cscope 15 $HOME/storage/projects/2016/pcengines/apu2/images/pcengines.apu_139_osp/coreboot/payloads/seabios/src -q 0000009132 0000905727
	@apm.c

9 
	~"biosv¨.h
"

10 
	~"bªgs.h
"

11 
	~"c⁄fig.h
"

12 
	~"fw/∑øvút.h
"

13 
	~"ouçut.h
"

14 
	~"°acks.h
"

15 
	~"utû.h
"

16 
	~"x86.h
"

19 
	$out_°r
(c⁄° *
°r_cs
)

21 i‡(!
	`ru¬ögOnQEMU
()) {

22 
	`d¥ötf
(1, "APMÑeque° '%s'\n", 
°r_cs
);

26 
u8
 *
s
 = (u8*)
°r_cs
;

28 
u8
 
c
 = 
	`GET_GLOBAL
(*
s
);

29 i‡(!
c
)

31 
	`outb
(
c
, 
PORT_BIOS_APM
);

32 
s
++;

34 
	}
}

38 
	$h™dÀ_155300
(
bªgs
 *
ªgs
)

40 
ªgs
->
ah
 = 1;

41 
ªgs
->
Æ
 = 2;

42 
ªgs
->
bh
 = 'P';

43 
ªgs
->
bl
 = 'M';

46 
ªgs
->
cx
 = 0x03;

47 
	`£t_suc˚ss
(
ªgs
);

48 
	}
}

52 
	$h™dÀ_155301
(
bªgs
 *
ªgs
)

54 
	`£t_suc˚ss
(
ªgs
);

55 
	}
}

58 
íåy_≠m16
();

59 
íåy_≠m32
();

63 
	$h™dÀ_155302
(
bªgs
 *
ªgs
)

65 
ªgs
->
bx
 = (
u32
)
íåy_≠m16
;

66 
ªgs
->
ax
 = 
SEG_BIOS
;

67 
ªgs
->
si
 = 0xfff0;

68 
ªgs
->
cx
 = 
SEG_BIOS
;

69 
ªgs
->
di
 = 0xfff0;

70 
	`£t_suc˚ss
(
ªgs
);

71 
	}
}

75 
	$h™dÀ_155303
(
bªgs
 *
ªgs
)

77 
ªgs
->
ax
 = 
SEG_BIOS
;

78 
ªgs
->
ebx
 = (
u32
)
íåy_≠m32
;

79 
ªgs
->
cx
 = 
SEG_BIOS
;

82 
ªgs
->
esi
 = 0xfff0fff0;

83 
ªgs
->
dx
 = 
SEG_BIOS
;

84 
ªgs
->
di
 = 0xfff0;

85 
	`£t_suc˚ss
(
ªgs
);

86 
	}
}

90 
	$h™dÀ_155304
(
bªgs
 *
ªgs
)

92 
	`£t_suc˚ss
(
ªgs
);

93 
	}
}

97 
	$h™dÀ_155305
(
bªgs
 *
ªgs
)

99 
	`yõld_toúq
();

100 
	`£t_suc˚ss
(
ªgs
);

101 
	}
}

105 
	$h™dÀ_155306
(
bªgs
 *
ªgs
)

107 
	`£t_suc˚ss
(
ªgs
);

108 
	}
}

111 
	$≠m_shutdown
()

113 
u16
 
pm1a_˙t
 = 
	`GET_GLOBAL
(
a˝i_pm1a_˙t
);

115 
	`úq_dißbÀ
();

116 i‡(
pm1a_˙t
)

117 
	`outw
(0x2000, 
pm1a_˙t
);

118 
	`out_°r
("Shutdown");

120 
	`h…
();

121 
	}
}

125 
	$h™dÀ_155307
(
bªgs
 *
ªgs
)

127 i‡(
ªgs
->
bx
 != 1) {

128 
	`£t_suc˚ss
(
ªgs
);

131 
ªgs
->
cx
) {

133 
	`out_°r
("Standby");

136 
	`out_°r
("Suspend");

139 
	`≠m_shutdown
();

142 
	`£t_suc˚ss
(
ªgs
);

143 
	}
}

146 
	$h™dÀ_155308
(
bªgs
 *
ªgs
)

148 
	`£t_suc˚ss
(
ªgs
);

149 
	}
}

153 
	$h™dÀ_15530a
(
bªgs
 *
ªgs
)

155 
ªgs
->
bh
 = 0x01;

156 
ªgs
->
bl
 = 0xff;

157 
ªgs
->
ch
 = 0x80;

158 
ªgs
->
˛
 = 0xff;

159 
ªgs
->
dx
 = 0xffff;

160 
ªgs
->
si
 = 0x00;

161 
	`£t_suc˚ss
(
ªgs
);

162 
	}
}

164 
	#RET_ENOEVENT
 0x80

	)

168 
	$h™dÀ_15530b
(
bªgs
 *
ªgs
)

170 
	`£t_code_övÆid_sûít
(
ªgs
, 
RET_ENOEVENT
);

171 
	}
}

175 
	$h™dÀ_15530e
(
bªgs
 *
ªgs
)

177 
ªgs
->
ah
 = 1;

178 
ªgs
->
Æ
 = 2;

179 
	`£t_suc˚ss
(
ªgs
);

180 
	}
}

184 
	$h™dÀ_15530f
(
bªgs
 *
ªgs
)

186 
	`£t_suc˚ss
(
ªgs
);

187 
	}
}

191 
	$h™dÀ_155310
(
bªgs
 *
ªgs
)

193 
ªgs
->
bl
 = 0;

194 
ªgs
->
cx
 = 0;

195 
	`£t_suc˚ss
(
ªgs
);

196 
	}
}

199 
	$h™dÀ_1553XX
(
bªgs
 *
ªgs
)

201 
	`£t_unim∂emíãd
(
ªgs
);

202 
	}
}

205 
	$h™dÀ_1553
(
bªgs
 *
ªgs
)

207 i‡(! 
CONFIG_APMBIOS
) {

208 
	`£t_code_övÆid
(
ªgs
, 
RET_EUNSUPPORTED
);

213 
ªgs
->
Æ
) {

214 0x00: 
	`h™dÀ_155300
(
ªgs
); ;

215 0x01: 
	`h™dÀ_155301
(
ªgs
); ;

216 0x02: 
	`h™dÀ_155302
(
ªgs
); ;

217 0x03: 
	`h™dÀ_155303
(
ªgs
); ;

218 0x04: 
	`h™dÀ_155304
(
ªgs
); ;

219 0x05: 
	`h™dÀ_155305
(
ªgs
); ;

220 0x06: 
	`h™dÀ_155306
(
ªgs
); ;

221 0x07: 
	`h™dÀ_155307
(
ªgs
); ;

222 0x08: 
	`h™dÀ_155308
(
ªgs
); ;

223 0x0a: 
	`h™dÀ_15530a
(
ªgs
); ;

224 0x0b: 
	`h™dÀ_15530b
(
ªgs
); ;

225 0x0e: 
	`h™dÀ_15530e
(
ªgs
); ;

226 0x0f: 
	`h™dÀ_15530f
(
ªgs
); ;

227 0x10: 
	`h™dÀ_155310
(
ªgs
); ;

228 : 
	`h™dÀ_1553XX
(
ªgs
); ;

230 
	}
}

232 
VISIBLE16
 
VISIBLE32SEG


233 
	$h™dÀ_≠m
(
bªgs
 *
ªgs
)

235 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_≠m
);

236 
	`h™dÀ_1553
(
ªgs
);

237 
	}
}

	@asm-offsets.c

3 
	~"gí-defs.h
"

4 
	~"bªgs.h
"

7 
	$foo
(Ë
VISIBLE16
;

9 
	$foo
()

11 
	`COMMENT
("BREGS");

12 
	`OFFSET
(
BREGS_es
, 
bªgs
, 
es
);

13 
	`OFFSET
(
BREGS_ds
, 
bªgs
, 
ds
);

14 
	`OFFSET
(
BREGS_óx
, 
bªgs
, 
óx
);

15 
	`OFFSET
(
BREGS_ebx
, 
bªgs
, 
ebx
);

16 
	`OFFSET
(
BREGS_ecx
, 
bªgs
, 
ecx
);

17 
	`OFFSET
(
BREGS_edx
, 
bªgs
, 
edx
);

18 
	`OFFSET
(
BREGS_ebp
, 
bªgs
, 
ebp
);

19 
	`OFFSET
(
BREGS_esi
, 
bªgs
, 
esi
);

20 
	`OFFSET
(
BREGS_edi
, 
bªgs
, 
edi
);

21 
	`OFFSET
(
BREGS_Êags
, 
bªgs
, 
Êags
);

22 
	`OFFSET
(
BREGS_code
, 
bªgs
, 
code
);

23 
	`DEFINE
(
BREGS_size
, (
bªgs
));

24 
	}
}

	@biosvar.h

6 #i‚de‡
__BIOSVAR_H


7 
	#__BIOSVAR_H


	)

9 
	~"c⁄fig.h
"

10 
	~"ÁΩå.h
"

11 
	~"°d/bda.h
"

18 
	#GET_IVT
(
ve˘‹
) \

19 
	`GET_FARVAR
(
SEG_IVT
, ((
rmode_IVT
 *)0)->
ivec
[
ve˘‹
])

	)

20 
	#SET_IVT
(
ve˘‹
, 
£goff
) \

21 
	`SET_FARVAR
(
SEG_IVT
, ((
rmode_IVT
 *)0)->
ivec
[
ve˘‹
], 
£goff
)

	)

23 
	#FUNC16
(
func
) ({ \

24 
	`ASSERT32FLAT
(); \

25 
	`func
 (); \

26 
	`SEGOFF
(
SEG_BIOS
, (
u32
)
func
 - 
BUILD_BIOS_ADDR
); \

27 })

	)

35 
	#GET_BDA
(
v¨
) \

36 
	`GET_FARVAR
(
SEG_BDA
, ((
bios_d©a_¨ó_s
 *)0)->
v¨
)

	)

37 
	#SET_BDA
(
v¨
, 
vÆ
) \

38 
	`SET_FARVAR
(
SEG_BDA
, ((
bios_d©a_¨ó_s
 *)0)->
v¨
, (
vÆ
))

	)

41 
ölöe
 
	$£t_equùmít_Êags
(
u16
 
˛ór
, u16 
£t
) {

42 
u16
 
eqf
 = 
	`GET_BDA
(
equùmít_li°_Êags
);

43 
	`SET_BDA
(
equùmít_li°_Êags
, (
eqf
 & ~
˛ór
Ë| 
£t
);

44 
	}
}

52 
	#EBDA_SIZE_START
 \

53 
	`DIV_ROUND_UP
((
exãnded_bios_d©a_¨ó_s
), 1024)

	)

54 
	#EBDA_SEGMENT_START
 \

55 
	`FLATPTR_TO_SEG
(
BUILD_LOWRAM_END
 - 
EBDA_SIZE_START
*1024)

	)

58 
ölöe
 
u16
 
	$gë_ebda_£g
() {

59  
	`GET_BDA
(
ebda_£g
);

60 
	}
}

61 
ölöe
 
exãnded_bios_d©a_¨ó_s
 *

62 
	$gë_ebda_±r
()

64 
	`ASSERT32FLAT
();

65  
	`MAKE_FLATPTR
(
	`gë_ebda_£g
(), 0);

66 
	}
}

67 
	#GET_EBDA
(
e£g
, 
v¨
) \

68 
	`GET_FARVAR
(
e£g
, ((
exãnded_bios_d©a_¨ó_s
 *)0)->
v¨
)

	)

69 
	#SET_EBDA
(
e£g
, 
v¨
, 
vÆ
) \

70 
	`SET_FARVAR
(
e£g
, ((
exãnded_bios_d©a_¨ó_s
 *)0)->
v¨
, (
vÆ
))

	)

77 #i‡
MODE16
 =0 && 
MODESEGMENT
 == 1

81 
	#GLOBAL_SEGREG
 
GS


	)

82 
ölöe
 
u32
 
__©åibuã_c⁄°
 
	$gë_globÆ_off£t
() {

83 
u32
 
ªt
;

84 
	`asm
(" calll 1f\n"

87 : "Ù"(
ªt
));

88  
ªt
;

89 
	}
}

91 
	#GLOBAL_SEGREG
 
CS


	)

92 
ölöe
 
u32
 
__©åibuã_c⁄°
 
	$gë_globÆ_off£t
() {

94 
	}
}

96 
ölöe
 
u16
 
	$gë_globÆ_£g
() {

97  
	`GET_SEG
(
GLOBAL_SEGREG
);

98 
	}
}

99 
	#GET_GLOBAL
(
v¨
) \

100 
	`GET_VAR
(
GLOBAL_SEGREG
, *(
	`ty≥of
(&(
v¨
)))((*)&(var) \

101 + 
	`gë_globÆ_off£t
()))

	)

102 #i‡
MODESEGMENT


103 
	#GLOBALFLAT2GLOBAL
(
v¨
Ë((
	`ty≥of
(v¨))((*)(v¨Ë- 
BUILD_BIOS_ADDR
))

	)

105 
	#GLOBALFLAT2GLOBAL
(
v¨
Ë(v¨)

	)

108 
	#GET_GLOBALFLAT
(
v¨
Ë
	`GET_GLOBAL
(*
	`GLOBALFLAT2GLOBAL
(&(v¨)))

	)

115 
u8
 
_z⁄ñow_£g
, 
z⁄ñow_ba£
[];

116 
	#SEG_LOW
 ((
u32
)&
_z⁄ñow_£g
)

	)

118 #i‡
MODESEGMENT


119 
	#GET_LOW
(
v¨
Ë
	`GET_FARVAR
(
SEG_LOW
, (v¨))

	)

120 
	#SET_LOW
(
v¨
, 
vÆ
Ë
	`SET_FARVAR
(
SEG_LOW
, (v¨), (vÆ))

	)

121 
	#LOWFLAT2LOW
(
v¨
Ë((
	`ty≥of
(v¨))((*)(v¨Ë- (
u32
)
z⁄ñow_ba£
))

	)

123 
	#GET_LOW
(
v¨
Ë(v¨)

	)

124 
	#SET_LOW
(
v¨
, 
vÆ
Ëdÿ{ (v¨Ë(vÆ); } 0)

	)

125 
	#LOWFLAT2LOW
(
v¨
Ë(v¨)

	)

127 
	#GET_LOWFLAT
(
v¨
Ë
	`GET_LOW
(*
	`LOWFLAT2LOW
(&(v¨)))

	)

128 
	#SET_LOWFLAT
(
v¨
, 
vÆ
Ë
	`SET_LOW
(*
	`LOWFLAT2LOW
(&(v¨)), (vÆ))

	)

	@block.c

9 
	~"biosv¨.h
"

10 
	~"block.h
"

11 
	~"bªgs.h
"

12 
	~"hw/©a.h
"

13 
	~"hw/ahci.h
"

14 
	~"hw/blockcmd.h
"

15 
	~"hw/πc.h
"

16 
	~"hw/vútio-blk.h
"

17 
	~"hw/sd_if.h
"

18 
	~"mÆloc.h
"

19 
	~"ouçut.h
"

20 
	~"°acks.h
"

21 
	~"°d/disk.h
"

22 
	~"°rög.h
"

23 
	~"utû.h
"

25 
	#MAX_DRIVE_TYPES
 4

	)

27 
u8
 
Fl›pyCou¡
 
	gVARFSEG
;

28 
u8
 
	gCDCou¡
;

30 
drive_s
 *
	gIDM≠
[
MAX_DRIVE_TYPES
][
BUILD_MAX_EXTDRIVE
] 
	gVARFSEG
;

31 
u8
 *
boun˚_buf_Ê
 
	gVARFSEG
;

32 
d±e_s
 
DeÁu…DPTE
 
	gVARLOW
;

34 
drive_s
 *

35 
	$gëDrive
(
u8
 
exây≥
, u8 
extdriveoff£t
)

37 i‡(
extdriveoff£t
 >
	`ARRAY_SIZE
(
IDM≠
[0]))

38  
NULL
;

39  
	`GET_GLOBAL
(
IDM≠
[
exây≥
][
extdriveoff£t
]);

40 
	}
}

42 
	$gëDriveId
(
u8
 
exây≥
, 
drive_s
 *
drive
)

44 
	`ASSERT32FLAT
();

45 
i
;

46 
i
 = 0; i < 
	`ARRAY_SIZE
(
IDM≠
[0]); i++)

47 i‡(
	`gëDrive
(
exây≥
, 
i
Ë=
drive
)

48  
i
;

50 
	}
}

52 
	$¸óã_boun˚_buf
()

54 i‡(
boun˚_buf_Ê
)

57 
u8
 *
buf
 = 
	`mÆloc_low
(
CDROM_SECTOR_SIZE
);

58 i‡(!
buf
) {

59 
	`w¨n_nﬂŒoc
();

62 
boun˚_buf_Ê
 = 
buf
;

64 
	}
}

70 
u8


71 
	$gë_å™¶©i⁄
(
drive_s
 *
drive
)

73 
u8
 
ty≥
 = 
drive
->type;

74 i‡(
CONFIG_QEMU
 && 
ty≥
 =
DTYPE_ATA
) {

76 
u8
 
©aid
 = 
drive
->
˙é_id
;

77 
u8
 
ch™√l
 = 
©aid
 / 2;

78 
u8
 
å™¶©i⁄
 = 
	`πc_ªad
(
CMOS_BIOS_DISKTRANSFLAG
 + 
ch™√l
/2);

79 
å™¶©i⁄
 >>2 * (
©aid
 % 4);

80 
å™¶©i⁄
 &= 0x03;

81  
å™¶©i⁄
;

85 
u16
 
hóds
 = 
drive
->
pchs
.
hód
;

86 
u16
 
cylödîs
 = 
drive
->
pchs
.
cylödî
;

87 
u16
 
•t
 = 
drive
->
pchs
.
£˘‹
;

88 
u64
 
£˘‹s
 = 
drive
->sectors;

89 
u64
 
p£˘‹s
 = (u64)
hóds
 * 
cylödîs
 * 
•t
;

90 i‡(!
hóds
 || !
cylödîs
 || !
•t
 || 
p£˘‹s
 > 
£˘‹s
)

92  
TRANSLATION_LBA
;

94 i‡(
cylödîs
 <1024 && 
hóds
 <16 && 
•t
 <= 63)

95  
TRANSLATION_NONE
;

96 i‡(
cylödîs
 * 
hóds
 <= 131072)

97  
TRANSLATION_LARGE
;

98  
TRANSLATION_LBA
;

99 
	}
}

102 
	$£tup_å™¶©i⁄
(
drive_s
 *
drive
)

104 
u8
 
å™¶©i⁄
 = 
	`gë_å™¶©i⁄
(
drive
);

105 
drive
->
å™¶©i⁄
 =Åranslation;

107 
u16
 
hóds
 = 
drive
->
pchs
.
hód
 ;

108 
u16
 
cylödîs
 = 
drive
->
pchs
.
cylödî
;

109 
u16
 
•t
 = 
drive
->
pchs
.
£˘‹
;

110 
u64
 
£˘‹s
 = 
drive
->sectors;

111 c⁄° *
desc
 = 
NULL
;

113 
å™¶©i⁄
) {

115 
TRANSLATION_NONE
:

116 
desc
 = "none";

118 
TRANSLATION_LBA
:

119 
desc
 = "lba";

120 
•t
 = 63;

121 i‡(
£˘‹s
 > 63*255*1024) {

122 
hóds
 = 255;

123 
cylödîs
 = 1024;

126 
u32
 
£˘
 = (u32)
£˘‹s
 / 63;

127 
hóds
 = 
£˘
 / 1024;

128 i‡(
hóds
>128)

129 
hóds
 = 255;

130 i‡(
hóds
>64)

131 
hóds
 = 128;

132 i‡(
hóds
>32)

133 
hóds
 = 64;

134 i‡(
hóds
>16)

135 
hóds
 = 32;

137 
hóds
 = 16;

138 
cylödîs
 = 
£˘
 / 
hóds
;

140 
TRANSLATION_RECHS
:

141 
desc
 = "r-echs";

143 i‡(
hóds
==16) {

144 i‡(
cylödîs
>61439)

145 
cylödîs
=61439;

146 
hóds
=15;

147 
cylödîs
 = (
u16
)((
u32
)(cylinders)*16/15);

150 
TRANSLATION_LARGE
:

151 i‡(
å™¶©i⁄
 =
TRANSLATION_LARGE
)

152 
desc
 = "large";

153 
cylödîs
 > 1024) {

154 
cylödîs
 >>= 1;

155 
hóds
 <<= 1;

158 i‡(
hóds
 > 127)

164 i‡(
cylödîs
 > 1024)

165 
cylödîs
 = 1024;

166 
	`d¥ötf
(1, "drive %p: PCHS=%u/%d/%dÅranslation=%s LCHS=%d/%d/%d s=%d\n"

167 , 
drive


168 , 
drive
->
pchs
.
cylödî
, drive->pchs.
hód
, drive->pchs.
£˘‹


169 , 
desc


170 , 
cylödîs
, 
hóds
, 
•t


171 , (
u32
)
£˘‹s
);

173 
drive
->
lchs
.
hód
 = 
hóds
;

174 
drive
->
lchs
.
cylödî
 = 
cylödîs
;

175 
drive
->
lchs
.
£˘‹
 = 
•t
;

176 
	}
}

185 
	$fûl_fd±
(
drive_s
 *
drive
, 
hdid
)

187 i‡(
hdid
 > 1)

190 
u16
 
∆c
 = 
drive
->
lchs
.
cylödî
;

191 
u16
 
∆h
 = 
drive
->
lchs
.
hód
;

192 
u16
 
∆s
 = 
drive
->
lchs
.
£˘‹
;

194 
u16
 
≈c
 = 
drive
->
pchs
.
cylödî
;

195 
u16
 
≈h
 = 
drive
->
pchs
.
hód
;

196 
u16
 
≈s
 = 
drive
->
pchs
.
£˘‹
;

198 
fd±_s
 *
fd±
 = &
	`gë_ebda_±r
()->fd±[
hdid
];

199 
fd±
->
¥ecom≥nßti⁄
 = 0xffff;

200 
fd±
->
drive_c⁄åﬁ_byã
 = 0xc0 | ((
≈h
 > 8) << 3);

201 
fd±
->
œndög_z⁄e
 = 
≈c
;

202 
fd±
->
cylödîs
 = 
∆c
;

203 
fd±
->
hóds
 = 
∆h
;

204 
fd±
->
£˘‹s
 = 
∆s
;

206 i‡(
∆c
 !
≈c
 || 
∆h
 !
≈h
 || 
∆s
 !
≈s
) {

211 
fd±
->
phys_cylödîs
 = 
≈c
;

212 
fd±
->
phys_hóds
 = 
≈h
;

213 
fd±
->
phys_£˘‹s
 = 
≈s
;

214 
fd±
->
a0h_sig«tuª
 = 0xa0;

217 
fd±
->
checksum
 -
	`checksum
(fdpt, (*fdpt));

220 i‡(
hdid
 == 0)

221 
	`SET_IVT
(0x41, 
	`SEGOFF
(
	`gë_ebda_£g
(), 
	`off£tof
(

222 
exãnded_bios_d©a_¨ó_s
, 
fd±
[0])));

224 
	`SET_IVT
(0x46, 
	`SEGOFF
(
	`gë_ebda_£g
(), 
	`off£tof
(

225 
exãnded_bios_d©a_¨ó_s
, 
fd±
[1])));

226 
	}
}

230 
	$add_drive
(
drive_s
 **
idm≠
, 
u8
 *
cou¡
, drive_†*
drive
)

232 i‡(*
cou¡
 >
	`ARRAY_SIZE
(
IDM≠
[0])) {

233 
	`w¨n_nﬂŒoc
();

236 
idm≠
[*
cou¡
] = 
drive
;

237 *
cou¡
 = *count + 1;

238 
	}
}

242 
	$m≠_hd_drive
(
drive_s
 *
drive
)

244 
	`ASSERT32FLAT
();

245 
bios_d©a_¨ó_s
 *
bda
 = 
	`MAKE_FLATPTR
(
SEG_BDA
, 0);

246 
hdid
 = 
bda
->
hdcou¡
;

247 
	`d¥ötf
(3, "M≠pög hd drivê%∞tÿ%d\n", 
drive
, 
hdid
);

248 
	`add_drive
(
IDM≠
[
EXTTYPE_HD
], &
bda
->
hdcou¡
, 
drive
);

251 
	`£tup_å™¶©i⁄
(
drive
);

254 
	`fûl_fd±
(
drive
, 
hdid
);

255 
	}
}

259 
	$m≠_cd_drive
(
drive_s
 *
drive
)

261 
	`ASSERT32FLAT
();

262 
	`d¥ötf
(3, "M≠pög cd drivê%p\n", 
drive
);

263 
	`add_drive
(
IDM≠
[
EXTTYPE_CD
], &
CDCou¡
, 
drive
);

264 
	}
}

268 
	$m≠_Ê›py_drive
(
drive_s
 *
drive
)

270 
	`ASSERT32FLAT
();

271 
	`d¥ötf
(3, "M≠pög fl›py drivê%p\n", 
drive
);

272 
	`add_drive
(
IDM≠
[
EXTTYPE_FLOPPY
], &
Fl›pyCou¡
, 
drive
);

275 i‡(
Fl›pyCou¡
 == 1) {

277 
	`£t_equùmít_Êags
(0x41, 0x01);

278 
	`SET_BDA
(
Ê›py_h¨ddisk_öfo
, 0x07);

279 } i‡(
Fl›pyCou¡
 >= 2) {

281 
	`£t_equùmít_Êags
(0x41, 0x41);

282 
	`SET_BDA
(
Ê›py_h¨ddisk_öfo
, 0x77);

284 
	}
}

288 
	$m≠_sd_drive
(
drive_s
 *
drive_g
)

290 
	`ASSERT32FLAT
();

291 
bios_d©a_¨ó_s
 *
bda
 = 
	`MAKE_FLATPTR
(
SEG_BDA
, 0);

292 
sdid
 = 
bda
->
hdcou¡
;

293 
	`¥ötf
("M≠pög sd/mm¯drivê0x%08x\n", ()
drive_g
);

294 
	`add_drive
(
IDM≠
[
EXTTYPE_HD
], &
bda
->
hdcou¡
, 
drive_g
);

297 
	`£tup_å™¶©i⁄
(
drive_g
);

300 
drive_g
->
pchs
.
hód
 = drive_g->
lchs
.head;

301 
drive_g
->
pchs
.
cylödî
 = drive_g->
lchs
.cylinder;

302 
drive_g
->
pchs
.
£˘‹
 = drive_g->
lchs
.sector;

305 
	`fûl_fd±
(
drive_g
, 
sdid
);

306 
	}
}

313 
	$__disk_ªt
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
)

315 
u8
 
code
 = 
löecode
;

316 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
)

317 
	`SET_BDA
(
Ê›py_œ°_°©us
, 
code
);

319 
	`SET_BDA
(
disk_œ°_°©us
, 
code
);

320 i‡(
code
)

321 
	`__£t_code_övÆid
(
ªgs
, 
löecode
, 
‚ame
);

323 
	`£t_code_suc˚ss
(
ªgs
);

324 
	}
}

327 
	$__disk_ªt_unim∂emíãd
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
)

329 
u8
 
code
 = 
löecode
;

330 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
)

331 
	`SET_BDA
(
Ê›py_œ°_°©us
, 
code
);

333 
	`SET_BDA
(
disk_œ°_°©us
, 
code
);

334 
	`__£t_code_unim∂emíãd
(
ªgs
, 
löecode
, 
‚ame
);

335 
	}
}

342 
VISIBLE32FLAT


343 
	$¥o˚ss_scsi_›
(
disk_›_s
 *
›
)

345 
›
->
comm™d
) {

346 
CMD_READ
:

347  
	`cdb_ªad
(
›
);

348 
CMD_WRITE
:

349  
	`cdb_wrôe
(
›
);

350 
CMD_FORMAT
:

351 
CMD_RESET
:

352 
CMD_ISREADY
:

353 
CMD_VERIFY
:

354 
CMD_SEEK
:

355  
DISK_RET_SUCCESS
;

357  
DISK_RET_EPARAM
;

359 
	}
}

361 
VISIBLE32FLAT


362 
	$¥o˚ss_©≠i_›
(
disk_›_s
 *
›
)

364 
›
->
comm™d
) {

365 
CMD_WRITE
:

366 
CMD_FORMAT
:

367  
DISK_RET_EWRITEPROTECT
;

369  
	`¥o˚ss_scsi_›
(
›
);

371 
	}
}

375 
	$¥o˚ss_›
(
disk_›_s
 *
›
)

377 
	`ASSERT16
();

378 
ªt
, 
‹igcou¡
 = 
›
->
cou¡
;

379 
u8
 
ty≥
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->type);

380 
ty≥
) {

381 
DTYPE_FLOPPY
:

382 
ªt
 = 
	`¥o˚ss_Ê›py_›
(
›
);

384 
DTYPE_ATA
:

385 
ªt
 = 
	`¥o˚ss_©a_›
(
›
);

387 
DTYPE_RAMDISK
:

388 
ªt
 = 
	`¥o˚ss_ømdisk_›
(
›
);

390 
DTYPE_CDEMU
:

391 
ªt
 = 
	`¥o˚ss_cdemu_›
(
›
);

393 
DTYPE_VIRTIO_BLK
:

394 
ªt
 = 
	`¥o˚ss_vútio_blk_›
(
›
);

396 
DTYPE_AHCI
: ;

397 
	`_cfunc32Ê©_¥o˚ss_ahci_›
();

398 
ªt
 = 
	`ˇŒ32
(
_cfunc32Ê©_¥o˚ss_ahci_›


399 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
›
), 
DISK_RET_EPARAM
);

401 
DTYPE_ATA_ATAPI
:

402 
ªt
 = 
	`¥o˚ss_©≠i_›
(
›
);

404 
DTYPE_AHCI_ATAPI
: ;

405 
	`_cfunc32Ê©_¥o˚ss_©≠i_›
();

406 
ªt
 = 
	`ˇŒ32
(
_cfunc32Ê©_¥o˚ss_©≠i_›


407 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
›
), 
DISK_RET_EPARAM
);

409 
DTYPE_USB
:

410 
DTYPE_UAS
:

411 
DTYPE_VIRTIO_SCSI
:

412 
DTYPE_LSI_SCSI
:

413 
DTYPE_ESP_SCSI
:

414 
DTYPE_MEGASAS
:

415 
ªt
 = 
	`¥o˚ss_scsi_›
(
›
);

417 
DTYPE_USB_32
:

418 
DTYPE_UAS_32
:

419 
DTYPE_PVSCSI
: ;

420 
	`_cfunc32Ê©_¥o˚ss_scsi_›
();

421 
ªt
 = 
	`ˇŒ32
(
_cfunc32Ê©_¥o˚ss_scsi_›


422 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
›
), 
DISK_RET_EPARAM
);

424 
DTYPE_SD
: ;

425 
	`_cfunc32Ê©_¥o˚ss_sd_›
();

426 
ªt
 = 
	`ˇŒ32
(
_cfunc32Ê©_¥o˚ss_sd_›


427 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
›
), 
DISK_RET_EPARAM
);

430 
ªt
 = 
DISK_RET_EPARAM
;

433 i‡(
ªt
 && 
›
->
cou¡
 =
‹igcou¡
)

435 
›
->
cou¡
 = 0;

436  
ªt
;

437 
	}
}

441 
	$__£nd_disk_›
(
disk_›_s
 *
›_Ár
, 
u16
 
›_£g
)

443 
disk_›_s
 
d›
;

444 
	`mem˝y_Ár
(
	`GET_SEG
(
SS
), &
d›


445 , 
›_£g
, 
›_Ár


446 , (
d›
));

448 
	`d¥ötf
(
DEBUG_HDL_13
, "disk_op d=%pÜba=%d buf=%p count=%d cmd=%d\n"

449 , 
d›
.
drive_gf
, (
u32
)d›.
lba
, d›.
buf_Ê


450 , 
d›
.
cou¡
, d›.
comm™d
);

452 
°©us
 = 
	`¥o˚ss_›
(&
d›
);

455 
	`SET_FARVAR
(
›_£g
, 
›_Ár
->
cou¡
, 
d›
.count);

457  
°©us
;

458 
	}
}

462 
	$£nd_disk_›
(
disk_›_s
 *
›
)

464 
	`ASSERT16
();

465 i‡(! 
CONFIG_DRIVES
)

468  
	`°ack_h›
((
u32
)
›
, 
	`GET_SEG
(
SS
), 
__£nd_disk_›
);

469 
	}
}

	@block.h

1 #i‚de‡
__BLOCK_H


2 
	#__BLOCK_H


	)

4 
	~"ty≥s.h
"

11 
	sdisk_›_s
 {

12 
u64
 
	mlba
;

13 *
	mbuf_Ê
;

14 
drive_s
 *
	mdrive_gf
;

15 
u16
 
	mcou¡
;

16 
u8
 
	mcomm™d
;

19 
	#CMD_RESET
 0x00

	)

20 
	#CMD_READ
 0x02

	)

21 
	#CMD_WRITE
 0x03

	)

22 
	#CMD_VERIFY
 0x04

	)

23 
	#CMD_FORMAT
 0x05

	)

24 
	#CMD_SEEK
 0x07

	)

25 
	#CMD_ISREADY
 0x10

	)

32 
	schs_s
 {

33 
u16
 
	mhód
;

34 
u16
 
	mcylödî
;

35 
u16
 
	m£˘‹
;

36 
u16
 
	m∑d
;

40 
	scdemu_s
 {

41 
drive_s
 *
	memuœãd_drive_gf
;

42 
u32
 
	mûba
;

43 
u16
 
	mbuf„r_£gmít
;

44 
u16
 
	mlﬂd_£gmít
;

45 
u16
 
	m£˘‹_cou¡
;

46 
u8
 
	ma˘ive
;

47 
u8
 
	mmedü
;

48 
u8
 
	memuœãd_extdrive
;

51 
chs_s
 
	mlchs
;

54 
	sdrive_s
 {

55 
u8
 
	mty≥
;

56 
u8
 
	mÊ›py_ty≥
;

57 
chs_s
 
	mlchs
;

58 
u64
 
	m£˘‹s
;

59 
u32
 
	m˙é_id
;

60 
u8
 
	mªmovabÀ
;

63 
u8
 
	må™¶©i⁄
;

64 
u16
 
	mblksize
;

65 
chs_s
 
	mpchs
;

68 
	#DISK_SECTOR_SIZE
 512

	)

69 
	#CDROM_SECTOR_SIZE
 2048

	)

71 
	#DTYPE_NONE
 0x00

	)

72 
	#DTYPE_FLOPPY
 0x10

	)

73 
	#DTYPE_ATA
 0x20

	)

74 
	#DTYPE_ATA_ATAPI
 0x21

	)

75 
	#DTYPE_RAMDISK
 0x30

	)

76 
	#DTYPE_CDEMU
 0x40

	)

77 
	#DTYPE_AHCI
 0x50

	)

78 
	#DTYPE_AHCI_ATAPI
 0x51

	)

79 
	#DTYPE_VIRTIO_SCSI
 0x60

	)

80 
	#DTYPE_VIRTIO_BLK
 0x61

	)

81 
	#DTYPE_USB
 0x70

	)

82 
	#DTYPE_USB_32
 0x71

	)

83 
	#DTYPE_UAS
 0x72

	)

84 
	#DTYPE_UAS_32
 0x73

	)

85 
	#DTYPE_LSI_SCSI
 0x80

	)

86 
	#DTYPE_ESP_SCSI
 0x81

	)

87 
	#DTYPE_MEGASAS
 0x82

	)

88 
	#DTYPE_PVSCSI
 0x83

	)

89 
	#DTYPE_SD
 0x90

	)

91 
	#MAXDESCSIZE
 80

	)

93 
	#TRANSLATION_NONE
 0

	)

94 
	#TRANSLATION_LBA
 1

	)

95 
	#TRANSLATION_LARGE
 2

	)

96 
	#TRANSLATION_RECHS
 3

	)

98 
	#EXTTYPE_FLOPPY
 0

	)

99 
	#EXTTYPE_HD
 1

	)

100 
	#EXTTYPE_CD
 2

	)

102 
	#EXTSTART_HD
 0x80

	)

103 
	#EXTSTART_CD
 0xE0

	)

111 
d±e_s
 
DeÁu…DPTE
;

112 
u8
 
Fl›pyCou¡
, 
CDCou¡
;

113 
u8
 *
boun˚_buf_Ê
;

114 
drive_s
 *
gëDrive
(
u8
 
exây≥
, u8 
extdriveoff£t
);

115 
gëDriveId
(
u8
 
exây≥
, 
drive_s
 *
drive
);

116 
m≠_Ê›py_drive
(
drive_s
 *
drive
);

117 
m≠_hd_drive
(
drive_s
 *
drive
);

118 
m≠_cd_drive
(
drive_s
 *
drive
);

119 
m≠_sd_drive
(
drive_s
 *
drive
);

120 
	gbªgs
;

121 
__disk_ªt
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
);

122 
__disk_ªt_unim∂emíãd
(
bªgs
 *
ªgs
, 
u32
 
löecode


123 , c⁄° *
‚ame
);

124 
¥o˚ss_›
(
disk_›_s
 *
›
);

125 
£nd_disk_›
(
disk_›_s
 *
›
);

126 
¸óã_boun˚_buf
();

129 
	#disk_ªt
(
ªgs
, 
code
) \

130 
	`__disk_ªt
((
ªgs
), (
code
Ë| (
__LINE__
 << 8), 
__func__
)

	)

131 
	#disk_ªt_unim∂emíãd
(
ªgs
, 
code
) \

132 
	`__disk_ªt_unim∂emíãd
((
ªgs
), (
code
Ë| (
__LINE__
 << 8), 
__func__
)

	)

	@bmp.c

9 
	~"mÆloc.h
"

10 
	~"°rög.h
"

11 
	~"utû.h
"

13 
	sbmp_decd©a
 {

14 
ègRGBQUAD
 *
	mquadp
;

15 *
	md©≠
;

16 
	mwidth
;

17 
	mheight
;

18 
	mbµ
;

21 
	#bmp_lﬂd4byã
(
addr
Ë(*(
u32
 *)◊ddr))

	)

22 
	#bmp_lﬂd2byã
(
addr
Ë(*(
u16
 *)◊ddr))

	)

24 
	sègBITMAPFILEHEADER
 {

25 
u8
 
	mbfTy≥
[2];

26 
u8
 
	mbfSize
[4];

27 
u8
 
	mbfRe£rved1
[2];

28 
u8
 
	mbfRe£rved2
[2];

29 
u8
 
	mbfOffBôs
[4];

30 } 
	tBITMAPFILEHEADER
, 
	tègBITMAPFILEHEADER
;

32 
	sègBITMAPINFOHEADER
 {

33 
u8
 
	mbiSize
[4];

34 
u8
 
	mbiWidth
[4];

35 
u8
 
	mbiHeight
[4];

36 
u8
 
	mbiPœ√s
[2];

37 
u8
 
	mbiBôCou¡
[2];

38 
u8
 
	mbiCom¥essi⁄
[4];

39 
u8
 
	mbiSizeImage
[4];

40 
u8
 
	mbiXPñsPîMëî
[4];

41 
u8
 
	mbiYPñsPîMëî
[4];

42 
u8
 
	mbiCÃU£d
[4];

43 
u8
 
	mbiCÃImp‹è¡
[4];

44 } 
	tBITMAPINFOHEADER
, 
	tègBITMAPINFOHEADER
;

46 
	sègRGBQUAD
 {

47 
u8
 
	mrgbBlue
;

48 
u8
 
	mrgbGªí
;

49 
u8
 
	mrgbRed
;

50 
u8
 
	mrgbRe£rved
;

51 } 
	tRGBQUAD
, 
	tègRGBQUAD
;

59 
	$øw_d©a_f‹m©_adju°_24bµ
(
u8
 *
§c
, u8 *
de°
, 
width
,

60 
height
, 
byãs_≥r_löe_de°
)

62 
byãs_≥r_löe_§c
 = 3 * 
width
;

63 
i
;

64 
i
 = 0 ; i < 
height
 ; i++) {

65 
	`mem˝y
(
de°
 + 
i
 * 
byãs_≥r_löe_de°
,

66 
§c
 + (
height
 - 1 - 
i
Ë* 
byãs_≥r_löe_§c
, bytes_per_line_src);

68 
	}
}

71 
bmp_decd©a
 *
	$bmp_Æloc
()

73 
bmp_decd©a
 *
bmp
 = 
	`mÆloc_tmphigh
((*bmp));

74  
bmp
;

75 
	}
}

78 
	$bmp_decode
(
bmp_decd©a
 *
bmp
, *
d©a
, 
d©a_size
)

80 i‡(
d©a_size
 < 54)

83 
u16
 
bmp_fûehód
 = 
	`bmp_lﬂd2byã
(
d©a
 + 0);

84 i‡(
bmp_fûehód
 != 0x4d42)

86 
u32
 
bmp_ªc‹dsize
 = 
	`bmp_lﬂd4byã
(
d©a
 + 2);

87 i‡(
bmp_ªc‹dsize
 !
d©a_size
)

89 
u32
 
bmp_d©aoff£t
 = 
	`bmp_lﬂd4byã
(
d©a
 + 10);

90 
bmp
->
d©≠
 = (*)
d©a
 + 
bmp_d©aoff£t
;

91 
bmp
->
width
 = 
	`bmp_lﬂd4byã
(
d©a
 + 18);

92 
bmp
->
height
 = 
	`bmp_lﬂd4byã
(
d©a
 + 22);

93 
bmp
->
bµ
 = 
	`bmp_lﬂd2byã
(
d©a
 + 28);

95 
	}
}

98 
	$bmp_gë_size
(
bmp_decd©a
 *
bmp
, *
width
, *
height
)

100 *
width
 = 
bmp
->width;

101 *
height
 = 
bmp
->height;

102 
	}
}

105 
	$bmp_show
(
bmp_decd©a
 *
bmp
, *
pic
, 
width


106 , 
height
, 
dïth
, 
byãs_≥r_löe_de°
)

108 i‡(
bmp
->
d©≠
 =
pic
)

111 i‡((
dïth
 =24Ë&& (
bmp
->
bµ
 == 24)) {

112 
	`øw_d©a_f‹m©_adju°_24bµ
(
bmp
->
d©≠
, 
pic
, 
width
, 
height
,

113 
byãs_≥r_löe_de°
);

117 
	}
}

	@boot.c

9 
	~"block.h
"

10 
	~"bªgs.h
"

11 
	~"c⁄fig.h
"

12 
	~"fw/∑øvút.h
"

13 
	~"hw/pci.h
"

14 
	~"hw/πc.h
"

15 
	~"hw/usb.h
"

16 
	~"li°.h
"

17 
	~"mÆloc.h
"

18 
	~"ouçut.h
"

19 
	~"romfûe.h
"

20 
	~"°d/disk.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

23 
	~"fw/c‹eboŸ.h
"

24 
	~"boŸ.h
"

30 **
BoŸ‹dî
 
	gVARVERIFY32INIT
;

31 
	gBoŸ‹dîCou¡
;

34 
	$lﬂdBoŸOrdî
()

36 i‡(!
CONFIG_BOOTORDER
)

39 *
f
 = 
NULL
;

41 i‡(
CONFIG_CHECK_FOR_BOOTORDER_IN_CBMEM
)

42 
f
 = (*)
	`gë_cbmem_boŸ‹dî_fûe
();

44 i‡(
f
 =
NULL
)

45 
f
 = 
	`romfûe_lﬂdfûe
("boŸ‹dî", 
NULL
);

47 i‡(!
f
)

50 
i
 = 0;

51 
BoŸ‹dîCou¡
 = 1;

52 
f
[
i
]) {

53 i‡(
f
[
i
] == '\n')

54 
BoŸ‹dîCou¡
++;

55 
i
++;

57 
BoŸ‹dî
 = 
	`mÆloc_tmphigh
(
BoŸ‹dîCou¡
*(*));

58 i‡(!
BoŸ‹dî
) {

59 
	`w¨n_nﬂŒoc
();

60 
	`‰ì
(
f
);

61 
BoŸ‹dîCou¡
 = 0;

65 
	`d¥ötf
(2, "boot order:\n");

66 
i
 = 0;

68 
BoŸ‹dî
[
i
] = 
f
;

69 
f
 = 
	`°rchr
(f, '\n');

70 i‡(
f
)

71 *(
f
++) = '\0';

72 
BoŸ‹dî
[
i
] = 
	`nuŒTøûögS∑˚
(Bootorder[i]);

73 
	`d¥ötf
(2, "%d: %s\n", 
i
+1, 
BoŸ‹dî
[i]);

74 
i
++;

75 } 
f
);

76 
	}
}

82 
	$glob_¥efix
(c⁄° *
glob
, c⁄° *
°r
)

86 i‡(!
glob
[0] && (!
°r
[0] || str[0] == '/'))

88 i‡(
°r
[0] == '*') {

89 i‡(!
°r
[1])

91 i‡(
glob
[0] == '*') {

92 i‡(
glob
[1] =
°r
[1])

93 
glob
++;

94 
°r
++;

97 i‡(
glob
[0] =
°r
[1])

98 
°r
++;

100 
glob
++;

103 i‡(
glob
[0] == '*') {

104 i‡(!
°r
[0] || så[0] ='/' || så[0] =
glob
[1])

105 
glob
++;

107 
°r
++;

110 i‡(
glob
[0] !
°r
[0])

112 
glob
++;

113 
°r
++;

115 
	}
}

119 
	$föd_¥io
(c⁄° *
glob
)

121 
	`d¥ötf
(1, "Sórchög boŸ‹dî f‹: %s\n", 
glob
);

122 
i
;

123 
i
 = 0; i < 
BoŸ‹dîCou¡
; i++) {

126 i‡(*(
BoŸ‹dî
[
i
]) == '!') {

127 i‡(
	`glob_¥efix
(
glob
, 
BoŸ‹dî
[
i
] + 1)) {

128 
	`d¥ötf
(1, "ªmovög %†a†®boŸabÀ devi˚\n", 
BoŸ‹dî
[
i
]);

133 i‡(
	`glob_¥efix
(
glob
, 
BoŸ‹dî
[
i
]))

134  
i
+1;

138 
	}
}

140 
	#FW_PCI_DOMAIN
 "/pci@i0cf8"

	)

143 
	$buûd_pci_∑th
(*
buf
, 
max
, c⁄° *
dev«me
, 
pci_devi˚
 *
pci
)

146 *
p
 = 
buf
;

147 i‡(
pci
->
∑ª¡
) {

148 
p
 = 
	`buûd_pci_∑th
’, 
max
, "pci-bridge", 
pci
->
∑ª¡
);

150 i‡(
pci
->
roŸbus
)

151 
p
 +
	`¢¥ötf
’, 
max
, "/pci-roŸ@%x", 
pci
->
roŸbus
);

152 
p
 +
	`¢¥ötf
’, 
buf
+
max
-p, "%s", 
FW_PCI_DOMAIN
);

155 
dev
 = 
	`pci_bdf_to_dev
(
pci
->
bdf
), 
‚
 = 
	`pci_bdf_to_‚
(pci->bdf);

156 
p
 +
	`¢¥ötf
’, 
buf
+
max
-p, "/%s@%x", 
dev«me
, 
dev
);

157 i‡(
‚
)

158 
p
 +
	`¢¥ötf
’, 
buf
+
max
-p, ",%x", 
‚
);

159  
p
;

160 
	}
}

162 
	$boŸ¥io_föd_pci_devi˚
(
pci_devi˚
 *
pci
)

164 i‡(
CONFIG_CSM
)

165  
	`csm_boŸ¥io_pci
(
pci
);

166 i‡(!
CONFIG_BOOTORDER
)

169 
desc
[256];

170 
	`buûd_pci_∑th
(
desc
, (desc), "*", 
pci
);

171  
	`föd_¥io
(
desc
);

172 
	}
}

174 
	$boŸ¥io_föd_scsi_devi˚
(
pci_devi˚
 *
pci
, 
èrgë
, 
lun
)

176 i‡(!
CONFIG_BOOTORDER
)

178 i‡(!
pci
)

182 
desc
[256], *
p
;

183 
p
 = 
	`buûd_pci_∑th
(
desc
, (desc), "*", 
pci
);

184 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, "/*@0/*@%d,%d", 
èrgë
, 
lun
);

185  
	`föd_¥io
(
desc
);

186 
	}
}

188 
	$boŸ¥io_föd_©a_devi˚
(
pci_devi˚
 *
pci
, 
ch™id
, 
¶ave
)

190 i‡(
CONFIG_CSM
)

191  
	`csm_boŸ¥io_©a
(
pci
, 
ch™id
, 
¶ave
);

192 i‡(!
CONFIG_BOOTORDER
)

194 i‡(!
pci
)

198 
desc
[256], *
p
;

199 
p
 = 
	`buûd_pci_∑th
(
desc
, (desc), "*", 
pci
);

200 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, "/drive@%x/disk@%x", 
ch™id
, 
¶ave
);

201  
	`föd_¥io
(
desc
);

202 
	}
}

204 
	$boŸ¥io_föd_fdc_devi˚
(
pci_devi˚
 *
pci
, 
p‹t
, 
fdid
)

206 i‡(
CONFIG_CSM
)

207  
	`csm_boŸ¥io_fdc
(
pci
, 
p‹t
, 
fdid
);

208 i‡(!
CONFIG_BOOTORDER
)

210 i‡(!
pci
)

214 
desc
[256], *
p
;

215 
p
 = 
	`buûd_pci_∑th
(
desc
, (desc), "iß", 
pci
);

216 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, "/fdc@%04x/Ê›py@%x", 
p‹t
, 
fdid
);

217  
	`föd_¥io
(
desc
);

218 
	}
}

220 
	$boŸ¥io_föd_pci_rom
(
pci_devi˚
 *
pci
, 
ö°™˚
)

222 i‡(!
CONFIG_BOOTORDER
)

225 
desc
[256], *
p
;

226 
p
 = 
	`buûd_pci_∑th
(
desc
, (desc), "*", 
pci
);

227 i‡(
ö°™˚
)

228 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, ":rom%d", 
ö°™˚
);

229  
	`föd_¥io
(
desc
);

230 
	}
}

232 
	$boŸ¥io_föd_«med_rom
(c⁄° *
«me
, 
ö°™˚
)

234 i‡(!
CONFIG_BOOTORDER
)

237 
desc
[256], *
p
;

238 
p
 = 
desc
 + 
	`¢¥ötf
(desc, (desc), "/rom@%s", 
«me
);

239 i‡(
ö°™˚
)

240 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, ":rom%d", 
ö°™˚
);

241  
	`föd_¥io
(
desc
);

242 
	}
}

245 
	$buûd_usb_∑th
(*
buf
, 
max
, 
usbhub_s
 *
hub
)

247 i‡(!
hub
->
usbdev
)

249  
buf
;

250 *
p
 = 
	`buûd_usb_∑th
(
buf
, 
max
, 
hub
->
usbdev
->hub);

251 
p
 +
	`¢¥ötf
’, 
buf
+
max
-p, "/hub@%x", 
hub
->
usbdev
->
p‹t
+1);

252  
p
;

253 
	}
}

255 
	$boŸ¥io_föd_usb
(
usbdevi˚_s
 *
usbdev
, 
lun
)

257 i‡(!
CONFIG_BOOTORDER
)

260 
desc
[256], *
p
;

261 
p
 = 
	`buûd_pci_∑th
(
desc
, (desc), "usb", 
usbdev
->
hub
->
˙é
->
pci
);

262 
p
 = 
	`buûd_usb_∑th
’, 
desc
+(desc)-p, 
usbdev
->
hub
);

263 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, "/storage@%x/*@0/*@0,%d"

264 , 
usbdev
->
p‹t
+1, 
lun
);

265 
ªt
 = 
	`föd_¥io
(
desc
);

266 i‡(
ªt
 >= 0)

267  
ªt
;

269 
	`¢¥ötf
(
p
, 
desc
+(desc)-p, "/usb-*@%x", 
usbdev
->
p‹t
+1);

270  
	`föd_¥io
(
desc
);

271 
	}
}

278 
	gBoŸRëryTime
;

279 
	gCheckFl›pySig
 = 1;

281 
	#DEFAULT_PRIO
 9999

	)

283 
	gDeÁu…Fl›pyPrio
 = 101;

284 
	gDeÁu…CDPrio
 = 102;

285 
	gDeÁu…HDPrio
 = 103;

286 
	gDeÁu…BEVPrio
 = 104;

289 
	$boŸ_öô
()

291 i‡(! 
CONFIG_BOOT
)

294 i‡(
CONFIG_QEMU
) {

296 i‡(
	`πc_ªad
(
CMOS_BIOS_BOOTFLAG1
) & 1)

297 
CheckFl›pySig
 = 0;

298 
u32
 
boŸ‹dî
 = (
	`πc_ªad
(
CMOS_BIOS_BOOTFLAG2
)

299 | ((
	`πc_ªad
(
CMOS_BIOS_BOOTFLAG1
) & 0xf0) << 4));

300 
DeÁu…Fl›pyPrio
 = 
DeÁu…CDPrio
 = 
DeÁu…HDPrio


301 
DeÁu…BEVPrio
 = 
DEFAULT_PRIO
;

302 
i
;

303 
i
=101; i<104; i++) {

304 
u32
 
vÆ
 = 
boŸ‹dî
 & 0x0f;

305 
boŸ‹dî
 >>= 4;

306 
vÆ
) {

307 1: 
DeÁu…Fl›pyPrio
 = 
i
; ;

308 2: 
DeÁu…HDPrio
 = 
i
; ;

309 3: 
DeÁu…CDPrio
 = 
i
; ;

310 4: 
DeÁu…BEVPrio
 = 
i
; ;

315 
BoŸRëryTime
 = 
	`romfûe_lﬂdöt
("etc/boot-fail-wait", 60*1000);

317 
	`lﬂdBoŸOrdî
();

318 
	}
}

325 
	sboŸíåy_s
 {

326 
	mty≥
;

328 
u32
 
	md©a
;

329 
£goff_s
 
	mve˘‹
;

330 
drive_s
 *
	mdrive
;

332 
	m¥i‹ôy
;

333 c⁄° *
	mdes¸ùti⁄
;

334 
hli°_node
 
	mnode
;

336 
hli°_hód
 
BoŸLi°
 
	gVARVERIFY32INIT
;

338 
	#IPL_TYPE_FLOPPY
 0x01

	)

339 
	#IPL_TYPE_HARDDISK
 0x02

	)

340 
	#IPL_TYPE_CDROM
 0x03

	)

341 
	#IPL_TYPE_CBFS
 0x20

	)

342 
	#IPL_TYPE_BEV
 0x80

	)

343 
	#IPL_TYPE_BCV
 0x81

	)

344 
	#IPL_TYPE_HALT
 0xf0

	)

347 
	$boŸíåy_add
(
ty≥
, 
¥io
, 
u32
 
d©a
, c⁄° *
desc
)

349 i‡(! 
CONFIG_BOOT
)

351 
boŸíåy_s
 *
be
 = 
	`mÆloc_tmp
((*be));

352 i‡(!
be
) {

353 
	`w¨n_nﬂŒoc
();

356 i‡(
¥io
 == 0xdead) {

359 
be
->
ty≥
 =Åype;

360 
be
->
¥i‹ôy
 = 
¥io
;

361 
be
->
d©a
 = data;

362 
be
->
des¸ùti⁄
 = 
desc
 ?: "?";

363 
	`d¥ötf
(3, "Registering bootable: %s (type:%dÖrio:%d data:%x)\n"

364 , 
be
->
des¸ùti⁄
, 
ty≥
, 
¥io
, 
d©a
);

367 
hli°_node
 **
µªv
;

368 
boŸíåy_s
 *
pos
;

369 
	`hli°_f‹_óch_íåy_µªv
(
pos
, 
µªv
, &
BoŸLi°
, 
node
) {

370 i‡(
be
->
¥i‹ôy
 < 
pos
->priority)

372 i‡(
be
->
¥i‹ôy
 > 
pos
->priority)

374 i‡(
be
->
ty≥
 < 
pos
->type)

376 i‡(
be
->
ty≥
 > 
pos
->type)

378 i‡(
be
->
ty≥
 <
IPL_TYPE_CDROM


379 && (
be
->
drive
->
ty≥
 < 
pos
->drive->type

380 || (
be
->
drive
->
ty≥
 =
pos
->drive->type

381 && 
be
->
drive
->
˙é_id
 < 
pos
->drive->cntl_id)))

384 
	`hli°_add
(&
be
->
node
, 
µªv
);

385 
	}
}

388 
ölöe
 
	$defPrio
(
¥i‹ôy
, 
deÁu…¥io
) {

389  (
¥i‹ôy
 < 0Ë? 
deÁu…¥io
 :Öriority;

390 
	}
}

394 
	$boŸ_add_bev
(
u16
 
£g
, u16 
bev
, u16 
desc
, 
¥io
)

396 
	`boŸíåy_add
(
IPL_TYPE_BEV
, 
	`defPrio
(
¥io
, 
DeÁu…BEVPrio
)

397 , 
	`SEGOFF
(
£g
, 
bev
).
£goff


398 , 
desc
 ? 
	`MAKE_FLATPTR
(
£g
, desc) : "Unknown");

399 
DeÁu…BEVPrio
 = 
DEFAULT_PRIO
;

400 
	}
}

404 
	$boŸ_add_bcv
(
u16
 
£g
, u16 
ù
, u16 
desc
, 
¥io
)

406 
	`boŸíåy_add
(
IPL_TYPE_BCV
, 
	`defPrio
(
¥io
, 
DeÁu…HDPrio
)

407 , 
	`SEGOFF
(
£g
, 
ù
).
£goff


408 , 
desc
 ? 
	`MAKE_FLATPTR
(
£g
, desc) : "Legacy optionÑom");

409 
	}
}

412 
	$boŸ_add_Ê›py
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
)

414 
	`boŸíåy_add
(
IPL_TYPE_FLOPPY
, 
	`defPrio
(
¥io
, 
DeÁu…Fl›pyPrio
)

415 , (
u32
)
drive_g
, 
desc
);

416 
	}
}

419 
	$boŸ_add_hd
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
)

421 
	`boŸíåy_add
(
IPL_TYPE_HARDDISK
, 
	`defPrio
(
¥io
, 
DeÁu…HDPrio
)

422 , (
u32
)
drive_g
, 
desc
);

423 
	}
}

426 
	$boŸ_add_cd
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
)

428 
	`boŸíåy_add
(
IPL_TYPE_CDROM
, 
	`defPrio
(
¥io
, 
DeÁu…CDPrio
)

429 , (
u32
)
drive_g
, 
desc
);

430 
	}
}

434 
	$boŸ_add_cbfs
(*
d©a
, c⁄° *
desc
, 
¥io
)

436 
	`boŸíåy_add
(
IPL_TYPE_CBFS
, 
	`defPrio
(
¥io
, 
DEFAULT_PRIO
), (
u32
)
d©a
, 
desc
);

437 
	}
}

446 
	$check_f‹_key°roke
()

448 
bªgs
 
br
;

449 
	`mem£t
(&
br
, 0, (br));

450 
br
.
Êags
 = 
F_IF
|
F_ZF
;

451 
br
.
ah
 = 1;

452 
	`ˇŒ16_öt
(0x16, &
br
);

453  !(
br
.
Êags
 & 
F_ZF
);

454 
	}
}

458 
	$gë_øw_key°roke
()

460 
bªgs
 
br
;

461 
	`mem£t
(&
br
, 0, (br));

462 
br
.
Êags
 = 
F_IF
;

463 
	`ˇŒ16_öt
(0x16, &
br
);

464  
br
.
ah
;

465 
	}
}

469 
	$gë_key°roke
(
m£c
)

471 
u32
 
íd
 = 
	`úqtimî_ˇlc
(
m£c
);

473 i‡(
	`check_f‹_key°roke
())

474  
	`gë_øw_key°roke
();

475 i‡(
	`úqtimî_check
(
íd
))

477 
	`yõld_toúq
();

479 
	}
}

486 
	#DEFAULT_BOOTMENU_WAIT
 2500

	)

490 
	$öãø˘ive_boŸmíu
()

494 #i‡
CONFIG_PRINT_TIMESTAMPS


495 
u64
 
tscvÆ
 = 
	`rdts˛l
();

496 
	`d¥ötf
(1, "TSC: Boot Device Menu: 0x%08lx_%08lx\n",

497 ()(
tscvÆ
 >> 32),

498 ()
tscvÆ
);

501 i‡(! 
CONFIG_BOOTMENU
 || !
	`romfûe_lﬂdöt
("etc/show-boot-menu", 1))

504 
	`gë_key°roke
(0) >= 0)

507 *
boŸmsg
 = 
	`romfûe_lﬂdfûe
("ëc/boŸ-míu-mesßge", 
NULL
);

508 
míukey
 = 
	`romfûe_lﬂdöt
("etc/boot-menu-key", 0x86);

509 
	`¥ötf
("%s", 
boŸmsg
 ?: "\nPress F12 for boot menu.\n\n");

510 
	`‰ì
(
boŸmsg
);

512 
u32
 
míutime
 = 
	`romfûe_lﬂdöt
("ëc/boŸ-míu-waô", 
DEFAULT_BOOTMENU_WAIT
);

513 
	`íabÀ_boŸ•œsh
();

514 
sˇn_code
 = 
	`gë_key°roke
(
míutime
);

515 
	`dißbÀ_boŸ•œsh
();

516 i‡(
sˇn_code
 !
míukey
)

519 
	`gë_key°roke
(0) >= 0)

522 
	`¥ötf
("Select boot device:\n\n");

523 
	`waô_thªads
();

525 
m≠_°ru˘
 *
f
 = 
	`romfûe_lﬂdfûe
("ëc/boŸm≠≥r", 
NULL
);

528 
maxmíu
 = 0;

529 
m≠˙t
, 
maxm≠
=0;

530 
boŸíåy_s
 *
pos
;

531 
	`hli°_f‹_óch_íåy
(
pos
, &
BoŸLi°
, 
node
) {

532 
desc
[60];

533 
maxmíu
++;

534 
u8
 
m≠≥d
 = 0;

535 i‡(
f
) {

536 
m≠˙t
=0 ; ; mapcnt++) {

537 i‡(
f
[
m≠˙t
].
m≠_ch¨
 == 0xff) {

538 
maxm≠
 = 
m≠˙t
;

541 
u8
 
é
;

543 
é
 = 0;Å»< 
BOOTMAPPER_STRING_LENGTH
;Ål++) {

544 i‡(
f
[
m≠˙t
].
m≠_°rög
[
é
] == '$') {

545 
f
[
m≠˙t
].
m≠_°rög
[
é
] = 0;

549 i‡(!
	`°rcmp
(
f
[
m≠˙t
].
m≠_°rög
, 
	`°π˝y
(
desc
, 
pos
->
des¸ùti⁄
, 
	`ARRAY_SIZE
(desc)))) {

550 
	`¥ötf
("%c. %s\n", 
f
[
m≠˙t
].
m≠_ch¨
, 
	`°π˝y
(
desc
, 
pos
->
des¸ùti⁄
, 
	`ARRAY_SIZE
(desc)));

551 
f
[
m≠˙t
].
m≠_num
 = 
maxmíu
+1;

552 
m≠≥d
 = 1;

556 i‡(!
m≠≥d
)

557 
	`¥ötf
("%d. %s\n", 
maxmíu
, 
	`°π˝y
(
desc
, 
pos
->
des¸ùti⁄
, 
	`ARRAY_SIZE
(desc)));

562 
sˇn_code
 = 
	`gë_key°roke
(1000);

563 i‡(
sˇn_code
 >1 && sˇn_codê<
maxmíu
+1)

565 i‡(
f
) {

566  
m≠˙t
=0; m≠˙à<
maxm≠
 ; mapcnt++ ) {

567 i‡(
sˇn_code
 =
	`°πﬁ
(
f
[
m≠˙t
].
m≠_key
, 
NULL
, 16)) {

568 
sˇn_code
 = 
f
[
m≠˙t
].
m≠_num
;

569 
maxm≠
 = 0;

573 i‡(!
maxm≠
) ;

576 
	`¥ötf
("\n");

577 i‡(
sˇn_code
 == 0x01)

582 
choi˚
 = 
sˇn_code
 - 1;

583 
	`hli°_f‹_óch_íåy
(
pos
, &
BoŸLi°
, 
node
) {

584 i‡(! --
choi˚
)

587 
	`hli°_dñ
(&
pos
->
node
);

588 
pos
->
¥i‹ôy
 = 0;

589 
	`hli°_add_hód
(&
pos
->
node
, &
BoŸLi°
);

590 
	}
}

593 
	sbev_s
 {

594 
	mty≥
;

595 
u32
 
	mve˘‹
;

597 
bev_s
 
	gBEV
[20];

598 
	gBEVCou¡
;

599 
	gHaveHDBoŸ
, 
	gHaveFDBoŸ
;

602 
	$add_bev
(
ty≥
, 
u32
 
ve˘‹
)

604 i‡(
ty≥
 =
IPL_TYPE_HARDDISK
 && 
HaveHDBoŸ
++)

606 i‡(
ty≥
 =
IPL_TYPE_FLOPPY
 && 
HaveFDBoŸ
++)

608 i‡(
BEVCou¡
 >
	`ARRAY_SIZE
(
BEV
))

610 
bev_s
 *
bev
 = &
BEV
[
BEVCou¡
++];

611 
bev
->
ty≥
 =Åype;

612 
bev
->
ve˘‹
 = vector;

613 
	}
}

617 
	$bcv_¥ïboŸ
()

619 i‡(! 
CONFIG_BOOT
)

622 #i‡
CONFIG_PRINT_TIMESTAMPS


623 
u64
 
tscvÆ
 = 
	`rdts˛l
();

624 
	`d¥ötf
(1, "TSC: StartÜoad from boot device: 0x%08lx_%08lx\n",

625 ()(
tscvÆ
 >> 32),

626 ()
tscvÆ
);

629 
hÆçrio
 = 
	`föd_¥io
("HALT");

630 i‡(
hÆçrio
 >= 0)

631 
	`boŸíåy_add
(
IPL_TYPE_HALT
, 
hÆçrio
, 0, "HALT");

634 
boŸíåy_s
 *
pos
;

635 
	`hli°_f‹_óch_íåy
(
pos
, &
BoŸLi°
, 
node
) {

636 
pos
->
ty≥
) {

637 
IPL_TYPE_BCV
:

638 
	`ˇŒ_bcv
(
pos
->
ve˘‹
.
£g
,Öos->ve˘‹.
off£t
);

639 
	`add_bev
(
IPL_TYPE_HARDDISK
, 0);

641 
IPL_TYPE_FLOPPY
:

642 
	`m≠_Ê›py_drive
(
pos
->
drive
);

643 
	`add_bev
(
IPL_TYPE_FLOPPY
, 0);

645 
IPL_TYPE_HARDDISK
:

646 
	`m≠_hd_drive
(
pos
->
drive
);

647 
	`add_bev
(
IPL_TYPE_HARDDISK
, 0);

649 
IPL_TYPE_CDROM
:

650 
	`m≠_cd_drive
(
pos
->
drive
);

653 
	`add_bev
(
pos
->
ty≥
,Öos->
d©a
);

659 
	`add_bev
(
IPL_TYPE_FLOPPY
, 0);

660 
	`add_bev
(
IPL_TYPE_HARDDISK
, 0);

661 
	}
}

670 
	$ˇŒ_boŸ_íåy
(
£goff_s
 
boŸ£gù
, 
u8
 
boŸdrv
)

672 #i‡
CONFIG_PRINT_TIMESTAMPS


673 
u64
 
tscvÆ
 = 
	`rdts˛l
();

674 
	`d¥ötf
(1, "TSC: End of seabios: 0x%08lx_%08lx\n",

675 ()(
tscvÆ
 >> 32),

676 ()
tscvÆ
);

678 
	`d¥ötf
(1, "BoŸög from %04x:%04x\n", 
boŸ£gù
.
£g
, boŸ£gù.
off£t
);

679 
bªgs
 
br
;

680 
	`mem£t
(&
br
, 0, (br));

681 
br
.
Êags
 = 
F_IF
;

682 
br
.
code
 = 
boŸ£gù
;

684 
br
.
dl
 = 
boŸdrv
;

685 
br
.
ax
 = 0xaa55;

686 
	`ÁrˇŒ16
(&
br
);

687 
	}
}

691 
	$boŸ_disk
(
u8
 
boŸdrv
, 
checksig
)

693 
u16
 
boŸ£g
 = 0x07c0;

696 
bªgs
 
br
;

697 
	`mem£t
(&
br
, 0, (br));

698 
br
.
Êags
 = 
F_IF
;

699 
br
.
dl
 = 
boŸdrv
;

700 
br
.
es
 = 
boŸ£g
;

701 
br
.
ah
 = 2;

702 
br
.
Æ
 = 1;

703 
br
.
˛
 = 1;

704 
	`ˇŒ16_öt
(0x13, &
br
);

706 i‡(
br
.
Êags
 & 
F_CF
) {

707 
	`¥ötf
("Boot failed: couldÇotÑeadÅhe boot disk\n\n");

711 i‡(
checksig
) {

712 
mbr_s
 *
mbr
 = (*)0;

713 i‡(
	`GET_FARVAR
(
boŸ£g
, 
mbr
->
sig«tuª
Ë!
MBR_SIGNATURE
) {

714 
	`¥ötf
("Boot failed:Çotá bootable disk\n\n");

720 
u16
 
boŸù
 = (
boŸ£g
 & 0x0fff) << 4;

721 
boŸ£g
 &= 0xf000;

723 
	`ˇŒ_boŸ_íåy
(
	`SEGOFF
(
boŸ£g
, 
boŸù
), 
boŸdrv
);

724 
	}
}

728 
	$boŸ_cdrom
(
drive_s
 *
drive_g
)

730 i‡(! 
CONFIG_CDROM_BOOT
)

732 
	`¥ötf
("Booting from DVD/CD...\n");

734 
°©us
 = 
	`cdrom_boŸ
(
drive_g
);

735 i‡(
°©us
) {

736 
	`¥ötf
("BoŸ faûed: CouldÇŸÑód from CDROM (codê%04x)\n", 
°©us
);

740 
u8
 
boŸdrv
 = 
CDEmu
.
emuœãd_extdrive
;

741 
u16
 
boŸ£g
 = 
CDEmu
.
lﬂd_£gmít
;

743 
u16
 
boŸù
 = (
boŸ£g
 & 0x0fff) << 4;

744 
boŸ£g
 &= 0xf000;

746 
	`ˇŒ_boŸ_íåy
(
	`SEGOFF
(
boŸ£g
, 
boŸù
), 
boŸdrv
);

747 
	}
}

751 
	$boŸ_cbfs
(
cbfs_fûe
 *
fûe
)

753 i‡(!
CONFIG_COREBOOT_FLASH
)

755 
	`¥ötf
("Booting from CBFS...\n");

756 
	`cbfs_run_∑ylﬂd
(
fûe
);

757 
	}
}

761 
	$boŸ_rom
(
u32
 
ve˘‹
)

763 
	`¥ötf
("Booting from ROM...\n");

764 
£goff_s
 
so
;

765 
so
.
£goff
 = 
ve˘‹
;

766 
	`ˇŒ_boŸ_íåy
(
so
, 0);

767 
	}
}

771 
	$boŸ_Áû
()

773 i‡(
BoŸRëryTime
 =(
u32
)-1)

774 
	`¥ötf
("No bootable device.\n");

776 
	`¥ötf
("No bootable device. Retrying in %d seconds.\n"

777 , 
BoŸRëryTime
/1000);

779 
u32
 
íd
 = 
	`úqtimî_ˇlc
(
BoŸRëryTime
);

781 i‡(
BoŸRëryTime
 !(
u32
)-1 && 
	`úqtimî_check
(
íd
))

783 
	`yõld_toúq
();

785 
	`¥ötf
("Rebooting.\n");

786 
bªgs
 
br
;

787 
	`mem£t
(&
br
, 0, (br));

788 
br
.
code
 = 
	`SEGOFF
(
SEG_BIOS
, (
u32
)
ª£t_ve˘‹
);

789 
	`ÁrˇŒ16big
(&
br
);

790 
	}
}

794 
	$do_boŸ
(
£q_ƒ
)

796 i‡(! 
CONFIG_BOOT
)

797 
	`∑nic
("Boot supportÇot compiled in.\n");

799 i‡(
£q_ƒ
 >
BEVCou¡
)

800 
	`boŸ_Áû
();

803 
bev_s
 *
õ
 = &
BEV
[
£q_ƒ
];

804 
õ
->
ty≥
) {

805 
IPL_TYPE_FLOPPY
:

806 
	`¥ötf
("Booting from Floppy...\n");

807 
	`boŸ_disk
(0x00, 
CheckFl›pySig
);

809 
IPL_TYPE_HARDDISK
:

810 
	`¥ötf
("Booting from Hard Disk...\n");

811 
	`boŸ_disk
(0x80, 1);

813 
IPL_TYPE_CDROM
:

814 
	`boŸ_cdrom
((*)
õ
->
ve˘‹
);

816 
IPL_TYPE_CBFS
:

817 
	`boŸ_cbfs
((*)
õ
->
ve˘‹
);

819 
IPL_TYPE_BEV
:

820 
	`boŸ_rom
(
õ
->
ve˘‹
);

822 
IPL_TYPE_HALT
:

823 
	`boŸ_Áû
();

828 
bªgs
 
br
;

829 
	`mem£t
(&
br
, 0, (br));

830 
br
.
Êags
 = 
F_IF
;

831 
	`ˇŒ16_öt
(0x18, &
br
);

832 
	}
}

834 
BoŸSequí˚
 
	gVARLOW
 = -1;

837 
VISIBLE32FLAT


838 
	$h™dÀ_18
()

840 
	`debug_íãr
(
NULL
, 
DEBUG_HDL_18
);

841 
£q
 = 
BoŸSequí˚
 + 1;

842 
BoŸSequí˚
 = 
£q
;

843 
	`do_boŸ
(
£q
);

844 
	}
}

847 
VISIBLE32FLAT


848 
	$h™dÀ_19
()

850 
	`debug_íãr
(
NULL
, 
DEBUG_HDL_19
);

851 
BoŸSequí˚
 = 0;

852 
	`do_boŸ
(0);

853 
	}
}

	@boot.h

7 #i‚de‡
__BOOTMAPPER_H


8 
	#__BOOTMAPPER_H


	)

10 
	#BOOTMAPPER_STRING_LENGTH
 40

	)

12 
	sm≠_°ru˘
 {

13 
u8
 
	mm≠_ch¨
;

14 
	mm≠_key
[2];

15 
u8
 
	mm≠_num
;

16 
	mm≠_°rög
[
BOOTMAPPER_STRING_LENGTH
];

	@bootsplash.c

8 
	~"bªgs.h
"

9 
	~"c⁄fig.h
"

10 
	~"ÁΩå.h
"

11 
	~"mÆloc.h
"

12 
	~"ouçut.h
"

13 
	~"romfûe.h
"

14 
	~"°acks.h
"

15 
	~"°d/vbe.h
"

16 
	~"°rög.h
"

17 
	~"utû.h
"

26 
	$ˇŒ16_öt10
(
bªgs
 *
br
)

28 
br
->
Êags
 = 
F_IF
;

29 
	`°¨t_¥ìm±
();

30 
	`ˇŒ16_öt
(0x10, 
br
);

31 
	`föish_¥ìm±
();

32 
	}
}

40 
	$íabÀ_vga_c⁄sﬁe
()

42 
	`d¥ötf
(1, "Turning on vgaÅext mode console\n");

43 
bªgs
 
br
;

46 
	`mem£t
(&
br
, 0, (br));

47 
br
.
ax
 = 0x0003;

48 
	`ˇŒ16_öt10
(&
br
);

51 
	`¥ötf
("SóBIOS (vîsi⁄ %s)\n", 
VERSION
);

52 
	`di•œy_uuid
();

53 
	}
}

56 
	$föd_videomode
(
vbe_öfo
 *
veß_öfo
, 
vbe_mode_öfo
 *
mode_öfo


57 , 
width
, 
height
, 
bµ_ªq
)

59 
	`d¥ötf
(3, "Finding vesa mode with dimensions %d x %d (%d bpp)\n",

60 
width
, 
height
, 
bµ_ªq
);

61 
u16
 *
videomodes
 = 
	`SEGOFF_TO_FLATPTR
(
veß_öfo
->
video_mode
);

62 ;; 
videomodes
++) {

63 
u16
 
videomode
 = *
videomodes
;

64 i‡(
videomode
 == 0xffff) {

65 
	`d¥ötf
(1, "UnableÅo find vesa video mode with dimensions %d x %d (%d bpp)\n",

66 
width
, 
height
, 
bµ_ªq
);

69 
bªgs
 
br
;

70 
	`mem£t
(&
br
, 0, (br));

71 
br
.
ax
 = 0x4f01;

72 
br
.
cx
 = 
videomode
;

73 
br
.
di
 = 
	`FLATPTR_TO_OFFSET
(
mode_öfo
);

74 
br
.
es
 = 
	`FLATPTR_TO_SEG
(
mode_öfo
);

75 
	`ˇŒ16_öt10
(&
br
);

76 i‡(
br
.
ax
 != 0x4f) {

77 
	`d¥ötf
(1, "get_mode failed.\n");

80 i‡(
mode_öfo
->
xªs
 !
width


81 || 
mode_öfo
->
yªs
 !
height
)

83 
u8
 
dïth
 = 
mode_öfo
->
bôs_≥r_pixñ
;

84 i‡(
bµ_ªq
 == 0) {

85 i‡(
dïth
 != 16 && depth != 24 && depth != 32)

88 i‡(
dïth
 !
bµ_ªq
)

92 i‡((
dïth
 == 16) &&

93 ((
mode_öfo
->
ªd_size
 != 5) ||

94 (
mode_öfo
->
gªí_size
 != 6) ||

95 (
mode_öfo
->
blue_size
 != 5)))

97  
videomode
;

99 
	}
}

101 
	gBoŸ•œshA˘ive
;

104 
	$íabÀ_boŸ•œsh
()

106 i‡(!
CONFIG_BOOTSPLASH
)

109 
	`d¥ötf
(3, "Checking for bootsplash\n");

110 
u8
 
ty≥
 = 0;

111 
fûesize
;

112 
u8
 *
fûed©a
 = 
	`romfûe_lﬂdfûe
("boŸ•œsh.jpg", &
fûesize
);

113 i‡(!
fûed©a
) {

114 
fûed©a
 = 
	`romfûe_lﬂdfûe
("boŸ•œsh.bmp", &
fûesize
);

115 i‡(!
fûed©a
)

117 
ty≥
 = 1;

119 
	`d¥ötf
(3, "start showing bootsplash\n");

121 
u8
 *
pi˘uª
 = 
NULL
;

122 
j≥g_decd©a
 *
j≥g
 = 
NULL
;

123 
bmp_decd©a
 *
bmp
 = 
NULL
;

124 
vbe_öfo
 *
veß_öfo
 = 
	`mÆloc_tm∂ow
((*vesa_info));

125 
vbe_mode_öfo
 *
mode_öfo
 = 
	`mÆloc_tm∂ow
((*mode_info));

126 i‡(!
veß_öfo
 || !
mode_öfo
) {

127 
	`w¨n_nﬂŒoc
();

128 
d⁄e
;

132 
	`mem£t
(
veß_öfo
, 0, (
vbe_öfo
));

133 
veß_öfo
->
sig«tuª
 = 
VBE2_SIGNATURE
;

134 
bªgs
 
br
;

135 
	`mem£t
(&
br
, 0, (br));

136 
br
.
ax
 = 0x4f00;

137 
br
.
di
 = 
	`FLATPTR_TO_OFFSET
(
veß_öfo
);

138 
br
.
es
 = 
	`FLATPTR_TO_SEG
(
veß_öfo
);

139 
	`ˇŒ16_öt10
(&
br
);

140 i‡(
veß_öfo
->
sig«tuª
 !
VESA_SIGNATURE
) {

141 
	`d¥ötf
(1,"No VBE2 found.\n");

142 
d⁄e
;

146 *
víd‹
 = 
	`SEGOFF_TO_FLATPTR
(
veß_öfo
->
€m_víd‹_°rög
);

147 *
¥odu˘
 = 
	`SEGOFF_TO_FLATPTR
(
veß_öfo
->
€m_¥odu˘_°rög
);

148 
	`d¥ötf
(3, "VESA %d.%d\nVENDOR: %s\nPRODUCT: %s\n",

149 
veß_öfo
->
vîsi⁄
>>8, vesa_info->version&0xff,

150 
víd‹
, 
¥odu˘
);

152 
ªt
, 
width
, 
height
;

153 
bµ_ªquúe
 = 0;

154 i‡(
ty≥
 == 0) {

155 
j≥g
 = 
	`j≥g_Æloc
();

156 i‡(!
j≥g
) {

157 
	`w¨n_nﬂŒoc
();

158 
d⁄e
;

161 
	`d¥ötf
(5, "Decoding bootsplash.jpg\n");

162 
ªt
 = 
	`j≥g_decode
(
j≥g
, 
fûed©a
);

163 i‡(
ªt
) {

164 
	`d¥ötf
(1, "j≥g_decodêÁûed wôhÑëu∫ codê%d...\n", 
ªt
);

165 
d⁄e
;

167 
	`j≥g_gë_size
(
j≥g
, &
width
, &
height
);

169 
bmp
 = 
	`bmp_Æloc
();

170 i‡(!
bmp
) {

171 
	`w¨n_nﬂŒoc
();

172 
d⁄e
;

175 
	`d¥ötf
(5, "Decoding bootsplash.bmp\n");

176 
ªt
 = 
	`bmp_decode
(
bmp
, 
fûed©a
, 
fûesize
);

177 i‡(
ªt
) {

178 
	`d¥ötf
(1, "bmp_decodêÁûed wôhÑëu∫ codê%d...\n", 
ªt
);

179 
d⁄e
;

181 
	`bmp_gë_size
(
bmp
, &
width
, &
height
);

182 
bµ_ªquúe
 = 24;

187 
videomode
 = 
	`föd_videomode
(
veß_öfo
, 
mode_öfo
, 
width
, 
height
,

188 
bµ_ªquúe
);

189 i‡(
videomode
 < 0) {

190 
	`d¥ötf
(1, "failedÅo findá videomode with %dx%d %dbpp (0=any).\n",

191 
width
, 
height
, 
bµ_ªquúe
);

192 
d⁄e
;

194 *
‰amebuf„r
 = (*)
mode_öfo
->
phys_ba£
;

195 
dïth
 = 
mode_öfo
->
bôs_≥r_pixñ
;

196 
	`d¥ötf
(3, "mode: %04x\n", 
videomode
);

197 
	`d¥ötf
(3, "‰amebuf„r: %p\n", 
‰amebuf„r
);

198 
	`d¥ötf
(3, "byã†≥∏sˇ∆öe: %d\n", 
mode_öfo
->
byãs_≥r_sˇ∆öe
);

199 
	`d¥ötf
(3, "bô†≥∏pixñ: %d\n", 
dïth
);

202 
imagesize
 = 
height
 * 
mode_öfo
->
byãs_≥r_sˇ∆öe
;

203 
pi˘uª
 = 
	`mÆloc_tmphigh
(
imagesize
);

204 i‡(!
pi˘uª
) {

205 
	`w¨n_nﬂŒoc
();

206 
d⁄e
;

209 i‡(
ty≥
 == 0) {

210 
	`d¥ötf
(5, "Decompressing bootsplash.jpg\n");

211 
ªt
 = 
	`j≥g_show
(
j≥g
, 
pi˘uª
, 
width
, 
height
, 
dïth
,

212 
mode_öfo
->
byãs_≥r_sˇ∆öe
);

213 i‡(
ªt
) {

214 
	`d¥ötf
(1, "j≥g_show faûed wôhÑëu∫ codê%d...\n", 
ªt
);

215 
d⁄e
;

218 
	`d¥ötf
(5, "Decompressing bootsplash.bmp\n");

219 
ªt
 = 
	`bmp_show
(
bmp
, 
pi˘uª
, 
width
, 
height
, 
dïth
,

220 
mode_öfo
->
byãs_≥r_sˇ∆öe
);

221 i‡(
ªt
) {

222 
	`d¥ötf
(1, "bmp_show faûed wôhÑëu∫ codê%d...\n", 
ªt
);

223 
d⁄e
;

228 
	`d¥ötf
(5, "SwitchingÅo graphics mode\n");

229 
	`mem£t
(&
br
, 0, (br));

230 
br
.
ax
 = 0x4f02;

231 
br
.
bx
 = 
videomode
 | 
VBE_MODE_LINEAR_FRAME_BUFFER
;

232 
	`ˇŒ16_öt10
(&
br
);

233 i‡(
br
.
ax
 != 0x4f) {

234 
	`d¥ötf
(1, "set_mode failed.\n");

235 
d⁄e
;

239 
	`d¥ötf
(5, "Showing bootsplashÖicture\n");

240 
	`iomem˝y
(
‰amebuf„r
, 
pi˘uª
, 
imagesize
);

241 
	`d¥ötf
(5, "Bootsplash copy complete\n");

242 
BoŸ•œshA˘ive
 = 1;

244 
d⁄e
:

245 
	`‰ì
(
fûed©a
);

246 
	`‰ì
(
pi˘uª
);

247 
	`‰ì
(
veß_öfo
);

248 
	`‰ì
(
mode_öfo
);

249 
	`‰ì
(
j≥g
);

250 
	`‰ì
(
bmp
);

252 
	}
}

255 
	$dißbÀ_boŸ•œsh
()

257 i‡(!
CONFIG_BOOTSPLASH
 || !
BoŸ•œshA˘ive
)

259 
BoŸ•œshA˘ive
 = 0;

260 
	`íabÀ_vga_c⁄sﬁe
();

261 
	}
}

	@bregs.h

7 #i‚de‡
__BREGS_H


8 
	#__BREGS_H


	)

10 
	~"ty≥s.h
"

11 
	~"x86.h
"

18 
	#UREG
(
ER
, 
R
, 
RH
, 
RL
Ëuni⁄ { 
u32
 ER; såu˘ { 
u16
 R; u16 R ## 
_hi
; }; såu˘ { 
u8
 RL; u8 RH; u8 R ## 
_hûo
; u8 R ## 
_hihi
; }; }

	)

23 
	sbªgs
 {

24 
u16
 
	mds
;

25 
u16
 
	mes
;

26 
UREG
(
edi
, 
di
, 
di8u
, 
di8l
);

27 
UREG
(
esi
, 
si
, 
si8u
, 
si8l
);

28 
UREG
(
ebp
, 
bp
, 
bp8u
, 
bp8l
);

29 
UREG
(
ebx
, 
bx
, 
bh
, 
bl
);

30 
UREG
(
edx
, 
dx
, 
dh
, 
dl
);

31 
UREG
(
ecx
, 
cx
, 
ch
, 
˛
);

32 
UREG
(
óx
, 
ax
, 
ah
, 
Æ
);

33 
£goff_s
 
	mcode
;

34 
u16
 
	mÊags
;

35 } 
	gPACKED
;

42 
ölöe
 

43 
	$£t_cf
(
bªgs
 *
ªgs
, 
c⁄d
)

45 i‡(
c⁄d
)

46 
ªgs
->
Êags
 |
F_CF
;

48 
ªgs
->
Êags
 &~
F_CF
;

49 
	}
}

52 
	#RET_EUNSUPPORTED
 0x86

	)

54 
ölöe
 

55 
	$£t_suc˚ss
(
bªgs
 *
ªgs
)

57 
	`£t_cf
(
ªgs
, 0);

58 
	}
}

60 
ölöe
 

61 
	$£t_code_suc˚ss
(
bªgs
 *
ªgs
)

63 
ªgs
->
ah
 = 0;

64 
	`£t_cf
(
ªgs
, 0);

65 
	}
}

67 
ölöe
 

68 
	$£t_övÆid_sûít
(
bªgs
 *
ªgs
)

70 
	`£t_cf
(
ªgs
, 1);

71 
	}
}

73 
ölöe
 

74 
	$£t_code_övÆid_sûít
(
bªgs
 *
ªgs
, 
u8
 
code
)

76 
ªgs
->
ah
 = 
code
;

77 
	`£t_cf
(
ªgs
, 1);

78 
	}
}

	@byteorder.h

1 #i‚de‡
__BYTEORDER_H


2 
	#__BYTEORDER_H


	)

4 
	~"ty≥s.h
"

6 
ölöe
 
u16
 
	$__swab16_c⁄°™t
(
u16
 
vÆ
) {

7  (
vÆ
<<8) | (val>>8);

8 
	}
}

9 
ölöe
 
u32
 
	$__swab32_c⁄°™t
(
u32
 
vÆ
) {

10  (
vÆ
<<24) | ((val&0xff00)<<8) | ((val&0xff0000)>>8) | (val>>24);

11 
	}
}

12 
ölöe
 
u64
 
	$__swab64_c⁄°™t
(
u64
 
vÆ
) {

13  ((
u64
)
	`__swab32_c⁄°™t
(
vÆ
) << 32) | __swab32_constant(val>>32);

14 
	}
}

15 
ölöe
 
u32
 
	$__swab32
(
u32
 
vÆ
) {

16 
	`asm
("bsw≠»%0" : "+r"(
vÆ
));

17  
vÆ
;

18 
	}
}

19 
ölöe
 
u64
 
	$__swab64
(
u64
 
vÆ
) {

20 
u64_u32_u
 
i
, 
o
;

21 
i
.
vÆ
 = val;

22 
o
.
lo
 = 
	`__swab32
(
i
.
hi
);

23 
o
.
hi
 = 
	`__swab32
(
i
.
lo
);

24  
o
.
vÆ
;

25 
	}
}

27 
	#swab16
(
x
Ë
	`__swab16_c⁄°™t
(x)

	)

28 
	#swab32
(
x
Ë(
	`__buûtö_c⁄°™t_p
((
u32
)(x)) \

29 ? 
	`__swab32_c⁄°™t
(
x
Ë: 
	`__swab32
(x))

	)

30 
	#swab64
(
x
Ë(
	`__buûtö_c⁄°™t_p
((
u64
)(x)) \

31 ? 
	`__swab64_c⁄°™t
(
x
Ë: 
	`__swab64
(x))

	)

33 
ölöe
 
u16
 
	$˝u_to_À16
(
u16
 
x
) {

34  
x
;

35 
	}
}

36 
ölöe
 
u32
 
	$˝u_to_À32
(
u32
 
x
) {

37  
x
;

38 
	}
}

39 
ölöe
 
u64
 
	$˝u_to_À64
(
u64
 
x
) {

40  
x
;

41 
	}
}

42 
ölöe
 
u16
 
	$À16_to_˝u
(
u16
 
x
) {

43  
x
;

44 
	}
}

45 
ölöe
 
u32
 
	$À32_to_˝u
(
u32
 
x
) {

46  
x
;

47 
	}
}

48 
ölöe
 
u64
 
	$À64_to_˝u
(
u64
 
x
) {

49  
x
;

50 
	}
}

52 
ölöe
 
u16
 
	$˝u_to_be16
(
u16
 
x
) {

53  
	`swab16
(
x
);

54 
	}
}

55 
ölöe
 
u32
 
	$˝u_to_be32
(
u32
 
x
) {

56  
	`swab32
(
x
);

57 
	}
}

58 
ölöe
 
u64
 
	$˝u_to_be64
(
u64
 
x
) {

59  
	`swab64
(
x
);

60 
	}
}

61 
ölöe
 
u16
 
	$be16_to_˝u
(
u16
 
x
) {

62  
	`swab16
(
x
);

63 
	}
}

64 
ölöe
 
u32
 
	$be32_to_˝u
(
u32
 
x
) {

65  
	`swab32
(
x
);

66 
	}
}

67 
ölöe
 
u64
 
	$be64_to_˝u
(
u64
 
x
) {

68  
	`swab64
(
x
);

69 
	}
}

	@cdrom.c

8 
	~"biosv¨.h
"

9 
	~"block.h
"

10 
	~"bªgs.h
"

11 
	~"hw/©a.h
"

12 
	~"hw/blockcmd.h
"

13 
	~"mÆloc.h
"

14 
	~"ouçut.h
"

15 
	~"°d/disk.h
"

16 
	~"°rög.h
"

17 
	~"utû.h
"

20 
u8
 
	gCDRom_locks
[
BUILD_MAX_EXTDRIVE
] 
	gVARLOW
;

27 
cdemu_s
 
CDEmu
 
	gVARLOW
;

28 
drive_s
 *
cdemu_drive_gf
 
	gVARFSEG
;

31 
	$cdemu_ªad
(
disk_›_s
 *
›
)

33 
drive_s
 *
drive_gf
 = 
	`GET_LOW
(
CDEmu
.
emuœãd_drive_gf
);

34 
disk_›_s
 
d›
;

35 
d›
.
drive_gf
 = drive_gf;

36 
d›
.
comm™d
 = 
›
->command;

37 
d›
.
lba
 = 
	`GET_LOW
(
CDEmu
.
ûba
Ë+ 
›
->lba / 4;

39 
cou¡
 = 
›
->count;

40 
›
->
cou¡
 = 0;

41 
u8
 *
cdbuf_Ê
 = 
	`GET_GLOBAL
(
boun˚_buf_Ê
);

43 i‡(
›
->
lba
 & 3) {

45 
d›
.
cou¡
 = 1;

46 
d›
.
buf_Ê
 = 
cdbuf_Ê
;

47 
ªt
 = 
	`¥o˚ss_›
(&
d›
);

48 i‡(
ªt
)

49  
ªt
;

50 
u8
 
thiscou¡
 = 4 - (
›
->
lba
 & 3);

51 i‡(
thiscou¡
 > 
cou¡
)

52 
thiscou¡
 = 
cou¡
;

53 
cou¡
 -
thiscou¡
;

54 
	`mem˝y_Ê
(
›
->
buf_Ê
, 
cdbuf_Ê
 + (›->
lba
 & 3Ë* 512, 
thiscou¡
 * 512);

55 
›
->
buf_Ê
 +
thiscou¡
 * 512;

56 
›
->
cou¡
 +
thiscou¡
;

57 
d›
.
lba
++;

60 i‡(
cou¡
 > 3) {

62 
d›
.
cou¡
 = count / 4;

63 
d›
.
buf_Ê
 = 
›
->buf_fl;

64 
ªt
 = 
	`¥o˚ss_›
(&
d›
);

65 
›
->
cou¡
 +
d›
.count * 4;

66 i‡(
ªt
)

67  
ªt
;

68 
u8
 
thiscou¡
 = 
cou¡
 & ~3;

69 
cou¡
 &= 3;

70 
›
->
buf_Ê
 +
thiscou¡
 * 512;

71 
d›
.
lba
 +
thiscou¡
 / 4;

74 i‡(
cou¡
) {

76 
d›
.
cou¡
 = 1;

77 
d›
.
buf_Ê
 = 
cdbuf_Ê
;

78 
ªt
 = 
	`¥o˚ss_›
(&
d›
);

79 i‡(
ªt
)

80  
ªt
;

81 
u8
 
thiscou¡
 = 
cou¡
;

82 
	`mem˝y_Ê
(
›
->
buf_Ê
, 
cdbuf_Ê
, 
thiscou¡
 * 512);

83 
›
->
cou¡
 +
thiscou¡
;

86  
DISK_RET_SUCCESS
;

87 
	}
}

90 
	$¥o˚ss_cdemu_›
(
disk_›_s
 *
›
)

92 i‡(!
CONFIG_CDROM_EMU
)

95 
›
->
comm™d
) {

96 
CMD_READ
:

97  
	`cdemu_ªad
(
›
);

98 
CMD_WRITE
:

99 
CMD_FORMAT
:

100  
DISK_RET_EWRITEPROTECT
;

101 
CMD_VERIFY
:

102 
CMD_RESET
:

103 
CMD_SEEK
:

104 
CMD_ISREADY
:

105  
DISK_RET_SUCCESS
;

107  
DISK_RET_EPARAM
;

109 
	}
}

112 
	$cdrom_¥ïboŸ
()

114 i‡(!
CONFIG_CDROM_EMU
)

116 i‡(!
CDCou¡
)

118 i‡(
	`¸óã_boun˚_buf
() < 0)

121 
drive_s
 *
drive
 = 
	`mÆloc_f£g
((*drive));

122 i‡(!
drive
) {

123 
	`w¨n_nﬂŒoc
();

124 
	`‰ì
(
drive
);

127 
cdemu_drive_gf
 = 
drive
;

128 
	`mem£t
(
drive
, 0, (*drive));

129 
drive
->
ty≥
 = 
DTYPE_CDEMU
;

130 
drive
->
blksize
 = 
DISK_SECTOR_SIZE
;

131 
drive
->
£˘‹s
 = (
u64
)-1;

132 
	}
}

134 
	#SET_INT13ET
(
ªgs
,
v¨
,
vÆ
) \

135 
	`SET_FARVAR
((
ªgs
)->
ds
, ((
ñt‹ôo_s
*)(‘egs)->
si
+0))->
v¨
, (
vÆ
))

	)

139 
	$cdemu_134b
(
bªgs
 *
ªgs
)

142 
	`SET_INT13ET
(
ªgs
, 
size
, 0x13);

143 
	`SET_INT13ET
(
ªgs
, 
medü
, 
	`GET_LOW
(
CDEmu
.media));

144 
	`SET_INT13ET
(
ªgs
, 
emuœãd_drive
, 
	`GET_LOW
(
CDEmu
.
emuœãd_extdrive
));

145 
drive_s
 *
drive_gf
 = 
	`GET_LOW
(
CDEmu
.
emuœãd_drive_gf
);

146 
u8
 
˙é_id
 = 0;

147 i‡(
drive_gf
)

148 
˙é_id
 = 
	`GET_GLOBALFLAT
(
drive_gf
->cntl_id);

149 
	`SET_INT13ET
(
ªgs
, 
c⁄åﬁÀr_ödex
, 
˙é_id
 / 2);

150 
	`SET_INT13ET
(
ªgs
, 
devi˚_•ec
, 
˙é_id
 % 2);

151 
	`SET_INT13ET
(
ªgs
, 
ûba
, 
	`GET_LOW
(
CDEmu
.ilba));

152 
	`SET_INT13ET
(
ªgs
, 
buf„r_£gmít
, 
	`GET_LOW
(
CDEmu
.buffer_segment));

153 
	`SET_INT13ET
(
ªgs
, 
lﬂd_£gmít
, 
	`GET_LOW
(
CDEmu
.load_segment));

154 
	`SET_INT13ET
(
ªgs
, 
£˘‹_cou¡
, 
	`GET_LOW
(
CDEmu
.sector_count));

155 
	`SET_INT13ET
(
ªgs
, 
cylödîs
, 
	`GET_LOW
(
CDEmu
.
lchs
.
cylödî
));

156 
	`SET_INT13ET
(
ªgs
, 
£˘‹s
, 
	`GET_LOW
(
CDEmu
.
lchs
.
£˘‹
));

157 
	`SET_INT13ET
(
ªgs
, 
hóds
, 
	`GET_LOW
(
CDEmu
.
lchs
.
hód
));

160 i‡(
ªgs
->
Æ
 == 0x00) {

162 
	`SET_LOW
(
CDEmu
.
a˘ive
, 0x00);

167 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

168 
	}
}

176 
	$cdrom_boŸ
(
drive_s
 *
drive
)

178 
	`ASSERT32FLAT
();

179 
disk_›_s
 
d›
;

180 
cdid
 = 
	`gëDriveId
(
EXTTYPE_CD
, 
drive
);

181 
	`mem£t
(&
d›
, 0, (dop));

182 
d›
.
drive_gf
 = 
drive
;

183 i‡(!
d›
.
drive_gf
 || 
cdid
 < 0)

186 
ªt
 = 
	`scsi_is_ªady
(&
d›
);

187 i‡(
ªt
)

188 
	`d¥ötf
(1, "scsi_is_ªadyÑëu∫ed %d\n", 
ªt
);

191 
u8
 
buf„r
[
CDROM_SECTOR_SIZE
];

192 
d›
.
lba
 = 0x11;

193 
d›
.
cou¡
 = 1;

194 
d›
.
buf_Ê
 = 
buf„r
;

195 
ªt
 = 
	`cdb_ªad
(&
d›
);

196 i‡(
ªt
)

200 i‡(
buf„r
[0])

202 i‡(
	`°rcmp
((*)&
buf„r
[1], "CD001\001EL TORITO SPECIFICATION") != 0)

206 
u32
 
lba
 = *(u32*)&
buf„r
[0x47];

209 
d›
.
lba
 =Üba;

210 
d›
.
cou¡
 = 1;

211 
ªt
 = 
	`cdb_ªad
(&
d›
);

212 i‡(
ªt
)

216 i‡(
buf„r
[0x00] != 0x01)

218 i‡(
buf„r
[0x01] != 0x00)

220 i‡(
buf„r
[0x1E] != 0x55)

222 i‡(
buf„r
[0x1F] != 0xAA)

226 i‡(
buf„r
[0x20] != 0x88)

229 
u8
 
medü
 = 
buf„r
[0x21];

230 
CDEmu
.
medü
 = media;

232 
CDEmu
.
emuœãd_drive_gf
 = 
d›
.
drive_gf
;

234 
u16
 
boŸ_£gmít
 = *(u16*)&
buf„r
[0x22];

235 i‡(!
boŸ_£gmít
)

236 
boŸ_£gmít
 = 0x07C0;

237 
CDEmu
.
lﬂd_£gmít
 = 
boŸ_£gmít
;

238 
CDEmu
.
buf„r_£gmít
 = 0x0000;

240 
u16
 
nb£˘‹s
 = *(u16*)&
buf„r
[0x26];

241 
CDEmu
.
£˘‹_cou¡
 = 
nb£˘‹s
;

243 
lba
 = *(
u32
*)&
buf„r
[0x28];

244 
CDEmu
.
ûba
 = 
lba
;

247 
d›
.
lba
 =Üba;

248 
d›
.
cou¡
 = 
	`DIV_ROUND_UP
(
nb£˘‹s
, 4);

249 
d›
.
buf_Ê
 = 
	`MAKE_FLATPTR
(
boŸ_£gmít
, 0);

250 
ªt
 = 
	`cdb_ªad
(&
d›
);

251 i‡(
ªt
)

254 i‡(
medü
 == 0) {

256 
CDEmu
.
emuœãd_extdrive
 = 
EXTSTART_CD
 + 
cdid
;

261 i‡(! 
CONFIG_CDROM_EMU
 || !
cdemu_drive_gf
)

266 i‡(
medü
 < 4) {

268 
CDEmu
.
emuœãd_extdrive
 = 0x00;

270 
	`£t_equùmít_Êags
(0x41, 0x41);

272 
medü
) {

274 
CDEmu
.
lchs
.
£˘‹
 = 15;

275 
CDEmu
.
lchs
.
cylödî
 = 80;

276 
CDEmu
.
lchs
.
hód
 = 2;

279 
CDEmu
.
lchs
.
£˘‹
 = 18;

280 
CDEmu
.
lchs
.
cylödî
 = 80;

281 
CDEmu
.
lchs
.
hód
 = 2;

284 
CDEmu
.
lchs
.
£˘‹
 = 36;

285 
CDEmu
.
lchs
.
cylödî
 = 80;

286 
CDEmu
.
lchs
.
hód
 = 2;

291 
CDEmu
.
emuœãd_extdrive
 = 0x80;

292 
	`SET_BDA
(
hdcou¡
, 
	`GET_BDA
(hdcount) + 1);

295 
mbr_s
 *
mbr
 = (*)0;

296 
u8
 
•tcyl
 = 
	`GET_FARVAR
(
boŸ_£gmít
, 
mbr
->
∑πôi⁄s
[0].
œ°
.sptcyl);

297 
u8
 
cyŒow
 = 
	`GET_FARVAR
(
boŸ_£gmít
, 
mbr
->
∑πôi⁄s
[0].
œ°
.cyllow);

298 
u8
 
hóds
 = 
	`GET_FARVAR
(
boŸ_£gmít
, 
mbr
->
∑πôi⁄s
[0].
œ°
.heads);

300 
CDEmu
.
lchs
.
£˘‹
 = 
•tcyl
 & 0x3f;

301 
CDEmu
.
lchs
.
cylödî
 = ((
•tcyl
<<2)&0x300Ë+ 
cyŒow
 + 1;

302 
CDEmu
.
lchs
.
hód
 = 
hóds
 + 1;

306 
CDEmu
.
a˘ive
 = 0x01;

307 
	`d¥ötf
(6, "cdemu medü=%d\n", 
medü
);

310 
	}
}

	@clock.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"hw/pic.h
"

11 
	~"hw/πc.h
"

12 
	~"hw/usb-hid.h
"

13 
	~"ouçut.h
"

14 
	~"°acks.h
"

15 
	~"°rög.h
"

16 
	~"utû.h
"

23 
u32


24 
	$bcd2bö
(
u8
 
vÆ
)

26  (
vÆ
 & 0xf) + ((val >> 4) * 10);

27 
	}
}

29 
u8
 
Cítury
 
	gVARLOW
;

32 
	$˛ock_£tup
()

34 
	`d¥ötf
(3, "initÅimer\n");

35 
	`pô_£tup
();

37 
	`πc_£tup
();

38 
	`πc_upd©ög
();

39 
u32
 
£c⁄ds
 = 
	`bcd2bö
(
	`πc_ªad
(
CMOS_RTC_SECONDS
));

40 
u32
 
möuãs
 = 
	`bcd2bö
(
	`πc_ªad
(
CMOS_RTC_MINUTES
));

41 
u32
 
hours
 = 
	`bcd2bö
(
	`πc_ªad
(
CMOS_RTC_HOURS
));

42 
u32
 
ticks
 = 
	`ticks_‰om_ms
(((
hours
 * 60 + 
möuãs
Ë* 60 + 
£c⁄ds
) * 1000);

43 
	`SET_BDA
(
timî_cou¡î
, 
ticks
 % 
TICKS_PER_DAY
);

46 i‡(
CONFIG_QEMU
) {

47 
Cítury
 = 
	`πc_ªad
(
CMOS_CENTURY
);

50 
u8
 
yór
 = 
	`πc_ªad
(
CMOS_RTC_YEAR
);

51 i‡(
yór
 > 0x80)

52 
Cítury
 = 0x19;

54 
Cítury
 = 0x20;

57 
	`íabÀ_hwúq
(0, 
	`FUNC16
(
íåy_08
));

58 
	`íabÀ_hwúq
(8, 
	`FUNC16
(
íåy_70
));

59 
	}
}

68 
	$h™dÀ_1a00
(
bªgs
 *
ªgs
)

70 
	`yõld
();

71 
u32
 
ticks
 = 
	`GET_BDA
(
timî_cou¡î
);

72 
ªgs
->
cx
 = 
ticks
 >> 16;

73 
ªgs
->
dx
 = 
ticks
;

74 
ªgs
->
Æ
 = 
	`GET_BDA
(
timî_rﬁlovî
);

75 
	`SET_BDA
(
timî_rﬁlovî
, 0);

76 
	`£t_suc˚ss
(
ªgs
);

77 
	}
}

81 
	$h™dÀ_1a01
(
bªgs
 *
ªgs
)

83 
u32
 
ticks
 = (
ªgs
->
cx
 << 16Ë|Ñegs->
dx
;

84 
	`SET_BDA
(
timî_cou¡î
, 
ticks
);

85 
	`SET_BDA
(
timî_rﬁlovî
, 0);

87 
ªgs
->
ah
 = 0;

88 
	`£t_suc˚ss
(
ªgs
);

89 
	}
}

93 
	$h™dÀ_1a02
(
bªgs
 *
ªgs
)

95 i‡(
	`πc_upd©ög
()) {

96 
	`£t_övÆid
(
ªgs
);

100 
ªgs
->
dh
 = 
	`πc_ªad
(
CMOS_RTC_SECONDS
);

101 
ªgs
->
˛
 = 
	`πc_ªad
(
CMOS_RTC_MINUTES
);

102 
ªgs
->
ch
 = 
	`πc_ªad
(
CMOS_RTC_HOURS
);

103 
ªgs
->
dl
 = 
	`πc_ªad
(
CMOS_STATUS_B
Ë& 
RTC_B_DSE
;

104 
ªgs
->
ah
 = 0;

105 
ªgs
->
Æ
 =Ñegs->
ch
;

106 
	`£t_suc˚ss
(
ªgs
);

107 
	}
}

111 
	$h™dÀ_1a03
(
bªgs
 *
ªgs
)

123 i‡(
	`πc_upd©ög
()) {

124 
	`πc_£tup
();

127 
	`πc_wrôe
(
CMOS_RTC_SECONDS
, 
ªgs
->
dh
);

128 
	`πc_wrôe
(
CMOS_RTC_MINUTES
, 
ªgs
->
˛
);

129 
	`πc_wrôe
(
CMOS_RTC_HOURS
, 
ªgs
->
ch
);

131 
u8
 
vÆ8
 = ((
	`πc_ªad
(
CMOS_STATUS_B
Ë& (
RTC_B_PIE
|
RTC_B_AIE
))

132 | 
RTC_B_24HR
 | (
ªgs
->
dl
 & 
RTC_B_DSE
));

133 
	`πc_wrôe
(
CMOS_STATUS_B
, 
vÆ8
);

134 
ªgs
->
ah
 = 0;

135 
ªgs
->
Æ
 = 
vÆ8
;

136 
	`£t_suc˚ss
(
ªgs
);

137 
	}
}

141 
	$h™dÀ_1a04
(
bªgs
 *
ªgs
)

143 
ªgs
->
ah
 = 0;

144 i‡(
	`πc_upd©ög
()) {

145 
	`£t_övÆid
(
ªgs
);

148 
ªgs
->
˛
 = 
	`πc_ªad
(
CMOS_RTC_YEAR
);

149 
ªgs
->
dh
 = 
	`πc_ªad
(
CMOS_RTC_MONTH
);

150 
ªgs
->
dl
 = 
	`πc_ªad
(
CMOS_RTC_DAY_MONTH
);

151 
ªgs
->
ch
 = 
	`GET_LOW
(
Cítury
);

152 
ªgs
->
Æ
 =Ñegs->
ch
;

153 
	`£t_suc˚ss
(
ªgs
);

154 
	}
}

158 
	$h™dÀ_1a05
(
bªgs
 *
ªgs
)

170 i‡(
	`πc_upd©ög
()) {

171 
	`πc_£tup
();

172 
	`£t_övÆid
(
ªgs
);

175 
	`πc_wrôe
(
CMOS_RTC_YEAR
, 
ªgs
->
˛
);

176 
	`πc_wrôe
(
CMOS_RTC_MONTH
, 
ªgs
->
dh
);

177 
	`πc_wrôe
(
CMOS_RTC_DAY_MONTH
, 
ªgs
->
dl
);

178 
	`SET_LOW
(
Cítury
, 
ªgs
->
ch
);

180 
u8
 
vÆ8
 = 
	`πc_ªad
(
CMOS_STATUS_B
Ë& ~
RTC_B_SET
;

181 
	`πc_wrôe
(
CMOS_STATUS_B
, 
vÆ8
);

182 
ªgs
->
ah
 = 0;

183 
ªgs
->
Æ
 = 
vÆ8
;

184 
	`£t_suc˚ss
(
ªgs
);

185 
	}
}

189 
	$h™dÀ_1a06
(
bªgs
 *
ªgs
)

201 
u8
 
vÆ8
 = 
	`πc_ªad
(
CMOS_STATUS_B
);

202 
ªgs
->
ax
 = 0;

203 i‡(
vÆ8
 & 
RTC_B_AIE
) {

205 
	`£t_övÆid
(
ªgs
);

208 i‡(
	`πc_upd©ög
()) {

209 
	`πc_£tup
();

212 
	`πc_wrôe
(
CMOS_RTC_SECONDS_ALARM
, 
ªgs
->
dh
);

213 
	`πc_wrôe
(
CMOS_RTC_MINUTES_ALARM
, 
ªgs
->
˛
);

214 
	`πc_wrôe
(
CMOS_RTC_HOURS_ALARM
, 
ªgs
->
ch
);

216 
	`πc_wrôe
(
CMOS_STATUS_B
, (
vÆ8
 & ~
RTC_B_SET
Ë| 
RTC_B_AIE
);

217 
	`£t_suc˚ss
(
ªgs
);

218 
	}
}

222 
	$h™dÀ_1a07
(
bªgs
 *
ªgs
)

234 
u8
 
vÆ8
 = 
	`πc_ªad
(
CMOS_STATUS_B
);

236 
	`πc_wrôe
(
CMOS_STATUS_B
, 
vÆ8
 & ~(
RTC_B_SET
|
RTC_B_AIE
));

237 
ªgs
->
ah
 = 0;

238 
ªgs
->
Æ
 = 
vÆ8
;

239 
	`£t_suc˚ss
(
ªgs
);

240 
	}
}

244 
	$h™dÀ_1aXX
(
bªgs
 *
ªgs
)

246 
	`£t_unim∂emíãd
(
ªgs
);

247 
	}
}

250 
VISIBLE16


251 
	$h™dÀ_1a
(
bªgs
 *
ªgs
)

253 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_1a
);

254 
ªgs
->
ah
) {

255 0x00: 
	`h™dÀ_1a00
(
ªgs
); ;

256 0x01: 
	`h™dÀ_1a01
(
ªgs
); ;

257 0x02: 
	`h™dÀ_1a02
(
ªgs
); ;

258 0x03: 
	`h™dÀ_1a03
(
ªgs
); ;

259 0x04: 
	`h™dÀ_1a04
(
ªgs
); ;

260 0x05: 
	`h™dÀ_1a05
(
ªgs
); ;

261 0x06: 
	`h™dÀ_1a06
(
ªgs
); ;

262 0x07: 
	`h™dÀ_1a07
(
ªgs
); ;

263 : 
	`h™dÀ_1aXX
(
ªgs
); ;

265 
	}
}

268 
VISIBLE16


269 
	$h™dÀ_08
()

271 
	`debug_i§
(
DEBUG_ISR_08
);

274 
u32
 
cou¡î
 = 
	`GET_BDA
(
timî_cou¡î
);

275 
cou¡î
++;

277 i‡(
cou¡î
 >
TICKS_PER_DAY
) {

279 
cou¡î
 = 0;

280 
	`SET_BDA
(
timî_rﬁlovî
, 
	`GET_BDA
(timer_rollover) + 1);

282 
	`SET_BDA
(
timî_cou¡î
, 
cou¡î
);

285 
	`Ê›py_tick
();

286 
	`usb_check_evít
();

287 #i‡
CONFIG_INT16_SERIAL_KEYBOARD


288 
	`u¨t_check_key°rokes
();

292 
bªgs
 
br
;

293 
	`mem£t
(&
br
, 0, (br));

294 
br
.
Êags
 = 
F_IF
;

295 
	`ˇŒ16_öt
(0x1c, &
br
);

297 
	`pic_eoi1
();

298 
	}
}

307 
u32


308 
	$úqtimî_ˇlc_ticks
(
u32
 
cou¡
)

310  (
	`GET_BDA
(
timî_cou¡î
Ë+ 
cou¡
 + 1Ë% 
TICKS_PER_DAY
;

311 
	}
}

314 
u32


315 
	$úqtimî_ˇlc
(
u32
 
m£cs
)

317 i‡(!
m£cs
)

318  
	`GET_BDA
(
timî_cou¡î
);

319  
	`úqtimî_ˇlc_ticks
(
	`ticks_‰om_ms
(
m£cs
));

320 
	}
}

324 
	$úqtimî_check
(
u32
 
íd
)

326  (((
	`GET_BDA
(
timî_cou¡î
Ë+ 
TICKS_PER_DAY
 - 
íd
) % TICKS_PER_DAY)

327 < (
TICKS_PER_DAY
/2));

328 
	}
}

336 
	$£t_u£πimî
(
u32
 
u£cs
, 
u16
 
£g
, u16 
off£t
)

338 i‡(
	`GET_BDA
(
πc_waô_Êag
Ë& 
RWS_WAIT_PENDING
)

342 
	`SET_BDA
(
πc_waô_Êag
, 
RWS_WAIT_PENDING
);

343 
	`SET_BDA
(
u£r_waô_com∂ëe_Êag
, 
	`SEGOFF
(
£g
, 
off£t
));

344 
	`SET_BDA
(
u£r_waô_timeout
, 
u£cs
);

345 
	`πc_u£
();

347 
	}
}

350 
	$˛ór_u£πimî
()

352 i‡(!(
	`GET_BDA
(
πc_waô_Êag
Ë& 
RWS_WAIT_PENDING
))

355 
	`SET_BDA
(
πc_waô_Êag
, 0);

356 
	`πc_ªÀa£
();

357 
	}
}

359 
	#RET_ECLOCKINUSE
 0x83

	)

363 
	$h™dÀ_1586
(
bªgs
 *
ªgs
)

366 
u8
 
°©usÊag
 = 0;

367 
u32
 
cou¡
 = (
ªgs
->
cx
 << 16Ë|Ñegs->
dx
;

368 
ªt
 = 
	`£t_u£πimî
(
cou¡
, 
	`GET_SEG
(
SS
), (
u32
)&
°©usÊag
);

369 i‡(
ªt
) {

370 
	`£t_code_övÆid
(
ªgs
, 
RET_ECLOCKINUSE
);

373 !
°©usÊag
)

374 
	`yõld_toúq
();

375 
	`£t_suc˚ss
(
ªgs
);

376 
	}
}

380 
	$h™dÀ_158300
(
bªgs
 *
ªgs
)

382 
ªt
 = 
	`£t_u£πimî
((
ªgs
->
cx
 << 16Ë|Ñegs->
dx
,Ñegs->
es
,Ñegs->
bx
);

383 i‡(
ªt
)

385 
	`£t_code_övÆid
(
ªgs
, 
RET_EUNSUPPORTED
);

387 
	`£t_suc˚ss
(
ªgs
);

388 
	}
}

392 
	$h™dÀ_158301
(
bªgs
 *
ªgs
)

394 
	`˛ór_u£πimî
();

395 
	`£t_suc˚ss
(
ªgs
);

396 
	}
}

399 
	$h™dÀ_1583XX
(
bªgs
 *
ªgs
)

401 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

402 
ªgs
->
Æ
--;

403 
	}
}

406 
	$h™dÀ_1583
(
bªgs
 *
ªgs
)

408 
ªgs
->
Æ
) {

409 0x00: 
	`h™dÀ_158300
(
ªgs
); ;

410 0x01: 
	`h™dÀ_158301
(
ªgs
); ;

411 : 
	`h™dÀ_1583XX
(
ªgs
); ;

413 
	}
}

415 
	#USEC_PER_RTC
 
	`DIV_ROUND_CLOSEST
(1000000, 1024)

	)

418 
VISIBLE16


419 
	$h™dÀ_70
()

421 
	`debug_i§
(
DEBUG_ISR_70
);

424 
u8
 
ªgi°îB
 = 
	`πc_ªad
(
CMOS_STATUS_B
);

425 
u8
 
ªgi°îC
 = 
	`πc_ªad
(
CMOS_STATUS_C
);

427 i‡(!(
ªgi°îB
 & (
RTC_B_PIE
|
RTC_B_AIE
)))

428 
d⁄e
;

429 i‡(
ªgi°îC
 & 
RTC_B_AIE
) {

431 
bªgs
 
br
;

432 
	`mem£t
(&
br
, 0, (br));

433 
br
.
Êags
 = 
F_IF
;

434 
	`ˇŒ16_öt
(0x4a, &
br
);

436 i‡(!(
ªgi°îC
 & 
RTC_B_PIE
))

437 
d⁄e
;

441 
	`check_¥ìm±
();

443 i‡(!
	`GET_BDA
(
πc_waô_Êag
))

444 
d⁄e
;

447 
u32
 
time
 = 
	`GET_BDA
(
u£r_waô_timeout
);

448 i‡(
time
 < 
USEC_PER_RTC
) {

450 
£goff_s
 
£goff
 = 
	`GET_BDA
(
u£r_waô_com∂ëe_Êag
);

451 
u16
 
±r_£g
 = 
£goff
.
£g
;

452 
u8
 *
±r_Ár
 = (u8*)(
£goff
.
off£t
+0);

453 
u8
 
ﬁdvÆ
 = 
	`GET_FARVAR
(
±r_£g
, *
±r_Ár
);

454 
	`SET_FARVAR
(
±r_£g
, *
±r_Ár
, 
ﬁdvÆ
 | 0x80);

456 
	`˛ór_u£πimî
();

459 
time
 -
USEC_PER_RTC
;

460 
	`SET_BDA
(
u£r_waô_timeout
, 
time
);

463 
d⁄e
:

464 
	`pic_eoi2
();

465 
	}
}

	@config.h

1 #i‚de‡
__CONFIG_H


2 
	#__CONFIG_H


	)

4 
	~"autoc⁄f.h
"

12 
	#BUILD_APPNAME
 "Bochs"

	)

13 
	#BUILD_CPUNAME8
 "BOCHSCPU"

	)

14 
	#BUILD_APPNAME6
 "BOCHS "

	)

15 
	#BUILD_APPNAME4
 "BXPC"

	)

18 
	#BUILD_MAX_E820
 32

	)

20 
	#BUILD_MAX_HIGHTABLE
 (256*1024)

	)

22 
	#BUILD_MAX_EXTDRIVE
 16

	)

24 
	#BUILD_MAX_SMBIOS_FSEG
 600

	)

26 
	#BUILD_MODEL_ID
 0xFC

	)

27 
	#BUILD_SUBMODEL_ID
 0x00

	)

28 
	#BUILD_BIOS_REVISION
 0x01

	)

31 
	#BUILD_STACK_ADDR
 0x7000

	)

32 
	#BUILD_S3RESUME_STACK_ADDR
 0x1000

	)

33 
	#BUILD_AP_BOOT_ADDR
 0x10000

	)

34 
	#BUILD_EBDA_MINIMUM
 0x90000

	)

35 
	#BUILD_LOWRAM_END
 0xa0000

	)

36 
	#BUILD_ROM_START
 0xc0000

	)

37 
	#BUILD_BIOS_ADDR
 0xf0000

	)

38 
	#BUILD_BIOS_SIZE
 0x10000

	)

39 
	#BUILD_EXTRA_STACK_SIZE
 0x800

	)

41 
	#BUILD_BIOS_TMP_ADDR
 0x30000

	)

42 
	#BUILD_SMM_INIT_ADDR
 0x38000

	)

43 
	#BUILD_SMM_ADDR
 0xa8000

	)

44 
	#BUILD_SMM_SIZE
 0x8000

	)

46 
	#BUILD_PCIMEM_START
 0xe0000000

	)

47 
	#BUILD_PCIMEM_END
 0x„c00000

	)

48 
	#BUILD_PCIMEM64_START
 0x8000000000ULL

	)

49 
	#BUILD_PCIMEM64_END
 0x10000000000ULL

	)

51 
	#BUILD_IOAPIC_ADDR
 0x„c00000

	)

52 
	#BUILD_IOAPIC_ID
 0

	)

53 
	#BUILD_HPET_ADDRESS
 0x„d00000

	)

54 
	#BUILD_APIC_ADDR
 0x„e00000

	)

57 
	#BUILD_PCI_IRQS
 ((1<<5Ë| (1<<9Ë| (1<<10Ë| (1<<11))

	)

60 
	#SEG_IVT
 0x0000

	)

61 
	#SEG_BDA
 0x0040

	)

62 
	#SEG_BIOS
 0xf000

	)

65 
	#SEG32_MODE32_CS
 (1 << 3)

	)

66 
	#SEG32_MODE32_DS
 (2 << 3)

	)

67 
	#SEG32_MODE16_CS
 (3 << 3)

	)

68 
	#SEG32_MODE16_DS
 (4 << 3)

	)

69 
	#SEG32_MODE16BIG_CS
 (5 << 3)

	)

70 
	#SEG32_MODE16BIG_DS
 (6 << 3)

	)

75 
	#DEBUG_ISR_02
 1

	)

76 
	#DEBUG_HDL_05
 1

	)

77 
	#DEBUG_ISR_08
 20

	)

78 
	#DEBUG_ISR_09
 9

	)

79 
	#DEBUG_ISR_0e
 9

	)

80 
	#DEBUG_HDL_10
 20

	)

81 
	#DEBUG_HDL_11
 2

	)

82 
	#DEBUG_HDL_12
 2

	)

83 
	#DEBUG_HDL_13
 10

	)

84 
	#DEBUG_HDL_14
 2

	)

85 
	#DEBUG_HDL_15
 9

	)

86 
	#DEBUG_HDL_16
 9

	)

87 
	#DEBUG_HDL_17
 2

	)

88 
	#DEBUG_HDL_18
 1

	)

89 
	#DEBUG_HDL_19
 1

	)

90 
	#DEBUG_HDL_1a
 9

	)

91 
	#DEBUG_HDL_40
 1

	)

92 
	#DEBUG_ISR_70
 9

	)

93 
	#DEBUG_ISR_74
 9

	)

94 
	#DEBUG_ISR_75
 1

	)

95 
	#DEBUG_ISR_76
 10

	)

96 
	#DEBUG_ISR_hwpic1
 5

	)

97 
	#DEBUG_ISR_hwpic2
 5

	)

98 
	#DEBUG_HDL_≤p
 1

	)

99 
	#DEBUG_HDL_pmm
 1

	)

100 
	#DEBUG_HDL_pcibios
 9

	)

101 
	#DEBUG_HDL_≠m
 9

	)

102 
	#DEBUG_HDL_SD
 6

	)

104 
	#DEBUG_unim∂emíãd
 2

	)

105 
	#DEBUG_övÆid
 3

	)

106 
	#DEBUG_thªad
 2

	)

	@disk.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"c⁄fig.h
"

11 
	~"hw/©a.h
"

12 
	~"hw/pci.h
"

13 
	~"hw/pic.h
"

14 
	~"ouçut.h
"

15 
	~"°acks.h
"

16 
	~"°d/disk.h
"

17 
	~"°rög.h
"

18 
	~"utû.h
"

26 
	$__disk_°ub
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

28 
	`__w¨n_unim∂emíãd
(
ªgs
, 
löío
, 
‚ame
);

29 
	`__disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
 | (
löío
 << 8), 
‚ame
);

30 
	}
}

32 
	#DISK_STUB
(
ªgs
) \

33 
	`__disk_°ub
((
ªgs
), 
__LINE__
, 
__func__
)

	)

36 
chs_s


37 
	$gëLCHS
(
drive_s
 *
drive_gf
)

39 
chs_s
 
ªs
 = { };

40 i‡(
CONFIG_CDROM_EMU
 && 
drive_gf
 =
	`GET_GLOBAL
(
cdemu_drive_gf
)) {

45 
ªs
.
cylödî
 = 
	`GET_LOW
(
CDEmu
.
lchs
.cylinder);

46 
ªs
.
hód
 = 
	`GET_LOW
(
CDEmu
.
lchs
.head);

47 
ªs
.
£˘‹
 = 
	`GET_LOW
(
CDEmu
.
lchs
.sector);

48  
ªs
;

50 
ªs
.
cylödî
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
lchs
.cylinder);

51 
ªs
.
hód
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
lchs
.head);

52 
ªs
.
£˘‹
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
lchs
.sector);

53  
ªs
;

54 
	}
}

57 
noölöe


58 
	$basic_ac˚ss
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
, 
u16
 
comm™d
)

60 
disk_›_s
 
d›
;

61 
d›
.
drive_gf
 = drive_gf;

62 
d›
.
comm™d
 = command;

64 
u8
 
cou¡
 = 
ªgs
->
Æ
;

65 
u16
 
cylödî
 = 
ªgs
->
ch
 | ((((u16Ïegs->
˛
) << 2) & 0x300);

66 
u16
 
£˘‹
 = 
ªgs
->
˛
 & 0x3f;

67 
u16
 
hód
 = 
ªgs
->
dh
;

69 i‡(
cou¡
 > 128 || cou¡ =0 || 
£˘‹
 == 0) {

70 
	`w¨n_övÆid
(
ªgs
);

71 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

74 
d›
.
cou¡
 = count;

76 
chs_s
 
chs
 = 
	`gëLCHS
(
drive_gf
);

77 
u16
 
∆c
=
chs
.
cylödî
, 
∆h
=chs.
hód
, 
∆s
=chs.
£˘‹
;

80 i‡(
cylödî
 >
∆c
 || 
hód
 >
∆h
 || 
£˘‹
 > 
∆s
) {

81 
	`w¨n_övÆid
(
ªgs
);

82 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

87 
d›
.
lba
 = (((((
u32
)
cylödî
 * (u32)
∆h
Ë+ (u32)
hód
Ë* (u32)
∆s
)

88 + (
u32
)
£˘‹
 - 1);

90 
d›
.
buf_Ê
 = 
	`MAKE_FLATPTR
(
ªgs
->
es
,Ñegs->
bx
);

92 
°©us
 = 
	`£nd_disk_›
(&
d›
);

94 
ªgs
->
Æ
 = 
d›
.
cou¡
;

96 
	`disk_ªt
(
ªgs
, 
°©us
);

97 
	}
}

100 
noölöe


101 
	$exãnded_ac˚ss
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
, 
u16
 
comm™d
)

103 
disk_›_s
 
d›
;

104 
öt13ext_s
 *
∑øm_Ár
 = (öt13ext_s*)(
ªgs
->
si
+0);

106 
d›
.
lba
 = 
	`GET_FARVAR
(
ªgs
->
ds
, 
∑øm_Ár
->lba);

107 
d›
.
comm™d
 = command;

108 
d›
.
drive_gf
 = drive_gf;

109 i‡(
d›
.
lba
 >
	`GET_GLOBALFLAT
(
drive_gf
->
£˘‹s
)) {

110 
	`w¨n_övÆid
(
ªgs
);

111 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

115 
d›
.
buf_Ê
 = 
	`SEGOFF_TO_FLATPTR
(
	`GET_FARVAR
(
ªgs
->
ds
, 
∑øm_Ár
->
d©a
));

116 
d›
.
cou¡
 = 
	`GET_FARVAR
(
ªgs
->
ds
, 
∑øm_Ár
->count);

117 i‡(! 
d›
.
cou¡
) {

119 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

123 
°©us
 = 
	`£nd_disk_›
(&
d›
);

125 
	`SET_FARVAR
(
ªgs
->
ds
, 
∑øm_Ár
->
cou¡
, 
d›
.count);

127 
	`disk_ªt
(
ªgs
, 
°©us
);

128 
	}
}

137 
	$disk_1300
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

139 
disk_›_s
 
d›
;

140 
d›
.
drive_gf
 = drive_gf;

141 
d›
.
comm™d
 = 
CMD_RESET
;

142 
°©us
 = 
	`£nd_disk_›
(&
d›
);

143 
	`disk_ªt
(
ªgs
, 
°©us
);

144 
	}
}

148 
	$disk_1301
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

150 
u8
 
v
;

151 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
)

153 
v
 = 
	`GET_BDA
(
Ê›py_œ°_°©us
);

155 
v
 = 
	`GET_BDA
(
disk_œ°_°©us
);

156 
ªgs
->
ah
 = 
v
;

157 
	`£t_cf
(
ªgs
, 
v
);

159 
	}
}

163 
	$disk_1302
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

165 
	`basic_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_READ
);

166 
	}
}

170 
	$disk_1303
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

172 
	`basic_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_WRITE
);

173 
	}
}

177 
	$disk_1304
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

179 
	`basic_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_VERIFY
);

180 
	}
}

183 
noölöe


184 
	$disk_1305
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

186 
	`debug_°ub
(
ªgs
);

188 
chs_s
 
chs
 = 
	`gëLCHS
(
drive_gf
);

189 
u16
 
∆c
=
chs
.
cylödî
, 
∆h
=chs.
hód
, 
∆s
=chs.
£˘‹
;

191 
u8
 
cou¡
 = 
ªgs
->
Æ
;

192 
u8
 
cylödî
 = 
ªgs
->
ch
;

193 
u8
 
hód
 = 
ªgs
->
dh
;

195 i‡(
cylödî
 >
∆c
 || 
hód
 >
∆h
 || 
cou¡
 =0 || cou¡ > 
∆s
) {

196 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

200 
disk_›_s
 
d›
;

201 
d›
.
drive_gf
 = drive_gf;

202 
d›
.
comm™d
 = 
CMD_FORMAT
;

203 
d›
.
lba
 = (((
u32
)
cylödî
 * (u32)
∆h
Ë+ (u32)
hód
Ë* (u32)
∆s
;

204 
d›
.
cou¡
 = count;

205 
d›
.
buf_Ê
 = 
	`MAKE_FLATPTR
(
ªgs
->
es
,Ñegs->
bx
);

206 
°©us
 = 
	`£nd_disk_›
(&
d›
);

207 
	`disk_ªt
(
ªgs
, 
°©us
);

208 
	}
}

211 
noölöe


212 
	$disk_1308
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

215 
chs_s
 
chs
 = 
	`gëLCHS
(
drive_gf
);

216 
u16
 
∆c
=
chs
.
cylödî
, 
∆h
=chs.
hód
, 
∆s
=chs.
£˘‹
;

217 
∆c
--;

218 
∆h
--;

219 
u8
 
cou¡
;

220 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
) {

222 
cou¡
 = 
	`GET_GLOBAL
(
Fl›pyCou¡
);

224 i‡(
CONFIG_CDROM_EMU
 && 
drive_gf
 =
	`GET_GLOBAL
(
cdemu_drive_gf
))

225 
ªgs
->
bx
 = 
	`GET_LOW
(
CDEmu
.
medü
) * 2;

227 
ªgs
->
bx
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
Ê›py_ty≥
);

230 
ªgs
->
es
 = 
SEG_BIOS
;

231 
ªgs
->
di
 = (
u32
)&
diskëã_∑øm_èbÀ2
;

232 } i‡(
ªgs
->
dl
 < 
EXTSTART_CD
) {

234 
cou¡
 = 
	`GET_BDA
(
hdcou¡
);

235 
∆c
--;

238 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

242 i‡(
CONFIG_CDROM_EMU
 && 
	`GET_LOW
(
CDEmu
.
a˘ive
)) {

243 
u8
 
emudrive
 = 
	`GET_LOW
(
CDEmu
.
emuœãd_extdrive
);

244 i‡(((
emudrive
 ^ 
ªgs
->
dl
) & 0x80) == 0)

246 
cou¡
++;

247 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
 && 
cou¡
 > 2)

249 
cou¡
 = 2;

252 
ªgs
->
Æ
 = 0;

253 
ªgs
->
ch
 = 
∆c
 & 0xff;

254 
ªgs
->
˛
 = ((
∆c
 >> 2Ë& 0xc0Ë| (
∆s
 & 0x3f);

255 
ªgs
->
dh
 = 
∆h
;

257 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

258 
ªgs
->
dl
 = 
cou¡
;

259 
	}
}

263 
	$disk_1309
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

265 
	`DISK_STUB
(
ªgs
);

266 
	}
}

270 
	$disk_130c
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

272 
	`DISK_STUB
(
ªgs
);

273 
	}
}

277 
	$disk_130d
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

279 
	`DISK_STUB
(
ªgs
);

280 
	}
}

284 
	$disk_1310
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

288 
disk_›_s
 
d›
;

289 
d›
.
drive_gf
 = drive_gf;

290 
d›
.
comm™d
 = 
CMD_ISREADY
;

291 
°©us
 = 
	`£nd_disk_›
(&
d›
);

292 
	`disk_ªt
(
ªgs
, 
°©us
);

293 
	}
}

297 
	$disk_1311
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

299 
	`DISK_STUB
(
ªgs
);

300 
	}
}

304 
	$disk_1314
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

306 
	`DISK_STUB
(
ªgs
);

307 
	}
}

310 
noölöe


311 
	$disk_1315
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

313 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

314 i‡(
ªgs
->
dl
 < 
EXTSTART_HD
 ||Ñegs->d»>
EXTSTART_CD
) {

316 
ªgs
->
ah
 = 1;

322 
chs_s
 
chs
 = 
	`gëLCHS
(
drive_gf
);

323 
u16
 
∆c
=
chs
.
cylödî
, 
∆h
=chs.
hód
, 
∆s
=chs.
£˘‹
;

326 
u32
 
lba
 = (u32)(
∆c
 - 1Ë* (u32)
∆h
 * (u32)
∆s
;

327 
ªgs
->
cx
 = 
lba
 >> 16;

328 
ªgs
->
dx
 = 
lba
 & 0xffff;

329 
ªgs
->
ah
 = 3;

330 
	}
}

333 
	$disk_1316
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

335 i‡(
ªgs
->
dl
 >
EXTSTART_HD
) {

337 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

340 
	`disk_ªt
(
ªgs
, 
DISK_RET_ECHANGED
);

341 
	}
}

345 
	$disk_1341
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

347 
ªgs
->
bx
 = 0xaa55;

348 
ªgs
->
cx
 = 0x0007;

349 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

350 
ªgs
->
ah
 = 0x30;

351 
	}
}

355 
	$disk_1342
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

357 
	`exãnded_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_READ
);

358 
	}
}

362 
	$disk_1343
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

364 
	`exãnded_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_WRITE
);

365 
	}
}

369 
	$disk_1344
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

371 
	`exãnded_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_VERIFY
);

372 
	}
}

376 
	$disk_134500
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

378 
cdid
 = 
ªgs
->
dl
 - 
EXTSTART_CD
;

379 
u8
 
locks
 = 
	`GET_LOW
(
CDRom_locks
[
cdid
]);

380 i‡(
locks
 == 0xff) {

381 
ªgs
->
Æ
 = 1;

382 
	`disk_ªt
(
ªgs
, 
DISK_RET_ETOOMANYLOCKS
);

385 
	`SET_LOW
(
CDRom_locks
[
cdid
], 
locks
 + 1);

386 
ªgs
->
Æ
 = 1;

387 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

388 
	}
}

392 
	$disk_134501
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

394 
cdid
 = 
ªgs
->
dl
 - 
EXTSTART_CD
;

395 
u8
 
locks
 = 
	`GET_LOW
(
CDRom_locks
[
cdid
]);

396 i‡(
locks
 == 0x00) {

397 
ªgs
->
Æ
 = 0;

398 
	`disk_ªt
(
ªgs
, 
DISK_RET_ENOTLOCKED
);

401 
locks
--;

402 
	`SET_LOW
(
CDRom_locks
[
cdid
], 
locks
);

403 
ªgs
->
Æ
 = (
locks
 ? 1 : 0);

404 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

405 
	}
}

409 
	$disk_134502
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

411 
cdid
 = 
ªgs
->
dl
 - 
EXTSTART_CD
;

412 
u8
 
locks
 = 
	`GET_LOW
(
CDRom_locks
[
cdid
]);

413 
ªgs
->
Æ
 = (
locks
 ? 1 : 0);

414 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

415 
	}
}

418 
	$disk_1345XX
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

420 
	`disk_ªt_unim∂emíãd
(
ªgs
, 
DISK_RET_EPARAM
);

421 
	}
}

425 
	$disk_1345
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

427 i‡(
ªgs
->
dl
 < 
EXTSTART_CD
) {

429 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

433 
ªgs
->
Æ
) {

434 0x00: 
	`disk_134500
(
ªgs
, 
drive_gf
); ;

435 0x01: 
	`disk_134501
(
ªgs
, 
drive_gf
); ;

436 0x02: 
	`disk_134502
(
ªgs
, 
drive_gf
); ;

437 : 
	`disk_1345XX
(
ªgs
, 
drive_gf
); ;

439 
	}
}

442 
noölöe


443 
	$disk_1346
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

445 i‡(
ªgs
->
dl
 < 
EXTSTART_CD
) {

447 
	`disk_ªt
(
ªgs
, 
DISK_RET_ENOTREMOVABLE
);

451 
cdid
 = 
ªgs
->
dl
 - 
EXTSTART_CD
;

452 
u8
 
locks
 = 
	`GET_LOW
(
CDRom_locks
[
cdid
]);

453 i‡(
locks
 != 0) {

454 
	`disk_ªt
(
ªgs
, 
DISK_RET_ELOCKED
);

462 
bªgs
 
br
;

463 
	`mem£t
(&
br
, 0, (br));

464 
br
.
ah
 = 0x52;

465 
br
.
dl
 = 
ªgs
->dl;

466 
	`ˇŒ16_öt
(0x15, &
br
);

468 i‡(
br
.
ah
 || br.
Êags
 & 
F_CF
) {

469 
	`disk_ªt
(
ªgs
, 
DISK_RET_ELOCKED
);

472 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

473 
	}
}

477 
	$disk_1347
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

479 
	`exãnded_ac˚ss
(
ªgs
, 
drive_gf
, 
CMD_SEEK
);

480 
	}
}

483 
noölöe


484 
	$disk_1348
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

486 
u16
 
£g
 = 
ªgs
->
ds
;

487 
öt13d±_s
 *
∑øm_Ár
 = (öt13d±_s*)(
ªgs
->
si
+0);

488 
u16
 
size
 = 
	`GET_FARVAR
(
£g
, 
∑øm_Ár
->size);

489 
u16
 
t13
 = 
size
 == 74;

492 i‡(
size
 < 26) {

493 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

499 
u8
 
ty≥
 = 
	`GET_GLOBALFLAT
(
drive_gf
->type);

500 
u16
 
≈c
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
pchs
.
cylödî
);

501 
u16
 
≈h
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
pchs
.
hód
);

502 
u16
 
≈s
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
pchs
.
£˘‹
);

503 
u64
 
lba
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
£˘‹s
);

504 
u16
 
blksize
 = 
	`GET_GLOBALFLAT
(
drive_gf
->blksize);

506 
	`d¥ötf
(
DEBUG_HDL_13
, "disk_1348 size=%dÅ=%d chs=%d,%d,%dÜba=%d bs=%d\n"

507 , 
size
, 
ty≥
, 
≈c
, 
≈h
, 
≈s
, (
u32
)
lba
, 
blksize
);

509 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
size
, 26);

510 i‡(
ty≥
 =
DTYPE_ATA_ATAPI
) {

512 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
öfos
, 0x74);

513 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
cylödîs
, 0xffffffff);

514 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
hóds
, 0xffffffff);

515 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
•t
, 0xffffffff);

516 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
£˘‹_cou¡
, (
u64
)-1);

518 i‡(
lba
 > (
u64
)
≈s
*
≈h
*0x3fff) {

519 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
öfos
, 0x00);

520 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
cylödîs
, 0x3fff);

522 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
öfos
, 0x02);

523 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
cylödîs
, (
u32
)
≈c
);

525 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
hóds
, (
u32
)
≈h
);

526 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
•t
, (
u32
)
≈s
);

527 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
£˘‹_cou¡
, 
lba
);

529 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
blksize
, blksize);

531 i‡(
size
 < 30 ||

532 (
ty≥
 !
DTYPE_ATA
 &&Åy≥ !
DTYPE_ATA_ATAPI
 &&

533 
ty≥
 !
DTYPE_VIRTIO_BLK
 &&Åy≥ !
DTYPE_VIRTIO_SCSI
)) {

534 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

540 
bdf
;

541 
u16
 
ioba£1
 = 0;

542 
u64
 
devi˚_∑th
 = 0;

543 
u8
 
ch™√l
 = 0;

544 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
size
, 30);

545 i‡(
ty≥
 =
DTYPE_ATA
 ||Åy≥ =
DTYPE_ATA_ATAPI
) {

546 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
d±e
, 
	`SEGOFF
(
SEG_LOW
, (
u32
)&
DeÁu…DPTE
));

549 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

550 
drive_gf
, 
©adrive_s
, 
drive
);

551 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

552 
u8
 
¶ave
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->slave);

553 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

554 
u8
 
úq
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->irq);

555 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

556 
bdf
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->
pci_bdf
);

557 
devi˚_∑th
 = 
¶ave
;

558 
ch™√l
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->
ch™id
);

560 
u16
 
›ti⁄s
 = 0;

561 i‡(
ty≥
 =
DTYPE_ATA
) {

562 
u8
 
å™¶©i⁄
 = 
	`GET_GLOBALFLAT
(
drive_gf
->translation);

563 i‡(
å™¶©i⁄
 !
TRANSLATION_NONE
) {

564 
›ti⁄s
 |= 1<<3;

565 i‡(
å™¶©i⁄
 =
TRANSLATION_LBA
)

566 
›ti⁄s
 |= 1<<9;

567 i‡(
å™¶©i⁄
 =
TRANSLATION_RECHS
)

568 
›ti⁄s
 |= 3<<9;

572 
›ti⁄s
 |= 1<<5;

573 
›ti⁄s
 |= 1<<6;

575 
›ti⁄s
 |= 1<<4;

576 i‡(
CONFIG_ATA_PIO32
)

577 
›ti⁄s
 |= 1<<7;

579 
	`SET_LOW
(
DeÁu…DPTE
.
ioba£1
, iobase1);

580 
	`SET_LOW
(
DeÁu…DPTE
.
ioba£2
, ioba£2 + 
ATA_CB_DC
);

581 
	`SET_LOW
(
DeÁu…DPTE
.
¥efix
, ((
¶ave
 ? 
ATA_CB_DH_DEV1
 : 
ATA_CB_DH_DEV0
)

582 | 
ATA_CB_DH_LBA
));

583 
	`SET_LOW
(
DeÁu…DPTE
.
unu£d
, 0xcb);

584 
	`SET_LOW
(
DeÁu…DPTE
.
úq
, irq);

585 
	`SET_LOW
(
DeÁu…DPTE
.
blkcou¡
, 1);

586 
	`SET_LOW
(
DeÁu…DPTE
.
dma
, 0);

587 
	`SET_LOW
(
DeÁu…DPTE
.
pio
, 0);

588 
	`SET_LOW
(
DeÁu…DPTE
.
›ti⁄s
, options);

589 
	`SET_LOW
(
DeÁu…DPTE
.
ª£rved
, 0);

590 
	`SET_LOW
(
DeÁu…DPTE
.
ªvisi⁄
, 0x11);

592 
u8
 
sum
 = 
	`checksum_Ár
(
SEG_LOW
, &
DeÁu…DPTE
, 15);

593 
	`SET_LOW
(
DeÁu…DPTE
.
checksum
, -
sum
);

595 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
d±e
.
£goff
, 0xffffffff);

596 
bdf
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
˙é_id
);

599 i‡(
size
 < 66) {

600 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

605 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
key
, 0xbedd);

606 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
dpi_Àngth
, 
t13
 ? 44 : 36);

607 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ª£rved1
, 0);

608 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ª£rved2
, 0);

610 i‡(
bdf
 != -1) {

611 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[0], 'P');

612 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[1], 'C');

613 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[2], 'I');

614 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[3], ' ');

616 
u32
 
∑th
 = (
	`pci_bdf_to_bus
(
bdf
Ë| (
	`pci_bdf_to_dev
(bdf) << 8)

617 | (
	`pci_bdf_to_‚
(
bdf
) << 16));

618 i‡(
t13
)

619 
∑th
 |
ch™√l
 << 24;

621 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_∑th
, 
∑th
);

624 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[0], 'I');

625 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[1], 'S');

626 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[2], 'A');

627 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ho°_bus
[3], ' ');

629 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_∑th
, 
ioba£1
);

632 i‡(
ty≥
 !
DTYPE_VIRTIO_BLK
) {

633 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[0], 'A');

634 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[1], 'T');

635 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[2], 'A');

636 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[3], ' ');

638 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[0], 'S');

639 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[1], 'C');

640 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[2], 'S');

641 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[3], 'I');

643 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[4], ' ');

644 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[5], ' ');

645 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[6], ' ');

646 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
iÁ˚_ty≥
[7], ' ');

648 i‡(
t13
) {

649 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
t13
.
devi˚_∑th
[0], device_path);

650 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
t13
.
devi˚_∑th
[1], 0);

652 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
t13
.
checksum


653 , -
	`checksum_Ár
(
£g
, (*)
∑øm_Ár
+30, 43));

655 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ph€nix
.
devi˚_∑th
, device_path);

657 
	`SET_FARVAR
(
£g
, 
∑øm_Ár
->
ph€nix
.
checksum


658 , -
	`checksum_Ár
(
£g
, (*)
∑øm_Ár
+30, 35));

661 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

662 
	}
}

666 
	$disk_1349
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

668 i‡(
ªgs
->
dl
 < 
EXTSTART_CD
) {

670 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

673 
	`£t_övÆid
(
ªgs
);

675 
ªgs
->
ah
 = 
DISK_RET_ECHANGED
;

676 
	}
}

679 
	$disk_134e01
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

681 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

682 
	}
}

685 
	$disk_134e03
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

687 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

688 
	}
}

691 
	$disk_134e04
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

693 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

694 
	}
}

697 
	$disk_134e06
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

699 
	`disk_ªt
(
ªgs
, 
DISK_RET_SUCCESS
);

700 
	}
}

703 
	$disk_134eXX
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

705 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

706 
	}
}

710 
	$disk_134e
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

712 
ªgs
->
Æ
) {

713 0x01: 
	`disk_134e01
(
ªgs
, 
drive_gf
); ;

714 0x03: 
	`disk_134e03
(
ªgs
, 
drive_gf
); ;

715 0x04: 
	`disk_134e04
(
ªgs
, 
drive_gf
); ;

716 0x06: 
	`disk_134e06
(
ªgs
, 
drive_gf
); ;

717 : 
	`disk_134eXX
(
ªgs
, 
drive_gf
); ;

719 
	}
}

722 
	$disk_13XX
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

724 
	`disk_ªt_unim∂emíãd
(
ªgs
, 
DISK_RET_EPARAM
);

725 
	}
}

728 
	$disk_13
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

733 
	`SET_BDA
(
disk_öãºu±_Êag
, 0);

735 
ªgs
->
ah
) {

736 0x00: 
	`disk_1300
(
ªgs
, 
drive_gf
); ;

737 0x01: 
	`disk_1301
(
ªgs
, 
drive_gf
); ;

738 0x02: 
	`disk_1302
(
ªgs
, 
drive_gf
); ;

739 0x03: 
	`disk_1303
(
ªgs
, 
drive_gf
); ;

740 0x04: 
	`disk_1304
(
ªgs
, 
drive_gf
); ;

741 0x05: 
	`disk_1305
(
ªgs
, 
drive_gf
); ;

742 0x08: 
	`disk_1308
(
ªgs
, 
drive_gf
); ;

743 0x09: 
	`disk_1309
(
ªgs
, 
drive_gf
); ;

744 0x0c: 
	`disk_130c
(
ªgs
, 
drive_gf
); ;

745 0x0d: 
	`disk_130d
(
ªgs
, 
drive_gf
); ;

746 0x10: 
	`disk_1310
(
ªgs
, 
drive_gf
); ;

747 0x11: 
	`disk_1311
(
ªgs
, 
drive_gf
); ;

748 0x14: 
	`disk_1314
(
ªgs
, 
drive_gf
); ;

749 0x15: 
	`disk_1315
(
ªgs
, 
drive_gf
); ;

750 0x16: 
	`disk_1316
(
ªgs
, 
drive_gf
); ;

751 0x41: 
	`disk_1341
(
ªgs
, 
drive_gf
); ;

752 0x42: 
	`disk_1342
(
ªgs
, 
drive_gf
); ;

753 0x43: 
	`disk_1343
(
ªgs
, 
drive_gf
); ;

754 0x44: 
	`disk_1344
(
ªgs
, 
drive_gf
); ;

755 0x45: 
	`disk_1345
(
ªgs
, 
drive_gf
); ;

756 0x46: 
	`disk_1346
(
ªgs
, 
drive_gf
); ;

757 0x47: 
	`disk_1347
(
ªgs
, 
drive_gf
); ;

758 0x48: 
	`disk_1348
(
ªgs
, 
drive_gf
); ;

759 0x49: 
	`disk_1349
(
ªgs
, 
drive_gf
); ;

760 0x4e: 
	`disk_134e
(
ªgs
, 
drive_gf
); ;

761 : 
	`disk_13XX
(
ªgs
, 
drive_gf
); ;

763 
	}
}

766 
	$Ê›py_13
(
bªgs
 *
ªgs
, 
drive_s
 *
drive_gf
)

769 
ªgs
->
ah
) {

779 
	`disk_13
(
ªgs
, 
drive_gf
);

781 : 
	`disk_13XX
(
ªgs
, 
drive_gf
); ;

783 
	}
}

791 
	$h™dÀ_Àgacy_disk
(
bªgs
 *
ªgs
, 
u8
 
extdrive
)

793 i‡(! 
CONFIG_DRIVES
) {

795 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

799 i‡(
extdrive
 < 
EXTSTART_HD
) {

800 
drive_s
 *
drive_gf
 = 
	`gëDrive
(
EXTTYPE_FLOPPY
, 
extdrive
);

801 i‡(!
drive_gf
)

802 
Áû
;

803 
	`Ê›py_13
(
ªgs
, 
drive_gf
);

807 
drive_s
 *
drive_gf
;

808 i‡(
extdrive
 >
EXTSTART_CD
)

809 
drive_gf
 = 
	`gëDrive
(
EXTTYPE_CD
, 
extdrive
 - 
EXTSTART_CD
);

811 
drive_gf
 = 
	`gëDrive
(
EXTTYPE_HD
, 
extdrive
 - 
EXTSTART_HD
);

812 i‡(!
drive_gf
)

813 
Áû
;

814 
	`disk_13
(
ªgs
, 
drive_gf
);

817 
Áû
:

819 
	`disk_ªt
(
ªgs
, 
DISK_RET_EPARAM
);

820 
	}
}

822 
VISIBLE16


823 
	$h™dÀ_40
(
bªgs
 *
ªgs
)

825 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_40
);

826 
	`h™dÀ_Àgacy_disk
(
ªgs
,Ñegs->
dl
);

827 
	}
}

830 
VISIBLE16


831 
	$h™dÀ_13
(
bªgs
 *
ªgs
)

833 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_13
);

834 
u8
 
extdrive
 = 
ªgs
->
dl
;

836 i‡(
CONFIG_CDROM_EMU
) {

837 i‡(
ªgs
->
ah
 == 0x4b) {

838 
	`cdemu_134b
(
ªgs
);

841 i‡(
	`GET_LOW
(
CDEmu
.
a˘ive
)) {

842 
u8
 
emudrive
 = 
	`GET_LOW
(
CDEmu
.
emuœãd_extdrive
);

843 i‡(
extdrive
 =
emudrive
) {

845 
drive_s
 *
cdemu_gf
 = 
	`GET_GLOBAL
(
cdemu_drive_gf
);

846 i‡(
ªgs
->
ah
 > 0x16) {

848 
	`disk_13XX
(
ªgs
, 
cdemu_gf
);

851 
	`disk_13
(
ªgs
, 
cdemu_gf
);

854 i‡(
extdrive
 < 
EXTSTART_CD
 && ((
emudrive
 ^Éxtdrive) & 0x80) == 0)

856 
extdrive
--;

859 
	`h™dÀ_Àgacy_disk
(
ªgs
, 
extdrive
);

860 
	}
}

863 
VISIBLE16


864 
	$h™dÀ_76
()

866 
	`debug_i§
(
DEBUG_ISR_76
);

867 
	`SET_BDA
(
disk_öãºu±_Êag
, 0xff);

868 
	`pic_eoi2
();

869 
	}
}

872 
fd±_s
 
OldFDPT
 
VAR16FIXED
(0xe401);

	@farptr.h

6 #i‚de‡
__FARPTR_H


7 
	#__FARPTR_H


	)

9 
	~"x86.h
"

13 
u16
 
__£gmít_ES
, 
__£gmít_CS
, 
__£gmít_DS
, 
__£gmít_SS
;

14 
u16
 
__£gmít_FS
, 
__£gmít_GS
;

17 
	#READ8_SEG
(
¥efix
, 
SEG
, 
vÆue
, 
v¨
) \

18 
	`__asm__
(
¥efix
 "movb %%" #SEG ":%1, %b0" : "=Qi"(
vÆue
) \

19 : "m"(
v¨
), "m"(
__£gmít_
 ## 
SEG
))

	)

20 
	#READ16_SEG
(
¥efix
, 
SEG
, 
vÆue
, 
v¨
) \

21 
	`__asm__
(
¥efix
 "movw %%" #SEG ":%1, %w0" : "Ùi"(
vÆue
) \

22 : "m"(
v¨
), "m"(
__£gmít_
 ## 
SEG
))

	)

23 
	#READ32_SEG
(
¥efix
, 
SEG
, 
vÆue
, 
v¨
) \

24 
	`__asm__
(
¥efix
 "mov»%%" #SEG ":%1, %0" : "Ùi"(
vÆue
) \

25 : "m"(
v¨
), "m"(
__£gmít_
 ## 
SEG
))

	)

26 
	#READ64_SEG
(
¥efix
, 
SEG
, 
vÆue
, 
v¨
) do { \

27 
u64_u32_u
 
__vÆue
; \

28 
u64_u32_u
 *
__r64_±r
 = (u64_u32_u *)&(
v¨
); \

29 
	`READ32_SEG
(
¥efix
, 
SEG
, 
__vÆue
.
lo
, 
__r64_±r
->lo); \

30 
	`READ32_SEG
(
¥efix
, 
SEG
, 
__vÆue
.
hi
, 
__r64_±r
->hi); \

31 *(
u64
*)&(
vÆue
Ë
__vÆue
.
vÆ
; \

32 } 0)

	)

33 
	#WRITE8_SEG
(
¥efix
, 
SEG
, 
v¨
, 
vÆue
) \

34 
	`__asm__
(
¥efix
 "movb %b1, %%" #SEG ":%0" : "=m"(
v¨
) \

35 : "Q"(
vÆue
), "m"(
__£gmít_
 ## 
SEG
))

	)

36 
	#WRITE16_SEG
(
¥efix
, 
SEG
, 
v¨
, 
vÆue
) \

37 
	`__asm__
(
¥efix
 "movw %w1, %%" #SEG ":%0" : "=m"(
v¨
) \

38 : "r"(
vÆue
), "m"(
__£gmít_
 ## 
SEG
))

	)

39 
	#WRITE32_SEG
(
¥efix
, 
SEG
, 
v¨
, 
vÆue
) \

40 
	`__asm__
(
¥efix
 "mov»%1, %%" #SEG ":%0" : "=m"(
v¨
) \

41 : "r"(
vÆue
), "m"(
__£gmít_
 ## 
SEG
))

	)

42 
	#WRITE64_SEG
(
¥efix
, 
SEG
, 
v¨
, 
vÆue
) do { \

43 
u64_u32_u
 
__vÆue
; \

44 
u64_u32_u
 *
__w64_±r
 = (u64_u32_u *)&(
v¨
); \

45 
	`ty≥of
(
v¨
Ë
__vÆue_tmp
 = (
vÆue
); \

46 
__vÆue
.
vÆ
 = *(
u64
*)&
__vÆue_tmp
; \

47 
	`WRITE32_SEG
(
¥efix
, 
SEG
, 
__w64_±r
->
lo
, 
__vÆue
.lo); \

48 
	`WRITE32_SEG
(
¥efix
, 
SEG
, 
__w64_±r
->
hi
, 
__vÆue
.hi); \

49 } 0)

	)

53 
__f‹˚_lök_îr‹__unknown_ty≥
();

55 
	#__GET_VAR
(
¥efix
, 
£g
, 
v¨
) ({ \

56 
	`ty≥of
(
v¨
Ë
__vÆ
; \

57 i‡((
__vÆ
) == 1) \

58 
	`READ8_SEG
(
¥efix
, 
£g
, 
__vÆ
, 
v¨
); \

59 i‡((
__vÆ
) == 2) \

60 
	`READ16_SEG
(
¥efix
, 
£g
, 
__vÆ
, 
v¨
); \

61 i‡((
__vÆ
) == 4) \

62 
	`READ32_SEG
(
¥efix
, 
£g
, 
__vÆ
, 
v¨
); \

63 i‡((
__vÆ
) == 8) \

64 
	`READ64_SEG
(
¥efix
, 
£g
, 
__vÆ
, 
v¨
); \

66 
	`__f‹˚_lök_îr‹__unknown_ty≥
(); \

67 
__vÆ
; })

	)

69 
	#__SET_VAR
(
¥efix
, 
£g
, 
v¨
, 
vÆ
) do { \

70 i‡((
v¨
) == 1) \

71 
	`WRITE8_SEG
(
¥efix
, 
£g
, 
v¨
, (
vÆ
)); \

72 i‡((
v¨
) == 2) \

73 
	`WRITE16_SEG
(
¥efix
, 
£g
, 
v¨
, (
vÆ
)); \

74 i‡((
v¨
) == 4) \

75 
	`WRITE32_SEG
(
¥efix
, 
£g
, 
v¨
, (
vÆ
)); \

76 i‡((
v¨
) == 8) \

77 
	`WRITE64_SEG
(
¥efix
, 
£g
, 
v¨
, (
vÆ
)); \

79 
	`__f‹˚_lök_îr‹__unknown_ty≥
(); \

80 } 0)

	)

82 
	#DECL_SEGFUNCS
(
SEG
) \

83 
ölöe
 
__£t_£g_
##
	`SEG
(
u16
 
£g
) { \

84 
	`__asm__
("movw %w1, %%" #SEG : "=m"(
__£gmít_
##
SEG
) \

85 : "rm"(
£g
)); \

87 
ölöe
 
u16
 
__gë_£g_
##
	`SEG
() { \

88 
u16
 
ªs
; \

89 
	`__asm__
("movw %%" #SEG ", %w0" : "Ùm"(
ªs
) \

90 : "m"(
__£gmít_
##
SEG
)); \

91  
ªs
; \

92 }

	)

93 
	$DECL_SEGFUNCS
(
CS
)

94 
	$DECL_SEGFUNCS
(
DS
)

95 
	$DECL_SEGFUNCS
(
ES
)

96 
	$DECL_SEGFUNCS
(
FS
)

97 
	$DECL_SEGFUNCS
(
GS
)

98 
	$DECL_SEGFUNCS
(
SS
)

101 
	#__SET_SEG
(
SEG
, 
vÆue
) \

102 
__£t_£g_
##
	`SEG
(
vÆue
)

	)

103 
	#__GET_SEG
(
SEG
) \

104 
__gë_£g_
##
	`SEG
()

	)

109 
	#__GET_FARVAR
(
£g
, 
v¨
) ({ \

110 
	`SET_SEG
(
ES
, (
£g
)); \

111 
	`GET_VAR
(
ES
, (
v¨
)); 
	}
})

	)

112 
	#__SET_FARVAR
(
£g
, 
v¨
, 
vÆ
) do { \

113 
	`ty≥of
(
v¨
Ë
__sfv_vÆ
 = (
vÆ
); \

114 
	`SET_SEG
(
ES
, (
£g
)); \

115 
	`SET_VAR
(
ES
, (
v¨
), 
__sfv_vÆ
); \

116 } 0)

	)

121 
	#__GET_FLATPTR
(
±r
) ({ \

122 
	`ty≥of
(&(
±r
)Ë
__±r
 = &(ptr); \

123 
	`GET_FARVAR
(
	`FLATPTR_TO_SEG
(
__±r
) \

124 , *(
	`ty≥of
(
__±r
))
	`FLATPTR_TO_OFFSET
(__±r)); })

	)

125 
	#__SET_FLATPTR
(
±r
, 
vÆ
) do { \

126 
	`ty≥of
 (&(
±r
)Ë
__±r
 = &(ptr); \

127 
	`SET_FARVAR
(
	`FLATPTR_TO_SEG
(
__±r
) \

128 , *(
	`ty≥of
(
__±r
))
	`FLATPTR_TO_OFFSET
(__ptr) \

129 , (
vÆ
)); \

130 } 0)

	)

134 
	#FLATPTR_TO_SEG
(
p
Ë(((
u32
)’)Ë>> 4)

	)

135 
	#FLATPTR_TO_OFFSET
(
p
Ë(((
u32
)’)Ë& 0xf)

	)

136 
	#MAKE_FLATPTR
(
£g
,
off
Ë((*)(((
u32
)(£g)<<4)+(u32)(off)))

	)

139 #i‡
MODESEGMENT
 == 1

142 
	#GET_FARVAR
(
£g
, 
v¨
Ë
	`__GET_FARVAR
((£g), (v¨))

	)

143 
	#SET_FARVAR
(
£g
, 
v¨
, 
vÆ
Ë
	`__SET_FARVAR
((£g), (v¨), (vÆ))

	)

144 
	#GET_VAR
(
£g
, 
v¨
Ë
	`__GET_VAR
("", seg, (v¨))

	)

145 
	#SET_VAR
(
£g
, 
v¨
, 
vÆ
Ë
	`__SET_VAR
("", seg, (v¨), (vÆ))

	)

146 
	#SET_SEG
(
SEG
, 
vÆue
Ë
	`__SET_SEG
(SEG, (vÆue))

	)

147 
	#GET_SEG
(
SEG
Ë
	`__GET_SEG
(SEG)

	)

148 
	#GET_FLATPTR
(
±r
Ë
	`__GET_FLATPTR
’å)

	)

149 
	#SET_FLATPTR
(
±r
, 
vÆ
Ë
	`__SET_FLATPTR
(’å), (vÆ))

	)

151 
ölöe
 
	$ösb_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

152 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

153 
	`ösb
(
p‹t
, (
u8
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

154 
	}
}

155 
ölöe
 
	$ösw_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

156 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

157 
	`ösw
(
p‹t
, (
u16
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

158 
	}
}

159 
ölöe
 
	$ö¶_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

160 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

161 
	`ö¶
(
p‹t
, (
u32
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

162 
	}
}

163 
ölöe
 
	$outsb_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

164 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

165 
	`outsb
(
p‹t
, (
u8
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

166 
	}
}

167 
ölöe
 
	$outsw_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

168 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

169 
	`outsw
(
p‹t
, (
u16
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

170 
	}
}

171 
ölöe
 
	$out¶_Ê
(
u16
 
p‹t
, *
±r_Ê
, u16 
cou¡
) {

172 
	`SET_SEG
(
ES
, 
	`FLATPTR_TO_SEG
(
±r_Ê
));

173 
	`out¶
(
p‹t
, (
u32
*)
	`FLATPTR_TO_OFFSET
(
±r_Ê
), 
cou¡
);

174 
	}
}

179 
	#GET_FARVAR
(
£g
, 
v¨
) \

180 (*((
	`ty≥of
(&(
v¨
)))
	`MAKE_FLATPTR
((
£g
), &(v¨))))

	)

181 
	#SET_FARVAR
(
£g
, 
v¨
, 
vÆ
) \

182 dÿ{ 
	`GET_FARVAR
((
£g
), (
v¨
)Ë(
vÆ
); } 0)

	)

183 
	#GET_VAR
(
£g
, 
v¨
Ë(v¨)

	)

184 
	#SET_VAR
(
£g
, 
v¨
, 
vÆ
Ëdÿ{ (v¨Ë(vÆ); } 0)

	)

185 
	#SET_SEG
(
SEG
, 
vÆue
Ë(()(vÆue))

	)

186 
	#GET_SEG
(
SEG
Ë0

	)

187 
	#GET_FLATPTR
(
±r
Ë’å)

	)

188 
	#SET_FLATPTR
(
±r
, 
vÆ
Ëdÿ{ (±rË(vÆ); } 0)

	)

190 
	#ösb_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`ösb
’‹t,Öå_Ê, cou¡)

	)

191 
	#ösw_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`ösw
’‹t,Öå_Ê, cou¡)

	)

192 
	#ö¶_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`ö¶
’‹t,Öå_Ê, cou¡)

	)

193 
	#outsb_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`outsb
’‹t,Öå_Ê, cou¡)

	)

194 
	#outsw_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`outsw
’‹t,Öå_Ê, cou¡)

	)

195 
	#out¶_Ê
(
p‹t
, 
±r_Ê
, 
cou¡
Ë
	`out¶
’‹t,Öå_Ê, cou¡)

	)

199 
	#SEGOFF
(
s
,
o
Ë({
£goff_s
 
__so
; __so.
off£t
=(o); __so.
£g
=(s); __so;})

	)

201 
ölöe
 
£goff_s
 
	$FLATPTR_TO_SEGOFF
(*
p
) {

202  
	`SEGOFF
(
	`FLATPTR_TO_SEG
(
p
), 
	`FLATPTR_TO_OFFSET
(p));

203 
	}
}

204 
ölöe
 *
	$SEGOFF_TO_FLATPTR
(
£goff_s
 
so
) {

205  
	`MAKE_FLATPTR
(
so
.
£g
, so.
off£t
);

206 
	}
}

	@font.c

1 
	~"ty≥s.h
"

10 
u8
 
	gvgaf⁄t8
[128*8] 
VAR16FIXED
(0xfa6e) = {

	@fw/acpi.c

8 
	~"byã‹dî.h
"

9 
	~"c⁄fig.h
"

10 
	~"dev-q35.h
"

11 
	~"hw/pci.h
"

12 
	~"hw/pci_ids.h
"

13 
	~"hw/pci_ªgs.h
"

14 
	~"mÆloc.h
"

15 
	~"ouçut.h
"

16 
	~"∑øvút.h
"

17 
	~"romfûe.h
"

18 
	~"°d/a˝i.h
"

19 
	~"°rög.h
"

20 
	~"utû.h
"

21 
	~"x86.h
"

22 
	~"romfûe_lﬂdî.h
"

24 
	~"§c/fw/a˝i-dsdt.hex
"

26 
u32
 
a˝i_pm1a_˙t
 
	gVARFSEG
;

29 
	$buûd_hódî
(
a˝i_èbÀ_hódî
 *
h
, 
u32
 
sig
, 
Àn
, 
u8
 
ªv
)

31 
h
->
sig«tuª
 = 
	`˝u_to_À32
(
sig
);

32 
h
->
Àngth
 = 
	`˝u_to_À32
(
Àn
);

33 
h
->
ªvisi⁄
 = 
ªv
;

34 
	`mem˝y
(
h
->
€m_id
, 
BUILD_APPNAME6
, 6);

35 
	`mem˝y
(
h
->
€m_èbÀ_id
, 
BUILD_APPNAME4
, 4);

36 
	`mem˝y
(
h
->
€m_èbÀ_id
 + 4, (*)&
sig
, 4);

37 
h
->
€m_ªvisi⁄
 = 
	`˝u_to_À32
(1);

38 
	`mem˝y
(
h
->
a¶_compûî_id
, 
BUILD_APPNAME4
, 4);

39 
h
->
a¶_compûî_ªvisi⁄
 = 
	`˝u_to_À32
(1);

40 
h
->
checksum
 -
	`checksum
(h, 
Àn
);

41 
	}
}

43 
	#PIIX4_ACPI_ENABLE
 0xf1

	)

44 
	#PIIX4_ACPI_DISABLE
 0xf0

	)

45 
	#PIIX4_GPE0_BLK
 0xa„0

	)

46 
	#PIIX4_GPE0_BLK_LEN
 4

	)

48 
	#PIIX4_PM_INTRRUPT
 9

49 

	)

50 
	$piix4_Ádt_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

52 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
¨g
;

54 
Ádt
->
modñ
 = 1;

55 
Ádt
->
ª£rved1
 = 0;

56 
Ádt
->
sci_öt
 = 
	`˝u_to_À16
(
PIIX4_PM_INTRRUPT
);

57 
Ádt
->
smi_cmd
 = 
	`˝u_to_À32
(
PORT_SMI_CMD
);

58 
Ádt
->
a˝i_íabÀ
 = 
PIIX4_ACPI_ENABLE
;

59 
Ádt
->
a˝i_dißbÀ
 = 
PIIX4_ACPI_DISABLE
;

60 
Ádt
->
pm1a_evt_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
);

61 
Ádt
->
pm1a_˙t_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
 + 0x04);

62 
Ádt
->
pm_tmr_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
 + 0x08);

63 
Ádt
->
g≥0_blk
 = 
	`˝u_to_À32
(
PIIX4_GPE0_BLK
);

64 
Ádt
->
pm1_evt_Àn
 = 4;

65 
Ádt
->
pm1_˙t_Àn
 = 2;

66 
Ádt
->
pm_tmr_Àn
 = 4;

67 
Ádt
->
g≥0_blk_Àn
 = 
PIIX4_GPE0_BLK_LEN
;

68 
Ádt
->
∂vl2_œt
 = 
	`˝u_to_À16
(0xfff);

69 
Ádt
->
∂vl3_œt
 = 
	`˝u_to_À16
(0xfff);

71 
Ádt
->
Êags
 = 
	`˝u_to_À32
((1 << 0) | (1 << 2) | (1 << 5) | (1 << 7) |

73 
	}
}

76 
	$ich9_Õc_Ádt_£tup
(
pci_devi˚
 *
dev
, *
¨g
)

78 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
¨g
;

80 
Ádt
->
modñ
 = 1;

81 
Ádt
->
ª£rved1
 = 0;

82 
Ádt
->
sci_öt
 = 
	`˝u_to_À16
(9);

83 
Ádt
->
smi_cmd
 = 
	`˝u_to_À32
(
PORT_SMI_CMD
);

84 
Ádt
->
a˝i_íabÀ
 = 
ICH9_ACPI_ENABLE
;

85 
Ádt
->
a˝i_dißbÀ
 = 
ICH9_ACPI_DISABLE
;

86 
Ádt
->
pm1a_evt_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
);

87 
Ádt
->
pm1a_˙t_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
 + 0x04);

88 
Ádt
->
pm_tmr_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
 + 0x08);

89 
Ádt
->
g≥0_blk
 = 
	`˝u_to_À32
(
PORT_ACPI_PM_BASE
 + 
ICH9_PMIO_GPE0_STS
);

90 
Ádt
->
pm1_evt_Àn
 = 4;

91 
Ádt
->
pm1_˙t_Àn
 = 2;

92 
Ádt
->
pm_tmr_Àn
 = 4;

93 
Ádt
->
g≥0_blk_Àn
 = 
ICH9_PMIO_GPE0_BLK_LEN
;

94 
Ádt
->
∂vl2_œt
 = 
	`˝u_to_À16
(0xfff);

95 
Ádt
->
∂vl3_œt
 = 
	`˝u_to_À16
(0xfff);

97 
Ádt
->
Êags
 = 
	`˝u_to_À32
((1 << 0) | (1 << 2) | (1 << 5) | (1 << 7) |

99 
	}
}

101 c⁄° 
pci_devi˚_id
 
	gÁdt_öô_tbl
[] = {

103 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB_3
,

104 
piix4_Ádt_£tup
),

105 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_LPC
,

106 
ich9_Õc_Ádt_£tup
),

107 
PCI_DEVICE_END


110 
	$fûl_dsdt
(
Ádt_des¸ùt‹_ªv1
 *
Ádt
, *
dsdt
)

112 i‡(
Ádt
->
dsdt
) {

113 
	`‰ì
((*)
	`À32_to_˝u
(
Ádt
->
dsdt
));

115 
Ádt
->
dsdt
 = 
	`˝u_to_À32
((
u32
)dsdt);

116 
Ádt
->
checksum
 -
	`checksum
(fadt, (*fadt));

117 
	`d¥ötf
(1, "ACPI DSDT=%p\n", 
dsdt
);

118 
	}
}

121 
	$buûd_Ádt
(
pci_devi˚
 *
pci
)

123 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
	`mÆloc_high
((*fadt));

124 
Ács_des¸ùt‹_ªv1
 *
Ács
 = 
	`memÆign_high
(64, (*facs));

126 i‡(!
Ádt
 || !
Ács
) {

127 
	`w¨n_nﬂŒoc
();

128  
NULL
;

132 
	`mem£t
(
Ács
, 0, (*facs));

133 
Ács
->
sig«tuª
 = 
	`˝u_to_À32
(
FACS_SIGNATURE
);

134 
Ács
->
Àngth
 = 
	`˝u_to_À32
((*facs));

137 
	`mem£t
(
Ádt
, 0, (*fadt));

138 
Ádt
->
fúmw¨e_˘æ
 = 
	`˝u_to_À32
((
u32
)
Ács
);

139 
Ádt
->
dsdt
 = 0;

141 
	`pci_öô_devi˚
(
Ádt_öô_tbl
, 
pci
, 
Ádt
);

143 
	`buûd_hódî
((*)
Ádt
, 
FACP_SIGNATURE
, (*fadt), 1);

145  
Ádt
;

146 
	}
}

149 
	$buûd_madt
()

151 
madt_size
 = ((
mu…ùÀ_≠ic_èbÀ
)

152 + (
madt_¥o˚ss‹_≠ic
Ë* 
MaxCou¡CPUs


153 + (
madt_io_≠ic
)

154 + (
madt_öt§covr
) * 16

155 + (
madt_loˇl_nmi
));

157 
mu…ùÀ_≠ic_èbÀ
 *
madt
 = 
	`mÆloc_high
(
madt_size
);

158 i‡(!
madt
) {

159 
	`w¨n_nﬂŒoc
();

160  
NULL
;

162 
	`mem£t
(
madt
, 0, 
madt_size
);

163 
madt
->
loˇl_≠ic_addªss
 = 
	`˝u_to_À32
(
BUILD_APIC_ADDR
);

164 
madt
->
Êags
 = 
	`˝u_to_À32
(1);

165 
madt_¥o˚ss‹_≠ic
 *
≠ic
 = (*)&
madt
[1];

166 
i
;

167 
i
=0; i<
MaxCou¡CPUs
; i++) {

168 
≠ic
->
ty≥
 = 
APIC_PROCESSOR
;

169 
≠ic
->
Àngth
 = (*apic);

170 
≠ic
->
¥o˚ss‹_id
 = 
i
;

171 
≠ic
->
loˇl_≠ic_id
 = 
i
;

172 i‡(
	`≠ic_id_is_¥e£¡
(
≠ic
->
loˇl_≠ic_id
))

173 
≠ic
->
Êags
 = 
	`˝u_to_À32
(1);

175 
≠ic
->
Êags
 = 
	`˝u_to_À32
(0);

176 
≠ic
++;

178 
madt_io_≠ic
 *
io_≠ic
 = (*)
≠ic
;

179 
io_≠ic
->
ty≥
 = 
APIC_IO
;

180 
io_≠ic
->
Àngth
 = (*io_apic);

181 
io_≠ic
->
io_≠ic_id
 = 
BUILD_IOAPIC_ID
;

182 
io_≠ic
->
addªss
 = 
	`˝u_to_À32
(
BUILD_IOAPIC_ADDR
);

183 
io_≠ic
->
öãºu±
 = 
	`˝u_to_À32
(0);

185 
madt_öt§covr
 *
öt§covr
 = (*)&
io_≠ic
[1];

186 i‡(
	`romfûe_lﬂdöt
("etc/irq0-override", 0)) {

187 
	`mem£t
(
öt§covr
, 0, (*intsrcovr));

188 
öt§covr
->
ty≥
 = 
APIC_XRUPT_OVERRIDE
;

189 
öt§covr
->
Àngth
 = (*intsrcovr);

190 
öt§covr
->
sour˚
 = 0;

191 
öt§covr
->
gsi
 = 
	`˝u_to_À32
(2);

192 
öt§covr
->
Êags
 = 
	`˝u_to_À16
(0);

193 
öt§covr
++;

195 
i
 = 1; i < 16; i++) {

196 i‡(!(
BUILD_PCI_IRQS
 & (1 << 
i
)))

199 
	`mem£t
(
öt§covr
, 0, (*intsrcovr));

200 
öt§covr
->
ty≥
 = 
APIC_XRUPT_OVERRIDE
;

201 
öt§covr
->
Àngth
 = (*intsrcovr);

202 
öt§covr
->
sour˚
 = 
i
;

203 
öt§covr
->
gsi
 = 
	`˝u_to_À32
(
i
);

204 
öt§covr
->
Êags
 = 
	`˝u_to_À16
(0xd);

205 
öt§covr
++;

208 
madt_loˇl_nmi
 *
loˇl_nmi
 = (*)
öt§covr
;

209 
loˇl_nmi
->
ty≥
 = 
APIC_LOCAL_NMI
;

210 
loˇl_nmi
->
Àngth
 = (*local_nmi);

211 
loˇl_nmi
->
¥o˚ss‹_id
 = 0xff;

212 
loˇl_nmi
->
Êags
 = 
	`˝u_to_À16
(0);

213 
loˇl_nmi
->
löt
 = 1;

214 
loˇl_nmi
++;

216 
	`buûd_hódî
((*)
madt
, 
APIC_SIGNATURE
, (*)
loˇl_nmi
 - (*)madt, 1);

217  
madt
;

218 
	}
}

221 
ölöe
 
	$gëHex
(
u32
 
vÆ
) {

222 
vÆ
 &= 0x0f;

223  (
vÆ
 <= 9) ? ('0' + val) : ('A' + val - 10);

224 
	}
}

227 
u8
 *

228 
	$ícodeLí
(
u8
 *
ssdt_±r
, 
Àngth
, 
byãs
)

230 
byãs
) {

232 4: 
ssdt_±r
[3] = ((
Àngth
 >> 20) & 0xff);

233 3: 
ssdt_±r
[2] = ((
Àngth
 >> 12) & 0xff);

234 2: 
ssdt_±r
[1] = ((
Àngth
 >> 4) & 0xff);

235 
ssdt_±r
[0] = (((
byãs
-1Ë& 0x3Ë<< 6Ë| (
Àngth
 & 0x0f);

237 1: 
ssdt_±r
[0] = 
Àngth
 & 0x3f;

239  
ssdt_±r
 + 
byãs
;

240 
	}
}

242 
	~"§c/fw/ssdt-¥oc.hex
"

245 
	#PROC_OFFSET_CPUHEX
 (*
ssdt_¥oc_«me
 - *
ssdt_¥oc_°¨t
 + 2)

	)

246 
	#PROC_OFFSET_CPUID1
 (*
ssdt_¥oc_«me
 - *
ssdt_¥oc_°¨t
 + 4)

	)

247 
	#PROC_OFFSET_CPUID2
 (*
ssdt_¥oc_id
 - *
ssdt_¥oc_°¨t
)

	)

248 
	#PROC_SIZEOF
 (*
ssdt_¥oc_íd
 - *
ssdt_¥oc_°¨t
)

	)

249 
	#PROC_AML
 (
ssdp_¥oc_aml
 + *
ssdt_¥oc_°¨t
)

	)

252 
	#PCIHP_OFFSET_HEX
 (*
ssdt_pcihp_«me
 - *
ssdt_pcihp_°¨t
 + 1)

	)

253 
	#PCIHP_OFFSET_ID
 (*
ssdt_pcihp_id
 - *
ssdt_pcihp_°¨t
)

	)

254 
	#PCIHP_OFFSET_ADR
 (*
ssdt_pcihp_adr
 - *
ssdt_pcihp_°¨t
)

	)

255 
	#PCIHP_OFFSET_EJ0
 (*
ssdt_pcihp_ej0
 - *
ssdt_pcihp_°¨t
)

	)

256 
	#PCIHP_SIZEOF
 (*
ssdt_pcihp_íd
 - *
ssdt_pcihp_°¨t
)

	)

257 
	#PCIHP_AML
 (
ssdp_pcihp_aml
 + *
ssdt_pcihp_°¨t
)

	)

258 
	#PCI_SLOTS
 32

	)

260 
	#SSDT_SIGNATURE
 0x54445353

261 
	#SSDT_HEADER_LENGTH
 36

	)

263 
	~"§c/fw/ssdt-misc.hex
"

264 
	~"§c/fw/ssdt-pcihp.hex
"

266 
	#PCI_RMV_BASE
 0x´0c

	)

268 
u8
*

269 
	$buûd_nŸify
(
u8
 *
ssdt_±r
, c⁄° *
«me
, 
skù
, 
cou¡
,

270 c⁄° *
èrgë
, 
ofs
)

272 
cou¡
 -
skù
;

274 *(
ssdt_±r
++) = 0x14;

275 
ssdt_±r
 = 
	`ícodeLí
(ssdt_±r, 2+5+(12*
cou¡
), 2);

276 
	`mem˝y
(
ssdt_±r
, 
«me
, 4);

277 
ssdt_±r
 += 4;

278 *(
ssdt_±r
++) = 0x02;

280 
i
;

281 
i
 = 
skù
; 
cou¡
-- > 0; i++) {

282 *(
ssdt_±r
++) = 0xA0;

283 
ssdt_±r
 = 
	`ícodeLí
(ssdt_ptr, 11, 1);

284 *(
ssdt_±r
++) = 0x93;

285 *(
ssdt_±r
++) = 0x68;

286 *(
ssdt_±r
++) = 0x0A;

287 *(
ssdt_±r
++Ë
i
;

288 *(
ssdt_±r
++) = 0x86;

289 
	`mem˝y
(
ssdt_±r
, 
èrgë
, 4);

290 
ssdt_±r
[
ofs
] = 
	`gëHex
(
i
 >> 4);

291 
ssdt_±r
[
ofs
 + 1] = 
	`gëHex
(
i
);

292 
ssdt_±r
 += 4;

293 *(
ssdt_±r
++) = 0x69;

295  
ssdt_±r
;

296 
	}
}

298 
	$∑tch_pcihp
(
¶Ÿ
, 
u8
 *
ssdt_±r
, 
u32
 
eje˘
)

300 
ssdt_±r
[
PCIHP_OFFSET_HEX
] = 
	`gëHex
(
¶Ÿ
 >> 4);

301 
ssdt_±r
[
PCIHP_OFFSET_HEX
+1] = 
	`gëHex
(
¶Ÿ
);

302 
ssdt_±r
[
PCIHP_OFFSET_ID
] = 
¶Ÿ
;

303 
ssdt_±r
[
PCIHP_OFFSET_ADR
 + 2] = 
¶Ÿ
;

308 i‡(
	`memcmp
(
ssdt_±r
 + 
PCIHP_OFFSET_EJ0
, "_EJ0", 4)) {

309 
	`w¨n_öã∫Æîr‹
();

311 i‡(!
eje˘
) {

312 
	`mem˝y
(
ssdt_±r
 + 
PCIHP_OFFSET_EJ0
, "EJ0_", 4);

314 
	}
}

317 
	$buûd_ssdt
()

319 
a˝i_˝us
 = 
MaxCou¡CPUs
 > 0xff ? 0xff : MaxCountCPUs;

320 
Àngth
 = ((
ssdp_misc_aml
)

322 + (
a˝i_˝us
 * 
PROC_SIZEOF
)

323 + (1+2+5+(12*
a˝i_˝us
))

324 + (6+2+1+(1*
a˝i_˝us
))

326 + ((
PCI_SLOTS
 - 1Ë* 
PCIHP_SIZEOF
)

327 + (1+2+5+(12*(
PCI_SLOTS
 - 1))));

328 
u8
 *
ssdt
 = 
	`mÆloc_high
(
Àngth
);

329 i‡(! 
ssdt
) {

330 
	`w¨n_nﬂŒoc
();

331  
NULL
;

333 
u8
 *
ssdt_±r
 = 
ssdt
;

336 
sys_°©e_size
;

337 *
sys_°©es
 = 
	`romfûe_lﬂdfûe
("ëc/sy°em-°©es", &
sys_°©e_size
);

338 i‡(!
sys_°©es
 || 
sys_°©e_size
 != 6)

339 
sys_°©es
 = ([]){128, 0, 0, 129, 128, 128};

341 
	`mem˝y
(
ssdt_±r
, 
ssdp_misc_aml
, (ssdp_misc_aml));

342 i‡(!(
sys_°©es
[3] & 128))

343 
ssdt_±r
[
a˝i_s3_«me
[0]] = 'X';

344 i‡(!(
sys_°©es
[4] & 128))

345 
ssdt_±r
[
a˝i_s4_«me
[0]] = 'X';

347 
ssdt_±r
[
a˝i_s4_pkg
[0] + 1] = 
ssdt
[a˝i_s4_pkg[0] + 3] = 
sys_°©es
[4] & 127;

350 *(
u32
*)&
ssdt_±r
[
a˝i_pci32_°¨t
[0]] = 
	`˝u_to_À32
(
pcimem_°¨t
);

351 *(
u32
*)&
ssdt_±r
[
a˝i_pci32_íd
[0]] = 
	`˝u_to_À32
(
pcimem_íd
 - 1);

352 i‡(
pcimem64_°¨t
) {

353 
ssdt_±r
[
a˝i_pci64_vÆid
[0]] = 1;

354 *(
u64
*)&
ssdt_±r
[
a˝i_pci64_°¨t
[0]] = 
	`˝u_to_À64
(
pcimem64_°¨t
);

355 *(
u64
*)&
ssdt_±r
[
a˝i_pci64_íd
[0]] = 
	`˝u_to_À64
(
pcimem64_íd
 - 1);

356 *(
u64
*)&
ssdt_±r
[
a˝i_pci64_Àngth
[0]] = 
	`˝u_to_À64
(

357 
pcimem64_íd
 - 
pcimem64_°¨t
);

359 
ssdt_±r
[
a˝i_pci64_vÆid
[0]] = 0;

362 
pv∑nic_p‹t
 = 
	`romfûe_lﬂdöt
("etc/pvpanic-port", 0x0);

363 *(
u16
 *)(
ssdt_±r
 + *
ssdt_iß_≥°
Ë
pv∑nic_p‹t
;

365 
ssdt_±r
 +(
ssdp_misc_aml
);

368 *(
ssdt_±r
++) = 0x10;

369 
ssdt_±r
 = 
	`ícodeLí
(ssdt_±r, 
Àngth
 - (ssdt_±∏- 
ssdt
), 3);

370 *(
ssdt_±r
++) = '_';

371 *(
ssdt_±r
++) = 'S';

372 *(
ssdt_±r
++) = 'B';

373 *(
ssdt_±r
++) = '_';

376 
i
;

377 
i
=0; i<
a˝i_˝us
; i++) {

378 
	`mem˝y
(
ssdt_±r
, 
PROC_AML
, 
PROC_SIZEOF
);

379 
ssdt_±r
[
PROC_OFFSET_CPUHEX
] = 
	`gëHex
(
i
 >> 4);

380 
ssdt_±r
[
PROC_OFFSET_CPUHEX
+1] = 
	`gëHex
(
i
);

381 
ssdt_±r
[
PROC_OFFSET_CPUID1
] = 
i
;

382 
ssdt_±r
[
PROC_OFFSET_CPUID2
] = 
i
;

383 
ssdt_±r
 +
PROC_SIZEOF
;

388 
ssdt_±r
 = 
	`buûd_nŸify
(ssdt_±r, "NTFY", 0, 
a˝i_˝us
, "CP00", 2);

391 *(
ssdt_±r
++) = 0x08;

392 *(
ssdt_±r
++) = 'C';

393 *(
ssdt_±r
++) = 'P';

394 *(
ssdt_±r
++) = 'O';

395 *(
ssdt_±r
++) = 'N';

396 *(
ssdt_±r
++) = 0x12;

397 
ssdt_±r
 = 
	`ícodeLí
(ssdt_±r, 2+1+(1*
a˝i_˝us
), 2);

398 *(
ssdt_±r
++Ë
a˝i_˝us
;

399 
i
=0; i<
a˝i_˝us
; i++)

400 *(
ssdt_±r
++Ë(
	`≠ic_id_is_¥e£¡
(
i
)) ? 0x01 : 0x00;

403 *(
ssdt_±r
++) = 0x10;

404 
ssdt_±r
 = 
	`ícodeLí
(ssdt_±r, 
Àngth
 - (ssdt_±∏- 
ssdt
), 3);

405 *(
ssdt_±r
++) = 'P';

406 *(
ssdt_±r
++) = 'C';

407 *(
ssdt_±r
++) = 'I';

408 *(
ssdt_±r
++) = '0';

411 
u32
 
rmvc_p¸m
 = 
	`öl
(
PCI_RMV_BASE
);

412 
i
=1; i<
PCI_SLOTS
; i++) {

413 
u32
 
eje˘
 = 
rmvc_p¸m
 & (0x1 << 
i
);

414 
	`mem˝y
(
ssdt_±r
, 
PCIHP_AML
, 
PCIHP_SIZEOF
);

415 
	`∑tch_pcihp
(
i
, 
ssdt_±r
, 
eje˘
 != 0);

416 
ssdt_±r
 +
PCIHP_SIZEOF
;

419 
ssdt_±r
 = 
	`buûd_nŸify
(ssdt_±r, "PCNT", 1, 
PCI_SLOTS
, "S00_", 1);

421 
	`buûd_hódî
((*)
ssdt
, 
SSDT_SIGNATURE
, 
ssdt_±r
 - ssdt, 1);

425  
ssdt
;

426 
	}
}

428 
	#HPET_ID
 0x000

	)

429 
	#HPET_PERIOD
 0x004

	)

432 
	$buûd_h≥t
()

434 
a˝i_20_h≥t
 *
h≥t
;

435 c⁄° *
h≥t_ba£
 = (*)
BUILD_HPET_ADDRESS
;

436 
u32
 
h≥t_víd‹
 = 
	`ªadl
(
h≥t_ba£
 + 
HPET_ID
) >> 16;

437 
u32
 
h≥t_≥riod
 = 
	`ªadl
(
h≥t_ba£
 + 
HPET_PERIOD
);

439 i‡(
h≥t_víd‹
 == 0 || hpet_vendor == 0xffff ||

440 
h≥t_≥riod
 == 0 || hpet_period > 100000000)

441  
NULL
;

443 
h≥t
 = 
	`mÆloc_high
((*hpet));

444 i‡(!
h≥t
) {

445 
	`w¨n_nﬂŒoc
();

446  
NULL
;

449 
	`mem£t
(
h≥t
, 0, (*hpet));

453 
h≥t
->
timî_block_id
 = 
	`˝u_to_À32
(0x8086a201);

454 
h≥t
->
addr
.
addªss
 = 
	`˝u_to_À64
(
BUILD_HPET_ADDRESS
);

455 
	`buûd_hódî
((*)
h≥t
, 
HPET_SIGNATURE
, (*hpet), 1);

457  
h≥t
;

458 
	}
}

461 
	$a˝i_buûd_§©_mem‹y
(
§©_mem‹y_afföôy
 *
numamem
,

462 
u64
 
ba£
, u64 
Àn
, 
node
, 
íabÀd
)

464 
numamem
->
ty≥
 = 
SRAT_MEMORY
;

465 
numamem
->
Àngth
 = (*numamem);

466 
	`mem£t
(
numamem
->
¥oximôy
, 0, 4);

467 
numamem
->
¥oximôy
[0] = 
node
;

468 
numamem
->
Êags
 = 
	`˝u_to_À32
(!!
íabÀd
);

469 
numamem
->
ba£_addr
 = 
	`˝u_to_À64
(
ba£
);

470 
numamem
->
ønge_Àngth
 = 
	`˝u_to_À64
(
Àn
);

471 
	}
}

474 
	$buûd_§©
()

476 
numad©asize
, 
numa˝usize
;

477 
u64
 *
numad©a
 = 
	`romfûe_lﬂdfûe
("ëc/numa-nodes", &
numad©asize
);

478 
u64
 *
numa˝um≠
 = 
	`romfûe_lﬂdfûe
("ëc/numa-˝u-m≠", &
numa˝usize
);

479 i‡(!
numad©a
 || !
numa˝um≠
)

480 
Áû
;

481 
max_˝u
 = 
numa˝usize
 / (
u64
);

482 
nb_numa_nodes
 = 
numad©asize
 / (
u64
);

484 
sy°em_ªsour˚_afföôy_èbÀ
 *
§©
;

485 
§©_size
 = (*
§©
) +

486 (
§©_¥o˚ss‹_afföôy
Ë* 
max_˝u
 +

487 (
§©_mem‹y_afföôy
Ë* (
nb_numa_nodes
 + 2);

489 
§©
 = 
	`mÆloc_high
(
§©_size
);

490 i‡(!
§©
) {

491 
	`w¨n_nﬂŒoc
();

492 
Áû
;

495 
	`mem£t
(
§©
, 0, 
§©_size
);

496 
§©
->
ª£rved1
=
	`˝u_to_À32
(1);

497 
§©_¥o˚ss‹_afföôy
 *
c‹e
 = (*)(
§©
 + 1);

498 
i
;

499 
u64
 
cu∫ode
;

501 
i
 = 0; i < 
max_˝u
; ++i) {

502 
c‹e
->
ty≥
 = 
SRAT_PROCESSOR
;

503 
c‹e
->
Àngth
 = (*core);

504 
c‹e
->
loˇl_≠ic_id
 = 
i
;

505 
cu∫ode
 = *
numa˝um≠
++;

506 
c‹e
->
¥oximôy_lo
 = 
cu∫ode
;

507 
	`mem£t
(
c‹e
->
¥oximôy_hi
, 0, 3);

508 
c‹e
->
loˇl_ßpic_eid
 = 0;

509 i‡(
	`≠ic_id_is_¥e£¡
(
i
))

510 
c‹e
->
Êags
 = 
	`˝u_to_À32
(1);

512 
c‹e
->
Êags
 = 
	`˝u_to_À32
(0);

513 
c‹e
++;

520 
§©_mem‹y_afföôy
 *
numamem
 = (*)
c‹e
;

521 
¶Ÿs
 = 0;

522 
u64
 
mem_Àn
, 
mem_ba£
, 
√xt_ba£
 = 0;

524 
	`a˝i_buûd_§©_mem‹y
(
numamem
, 0, 640*1024, 0, 1);

525 
√xt_ba£
 = 1024 * 1024;

526 
numamem
++;

527 
¶Ÿs
++;

528 
i
 = 1; i < 
nb_numa_nodes
 + 1; ++i) {

529 
mem_ba£
 = 
√xt_ba£
;

530 
mem_Àn
 = *
numad©a
++;

531 i‡(
i
 == 1)

532 
mem_Àn
 -= 1024 * 1024;

533 
√xt_ba£
 = 
mem_ba£
 + 
mem_Àn
;

536 i‡(
mem_ba£
 <
RamSize
 && 
√xt_ba£
 > RamSize) {

537 
mem_Àn
 -
√xt_ba£
 - 
RamSize
;

538 i‡(
mem_Àn
 > 0) {

539 
	`a˝i_buûd_§©_mem‹y
(
numamem
, 
mem_ba£
, 
mem_Àn
, 
i
-1, 1);

540 
numamem
++;

541 
¶Ÿs
++;

543 
mem_ba£
 = 1ULL << 32;

544 
mem_Àn
 = 
√xt_ba£
 - 
RamSize
;

545 
√xt_ba£
 +(1ULL << 32Ë- 
RamSize
;

547 
	`a˝i_buûd_§©_mem‹y
(
numamem
, 
mem_ba£
, 
mem_Àn
, 
i
-1, 1);

548 
numamem
++;

549 
¶Ÿs
++;

551 ; 
¶Ÿs
 < 
nb_numa_nodes
 + 2; slots++) {

552 
	`a˝i_buûd_§©_mem‹y
(
numamem
, 0, 0, 0, 0);

553 
numamem
++;

556 
	`buûd_hódî
((*)
§©
, 
SRAT_SIGNATURE
, 
§©_size
, 1);

558 
	`‰ì
(
numad©a
);

559 
	`‰ì
(
numa˝um≠
);

560  
§©
;

561 
Áû
:

562 
	`‰ì
(
numad©a
);

563 
	`‰ì
(
numa˝um≠
);

564  
NULL
;

565 
	}
}

568 
	$buûd_mcfg_q35
()

570 
a˝i_èbÀ_mcfg
 *
mcfg
;

572 
Àn
 = (*
mcfg
Ë+ 1 * (mcfg->
Æloˇti⁄
[0]);

573 
mcfg
 = 
	`mÆloc_high
(
Àn
);

574 i‡(!
mcfg
) {

575 
	`w¨n_nﬂŒoc
();

576  
NULL
;

578 
	`mem£t
(
mcfg
, 0, 
Àn
);

579 
mcfg
->
Æloˇti⁄
[0].
addªss
 = 
	`˝u_to_À64
(
Q35_HOST_BRIDGE_PCIEXBAR_ADDR
);

580 
mcfg
->
Æloˇti⁄
[0].
pci_£gmít
 = 
	`˝u_to_À16
(
Q35_HOST_PCIE_PCI_SEGMENT
);

581 
mcfg
->
Æloˇti⁄
[0].
°¨t_bus_numbî
 = 
Q35_HOST_PCIE_START_BUS_NUMBER
;

582 
mcfg
->
Æloˇti⁄
[0].
íd_bus_numbî
 = 
Q35_HOST_PCIE_END_BUS_NUMBER
;

584 
	`buûd_hódî
((*)
mcfg
, 
MCFG_SIGNATURE
, 
Àn
, 1);

585  
mcfg
;

586 
	}
}

588 c⁄° 
pci_devi˚_id
 
	ga˝i_föd_tbl
[] = {

590 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB_3
, 
NULL
),

591 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_LPC
, 
NULL
),

592 
PCI_DEVICE_END
,

595 
rsdp_des¸ùt‹
 *
	gRsdpAddr
;

597 
	#MAX_ACPI_TABLES
 20

	)

599 
	$a˝i_£tup
()

601 i‡(
CONFIG_FW_ROMFILE_LOAD
) {

602 
lﬂdî_îr
;

604 
	`d¥ötf
(3, "load ACPIÅables\n");

606 
lﬂdî_îr
 = 
	`romfûe_lﬂdî_execuã
("etc/table-loader");

608 
RsdpAddr
 = 
	`föd_a˝i_rsdp
();

610 i‡(
RsdpAddr
)

617 i‡(!
lﬂdî_îr
)

618 
	`w¨n_öã∫Æîr‹
();

621 i‡(! 
CONFIG_ACPI
)

624 
	`d¥ötf
(3, "init ACPIÅables\n");

627 
pci_devi˚
 *
pci
 = 
	`pci_föd_öô_devi˚
(
a˝i_föd_tbl
, 
NULL
);

628 i‡(!
pci
)

633 
u32
 
èbÀs
[
MAX_ACPI_TABLES
], 
tbl_idx
 = 0;

635 
	#ACPI_INIT_TABLE
(
X
) \

637 
èbÀs
[
tbl_idx
] = 
	`˝u_to_À32
((
u32
)(
X
)); \

638 i‡(
	`À32_to_˝u
(
èbÀs
[
tbl_idx
])) \

639 
tbl_idx
++; \

640 } 0)

	)

642 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
	`buûd_Ádt
(
pci
);

643 
	`ACPI_INIT_TABLE
(
Ádt
);

644 
	`ACPI_INIT_TABLE
(
	`buûd_ssdt
());

645 
	`ACPI_INIT_TABLE
(
	`buûd_madt
());

646 
	`ACPI_INIT_TABLE
(
	`buûd_h≥t
());

647 
	`ACPI_INIT_TABLE
(
	`buûd_§©
());

648 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_INTEL_ICH9_LPC
)

649 
	`ACPI_INIT_TABLE
(
	`buûd_mcfg_q35
());

651 
romfûe_s
 *
fûe
 = 
NULL
;

653 
fûe
 = 
	`romfûe_föd¥efix
("acpi/", file);

654 i‡(!
fûe
)

656 
a˝i_èbÀ_hódî
 *
èbÀ
 = 
	`mÆloc_high
(
fûe
->
size
);

657 i‡(!
èbÀ
) {

658 
	`w¨n_nﬂŒoc
();

661 
ªt
 = 
fûe
->
	`c›y
(fûe, 
èbÀ
, fûe->
size
);

662 i‡(
ªt
 <(*
èbÀ
))

664 i‡(
èbÀ
->
sig«tuª
 =
DSDT_SIGNATURE
) {

665 i‡(
Ádt
) {

666 
	`fûl_dsdt
(
Ádt
, 
èbÀ
);

669 
	`ACPI_INIT_TABLE
(
èbÀ
);

671 i‡(
tbl_idx
 =
MAX_ACPI_TABLES
) {

672 
	`w¨n_nﬂŒoc
();

677 i‡(
CONFIG_ACPI_DSDT
 && 
Ádt
 && !Ádt->
dsdt
) {

679 
a˝i_èbÀ_hódî
 *
dsdt
 = 
	`mÆloc_high
((
AmlCode
));

680 i‡(!
dsdt
) {

681 
	`w¨n_nﬂŒoc
();

684 
	`mem˝y
(
dsdt
, 
AmlCode
, (AmlCode));

685 
	`fûl_dsdt
(
Ádt
, 
dsdt
);

687 
	`mem£t
(
dsdt
, 0,  *dsdt);

688 
	`buûd_hódî
(
dsdt
, 
DSDT_SIGNATURE
, (
AmlCode
), 1);

692 
rsdt_des¸ùt‹_ªv1
 *
rsdt
;

693 
size_t
 
rsdt_Àn
 = (*
rsdt
Ë+ (
u32
Ë* 
tbl_idx
;

694 
rsdt
 = 
	`mÆloc_high
(
rsdt_Àn
);

695 i‡(!
rsdt
) {

696 
	`w¨n_nﬂŒoc
();

699 
	`mem£t
(
rsdt
, 0, 
rsdt_Àn
);

700 
	`mem˝y
(
rsdt
->
èbÀ_off£t_íåy
, 
èbÀs
, (
u32
Ë* 
tbl_idx
);

701 
	`buûd_hódî
((*)
rsdt
, 
RSDT_SIGNATURE
, 
rsdt_Àn
, 1);

704 
rsdp_des¸ùt‹
 *
rsdp
 = 
	`mÆloc_f£g
((*rsdp));

705 i‡(!
rsdp
) {

706 
	`w¨n_nﬂŒoc
();

709 
	`mem£t
(
rsdp
, 0, (*rsdp));

710 
rsdp
->
sig«tuª
 = 
	`˝u_to_À64
(
RSDP_SIGNATURE
);

711 
	`mem˝y
(
rsdp
->
€m_id
, 
BUILD_APPNAME6
, 6);

712 
rsdp
->
rsdt_physiˇl_addªss
 = 
	`˝u_to_À32
((
u32
)
rsdt
);

713 
rsdp
->
checksum
 -
	`checksum
(rsdp, 20);

714 
RsdpAddr
 = 
rsdp
;

715 
	`d¥ötf
(1, "ACPIÅabÀs: RSDP=%∞RSDT=%p\n", 
rsdp
, 
rsdt
);

716 
	}
}

718 
Ádt_des¸ùt‹_ªv1
 *

719 
	$föd_Ádt
()

721 
	`d¥ötf
(4, "rsdp=%p\n", 
RsdpAddr
);

722 i‡(!
RsdpAddr
 || RsdpAddr->
sig«tuª
 !
RSDP_SIGNATURE
)

723  
NULL
;

724 
rsdt_des¸ùt‹_ªv1
 *
rsdt
 = (*)
RsdpAddr
->
rsdt_physiˇl_addªss
;

725 
	`d¥ötf
(4, "rsdt=%p\n", 
rsdt
);

726 i‡(!
rsdt
 ||Ñsdt->
sig«tuª
 !
RSDT_SIGNATURE
)

727  
NULL
;

728 *
íd
 = (*)
rsdt
 +Ñsdt->
Àngth
;

729 
i
;

730 
i
=0; (*)&
rsdt
->
èbÀ_off£t_íåy
[i] < 
íd
; i++) {

731 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = (*)
rsdt
->
èbÀ_off£t_íåy
[
i
];

732 i‡(!
Ádt
 || fadt->
sig«tuª
 !
FACP_SIGNATURE
)

734 
	`d¥ötf
(4, "Ádt=%p\n", 
Ádt
);

735  
Ádt
;

737 
	`d¥ötf
(4, "no fadt found\n");

738  
NULL
;

739 
	}
}

741 
u32


742 
	$föd_ªsume_ve˘‹
()

744 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
	`föd_Ádt
();

745 i‡(!
Ádt
)

747 
Ács_des¸ùt‹_ªv1
 *
Ács
 = (*)
Ádt
->
fúmw¨e_˘æ
;

748 
	`d¥ötf
(4, "Ács=%p\n", 
Ács
);

749 i‡(! 
Ács
 || facs->
sig«tuª
 !
FACS_SIGNATURE
)

752 
	`d¥ötf
(4, "ªsumêaddr=%d\n", 
Ács
->
fúmw¨e_wakög_ve˘‹
);

753  
Ács
->
fúmw¨e_wakög_ve˘‹
;

754 
	}
}

757 
	$föd_a˝i_„©uªs
()

759 
Ádt_des¸ùt‹_ªv1
 *
Ádt
 = 
	`föd_Ádt
();

760 i‡(!
Ádt
)

762 
u32
 
pm_tmr
 = 
	`À32_to_˝u
(
Ádt
->
pm_tmr_blk
);

763 
u32
 
pm1a_˙t
 = 
	`À32_to_˝u
(
Ádt
->
pm1a_˙t_blk
);

764 
	`d¥ötf
(4, "pm_tmr_blk=%x\n", 
pm_tmr
);

765 i‡(
pm_tmr
)

766 
	`pmtimî_£tup
(
pm_tmr
);

767 i‡(
pm1a_˙t
)

768 
a˝i_pm1a_˙t
 = 
pm1a_˙t
;

773 i‡(
Ádt
->
Àngth
 >= 129) {

774 *
p
 = 
Ádt
;

775 
	`a˝i_£t_ª£t_ªg
(
p
 + 116, *(
u8
 *)(p + 128));

777 
	}
}

779 
a˝i_20_gíîic_addªss
 
	ga˝i_ª£t_ªg
;

780 
u8
 
	ga˝i_ª£t_vÆ
;

782 
	#a˝i_ga_to_bdf
(
addr
Ë
	`pci_to_bdf
(0, (add∏>> 32Ë& 0xffff, (add∏>> 16Ë& 0xffff)

	)

785 
	$a˝i_ªboŸ
()

788 i‡(
a˝i_ª£t_ªg
.
ªgi°î_bô_width
 != 8)

791 
u64
 
addr
 = 
	`À64_to_˝u
(
a˝i_ª£t_ªg
.
addªss
);

793 
	`d¥ötf
(1, "ACPI hardÑeset %d:%llx (%x)\n",

794 
a˝i_ª£t_ªg
.
addªss_•a˚_id
, 
addr
, 
a˝i_ª£t_vÆ
);

796 
a˝i_ª£t_ªg
.
addªss_•a˚_id
) {

798 
	`wrôeb
((*)(
u32
)
addr
, 
a˝i_ª£t_vÆ
);

801 
	`outb
(
a˝i_ª£t_vÆ
, 
addr
);

804 
	`pci_c⁄fig_wrôeb
(
	`a˝i_ga_to_bdf
(
addr
),ádd∏& 0xffff, 
a˝i_ª£t_vÆ
);

807 
	}
}

810 
	$a˝i_£t_ª£t_ªg
(
a˝i_20_gíîic_addªss
 *
ªg
, 
u8
 
vÆ
)

812 i‡(!
ªg
 ||Ñeg->
addªss_•a˚_id
 > 2 ||

813 
ªg
->
ªgi°î_bô_width
 !8 ||Ñeg->
ªgi°î_bô_off£t
)

816 
a˝i_ª£t_ªg
 = *
ªg
;

817 
a˝i_ª£t_vÆ
 = 
vÆ
;

818 
	}
}

	@fw/biostables.c

7 
	~"c⁄fig.h
"

8 
	~"mÆloc.h
"

9 
	~"ouçut.h
"

10 
	~"°d/a˝i.h
"

11 
	~"°d/m±abÀ.h
"

12 
	~"°d/púèbÀ.h
"

13 
	~"°d/smbios.h
"

14 
	~"°rög.h
"

15 
	~"utû.h
"

18 
	$c›y_pú
(*
pos
)

20 
pú_hódî
 *
p
 = 
pos
;

21 i‡(
p
->
sig«tuª
 !
PIR_SIGNATURE
)

23 i‡(
PúAddr
)

25 i‡(
p
->
size
 < (*p))

27 i‡(
	`checksum
(
pos
, 
p
->
size
) != 0)

29 *
√wpos
 = 
	`mÆloc_f£g
(
p
->
size
);

30 i‡(!
√wpos
) {

31 
	`w¨n_nﬂŒoc
();

34 
	`d¥ötf
(1, "C›yög PIR from %∞tÿ%p\n", 
pos
, 
√wpos
);

35 
	`mem˝y
(
√wpos
, 
pos
, 
p
->
size
);

36 
PúAddr
 = 
√wpos
;

37 
	}
}

40 
	$c›y_m±abÀ
(*
pos
)

42 
m±abÀ_Êﬂtög_s
 *
p
 = 
pos
;

43 i‡(
p
->
sig«tuª
 !
MPTABLE_SIGNATURE
)

45 i‡(!
p
->
phyßddr
)

47 i‡(
	`checksum
(
pos
, (*
p
)) != 0)

49 
u16
 
mpÊígth
 = 
p
->
Àngth
 * 16;

50 
u16
 
mp˛ígth
 = ((
m±abÀ_c⁄fig_s
 *)
p
->
phyßddr
)->
Àngth
;

51 
u16
 
m≥Àngth
 = ((
m±abÀ_c⁄fig_s
 *)
p
->
phyßddr
)->
exâabÀ_Àngth
;

52 
u16
 
tŸÆÀngth
 = 
mpÊígth
 + 
mp˛ígth
 + 
m≥Àngth
;

53 
m±abÀ_Êﬂtög_s
 *
√wpos
 = 
	`mÆloc_f£g
(
tŸÆÀngth
);

54 i‡(!
√wpos
) {

55 
	`w¨n_nﬂŒoc
();

58 
	`d¥ötf
(1, "Copying MPTABLE from %p/%xÅo %p withÜength %x\n",

59 
pos
, 
p
->
phyßddr
, 
√wpos
, 
tŸÆÀngth
);

60 
	`mem˝y
(
√wpos
, 
pos
, 
mpÊígth
);

61 
	`d¥ötf
(8, "Copied MPTable FPS from %pÅo %p withÜength %x\n",

62 
pos
, 
√wpos
, 
mpÊígth
);

63 
√wpos
->
phyßddr
 = (
u32
Íewpo†+ 
mpÊígth
;

64 
√wpos
->
checksum
 -
	`checksum
(newpos, (*newpos));

65 
	`mem˝y
((*)
√wpos
 + 
mpÊígth
, (*)
p
->
phyßddr
, 
mp˛ígth
);

66 
	`d¥ötf
(8, "Copied MPTable MPC from %pÅo %p withÜength %x\n",

67 (*)
√wpos
 + 
mpÊígth
, (*)
p
->
phyßddr
, 
mp˛ígth
);

68 i‡(
m≥Àngth
) {

69 
	`mem˝y
((*)
√wpos
 + 
mpÊígth
 + 
mp˛ígth
, (*)
p
->
phyßddr
 + mp˛ígth, 
m≥Àngth
);

70 
	`d¥ötf
(8, "Copied MPTable MPE from %pÅo %p withÜength %x\n",

71 (*)
√wpos
 + 
mpÊígth
 + 
m≥Àngth
, (*)
p
->
phyßddr
 + 
mp˛ígth
, mpelength);

73 
	}
}

76 
	$gë_a˝i_rsdp_Àngth
(*
pos
, 
size
)

78 
rsdp_des¸ùt‹
 *
p
 = 
pos
;

79 i‡(
p
->
sig«tuª
 !
RSDP_SIGNATURE
)

81 
u32
 
Àngth
 = 20;

82 i‡(
Àngth
 > 
size
)

84 i‡(
	`checksum
(
pos
, 
Àngth
) != 0)

86 i‡(
p
->
ªvisi⁄
 > 1) {

87 
Àngth
 = 
p
->length;

88 i‡(
Àngth
 > 
size
)

90 i‡(
	`checksum
(
pos
, 
Àngth
) != 0)

93  
Àngth
;

94 
	}
}

97 
	$c›y_a˝i_rsdp
(*
pos
)

99 i‡(
RsdpAddr
)

101 
Àngth
 = 
	`gë_a˝i_rsdp_Àngth
(
pos
, -1);

102 i‡(
Àngth
 < 0)

104 *
√wpos
 = 
	`mÆloc_f£g
(
Àngth
);

105 i‡(!
√wpos
) {

106 
	`w¨n_nﬂŒoc
();

109 
	`d¥ötf
(1, "C›yög ACPI RSDP from %∞tÿ%p\n", 
pos
, 
√wpos
);

110 
	`mem˝y
(
√wpos
, 
pos
, 
Àngth
);

111 
RsdpAddr
 = 
√wpos
;

112 
	}
}

115 
	$c›y_smbios
(*
pos
)

117 i‡(
SMBiosAddr
)

119 
smbios_íåy_poöt
 *
p
 = 
pos
;

120 i‡(
	`memcmp
(
p
->
™ch‹_°rög
, "_SM_", 4))

122 i‡(
	`checksum
(
pos
, 0x10) != 0)

124 i‡(
	`memcmp
(
p
->
öãrmedüã_™ch‹_°rög
, "_DMI_", 5))

126 i‡(
	`checksum
(
pos
+0x10, 
p
->
Àngth
-0x10) != 0)

128 
smbios_íåy_poöt
 *
√wpos
 = 
	`mÆloc_f£g
(
p
->
Àngth
);

129 i‡(!
√wpos
) {

130 
	`w¨n_nﬂŒoc
();

133 
	`d¥ötf
(1, "C›yög SMBIOSÉ¡ryÖoöà‰om %∞tÿ%p\n", 
pos
, 
√wpos
);

134 
	`mem˝y
(
√wpos
, 
pos
, 
p
->
Àngth
);

135 
SMBiosAddr
 = 
√wpos
;

136 
	}
}

139 
	$c›y_èbÀ
(*
pos
)

141 
	`c›y_pú
(
pos
);

142 
	`c›y_m±abÀ
(
pos
);

143 
	`c›y_a˝i_rsdp
(
pos
);

144 
	`c›y_smbios
(
pos
);

145 
	}
}

147 *
	$föd_a˝i_rsdp
()

149 
u8
 
z⁄ef£g_°¨t
[], 
z⁄ef£g_íd
[];

150 
°¨t
 = ()
z⁄ef£g_°¨t
;

151 
íd
 = ()
z⁄ef£g_íd
;

152 
pos
;

154 
pos
 = 
	`ALIGN
(
°¨t
, 0x10);Öo†<
	`ALIGN_DOWN
(
íd
, 0x10);Öos += 0x10)

155 i‡(
	`gë_a˝i_rsdp_Àngth
((*)
pos
, 
íd
 -Öos) >= 0)

156  (*)
pos
;

158  
NULL
;

159 
	}
}

	@fw/coreboot.c

8 
	~"block.h
"

9 
	~"byã‹dî.h
"

10 
	~"c⁄fig.h
"

11 
	~"hw/pci.h
"

12 
	~"lzmadecode.h
"

13 
	~"mÆloc.h
"

14 
	~"memm≠.h
"

15 
	~"ouçut.h
"

16 
	~"∑øvút.h
"

17 
	~"romfûe.h
"

18 
	~"°acks.h
"

19 
	~"°rög.h
"

20 
	~"utû.h
"

21 
	~"efi.h
"

22 
	~"c‹eboŸ.h
"

29 
	scb_hódî
 {

30 
u32
 
	msig«tuª
;

31 
u32
 
	mhódî_byãs
;

32 
u32
 
	mhódî_checksum
;

33 
u32
 
	mèbÀ_byãs
;

34 
u32
 
	mèbÀ_checksum
;

35 
u32
 
	mèbÀ_íåõs
;

38 
	#CB_SIGNATURE
 0x4f49424C

39 

	)

40 
	scb_mem‹y_ønge
 {

41 
u64
 
	m°¨t
;

42 
u64
 
	msize
;

43 
u32
 
	mty≥
;

46 
	#CB_MEM_TYPE_RAM
 1

	)

47 
	#CB_MEM_TABLE
 16

	)

49 
	scb_mem‹y
 {

50 
u32
 
	mèg
;

51 
u32
 
	msize
;

52 
cb_mem‹y_ønge
 
	mm≠
[0];

55 
	#MAX_CB_MEMORY_SIZE
 ((
cb_mem‹y
) + \

56 (
cb_mem‹y_ønge
Ë* 
BUILD_MAX_E820
)

	)

58 
	#CB_TAG_MEMORY
 0x01

	)

60 
	#MEM_RANGE_COUNT
(
_ªc
) \

61 (((
_ªc
)->
size
 - (*(_ªc))Ë/ ((_ªc)->
m≠
[0]))

	)

63 
	scb_maöbﬂrd
 {

64 
u32
 
	mèg
;

65 
u32
 
	msize
;

66 
u8
 
	mvíd‹_idx
;

67 
u8
 
	m∑π_idx
;

68 
	m°rögs
[0];

71 
	#CB_TAG_MAINBOARD
 0x0003

	)

73 
	scb_vîsi⁄
 {

74 
u32
 
	mèg
;

75 
u32
 
	msize
;

76 
	m°rög
[];

79 
	#CB_TAG_VERSION
 0x0004

	)

81 
	scb_f‹w¨d
 {

82 
u32
 
	mèg
;

83 
u32
 
	msize
;

84 
u64
 
	mf‹w¨d
;

87 
	#CB_TAG_FORWARD
 0x11

	)

89 
	scb_cbmem_ªf
 {

90 
u32
 
	mèg
;

91 
u32
 
	msize
;

92 
u64
 
	mcbmem_addr
;

95 
	#CB_TAG_CBMEM_CONSOLE
 0x17

	)

97 
	scbmem_c⁄sﬁe
 {

98 
u32
 
	mbuf„r_size
;

99 
u32
 
	mbuf„r_curs‹
;

100 
u8
 
	mbuf„r_body
[0];

101 } 
	gPACKED
;

102 
cbmem_c⁄sﬁe
 *
	gcbc⁄
 = 
NULL
;

104 
u16


105 
	$ùchksum
(*
buf
, 
cou¡
)

107 
u16
 *
p
 = (u16*)
buf
;

108 
u32
 
sum
 = 0;

109 
cou¡
 > 1) {

110 
sum
 +*
p
++;

111 
cou¡
 -= 2;

113 i‡(
cou¡
)

114 
sum
 +*(
u8
*)
p
;

115 
sum
 = (sum >> 16) + (sum & 0xffff);

116 
sum
 += (sum >> 16);

117  ~
sum
;

118 
	}
}

121 
cb_hódî
 *

122 
	$föd_cb_hódî
(*
addr
, 
Àn
)

124 *
íd
 = 
addr
 + 
Àn
;

125 ; 
addr
 < 
íd
;áddr += 16) {

126 
cb_hódî
 *
cbh
 = (cb_hódî *)
addr
;

127 i‡(
cbh
->
sig«tuª
 !
CB_SIGNATURE
)

129 i‡(! 
cbh
->
èbÀ_byãs
)

131 i‡(
	`ùchksum
(
addr
, (*
cbh
)) != 0)

133 i‡(
	`ùchksum
(
addr
 + (*
cbh
), cbh->
èbÀ_byãs
)

134 !
cbh
->
èbÀ_checksum
)

136  
cbh
;

138  
NULL
;

139 
	}
}

143 
	$föd_cb_subèbÀ
(
cb_hódî
 *
cbh
, 
u32
 
èg
)

145 *
tbl
 = (*)
cbh
 + (*cbh);

146 
i
;

147 
i
=0; i<
cbh
->
èbÀ_íåõs
; i++) {

148 
cb_mem‹y
 *
cbm
 = (cb_mem‹y *)
tbl
;

149 
tbl
 +
cbm
->
size
;

150 i‡(
cbm
->
èg
 ==Åag)

151  
cbm
;

153  
NULL
;

154 
	}
}

156 
cb_mem‹y
 *
	gCBMemTabÀ
;

157 c⁄° *
	gCBvíd‹
 = "", *
	gCB∑π
 = "";

167 
cb_hódî
*

168 
	$föd_fuŒ_c‹eboŸ_èbÀ
()

170 
cb_hódî
 *
ªt_hódî
 = 
NULL
;

172 
ªt_hódî
 = 
	`föd_cb_hódî
(0, 0x1000);

173 i‡(
ªt_hódî
) {

174 
cb_f‹w¨d
 *
cbf
 =

175 
	`föd_cb_subèbÀ
(
ªt_hódî
, 
CB_TAG_FORWARD
);

176 i‡(
cbf
) {

177 
	`d¥ötf
(3, "Found corebootÅable forwarder.\n");

178 
ªt_hódî
 = 
	`föd_cb_hódî
((*)((
u32
)
cbf
->
f‹w¨d
), 0x100);

181  
ªt_hódî
;

182 
	}
}

184 
u64


185 
	$föd_c‹eboŸ_mem_size
()

187 
i
, 
max_mem_èg
 = 0;

189 
cb_hódî
 *
cbh
 = 
	`föd_fuŒ_c‹eboŸ_èbÀ
();

190 if(
cbh
) {

191 
cb_mem‹y
 *
cbm
 = 
CBMemTabÀ
 = 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_MEMORY
);

192 if(
cbm
) {

193 
u32
 
num_íåõs
 = 
cbm
->
size
 - (*cbm);

194 
num_íåõs
 /(
cbm
->
m≠
[0]);

195 
i
 = 0; i < 
num_íåõs
 ; i++) {

196 i‡(
cbm
->
m≠
[
i
].
ty≥
 =
CB_MEM_TYPE_RAM
)

197 
max_mem_èg
 = 
i
;

199 i‡(
max_mem_èg
)

200  
cbm
->
m≠
[
max_mem_èg
].
°¨t
 + cbm->m≠[max_mem_èg].
size
;

204 
	}
}

207 
	$gë_cbmem_boŸ‹dî_fûe
()

209 *
f
 = 
NULL
;

210 
cbmem_íåy
 *
cbmem_èbÀ
 = 
NULL
;

213 
cb_hódî
 *
cbh
 = 
	`föd_fuŒ_c‹eboŸ_èbÀ
();

214 i‡(
cbh
) {

216 
cb_mem‹y
 *
cbm
 = 
CBMemTabÀ
 =

217 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_MEMORY
);

218 i‡(
cbm
) {

226 
u32
 
num_íåõs
 = 
cbm
->
size
 - (*cbm);

227 
num_íåõs
 /(
cbm
->
m≠
[0]);

228 i‡(
num_íåõs
 != 0) {

229 
u32
 
i
;

230 
i
 = 0; i < 
num_íåõs
; i++) {

231 i‡((
cbm
->
m≠
[
i
].
ty≥
 =
CB_MEM_TABLE
Ë&& (cbm->m≠[i].
°¨t
 != 0)) {

232 
cbmem_èbÀ
 = (
cbmem_íåy
 *)(
u32
)
cbm
->
m≠
[
i
].
°¨t
;

244 i‡(
cbmem_èbÀ
) {

246 i‡(
cbmem_èbÀ
->
magic
 =
CBMEM_MAGIC
) {

247 i‡(
cbmem_èbÀ
->
id
 =
CBMEM_ID_BOOTORDER
) {

248 
boŸ‹dî_c⁄èöî
 *
cbmem_boŸ_±r
;

249 
cbmem_boŸ_±r
 = (
boŸ‹dî_c⁄èöî
 *)(
u32
)
cbmem_èbÀ
->
ba£
;

250 
	`d¥ötf
(1, "found fûê\"%s\" i¿cbmem\n", 
cbmem_boŸ_±r
->
boŸ‹dî_fûe_«me
);

251 
f
 = (*)
cbmem_boŸ_±r
->
boŸ‹dî_d©a
;

255 
cbmem_èbÀ
 += 1;

258 
	`d¥ötf
(1, "didÇot find bootorder file in cbmem\n");

263  
f
;

264 
	}
}

268 
	$c‹eboŸ_¥eöô
()

270 i‡(!
CONFIG_COREBOOT
)

273 
	`d¥ötf
(3, "AttemptingÅo find corebootÅable\n");

276 
cb_hódî
 *
cbh
 = 
	`föd_fuŒ_c‹eboŸ_èbÀ
();

277 i‡(!
cbh
)

278 
Áû
;

279 
	`d¥ötf
(3, "NowáttemptingÅo find coreboot memory map\n");

280 
cb_mem‹y
 *
cbm
 = 
CBMemTabÀ
 = 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_MEMORY
);

281 i‡(!
cbm
)

282 
Áû
;

284 
i
, 
cou¡
 = 
	`MEM_RANGE_COUNT
(
cbm
);

285 
i
=0; i<
cou¡
; i++) {

286 
cb_mem‹y_ønge
 *
m
 = &
cbm
->
m≠
[
i
];

287 
u32
 
ty≥
 = 
m
->type;

288 i‡(
ty≥
 =
CB_MEM_TABLE
)

289 
ty≥
 = 
E820_RESERVED
;

290 
	`add_e820
(
m
->
°¨t
, m->
size
, 
ty≥
);

295 
	`add_e820
(0, 16*1024, 
E820_RAM
);

297 
cb_cbmem_ªf
 *
cbªf
 = 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_CBMEM_CONSOLE
);

298 i‡(
cbªf
) {

299 
cbc⁄
 = (*)(
u32
)
cbªf
->
cbmem_addr
;

300 
	`debug_b™√r
();

301 
	`d¥ötf
(1, "Found c‹eboŸ cbmem c⁄sﬁê@ %Œx\n", 
cbªf
->
cbmem_addr
);

304 
cb_maöbﬂrd
 *
cbmb
 = 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_MAINBOARD
);

305 i‡(
cbmb
) {

306 
CBvíd‹
 = &
cbmb
->
°rögs
[cbmb->
víd‹_idx
];

307 
CB∑π
 = &
cbmb
->
°rögs
[cbmb->
∑π_idx
];

308 
	`d¥ötf
(1, "Found maöbﬂrd %†%s\n", 
CBvíd‹
, 
CB∑π
);

313 
Áû
:

315 
	`d¥ötf
(1, "UnableÅo find corebootÅable!\n");

316 
	`add_e820
(0, 16*1024*1024, 
E820_RAM
);

318 
	}
}

320 
	$c‹eboŸ_debug_putc
(
c
)

322 i‡(!
CONFIG_DEBUG_COREBOOT
)

324 i‡(!
cbc⁄
)

326 
u32
 
curs‹
 = 
cbc⁄
->
buf„r_curs‹
++;

327 i‡(
curs‹
 < 
cbc⁄
->
buf„r_size
)

328 
cbc⁄
->
buf„r_body
[
curs‹
] = 
c
;

329 
	}
}

338 
	$sˇn_èbÀs
(
u32
 
°¨t
, u32 
size
)

340 *
p
 = (*)
	`ALIGN
(
°¨t
, 16);

341 *
íd
 = (*)
°¨t
 + 
size
;

342 ; 
p
<
íd
;Ö += 16)

343 
	`c›y_èbÀ
(
p
);

344 
	}
}

347 
	$c‹eboŸ_∂©f‹m_£tup
()

349 i‡(!
CONFIG_COREBOOT
)

351 
	`pci_¥obe_devi˚s
();

353 
cb_mem‹y
 *
cbm
 = 
CBMemTabÀ
;

354 i‡(!
cbm
)

357 
	`d¥ötf
(3, "Relocating coreboot biosÅables\n");

360 
i
, 
cou¡
 = 
	`MEM_RANGE_COUNT
(
cbm
);

361 
i
=0; i<
cou¡
; i++) {

362 
cb_mem‹y_ønge
 *
m
 = &
cbm
->
m≠
[
i
];

363 i‡(
m
->
ty≥
 =
CB_MEM_TABLE
)

364 
	`sˇn_èbÀs
(
m
->
°¨t
, m->
size
);

367 
	`föd_a˝i_„©uªs
();

368 
	}
}

377 
	$ulzma
(
u8
 *
d°
, 
u32
 
maxÀn
, c⁄° u8 *
§c
, u32 
§˛í
)

379 
	`d¥ötf
(3, "Uncom¥essög d©®%d@%∞tÿ%d@%p\n", 
§˛í
, 
§c
, 
maxÀn
, 
d°
);

380 
CLzmaDecodîSèã
 
°©e
;

381 
ªt
 = 
	`LzmaDecodePr›îtõs
(&
°©e
.
Pr›îtõs
, 
§c
, 
LZMA_PROPERTIES_SIZE
);

382 i‡(
ªt
 !
LZMA_RESULT_OK
) {

383 
	`d¥ötf
(1, "LzmaDecodePr›îtõ†îr‹ - %d\n", 
ªt
);

386 
u8
 
s¸©ch
[15980];

387 
√ed
 = (
	`LzmaGëNumProbs
(&
°©e
.
Pr›îtõs
Ë* (
CProb
));

388 i‡(
√ed
 > (
s¸©ch
)) {

389 
	`d¥ötf
(1, "LzmaDecodê√ed %d havê%d\n", 
√ed
, ()(
s¸©ch
));

392 
°©e
.
Probs
 = (
CProb
 *)
s¸©ch
;

394 
u32
 
d°Àn
 = *(u32*)(
§c
 + 
LZMA_PROPERTIES_SIZE
);

395 i‡(
d°Àn
 > 
maxÀn
) {

396 
	`d¥ötf
(1, "LzmaDecodêtoÿœrgê(max %dÇìd %d)\n", 
maxÀn
, 
d°Àn
);

399 
u32
 
öPro˚s£d
, 
outPro˚s£d
;

400 
ªt
 = 
	`LzmaDecode
(&
°©e
, 
§c
 + 
LZMA_PROPERTIES_SIZE
 + 8, 
§˛í


401 , &
öPro˚s£d
, 
d°
, 
d°Àn
, &
outPro˚s£d
);

402 i‡(
ªt
) {

403 
	`d¥ötf
(1, "LzmaDecodêªtu∫ed %d\n", 
ªt
);

406  
d°Àn
;

407 
	}
}

414 
	#CBFS_HEADER_MAGIC
 0x4F524243

	)

415 
	#CBFS_VERSION1
 0x31313131

	)

417 
	scbfs_hódî
 {

418 
u32
 
	mmagic
;

419 
u32
 
	mvîsi⁄
;

420 
u32
 
	mromsize
;

421 
u32
 
	mboŸblocksize
;

422 
u32
 
	mÆign
;

423 
u32
 
	moff£t
;

424 
u32
 
	m∑d
[2];

425 } 
	gPACKED
;

427 
	#CBFS_FILE_MAGIC
 0x455649484352414cLL

428 

	)

429 
	scbfs_fûe
 {

430 
u64
 
	mmagic
;

431 
u32
 
	mÀn
;

432 
u32
 
	mty≥
;

433 
u32
 
	mchecksum
;

434 
u32
 
	moff£t
;

435 
	mfûíame
[0];

436 } 
	gPACKED
;

440 
	$cbfs_c›yfûe
(
romfûe_s
 *
fûe
, *
d°
, 
u32
 
maxÀn
)

442 i‡(!
CONFIG_COREBOOT_FLASH
)

445 
cbfs_romfûe_s
 *
cfûe
;

446 
cfûe
 = 
	`c⁄èöî_of
(
fûe
, 
cbfs_romfûe_s
, file);

447 
u32
 
size
 = 
cfûe
->
øwsize
;

448 *
§c
 = 
cfûe
->
d©a
;

449 i‡(
cfûe
->
Êags
) {

451 *
ãmp
 = 
	`mÆloc_tmphigh
(
size
);

452 i‡(!
ãmp
) {

453 
	`w¨n_nﬂŒoc
();

456 
	`iomem˝y
(
ãmp
, 
§c
, 
size
);

457 
ªt
 = 
	`ulzma
(
d°
, 
maxÀn
, 
ãmp
, 
size
);

458 
	`yõld
();

459 
	`‰ì
(
ãmp
);

460  
ªt
;

464 
	`d¥ötf
(3, "C›yög d©®%d@%∞tÿ%d@%p\n", 
size
, 
§c
, 
maxÀn
, 
d°
);

465 i‡(
size
 > 
maxÀn
) {

466 
	`w¨n_nﬂŒoc
();

469 
	`iomem˝y
(
d°
, 
§c
, 
size
);

470  
size
;

471 
	}
}

477 
	$¥o˚ss_löks_fûe
()

479 *
löks
 = 
	`romfûe_lﬂdfûe
("löks", 
NULL
), *
√xt
 =Üinks;

480 
√xt
) {

482 *
lök«me
 = 
√xt
;

483 
√xt
 = 
	`°rchr
(
lök«me
, '\n');

484 i‡(
√xt
)

485 *
√xt
++ = '\0';

486 *
commít
 = 
	`°rchr
(
lök«me
, '#');

487 i‡(
commít
)

488 *
commít
 = '\0';

489 
lök«me
 = 
	`nuŒTøûögS∑˚
(linkname);

490 *
de°«me
 = 
	`°rchr
(
lök«me
, ' ');

491 i‡(!
de°«me
)

493 *
de°«me
++ = '\0';

494 
de°«me
 = 
	`nuŒTøûögS∑˚
(destname);

496 
romfûe_s
 *
ufûe
 = 
	`romfûe_föd
(
de°«me
);

497 i‡(!
ufûe
)

499 
cbfs_romfûe_s
 *
cufûe


500 
	`c⁄èöî_of
(
ufûe
, 
cbfs_romfûe_s
, 
fûe
);

501 
cbfs_romfûe_s
 *
cfûe
 = 
	`mÆloc_tmp
((*cfile));

502 i‡(!
cfûe
) {

503 
	`w¨n_nﬂŒoc
();

506 
	`mem˝y
(
cfûe
, 
cufûe
, (*cfile));

507 
	`°π˝y
(
cfûe
->
fûe
.
«me
, 
lök«me
, (cfile->file.name));

508 
	`romfûe_add
(&
cfûe
->
fûe
);

510 
	`‰ì
(
löks
);

511 
	}
}

514 
	$c‹eboŸ_cbfs_öô
()

516 i‡(!
CONFIG_COREBOOT_FLASH
)

519 
cbfs_hódî
 *
hdr
 = *(**)(
CONFIG_CBFS_LOCATION
 - 4);

520 i‡(
hdr
->
magic
 !
	`˝u_to_be32
(
CBFS_HEADER_MAGIC
)) {

521 
	`d¥ötf
(1, "UnableÅo find CBFS (ptr=%p; got %xÇot %x)\n"

522 , 
hdr
, hdr->
magic
, 
	`˝u_to_be32
(
CBFS_HEADER_MAGIC
));

525 
	`d¥ötf
(1, "Found CBFS hódîáà%p\n", 
hdr
);

527 
u32
 
romsize
 = 
	`be32_to_˝u
(
hdr
->romsize);

528 
u32
 
rom°¨t
 = 
CONFIG_CBFS_LOCATION
 - 
romsize
;

529 
cbfs_fûe
 *
fhdr
 = (*)
rom°¨t
 + 
	`be32_to_˝u
(
hdr
->
off£t
);

531 i‡((
u32
)
fhdr
 - 
rom°¨t
 > 
romsize
)

533 
u64
 
magic
 = 
fhdr
->magic;

534 i‡(
magic
 !
CBFS_FILE_MAGIC
)

536 
cbfs_romfûe_s
 *
cfûe
 = 
	`mÆloc_tmp
((*cfile));

537 i‡(!
cfûe
) {

538 
	`w¨n_nﬂŒoc
();

541 
	`mem£t
(
cfûe
, 0, (*cfile));

542 
	`°π˝y
(
cfûe
->
fûe
.
«me
, 
fhdr
->
fûíame
, (cfile->file.name));

543 
cfûe
->
fûe
.
size
 = cfûe->
øwsize
 = 
	`be32_to_˝u
(
fhdr
->
Àn
);

544 
cfûe
->
fhdr
 = fhdr;

545 
cfûe
->
fûe
.
c›y
 = 
cbfs_c›yfûe
;

546 
cfûe
->
d©a
 = (*)
fhdr
 + 
	`be32_to_˝u
(fhdr->
off£t
);

547 
Àn
 = 
	`°æí
(
cfûe
->
fûe
.
«me
);

548 i‡(
Àn
 > 5 && 
	`°rcmp
(&
cfûe
->
fûe
.
«me
[len-5], ".lzma") == 0) {

550 
cfûe
->
Êags
 = 1;

551 
cfûe
->
fûe
.
«me
[
Àn
-5] = '\0';

552 
cfûe
->
fûe
.
size
 = *(
u32
*)(cfûe->
d©a
 + 
LZMA_PROPERTIES_SIZE
);

554 
	`romfûe_add
(&
cfûe
->
fûe
);

556 
fhdr
 = (*)
	`ALIGN
((
u32
)
cfûe
->
d©a
 + cfûe->
øwsize


557 , 
	`be32_to_˝u
(
hdr
->
Æign
));

560 
	`¥o˚ss_löks_fûe
();

561 
	}
}

572 
	$cbmem_‰om_e820
(
cb_mem‹y
 *
√w_èbÀ
,

573 
e820íåy
 *
e820_èbÀ
, 
u32
 
íåy_cou¡
)

575 
u32
 
èbÀ_size
 = (
cb_mem‹y
)

576 + (
cb_mem‹y_ønge
Ë* 
íåy_cou¡
;

577 
u32
 
i
 = 0;

579 
√w_èbÀ
->
size
 = 
èbÀ_size
;

580 
√w_èbÀ
->
èg
 = 
CB_TAG_MEMORY
;

582 
i
 = 0; i < 
íåy_cou¡
; ++i) {

583 
√w_èbÀ
->
m≠
[
i
].
°¨t
 = 
e820_èbÀ
[i].start;

584 
√w_èbÀ
->
m≠
[
i
].
size
 = 
e820_èbÀ
[i].size;

585 
√w_èbÀ
->
m≠
[
i
].
ty≥
 = 
e820_èbÀ
[i].type;

588 
	`d¥ötf
(3, "Converted %dÉntries backÅo cbmem\n",

589 
e820_cou¡
);

591 
	}
}

601 
	$upd©e_cbmem
()

603 
cb_hódî
 *
cbh
 = 
	`föd_fuŒ_c‹eboŸ_èbÀ
();

604 if(
cbh
) {

605 
cb_mem‹y
 *
cbm
 = 
CBMemTabÀ
 =

606 
	`föd_cb_subèbÀ
(
cbh
, 
CB_TAG_MEMORY
);

607 if(
cbm
) {

608 
u32
 
num_íåõs
 = 
cbm
->
size
 - (*cbm);

609 
num_íåõs
 /(
cbm
->
m≠
[0]);

610 
s32
 
íåõs_diff
 = 
e820_cou¡
 - 
num_íåõs
;

611 if(
íåõs_diff
 != 0) {

613 
u32
 
block_size
 = 
cbh
->
èbÀ_byãs
;

614 
block_size
 -((
u32
)
cbm
Ë- ((u32Ë
cbh
) + (*cbh);

615 
block_size
 -
cbm
->
size
;

616 *
block_°¨t
 = ((*)
cbm
Ë+ cbm->
size
;

617 *
√w_loˇti⁄
 = 
block_°¨t
 +

618 
íåõs_diff
 * (
cbm
->
m≠
[0]);

619 
	`memmove
(
√w_loˇti⁄
, 
block_°¨t
, 
block_size
);

621 
	`cbmem_‰om_e820
(
cbm
, 
e820_li°
, 
e820_cou¡
);

624 
	}
}

626 
	scbfs_∑ylﬂd_£gmít
 {

627 
u32
 
	mty≥
;

628 
u32
 
	mcom¥essi⁄
;

629 
u32
 
	moff£t
;

630 
u64
 
	mlﬂd_addr
;

631 
u32
 
	mÀn
;

632 
u32
 
	mmem_Àn
;

633 } 
	gPACKED
;

635 
	#PAYLOAD_SEGMENT_BSS
 0x20535342

	)

636 
	#PAYLOAD_SEGMENT_ENTRY
 0x52544E45

	)

638 
	#CBFS_COMPRESS_NONE
 0

	)

639 
	#CBFS_COMPRESS_LZMA
 1

	)

641 
	scbfs_∑ylﬂd
 {

642 
cbfs_∑ylﬂd_£gmít
 
	m£gmíts
[1];

645 (*
	gVOID_FUNCTION_POINTER
)();

646 (*
	tEXTENSION_LOADER_FUNCTION_POINTER
)(
	tVOID_FUNCTION_POINTER
);

648 
	$lﬂd_vxw‹ks32_boŸrom
(
VOID_FUNCTION_POINTER
 
func
)

660 
u8
 
√w_èbÀ
[
MAX_CB_MEMORY_SIZE
];

661 
	`mem£t
(
√w_èbÀ
, 0, (new_table));

663 
	`d¥ötf
(3, "ConvertingÉ820 backÅo cbmem\n");

664 
	`cbmem_‰om_e820
((
cb_mem‹y
*Ë
√w_èbÀ
, &
e820_li°
[0], 
e820_cou¡
);

666 
u32
 
a˝i_±r
 = (u32)
RsdpAddr
;

667 
u32
 
mem‹y_block
 = (u32)
√w_èbÀ
;

669 
asm
 volatile (

683 : "g" (
a˝i_±r
), "g" (
func
), "g" (
mem‹y_block
)

686 
	}
}

688 
	sexãnsi⁄_ba£d_lﬂdî
 {

689 * 
	mexãnsi⁄
;

690 
EXTENSION_LOADER_FUNCTION_POINTER
 
	mfunc
;

691 } 
	gPACKED
;

693 
exãnsi⁄_ba£d_lﬂdî
 
	gexãnsi⁄_lﬂdîs
[] = {

694 {".v32", 
lﬂd_vxw‹ks32_boŸrom
},

698 
EXTENSION_LOADER_FUNCTION_POINTER
 
	$loˇã_exãnsi⁄_lﬂdî
(* 
fûíame
) {

699 * 
exãnsi⁄
 = 
	`°rchr
(
fûíame
, '.');

700 i‡(
exãnsi⁄
) {

703 
i
;

704 
Àn
 = 
	`°æí
(
exãnsi⁄
) + 1;

705 
i
 = 0; i < (
exãnsi⁄_lﬂdîs
)/(extension_loaders[0]); i++) {

706 i‡(!
	`memcmp
(
exãnsi⁄_lﬂdîs
[
i
].
exãnsi⁄
,Éxãnsi⁄, 
Àn
)) {

708 
	`d¥ötf
(1, "Usög Lﬂdî %d (%s)\n", 
i
, 
exãnsi⁄
);

709  
exãnsi⁄_lﬂdîs
[
i
].
func
;

716 
	`d¥ötf
(1, "NoÉxtension-basedÜoader found\n");

717  
NULL
;

718 
	}
}

721 
	$cbfs_run_∑ylﬂd
(
cbfs_fûe
 *
fhdr
)

723 i‡(!
CONFIG_COREBOOT_FLASH
 || !
fhdr
)

725 
	`d¥ötf
(1, "Ru¿%s\n", 
fhdr
->
fûíame
);

726 
EXTENSION_LOADER_FUNCTION_POINTER
 
lﬂdî
 = 
	`loˇã_exãnsi⁄_lﬂdî
(
fhdr
->
fûíame
);

727 
cbfs_∑ylﬂd
 *
∑y
 = (*)
fhdr
 + 
	`be32_to_˝u
(fhdr->
off£t
);

728 
cbfs_∑ylﬂd_£gmít
 *
£g
 = 
∑y
->
£gmíts
;

730 *
§c
 = (*)
∑y
 + 
	`be32_to_˝u
(
£g
->
off£t
);

731 *
de°
 = (*)(
u32
)
	`be64_to_˝u
(
£g
->
lﬂd_addr
);

732 
u32
 
§c_Àn
 = 
	`be32_to_˝u
(
£g
->
Àn
);

733 
u32
 
de°_Àn
 = 
	`be32_to_˝u
(
£g
->
mem_Àn
);

734 
£g
->
ty≥
) {

735 
PAYLOAD_SEGMENT_BSS
:

736 
	`d¥ötf
(3, "BSS segmíà%d@%p\n", 
de°_Àn
, 
de°
);

737 
	`mem£t
(
de°
, 0, 
de°_Àn
);

739 
PAYLOAD_SEGMENT_ENTRY
: {

740 
	`d¥ötf
(1, "CÆlögádd∏%p\n", 
de°
);

741 (*
func
)(Ë
de°
;

742 i‡(
lﬂdî
) {

743 
	`lﬂdî
(
func
);

745 
	`func
();

750 
	`d¥ötf
(3, "Segment %x %d@%p -> %d@%p\n"

751 , 
£g
->
ty≥
, 
§c_Àn
, 
§c
, 
de°_Àn
, 
de°
);

752 i‡(
£g
->
com¥essi⁄
 =
	`˝u_to_be32
(
CBFS_COMPRESS_NONE
)) {

753 i‡(
§c_Àn
 > 
de°_Àn
)

754 
§c_Àn
 = 
de°_Àn
;

755 
	`mem˝y
(
de°
, 
§c
, 
§c_Àn
);

756 } i‡(
CONFIG_LZMA


757 && 
£g
->
com¥essi⁄
 =
	`˝u_to_be32
(
CBFS_COMPRESS_LZMA
)) {

758 
ªt
 = 
	`ulzma
(
de°
, 
de°_Àn
, 
§c
, 
§c_Àn
);

759 i‡(
ªt
 < 0)

761 
§c_Àn
 = 
ªt
;

763 
	`d¥ötf
(1, "No support for compressionÅype %x\n"

764 , 
£g
->
com¥essi⁄
);

767 i‡(
de°_Àn
 > 
§c_Àn
)

768 
	`mem£t
(
de°
 + 
§c_Àn
, 0, 
de°_Àn
 - src_len);

771 
£g
++;

773 
	}
}

777 
	$cbfs_∑ylﬂd_£tup
()

779 i‡(!
CONFIG_COREBOOT_FLASH
)

781 
romfûe_s
 *
fûe
 = 
NULL
;

783 
fûe
 = 
	`romfûe_föd¥efix
("img/", file);

784 i‡(!
fûe
)

786 
cbfs_romfûe_s
 *
cfûe
;

787 
cfûe
 = 
	`c⁄èöî_of
(
fûe
, 
cbfs_romfûe_s
, file);

788 c⁄° *
fûíame
 = 
fûe
->
«me
;

789 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "Paylﬂd [%s]", &
fûíame
[4]);

790 
	`boŸ_add_cbfs
(
cfûe
->
fhdr
, 
desc
, 
	`boŸ¥io_föd_«med_rom
(
fûíame
, 0));

792 
	}
}

	@fw/coreboot.h

15 #i‚de‡
__COREBOOT_H


16 
	#__COREBOOT_H


	)

18 
	scbfs_romfûe_s
 {

19 
romfûe_s
 
	mfûe
;

20 
cbfs_fûe
 *
	mfhdr
;

21 *
	md©a
;

22 
u32
 
	møwsize
, 
	mÊags
;

25 
	scbmem_íåy
 {

26 
u32
 
	mmagic
;

27 
u32
 
	mid
;

28 
u64
 
	mba£
;

29 
u64
 
	msize
;

32 
	sboŸ‹dî_c⁄èöî
 {

33 
u32
 
	mboŸ‹dî_sig«tuª
;

34 
u32
 
	mboŸ‹dî_size
;

35 
	mboŸ‹dî_fûe_«me
[16];

36 
	mboŸ‹dî_d©a
[0];

39 
	#CBMEM_ID_BOOTORDER
 0x424f4f54

	)

40 
	#CBMEM_MAGIC
 0x434f5245

	)

42 * 
gë_cbmem_boŸ‹dî_fûe
();

43 *
föd_c‹eboŸ_buûd_d©e
();

44 
u64
 
föd_c‹eboŸ_mem_size
();

	@fw/csm.c

7 
	~"bªgs.h
"

8 
	~"c⁄fig.h
"

9 
	~"ÁΩå.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pic.h
"

12 
	~"mÆloc.h
"

13 
	~"memm≠.h
"

14 
	~"ouçut.h
"

15 
	~"°acks.h
"

16 
	~"°d/a˝i.h
"

17 
	~"°d/bda.h
"

18 
	~"°d/›ti⁄rom.h
"

19 
	~"utû.h
"

20 
	~"∑øvút.h
"

22 
	#UINT8
 
u8


	)

23 
	#UINT16
 
u16


	)

24 
	#UINT32
 
u32


	)

25 
	~"°d/LegacyBios.h
"

27 
rsdp_des¸ùt‹
 
csm_rsdp
 
VARFSEG
 
__Æig√d
(16);

29 
EFI_COMPATIBILITY16_TABLE
 
csm_com∑t_èbÀ
 
VARFSEG
 
__Æig√d
(16) = {

30 .
Sig«tuª
 = 0x24454649,

31 .
	gTabÀChecksum
 = 0 ,

32 .
	gTabÀLígth
 = (
csm_com∑t_èbÀ
),

33 .
	gCom∑tibûôy16CÆlSegmít
 = 
SEG_BIOS
,

34 .
	gCom∑tibûôy16CÆlOff£t
 = 0 ,

35 .
	gOemIdSåögPoöãr
 = (
u32
)"SeaBIOS",

36 .
	gA˝iRsdPåPoöãr
 = (
u32
)&
csm_rsdp
,

39 
EFI_TO_COMPATIBILITY16_INIT_TABLE
 *
	gcsm_öô_èbÀ
;

40 
EFI_TO_COMPATIBILITY16_BOOT_TABLE
 *
	gcsm_boŸ_èbÀ
;

42 
u16
 
	gPICMask
 = 
PIC_IRQMASK_DEFAULT
;

44 
	$__csm_ªtu∫
(
bªgs
 *
ªgs
Ë
__n‹ëu∫
;

47 
	$csm_ªtu∫
(
bªgs
 *
ªgs
)

49 
	`d¥ötf
(3, "h™dÀ_csmÑëu∫ög AX=%04x\n", 
ªgs
->
ax
);

51 
PICMask
 = 
	`pic_úqmask_ªad
();

52 
	`__csm_ªtu∫
(
ªgs
);

53 
	}
}

56 
	$csm_maööô
(
bªgs
 *
ªgs
)

58 
	`öãrÁ˚_öô
();

59 
	`pci_¥obe_devi˚s
();

61 
csm_com∑t_èbÀ
.
PnPIn°Æœti⁄CheckSegmít
 = 
SEG_BIOS
;

62 
csm_com∑t_èbÀ
.
PnPIn°Æœti⁄CheckOff£t
 = 
	`gë_≤p_off£t
();

64 
ªgs
->
ax
 = 0;

66 
	`csm_ªtu∫
(
ªgs
);

67 
	}
}

71 
	$h™dÀ_csm_0000
(
bªgs
 *
ªgs
)

73 
	`qemu_¥eöô
();

75 
	`d¥ötf
(3, "Legacy16InôülizeYour£l‡èbÀ %04x:%04x\n", 
ªgs
->
es
,

76 
ªgs
->
bx
);

78 
csm_öô_èbÀ
 = 
	`MAKE_FLATPTR
(
ªgs
->
es
,Ñegs->
bx
);

80 
	`d¥ötf
(3, "BiosLessTh™1MB %08x\n", 
csm_öô_èbÀ
->
BiosLessTh™1MB
);

81 
	`d¥ötf
(3, "HiPmmMem‹y %08x\n", 
csm_öô_èbÀ
->
HiPmmMem‹y
);

82 
	`d¥ötf
(3, "HiPmmMem‹ySizê%08x\n", 
csm_öô_èbÀ
->
HiPmmMem‹ySizeInByãs
);

83 
	`d¥ötf
(3, "Revî£Thunk %04x:%04x\n", 
csm_öô_èbÀ
->
Revî£ThunkCÆlSegmít
,

84 
csm_öô_èbÀ
->
Revî£ThunkCÆlOff£t
);

85 
	`d¥ötf
(3, "NumE820E¡rõ† %08x\n", 
csm_öô_èbÀ
->
NumbîE820E¡rõs
);

86 
	`d¥ötf
(3, "OsMem‹yAbove1M %08x\n", 
csm_öô_èbÀ
->
OsMem‹yAbove1Mb
);

87 
	`d¥ötf
(3, "ThunkSèπ %08x\n", 
csm_öô_èbÀ
->
ThunkSèπ
);

88 
	`d¥ötf
(3, "ThunkSizê %08x\n", 
csm_öô_èbÀ
->
ThunkSizeInByãs
);

89 
	`d¥ötf
(3, "LoPmmMem‹y %08x\n", 
csm_öô_èbÀ
->
LowPmmMem‹y
);

90 
	`d¥ötf
(3, "LoPmmMem‹ySizê%08x\n", 
csm_öô_èbÀ
->
LowPmmMem‹ySizeInByãs
);

92 
	`csm_mÆloc_¥eöô
(
csm_öô_èbÀ
->
LowPmmMem‹y
,

93 
csm_öô_èbÀ
->
LowPmmMem‹ySizeInByãs
,

94 
csm_öô_èbÀ
->
HiPmmMem‹y
,

95 
csm_öô_èbÀ
->
HiPmmMem‹ySizeInByãs
);

96 
	`ªloc_¥eöô
(
csm_maööô
, 
ªgs
);

97 
	}
}

101 
	$h™dÀ_csm_0001
(
bªgs
 *
ªgs
)

103 i‡(!
CONFIG_BOOT
) {

104 
ªgs
->
ax
 = 1;

108 
	`d¥ötf
(3, "Legacy16Upd©eBb†èbÀ %04x:%04x\n", 
ªgs
->
es
,Ñegs->
bx
);

110 
csm_boŸ_èbÀ
 = 
	`MAKE_FLATPTR
(
ªgs
->
es
,Ñegs->
bx
);

111 
	`d¥ötf
(3, "Maj‹Vîsi⁄ %04x\n", 
csm_boŸ_èbÀ
->
Maj‹Vîsi⁄
);

112 
	`d¥ötf
(3, "Mö‹Vîsi⁄ %04x\n", 
csm_boŸ_èbÀ
->
Mö‹Vîsi⁄
);

113 
	`d¥ötf
(3, "A˝iTabÀ %08x\n", 
csm_boŸ_èbÀ
->
A˝iTabÀ
);

114 
	`d¥ötf
(3, "SmbiosTabÀ %08x\n", 
csm_boŸ_èbÀ
->
SmbiosTabÀ
);

115 
	`d¥ötf
(3, "SmbiosTabÀLígth %08x\n", 
csm_boŸ_èbÀ
->
SmbiosTabÀLígth
);

117 
	`d¥ötf
(3, "Devi˚P©hTy≥ %04x\n", 
csm_boŸ_èbÀ
->
Devi˚P©hTy≥
);

118 
	`d¥ötf
(3, "PciIrqMask %04x\n", 
csm_boŸ_èbÀ
->
PciIrqMask
);

119 
	`d¥ötf
(3, "NumbîE820E¡rõ†%08x\n", 
csm_boŸ_èbÀ
->
NumbîE820E¡rõs
);

121 
	`d¥ötf
(3, "NumbîBbsE¡rõ†%08x\n", 
csm_boŸ_èbÀ
->
NumbîBbsE¡rõs
);

122 
	`d¥ötf
(3, "BBsTabÀ %08x\n", 
csm_boŸ_èbÀ
->
BbsTabÀ
);

123 
	`d¥ötf
(3, "SmmTabÀ %08x\n", 
csm_boŸ_èbÀ
->
SmmTabÀ
);

124 
	`d¥ötf
(3, "OsMem‹yAbove1Mb %08x\n", 
csm_boŸ_èbÀ
->
OsMem‹yAbove1Mb
);

125 
	`d¥ötf
(3, "Unc⁄víti⁄ÆDevi˚TabÀ %08x\n", 
csm_boŸ_èbÀ
->
Unc⁄víti⁄ÆDevi˚TabÀ
);

127 
ªgs
->
ax
 = 0;

128 
	}
}

132 
	$h™dÀ_csm_0002
(
bªgs
 *
ªgs
)

134 i‡(!
CONFIG_BOOT
) {

135 
ªgs
->
ax
 = 1;

139 
	`d¥ötf
(3, "Pª∑ªToBoŸÅabÀ %04x:%04x\n", 
ªgs
->
es
,Ñegs->
bx
);

141 
e820íåy
 *
p
 = (*)
csm_com∑t_èbÀ
.
E820Poöãr
;

142 
i
;

143 
i
=0; i < 
csm_com∑t_èbÀ
.
E820Lígth
 / (
e820íåy
); i++)

144 
	`add_e820
(
p
[
i
].
°¨t
,Ö[i].
size
,Ö[i].
ty≥
);

146 i‡(
csm_öô_èbÀ
->
HiPmmMem‹ySizeInByãs
 > 
BUILD_MAX_HIGHTABLE
) {

147 
u32
 
hi_pmm_íd
 = 
csm_öô_èbÀ
->
HiPmmMem‹y
 + csm_öô_èbÀ->
HiPmmMem‹ySizeInByãs
;

148 
	`add_e820
(
hi_pmm_íd
 - 
BUILD_MAX_HIGHTABLE
, BUILD_MAX_HIGHTABLE, 
E820_RESERVED
);

152 i‡(
csm_com∑t_èbÀ
.
IrqRoutögTabÀPoöãr
 &&

153 
csm_com∑t_èbÀ
.
IrqRoutögTabÀLígth
) {

154 
PúAddr
 = (*)
csm_com∑t_èbÀ
.
IrqRoutögTabÀPoöãr
;

155 
	`d¥ötf
(3, "CSM PIRQÅabÀáà%p\n", 
PúAddr
);

159 i‡(
csm_rsdp
.
sig«tuª
 =
RSDP_SIGNATURE
) {

160 
RsdpAddr
 = &
csm_rsdp
;

161 
	`d¥ötf
(3, "CSM ACPI RSDPáà%p\n", 
RsdpAddr
);

163 
	`föd_a˝i_„©uªs
();

168 i‡(
csm_boŸ_èbÀ
->
SmbiosTabÀ
 && !
SMBiosAddr
)

169 
	`c›y_smbios
((*)
csm_boŸ_èbÀ
->
SmbiosTabÀ
);

174 
	`íabÀ_vga_c⁄sﬁe
();

177 
bios_d©a_¨ó_s
 *
bda
 = 
	`MAKE_FLATPTR
(
SEG_BDA
, 0);

178 
bda
->
hdcou¡
 = 0;

180 
	`m©h˝_£tup
();

181 
	`timî_£tup
();

182 
	`˛ock_£tup
();

183 
	`devi˚_h¨dw¨e_£tup
();

184 
	`waô_thªads
();

185 
	`öãø˘ive_boŸmíu
();

187 
	`¥ï¨eboŸ
();

189 
ªgs
->
ax
 = 0;

190 
	}
}

194 
	$h™dÀ_csm_0003
(
bªgs
 *
ªgs
)

196 i‡(!
CONFIG_BOOT
) {

197 
ªgs
->
ax
 = 1;

201 
	`d¥ötf
(3, "Boot\n");

203 
	`°¨tBoŸ
();

205 
ªgs
->
ax
 = 1;

206 
	}
}

210 
	$h™dÀ_csm_0005
(
bªgs
 *
ªgs
)

212 
EFI_DISPATCH_OPROM_TABLE
 *
èbÀ
 = 
	`MAKE_FLATPTR
(
ªgs
->
es
,Ñegs->
bx
);

213 
rom_hódî
 *
rom
;

214 
u16
 
bdf
;

216 i‡(!
CONFIG_OPTIONROMS
) {

217 
ªgs
->
ax
 = 1;

221 
	`d¥ötf
(3, "Legacy16Di•©chO¥omÑom %p\n", 
èbÀ
);

223 
	`d¥ötf
(3, "O¥omSegmíà %04x\n", 
èbÀ
->
O¥omSegmít
);

224 
	`d¥ötf
(3, "Ru¡imeSegmíà%04x\n", 
èbÀ
->
Ru¡imeSegmít
);

225 
	`d¥ötf
(3, "PnPInstallationCheck %04x:%04x\n",

226 
èbÀ
->
PnPIn°Æœti⁄CheckSegmít
,

227 
èbÀ
->
PnPIn°Æœti⁄CheckOff£t
);

228 
	`d¥ötf
(3, "Ru¡imeSegmíà%04x\n", 
èbÀ
->
Ru¡imeSegmít
);

230 
rom
 = 
	`MAKE_FLATPTR
(
èbÀ
->
O¥omSegmít
, 0);

231 
bdf
 = 
	`pci_bus_dev‚_to_bdf
(
èbÀ
->
PciBus
,ÅabÀ->
PciDevi˚Fun˘i⁄
);

233 
	`rom_ª£rve
(
rom
->
size
 * 512);

236 
	`ˇŒrom
(
rom
, 
bdf
);

238 
	`rom_c⁄fúm
(
rom
->
size
 * 512);

240 
ªgs
->
bx
 = 0;

241 
ªgs
->
ax
 = 0;

242 
	}
}

246 
	$h™dÀ_csm_0006
(
bªgs
 *
ªgs
)

248 
u16
 
size
 = 
ªgs
->
cx
;

249 
u16
 
Æign
 = 
ªgs
->
dx
;

250 
u16
 
ªgi⁄
 = 
ªgs
->
bx
;

251 *
chunk
 = 
NULL
;

253 i‡(!
ªgi⁄
)

254 
ªgi⁄
 = 3;

256 
	`d¥ötf
(3, "Legacy16GetTableAddress size %xálign %xÑegion %d\n",

257 
size
, 
Æign
, 
ªgi⁄
);

259 i‡(
ªgi⁄
 & 2)

260 
chunk
 = 
	`_mÆloc
(&
Z⁄eLow
, 
size
, 
Æign
);

261 i‡(!
chunk
 && (
ªgi⁄
 & 1))

262 
chunk
 = 
	`_mÆloc
(&
Z⁄eFSeg
, 
size
, 
Æign
);

264 
	`d¥ötf
(3, "Legacy16GetTableAddress size %xálign %xÑegion %d yields %p\n",

265 
size
, 
Æign
, 
ªgi⁄
, 
chunk
);

266 i‡(
chunk
) {

267 
ªgs
->
ds
 = 
	`FLATPTR_TO_SEG
(
chunk
);

268 
ªgs
->
bx
 = 
	`FLATPTR_TO_OFFSET
(
chunk
);

269 
ªgs
->
ax
 = 0;

271 
ªgs
->
ax
 = 1;

273 
	}
}

275 
VISIBLE32INIT


276 
	$h™dÀ_csm
(
bªgs
 *
ªgs
)

278 
	`ASSERT32FLAT
();

280 i‡(!
CONFIG_CSM
)

283 
	`d¥ötf
(3, "h™dÀ_csmÑeg†%∞AX=%04x\n", 
ªgs
,Ñegs->
ax
);

285 
	`pic_úqmask_wrôe
(
PICMask
);

287 
ªgs
->
ax
) {

288 0000: 
	`h™dÀ_csm_0000
(
ªgs
); ;

289 0001: 
	`h™dÀ_csm_0001
(
ªgs
); ;

290 0002: 
	`h™dÀ_csm_0002
(
ªgs
); ;

291 0003: 
	`h™dÀ_csm_0003
(
ªgs
); ;

293 0005: 
	`h™dÀ_csm_0005
(
ªgs
); ;

294 0006: 
	`h™dÀ_csm_0006
(
ªgs
); ;

297 : 
ªgs
->
Æ
 = 1;

300 
	`csm_ªtu∫
(
ªgs
);

301 
	}
}

303 
	$csm_boŸ¥io_©a
(
pci_devi˚
 *
pci
, 
ch™id
, 
¶ave
)

305 i‡(!
csm_boŸ_èbÀ
)

307 
BBS_TABLE
 *
bbs
 = (*)
csm_boŸ_èbÀ
->
BbsTabÀ
;

308 
ödex
 = 1 + (
ch™id
 * 2Ë+ 
¶ave
;

309 
	`d¥ötf
(3, "CSM boŸ¥iÿf‹ ATA%d,%d (ödex %dËi†%d\n", 
ch™id
, 
¶ave
,

310 
ödex
, 
bbs
[ödex].
BoŸPri‹ôy
);

311  
bbs
[
ödex
].
BoŸPri‹ôy
;

312 
	}
}

314 
	$csm_boŸ¥io_fdc
(
pci_devi˚
 *
pci
, 
p‹t
, 
fdid
)

316 i‡(!
csm_boŸ_èbÀ
)

318 
BBS_TABLE
 *
bbs
 = (*)
csm_boŸ_èbÀ
->
BbsTabÀ
;

319 
	`d¥ötf
(3, "CSM boŸ¥iÿf‹ FDC i†%d\n", 
bbs
[0].
BoŸPri‹ôy
);

320  
bbs
[0].
BoŸPri‹ôy
;

321 
	}
}

323 
	$csm_boŸ¥io_pci
(
pci_devi˚
 *
pci
)

325 i‡(!
csm_boŸ_èbÀ
)

327 
BBS_TABLE
 *
bbs
 = (*)
csm_boŸ_èbÀ
->
BbsTabÀ
;

328 
i
;

330 
i
 = 5; i < 
csm_boŸ_èbÀ
->
NumbîBbsE¡rõs
; i++) {

331 i‡(
pci
->
bdf
 =
	`pci_to_bdf
(
bbs
[
i
].
Bus
, bbs[i].
Devi˚
, bbs[i].
Fun˘i⁄
)) {

332 
	`d¥ötf
(3, "CSM boŸ¥iÿf‹ PCI(%d,%d,%dËi†%d\n", 
bbs
[
i
].
Bus
,

333 
bbs
[
i
].
Devi˚
, bbs[i].
Fun˘i⁄
, bbs[i].
BoŸPri‹ôy
);

334  
bbs
[
i
].
BoŸPri‹ôy
;

338 
	}
}

	@fw/dev-q35.h

1 #i‚de‡
__DEV_Q35_H


2 
	#__DEV_Q35_H


	)

4 
	~"ty≥s.h
"

6 
	#PCI_DEVICE_ID_INTEL_Q35_MCH
 0x29c0

	)

7 
	#Q35_HOST_BRIDGE_PAM0
 0x90

	)

8 
	#Q35_HOST_BRIDGE_SMRAM
 0x9d

	)

9 
	#Q35_HOST_BRIDGE_PCIEXBAR
 0x60

	)

10 
	#Q35_HOST_BRIDGE_PCIEXBAR_SIZE
 (256 * 1024 * 1024)

	)

11 
	#Q35_HOST_BRIDGE_PCIEXBAR_ADDR
 0xb0000000

	)

12 
	#Q35_HOST_BRIDGE_PCIEXBAREN
 ((
u64
)1)

	)

13 
	#Q35_HOST_PCIE_PCI_SEGMENT
 0

	)

14 
	#Q35_HOST_PCIE_START_BUS_NUMBER
 0

	)

15 
	#Q35_HOST_PCIE_END_BUS_NUMBER
 255

	)

17 
	#PCI_DEVICE_ID_INTEL_ICH9_LPC
 0x2918

	)

18 
	#ICH9_LPC_PMBASE
 0x40

	)

19 
	#ICH9_LPC_PMBASE_RTE
 0x1

	)

21 
	#ICH9_LPC_ACPI_CTRL
 0x44

	)

22 
	#ICH9_LPC_ACPI_CTRL_ACPI_EN
 0x80

	)

23 
	#ICH9_LPC_PIRQA_ROUT
 0x60

	)

24 
	#ICH9_LPC_PIRQE_ROUT
 0x68

	)

25 
	#ICH9_LPC_PIRQ_ROUT_IRQEN
 0x80

	)

26 
	#ICH9_LPC_PORT_ELCR1
 0x4d0

	)

27 
	#ICH9_LPC_PORT_ELCR2
 0x4d1

	)

28 
	#PCI_DEVICE_ID_INTEL_ICH9_SMBUS
 0x2930

	)

29 
	#ICH9_SMB_SMB_BASE
 0x20

	)

30 
	#ICH9_SMB_HOSTC
 0x40

	)

31 
	#ICH9_SMB_HOSTC_HST_EN
 0x01

	)

33 
	#ICH9_ACPI_ENABLE
 0x2

	)

34 
	#ICH9_ACPI_DISABLE
 0x3

	)

37 
	#ICH9_PMIO_GPE0_STS
 0x20

	)

38 
	#ICH9_PMIO_GPE0_BLK_LEN
 0x10

	)

39 
	#ICH9_PMIO_SMI_EN
 0x30

	)

40 
	#ICH9_PMIO_SMI_EN_APMC_EN
 (1 << 5)

	)

43 
	#ICH9_APM_ACPI_ENABLE
 0x2

	)

44 
	#ICH9_APM_ACPI_DISABLE
 0x3

	)

	@fw/efi.h

1 #i‚de‡
__EFI_H__


2 
	#__EFI_H__


	)

4 
u64
 
	tEFI_PHYSICAL_ADDRESS
;

5 
u64
 
	tEFI_VIRTUAL_ADDRESS
;

15 
	mEfiRe£rvedMem‹yTy≥
,

20 
	mEfiLﬂdîCode
,

25 
	mEfiLﬂdîD©a
,

29 
	mEfiBoŸSîvi˚sCode
,

34 
	mEfiBoŸSîvi˚sD©a
,

38 
	mEfiRu¡imeSîvi˚sCode
,

43 
	mEfiRu¡imeSîvi˚sD©a
,

47 
	mEfiC⁄víti⁄ÆMem‹y
,

51 
	mEfiUnußbÀMem‹y
,

55 
	mEfiACPIRe˛aimMem‹y
,

59 
	mEfiACPIMem‹yNVS
,

64 
	mEfiMem‹yM≠≥dIO
,

69 
	mEfiMem‹yM≠≥dIOP‹tS∑˚
,

73 
	mEfiPÆCode
,

74 
	mEfiMaxMem‹yTy≥


75 } 
	tEFI_MEMORY_TYPE
;

81 
	#EFI_MEMORY_UC
 0x0000000000000001

	)

82 
	#EFI_MEMORY_WC
 0x0000000000000002

	)

83 
	#EFI_MEMORY_WT
 0x0000000000000004

	)

84 
	#EFI_MEMORY_WB
 0x0000000000000008

	)

85 
	#EFI_MEMORY_UCE
 0x0000000000000010

	)

86 
	#EFI_MEMORY_WP
 0x0000000000001000

	)

87 
	#EFI_MEMORY_RP
 0x0000000000002000

	)

88 
	#EFI_MEMORY_XP
 0x0000000000004000

	)

89 
	#EFI_MEMORY_RUNTIME
 0x8000000000000000

	)

92 
u32
 
	mTy≥
;

93 
u32
 
	mRe£rved
;

94 
EFI_PHYSICAL_ADDRESS
 
	mPhysiˇlSèπ
;

95 
EFI_VIRTUAL_ADDRESS
 
	mVútuÆSèπ
;

96 
u64
 
	mNumbîOfPages
;

97 
u64
 
	mAâribuã
;

98 } 
	tEFI_MEMORY_DESCRIPTOR
;

	@fw/lzmadecode.c

22 
	~"lzmadecode.h
"

24 
	#kNumT›Bôs
 24

	)

25 
	#kT›VÆue
 ((
UI¡32
)1 << 
kNumT›Bôs
)

	)

27 
	#kNumBôModñTŸÆBôs
 11

	)

28 
	#kBôModñTŸÆ
 (1 << 
kNumBôModñTŸÆBôs
)

	)

29 
	#kNumMoveBôs
 5

	)

31 
	#RC_READ_BYTE
 (*
Buf„r
++)

	)

33 
	#RC_INIT2
 
Code
 = 0; 
R™ge
 = 0xFFFFFFFF; \

34 { 
i
; ò0; i < 5; i++Ë{ 
RC_TEST
; 
Code
 = (Codê<< 8Ë| 
RC_READ_BYTE
; }}

	)

37 
	#RC_TEST
 { i‡(
Buf„r
 =
Buf„rLim
Ë 
LZMA_RESULT_DATA_ERROR
; }

	)

39 
	#RC_INIT
(
buf„r
, 
buf„rSize
Ë
Buf„r
 = buf„r; 
Buf„rLim
 = buf„∏+ buf„rSize; 
RC_INIT2


	)

42 
	#RC_NORMALIZE
 i‡(
R™ge
 < 
kT›VÆue
Ë{ 
RC_TEST
; R™gê<<8; 
Code
 = (Codê<< 8Ë| 
RC_READ_BYTE
; }

	)

44 
	#IfBô0
(
p
Ë
RC_NORMALIZE
; 
bound
 = (
R™ge
 >> 
kNumBôModñTŸÆBôs
Ë* *’); i‡(
Code
 < bound)

	)

45 
	#Upd©eBô0
(
p
Ë
R™ge
 = 
bound
; *’Ë+(
kBôModñTŸÆ
 - *’)Ë>> 
kNumMoveBôs
;

	)

46 
	#Upd©eBô1
(
p
Ë
R™ge
 -
bound
; 
Code
 -bound; *’Ë-(*’)Ë>> 
kNumMoveBôs
;

	)

48 
	#RC_GET_BIT2
(
p
, 
mi
, 
A0
, 
A1
Ë
	`IfBô0
(p) \

49 { 
	`Upd©eBô0
(
p
); 
mi
 <<1; 
A0
; } \

50 { 
	`Upd©eBô1
(
p
); 
mi
 = (mò+ miË+ 1; 
A1
; }

	)

52 
	#RC_GET_BIT
(
p
, 
mi
Ë
	`RC_GET_BIT2
’, mi, ; , ;)

	)

54 
	#R™geDecodîBôTªeDecode
(
¥obs
, 
numLevñs
, 
ªs
) \

55 { 
i
 = 
numLevñs
; 
ªs
 = 1; \

56 dÿ{ 
CProb
 *
˝
 = 
¥obs
 + 
ªs
; 
	`RC_GET_BIT
(˝,ÑesË} --
i
 != 0); \

57 
ªs
 -(1 << 
numLevñs
); }

	)

60 
	#kNumPosBôsMax
 4

	)

61 
	#kNumPosSèãsMax
 (1 << 
kNumPosBôsMax
)

	)

63 
	#kLíNumLowBôs
 3

	)

64 
	#kLíNumLowSymbﬁs
 (1 << 
kLíNumLowBôs
)

	)

65 
	#kLíNumMidBôs
 3

	)

66 
	#kLíNumMidSymbﬁs
 (1 << 
kLíNumMidBôs
)

	)

67 
	#kLíNumHighBôs
 8

	)

68 
	#kLíNumHighSymbﬁs
 (1 << 
kLíNumHighBôs
)

	)

70 
	#LíChoi˚
 0

	)

71 
	#LíChoi˚2
 (
LíChoi˚
 + 1)

	)

72 
	#LíLow
 (
LíChoi˚2
 + 1)

	)

73 
	#LíMid
 (
LíLow
 + (
kNumPosSèãsMax
 << 
kLíNumLowBôs
))

	)

74 
	#LíHigh
 (
LíMid
 + (
kNumPosSèãsMax
 << 
kLíNumMidBôs
))

	)

75 
	#kNumLíProbs
 (
LíHigh
 + 
kLíNumHighSymbﬁs
)

	)

78 
	#kNumSèãs
 12

	)

79 
	#kNumLôSèãs
 7

	)

81 
	#kSèπPosModñIndex
 4

	)

82 
	#kEndPosModñIndex
 14

	)

83 
	#kNumFuŒDi°™˚s
 (1 << (
kEndPosModñIndex
 >> 1))

	)

85 
	#kNumPosSlŸBôs
 6

	)

86 
	#kNumLíToPosSèãs
 4

	)

88 
	#kNumAlignBôs
 4

	)

89 
	#kAlignTabÀSize
 (1 << 
kNumAlignBôs
)

	)

91 
	#kM©chMöLí
 2

	)

93 
	#IsM©ch
 0

	)

94 
	#IsRï
 (
IsM©ch
 + (
kNumSèãs
 << 
kNumPosBôsMax
))

	)

95 
	#IsRïG0
 (
IsRï
 + 
kNumSèãs
)

	)

96 
	#IsRïG1
 (
IsRïG0
 + 
kNumSèãs
)

	)

97 
	#IsRïG2
 (
IsRïG1
 + 
kNumSèãs
)

	)

98 
	#IsRï0L⁄g
 (
IsRïG2
 + 
kNumSèãs
)

	)

99 
	#PosSlŸ
 (
IsRï0L⁄g
 + (
kNumSèãs
 << 
kNumPosBôsMax
))

	)

100 
	#S≥cPos
 (
PosSlŸ
 + (
kNumLíToPosSèãs
 << 
kNumPosSlŸBôs
))

	)

101 
	#Align
 (
S≥cPos
 + 
kNumFuŒDi°™˚s
 - 
kEndPosModñIndex
)

	)

102 
	#LíCodî
 (
Align
 + 
kAlignTabÀSize
)

	)

103 
	#RïLíCodî
 (
LíCodî
 + 
kNumLíProbs
)

	)

104 
	#LôîÆ
 (
RïLíCodî
 + 
kNumLíProbs
)

	)

106 #i‡
LôîÆ
 !
LZMA_BASE_SIZE


107 
	gSt›CompûögDueBUG


110 
	$LzmaDecodePr›îtõs
(
CLzmaPr›îtõs
 *
¥›sRes
, c⁄° *
¥›sD©a
, 
size
)

112 
¥›0
;

113 i‡(
size
 < 
LZMA_PROPERTIES_SIZE
)

114  
LZMA_RESULT_DATA_ERROR
;

115 
¥›0
 = 
¥›sD©a
[0];

116 i‡(
¥›0
 >= (9 * 5 * 5))

117  
LZMA_RESULT_DATA_ERROR
;

119 
¥›sRes
->
pb
 = 0; 
¥›0
 >= (9 * 5);ÖropsRes->pb++,Örop0 -= (9 * 5));

120 
¥›sRes
->
Õ
 = 0; 
¥›0
 >= 9;ÖropsRes->lp++,Örop0 -= 9);

121 
¥›sRes
->
lc
 = 
¥›0
;

130  
LZMA_RESULT_OK
;

131 
	}
}

133 
	#kLzmaSåómWasFöishedId
 (-1)

	)

135 
	$LzmaDecode
(
CLzmaDecodîSèã
 *
vs
,

136 c⁄° *
öSåóm
, 
SizeT
 
öSize
, SizeT *
öSizePro˚s£d
,

137 *
outSåóm
, 
SizeT
 
outSize
, SizeT *
outSizePro˚s£d
)

139 
CProb
 *
p
 = 
vs
->
Probs
;

140 
SizeT
 
nowPos
 = 0;

141 
Byã
 
¥eviousByã
 = 0;

142 
UI¡32
 
posSèãMask
 = (1 << (
vs
->
Pr›îtõs
.
pb
)) - 1;

143 
UI¡32
 
lôîÆPosMask
 = (1 << (
vs
->
Pr›îtõs
.
Õ
)) - 1;

144 
lc
 = 
vs
->
Pr›îtõs
.lc;

147 
°©e
 = 0;

148 
UI¡32
 
ªp0
 = 1, 
ªp1
 = 1, 
ªp2
 = 1, 
ªp3
 = 1;

149 
Àn
 = 0;

150 c⁄° 
Byã
 *
Buf„r
;

151 c⁄° 
Byã
 *
Buf„rLim
;

152 
UI¡32
 
R™ge
;

153 
UI¡32
 
Code
;

155 *
öSizePro˚s£d
 = 0;

156 *
outSizePro˚s£d
 = 0;

159 
UI¡32
 
i
;

160 
UI¡32
 
numProbs
 = 
LôîÆ
 + ((UI¡32)
LZMA_LIT_SIZE
 << (
lc
 + 
vs
->
Pr›îtõs
.
Õ
));

161 
i
 = 0; i < 
numProbs
; i++)

162 
p
[
i
] = 
kBôModñTŸÆ
 >> 1;

165 
	`RC_INIT
(
öSåóm
, 
öSize
);

168 
nowPos
 < 
outSize
)

170 
CProb
 *
¥ob
;

171 
UI¡32
 
bound
;

172 
posSèã
 = ()(

173 (
nowPos


175 & 
posSèãMask
);

177 
¥ob
 = 
p
 + 
IsM©ch
 + (
°©e
 << 
kNumPosBôsMax
Ë+ 
posSèã
;

178 
	`IfBô0
(
¥ob
)

180 
symbﬁ
 = 1;

181 
	`Upd©eBô0
(
¥ob
)

182 
¥ob
 = 
p
 + 
LôîÆ
 + (
LZMA_LIT_SIZE
 *

184 (
nowPos


186 & 
lôîÆPosMask
Ë<< 
lc
Ë+ (
¥eviousByã
 >> (8 -Üc))));

188 i‡(
°©e
 >
kNumLôSèãs
)

190 
m©chByã
;

191 
m©chByã
 = 
outSåóm
[
nowPos
 - 
ªp0
];

194 
bô
;

195 
CProb
 *
¥obLô
;

196 
m©chByã
 <<= 1;

197 
bô
 = (
m©chByã
 & 0x100);

198 
¥obLô
 = 
¥ob
 + 0x100 + 
bô
 + 
symbﬁ
;

199 
	`RC_GET_BIT2
(
¥obLô
, 
symbﬁ
, i‡(
bô
 != 0) , if (bit == 0) )

201 
symbﬁ
 < 0x100);

203 
symbﬁ
 < 0x100)

205 
CProb
 *
¥obLô
 = 
¥ob
 + 
symbﬁ
;

206 
	`RC_GET_BIT
(
¥obLô
, 
symbﬁ
)

208 
¥eviousByã
 = (
Byã
)
symbﬁ
;

210 
outSåóm
[
nowPos
++] = 
¥eviousByã
;

211 i‡(
°©e
 < 4) state = 0;

212 i‡(
°©e
 < 10) state -= 3;

213 
°©e
 -= 6;

217 
	`Upd©eBô1
(
¥ob
);

218 
¥ob
 = 
p
 + 
IsRï
 + 
°©e
;

219 
	`IfBô0
(
¥ob
)

221 
	`Upd©eBô0
(
¥ob
);

222 
ªp3
 = 
ªp2
;

223 
ªp2
 = 
ªp1
;

224 
ªp1
 = 
ªp0
;

225 
°©e
 = sèã < 
kNumLôSèãs
 ? 0 : 3;

226 
¥ob
 = 
p
 + 
LíCodî
;

230 
	`Upd©eBô1
(
¥ob
);

231 
¥ob
 = 
p
 + 
IsRïG0
 + 
°©e
;

232 
	`IfBô0
(
¥ob
)

234 
	`Upd©eBô0
(
¥ob
);

235 
¥ob
 = 
p
 + 
IsRï0L⁄g
 + (
°©e
 << 
kNumPosBôsMax
Ë+ 
posSèã
;

236 
	`IfBô0
(
¥ob
)

238 
	`Upd©eBô0
(
¥ob
);

240 i‡(
nowPos
 == 0)

241  
LZMA_RESULT_DATA_ERROR
;

243 
°©e
 = sèã < 
kNumLôSèãs
 ? 9 : 11;

244 
¥eviousByã
 = 
outSåóm
[
nowPos
 - 
ªp0
];

245 
outSåóm
[
nowPos
++] = 
¥eviousByã
;

251 
	`Upd©eBô1
(
¥ob
);

256 
UI¡32
 
di°™˚
;

257 
	`Upd©eBô1
(
¥ob
);

258 
¥ob
 = 
p
 + 
IsRïG1
 + 
°©e
;

259 
	`IfBô0
(
¥ob
)

261 
	`Upd©eBô0
(
¥ob
);

262 
di°™˚
 = 
ªp1
;

266 
	`Upd©eBô1
(
¥ob
);

267 
¥ob
 = 
p
 + 
IsRïG2
 + 
°©e
;

268 
	`IfBô0
(
¥ob
)

270 
	`Upd©eBô0
(
¥ob
);

271 
di°™˚
 = 
ªp2
;

275 
	`Upd©eBô1
(
¥ob
);

276 
di°™˚
 = 
ªp3
;

277 
ªp3
 = 
ªp2
;

279 
ªp2
 = 
ªp1
;

281 
ªp1
 = 
ªp0
;

282 
ªp0
 = 
di°™˚
;

284 
°©e
 = sèã < 
kNumLôSèãs
 ? 8 : 11;

285 
¥ob
 = 
p
 + 
RïLíCodî
;

288 
numBôs
, 
off£t
;

289 
CProb
 *
¥obLí
 = 
¥ob
 + 
LíChoi˚
;

290 
	`IfBô0
(
¥obLí
)

292 
	`Upd©eBô0
(
¥obLí
);

293 
¥obLí
 = 
¥ob
 + 
LíLow
 + (
posSèã
 << 
kLíNumLowBôs
);

294 
off£t
 = 0;

295 
numBôs
 = 
kLíNumLowBôs
;

299 
	`Upd©eBô1
(
¥obLí
);

300 
¥obLí
 = 
¥ob
 + 
LíChoi˚2
;

301 
	`IfBô0
(
¥obLí
)

303 
	`Upd©eBô0
(
¥obLí
);

304 
¥obLí
 = 
¥ob
 + 
LíMid
 + (
posSèã
 << 
kLíNumMidBôs
);

305 
off£t
 = 
kLíNumLowSymbﬁs
;

306 
numBôs
 = 
kLíNumMidBôs
;

310 
	`Upd©eBô1
(
¥obLí
);

311 
¥obLí
 = 
¥ob
 + 
LíHigh
;

312 
off£t
 = 
kLíNumLowSymbﬁs
 + 
kLíNumMidSymbﬁs
;

313 
numBôs
 = 
kLíNumHighBôs
;

316 
	`R™geDecodîBôTªeDecode
(
¥obLí
, 
numBôs
, 
Àn
);

317 
Àn
 +
off£t
;

320 i‡(
°©e
 < 4)

322 
posSlŸ
;

323 
°©e
 +
kNumLôSèãs
;

324 
¥ob
 = 
p
 + 
PosSlŸ
 +

325 ((
Àn
 < 
kNumLíToPosSèãs
 ?Üen : kNumLenToPosStates - 1) <<

326 
kNumPosSlŸBôs
);

327 
	`R™geDecodîBôTªeDecode
(
¥ob
, 
kNumPosSlŸBôs
, 
posSlŸ
);

328 i‡(
posSlŸ
 >
kSèπPosModñIndex
)

330 
numDúe˘Bôs
 = ((
posSlŸ
 >> 1) - 1);

331 
ªp0
 = (2 | ((
UI¡32
)
posSlŸ
 & 1));

332 i‡(
posSlŸ
 < 
kEndPosModñIndex
)

334 
ªp0
 <<
numDúe˘Bôs
;

335 
¥ob
 = 
p
 + 
S≥cPos
 + 
ªp0
 - 
posSlŸ
 - 1;

339 
numDúe˘Bôs
 -
kNumAlignBôs
;

342 
RC_NORMALIZE


343 
R™ge
 >>= 1;

344 
ªp0
 <<= 1;

345 i‡(
Code
 >
R™ge
)

347 
Code
 -
R™ge
;

348 
ªp0
 |= 1;

351 --
numDúe˘Bôs
 != 0);

352 
¥ob
 = 
p
 + 
Align
;

353 
ªp0
 <<
kNumAlignBôs
;

354 
numDúe˘Bôs
 = 
kNumAlignBôs
;

357 
i
 = 1;

358 
mi
 = 1;

361 
CProb
 *
¥ob3
 = 
¥ob
 + 
mi
;

362 
	`RC_GET_BIT2
(
¥ob3
, 
mi
, ; , 
ªp0
 |
i
);

363 
i
 <<= 1;

365 --
numDúe˘Bôs
 != 0);

369 
ªp0
 = 
posSlŸ
;

370 i‡(++
ªp0
 =(
UI¡32
)(0))

373 
Àn
 = 
kLzmaSåómWasFöishedId
;

378 
Àn
 +
kM©chMöLí
;

379 i‡(
ªp0
 > 
nowPos
)

380  
LZMA_RESULT_DATA_ERROR
;

385 
¥eviousByã
 = 
outSåóm
[
nowPos
 - 
ªp0
];

386 
Àn
--;

387 
outSåóm
[
nowPos
++] = 
¥eviousByã
;

389 
Àn
 !0 && 
nowPos
 < 
outSize
);

392 
RC_NORMALIZE
;

395 *
öSizePro˚s£d
 = (
SizeT
)(
Buf„r
 - 
öSåóm
);

396 *
outSizePro˚s£d
 = 
nowPos
;

397  
LZMA_RESULT_OK
;

398 
	}
}

	@fw/lzmadecode.h

22 #i‚de‡
__LZMADECODE_H


23 
	#__LZMADECODE_H


	)

25 
	tByã
;

26 
	tUI¡16
;

27 
	tUI¡32
;

28 
UI¡32
 
	tSizeT
;

30 
	#CProb
 
UI¡16


	)

32 
	#LZMA_RESULT_OK
 0

	)

33 
	#LZMA_RESULT_DATA_ERROR
 1

	)

36 
	#LZMA_BASE_SIZE
 1846

	)

37 
	#LZMA_LIT_SIZE
 768

	)

39 
	#LZMA_PROPERTIES_SIZE
 5

	)

41 
	s_CLzmaPr›îtõs


43 
	mlc
;

44 
	mÕ
;

45 
	mpb
;

46 }
	tCLzmaPr›îtõs
;

48 
LzmaDecodePr›îtõs
(
CLzmaPr›îtõs
 *
¥›sRes
, c⁄° *
¥›sD©a
, 
size
);

50 
	#LzmaGëNumProbs
(
Pr›îtõs
Ë(
LZMA_BASE_SIZE
 + (
LZMA_LIT_SIZE
 << ((Pr›îtõs)->
lc
 + (Pr›îtõs)->
Õ
)))

	)

52 
	#kLzmaNìdInôId
 (-2)

	)

54 
	s_CLzmaDecodîSèã


56 
CLzmaPr›îtõs
 
	mPr›îtõs
;

57 
CProb
 *
	mProbs
;

60 } 
	tCLzmaDecodîSèã
;

63 
LzmaDecode
(
CLzmaDecodîSèã
 *
vs
,

64 c⁄° *
öSåóm
, 
SizeT
 
öSize
, SizeT *
öSizePro˚s£d
,

65 *
outSåóm
, 
SizeT
 
outSize
, SizeT *
outSizePro˚s£d
);

	@fw/mptable.c

8 
	~"c⁄fig.h
"

9 
	~"hw/pci.h
"

10 
	~"hw/pci_ªgs.h
"

11 
	~"mÆloc.h
"

12 
	~"ouçut.h
"

13 
	~"romfûe.h
"

14 
	~"°d/m±abÀ.h
"

15 
	~"°rög.h
"

16 
	~"utû.h
"

17 
	~"x86.h
"

20 
	$m±abÀ_£tup
()

22 i‡(! 
CONFIG_MPTABLE
)

25 
	`d¥ötf
(3, "init MPTable\n");

28 
m±abÀ_c⁄fig_s
 *
c⁄fig
 = 
	`mÆloc_tmp
(32*1024);

29 i‡(!
c⁄fig
) {

30 
	`w¨n_nﬂŒoc
();

33 
	`mem£t
(
c⁄fig
, 0, (*config));

34 
c⁄fig
->
sig«tuª
 = 
MPCONFIG_SIGNATURE
;

35 
c⁄fig
->
•ec
 = 4;

36 
	`mem˝y
(
c⁄fig
->
€mid
, 
BUILD_CPUNAME8
, (config->oemid));

37 
	`mem˝y
(
c⁄fig
->
¥odu˘id
, "0.1 ", (config->productid));

38 
c⁄fig
->
œpic
 = 
BUILD_APIC_ADDR
;

41 
u32
 
˝uid_sig«tuª
, 
ebx
, 
ecx
, 
˝uid_„©uªs
;

42 
	`˝uid
(1, &
˝uid_sig«tuª
, &
ebx
, &
ecx
, &
˝uid_„©uªs
);

43 i‡(! 
˝uid_sig«tuª
) {

45 
˝uid_sig«tuª
 = 0x600;

46 
˝uid_„©uªs
 = 0x201;

48 
pkg˝us
 = 1;

49 i‡(
˝uid_„©uªs
 & (1 << 28)) {

52 
pkg˝us
 = (
ebx
 >> 16) & 0xff;

53 
pkg˝us
 = 1 << (
	`__Ês
(pkgcpus - 1) + 1);

55 
u8
 
≠ic_vîsi⁄
 = 
	`ªadl
((u8*)
BUILD_APIC_ADDR
 + 0x30) & 0xff;

58 
m±_˝u
 *
˝us
 = (*)&
c⁄fig
[1], *
˝u
 = cpus;

59 
i
;

60 
i
 = 0; i < 
MaxCou¡CPUs
; i+=
pkg˝us
) {

61 
	`mem£t
(
˝u
, 0, (*cpu));

62 
˝u
->
ty≥
 = 
MPT_TYPE_CPU
;

63 
˝u
->
≠icid
 = 
i
;

64 
˝u
->
≠icvî
 = 
≠ic_vîsi⁄
;

66 
˝u
->
˝uÊag
 = (
	`≠ic_id_is_¥e£¡
(
i
) ? 0x01 : 0x00) | ((i==0) ? 0x02 : 0x00);

67 
˝u
->
˝usig«tuª
 = 
˝uid_sig«tuª
;

68 
˝u
->
„©uªÊag
 = 
˝uid_„©uªs
;

69 
˝u
++;

71 
íåycou¡
 = 
˝u
 - 
˝us
;

74 
m±_bus
 *
bu£s
 = (*)
˝u
, *
bus
 = buses;

75 i‡(!
	`hli°_em±y
(&
PCIDevi˚s
)) {

76 
	`mem£t
(
bus
, 0, (*bus));

77 
bus
->
ty≥
 = 
MPT_TYPE_BUS
;

78 
bus
->
busid
 = 0;

79 
	`mem˝y
(
bus
->
bu°y≥
, "PCI ", (bus->bustype));

80 
bus
++;

81 
íåycou¡
++;

85 
ißbusid
 = 
bus
 - 
bu£s
;

86 
	`mem£t
(
bus
, 0, (*bus));

87 
bus
->
ty≥
 = 
MPT_TYPE_BUS
;

88 
bus
->
busid
 = 
ißbusid
;

89 
	`mem˝y
(
bus
->
bu°y≥
, "ISA ", (bus->bustype));

90 
bus
++;

91 
íåycou¡
++;

94 
u8
 
iﬂpic_id
 = 
BUILD_IOAPIC_ID
;

95 
m±_iﬂpic
 *
iﬂpic
 = (*)
bus
;

96 
	`mem£t
(
iﬂpic
, 0, (*ioapic));

97 
iﬂpic
->
ty≥
 = 
MPT_TYPE_IOAPIC
;

98 
iﬂpic
->
≠icid
 = 
iﬂpic_id
;

99 
iﬂpic
->
≠icvî
 = 0x11;

100 
iﬂpic
->
Êags
 = 1;

101 
iﬂpic
->
≠iˇddr
 = 
BUILD_IOAPIC_ADDR
;

102 
íåycou¡
++;

105 
m±_öt§c
 *
öt§cs
 = (*)&
iﬂpic
[1], *
öt§c
 = intsrcs;

106 
dev
 = -1;

107 
pömask
 = 0;

109 
pci_devi˚
 *
pci
;

110 
	`f‹óchpci
(
pci
) {

111 
u16
 
bdf
 = 
pci
->bdf;

112 i‡(
	`pci_bdf_to_bus
(
bdf
) != 0)

114 
pö
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_INTERRUPT_PIN
);

115 
úq
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_INTERRUPT_LINE
);

116 i‡(
pö
 == 0)

118 i‡(
dev
 !
	`pci_bdf_to_busdev
(
bdf
)) {

119 
dev
 = 
	`pci_bdf_to_busdev
(
bdf
);

120 
pömask
 = 0;

122 i‡(
pömask
 & (1 << 
pö
))

124 
pömask
 |(1 << 
pö
);

125 
	`mem£t
(
öt§c
, 0, (*intsrc));

126 
öt§c
->
ty≥
 = 
MPT_TYPE_INTSRC
;

127 
öt§c
->
úqty≥
 = 0;

128 
öt§c
->
úqÊag
 = 1;

129 
öt§c
->
§cbus
 = 
	`pci_bdf_to_bus
(
bdf
);

130 
öt§c
->
§cbusúq
 = (
	`pci_bdf_to_dev
(
bdf
Ë<< 2Ë| (
pö
 - 1);

131 
öt§c
->
d°≠ic
 = 
iﬂpic_id
;

132 
öt§c
->
d°úq
 = 
úq
;

133 
öt§c
++;

136 
úq0_ovîride
 = 
	`romfûe_lﬂdöt
("etc/irq0-override", 0);

137 
i
 = 0; i < 16; i++) {

138 
	`mem£t
(
öt§c
, 0, (*intsrc));

139 i‡(
BUILD_PCI_IRQS
 & (1 << 
i
))

141 
öt§c
->
ty≥
 = 
MPT_TYPE_INTSRC
;

142 
öt§c
->
úqty≥
 = 0;

143 
öt§c
->
úqÊag
 = 0;

144 
öt§c
->
§cbus
 = 
ißbusid
;

145 
öt§c
->
§cbusúq
 = 
i
;

146 
öt§c
->
d°≠ic
 = 
iﬂpic_id
;

147 
öt§c
->
d°úq
 = 
i
;

148 i‡(
úq0_ovîride
) {

151 i‡(
i
 == 0)

152 
öt§c
->
d°úq
 = 2;

153 i‡(
i
 == 2)

154 
öt§c
--;

156 
öt§c
++;

160 
öt§c
->
ty≥
 = 
MPT_TYPE_LOCAL_INT
;

161 
öt§c
->
úqty≥
 = 3;

162 
öt§c
->
úqÊag
 = 0;

163 
öt§c
->
§cbus
 = 
ißbusid
;

164 
öt§c
->
§cbusúq
 = 0;

165 
öt§c
->
d°≠ic
 = 0;

166 
öt§c
->
d°úq
 = 0;

167 
öt§c
++;

169 
öt§c
->
ty≥
 = 
MPT_TYPE_LOCAL_INT
;

170 
öt§c
->
úqty≥
 = 1;

171 
öt§c
->
úqÊag
 = 0;

172 
öt§c
->
§cbus
 = 
ißbusid
;

173 
öt§c
->
§cbusúq
 = 0;

174 
öt§c
->
d°≠ic
 = 0xff;

175 
öt§c
->
d°úq
 = 1;

176 
öt§c
++;

177 
íåycou¡
 +
öt§c
 - 
öt§cs
;

180 
Àngth
 = (*)
öt§c
 - (*)
c⁄fig
;

181 
c⁄fig
->
íåycou¡
 =Éntrycount;

182 
c⁄fig
->
Àngth
 =Üength;

183 
c⁄fig
->
checksum
 -
	`checksum
(c⁄fig, 
Àngth
);

188 
m±abÀ_c⁄fig_s
 *
föÆc⁄fig
 = 
	`mÆloc_f£g
(
Àngth
);

189 
m±abÀ_Êﬂtög_s
 *
Êﬂtög
 = 
	`mÆloc_f£g
((*floating));

190 i‡(!
föÆc⁄fig
 || !
Êﬂtög
) {

191 
	`w¨n_nﬂŒoc
();

192 
	`‰ì
(
c⁄fig
);

193 
	`‰ì
(
föÆc⁄fig
);

194 
	`‰ì
(
Êﬂtög
);

197 
	`mem˝y
(
föÆc⁄fig
, 
c⁄fig
, 
Àngth
);

198 
	`‰ì
(
c⁄fig
);

201 
	`mem£t
(
Êﬂtög
, 0, (*floating));

202 
Êﬂtög
->
sig«tuª
 = 
MPTABLE_SIGNATURE
;

203 
Êﬂtög
->
phyßddr
 = (
u32
)
föÆc⁄fig
;

204 
Êﬂtög
->
Àngth
 = 1;

205 
Êﬂtög
->
•ec_ªv
 = 4;

206 
Êﬂtög
->
checksum
 -
	`checksum
(floating, (*floating));

208 
	`d¥ötf
(1, "MPÅableáddr=%p MPCÅableáddr=%p size=%d\n",

209 
Êﬂtög
, 
föÆc⁄fig
, 
Àngth
);

210 
	}
}

	@fw/mtrr.c

7 
	~"c⁄fig.h
"

8 
	~"hw/pci.h
"

9 
	~"ouçut.h
"

10 
	~"∑øvút.h
"

11 
	~"utû.h
"

12 
	~"x86.h
"

14 
	#MSR_MTRRˇp
 0x000000„

	)

15 
	#MSR_MTRRfix64K_00000
 0x00000250

	)

16 
	#MSR_MTRRfix16K_80000
 0x00000258

	)

17 
	#MSR_MTRRfix16K_A0000
 0x00000259

	)

18 
	#MSR_MTRRfix4K_C0000
 0x00000268

	)

19 
	#MSR_MTRRfix4K_C8000
 0x00000269

	)

20 
	#MSR_MTRRfix4K_D0000
 0x0000026a

	)

21 
	#MSR_MTRRfix4K_D8000
 0x0000026b

	)

22 
	#MSR_MTRRfix4K_E0000
 0x0000026c

	)

23 
	#MSR_MTRRfix4K_E8000
 0x0000026d

	)

24 
	#MSR_MTRRfix4K_F0000
 0x0000026e

	)

25 
	#MSR_MTRRfix4K_F8000
 0x0000026f

	)

26 
	#MSR_MTRRdefTy≥
 0x000002ff

	)

28 
	#MTRRphysBa£_MSR
(
ªg
Ë(0x200 + 2 * (ªg))

	)

29 
	#MTRRphysMask_MSR
(
ªg
Ë(0x200 + 2 * (ªgË+ 1)

	)

31 
	#MTRR_MEMTYPE_UC
 0

	)

32 
	#MTRR_MEMTYPE_WC
 1

	)

33 
	#MTRR_MEMTYPE_WT
 4

	)

34 
	#MTRR_MEMTYPE_WP
 5

	)

35 
	#MTRR_MEMTYPE_WB
 6

	)

37 
	$mår_£tup
()

39 i‡(!
CONFIG_MTRR_INIT
)

42 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
, 
˝uid_„©uªs
;

43 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
˝uid_„©uªs
);

44 i‡(!(
˝uid_„©uªs
 & 
CPUID_MTRR
))

46 i‡(!(
˝uid_„©uªs
 & 
CPUID_MSR
))

49 
	`d¥ötf
(3, "init mtrr\n");

51 
u32
 
mår_ˇp
 = 
	`rdm§
(
MSR_MTRRˇp
);

52 
v˙t
 = 
mår_ˇp
 & 0xff;

53 
fix
 = 
mår_ˇp
 & 0x100;

54 i‡(!
v˙t
 || !
fix
)

58 
	`wrm§_smp
(
MSR_MTRRdefTy≥
, 0);

61 
	uu64b
 {

62 
u8
 
vÆb
[8];

63 
u64
 
vÆ
;

64 } 
u
;

65 
u
.
vÆ
 = 0;

66 
i
;

67 
i
 = 0; i < 8; i++)

68 i‡(
RamSize
 >65536 * (
i
 + 1))

69 
u
.
vÆb
[
i
] = 
MTRR_MEMTYPE_WB
;

70 
	`wrm§_smp
(
MSR_MTRRfix64K_00000
, 
u
.
vÆ
);

71 
u
.
vÆ
 = 0;

72 
i
 = 0; i < 8; i++)

73 i‡(
RamSize
 >0x80000 + 16384 * (
i
 + 1))

74 
u
.
vÆb
[
i
] = 
MTRR_MEMTYPE_WB
;

75 
	`wrm§_smp
(
MSR_MTRRfix16K_80000
, 
u
.
vÆ
);

76 
	`wrm§_smp
(
MSR_MTRRfix16K_A0000
, 0);

77 
j
;

78 
j
 = 0; j < 8; j++) {

79 
u
.
vÆ
 = 0;

80 
i
 = 0; i < 8; i++)

81 i‡(
RamSize
 >0xC0000 + 
j
 * 0x8000 + 4096 * (
i
 + 1))

82 
u
.
vÆb
[
i
] = 
MTRR_MEMTYPE_WP
;

83 
	`wrm§_smp
(
MSR_MTRRfix4K_C0000
 + 
j
, 
u
.
vÆ
);

87 
phys_bôs
 = 36;

88 
	`˝uid
(0x80000000u, &
óx
, &
ebx
, &
ecx
, &
edx
);

89 i‡(
óx
 >= 0x80000008) {

91 
	`˝uid
(0x80000008u, &
óx
, &
ebx
, &
ecx
, &
edx
);

92 
phys_bôs
 = 
óx
 & 0xff;

94 
u64
 
phys_mask
 = ((1uŒ << 
phys_bôs
) - 1);

95 
i
=0; i<
v˙t
; i++) {

96 
	`wrm§_smp
(
	`MTRRphysBa£_MSR
(
i
), 0);

97 
	`wrm§_smp
(
	`MTRRphysMask_MSR
(
i
), 0);

100 
	`wrm§_smp
(
	`MTRRphysBa£_MSR
(0), 
pcimem_°¨t
 | 
MTRR_MEMTYPE_UC
);

101 
	`wrm§_smp
(
	`MTRRphysMask_MSR
(0)

102 , (-((1uŒ<<32)-
pcimem_°¨t
Ë& 
phys_mask
) | 0x800);

105 
	`wrm§_smp
(
MSR_MTRRdefTy≥
, 0xc00 | 
MTRR_MEMTYPE_WB
);

106 
	}
}

	@fw/paravirt.c

11 
	~"byã‹dî.h
"

12 
	~"c⁄fig.h
"

13 
	~"hw/pci.h
"

14 
	~"hw/pci_ªgs.h
"

15 
	~"hw/πc.h
"

16 
	~"mÆloc.h
"

17 
	~"memm≠.h
"

18 
	~"ouçut.h
"

19 
	~"∑øvút.h
"

20 
	~"romfûe.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

23 
	~"x86.h
"

24 
	~"xí.h
"

27 
u32
 
	gRamSize
;

29 
u64
 
	gRamSizeOvî4G
;

31 
Pœtf‹mRu¬ögOn
 
	gVARFSEG
;

36 
	#KVM_CPUID_SIGNATURE
 0x40000000

	)

38 
	$kvm_dëe˘
()

40 
óx
, 
ebx
, 
ecx
, 
edx
;

41 
sig«tuª
[13];

43 
	`˝uid
(
KVM_CPUID_SIGNATURE
, &
óx
, &
ebx
, &
ecx
, &
edx
);

44 
	`mem˝y
(
sig«tuª
 + 0, &
ebx
, 4);

45 
	`mem˝y
(
sig«tuª
 + 4, &
ecx
, 4);

46 
	`mem˝y
(
sig«tuª
 + 8, &
edx
, 4);

47 
sig«tuª
[12] = 0;

49 i‡(
	`°rcmp
(
sig«tuª
, "KVMKVMKVM") == 0) {

50 
	`d¥ötf
(1, "Running on KVM\n");

51 
Pœtf‹mRu¬ögOn
 |
PF_KVM
;

53 
	}
}

55 
	$qemu_dëe˘
()

57 i‡(!
CONFIG_QEMU_HARDWARE
)

61 
u16
 
v
 = 
	`pci_c⁄fig_ªadw
(0, 
PCI_VENDOR_ID
);

62 i‡(
v
 == 0x0000 || v == 0xffff)

64 
u16
 
d
 = 
	`pci_c⁄fig_ªadw
(0, 
PCI_DEVICE_ID
);

65 
u16
 
sv
 = 
	`pci_c⁄fig_ªadw
(0, 
PCI_SUBSYSTEM_VENDOR_ID
);

66 
u16
 
sd
 = 
	`pci_c⁄fig_ªadw
(0, 
PCI_SUBSYSTEM_ID
);

68 i‡(
sv
 != 0x1af4 ||

69 
sd
 != 0x1100)

72 
Pœtf‹mRu¬ögOn
 |
PF_QEMU
;

73 
d
) {

75 
	`d¥ötf
(1, "Running on QEMU (i440fx)\n");

78 
	`d¥ötf
(1, "Running on QEMU (q35)\n");

81 
	`d¥ötf
(1, "Ru¬ög o¿QEMU (unknow¿nb: %04x:%04x)\n", 
v
, 
d
);

84 
	`kvm_dëe˘
();

85 
	}
}

88 
	$qemu_¥eöô
()

90 
	`qemu_dëe˘
();

92 i‡(!
CONFIG_QEMU
)

95 i‡(
	`ru¬ögOnXí
()) {

96 
	`xí_ømsize_¥eöô
();

100 i‡(!
	`ru¬ögOnQEMU
()) {

101 
	`d¥ötf
(1, "Warning: No QEMU Northbridge found (isapc?)\n");

102 
Pœtf‹mRu¬ögOn
 |
PF_QEMU
;

103 
	`kvm_dëe˘
();

107 
u32
 
rs
 = ((
	`πc_ªad
(
CMOS_MEM_EXTMEM2_LOW
) << 16)

108 | (
	`πc_ªad
(
CMOS_MEM_EXTMEM2_HIGH
) << 24));

109 i‡(
rs
)

110 
rs
 += 16 * 1024 * 1024;

112 
rs
 = (((
	`πc_ªad
(
CMOS_MEM_EXTMEM_LOW
) << 10)

113 | (
	`πc_ªad
(
CMOS_MEM_EXTMEM_HIGH
) << 18))

115 
RamSize
 = 
rs
;

116 
	`add_e820
(0, 
rs
, 
E820_RAM
);

119 
	`add_e820
(0xfffc0000, 256*1024, 
E820_RESERVED
);

121 
	`d¥ötf
(1, "RamSize: 0x%08x [cmos]\n", 
RamSize
);

122 
	}
}

125 
	$qemu_∂©f‹m_£tup
()

127 i‡(!
CONFIG_QEMU
)

130 i‡(
	`ru¬ögOnXí
()) {

131 
	`pci_¥obe_devi˚s
();

132 
	`xí_hy≥rˇŒ_£tup
();

133 
	`xí_bio°abÀ_£tup
();

138 
	`pci_£tup
();

139 
	`smm_devi˚_£tup
();

140 
	`smm_£tup
();

143 
	`mår_£tup
();

144 
	`smp_£tup
();

147 
	`púèbÀ_£tup
();

148 
	`m±abÀ_£tup
();

149 
	`smbios_£tup
();

150 
	`a˝i_£tup
();

151 
	}
}

160 
	#QEMU_CFG_SIGNATURE
 0x00

	)

161 
	#QEMU_CFG_ID
 0x01

	)

162 
	#QEMU_CFG_UUID
 0x02

	)

163 
	#QEMU_CFG_NUMA
 0x0d

	)

164 
	#QEMU_CFG_BOOT_MENU
 0x0e

	)

165 
	#QEMU_CFG_MAX_CPUS
 0x0f

	)

166 
	#QEMU_CFG_FILE_DIR
 0x19

	)

167 
	#QEMU_CFG_ARCH_LOCAL
 0x8000

	)

168 
	#QEMU_CFG_ACPI_TABLES
 (
QEMU_CFG_ARCH_LOCAL
 + 0)

	)

169 
	#QEMU_CFG_SMBIOS_ENTRIES
 (
QEMU_CFG_ARCH_LOCAL
 + 1)

	)

170 
	#QEMU_CFG_IRQ0_OVERRIDE
 (
QEMU_CFG_ARCH_LOCAL
 + 2)

	)

171 
	#QEMU_CFG_E820_TABLE
 (
QEMU_CFG_ARCH_LOCAL
 + 3)

	)

174 
	$qemu_cfg_£À˘
(
u16
 
f
)

176 
	`outw
(
f
, 
PORT_QEMU_CFG_CTL
);

177 
	}
}

180 
	$qemu_cfg_ªad
(*
buf
, 
Àn
)

182 
	`ösb
(
PORT_QEMU_CFG_DATA
, 
buf
, 
Àn
);

183 
	}
}

186 
	$qemu_cfg_skù
(
Àn
)

188 
Àn
--)

189 
	`öb
(
PORT_QEMU_CFG_DATA
);

190 
	}
}

193 
	$qemu_cfg_ªad_íåy
(*
buf
, 
e
, 
Àn
)

195 
	`qemu_cfg_£À˘
(
e
);

196 
	`qemu_cfg_ªad
(
buf
, 
Àn
);

197 
	}
}

199 
	sqemu_romfûe_s
 {

200 
romfûe_s
 
	mfûe
;

201 
	m£À˘
, 
	mskù
;

205 
	$qemu_cfg_ªad_fûe
(
romfûe_s
 *
fûe
, *
d°
, 
u32
 
maxÀn
)

207 i‡(
fûe
->
size
 > 
maxÀn
)

209 
qemu_romfûe_s
 *
qfûe
;

210 
qfûe
 = 
	`c⁄èöî_of
(
fûe
, 
qemu_romfûe_s
, file);

211 
	`qemu_cfg_£À˘
(
qfûe
->
£À˘
);

212 
	`qemu_cfg_skù
(
qfûe
->
skù
);

213 
	`qemu_cfg_ªad
(
d°
, 
fûe
->
size
);

214  
fûe
->
size
;

215 
	}
}

218 
	$qemu_romfûe_add
(*
«me
, 
£À˘
, 
skù
, 
size
)

220 
qemu_romfûe_s
 *
qfûe
 = 
	`mÆloc_tmp
((*qfile));

221 i‡(!
qfûe
) {

222 
	`w¨n_nﬂŒoc
();

225 
	`mem£t
(
qfûe
, 0, (*qfile));

226 
	`°π˝y
(
qfûe
->
fûe
.
«me
,Çame, (qfile->file.name));

227 
qfûe
->
fûe
.
size
 = size;

228 
qfûe
->
£À˘
 = select;

229 
qfûe
->
skù
 = skip;

230 
qfûe
->
fûe
.
c›y
 = 
qemu_cfg_ªad_fûe
;

231 
	`romfûe_add
(&
qfûe
->
fûe
);

232 
	}
}

234 
	se820_ª£rv©i⁄
 {

235 
u64
 
	maddªss
;

236 
u64
 
	mÀngth
;

237 
u32
 
	mty≥
;

240 
	#SMBIOS_FIELD_ENTRY
 0

	)

241 
	#SMBIOS_TABLE_ENTRY
 1

	)

243 
	sqemu_smbios_hódî
 {

244 
u16
 
	mÀngth
;

245 
u8
 
	mhódîty≥
;

246 
u8
 
	mèbÀty≥
;

247 
u16
 
	mfõldoff£t
;

248 } 
	gPACKED
;

251 
	$qemu_cfg_e820
()

253 
e820_ª£rv©i⁄
 *
èbÀ
;

254 
i
, 
size
;

256 i‡(!
CONFIG_QEMU
)

260 
èbÀ
 = 
	`romfûe_lﬂdfûe
("ëc/e820", &
size
);

261 i‡(
èbÀ
) {

262 
i
 = 0; i < 
size
 / (
e820_ª£rv©i⁄
); i++) {

263 
èbÀ
[
i
].
ty≥
) {

264 
E820_RAM
:

265 
	`d¥ötf
(1, "RamBlock:áddr 0x%016llxÜen 0x%016llx [e820]\n",

266 
èbÀ
[
i
].
addªss
,ÅabÀ[i].
Àngth
);

267 i‡(
èbÀ
[
i
].
addªss
 < 
RamSize
)

272 i‡(
èbÀ
[
i
].
addªss
 < 0x100000000LL) {

274 i‡(
RamSize
 < 
èbÀ
[
i
].
addªss
 +ÅabÀ[i].
Àngth
)

275 
RamSize
 = 
èbÀ
[
i
].
addªss
 +ÅabÀ[i].
Àngth
;

278 i‡(0x100000000LL + 
RamSizeOvî4G
 < 
èbÀ
[
i
].
addªss
 +ÅabÀ[i].
Àngth
)

279 
RamSizeOvî4G
 = 
èbÀ
[
i
].
addªss
 +ÅabÀ[i].
Àngth
 - 0x100000000LL;

282 
E820_RESERVED
:

283 
	`add_e820
(
èbÀ
[
i
].
addªss
,ÅabÀ[i].
Àngth
,ÅabÀ[i].
ty≥
);

298 
u32
 
cou¡32
;

299 
	`qemu_cfg_ªad_íåy
(&
cou¡32
, 
QEMU_CFG_E820_TABLE
, (count32));

300 i‡(
cou¡32
) {

301 
e820_ª£rv©i⁄
 
íåy
;

302 
i
;

303 
i
 = 0; i < 
cou¡32
; i++) {

304 
	`qemu_cfg_ªad
(&
íåy
, (entry));

305 
	`add_e820
(
íåy
.
addªss
,É¡ry.
Àngth
,É¡ry.
ty≥
);

307 } i‡(
	`ru¬ögOnKVM
()) {

311 
	`add_e820
(0xfffbc000, 4*4096, 
E820_RESERVED
);

315 
u64
 
high
 = ((
	`πc_ªad
(
CMOS_MEM_HIGHMEM_LOW
) << 16)

316 | ((
u32
)
	`πc_ªad
(
CMOS_MEM_HIGHMEM_MID
) << 24)

317 | ((
u64
)
	`πc_ªad
(
CMOS_MEM_HIGHMEM_HIGH
) << 32));

318 
RamSizeOvî4G
 = 
high
;

319 
	`add_e820
(0x100000000uŒ, 
high
, 
E820_RAM
);

320 
	`d¥ötf
(1, "RamSizeOvî4G: 0x%016Œx [cmos]\n", 
RamSizeOvî4G
);

321 
	}
}

326 
	$qemu_cfg_Àgacy
()

328 i‡(!
CONFIG_QEMU
)

332 
	`qemu_romfûe_add
("ëc/show-boŸ-míu", 
QEMU_CFG_BOOT_MENU
, 0, 2);

333 
	`qemu_romfûe_add
("ëc/úq0-ovîride", 
QEMU_CFG_IRQ0_OVERRIDE
, 0, 1);

334 
	`qemu_romfûe_add
("ëc/max-˝us", 
QEMU_CFG_MAX_CPUS
, 0, 2);

337 
u64
 
numacou¡
;

338 
	`qemu_cfg_ªad_íåy
(&
numacou¡
, 
QEMU_CFG_NUMA
, (numacount));

339 
max_˝u
 = 
	`romfûe_lﬂdöt
("etc/max-cpus", 0);

340 
	`qemu_romfûe_add
("ëc/numa-˝u-m≠", 
QEMU_CFG_NUMA
, (
numacou¡
)

341 , 
max_˝u
*(
u64
));

342 
	`qemu_romfûe_add
("ëc/numa-nodes", 
QEMU_CFG_NUMA


343 , (
numacou¡
Ë+ 
max_˝u
*(
u64
)

344 , 
numacou¡
*(
u64
));

347 
«me
[128];

348 
u16
 
˙t
;

349 
	`qemu_cfg_ªad_íåy
(&
˙t
, 
QEMU_CFG_ACPI_TABLES
, (cnt));

350 
i
, 
off£t
 = (
˙t
);

351 
i
 = 0; i < 
˙t
; i++) {

352 
u16
 
Àn
;

353 
	`qemu_cfg_ªad
(&
Àn
, (len));

354 
off£t
 +(
Àn
);

355 
	`¢¥ötf
(
«me
, “ame), "a˝i/èbÀ%d", 
i
);

356 
	`qemu_romfûe_add
(
«me
, 
QEMU_CFG_ACPI_TABLES
, 
off£t
, 
Àn
);

357 
	`qemu_cfg_skù
(
Àn
);

358 
off£t
 +
Àn
;

362 
	`qemu_cfg_ªad_íåy
(&
˙t
, 
QEMU_CFG_SMBIOS_ENTRIES
, (cnt));

363 
off£t
 = (
˙t
);

364 
i
 = 0; i < 
˙t
; i++) {

365 
qemu_smbios_hódî
 
hódî
;

366 
	`qemu_cfg_ªad
(&
hódî
, (header));

367 i‡(
hódî
.
hódîty≥
 =
SMBIOS_FIELD_ENTRY
) {

368 
	`¢¥ötf
(
«me
, (name), "smbios/field%d-%d"

369 , 
hódî
.
èbÀty≥
, hódî.
fõldoff£t
);

370 
	`qemu_romfûe_add
(
«me
, 
QEMU_CFG_SMBIOS_ENTRIES


371 , 
off£t
 + (
hódî
)

372 , 
hódî
.
Àngth
 - (header));

374 
	`¢¥ötf
(
«me
, (name), "smbios/table%d-%d"

375 , 
hódî
.
èbÀty≥
, 
i
);

376 
	`qemu_romfûe_add
(
«me
, 
QEMU_CFG_SMBIOS_ENTRIES


377 , 
off£t
 + 3, 
hódî
.
Àngth
 - 3);

379 
	`qemu_cfg_skù
(
hódî
.
Àngth
 - (header));

380 
off£t
 +
hódî
.
Àngth
;

382 
	}
}

384 
	sQemuCfgFûe
 {

385 
u32
 
	msize
;

386 
u16
 
	m£À˘
;

387 
u16
 
	mª£rved
;

388 
	m«me
[56];

391 
	$qemu_cfg_öô
()

393 i‡(!
	`ru¬ögOnQEMU
())

397 
	`qemu_cfg_£À˘
(
QEMU_CFG_SIGNATURE
);

398 *
sig
 = "QEMU";

399 
i
;

400 
i
 = 0; i < 4; i++)

401 i‡(
	`öb
(
PORT_QEMU_CFG_DATA
Ë!
sig
[
i
])

403 
	`d¥ötf
(1, "Found QEMU fw_cfg\n");

406 
	`qemu_cfg_Àgacy
();

409 
u32
 
cou¡
;

410 
	`qemu_cfg_ªad_íåy
(&
cou¡
, 
QEMU_CFG_FILE_DIR
, (count));

411 
cou¡
 = 
	`be32_to_˝u
(count);

412 
u32
 
e
;

413 
e
 = 0;É < 
cou¡
;É++) {

414 
QemuCfgFûe
 
qfûe
;

415 
	`qemu_cfg_ªad
(&
qfûe
, (qfile));

416 
	`qemu_romfûe_add
(
qfûe
.
«me
, 
	`be16_to_˝u
(qfûe.
£À˘
)

417 , 0, 
	`be32_to_˝u
(
qfûe
.
size
));

420 
	`qemu_cfg_e820
();

421 
	}
}

	@fw/paravirt.h

1 #i‚de‡
__PV_H


2 
	#__PV_H


	)

4 
	~"c⁄fig.h
"

5 
	~"biosv¨.h
"

8 
	#PF_QEMU
 (1<<0)

	)

9 
	#PF_XEN
 (1<<1)

	)

10 
	#PF_KVM
 (1<<2)

	)

12 
u32
 
RamSize
;

13 
u64
 
RamSizeOvî4G
;

14 
Pœtf‹mRu¬ögOn
;

16 
ölöe
 
	$ru¬ögOnQEMU
() {

17  
CONFIG_QEMU
 || (

18 
CONFIG_QEMU_HARDWARE
 && 
	`GET_GLOBAL
(
Pœtf‹mRu¬ögOn
Ë& 
PF_QEMU
);

19 
	}
}

20 
ölöe
 
	$ru¬ögOnXí
() {

21  
CONFIG_XEN
 && 
	`GET_GLOBAL
(
Pœtf‹mRu¬ögOn
Ë& 
PF_XEN
;

22 
	}
}

23 
ölöe
 
	$ru¬ögOnKVM
() {

24  
CONFIG_QEMU
 && 
	`GET_GLOBAL
(
Pœtf‹mRu¬ögOn
Ë& 
PF_KVM
;

25 
	}
}

28 
	#PORT_SMI_CMD
 0x00b2

	)

29 
	#PORT_SMI_STATUS
 0x00b3

	)

30 
	#PORT_QEMU_CFG_CTL
 0x0510

	)

31 
	#PORT_QEMU_CFG_DATA
 0x0511

	)

32 
	#PORT_ACPI_PM_BASE
 0xb000

	)

33 
	#PORT_SMB_BASE
 0xb100

	)

34 
	#PORT_BIOS_APM
 0x8900

	)

36 
qemu_¥eöô
();

37 
qemu_∂©f‹m_£tup
();

38 
qemu_cfg_öô
();

	@fw/pciinit.c

8 
	~"byã‹dî.h
"

9 
	~"c⁄fig.h
"

10 
	~"dev-q35.h
"

11 
	~"hw/©a.h
"

12 
	~"hw/pci.h
"

13 
	~"hw/pci_ids.h
"

14 
	~"hw/pci_ªgs.h
"

15 
	~"li°.h
"

16 
	~"mÆloc.h
"

17 
	~"memm≠.h
"

18 
	~"ouçut.h
"

19 
	~"∑øvút.h
"

20 
	~"romfûe.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

23 
	~"x86.h
"

25 
	#PCI_DEVICE_MEM_MIN
 (1<<12)

26 
	#PCI_BRIDGE_MEM_MIN
 (1<<21)

27 
	#PCI_BRIDGE_IO_MIN
 0x1000

28 

	)

29 
	epci_ªgi⁄_ty≥
 {

30 
	mPCI_REGION_TYPE_IO
,

31 
	mPCI_REGION_TYPE_MEM
,

32 
	mPCI_REGION_TYPE_PREFMEM
,

33 
	mPCI_REGION_TYPE_COUNT
,

36 c⁄° *
	gªgi⁄_ty≥_«me
[] = {

37 [ 
PCI_REGION_TYPE_IO
 ] = "io",

38 [ 
PCI_REGION_TYPE_MEM
 ] = "mem",

39 [ 
PCI_REGION_TYPE_PREFMEM
 ] = "prefmem",

42 
u64
 
	gpcimem_°¨t
 = 
BUILD_PCIMEM_START
;

43 
u64
 
	gpcimem_íd
 = 
BUILD_PCIMEM_END
;

44 
u64
 
	gpcimem64_°¨t
 = 
BUILD_PCIMEM64_START
;

45 
u64
 
	gpcimem64_íd
 = 
BUILD_PCIMEM64_END
;

47 
	spci_ªgi⁄_íåy
 {

48 
pci_devi˚
 *
	mdev
;

49 
	mb¨
;

50 
u64
 
	msize
;

51 
u64
 
	mÆign
;

52 
	mis64
;

53 
pci_ªgi⁄_ty≥
 
	mty≥
;

54 
hli°_node
 
	mnode
;

57 
	spci_ªgi⁄
 {

59 
u64
 
	mba£
;

60 
hli°_hód
 
	mli°
;

63 
	spci_bus
 {

64 
pci_ªgi⁄
 
	mr
[
PCI_REGION_TYPE_COUNT
];

65 
pci_devi˚
 *
	mbus_dev
;

68 
u32
 
	$pci_b¨
(
pci_devi˚
 *
pci
, 
ªgi⁄_num
)

70 i‡(
ªgi⁄_num
 !
PCI_ROM_SLOT
) {

71  
PCI_BASE_ADDRESS_0
 + 
ªgi⁄_num
 * 4;

74 
	#PCI_HEADER_TYPE_MULTI_FUNCTION
 0x80

	)

75 
u8
 
ty≥
 = 
pci
->
hódî_ty≥
 & ~
PCI_HEADER_TYPE_MULTI_FUNCTION
;

76  
ty≥
 =
PCI_HEADER_TYPE_BRIDGE
 ? 
PCI_ROM_ADDRESS1
 : 
PCI_ROM_ADDRESS
;

77 
	}
}

80 
	$pci_£t_io_ªgi⁄_addr
(
pci_devi˚
 *
pci
, 
b¨
, 
u64
 
addr
, 
is64
)

82 
u32
 
ofs
 = 
	`pci_b¨
(
pci
, 
b¨
);

83 
	`pci_c⁄fig_wrôñ
(
pci
->
bdf
, 
ofs
, 
addr
);

84 i‡(
is64
)

85 
	`pci_c⁄fig_wrôñ
(
pci
->
bdf
, 
ofs
 + 4, 
addr
 >> 32);

86 
	}
}

94 c⁄° 
u8
 
	gpci_úqs
[4] = {

98 
	$dummy_pci_¶Ÿ_gë_úq
(
pci_devi˚
 *
pci
, 
pö
)

100 
	`d¥ötf
(1, "pci_slot_get_irq called with unknownÑouting\n");

103 
	}
}

105 (*
pci_¶Ÿ_gë_úq
)(
pci_devi˚
 *
pci
, 
pö
) =

106 
dummy_pci_¶Ÿ_gë_úq
;

109 
	$piix_pci_¶Ÿ_gë_úq
(
pci_devi˚
 *
pci
, 
pö
)

111 
¶Ÿ_addíd
 = 0;

113 
pci
->
∑ª¡
 !
NULL
) {

114 
¶Ÿ_addíd
 +
	`pci_bdf_to_dev
(
pci
->
bdf
);

115 
pci
 =Öci->
∑ª¡
;

117 
¶Ÿ_addíd
 +
	`pci_bdf_to_dev
(
pci
->
bdf
) - 1;

118  
pci_úqs
[(
pö
 - 1 + 
¶Ÿ_addíd
) & 3];

119 
	}
}

121 
	$mch_pci_¶Ÿ_gë_úq
(
pci_devi˚
 *
pci
, 
pö
)

123 
úq
, 
¶Ÿ
, 
pö_addíd
 = 0;

125 
pci
->
∑ª¡
 !
NULL
) {

126 
pö_addíd
 +
	`pci_bdf_to_dev
(
pci
->
bdf
);

127 
pci
 =Öci->
∑ª¡
;

129 
¶Ÿ
 = 
	`pci_bdf_to_dev
(
pci
->
bdf
);

131 
¶Ÿ
) {

135 
úq
 = 
pci_úqs
[(
pö
 - 1 + 
pö_addíd
 + 
¶Ÿ
) & 3];

139 
úq
 = 
pci_úqs
[(
pö
 - 1 + 
pö_addíd
) & 3];

143  
úq
;

144 
	}
}

147 
	$piix_iß_bridge_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

149 
i
, 
úq
;

150 
u8
 
ñ¸
[2];

152 
ñ¸
[0] = 0x00;

153 
ñ¸
[1] = 0x00;

154 
i
 = 0; i < 4; i++) {

155 
úq
 = 
pci_úqs
[
i
];

157 
ñ¸
[
úq
 >> 3] |= (1 << (irq & 7));

159 
	`pci_c⁄fig_wrôeb
(
pci
->
bdf
, 0x60 + 
i
, 
úq
);

161 
	`outb
(
ñ¸
[0], 0x4d0);

162 
	`outb
(
ñ¸
[1], 0x4d1);

163 
	`d¥ötf
(1, "PIIX3/PIIX4 inô:Él¸=%02x %02x\n", 
ñ¸
[0],Élcr[1]);

164 
	}
}

168 
	$mch_iß_bridge_£tup
(
pci_devi˚
 *
dev
, *
¨g
)

170 
u16
 
bdf
 = 
dev
->bdf;

171 
i
, 
úq
;

172 
u8
 
ñ¸
[2];

174 
ñ¸
[0] = 0x00;

175 
ñ¸
[1] = 0x00;

177 
i
 = 0; i < 4; i++) {

178 
úq
 = 
pci_úqs
[
i
];

180 
ñ¸
[
úq
 >> 3] |= (1 << (irq & 7));

185 
	`pci_c⁄fig_wrôeb
(
bdf
, 
ICH9_LPC_PIRQA_ROUT
 + 
i
, 
úq
);

187 
	`pci_c⁄fig_wrôeb
(
bdf
, 
ICH9_LPC_PIRQE_ROUT
 + 
i
, 
úq
);

189 
	`outb
(
ñ¸
[0], 
ICH9_LPC_PORT_ELCR1
);

190 
	`outb
(
ñ¸
[1], 
ICH9_LPC_PORT_ELCR2
);

191 
	`d¥ötf
(1, "Q35 LPC inô:Él¸=%02x %02x\n", 
ñ¸
[0],Élcr[1]);

194 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ICH9_LPC_PMBASE
,

195 
PORT_ACPI_PM_BASE
 | 
ICH9_LPC_PMBASE_RTE
);

198 
	`pci_c⁄fig_wrôeb
(
bdf
, 
ICH9_LPC_ACPI_CTRL
, 
ICH9_LPC_ACPI_CTRL_ACPI_EN
);

200 
a˝i_pm1a_˙t
 = 
PORT_ACPI_PM_BASE
 + 0x04;

201 
	`pmtimî_£tup
(
PORT_ACPI_PM_BASE
 + 0x08);

202 
	}
}

204 
	$°‹age_ide_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

207 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 0, 
PORT_ATA1_CMD_BASE
, 0);

208 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 1, 
PORT_ATA1_CTRL_BASE
, 0);

209 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 2, 
PORT_ATA2_CMD_BASE
, 0);

210 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 3, 
PORT_ATA2_CTRL_BASE
, 0);

211 
	}
}

214 
	$piix_ide_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

216 
u16
 
bdf
 = 
pci
->bdf;

217 
	`pci_c⁄fig_wrôew
(
bdf
, 0x40, 0x8000);

218 
	`pci_c⁄fig_wrôew
(
bdf
, 0x42, 0x8000);

219 
	}
}

221 
	$pic_ibm_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

224 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 0, 0x80800000 + 0x00040000, 0);

225 
	}
}

227 
	$≠∂e_macio_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

230 
	`pci_£t_io_ªgi⁄_addr
(
pci
, 0, 0x80800000, 0);

231 
	}
}

233 
	$piix4_pm_c⁄fig_£tup
(
u16
 
bdf
)

236 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_INTERRUPT_LINE
, 9);

238 
	`pci_c⁄fig_wrôñ
(
bdf
, 0x40, 
PORT_ACPI_PM_BASE
 | 1);

239 
	`pci_c⁄fig_wrôeb
(
bdf
, 0x80, 0x01);

240 
	`pci_c⁄fig_wrôñ
(
bdf
, 0x90, 
PORT_SMB_BASE
 | 1);

241 
	`pci_c⁄fig_wrôeb
(
bdf
, 0xd2, 0x09);

242 
	}
}

244 
	gPiixPmBDF
 = -1;

247 
	$piix4_pm_£tup
(
pci_devi˚
 *
pci
, *
¨g
)

249 
PiixPmBDF
 = 
pci
->
bdf
;

250 
	`piix4_pm_c⁄fig_£tup
(
pci
->
bdf
);

252 
a˝i_pm1a_˙t
 = 
PORT_ACPI_PM_BASE
 + 0x04;

253 
	`pmtimî_£tup
(
PORT_ACPI_PM_BASE
 + 0x08);

254 
	}
}

258 
	$ich9_smbus_£tup
(
pci_devi˚
 *
dev
, *
¨g
)

260 
u16
 
bdf
 = 
dev
->bdf;

262 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ICH9_SMB_SMB_BASE
,

263 
PORT_SMB_BASE
 | 
PCI_BASE_ADDRESS_SPACE_IO
);

266 
	`pci_c⁄fig_wrôeb
(
bdf
, 
ICH9_SMB_HOSTC
, 
ICH9_SMB_HOSTC_HST_EN
);

267 
	}
}

269 c⁄° 
pci_devi˚_id
 
	gpci_devi˚_tbl
[] = {

271 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371SB_0
,

272 
piix_iß_bridge_£tup
),

273 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB_0
,

274 
piix_iß_bridge_£tup
),

275 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_LPC
,

276 
mch_iß_bridge_£tup
),

279 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371SB_1
,

280 
PCI_CLASS_STORAGE_IDE
, 
piix_ide_£tup
),

281 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB
,

282 
PCI_CLASS_STORAGE_IDE
, 
piix_ide_£tup
),

283 
PCI_DEVICE_CLASS
(
PCI_ANY_ID
, PCI_ANY_ID, 
PCI_CLASS_STORAGE_IDE
,

284 
°‹age_ide_£tup
),

287 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_IBM
, 0x0046, 
PCI_CLASS_SYSTEM_PIC
,

288 
pic_ibm_£tup
),

289 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_IBM
, 0xFFFF, 
PCI_CLASS_SYSTEM_PIC
,

290 
pic_ibm_£tup
),

293 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB_3
,

294 
piix4_pm_£tup
),

295 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_SMBUS
,

296 
ich9_smbus_£tup
),

299 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_APPLE
, 0x0017, 0xff00, 
≠∂e_macio_£tup
),

300 
PCI_DEVICE_CLASS
(
PCI_VENDOR_ID_APPLE
, 0x0022, 0xff00, 
≠∂e_macio_£tup
),

302 
PCI_DEVICE_END
,

305 
	$pci_ªsume
()

307 i‡(!
CONFIG_QEMU
) {

311 i‡(
PiixPmBDF
 >= 0) {

312 
	`piix4_pm_c⁄fig_£tup
(
PiixPmBDF
);

314 
	}
}

316 
	$pci_bios_öô_devi˚
(
pci_devi˚
 *
pci
)

318 
u16
 
bdf
 = 
pci
->bdf;

319 
	`d¥ötf
(1, "PCI: init bdf=%02x:%02x.%x id=%04x:%04x\n"

320 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf), 
	`pci_bdf_to_‚
(bdf)

321 , 
pci
->
víd‹
,Öci->
devi˚
);

324 
pö
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_INTERRUPT_PIN
);

325 i‡(
pö
 != 0)

326 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_INTERRUPT_LINE
, 
	`pci_¶Ÿ_gë_úq
(
pci
, 
pö
));

328 
	`pci_öô_devi˚
(
pci_devi˚_tbl
, 
pci
, 
NULL
);

331 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0,

332 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_SERR
);

333 
	}
}

335 
	$pci_bios_öô_devi˚s
()

337 
pci_devi˚
 *
pci
;

338 
	`f‹óchpci
(
pci
) {

339 
	`pci_bios_öô_devi˚
(
pci
);

341 
	}
}

343 
	$pci_íabÀ_deÁu…_vga
()

345 
pci_devi˚
 *
pci
;

347 
	`f‹óchpci
(
pci
) {

348 i‡(
	`is_pci_vga
(
pci
)) {

349 
	`d¥ötf
(1, "PCI: Using %02x:%02x.%x forÖrimary VGA\n",

350 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

351 
	`pci_bdf_to_‚
(
pci
->
bdf
));

356 
pci
 = 
	`pci_föd_˛ass
(
PCI_CLASS_DISPLAY_VGA
);

357 i‡(!
pci
) {

358 
	`d¥ötf
(1, "PCI: No VGA devices found\n");

362 
	`d¥ötf
(1, "PCI: Enabling %02x:%02x.%x forÖrimary VGA\n",

363 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

364 
	`pci_bdf_to_‚
(
pci
->
bdf
));

366 
	`pci_c⁄fig_maskw
(
pci
->
bdf
, 
PCI_COMMAND
, 0,

367 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
);

369 
pci
->
∑ª¡
) {

370 
pci
 =Öci->
∑ª¡
;

372 
	`d¥ötf
(1, "PCI: Setting VGAÉnable on bridge %02x:%02x.%x\n",

373 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

374 
	`pci_bdf_to_‚
(
pci
->
bdf
));

376 
	`pci_c⁄fig_maskw
(
pci
->
bdf
, 
PCI_BRIDGE_CONTROL
, 0, 
PCI_BRIDGE_CTL_VGA
);

377 
	`pci_c⁄fig_maskw
(
pci
->
bdf
, 
PCI_COMMAND
, 0,

378 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
);

380 
	}
}

386 
	$i440fx_mem_addr_£tup
(
pci_devi˚
 *
dev
, *
¨g
)

388 i‡(
RamSize
 <= 0x80000000)

389 
pcimem_°¨t
 = 0x80000000;

390 i‡(
RamSize
 <= 0xc0000000)

391 
pcimem_°¨t
 = 0xc0000000;

393 
pci_¶Ÿ_gë_úq
 = 
piix_pci_¶Ÿ_gë_úq
;

394 
	}
}

396 
	$mch_mem_addr_£tup
(
pci_devi˚
 *
dev
, *
¨g
)

398 
u64
 
addr
 = 
Q35_HOST_BRIDGE_PCIEXBAR_ADDR
;

399 
u32
 
size
 = 
Q35_HOST_BRIDGE_PCIEXBAR_SIZE
;

402 
u16
 
bdf
 = 
dev
->bdf;

403 
u32
 
uµî
 = 
addr
 >> 32;

404 
u32
 
lowî
 = (
addr
 & 0xffffffffË| 
Q35_HOST_BRIDGE_PCIEXBAREN
;

405 
	`pci_c⁄fig_wrôñ
(
bdf
, 
Q35_HOST_BRIDGE_PCIEXBAR
, 0);

406 
	`pci_c⁄fig_wrôñ
(
bdf
, 
Q35_HOST_BRIDGE_PCIEXBAR
 + 4, 
uµî
);

407 
	`pci_c⁄fig_wrôñ
(
bdf
, 
Q35_HOST_BRIDGE_PCIEXBAR
, 
lowî
);

408 
	`add_e820
(
addr
, 
size
, 
E820_RESERVED
);

411 
pcimem_°¨t
 = 
addr
 + 
size
;

413 
pci_¶Ÿ_gë_úq
 = 
mch_pci_¶Ÿ_gë_úq
;

414 
	}
}

416 c⁄° 
pci_devi˚_id
 
	gpci_∂©f‹m_tbl
[] = {

417 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82441
,

418 
i440fx_mem_addr_£tup
),

419 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_Q35_MCH
,

420 
mch_mem_addr_£tup
),

421 
PCI_DEVICE_END


424 
	$pci_bios_öô_∂©f‹m
()

426 
pci_devi˚
 *
pci
;

427 
	`f‹óchpci
(
pci
) {

428 
	`pci_öô_devi˚
(
pci_∂©f‹m_tbl
, 
pci
, 
NULL
);

430 
	}
}

438 
	$pci_bios_öô_bus_ªc
(
bus
, 
u8
 *
pci_bus
)

440 
bdf
;

441 
u16
 
˛ass
;

443 
	`d¥ötf
(1, "PCI: %†bu†0x%x\n", 
__func__
, 
bus
);

446 
	`f‹óchbdf
(
bdf
, 
bus
) {

447 
˛ass
 = 
	`pci_c⁄fig_ªadw
(
bdf
, 
PCI_CLASS_DEVICE
);

448 i‡(
˛ass
 =
PCI_CLASS_BRIDGE_PCI
) {

449 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_SECONDARY_BUS
, 255);

450 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_SUBORDINATE_BUS
, 0);

454 
	`f‹óchbdf
(
bdf
, 
bus
) {

455 
˛ass
 = 
	`pci_c⁄fig_ªadw
(
bdf
, 
PCI_CLASS_DEVICE
);

456 i‡(
˛ass
 !
PCI_CLASS_BRIDGE_PCI
) {

459 
	`d¥ötf
(1, "PCI: %†bd‡0x%x\n", 
__func__
, 
bdf
);

461 
u8
 
¥ibus
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_PRIMARY_BUS
);

462 i‡(
¥ibus
 !
bus
) {

463 
	`d¥ötf
(1, "PCI:Örim¨y bu†0x%x -> 0x%x\n", 
¥ibus
, 
bus
);

464 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_PRIMARY_BUS
, 
bus
);

466 
	`d¥ötf
(1, "PCI:Örim¨y bu†0x%x\n", 
¥ibus
);

469 
u8
 
£cbus
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_SECONDARY_BUS
);

470 (*
pci_bus
)++;

471 i‡(*
pci_bus
 !
£cbus
) {

472 
	`d¥ötf
(1, "PCI: secondary bus = 0x%x -> 0x%x\n",

473 
£cbus
, *
pci_bus
);

474 
£cbus
 = *
pci_bus
;

475 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_SECONDARY_BUS
, 
£cbus
);

477 
	`d¥ötf
(1, "PCI: sec⁄d¨y bu†0x%x\n", 
£cbus
);

482 
u8
 
subbus
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_SUBORDINATE_BUS
);

483 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_SUBORDINATE_BUS
, 255);

485 
	`pci_bios_öô_bus_ªc
(
£cbus
, 
pci_bus
);

487 i‡(
subbus
 !*
pci_bus
) {

488 
	`d¥ötf
(1, "PCI: subordinate bus = 0x%x -> 0x%x\n",

489 
subbus
, *
pci_bus
);

490 
subbus
 = *
pci_bus
;

492 
	`d¥ötf
(1, "PCI: sub‹dö©êbu†0x%x\n", 
subbus
);

494 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_SUBORDINATE_BUS
, 
subbus
);

496 
	}
}

499 
	$pci_bios_öô_bus
()

501 
u8
 
pci_bus
 = 0;

502 
	`pci_bios_öô_bus_ªc
(0 , &
pci_bus
);

503 
	}
}

511 
	$pci_bios_gë_b¨
(
pci_devi˚
 *
pci
, 
b¨
,

512 *
±y≥
, 
u64
 *
psize
, *
pis64
)

514 
u32
 
ofs
 = 
	`pci_b¨
(
pci
, 
b¨
);

515 
u16
 
bdf
 = 
pci
->bdf;

516 
u32
 
ﬁd
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
ofs
);

517 
is64
 = 0, 
ty≥
 = 
PCI_REGION_TYPE_MEM
;

518 
u64
 
mask
;

520 i‡(
b¨
 =
PCI_ROM_SLOT
) {

521 
mask
 = 
PCI_ROM_ADDRESS_MASK
;

522 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ofs
, 
mask
);

524 i‡(
ﬁd
 & 
PCI_BASE_ADDRESS_SPACE_IO
) {

525 
mask
 = 
PCI_BASE_ADDRESS_IO_MASK
;

526 
ty≥
 = 
PCI_REGION_TYPE_IO
;

528 
mask
 = 
PCI_BASE_ADDRESS_MEM_MASK
;

529 i‡(
ﬁd
 & 
PCI_BASE_ADDRESS_MEM_PREFETCH
)

530 
ty≥
 = 
PCI_REGION_TYPE_PREFMEM
;

531 
is64
 = ((
ﬁd
 & 
PCI_BASE_ADDRESS_MEM_TYPE_MASK
)

532 =
PCI_BASE_ADDRESS_MEM_TYPE_64
);

534 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ofs
, ~0);

536 
u64
 
vÆ
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
ofs
);

537 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ofs
, 
ﬁd
);

538 i‡(
is64
) {

539 
u32
 
hﬁd
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
ofs
 + 4);

540 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ofs
 + 4, ~0);

541 
u32
 
high
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
ofs
 + 4);

542 
	`pci_c⁄fig_wrôñ
(
bdf
, 
ofs
 + 4, 
hﬁd
);

543 
vÆ
 |((
u64
)
high
 << 32);

544 
mask
 |((
u64
)0xffffffff << 32);

545 *
psize
 = (~(
vÆ
 & 
mask
)) + 1;

547 *
psize
 = ((~(
vÆ
 & 
mask
)) + 1) & 0xffffffff;

549 *
±y≥
 = 
ty≥
;

550 *
pis64
 = 
is64
;

551 
	}
}

553 
	$pci_bios_bridge_ªgi⁄_is64
(
pci_ªgi⁄
 *
r
,

554 
pci_devi˚
 *
pci
, 
ty≥
)

556 i‡(
ty≥
 !
PCI_REGION_TYPE_PREFMEM
)

558 
u32
 
pmem
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_PREF_MEMORY_BASE
);

559 i‡(!
pmem
) {

560 
	`pci_c⁄fig_wrôñ
(
pci
->
bdf
, 
PCI_PREF_MEMORY_BASE
, 0xfff0fff0);

561 
pmem
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_PREF_MEMORY_BASE
);

562 
	`pci_c⁄fig_wrôñ
(
pci
->
bdf
, 
PCI_PREF_MEMORY_BASE
, 0x0);

564 i‡((
pmem
 & 
PCI_PREF_RANGE_TYPE_MASK
Ë!
PCI_PREF_RANGE_TYPE_64
)

566 
pci_ªgi⁄_íåy
 *
íåy
;

567 
	`hli°_f‹_óch_íåy
(
íåy
, &
r
->
li°
, 
node
) {

568 i‡(!
íåy
->
is64
)

572 
	}
}

574 
u64
 
	$pci_ªgi⁄_Æign
(
pci_ªgi⁄
 *
r
)

576 
pci_ªgi⁄_íåy
 *
íåy
;

577 
	`hli°_f‹_óch_íåy
(
íåy
, &
r
->
li°
, 
node
) {

579  
íåy
->
Æign
;

582 
	}
}

584 
u64
 
	$pci_ªgi⁄_sum
(
pci_ªgi⁄
 *
r
)

586 
u64
 
sum
 = 0;

587 
pci_ªgi⁄_íåy
 *
íåy
;

588 
	`hli°_f‹_óch_íåy
(
íåy
, &
r
->
li°
, 
node
) {

589 
sum
 +
íåy
->
size
;

591  
sum
;

592 
	}
}

594 
	$pci_ªgi⁄_migøã_64bô_íåõs
(
pci_ªgi⁄
 *
‰om
,

595 
pci_ªgi⁄
 *
to
)

597 
hli°_node
 *
n
, **
œ°
 = &
to
->
li°
.
fú°
;

598 
pci_ªgi⁄_íåy
 *
íåy
;

599 
	`hli°_f‹_óch_íåy_ß„
(
íåy
, 
n
, &
‰om
->
li°
, 
node
) {

600 i‡(!
íåy
->
is64
)

602 i‡(
íåy
->
dev
->
˛ass
 =
PCI_CLASS_SERIAL_USB
)

605 
	`hli°_dñ
(&
íåy
->
node
);

606 
	`hli°_add
(&
íåy
->
node
, 
œ°
);

607 
œ°
 = &
íåy
->
node
.
√xt
;

609 
	}
}

611 
pci_ªgi⁄_íåy
 *

612 
	$pci_ªgi⁄_¸óã_íåy
(
pci_bus
 *
bus
, 
pci_devi˚
 *
dev
,

613 
b¨
, 
u64
 
size
, u64 
Æign
, 
ty≥
, 
is64
)

615 
pci_ªgi⁄_íåy
 *
íåy
 = 
	`mÆloc_tmp
((*entry));

616 i‡(!
íåy
) {

617 
	`w¨n_nﬂŒoc
();

618  
NULL
;

620 
	`mem£t
(
íåy
, 0, (*entry));

621 
íåy
->
dev
 = dev;

622 
íåy
->
b¨
 = bar;

623 
íåy
->
size
 = size;

624 
íåy
->
Æign
 =álign;

625 
íåy
->
is64
 = is64;

626 
íåy
->
ty≥
 =Åype;

628 
hli°_node
 **
µªv
;

629 
pci_ªgi⁄_íåy
 *
pos
;

630 
	`hli°_f‹_óch_íåy_µªv
(
pos
, 
µªv
, &
bus
->
r
[
ty≥
].
li°
, 
node
) {

631 i‡(
pos
->
Æign
 <álig¿|| (pos->Æig¿=Æig¿&&Öos->
size
 < size))

634 
	`hli°_add
(&
íåy
->
node
, 
µªv
);

635  
íåy
;

636 
	}
}

638 
	$pci_bios_check_devi˚s
(
pci_bus
 *
bus£s
)

640 
	`d¥ötf
(1, "PCI: check devices\n");

643 
pci_devi˚
 *
pci
;

644 
	`f‹óchpci
(
pci
) {

645 i‡(
pci
->
˛ass
 =
PCI_CLASS_BRIDGE_PCI
)

646 
bus£s
[
pci
->
£c⁄d¨y_bus
].
bus_dev
 =Öci;

648 
pci_bus
 *
bus
 = &
bus£s
[
	`pci_bdf_to_bus
(
pci
->
bdf
)];

649 
i
;

650 
i
 = 0; i < 
PCI_NUM_REGIONS
; i++) {

651 i‡((
pci
->
˛ass
 =
PCI_CLASS_BRIDGE_PCI
) &&

652 (
i
 >
PCI_BRIDGE_NUM_REGIONS
 && i < 
PCI_ROM_SLOT
))

654 
ty≥
, 
is64
;

655 
u64
 
size
;

656 
	`pci_bios_gë_b¨
(
pci
, 
i
, &
ty≥
, &
size
, &
is64
);

657 i‡(
size
 == 0)

660 i‡(
ty≥
 !
PCI_REGION_TYPE_IO
 && 
size
 < 
PCI_DEVICE_MEM_MIN
)

661 
size
 = 
PCI_DEVICE_MEM_MIN
;

662 
pci_ªgi⁄_íåy
 *
íåy
 = 
	`pci_ªgi⁄_¸óã_íåy
(

663 
bus
, 
pci
, 
i
, 
size
, size, 
ty≥
, 
is64
);

664 i‡(!
íåy
)

667 i‡(
is64
)

668 
i
++;

673 
£c⁄d¨y_bus
;

674 
£c⁄d¨y_bus
=
MaxPCIBus
; secondary_bus>0; secondary_bus--) {

675 
pci_bus
 *
s
 = &
bus£s
[
£c⁄d¨y_bus
];

676 i‡(!
s
->
bus_dev
)

678 
pci_bus
 *
∑ª¡
 = &
bus£s
[
	`pci_bdf_to_bus
(
s
->
bus_dev
->
bdf
)];

679 
ty≥
;

680 
ty≥
 = 0;Åy≥ < 
PCI_REGION_TYPE_COUNT
;Åype++) {

681 
u64
 
Æign
 = (
ty≥
 =
PCI_REGION_TYPE_IO
) ?

682 
PCI_BRIDGE_IO_MIN
 : 
PCI_BRIDGE_MEM_MIN
;

683 i‡(
	`pci_ªgi⁄_Æign
(&
s
->
r
[
ty≥
]Ë> 
Æign
)

684 
Æign
 = 
	`pci_ªgi⁄_Æign
(&
s
->
r
[
ty≥
]);

685 
u64
 
sum
 = 
	`pci_ªgi⁄_sum
(&
s
->
r
[
ty≥
]);

686 
u64
 
size
 = 
	`ALIGN
(
sum
, 
Æign
);

687 
is64
 = 
	`pci_bios_bridge_ªgi⁄_is64
(&
s
->
r
[
ty≥
],

688 
s
->
bus_dev
, 
ty≥
);

690 
pci_ªgi⁄_íåy
 *
íåy
 = 
	`pci_ªgi⁄_¸óã_íåy
(

691 
∑ª¡
, 
s
->
bus_dev
, -1, 
size
, 
Æign
, 
ty≥
, 
is64
);

692 i‡(!
íåy
)

694 
	`d¥ötf
(1, "PCI: secondary bus %d size %08llxÅype %s\n",

695 
íåy
->
dev
->
£c⁄d¨y_bus
, 
size
,

696 
ªgi⁄_ty≥_«me
[
íåy
->
ty≥
]);

700 
	}
}

708 
	$pci_bios_öô_roŸ_ªgi⁄s_io
(
pci_bus
 *
bus
)

721 
pci_ªgi⁄
 *
r_io
 = &
bus
->
r
[
PCI_REGION_TYPE_IO
];

722 
u64
 
sum
 = 
	`pci_ªgi⁄_sum
(
r_io
);

723 i‡(
sum
 < 0x4000) {

725 
r_io
->
ba£
 = 0xc000;

726 } i‡(
sum
 < 0x9000) {

728 
r_io
->
ba£
 = 0x1000;

738 
	`d¥ötf
(1, "PCI: IO: %4Œx - %4Œx\n", 
r_io
->
ba£
,Ñ_io->ba£ + 
sum
 - 1);

740 
	}
}

742 
	$pci_bios_öô_roŸ_ªgi⁄s_mem
(
pci_bus
 *
bus
)

744 
pci_ªgi⁄
 *
r_íd
 = &
bus
->
r
[
PCI_REGION_TYPE_PREFMEM
];

745 
pci_ªgi⁄
 *
r_°¨t
 = &
bus
->
r
[
PCI_REGION_TYPE_MEM
];

747 i‡(
	`pci_ªgi⁄_Æign
(
r_°¨t
Ë<Öci_ªgi⁄_Æign(
r_íd
)) {

749 
r_íd
 = 
r_°¨t
;

750 
r_°¨t
 = &
bus
->
r
[
PCI_REGION_TYPE_PREFMEM
];

752 
u64
 
sum
 = 
	`pci_ªgi⁄_sum
(
r_íd
);

753 
u64
 
Æign
 = 
	`pci_ªgi⁄_Æign
(
r_íd
);

754 
r_íd
->
ba£
 = 
	`ALIGN_DOWN
((
pcimem_íd
 - 
sum
), 
Æign
);

755 
sum
 = 
	`pci_ªgi⁄_sum
(
r_°¨t
);

756 
Æign
 = 
	`pci_ªgi⁄_Æign
(
r_°¨t
);

757 
r_°¨t
->
ba£
 = 
	`ALIGN_DOWN
((
r_íd
->ba£ - 
sum
), 
Æign
);

759 i‡((
r_°¨t
->
ba£
 < 
pcimem_°¨t
) ||

760 (
r_°¨t
->
ba£
 > 
pcimem_íd
))

764 
	}
}

766 
	#PCI_IO_SHIFT
 8

	)

767 
	#PCI_MEMORY_SHIFT
 16

	)

768 
	#PCI_PREF_MEMORY_SHIFT
 16

	)

771 
	$pci_ªgi⁄_m≠_⁄e_íåy
(
pci_ªgi⁄_íåy
 *
íåy
, 
u64
 
addr
)

773 
u16
 
bdf
 = 
íåy
->
dev
->bdf;

774 i‡(
íåy
->
b¨
 >= 0) {

775 
	`d¥ötf
(1, "PCI: map device bdf=%02x:%02x.%x"

777 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf), 
	`pci_bdf_to_‚
(bdf),

778 
íåy
->
b¨
, 
addr
,É¡ry->
size
, 
ªgi⁄_ty≥_«me
[íåy->
ty≥
]);

780 
	`pci_£t_io_ªgi⁄_addr
(
íåy
->
dev
,É¡ry->
b¨
, 
addr
,É¡ry->
is64
);

784 
u64
 
limô
 = 
addr
 + 
íåy
->
size
 - 1;

785 i‡(
íåy
->
ty≥
 =
PCI_REGION_TYPE_IO
) {

786 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_IO_BASE
, 
addr
 >> 
PCI_IO_SHIFT
);

787 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_IO_BASE_UPPER16
, 0);

788 
	`pci_c⁄fig_wrôeb
(
bdf
, 
PCI_IO_LIMIT
, 
limô
 >> 
PCI_IO_SHIFT
);

789 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_IO_LIMIT_UPPER16
, 0);

791 i‡(
íåy
->
ty≥
 =
PCI_REGION_TYPE_MEM
) {

792 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_MEMORY_BASE
, 
addr
 >> 
PCI_MEMORY_SHIFT
);

793 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_MEMORY_LIMIT
, 
limô
 >> 
PCI_MEMORY_SHIFT
);

795 i‡(
íåy
->
ty≥
 =
PCI_REGION_TYPE_PREFMEM
) {

796 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_PREF_MEMORY_BASE
, 
addr
 >> 
PCI_PREF_MEMORY_SHIFT
);

797 
	`pci_c⁄fig_wrôew
(
bdf
, 
PCI_PREF_MEMORY_LIMIT
, 
limô
 >> 
PCI_PREF_MEMORY_SHIFT
);

798 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_PREF_BASE_UPPER32
, 
addr
 >> 32);

799 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_PREF_LIMIT_UPPER32
, 
limô
 >> 32);

801 
	}
}

803 
	$pci_ªgi⁄_m≠_íåõs
(
pci_bus
 *
bus£s
, 
pci_ªgi⁄
 *
r
)

805 
hli°_node
 *
n
;

806 
pci_ªgi⁄_íåy
 *
íåy
;

807 
	`hli°_f‹_óch_íåy_ß„
(
íåy
, 
n
, &
r
->
li°
, 
node
) {

808 
u64
 
addr
 = 
r
->
ba£
;

809 
r
->
ba£
 +
íåy
->
size
;

810 i‡(
íåy
->
b¨
 == -1)

812 
bus£s
[
íåy
->
dev
->
£c⁄d¨y_bus
].
r
[íåy->
ty≥
].
ba£
 = 
addr
;

813 
	`pci_ªgi⁄_m≠_⁄e_íåy
(
íåy
, 
addr
);

814 
	`hli°_dñ
(&
íåy
->
node
);

815 
	`‰ì
(
íåy
);

817 
	}
}

819 
	$pci_bios_m≠_devi˚s
(
pci_bus
 *
bus£s
)

821 i‡(
	`pci_bios_öô_roŸ_ªgi⁄s_io
(
bus£s
))

822 
	`∑nic
("PCI: out of I/Oáddress space\n");

824 
	`d¥ötf
(1, "PCI: 32: %016Œx - %016Œx\n", 
pcimem_°¨t
, 
pcimem_íd
);

825 i‡(
	`pci_bios_öô_roŸ_ªgi⁄s_mem
(
bus£s
)) {

826 
pci_ªgi⁄
 
r64_mem
, 
r64_¥ef
;

827 
r64_mem
.
li°
.
fú°
 = 
NULL
;

828 
r64_¥ef
.
li°
.
fú°
 = 
NULL
;

829 
	`pci_ªgi⁄_migøã_64bô_íåõs
(&
bus£s
[0].
r
[
PCI_REGION_TYPE_MEM
],

830 &
r64_mem
);

831 
	`pci_ªgi⁄_migøã_64bô_íåõs
(&
bus£s
[0].
r
[
PCI_REGION_TYPE_PREFMEM
],

832 &
r64_¥ef
);

834 i‡(
	`pci_bios_öô_roŸ_ªgi⁄s_mem
(
bus£s
))

835 
	`∑nic
("PCI: out of 32bitáddress space\n");

837 
u64
 
sum_mem
 = 
	`pci_ªgi⁄_sum
(&
r64_mem
);

838 
u64
 
sum_¥ef
 = 
	`pci_ªgi⁄_sum
(&
r64_¥ef
);

839 
u64
 
Æign_mem
 = 
	`pci_ªgi⁄_Æign
(&
r64_mem
);

840 
u64
 
Æign_¥ef
 = 
	`pci_ªgi⁄_Æign
(&
r64_¥ef
);

842 
r64_mem
.
ba£
 = 
	`À64_to_˝u
(
	`romfûe_lﬂdöt
("etc/reserved-memory-end", 0));

843 i‡(
r64_mem
.
ba£
 < 0x100000000LL + 
RamSizeOvî4G
)

844 
r64_mem
.
ba£
 = 0x100000000LL + 
RamSizeOvî4G
;

845 
r64_mem
.
ba£
 = 
	`ALIGN
‘64_mem.ba£, 
Æign_mem
);

846 
r64_mem
.
ba£
 = 
	`ALIGN
(r64_mem.base, (1LL<<30));

847 
r64_¥ef
.
ba£
 = 
r64_mem
.ba£ + 
sum_mem
;

848 
r64_¥ef
.
ba£
 = 
	`ALIGN
‘64_¥ef.ba£, 
Æign_¥ef
);

849 
r64_¥ef
.
ba£
 = 
	`ALIGN
(r64_pref.base, (1LL<<30));

850 
pcimem64_°¨t
 = 
r64_mem
.
ba£
;

851 
pcimem64_íd
 = 
r64_¥ef
.
ba£
 + 
sum_¥ef
;

852 
pcimem64_íd
 = 
	`ALIGN
(pcimem64_end, (1LL<<30));

853 
	`d¥ötf
(1, "PCI: 64: %016Œx - %016Œx\n", 
pcimem64_°¨t
, 
pcimem64_íd
);

855 
	`pci_ªgi⁄_m≠_íåõs
(
bus£s
, &
r64_mem
);

856 
	`pci_ªgi⁄_m≠_íåõs
(
bus£s
, &
r64_¥ef
);

859 
pcimem64_°¨t
 = 0;

862 
bus
;

863 
bus
 = 0; bus<=
MaxPCIBus
; bus++) {

864 
ty≥
;

865 
ty≥
 = 0;Åy≥ < 
PCI_REGION_TYPE_COUNT
;Åype++)

866 
	`pci_ªgi⁄_m≠_íåõs
(
bus£s
, &bus£s[
bus
].
r
[
ty≥
]);

868 
	}
}

876 
	$pci_£tup
()

878 i‡(!
CONFIG_QEMU
)

881 
	`d¥ötf
(3, "pci setup\n");

883 
	`d¥ötf
(1, "=== PCI bus & bridge init ===\n");

884 i‡(
	`pci_¥obe_ho°
() != 0) {

887 
	`pci_bios_öô_bus
();

889 
	`d¥ötf
(1, "=== PCI deviceÖrobing ===\n");

890 
	`pci_¥obe_devi˚s
();

892 
pcimem_°¨t
 = 
RamSize
;

893 
	`pci_bios_öô_∂©f‹m
();

895 
	`d¥ötf
(1, "=== PCIÇewállocationÖass #1 ===\n");

896 
pci_bus
 *
bus£s
 = 
	`mÆloc_tmp
((*bus£sË* (
MaxPCIBus
 + 1));

897 i‡(!
bus£s
) {

898 
	`w¨n_nﬂŒoc
();

901 
	`mem£t
(
bus£s
, 0, (*bus£sË* (
MaxPCIBus
 + 1));

902 i‡(
	`pci_bios_check_devi˚s
(
bus£s
))

905 
	`d¥ötf
(1, "=== PCIÇewállocationÖass #2 ===\n");

906 
	`pci_bios_m≠_devi˚s
(
bus£s
);

908 
	`pci_bios_öô_devi˚s
();

910 
	`‰ì
(
bus£s
);

912 
	`pci_íabÀ_deÁu…_vga
();

913 
	}
}

	@fw/pirtable.c

8 
	~"c⁄fig.h
"

9 
	~"ouçut.h
"

10 
	~"°d/púèbÀ.h
"

11 
	~"°rög.h
"

13 
pú_hódî
 *
PúAddr
 
	gVARFSEG
;

15 
	spú_èbÀ
 {

16 
pú_hódî
 
	mpú
;

17 
pú_¶Ÿ
 
	m¶Ÿs
[6];

18 } 
	gPACKED
;

20 
pú_èbÀ
 
PIR_TABLE
;

21 #i‡
CONFIG_PIRTABLE


22 
pú_èbÀ
 
PIR_TABLE
 
	$__Æig√d
(16Ë
VARFSEG
 = {

23 .
pú
 = {

24 .
vîsi⁄
 = 0x0100,

25 .
size
 = (
pú_èbÀ
),

26 .
rouãr_devfunc
 = 0x08,

27 .
com∑tibÀ_devid
 = 0x122e8086,

29 .
¶Ÿs
 = {

32 .
dev
 = 1<<3,

33 .
löks
 = {

34 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

35 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

36 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

37 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

39 .
¶Ÿ_ƒ
 = 0,

42 .
dev
 = 2<<3,

43 .
löks
 = {

44 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

45 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

46 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

47 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

49 .
¶Ÿ_ƒ
 = 1,

52 .
dev
 = 3<<3,

53 .
löks
 = {

54 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

55 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

56 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

57 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

59 .
¶Ÿ_ƒ
 = 2,

62 .
dev
 = 4<<3,

63 .
löks
 = {

64 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

65 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

66 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

67 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

69 .
¶Ÿ_ƒ
 = 3,

72 .
dev
 = 5<<3,

73 .
löks
 = {

74 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

75 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

76 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

77 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

79 .
¶Ÿ_ƒ
 = 4,

82 .
dev
 = 6<<3,

83 .
löks
 = {

84 {.
lök
 = 0x61, .
bôm≠
 = 0xdef8},

85 {.
lök
 = 0x62, .
bôm≠
 = 0xdef8},

86 {.
lök
 = 0x63, .
bôm≠
 = 0xdef8},

87 {.
lök
 = 0x60, .
bôm≠
 = 0xdef8},

89 .
¶Ÿ_ƒ
 = 5,

92 
	}
};

96 
	$púèbÀ_£tup
()

98 i‡(! 
CONFIG_PIRTABLE
)

101 
	`d¥ötf
(3, "init PIRÅable\n");

103 
PIR_TABLE
.
pú
.
sig«tuª
 = 
PIR_SIGNATURE
;

104 
PIR_TABLE
.
pú
.
checksum
 -
	`checksum
(&PIR_TABLE, (PIR_TABLE));

105 
PúAddr
 = &
PIR_TABLE
.
pú
;

106 
	}
}

	@fw/romfile_loader.c

1 
	~"romfûe_lﬂdî.h
"

2 
	~"byã‹dî.h
"

3 
	~"utû.h
"

4 
	~"°rög.h
"

5 
	~"romfûe.h
"

6 
	~"mÆloc.h
"

7 
	~"ouçut.h
"

9 
	sromfûe_lﬂdî_fûe
 {

10 
romfûe_s
 *
	mfûe
;

11 *
	md©a
;

13 
	sromfûe_lﬂdî_fûes
 {

14 
	mnfûes
;

15 
romfûe_lﬂdî_fûe
 
	mfûes
[];

18 
romfûe_lﬂdî_fûe
 *

19 
	$romfûe_lﬂdî_föd
(c⁄° *
«me
,

20 
romfûe_lﬂdî_fûes
 *
fûes
)

22 
i
;

23 i‡(
«me
[
ROMFILE_LOADER_FILESZ
 - 1])

24  
NULL
;

25 
i
 = 0; i < 
fûes
->
nfûes
; ++i)

26 i‡(!
	`°rcmp
(
fûes
->fûes[
i
].
fûe
->
«me
,Çame))

27  &
fûes
->fûes[
i
];

28  
NULL
;

29 
	}
}

31 
	$romfûe_lﬂdî_Æloˇã
(
romfûe_lﬂdî_íåy_s
 *
íåy
,

32 
romfûe_lﬂdî_fûes
 *
fûes
)

34 
z⁄e_s
 *
z⁄e
;

35 
romfûe_lﬂdî_fûe
 *
fûe
 = &
fûes
->fûes[fûes->
nfûes
];

36 *
d©a
;

37 
ªt
;

38 
Æloc_Æign
 = 
	`À32_to_˝u
(
íåy
->alloc_align);

40 i‡(
Æloc_Æign
 & (alloc_align - 1))

41 
îr
;

43 
íåy
->
Æloc_z⁄e
) {

44 
ROMFILE_LOADER_ALLOC_ZONE_HIGH
:

45 
z⁄e
 = &
Z⁄eHigh
;

47 
ROMFILE_LOADER_ALLOC_ZONE_FSEG
:

48 
z⁄e
 = &
Z⁄eFSeg
;

51 
îr
;

53 i‡(
Æloc_Æign
 < 
MALLOC_MIN_ALIGN
)

54 
Æloc_Æign
 = 
MALLOC_MIN_ALIGN
;

55 i‡(
íåy
->
Æloc_fûe
[
ROMFILE_LOADER_FILESZ
 - 1])

56 
îr
;

57 
fûe
->fûê
	`romfûe_föd
(
íåy
->
Æloc_fûe
);

58 i‡(!
fûe
->fûê|| !fûe->fûe->
size
)

60 
d©a
 = 
	`_mÆloc
(
z⁄e
, 
fûe
->fûe->
size
, 
Æloc_Æign
);

61 i‡(!
d©a
) {

62 
	`w¨n_nﬂŒoc
();

65 
ªt
 = 
fûe
->fûe->
	`c›y
(fûe->fûe, 
d©a
, fûe->fûe->
size
);

66 i‡(
ªt
 !
fûe
->fûe->
size
)

67 
fûe_îr
;

68 
fûe
->
d©a
 = data;

69 
fûes
->
nfûes
++;

72 
fûe_îr
:

73 
	`‰ì
(
d©a
);

74 
îr
:

75 
	`w¨n_öã∫Æîr‹
();

76 
	}
}

78 
	$romfûe_lﬂdî_add_poöãr
(
romfûe_lﬂdî_íåy_s
 *
íåy
,

79 
romfûe_lﬂdî_fûes
 *
fûes
)

81 
romfûe_lﬂdî_fûe
 *
de°_fûe
;

82 
romfûe_lﬂdî_fûe
 *
§c_fûe
;

83 
off£t
 = 
	`À32_to_˝u
(
íåy
->
poöãr_off£t
);

84 
u64
 
poöãr
 = 0;

86 
de°_fûe
 = 
	`romfûe_lﬂdî_föd
(
íåy
->
poöãr_de°_fûe
, 
fûes
);

87 
§c_fûe
 = 
	`romfûe_lﬂdî_föd
(
íåy
->
poöãr_§c_fûe
, 
fûes
);

89 i‡(!
de°_fûe
 || !
§c_fûe
 || !de°_fûe->
d©a
 || !src_file->data ||

90 
off£t
 + 
íåy
->
poöãr_size
 < offset ||

91 
off£t
 + 
íåy
->
poöãr_size
 > 
de°_fûe
->
fûe
->
size
 ||

92 
íåy
->
poöãr_size
 < 1 ||Éntry->pointer_size > 8 ||

93 
íåy
->
poöãr_size
 & (entry->pointer_size - 1))

94 
îr
;

96 
	`mem˝y
(&
poöãr
, 
de°_fûe
->
d©a
 + 
off£t
, 
íåy
->
poöãr_size
);

97 
poöãr
 = 
	`À64_to_˝u
(pointer);

98 
poöãr
 +()
§c_fûe
->
d©a
;

99 
poöãr
 = 
	`˝u_to_À64
(pointer);

100 
	`mem˝y
(
de°_fûe
->
d©a
 + 
off£t
, &
poöãr
, 
íåy
->
poöãr_size
);

103 
îr
:

104 
	`w¨n_öã∫Æîr‹
();

105 
	}
}

107 
	$romfûe_lﬂdî_add_checksum
(
romfûe_lﬂdî_íåy_s
 *
íåy
,

108 
romfûe_lﬂdî_fûes
 *
fûes
)

110 
romfûe_lﬂdî_fûe
 *
fûe
;

111 
off£t
 = 
	`À32_to_˝u
(
íåy
->
cksum_off£t
);

112 
°¨t
 = 
	`À32_to_˝u
(
íåy
->
cksum_°¨t
);

113 
Àn
 = 
	`À32_to_˝u
(
íåy
->
cksum_Àngth
);

114 
u8
 *
d©a
;

116 
fûe
 = 
	`romfûe_lﬂdî_föd
(
íåy
->
cksum_fûe
, 
fûes
);

118 i‡(!
fûe
 || !fûe->
d©a
 || 
off£t
 >fûe->fûe->
size
 ||

119 
°¨t
 + 
Àn
 < sèπ || sèπ +Üí > 
fûe
->fûe->
size
)

120 
îr
;

122 
d©a
 = 
fûe
->d©®+ 
off£t
;

123 *
d©a
 -
	`checksum
(
fûe
->d©®+ 
°¨t
, 
Àn
);

126 
îr
:

127 
	`w¨n_öã∫Æîr‹
();

128 
	}
}

130 
	$romfûe_lﬂdî_execuã
(c⁄° *
«me
)

132 
romfûe_lﬂdî_íåy_s
 *
íåy
;

133 
size
, 
off£t
 = 0, 
nfûes
;

134 
romfûe_lﬂdî_fûes
 *
fûes
;

135 *
d©a
 = 
	`romfûe_lﬂdfûe
(
«me
, &
size
);

136 i‡(!
d©a
)

139 i‡(
size
 % (*
íåy
)) {

140 
	`w¨n_öã∫Æîr‹
();

141 
îr
;

145 
nfûes
 = 
size
 / (*
íåy
);

146 
fûes
 = 
	`mÆloc_tmp
((*fûesË+ 
nfûes
 * (files->files[0]));

147 i‡(!
fûes
) {

148 
	`w¨n_nﬂŒoc
();

149 
îr
;

151 
fûes
->
nfûes
 = 0;

153 
off£t
 = 0; off£à< 
size
; off£à+(*
íåy
)) {

154 
íåy
 = 
d©a
 + 
off£t
;

155 
	`À32_to_˝u
(
íåy
->
comm™d
)) {

156 
ROMFILE_LOADER_COMMAND_ALLOCATE
:

157 
	`romfûe_lﬂdî_Æloˇã
(
íåy
, 
fûes
);

159 
ROMFILE_LOADER_COMMAND_ADD_POINTER
:

160 
	`romfûe_lﬂdî_add_poöãr
(
íåy
, 
fûes
);

162 
ROMFILE_LOADER_COMMAND_ADD_CHECKSUM
:

163 
	`romfûe_lﬂdî_add_checksum
(
íåy
, 
fûes
);

170 
	`‰ì
(
fûes
);

171 
	`‰ì
(
d©a
);

174 
îr
:

175 
	`‰ì
(
d©a
);

177 
	}
}

	@fw/romfile_loader.h

1 #i‚de‡
__ROMFILE_LOADER_H


2 
	#__ROMFILE_LOADER_H


	)

4 
	~"ty≥s.h
"

5 
	~"utû.h
"

7 
	#ROMFILE_LOADER_FILESZ
 56

	)

10 
	sromfûe_lﬂdî_íåy_s
 {

11 
u32
 
	mcomm™d
;

22 
	mÆloc_fûe
[
ROMFILE_LOADER_FILESZ
];

23 
u32
 
	mÆloc_Æign
;

24 
u8
 
	mÆloc_z⁄e
;

34 
	mpoöãr_de°_fûe
[
ROMFILE_LOADER_FILESZ
];

35 
	mpoöãr_§c_fûe
[
ROMFILE_LOADER_FILESZ
];

36 
u32
 
	mpoöãr_off£t
;

37 
u8
 
	mpoöãr_size
;

48 
	mcksum_fûe
[
ROMFILE_LOADER_FILESZ
];

49 
u32
 
	mcksum_off£t
;

50 
u32
 
	mcksum_°¨t
;

51 
u32
 
	mcksum_Àngth
;

55 
	m∑d
[124];

60 
	mROMFILE_LOADER_COMMAND_ALLOCATE
 = 0x1,

61 
	mROMFILE_LOADER_COMMAND_ADD_POINTER
 = 0x2,

62 
	mROMFILE_LOADER_COMMAND_ADD_CHECKSUM
 = 0x3,

66 
	mROMFILE_LOADER_ALLOC_ZONE_HIGH
 = 0x1,

67 
	mROMFILE_LOADER_ALLOC_ZONE_FSEG
 = 0x2,

70 
romfûe_lﬂdî_execuã
(c⁄° *
«me
);

	@fw/shadow.c

8 
	~"c⁄fig.h
"

9 
	~"dev-q35.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pci_ids.h
"

12 
	~"hw/pci_ªgs.h
"

13 
	~"mÆloc.h
"

14 
	~"ouçut.h
"

15 
	~"∑øvút.h
"

16 
	~"°rög.h
"

17 
	~"utû.h
"

18 
	~"x86.h
"

21 
	#BIOS_SRC_OFFSET
 0xfff00000

	)

23 
	#I440FX_PAM0
 0x59

	)

27 
	$__make_bios_wrôabÀ_öãl
(
u16
 
bdf
, 
u32
 
∑m0
)

30 
˛ór
 = 0;

31 
i
;

32 
i
=0; i<6; i++) {

33 
u32
 
∑m
 = 
∑m0
 + 1 + 
i
;

34 
ªg
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
∑m
);

35 i‡(
CONFIG_OPTIONROMS_DEPLOYED
 && (
ªg
 & 0x11) != 0x11) {

37 *
mem
 = (*)(
BUILD_ROM_START
 + 
i
 * 32*1024);

38 
	`mem˝y
((*)
BUILD_BIOS_TMP_ADDR
, 
mem
, 32*1024);

39 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m
, 0x33);

40 
	`mem˝y
(
mem
, (*)
BUILD_BIOS_TMP_ADDR
, 32*1024);

41 
˛ór
 = 1;

43 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m
, 0x33);

46 i‡(
˛ór
)

47 
	`mem£t
((*)
BUILD_BIOS_TMP_ADDR
, 0, 32*1024);

50 
ªg
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
∑m0
);

51 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m0
, 0x30);

52 i‡(
ªg
 & 0x10)

57 
u8
 
code32Ê©_°¨t
[], 
code32Ê©_íd
[];

58 
	`mem˝y
(
code32Ê©_°¨t
, code32Ê©_°¨à+ 
BIOS_SRC_OFFSET


59 , 
code32Ê©_íd
 - 
code32Ê©_°¨t
);

60 
	}
}

63 
	$make_bios_wrôabÀ_öãl
(
u16
 
bdf
, 
u32
 
∑m0
)

65 
ªg
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
∑m0
);

66 i‡(!(
ªg
 & 0x10)) {

71 
u32
 
pos
 = (u32)
__make_bios_wrôabÀ_öãl
 + 
BIOS_SRC_OFFSET
;

72 (*
func
)(
u16
 
bdf
, 
u32
 
∑m0
Ë(*)
pos
;

73 
	`func
(
bdf
, 
∑m0
);

77 
	`__make_bios_wrôabÀ_öãl
(
bdf
, 
∑m0
);

78 
	}
}

81 
	$make_bios_ªad⁄ly_öãl
(
u16
 
bdf
, 
u32
 
∑m0
)

84 
	`wbövd
();

87 
u32
 
romœ°
 = 
BUILD_BIOS_ADDR
, 
rommax
 = BUILD_BIOS_ADDR;

88 i‡(
CONFIG_WRITABLE_UPPERMEMORY
)

89 
romœ°
 = 
	`rom_gë_œ°
();

90 i‡(
CONFIG_MALLOC_UPPERMEMORY
)

91 
rommax
 = 
	`rom_gë_max
();

92 
i
;

93 
i
=0; i<6; i++) {

94 
u32
 
mem
 = 
BUILD_ROM_START
 + 
i
 * 32*1024;

95 
u32
 
∑m
 = 
∑m0
 + 1 + 
i
;

96 i‡(
romœ°
 < 
mem
 + 16*1024 || 
rommax
 < mem + 32*1024) {

97 i‡(
romœ°
 >
mem
 && 
rommax
 >= mem + 16*1024)

98 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m
, 0x31);

101 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m
, 0x11);

105 
	`pci_c⁄fig_wrôeb
(
bdf
, 
∑m0
, 0x10);

106 
	}
}

108 
	gShadowBDF
 = -1;

112 
	$make_bios_wrôabÀ
()

114 i‡(!
CONFIG_QEMU
 || 
	`ru¬ögOnXí
())

117 
	`d¥ötf
(3, "enabling shadowÑam\n");

121 
bdf
;

122 
	`f‹óchbdf
(
bdf
, 0) {

123 
u32
 
vídev
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_VENDOR_ID
);

124 
u16
 
víd‹
 = 
vídev
 & 0xffff, 
devi˚
 = vendev >> 16;

125 i‡(
víd‹
 =
PCI_VENDOR_ID_INTEL


126 && 
devi˚
 =
PCI_DEVICE_ID_INTEL_82441
) {

127 
	`make_bios_wrôabÀ_öãl
(
bdf
, 
I440FX_PAM0
);

128 
ShadowBDF
 = 
bdf
;

131 i‡(
víd‹
 =
PCI_VENDOR_ID_INTEL


132 && 
devi˚
 =
PCI_DEVICE_ID_INTEL_Q35_MCH
) {

133 
	`make_bios_wrôabÀ_öãl
(
bdf
, 
Q35_HOST_BRIDGE_PAM0
);

134 
ShadowBDF
 = 
bdf
;

138 
	`d¥ötf
(1, "UnableÅo unlockÑam - bridgeÇot found\n");

139 
	}
}

143 
	$make_bios_ªad⁄ly
()

145 i‡(!
CONFIG_QEMU
 || 
	`ru¬ögOnXí
())

147 
	`d¥ötf
(3, "locking shadowÑam\n");

149 i‡(
ShadowBDF
 < 0) {

150 
	`d¥ötf
(1, "UnableÅoÜockÑam - bridgeÇot found\n");

154 
u16
 
devi˚
 = 
	`pci_c⁄fig_ªadw
(
ShadowBDF
, 
PCI_DEVICE_ID
);

155 i‡(
devi˚
 =
PCI_DEVICE_ID_INTEL_82441
)

156 
	`make_bios_ªad⁄ly_öãl
(
ShadowBDF
, 
I440FX_PAM0
);

158 
	`make_bios_ªad⁄ly_öãl
(
ShadowBDF
, 
Q35_HOST_BRIDGE_PAM0
);

159 
	}
}

162 
	$qemu_¥ï_ª£t
()

164 i‡(!
CONFIG_QEMU
 || 
	`ru¬ögOnXí
())

168 
	`make_bios_wrôabÀ
();

169 
u8
 
code32Ê©_°¨t
[], 
code32Ê©_íd
[];

170 
	`mem˝y
(
code32Ê©_°¨t
, code32Ê©_°¨à+ 
BIOS_SRC_OFFSET


171 , 
code32Ê©_íd
 - 
code32Ê©_°¨t
);

172 
	}
}

	@fw/smbios.c

8 
	~"c⁄fig.h
"

9 
	~"mÆloc.h
"

10 
	~"ouçut.h
"

11 
	~"∑øvút.h
"

12 
	~"romfûe.h
"

13 
	~"°d/smbios.h
"

14 
	~"°rög.h
"

15 
	~"utû.h
"

16 
	~"x86.h
"

18 
smbios_íåy_poöt
 *
	gSMBiosAddr
;

21 
	$smbios_íåy_poöt_£tup
(
u16
 
max_°ru˘uª_size
,

22 
u16
 
°ru˘uª_èbÀ_Àngth
,

23 *
°ru˘uª_èbÀ_addªss
,

24 
u16
 
numbî_of_°ru˘uªs
)

26 
smbios_íåy_poöt
 *
ï
 = 
	`mÆloc_f£g
((*ep));

27 *
föÆèbÀ
;

28 i‡(
°ru˘uª_èbÀ_Àngth
 <
BUILD_MAX_SMBIOS_FSEG
)

31 
föÆèbÀ
 = 
	`mÆloc_f£g
(
°ru˘uª_èbÀ_Àngth
);

33 
föÆèbÀ
 = 
	`mÆloc_high
(
°ru˘uª_èbÀ_Àngth
);

34 i‡(!
ï
 || !
föÆèbÀ
) {

35 
	`w¨n_nﬂŒoc
();

36 
	`‰ì
(
ï
);

37 
	`‰ì
(
föÆèbÀ
);

40 
	`mem˝y
(
föÆèbÀ
, 
°ru˘uª_èbÀ_addªss
, 
°ru˘uª_èbÀ_Àngth
);

42 
	`mem˝y
(
ï
->
™ch‹_°rög
, "_SM_", 4);

43 
ï
->
Àngth
 = 0x1f;

44 
ï
->
smbios_maj‹_vîsi⁄
 = 2;

45 
ï
->
smbios_mö‹_vîsi⁄
 = 4;

46 
ï
->
max_°ru˘uª_size
 = max_structure_size;

47 
ï
->
íåy_poöt_ªvisi⁄
 = 0;

48 
	`mem£t
(
ï
->
f‹m©ãd_¨ó
, 0, 5);

49 
	`mem˝y
(
ï
->
öãrmedüã_™ch‹_°rög
, "_DMI_", 5);

51 
ï
->
°ru˘uª_èbÀ_Àngth
 = structure_table_length;

52 
ï
->
°ru˘uª_èbÀ_addªss
 = (
u32
)
föÆèbÀ
;

53 
ï
->
numbî_of_°ru˘uªs
 =Çumber_of_structures;

54 
ï
->
smbios_bcd_ªvisi⁄
 = 0x24;

56 
ï
->
checksum
 -
	`checksum
(ep, 0x10);

58 
ï
->
öãrmedüã_checksum
 -
	`checksum
((*Î∞+ 0x10,Ép->
Àngth
 - 0x10);

60 
SMBiosAddr
 = 
ï
;

61 
	`d¥ötf
(1, "SMBIOSÖtr=%pÅable=%p size=%d\n"

62 , 
ï
, 
föÆèbÀ
, 
°ru˘uª_èbÀ_Àngth
);

63 
	}
}

66 
	$gë_fõld
(
ty≥
, 
off£t
, *
de°
)

68 
«me
[128];

69 
	`¢¥ötf
(
«me
, “ame), "smbios/fõld%d-%d", 
ty≥
, 
off£t
);

70 
romfûe_s
 *
fûe
 = 
	`romfûe_föd
(
«me
);

71 i‡(!
fûe
)

73 
fûe
->
	`c›y
(fûe, 
de°
, fûe->
size
);

74  
fûe
->
size
;

75 
	}
}

78 
	$gë_exã∫Æ
(
ty≥
, **
p
, *
ƒ_°ru˘s
,

79 *
max_°ru˘_size
, *
íd
)

81 
u64
 
u£d_bôm≠
[4] = { 0 };

82 *
°¨t
 = *
p
;

85 i‡(
u£d_bôm≠
[(
ty≥
 >> 6) & 0x3] & (1ULL << (type & 0x3f)))

89 i‡(
ty≥
 == 127)

92 
¥efix
[128];

93 
	`¢¥ötf
(
¥efix
, ’ªfix), "smbios/èbÀ%d-", 
ty≥
);

94 
romfûe_s
 *
fûe
 = 
NULL
;

96 
fûe
 = 
	`romfûe_föd¥efix
(
¥efix
, file);

97 i‡(!
fûe
)

100 i‡(
íd
 - *
p
 < 
fûe
->
size
) {

101 
	`w¨n_nﬂŒoc
();

105 
smbios_°ru˘uª_hódî
 *
hódî
 = (*)*
p
;

106 
fûe
->
	`c›y
(fûe, 
hódî
, fûe->
size
);

107 *
p
 +
fûe
->
size
;

112 *((
u8
*)*
p
) = 0;

113 (*
p
)++;

114 i‡(
hódî
->
Àngth
 >
fûe
->
size
) {

115 *((
u8
*)*
p
) = 0;

116 (*
p
)++;

119 (*
ƒ_°ru˘s
)++;

120 i‡(*
p
 - (*)
hódî
 > *
max_°ru˘_size
)

121 *
max_°ru˘_size
 = *
p
 - (*)
hódî
;

124 i‡(
°¨t
 =*
p
)

128 
u£d_bôm≠
[(
ty≥
 >> 6) & 0x3] |= (1ULL << (type & 0x3f));

130 
	}
}

132 
	#lﬂd_°r_fõld_wôh_deÁu…
(
ty≥
, 
fõld
, 
def
) \

134 
size
 = 
	`gë_fõld
(
ty≥
, 
	`off£tof
(
smbios_ty≥_
##type, \

135 
fõld
), 
íd
); \

136 i‡(
size
 == 1) { \

138 
p
->
fõld
 = 0; \

139 } i‡(
size
 > 1) { \

140 
íd
 +
size
; \

141 
p
->
fõld
 = ++
°r_ödex
; \

143 
	`mem˝y
(
íd
, 
def
, (def)); \

144 
íd
 +(
def
); \

145 
p
->
fõld
 = ++
°r_ödex
; \

147 } 0)

	)

149 
	#lﬂd_°r_fõld_‹_skù
(
ty≥
, 
fõld
) \

151 
size
 = 
	`gë_fõld
(
ty≥
, 
	`off£tof
(
smbios_ty≥_
##type, \

152 
fõld
), 
íd
); \

153 i‡(
size
 > 1) { \

154 
íd
 +
size
; \

155 
p
->
fõld
 = ++
°r_ödex
; \

157 
p
->
fõld
 = 0; \

159 } 0)

	)

161 
	#£t_fõld_wôh_deÁu…
(
ty≥
, 
fõld
, 
def
) \

163 i‡(!
	`gë_fõld
(
ty≥
, 
	`off£tof
(
smbios_ty≥_
##type, \

164 
fõld
), &
p
->field)) { \

165 
p
->
fõld
 = 
def
; \

167 } 0)

	)

170 
	#RELEASE_DATE_STR
 "01/01/2011"

	)

172 
	$smbios_öô_ty≥_0
(*
°¨t
)

174 
smbios_ty≥_0
 *
p
 = (smbios_ty≥_0 *)
°¨t
;

175 *
íd
 = (*)
°¨t
 + (
smbios_ty≥_0
);

176 
size_t
 
size
;

177 
°r_ödex
 = 0;

179 
p
->
hódî
.
ty≥
 = 0;

180 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_0
);

181 
p
->
hódî
.
h™dÀ
 = 0;

183 
	`lﬂd_°r_fõld_wôh_deÁu…
(0, 
víd‹_°r
, 
BUILD_APPNAME
);

184 
	`lﬂd_°r_fõld_wôh_deÁu…
(0, 
bios_vîsi⁄_°r
, 
BUILD_APPNAME
);

186 
p
->
bios_°¨tög_addªss_£gmít
 = 0xe800;

188 
	`lﬂd_°r_fõld_wôh_deÁu…
(0, 
bios_ªÀa£_d©e_°r
, 
RELEASE_DATE_STR
);

190 
p
->
bios_rom_size
 = 0;

192 i‡(!
	`gë_fõld
(0, 
	`off£tof
(
smbios_ty≥_0
, 
bios_ch¨a˘îi°ics
),

193 &
p
->
bios_ch¨a˘îi°ics
)) {

194 
	`mem£t
(
p
->
bios_ch¨a˘îi°ics
, 0, 8);

196 
p
->
bios_ch¨a˘îi°ics
[0] = 0x08;

199 i‡(!
	`gë_fõld
(0, 
	`off£tof
(
smbios_ty≥_0
,

200 
bios_ch¨a˘îi°ics_exãnsi⁄_byãs
),

201 &
p
->
bios_ch¨a˘îi°ics_exãnsi⁄_byãs
)) {

202 
p
->
bios_ch¨a˘îi°ics_exãnsi⁄_byãs
[0] = 0;

204 
p
->
bios_ch¨a˘îi°ics_exãnsi⁄_byãs
[1] = 4;

207 
	`£t_fõld_wôh_deÁu…
(0, 
sy°em_bios_maj‹_ªÀa£
, 1);

208 
	`£t_fõld_wôh_deÁu…
(0, 
sy°em_bios_mö‹_ªÀa£
, 0);

209 
	`£t_fõld_wôh_deÁu…
(0, 
embedded_c⁄åﬁÀr_maj‹_ªÀa£
, 0xff);

210 
	`£t_fõld_wôh_deÁu…
(0, 
embedded_c⁄åﬁÀr_mö‹_ªÀa£
, 0xff);

212 *
íd
 = 0;

213 
íd
++;

215  
íd
;

216 
	}
}

220 
	$smbios_öô_ty≥_1
(*
°¨t
)

222 
smbios_ty≥_1
 *
p
 = (smbios_ty≥_1 *)
°¨t
;

223 *
íd
 = (*)
°¨t
 + (
smbios_ty≥_1
);

224 
size_t
 
size
;

225 
°r_ödex
 = 0;

227 
p
->
hódî
.
ty≥
 = 1;

228 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_1
);

229 
p
->
hódî
.
h™dÀ
 = 0x100;

231 
	`lﬂd_°r_fõld_wôh_deÁu…
(1, 
m™uÁ˘uªr_°r
, 
BUILD_APPNAME
);

232 
	`lﬂd_°r_fõld_wôh_deÁu…
(1, 
¥odu˘_«me_°r
, 
BUILD_APPNAME
);

233 
	`lﬂd_°r_fõld_‹_skù
(1, 
vîsi⁄_°r
);

234 
	`lﬂd_°r_fõld_‹_skù
(1, 
£rül_numbî_°r
);

236 i‡(!
	`gë_fõld
(1, 
	`off£tof
(
smbios_ty≥_1
, 
uuid
), &
p
->uuid))

237 
	`mem£t
(
p
->
uuid
, 0, 16);

239 
	`£t_fõld_wôh_deÁu…
(1, 
wake_up_ty≥
, 0x06);

241 
	`lﬂd_°r_fõld_‹_skù
(1, 
sku_numbî_°r
);

242 
	`lﬂd_°r_fõld_‹_skù
(1, 
Ámûy_°r
);

244 *
íd
 = 0;

245 
íd
++;

246 i‡(!
°r_ödex
) {

247 *
íd
 = 0;

248 
íd
++;

251  
íd
;

252 
	}
}

256 
	$smbios_öô_ty≥_3
(*
°¨t
)

258 
smbios_ty≥_3
 *
p
 = (smbios_ty≥_3 *)
°¨t
;

259 *
íd
 = (*)
°¨t
 + (
smbios_ty≥_3
);

260 
size_t
 
size
;

261 
°r_ödex
 = 0;

263 
p
->
hódî
.
ty≥
 = 3;

264 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_3
);

265 
p
->
hódî
.
h™dÀ
 = 0x300;

267 
	`lﬂd_°r_fõld_wôh_deÁu…
(3, 
m™uÁ˘uªr_°r
, 
BUILD_APPNAME
);

268 
	`£t_fõld_wôh_deÁu…
(3, 
ty≥
, 0x01);

270 
	`lﬂd_°r_fõld_‹_skù
(3, 
vîsi⁄_°r
);

271 
	`lﬂd_°r_fõld_‹_skù
(3, 
£rül_numbî_°r
);

272 
	`lﬂd_°r_fõld_‹_skù
(3, 
as£t_èg_numbî_°r
);

274 
	`£t_fõld_wôh_deÁu…
(3, 
boŸ_up_°©e
, 0x03);

275 
	`£t_fõld_wôh_deÁu…
(3, 
powî_suµly_°©e
, 0x03);

276 
	`£t_fõld_wôh_deÁu…
(3, 
thîmÆ_°©e
, 0x03);

277 
	`£t_fõld_wôh_deÁu…
(3, 
£curôy_°©us
, 0x02);

279 
	`£t_fõld_wôh_deÁu…
(3, 
€m_deföed
, 0);

280 
	`£t_fõld_wôh_deÁu…
(3, 
height
, 0);

281 
	`£t_fõld_wôh_deÁu…
(3, 
numbî_of_powî_c‹ds
, 0);

282 
	`£t_fõld_wôh_deÁu…
(3, 
c⁄èöed_ñemít_cou¡
, 0);

284 *
íd
 = 0;

285 
íd
++;

286 i‡(!
°r_ödex
) {

287 *
íd
 = 0;

288 
íd
++;

291  
íd
;

292 
	}
}

296 
	$smbios_öô_ty≥_4
(*
°¨t
, 
˝u_numbî
)

298 
smbios_ty≥_4
 *
p
 = (smbios_ty≥_4 *)
°¨t
;

299 *
íd
 = (*)
°¨t
 + (
smbios_ty≥_4
);

300 
size_t
 
size
;

301 
°r_ödex
 = 0;

302 
«me
[1024];

304 
p
->
hódî
.
ty≥
 = 4;

305 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_4
);

306 
p
->
hódî
.
h™dÀ
 = 0x400 + 
˝u_numbî
;

308 
size
 = 
	`gë_fõld
(4, 
	`off£tof
(
smbios_ty≥_4
, 
sockë_desig«ti⁄_°r
),

309 
«me
);

310 i‡(
size
)

311 
	`¢¥ötf
(
«me
 + 
size
 - 1, “ameË- size, "%2x", 
˝u_numbî
);

313 
	`¢¥ötf
(
«me
, “ame), "CPU%2x", 
˝u_numbî
);

315 
	`mem˝y
(
íd
, 
«me
, 
	`°æí
(name) + 1);

316 
íd
 +
	`°æí
(
«me
) + 1;

317 
p
->
sockë_desig«ti⁄_°r
 = ++
°r_ödex
;

319 
	`£t_fõld_wôh_deÁu…
(4, 
¥o˚ss‹_ty≥
, 0x03);

320 
	`£t_fõld_wôh_deÁu…
(4, 
¥o˚ss‹_Ámûy
, 0x01);

322 
	`lﬂd_°r_fõld_wôh_deÁu…
(4, 
¥o˚ss‹_m™uÁ˘uªr_°r
, 
BUILD_APPNAME
);

324 i‡(!
	`gë_fõld
(4, 
	`off£tof
(
smbios_ty≥_4
, 
¥o˚ss‹_id
)

325 , 
p
->
¥o˚ss‹_id
)) {

326 
u32
 
˝uid_sig«tuª
, 
ebx
, 
ecx
, 
˝uid_„©uªs
;

327 
	`˝uid
(1, &
˝uid_sig«tuª
, &
ebx
, &
ecx
, &
˝uid_„©uªs
);

328 
p
->
¥o˚ss‹_id
[0] = 
˝uid_sig«tuª
;

329 
p
->
¥o˚ss‹_id
[1] = 
˝uid_„©uªs
;

332 
	`lﬂd_°r_fõld_‹_skù
(4, 
¥o˚ss‹_vîsi⁄_°r
);

333 
	`£t_fõld_wôh_deÁu…
(4, 
vﬁège
, 0);

334 
	`£t_fõld_wôh_deÁu…
(4, 
exã∫Æ_˛ock
, 0);

336 
	`£t_fõld_wôh_deÁu…
(4, 
max_•ìd
, 2000);

337 
	`£t_fõld_wôh_deÁu…
(4, 
cuºít_•ìd
, 2000);

339 
	`£t_fõld_wôh_deÁu…
(4, 
°©us
, 0x41);

340 
	`£t_fõld_wôh_deÁu…
(4, 
¥o˚ss‹_upgøde
, 0x01);

343 
p
->
l1_ˇche_h™dÀ
 = 0xffff;

344 
p
->
l2_ˇche_h™dÀ
 = 0xffff;

345 
p
->
l3_ˇche_h™dÀ
 = 0xffff;

347 *
íd
 = 0;

348 
íd
++;

349 i‡(!
°r_ödex
) {

350 *
íd
 = 0;

351 
íd
++;

354  
íd
;

355 
	}
}

359 
	$smbios_öô_ty≥_16
(*
°¨t
, 
u32
 
mem‹y_size_mb
, 
ƒ_mem_devs
)

361 
smbios_ty≥_16
 *
p
 = (smbios_ty≥_16*)
°¨t
;

363 
p
->
hódî
.
ty≥
 = 16;

364 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_16
);

365 
p
->
hódî
.
h™dÀ
 = 0x1000;

367 
	`£t_fõld_wôh_deÁu…
(16, 
loˇti⁄
, 0x01);

368 
	`£t_fõld_wôh_deÁu…
(16, 
u£
, 0x03);

370 
	`£t_fõld_wôh_deÁu…
(16, 
îr‹_c‹ª˘i⁄
, 0x06);

372 
p
->
maximum_ˇ∑côy
 = 
mem‹y_size_mb
 < 2 << 20 ?

373 
mem‹y_size_mb
 << 10 : 0x80000000;

374 
p
->
mem‹y_îr‹_öf‹m©i⁄_h™dÀ
 = 0xfffe;

375 
p
->
numbî_of_mem‹y_devi˚s
 = 
ƒ_mem_devs
;

377 
°¨t
 +(
smbios_ty≥_16
);

378 *((
u16
 *)
°¨t
) = 0;

380  
°¨t
 + 2;

381 
	}
}

385 
	$smbios_öô_ty≥_17
(*
°¨t
, 
u32
 
size_mb
, 
ö°™˚
)

387 
smbios_ty≥_17
 *
p
 = (smbios_ty≥_17 *)
°¨t
;

388 *
íd
 = (*)
°¨t
 + (
smbios_ty≥_17
);

389 
size_t
 
size
;

390 
°r_ödex
 = 0;

391 
«me
[1024];

393 
p
->
hódî
.
ty≥
 = 17;

394 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_17
);

395 
p
->
hódî
.
h™dÀ
 = 0x1100 + 
ö°™˚
;

397 
p
->
physiˇl_mem‹y_¨øy_h™dÀ
 = 0x1000;

398 
	`£t_fõld_wôh_deÁu…
(17, 
tŸÆ_width
, 64);

399 
	`£t_fõld_wôh_deÁu…
(17, 
d©a_width
, 64);

401 
p
->
size
 = 
size_mb
;

402 
	`£t_fõld_wôh_deÁu…
(17, 
f‹m_Á˘‹
, 0x09);

403 
p
->
devi˚_£t
 = 0;

405 
size
 = 
	`gë_fõld
(17, 
	`off£tof
(
smbios_ty≥_17
, 
devi˚_loˇt‹_°r
),

406 
«me
);

407 i‡(
size
)

408 
	`¢¥ötf
(
«me
 + 
size
 - 1, “ameË- size, "%d", 
ö°™˚
);

410 
	`¢¥ötf
(
«me
, “ame), "DIMM %d", 
ö°™˚
);

412 
	`mem˝y
(
íd
, 
«me
, 
	`°æí
(name) + 1);

413 
íd
 +
	`°æí
(
«me
) + 1;

414 
p
->
devi˚_loˇt‹_°r
 = ++
°r_ödex
;

416 
	`lﬂd_°r_fõld_‹_skù
(17, 
b™k_loˇt‹_°r
);

417 
	`£t_fõld_wôh_deÁu…
(17, 
mem‹y_ty≥
, 0x07);

418 
	`£t_fõld_wôh_deÁu…
(17, 
ty≥_dëaû
, 0);

420 *
íd
 = 0;

421 
íd
++;

422 i‡(!
°r_ödex
) {

423 *
íd
 = 0;

424 
íd
++;

427  
íd
;

428 
	}
}

432 
	$smbios_öô_ty≥_19
(*
°¨t
, 
u32
 
°¨t_mb
, u32 
size_mb
, 
ö°™˚
)

434 
smbios_ty≥_19
 *
p
 = (smbios_ty≥_19 *)
°¨t
;

436 
p
->
hódî
.
ty≥
 = 19;

437 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_19
);

438 
p
->
hódî
.
h™dÀ
 = 0x1300 + 
ö°™˚
;

440 
p
->
°¨tög_addªss
 = 
°¨t_mb
 << 10;

441 
p
->
ídög_addªss
 =Ö->
°¨tög_addªss
 + (
size_mb
 << 10) - 1;

442 
p
->
mem‹y_¨øy_h™dÀ
 = 0x1000;

443 
p
->
∑πôi⁄_width
 = 1;

445 
°¨t
 +(
smbios_ty≥_19
);

446 *((
u16
 *)
°¨t
) = 0;

448  
°¨t
 + 2;

449 
	}
}

453 
	$smbios_öô_ty≥_20
(*
°¨t
, 
u32
 
°¨t_mb
, u32 
size_mb
, 
ö°™˚
,

454 
dev_h™dÀ
, 
¨øy_h™dÀ
)

456 
smbios_ty≥_20
 *
p
 = (smbios_ty≥_20 *)
°¨t
;

458 
p
->
hódî
.
ty≥
 = 20;

459 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_20
);

460 
p
->
hódî
.
h™dÀ
 = 0x1400 + 
ö°™˚
;

462 
p
->
°¨tög_addªss
 = 
°¨t_mb
 << 10;

463 
p
->
ídög_addªss
 =Ö->
°¨tög_addªss
 + (
size_mb
 << 10) - 1;

464 
p
->
mem‹y_devi˚_h™dÀ
 = 0x1100 + 
dev_h™dÀ
;

465 
p
->
mem‹y_¨øy_m≠≥d_addªss_h™dÀ
 = 0x1300 + 
¨øy_h™dÀ
;

466 
p
->
∑πôi⁄_row_posôi⁄
 = 1;

467 
p
->
öãæóve_posôi⁄
 = 0;

468 
p
->
öãæóved_d©a_dïth
 = 0;

470 
°¨t
 +(
smbios_ty≥_20
);

472 *((
u16
 *)
°¨t
) = 0;

473  
°¨t
+2;

474 
	}
}

478 
	$smbios_öô_ty≥_32
(*
°¨t
)

480 
smbios_ty≥_32
 *
p
 = (smbios_ty≥_32 *)
°¨t
;

482 
p
->
hódî
.
ty≥
 = 32;

483 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_32
);

484 
p
->
hódî
.
h™dÀ
 = 0x2000;

485 
	`mem£t
(
p
->
ª£rved
, 0, 6);

486 
	`£t_fõld_wôh_deÁu…
(32, 
boŸ_°©us
, 0);

488 
°¨t
 +(
smbios_ty≥_32
);

489 *((
u16
 *)
°¨t
) = 0;

491  
°¨t
+2;

492 
	}
}

496 
	$smbios_öô_ty≥_127
(*
°¨t
)

498 
smbios_ty≥_127
 *
p
 = (smbios_ty≥_127 *)
°¨t
;

500 
p
->
hódî
.
ty≥
 = 127;

501 
p
->
hódî
.
Àngth
 = (
smbios_ty≥_127
);

502 
p
->
hódî
.
h™dÀ
 = 0x7f00;

504 
°¨t
 +(
smbios_ty≥_127
);

505 *((
u16
 *)
°¨t
) = 0;

507  
°¨t
 + 2;

508 
	}
}

510 
	#TEMPSMBIOSSIZE
 (32 * 1024)

	)

513 
	$smbios_£tup
()

515 i‡(! 
CONFIG_SMBIOS
)

518 
	`d¥ötf
(3, "init SMBIOSÅables\n");

520 *
°¨t
 = 
	`mÆloc_tmphigh
(
TEMPSMBIOSSIZE
);

521 i‡(! 
°¨t
) {

522 
	`w¨n_nﬂŒoc
();

525 
	`mem£t
(
°¨t
, 0, 
TEMPSMBIOSSIZE
);

527 
u32
 
ƒ_°ru˘s
 = 0, 
max_°ru˘_size
 = 0;

528 *
q
, *
p
 = 
°¨t
;

529 *
íd
 = 
°¨t
 + 
TEMPSMBIOSSIZE
 - (
smbios_ty≥_127
);

531 
	#add_°ru˘
(
ty≥
, 
¨gs
...) \

533 i‡(!
	`gë_exã∫Æ
(
ty≥
, &
p
, &
ƒ_°ru˘s
, &
max_°ru˘_size
, 
íd
)) { \

534 
q
 = 
smbios_öô_ty≥_
##
	`ty≥
(
¨gs
); \

535 
ƒ_°ru˘s
++; \

536 i‡((
q
 - 
p
Ë> 
max_°ru˘_size
) \

537 
max_°ru˘_size
 = 
q
 - 
p
; \

538 
p
 = 
q
; \

540 } 0)

	)

542 
	`add_°ru˘
(0, 
p
);

543 
	`add_°ru˘
(1, 
p
);

544 
	`add_°ru˘
(3, 
p
);

546 
˝u_num
;

547 
˝u_num
 = 1; cpu_num <
MaxCou¡CPUs
; cpu_num++)

548 
	`add_°ru˘
(4, 
p
, 
˝u_num
);

550 
øm_mb
 = (
RamSize
 + 
RamSizeOvî4G
) >> 20;

551 
ƒ_mem_devs
 = (
øm_mb
 + 0x3fff) >> 14;

552 
	`add_°ru˘
(16, 
p
, 
øm_mb
, 
ƒ_mem_devs
);

554 
i
, 
j
;

555 
i
 = 0; i < 
ƒ_mem_devs
; i++) {

556 
u32
 
dev_mb
 = ((
i
 =(
ƒ_mem_devs
 - 1))

557 ? (((
øm_mb
 - 1) & 0x3fff) + 1)

559 
	`add_°ru˘
(17, 
p
, 
dev_mb
, 
i
);

562 
	`add_°ru˘
(19, 
p
, 0, 
RamSize
 >> 20, 0);

563 i‡(
RamSizeOvî4G
)

564 
	`add_°ru˘
(19, 
p
, 4096, 
RamSizeOvî4G
 >> 20, 1);

566 
	`add_°ru˘
(20, 
p
, 0, 
RamSize
 >> 20, 0, 0, 0);

567 i‡(
RamSizeOvî4G
) {

568 
u32
 
°¨t_mb
 = 4096;

569 
j
 = 1, 
i
 = 0; i < 
ƒ_mem_devs
; i++, j++) {

570 
u32
 
dev_mb
 = ((
i
 =(
ƒ_mem_devs
 - 1))

571 ? (((
øm_mb
 - 1) & 0x3fff) + 1)

573 i‡(
i
 == 0)

574 
dev_mb
 -
RamSize
 >> 20;

576 
	`add_°ru˘
(20, 
p
, 
°¨t_mb
, 
dev_mb
, 
j
, 
i
, 1);

577 
°¨t_mb
 +
dev_mb
;

581 
	`add_°ru˘
(32, 
p
);

583 
i
 = 0; i < 256; i++)

584 
	`gë_exã∫Æ
(
i
, &
p
, &
ƒ_°ru˘s
, &
max_°ru˘_size
, 
íd
);

585 
	`add_°ru˘
(127, 
p
);

587 #unde‡
add_°ru˘


589 
	`smbios_íåy_poöt_£tup
(
max_°ru˘_size
, 
p
 - 
°¨t
, sèπ, 
ƒ_°ru˘s
);

590 
	`‰ì
(
°¨t
);

591 
	}
}

594 
	$di•œy_uuid
()

596 
u32
 
addr
, 
íd
;

597 
u8
 *
uuid
;

598 
u8
 
em±y_uuid
[16] = { 0 };

600 i‡(
SMBiosAddr
 =
NULL
)

603 
addr
 = 
SMBiosAddr
->
°ru˘uª_èbÀ_addªss
;

604 
íd
 = 
addr
 + 
SMBiosAddr
->
°ru˘uª_èbÀ_Àngth
;

607 
addr
 < 
íd
) {

608 c⁄° 
smbios_°ru˘uª_hódî
 *
hdr
;

611 i‡(
íd
 - 
addr
 < (
smbios_°ru˘uª_hódî
))

614 
hdr
 = (
smbios_°ru˘uª_hódî
 *)
addr
;

617 i‡(
íd
 - 
addr
 < 
hdr
->
Àngth
)

621 i‡(
hdr
->
ty≥
 == 1 &&

622 
hdr
->
Àngth
 >
	`off£tof
(
smbios_ty≥_1
, 
uuid
) + 16)

626 
addr
 +
hdr
->
Àngth
;

628 
íd
 - 
addr
 >= 2 &&

629 (*(
u8
 *)
addr
 != '\0' ||

630 *(
u8
 *)(
addr
+1) != '\0'))

631 ++
addr
;

634 i‡(
íd
 - 
addr
 < 2)

637 
addr
 += 2;

641 i‡(
addr
 >
íd
)

644 
uuid
 = (
u8
 *)(
addr
 + 
	`off£tof
(
smbios_ty≥_1
, uuid));

645 i‡(
	`memcmp
(
uuid
, 
em±y_uuid
, Émpty_uuid) == 0)

648 
	`¥ötf
("Machine UUID"

654 , 
uuid
[ 0], uuid[ 1], uuid[ 2], uuid[ 3]

655 , 
uuid
[ 4], uuid[ 5]

656 , 
uuid
[ 6], uuid[ 7]

657 , 
uuid
[ 8], uuid[ 9]

658 , 
uuid
[10], uuid[11], uuid[12], uuid[13], uuid[14], uuid[15]);

659 
	}
}

	@fw/smm.c

8 
	~"c⁄fig.h
"

9 
	~"dev-q35.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pci_ids.h
"

12 
	~"hw/pci_ªgs.h
"

13 
	~"ouçut.h
"

14 
	~"∑øvút.h
"

15 
	~"°rög.h
"

16 
	~"utû.h
"

17 
	~"x86.h
"

19 
u8
 
smm_ªloˇti⁄_°¨t
, 
smm_ªloˇti⁄_íd
;

20 
ASM32FLAT
(

26 " mov»$" 
__°rögify
(
BUILD_SMM_INIT_ADDR
) " + 0x7efc, %ebx\n"

30 " mov»$" 
__°rögify
(
BUILD_SMM_INIT_ADDR
) " + 0x7ef8, %ebx\n"

33 " mov»$" 
__°rögify
(
BUILD_SMM_INIT_ADDR
) " + 0x7f00, %ebx\n"

35 " mov»$" 
__°rögify
(
BUILD_SMM_ADDR
) " - 0x8000, %eax\n"

39 " movw $" 
__°rögify
(
PORT_SMI_STATUS
) ", %dx\n"

46 
u8
 
smm_code_°¨t
, 
smm_code_íd
;

47 
ASM32FLAT
(

52 " movw $" 
__°rögify
(
PORT_SMI_CMD
) ", %dx\n"

58 " movw $" 
__°rögify
(
PORT_ACPI_PM_BASE
) " + 0x04, %dx\n"

70 " movw $" 
__°rögify
(
PORT_ACPI_PM_BASE
) " + 0x04, %dx\n"

82 
	$smm_ßve_™d_c›y
()

85 
	`mem˝y
((*)
BUILD_SMM_ADDR
, (*)
BUILD_SMM_INIT_ADDR
, 
BUILD_SMM_SIZE
);

88 
	`mem˝y
((*)
BUILD_SMM_INIT_ADDR
, &
smm_ªloˇti⁄_°¨t
,

89 &
smm_ªloˇti⁄_íd
 - &
smm_ªloˇti⁄_°¨t
);

90 
	}
}

93 
	$smm_ªloˇã_™d_ª°‹e
()

96 
	`outb
(0x01, 
PORT_SMI_STATUS
);

99 
	`outb
(0x00, 
PORT_SMI_CMD
);

102 
	`öb
(
PORT_SMI_STATUS
) != 0x00)

106 
	`mem˝y
((*)
BUILD_SMM_INIT_ADDR
, (*)
BUILD_SMM_ADDR
, 
BUILD_SMM_SIZE
);

109 
	`mem˝y
((*)
BUILD_SMM_ADDR
, &
smm_code_°¨t


110 , &
smm_code_íd
 - &
smm_code_°¨t
);

111 
	`wbövd
();

112 
	}
}

114 
	#I440FX_SMRAM
 0x72

	)

115 
	#PIIX_DEVACTB
 0x58

	)

116 
	#PIIX_APMC_EN
 (1 << 25)

	)

119 
	$piix4_≠mc_smm_£tup
(
ißbdf
, 
i440_bdf
)

122 
u32
 
vÆue
 = 
	`pci_c⁄fig_ªadl
(
ißbdf
, 
PIIX_DEVACTB
);

123 i‡(
vÆue
 & 
PIIX_APMC_EN
)

127 
	`pci_c⁄fig_wrôeb
(
i440_bdf
, 
I440FX_SMRAM
, 0x02 | 0x48);

129 
	`smm_ßve_™d_c›y
();

132 
	`pci_c⁄fig_wrôñ
(
ißbdf
, 
PIIX_DEVACTB
, 
vÆue
 | 
PIIX_APMC_EN
);

134 
	`smm_ªloˇã_™d_ª°‹e
();

137 
	`pci_c⁄fig_wrôeb
(
i440_bdf
, 
I440FX_SMRAM
, 0x02 | 0x08);

138 
	}
}

141 
	$ich9_Õc_≠mc_smm_£tup
(
ißbdf
, 
mch_bdf
)

144 
u32
 
vÆue
 = 
	`öl
(
PORT_ACPI_PM_BASE
 + 
ICH9_PMIO_SMI_EN
);

145 i‡(
vÆue
 & 
ICH9_PMIO_SMI_EN_APMC_EN
)

149 
	`pci_c⁄fig_wrôeb
(
mch_bdf
, 
Q35_HOST_BRIDGE_SMRAM
, 0x02 | 0x48);

151 
	`smm_ßve_™d_c›y
();

154 
	`oué
(
vÆue
 | 
ICH9_PMIO_SMI_EN_APMC_EN
,

155 
PORT_ACPI_PM_BASE
 + 
ICH9_PMIO_SMI_EN
);

157 
	`smm_ªloˇã_™d_ª°‹e
();

160 
	`pci_c⁄fig_wrôeb
(
mch_bdf
, 
Q35_HOST_BRIDGE_SMRAM
, 0x02 | 0x08);

161 
	}
}

163 
	gSMMISADevi˚BDF
 = -1, 
	gSMMPMDevi˚BDF
 = -1;

166 
	$smm_devi˚_£tup
()

168 i‡(!
CONFIG_USE_SMM
)

171 
pci_devi˚
 *
ißpci
, *
pmpci
;

172 
ißpci
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82371AB_3
);

173 
pmpci
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_82441
);

174 i‡(
ißpci
 && 
pmpci
) {

175 
SMMISADevi˚BDF
 = 
ißpci
->
bdf
;

176 
SMMPMDevi˚BDF
 = 
pmpci
->
bdf
;

179 
ißpci
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_ICH9_LPC
);

180 
pmpci
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL_Q35_MCH
);

181 i‡(
ißpci
 && 
pmpci
) {

182 
SMMISADevi˚BDF
 = 
ißpci
->
bdf
;

183 
SMMPMDevi˚BDF
 = 
pmpci
->
bdf
;

185 
	}
}

188 
	$smm_£tup
()

190 i‡(!
CONFIG_USE_SMM
 || 
SMMISADevi˚BDF
 < 0)

193 
	`d¥ötf
(3, "init smm\n");

194 
u16
 
devi˚
 = 
	`pci_c⁄fig_ªadw
(
SMMISADevi˚BDF
, 
PCI_DEVICE_ID
);

195 i‡(
devi˚
 =
PCI_DEVICE_ID_INTEL_82371AB_3
)

196 
	`piix4_≠mc_smm_£tup
(
SMMISADevi˚BDF
, 
SMMPMDevi˚BDF
);

198 
	`ich9_Õc_≠mc_smm_£tup
(
SMMISADevi˚BDF
, 
SMMPMDevi˚BDF
);

199 
	}
}

	@fw/smp.c

8 
	~"c⁄fig.h
"

9 
	~"hw/πc.h
"

10 
	~"ouçut.h
"

11 
	~"romfûe.h
"

12 
	~"°acks.h
"

13 
	~"utû.h
"

14 
	~"x86.h
"

16 
	#APIC_ICR_LOW
 ((
u8
*)
BUILD_APIC_ADDR
 + 0x300)

	)

17 
	#APIC_SVR
 ((
u8
*)
BUILD_APIC_ADDR
 + 0x0F0)

	)

18 
	#APIC_LINT0
 ((
u8
*)
BUILD_APIC_ADDR
 + 0x350)

	)

19 
	#APIC_LINT1
 ((
u8
*)
BUILD_APIC_ADDR
 + 0x360)

	)

21 
	#APIC_ENABLED
 0x0100

	)

23 °ru˘ { 
u32
 
	mecx
, 
	móx
, 
	medx
; } 
	gsmp_mår
[32] 
	gVARFSEG
;

24 
u32
 
smp_mår_cou¡
 
	gVARFSEG
;

27 
	$wrm§_smp
(
u32
 
ödex
, 
u64
 
vÆ
)

29 
	`wrm§
(
ödex
, 
vÆ
);

30 i‡(
smp_mår_cou¡
 >
	`ARRAY_SIZE
(
smp_mår
)) {

31 
	`w¨n_nﬂŒoc
();

34 
smp_mår
[
smp_mår_cou¡
].
ecx
 = 
ödex
;

35 
smp_mår
[
smp_mår_cou¡
].
óx
 = 
vÆ
;

36 
smp_mår
[
smp_mår_cou¡
].
edx
 = 
vÆ
 >> 32;

37 
smp_mår_cou¡
++;

38 
	}
}

40 
u32
 
Cou¡CPUs
 
	gVARFSEG
;

41 
u32
 
	gMaxCou¡CPUs
;

43 
u32
 
	gFoundAPICIDs
[256/32] 
	gVARFSEG
;

44 
smp_≠_boŸ_code
();

45 
ASM16
(

50 " movw $" 
__°rögify
(
SEG_BIOS
) ", %ax\n"

81 
	$≠ic_id_is_¥e£¡
(
u8
 
≠ic_id
)

83  !!(
FoundAPICIDs
[
≠ic_id
/32] & (1ul << (apic_id % 32)));

84 
	}
}

88 
	$smp_£tup
()

90 i‡(!
CONFIG_QEMU
)

93 
	`ASSERT32FLAT
();

94 
u32
 
óx
, 
ebx
, 
ecx
, 
˝uid_„©uªs
;

95 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
˝uid_„©uªs
);

96 i‡(
óx
 < 1 || !(
˝uid_„©uªs
 & 
CPUID_APIC
)) {

98 
	`d¥ötf
(1, "Noápic - onlyÅhe main cpu isÖresent.\n");

99 
Cou¡CPUs
= 1;

100 
MaxCou¡CPUs
 = 1;

105 
u8
 
≠ic_id
 = 
ebx
>>24;

106 
FoundAPICIDs
[
≠ic_id
/32] |= (1 << (apic_id % 32));

109 
	`wrôñ
(&
Cou¡CPUs
, 1);

112 
u64
 
ﬁd
 = *(u64*)
BUILD_AP_BOOT_ADDR
;

114 
u64
 
√w
 = (0xó | ((u64)
SEG_BIOS
<<24)

115 | (((
u32
)
smp_≠_boŸ_code
 - 
BUILD_BIOS_ADDR
) << 8));

116 *(
u64
*)
BUILD_AP_BOOT_ADDR
 = 
√w
;

119 
u32
 
vÆ
 = 
	`ªadl
(
APIC_SVR
);

120 
	`wrôñ
(
APIC_SVR
, 
vÆ
 | 
APIC_ENABLED
);

123 
	`wrôñ
(
APIC_LINT0
, 0x8700);

126 
	`wrôñ
(
APIC_LINT1
, 0x8400);

129 
	`b¨rõr
();

130 
	`wrôñ
(
APIC_ICR_LOW
, 0x000C4500);

131 
u32
 
sùi_ve˘‹
 = 
BUILD_AP_BOOT_ADDR
 >> 12;

132 
	`wrôñ
(
APIC_ICR_LOW
, 0x000C4600 | 
sùi_ve˘‹
);

135 
u8
 
cmos_smp_cou¡
 = 
	`πc_ªad
(
CMOS_BIOS_SMP_COUNT
);

136 
cmos_smp_cou¡
 + 1 !
	`ªadl
(&
Cou¡CPUs
))

137 
	`yõld
();

140 *(
u64
*)
BUILD_AP_BOOT_ADDR
 = 
ﬁd
;

142 
MaxCou¡CPUs
 = 
	`romfûe_lﬂdöt
("etc/max-cpus", 0);

143 i‡(!
MaxCou¡CPUs
 || MaxCou¡CPU†< 
Cou¡CPUs
)

144 
MaxCou¡CPUs
 = 
Cou¡CPUs
;

146 
	`d¥ötf
(1, "Found %d cpu(sËmax suµ‹ãd %d cpu(s)\n", 
	`ªadl
(&
Cou¡CPUs
),

147 
MaxCou¡CPUs
);

148 
	}
}

	@fw/xen.c

7 
	~"c⁄fig.h
"

8 
	~"hw/£rülio.h
"

9 
	~"mÆloc.h
"

10 
	~"memm≠.h
"

11 
	~"ouçut.h
"

12 
	~"∑øvút.h
"

13 
	~"°rög.h
"

14 
	~"utû.h
"

15 
	~"x86.h
"

16 
	~"xí.h
"

18 
	#INFO_PHYSICAL_ADDRESS
 0x00001000

	)

20 
u32
 
	gxí_˝uid_ba£
 = 0;

21 
	gxí_hy≥rˇŒ_∑ge
 = 0;

23 
	sxí_£abios_öfo
 {

24 
	msig«tuª
[14];

25 
u8
 
	mÀngth
;

26 
u8
 
	mchecksum
;

33 
u32
 
	mèbÀs
;

34 
u32
 
	mèbÀs_ƒ
;

38 
u32
 
	me820
;

39 
u32
 
	me820_ƒ
;

40 } 
	gPACKED
;

42 
	$vÆid©e_öfo
(
xí_£abios_öfo
 *
t
)

44 i‡–
	`memcmp
(
t
->
sig«tuª
, "XenHVMSeaBIOS", 14) )

45 
	`∑nic
("Bad Xen info signature\n");

47 i‡–
t
->
Àngth
 < (
xí_£abios_öfo
) )

48 
	`∑nic
("Bad Xen infoÜength\n");

50 i‡(
	`checksum
(
t
,Å->
Àngth
) != 0)

51 
	`∑nic
("Bad Xen info checksum\n");

52 
	}
}

54 
	$xí_¥eöô
()

56 
u32
 
ba£
, 
óx
, 
ebx
, 
ecx
, 
edx
;

57 
sig«tuª
[13];

59 i‡(!
CONFIG_XEN
)

62 
ba£
 = 0x40000000; base < 0x40010000; base += 0x100) {

63 
	`˝uid
(
ba£
, &
óx
, &
ebx
, &
ecx
, &
edx
);

64 
	`mem˝y
(
sig«tuª
 + 0, &
ebx
, 4);

65 
	`mem˝y
(
sig«tuª
 + 4, &
ecx
, 4);

66 
	`mem˝y
(
sig«tuª
 + 8, &
edx
, 4);

67 
sig«tuª
[12] = 0;

69 
	`d¥ötf
(9, "Found hypervisor signature \"%s\"át %x\n",

70 
sig«tuª
, 
ba£
);

71 i‡(
	`°rcmp
(
sig«tuª
, "XenVMMXenVMM") == 0) {

73 
DebugOuçutP‹t
 = 0xe9;

74 
	`debug_b™√r
();

75 
	`d¥ötf
(1, "\nFound Xí hy≥rvis‹ sig«tuªáà%x\n", 
ba£
);

76 i‡((
óx
 - 
ba£
) < 2)

77 
	`∑nic
("Insufficient Xen cpuidÜeaves.Éax=%xát base %x\n",

78 
óx
, 
ba£
);

79 
xí_˝uid_ba£
 = 
ba£
;

83 i‡(!
xí_˝uid_ba£
) {

84 
	`d¥ötf
(1, "No Xen hypervisor found.\n");

87 
Pœtf‹mRu¬ögOn
 = 
PF_QEMU
|
PF_XEN
;

88 
	}
}

90 
	$hy≥rˇŒ_xí_vîsi⁄
–
cmd
, *
¨g
)

92  
	`_hy≥rˇŒ2
(, 
xí_vîsi⁄
, 
cmd
, 
¨g
);

93 
	}
}

96 
	$xí_hy≥rˇŒ_£tup
()

98 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
;

99 
xí_exåavîsi⁄_t
 
exåavîsi⁄
;

100 
i
;

102 i‡(!
	`ru¬ögOnXí
())

105 
	`˝uid
(
xí_˝uid_ba£
 + 2, &
óx
, &
ebx
, &
ecx
, &
edx
);

107 
xí_hy≥rˇŒ_∑ge
 = ()
	`memÆign_high
(
PAGE_SIZE
, 
óx
*PAGE_SIZE);

108 i‡(!
xí_hy≥rˇŒ_∑ge
)

109 
	`∑nic
("unableÅoállocate Xen hypercallÖage\n");

111 
	`d¥ötf
(1, "AŒoˇãd Xí hy≥rˇŒÖagê© %lx\n", 
xí_hy≥rˇŒ_∑ge
);

112  
i
 = 0; i < 
óx
; i++ )

113 
	`wrm§
(
ebx
, 
xí_hy≥rˇŒ_∑ge
 + (
i
 << 12) + i);

116 
	`˝uid
(
xí_˝uid_ba£
 + 1, &
óx
, &
ebx
, &
ecx
, &
edx
);

117 
	`hy≥rˇŒ_xí_vîsi⁄
(
XENVER_exåavîsi⁄
, 
exåavîsi⁄
);

118 
	`d¥ötf
(1, "Dëe˘ed Xí v%u.%u%s\n", 
óx
 >> 16,Éax & 0xffff, 
exåavîsi⁄
);

119 
	}
}

121 
	$xí_bio°abÀ_£tup
()

123 
xí_£abios_öfo
 *
öfo
 = (*)
INFO_PHYSICAL_ADDRESS
;

124 **
èbÀs
 = (*)
öfo
->tables;

125 
i
;

127 
	`d¥ötf
(1, "xen: copy BIOSÅables...\n");

128 
i
=0; i<
öfo
->
èbÀs_ƒ
; i++)

129 
	`c›y_èbÀ
(
èbÀs
[
i
]);

131 
	`föd_a˝i_„©uªs
();

132 
	}
}

134 
	$xí_ømsize_¥eöô
()

136 
i
;

137 
xí_£abios_öfo
 *
öfo
 = (*)
INFO_PHYSICAL_ADDRESS
;

138 
e820íåy
 *
e820
 = (e820íåy *)
öfo
->e820;

139 
	`vÆid©e_öfo
(
öfo
);

141 
	`d¥ötf
(1, "xen: copyÉ820...\n");

143 
i
 = 0; i < 
öfo
->
e820_ƒ
; i++) {

144 
e820íåy
 *
e
 = &
e820
[
i
];

145 
	`add_e820
(
e
->
°¨t
,É->
size
,É->
ty≥
);

147 
	}
}

	@fw/xen.h

1 #i‚de‡
__XEN_H


2 
	#__XEN_H


	)

4 
xí_¥eöô
();

5 
xí_ømsize_¥eöô
();

6 
xí_hy≥rˇŒ_£tup
();

7 
xí_bio°abÀ_£tup
();

9 
xí_hy≥rˇŒ_∑ge
;

11 
	#_hy≥rˇŒ0
(
ty≥
, 
«me
) \

13 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

14 
__ªs
; \

15 
asm
 volatile ( \

17 : "˜" (
__ªs
) \

18 : "0" (
__híåy
) \

20 (
ty≥
)
__ªs
; \

21 })

	)

23 
	#_hy≥rˇŒ1
(
ty≥
, 
«me
, 
a1
) \

25 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

26 
__ªs
, 
__ign1
; \

27 
asm
 volatile ( \

29 : "˜" (
__ªs
), "=b" (
__ign1
) \

30 : "0" (
__híåy
), "1" (()(
a1
)) \

32 (
ty≥
)
__ªs
; \

33 })

	)

35 
	#_hy≥rˇŒ2
(
ty≥
, 
«me
, 
a1
, 
a2
) \

37 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

38 
__ªs
, 
__ign1
, 
__ign2
; \

39 
asm
 volatile ( \

41 : "˜" (
__ªs
), "=b" (
__ign1
), "=c" (
__ign2
) \

42 : "0" (
__híåy
), "1" (()(
a1
)), "2" (()(
a2
)) \

44 (
ty≥
)
__ªs
; \

45 })

	)

47 
	#_hy≥rˇŒ3
(
ty≥
, 
«me
, 
a1
, 
a2
, 
a3
) \

49 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

50 
__ªs
, 
__ign1
, 
__ign2
, 
__ign3
; \

51 
asm
 volatile ( \

53 : "˜" (
__ªs
), "=b" (
__ign1
), "=c" (
__ign2
), \

54 "=d" (
__ign3
) \

55 : "0" (
__híåy
), "1" (()(
a1
)), "2" (()(
a2
)), \

56 "3" (()(
a3
)) \

58 (
ty≥
)
__ªs
; \

59 })

	)

61 
	#_hy≥rˇŒ4
(
ty≥
, 
«me
, 
a1
, 
a2
, 
a3
, 
a4
) \

63 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

64 
__ªs
, 
__ign1
, 
__ign2
, 
__ign3
, 
__ign4
; \

65 
asm
 volatile ( \

67 : "˜" (
__ªs
), "=b" (
__ign1
), "=c" (
__ign2
), \

68 "=d" (
__ign3
), "=S" (
__ign4
) \

69 : "0" (
__híåy
), "1" (()(
a1
)), "2" (()(
a2
)), \

70 "3" (()(
a3
)), "4" (()(
a4
)) \

72 (
ty≥
)
__ªs
; \

73 })

	)

75 
	#_hy≥rˇŒ5
(
ty≥
, 
«me
, 
a1
, 
a2
, 
a3
, 
a4
, 
a5
) \

77 
__híåy
 = 
xí_hy≥rˇŒ_∑ge
+
__HYPERVISOR_
##
«me
*32; \

78 
__ªs
, 
__ign1
, 
__ign2
, 
__ign3
, 
__ign4
, 
__ign5
; \

79 
asm
 volatile ( \

81 : "˜" (
__ªs
), "=b" (
__ign1
), "=c" (
__ign2
), \

82 "=d" (
__ign3
), "=S" (
__ign4
), "=D" (
__ign5
) \

83 : "0" (
__híåy
), "1" (()(
a1
)), "2" (()(
a2
)), \

84 "3" (()(
a3
)), "4" (()(
a4
)), \

85 "5" (()(
a5
)) \

87 (
ty≥
)
__ªs
; \

88 })

	)

116 
	#__HYPERVISOR_xí_vîsi⁄
 17

	)

121 
	#XENVER_exåavîsi⁄
 1

	)

122 
	txí_exåavîsi⁄_t
[16];

123 
	#XEN_EXTRAVERSION_LEN
 ((
xí_exåavîsi⁄_t
))

	)

	@gen-defs.h

3 #i‚de‡
__GEN_DEFS_H


4 
	#__GEN_DEFS_H


	)

7 
	#DEFINE
(
sym
, 
vÆ
) \

8 
asm
 vﬁ©ûe("\n->" #sym " %0 " #vÆ : : "i" (
vÆ
))

	)

10 
	#BLANK
() \

11 
asm
 vﬁ©ûe("\n->" : : )

	)

13 
	#OFFSET
(
sym
, 
°r
, 
mem
) \

14 
	`DEFINE
(
sym
, 
	`off£tof
(
°r
, 
mem
))

	)

16 
	#COMMENT
(
x
) \

17 
asm
 vﬁ©ûe("\n->#" 
x
)

	)

	@hw/ahci.c

7 
	~"ahci.h
"

8 
	~"©a.h
"

9 
	~"biosv¨.h
"

10 
	~"blockcmd.h
"

11 
	~"mÆloc.h
"

12 
	~"ouçut.h
"

13 
	~"pci.h
"

14 
	~"pci_ids.h
"

15 
	~"pci_ªgs.h
"

16 
	~"°acks.h
"

17 
	~"°d/disk.h
"

18 
	~"°rög.h
"

19 
	~"utû.h
"

20 
	~"x86.h
"

22 
	#AHCI_REQUEST_TIMEOUT
 32000

23 
	#AHCI_RESET_TIMEOUT
 500

24 
	#AHCI_LINK_TIMEOUT
 10

25 

	)

27 
	$ßè_¥ï_sim∂e
(
ßè_cmd_fis
 *
fis
, 
u8
 
comm™d
)

29 
	`mem£t_Ê
(
fis
, 0, (*fis));

30 
fis
->
comm™d
 = command;

31 
	}
}

33 
	$ßè_¥ï_ªadwrôe
(
ßè_cmd_fis
 *
fis
,

34 
disk_›_s
 *
›
, 
iswrôe
)

36 
u64
 
lba
 = 
›
->lba;

37 
u8
 
comm™d
;

39 
	`mem£t_Ê
(
fis
, 0, (*fis));

41 i‡(
›
->
cou¡
 >(1<<8Ë|| 
lba
 + op->count >= (1<<28)) {

42 
fis
->
£˘‹_cou¡2
 = 
›
->
cou¡
 >> 8;

43 
fis
->
lba_low2
 = 
lba
 >> 24;

44 
fis
->
lba_mid2
 = 
lba
 >> 32;

45 
fis
->
lba_high2
 = 
lba
 >> 40;

46 
lba
 &= 0xffffff;

47 
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_DMA_EXT


48 : 
ATA_CMD_READ_DMA_EXT
);

50 
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_DMA


51 : 
ATA_CMD_READ_DMA
);

53 
fis
->
„©uª
 = 1;

54 
fis
->
comm™d
 = command;

55 
fis
->
£˘‹_cou¡
 = 
›
->
cou¡
;

56 
fis
->
lba_low
 = 
lba
;

57 
fis
->
lba_mid
 = 
lba
 >> 8;

58 
fis
->
lba_high
 = 
lba
 >> 16;

59 
fis
->
devi˚
 = ((
lba
 >> 24Ë& 0xfË| 
ATA_CB_DH_LBA
;

60 
	}
}

62 
	$ßè_¥ï_©≠i
(
ßè_cmd_fis
 *
fis
, 
u16
 
blocksize
)

64 
	`mem£t_Ê
(
fis
, 0, (*fis));

65 
fis
->
comm™d
 = 
ATA_CMD_PACKET
;

66 
fis
->
„©uª
 = 1;

67 
fis
->
lba_mid
 = 
blocksize
;

68 
fis
->
lba_high
 = 
blocksize
 >> 8;

69 
	}
}

72 
u32
 
	$ahci_˘æ_ªadl
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
ªg
)

74 
u32
 
addr
 = 
˘æ
->
ioba£
 + 
ªg
;

75  
	`ªadl
((*)
addr
);

76 
	}
}

78 
	$ahci_˘æ_wrôñ
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
ªg
, u32 
vÆ
)

80 
u32
 
addr
 = 
˘æ
->
ioba£
 + 
ªg
;

81 
	`wrôñ
((*)
addr
, 
vÆ
);

82 
	}
}

84 
u32
 
	$ahci_p‹t_to_˘æ
(
u32
 
≤r
, u32 
p‹t_ªg
)

86 
u32
 
˘æ_ªg
 = 0x100;

87 
˘æ_ªg
 +
≤r
 * 0x80;

88 
˘æ_ªg
 +
p‹t_ªg
;

89  
˘æ_ªg
;

90 
	}
}

92 
u32
 
	$ahci_p‹t_ªadl
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
≤r
, u32 
ªg
)

94 
u32
 
˘æ_ªg
 = 
	`ahci_p‹t_to_˘æ
(
≤r
, 
ªg
);

95  
	`ahci_˘æ_ªadl
(
˘æ
, 
˘æ_ªg
);

96 
	}
}

98 
	$ahci_p‹t_wrôñ
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
≤r
, u32 
ªg
, u32 
vÆ
)

100 
u32
 
˘æ_ªg
 = 
	`ahci_p‹t_to_˘æ
(
≤r
, 
ªg
);

101 
	`ahci_˘æ_wrôñ
(
˘æ
, 
˘æ_ªg
, 
vÆ
);

102 
	}
}

105 
	$ahci_comm™d
(
ahci_p‹t_s
 *
p‹t_gf
, 
iswrôe
, 
ißèpi
,

106 *
buf„r
, 
u32
 
bsize
)

108 
u32
 
vÆ
, 
°©us
, 
suc˚ss
, 
Êags
, 
ötbôs
, 
îr‹
;

109 
ahci_˘æ_s
 *
˘æ
 = 
p‹t_gf
->ctrl;

110 
ahci_cmd_s
 *
cmd
 = 
p‹t_gf
->cmd;

111 
ahci_fis_s
 *
fis
 = 
p‹t_gf
->fis;

112 
ahci_li°_s
 *
li°
 = 
p‹t_gf
->list;

113 
u32
 
≤r
 = 
p‹t_gf
->pnr;

115 
cmd
->
fis
.
ªg
 = 0x27;

116 
cmd
->
fis
.
pmp_ty≥
 = 1 << 7;

117 
cmd
->
¥dt
[0].
ba£
 = (
u32
)
buf„r
;

118 
cmd
->
¥dt
[0].
ba£u
 = 0;

119 
cmd
->
¥dt
[0].
Êags
 = 
bsize
-1;

121 
Êags
 = ((1 << 16) |

122 (
iswrôe
 ? (1 << 6) : 0) |

123 (
ißèpi
 ? (1 << 5) : 0) |

125 
li°
[0].
Êags
 = flags;

126 
li°
[0].
byãs
 = 0;

127 
li°
[0].
ba£
 = (
u32
)(
cmd
);

128 
li°
[0].
ba£u
 = 0;

130 
	`d¥ötf
(8, "AHCI/%d: síd cmd ...\n", 
≤r
);

131 
ötbôs
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
);

132 i‡(
ötbôs
)

133 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
, 
ötbôs
);

134 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_SCR_ACT
, 1);

135 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD_ISSUE
, 1);

137 
u32
 
íd
 = 
	`timî_ˇlc
(
AHCI_REQUEST_TIMEOUT
);

140 
ötbôs
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
);

141 i‡(
ötbôs
) {

142 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
, 
ötbôs
);

143 i‡(
ötbôs
 & 0x02) {

144 
°©us
 = 
	`GET_LOWFLAT
(
fis
->
psfis
[2]);

145 
îr‹
 = 
	`GET_LOWFLAT
(
fis
->
psfis
[3]);

148 i‡(
ötbôs
 & 0x01) {

149 
°©us
 = 
	`GET_LOWFLAT
(
fis
->
rfis
[2]);

150 
îr‹
 = 
	`GET_LOWFLAT
(
fis
->
rfis
[3]);

154 i‡(
	`timî_check
(
íd
)) {

155 
	`w¨n_timeout
();

158 
	`yõld
();

160 
	`d¥ötf
(8, "AHCI/%d: ... intbits 0x%x, status 0x%x ...\n",

161 
≤r
, 
ötbôs
, 
°©us
);

162 } 
°©us
 & 
ATA_CB_STAT_BSY
);

164 
suc˚ss
 = (0x00 =(
°©us
 & (
ATA_CB_STAT_BSY
 | 
ATA_CB_STAT_DF
 |

165 
ATA_CB_STAT_ERR
)) &&

166 
ATA_CB_STAT_RDY
 =(
°©us
 & (ATA_CB_STAT_RDY)));

167 i‡(
suc˚ss
) {

168 
	`d¥ötf
(8, "AHCI/%d: ... föished, sètu†0x%x, OK\n", 
≤r
,

169 
°©us
);

171 
	`d¥ötf
(2, "AHCI/%d: ... föished, sètu†0x%x, ERROR 0x%x\n", 
≤r
,

172 
°©us
, 
îr‹
);

176 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_CMD
);

177 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
vÆ
 & ~
PORT_CMD_START
);

181 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_CMD
);

182 i‡((
vÆ
 & 
PORT_CMD_LIST_ON
) == 0)

184 
	`yõld
();

188 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_SCR_ERR
);

189 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_SCR_ERR
, 
vÆ
);

192 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
);

193 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
, 
vÆ
);

197 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_TFDATA
);

198 i‡(
vÆ
 & (
ATA_CB_STAT_BSY
 | 
ATA_CB_STAT_DRQ
)) {

199 
	`d¥ötf
(2, "AHCI/%d: issuêcomª£t\n", 
≤r
);

200 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_SCR_CTL
);

202 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_SCR_CTL
, 
vÆ
 | 1);

203 
	`mdñay
 (1);

204 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_SCR_CTL
, 
vÆ
);

208 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_CMD
);

209 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
vÆ
 | 
PORT_CMD_START
);

211  
suc˚ss
 ? 0 : -1;

212 
	}
}

214 
	#CDROM_CDB_SIZE
 12

	)

216 
	$ahci_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

218 i‡(! 
CONFIG_AHCI
)

221 
ahci_p‹t_s
 *
p‹t_gf
 = 
	`c⁄èöî_of
(

222 
›
->
drive_gf
, 
ahci_p‹t_s
, 
drive
);

223 
ahci_cmd_s
 *
cmd
 = 
p‹t_gf
->cmd;

224 
u8
 *
©≠i
 = 
cdbcmd
;

225 
i
, 
rc
;

227 
	`ßè_¥ï_©≠i
(&
cmd
->
fis
, 
blocksize
);

228 
i
 = 0; i < 
CDROM_CDB_SIZE
; i++) {

229 
cmd
->
©≠i
[
i
] =átapi[i];

231 
rc
 = 
	`ahci_comm™d
(
p‹t_gf
, 0, 1, 
›
->
buf_Ê
,

232 
›
->
cou¡
 * 
blocksize
);

233 i‡(
rc
 < 0)

234  
DISK_RET_EBADTRACK
;

235  
DISK_RET_SUCCESS
;

236 
	}
}

240 
	$ahci_disk_ªadwrôe_Æig√d
(
disk_›_s
 *
›
, 
iswrôe
)

242 
ahci_p‹t_s
 *
p‹t_gf
 = 
	`c⁄èöî_of
(

243 
›
->
drive_gf
, 
ahci_p‹t_s
, 
drive
);

244 
ahci_cmd_s
 *
cmd
 = 
p‹t_gf
->cmd;

245 
rc
;

247 
	`ßè_¥ï_ªadwrôe
(&
cmd
->
fis
, 
›
, 
iswrôe
);

248 
rc
 = 
	`ahci_comm™d
(
p‹t_gf
, 
iswrôe
, 0, 
›
->
buf_Ê
,

249 
›
->
cou¡
 * 
DISK_SECTOR_SIZE
);

250 
	`d¥ötf
(8, "ahci disk %s,Üba %6x, count %3x, buf %p,Ñc %d\n",

251 
iswrôe
 ? "wrôe" : "ªad", (
u32
)
›
->
lba
, op->
cou¡
, op->
buf_Ê
, 
rc
);

252 i‡(
rc
 < 0)

253  
DISK_RET_EBADTRACK
;

254  
DISK_RET_SUCCESS
;

255 
	}
}

259 
	$ahci_disk_ªadwrôe
(
disk_›_s
 *
›
, 
iswrôe
)

262 i‡(((
u32
Ë
›
->
buf_Ê
 & 1) == 0)

263  
	`ahci_disk_ªadwrôe_Æig√d
(
›
, 
iswrôe
);

266 
rc
;

267 
disk_›_s
 
loˇl›
 = *
›
;

268 
u8
 *
Æig√dbuf_Ê
 = 
boun˚_buf_Ê
;

269 
u8
 *
posôi⁄
 = 
›
->
buf_Ê
;

271 
loˇl›
.
buf_Ê
 = 
Æig√dbuf_Ê
;

272 
loˇl›
.
cou¡
 = 1;

274 i‡(
iswrôe
) {

275 
u16
 
block
;

276 
block
 = 0; block < 
›
->
cou¡
; block++) {

277 
	`mem˝y_Ê
 (
Æig√dbuf_Ê
, 
posôi⁄
, 
DISK_SECTOR_SIZE
);

278 
rc
 = 
	`ahci_disk_ªadwrôe_Æig√d
 (&
loˇl›
, 1);

279 i‡(
rc
)

280  
rc
;

281 
posôi⁄
 +
DISK_SECTOR_SIZE
;

282 
loˇl›
.
lba
++;

285 
u16
 
block
;

286 
block
 = 0; block < 
›
->
cou¡
; block++) {

287 
rc
 = 
	`ahci_disk_ªadwrôe_Æig√d
 (&
loˇl›
, 0);

288 i‡(
rc
)

289  
rc
;

290 
	`mem˝y_Ê
 (
posôi⁄
, 
Æig√dbuf_Ê
, 
DISK_SECTOR_SIZE
);

291 
posôi⁄
 +
DISK_SECTOR_SIZE
;

292 
loˇl›
.
lba
++;

295  
DISK_RET_SUCCESS
;

296 
	}
}

299 
VISIBLE32FLAT


300 
	$¥o˚ss_ahci_›
(
disk_›_s
 *
›
)

302 i‡(!
CONFIG_AHCI
)

304 
›
->
comm™d
) {

305 
CMD_READ
:

306  
	`ahci_disk_ªadwrôe
(
›
, 0);

307 
CMD_WRITE
:

308  
	`ahci_disk_ªadwrôe
(
›
, 1);

309 
CMD_FORMAT
:

310 
CMD_RESET
:

311 
CMD_ISREADY
:

312 
CMD_VERIFY
:

313 
CMD_SEEK
:

314  
DISK_RET_SUCCESS
;

316 
	`d¥ötf
(1, "AHCI: unknow¿disk comm™d %d\n", 
›
->
comm™d
);

317  
DISK_RET_EPARAM
;

319 
	}
}

322 
	$ahci_p‹t_ª£t
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
≤r
)

324 
u32
 
vÆ
;

327 
u32
 
íd
 = 
	`timî_ˇlc
(
AHCI_RESET_TIMEOUT
);

329 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_CMD
);

330 i‡(!(
vÆ
 & (
PORT_CMD_FIS_RX
 | 
PORT_CMD_START
 |

331 
PORT_CMD_FIS_ON
 | 
PORT_CMD_LIST_ON
)))

333 
vÆ
 &~(
PORT_CMD_FIS_RX
 | 
PORT_CMD_START
);

334 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
vÆ
);

335 i‡(
	`timî_check
(
íd
)) {

336 
	`w¨n_timeout
();

339 
	`yõld
();

343 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_IRQ_MASK
, 0);

344 
vÆ
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
);

345 i‡(
vÆ
)

346 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_IRQ_STAT
, 
vÆ
);

347 
	}
}

349 
ahci_p‹t_s
*

350 
	$ahci_p‹t_Æloc
(
ahci_˘æ_s
 *
˘æ
, 
u32
 
≤r
)

352 
ahci_p‹t_s
 *
p‹t
 = 
	`mÆloc_tmp
((*port));

354 i‡(!
p‹t
) {

355 
	`w¨n_nﬂŒoc
();

356  
NULL
;

358 
p‹t
->
≤r
 =Önr;

359 
p‹t
->
˘æ
 = ctrl;

360 
p‹t
->
li°
 = 
	`memÆign_tmp
(1024, 1024);

361 
p‹t
->
fis
 = 
	`memÆign_tmp
(256, 256);

362 
p‹t
->
cmd
 = 
	`memÆign_tmp
(256, 256);

363 i‡(
p‹t
->
li°
 =
NULL
 ||Ö‹t->
fis
 =NULL ||Ö‹t->
cmd
 == NULL) {

364 
	`w¨n_nﬂŒoc
();

365  
NULL
;

367 
	`mem£t
(
p‹t
->
li°
, 0, 1024);

368 
	`mem£t
(
p‹t
->
fis
, 0, 256);

369 
	`mem£t
(
p‹t
->
cmd
, 0, 256);

371 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_LST_ADDR
, (
u32
)
p‹t
->
li°
);

372 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_FIS_ADDR
, (
u32
)
p‹t
->
fis
);

373  
p‹t
;

374 
	}
}

376 
	$ahci_p‹t_ªÀa£
(
ahci_p‹t_s
 *
p‹t
)

378 
	`ahci_p‹t_ª£t
(
p‹t
->
˘æ
,Ö‹t->
≤r
);

379 
	`‰ì
(
p‹t
->
li°
);

380 
	`‰ì
(
p‹t
->
fis
);

381 
	`‰ì
(
p‹t
->
cmd
);

382 
	`‰ì
(
p‹t
);

383 
	}
}

385 
ahci_p‹t_s
* 
	$ahci_p‹t_ªÆloc
(
ahci_p‹t_s
 *
p‹t
)

387 
ahci_p‹t_s
 *
tmp
;

388 
u32
 
cmd
;

390 
tmp
 = 
	`mÆloc_f£g
((*
p‹t
));

391 i‡(!
tmp
) {

392 
	`w¨n_nﬂŒoc
();

393 
	`ahci_p‹t_ªÀa£
(
p‹t
);

394  
NULL
;

396 *
tmp
 = *
p‹t
;

397 
	`‰ì
(
p‹t
);

398 
p‹t
 = 
tmp
;

400 
	`ahci_p‹t_ª£t
(
p‹t
->
˘æ
,Ö‹t->
≤r
);

402 
	`‰ì
(
p‹t
->
li°
);

403 
	`‰ì
(
p‹t
->
fis
);

404 
	`‰ì
(
p‹t
->
cmd
);

405 
p‹t
->
li°
 = 
	`memÆign_high
(1024, 1024);

406 
p‹t
->
fis
 = 
	`memÆign_high
(256, 256);

407 
p‹t
->
cmd
 = 
	`memÆign_high
(256, 256);

409 
	`ahci_p‹t_wrôñ
(
p‹t
->
˘æ
,Ö‹t->
≤r
, 
PORT_LST_ADDR
, (
u32
Ì‹t->
li°
);

410 
	`ahci_p‹t_wrôñ
(
p‹t
->
˘æ
,Ö‹t->
≤r
, 
PORT_FIS_ADDR
, (
u32
Ì‹t->
fis
);

412 
cmd
 = 
	`ahci_p‹t_ªadl
(
p‹t
->
˘æ
,Ö‹t->
≤r
, 
PORT_CMD
);

413 
cmd
 |(
PORT_CMD_FIS_RX
|
PORT_CMD_START
);

414 
	`ahci_p‹t_wrôñ
(
p‹t
->
˘æ
,Ö‹t->
≤r
, 
PORT_CMD
, 
cmd
);

416  
p‹t
;

417 
	}
}

419 
	#MAXMODEL
 40

	)

422 
	$ahci_p‹t_£tup
(
ahci_p‹t_s
 *
p‹t
)

424 
ahci_˘æ_s
 *
˘æ
 = 
p‹t
->ctrl;

425 
u32
 
≤r
 = 
p‹t
->pnr;

426 
modñ
[
MAXMODEL
+1];

427 
u16
 
buf„r
[256];

428 
u32
 
cmd
, 
°©
, 
îr
, 
tf
;

429 
rc
;

432 
cmd
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_CMD
);

433 
cmd
 |
PORT_CMD_FIS_RX
;

434 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
cmd
);

437 
cmd
 |
PORT_CMD_SPIN_UP
;

438 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
cmd
);

439 
u32
 
íd
 = 
	`timî_ˇlc
(
AHCI_LINK_TIMEOUT
);

441 
°©
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_SCR_STAT
);

442 i‡((
°©
 & 0x07) == 0x03) {

443 
	`d¥ötf
(2, "AHCI/%d:Üök up\n", 
p‹t
->
≤r
);

446 i‡(
	`timî_check
(
íd
)) {

447 
	`d¥ötf
(2, "AHCI/%d:Üök down\n", 
p‹t
->
≤r
);

450 
	`yõld
();

454 
îr
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_SCR_ERR
);

455 i‡(
îr
)

456 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_SCR_ERR
, 
îr
);

459 
íd
 = 
	`timî_ˇlc
(
AHCI_REQUEST_TIMEOUT
);

461 
tf
 = 
	`ahci_p‹t_ªadl
(
˘æ
, 
≤r
, 
PORT_TFDATA
);

462 i‡(!(
tf
 & (
ATA_CB_STAT_BSY
 |

463 
ATA_CB_STAT_DRQ
)))

465 i‡(
	`timî_check
(
íd
)) {

466 
	`w¨n_timeout
();

467 
	`d¥ötf
(1, "AHCI/%d: devi˚ÇŸÑódy (t‡0x%x)\n", 
p‹t
->
≤r
, 
tf
);

470 
	`yõld
();

474 
cmd
 |
PORT_CMD_START
;

475 
	`ahci_p‹t_wrôñ
(
˘æ
, 
≤r
, 
PORT_CMD
, 
cmd
);

477 
	`ßè_¥ï_sim∂e
(&
p‹t
->
cmd
->
fis
, 
ATA_CMD_IDENTIFY_PACKET_DEVICE
);

478 
rc
 = 
	`ahci_comm™d
(
p‹t
, 0, 0, 
buf„r
, (buffer));

479 i‡(
rc
 == 0) {

480 
p‹t
->
©≠i
 = 1;

482 
p‹t
->
©≠i
 = 0;

483 
	`ßè_¥ï_sim∂e
(&
p‹t
->
cmd
->
fis
, 
ATA_CMD_IDENTIFY_DEVICE
);

484 
rc
 = 
	`ahci_comm™d
(
p‹t
, 0, 0, 
buf„r
, (buffer));

485 i‡(
rc
 < 0)

489 
p‹t
->
drive
.
˙é_id
 = 
≤r
;

490 
p‹t
->
drive
.
ªmovabÀ
 = (
buf„r
[0] & 0x80) ? 1 : 0;

492 i‡(!
p‹t
->
©≠i
) {

494 
p‹t
->
drive
.
ty≥
 = 
DTYPE_AHCI
;

495 
p‹t
->
drive
.
blksize
 = 
DISK_SECTOR_SIZE
;

496 
p‹t
->
drive
.
pchs
.
cylödî
 = 
buf„r
[1];

497 
p‹t
->
drive
.
pchs
.
hód
 = 
buf„r
[3];

498 
p‹t
->
drive
.
pchs
.
£˘‹
 = 
buf„r
[6];

500 
u64
 
£˘‹s
;

501 i‡(
buf„r
[83] & (1 << 10))

502 
£˘‹s
 = *(
u64
*)&
buf„r
[100];

504 
£˘‹s
 = *(
u32
*)&
buf„r
[60];

505 
p‹t
->
drive
.
£˘‹s
 = sectors;

506 
u64
 
adjsize
 = 
£˘‹s
 >> 11;

507 
adj¥efix
 = 'M';

508 i‡(
adjsize
 >= (1 << 16)) {

509 
adjsize
 >>= 10;

510 
adj¥efix
 = 'G';

512 
p‹t
->
desc
 = 
	`z≈rötf
(
MAXDESCSIZE


514 , 
p‹t
->
≤r


515 , 
	`©a_exåa˘_modñ
(
modñ
, 
MAXMODEL
, 
buf„r
)

516 , 
	`©a_exåa˘_vîsi⁄
(
buf„r
)

517 , (
u32
)
adjsize
, 
adj¥efix
);

518 
p‹t
->
¥io
 = 
	`boŸ¥io_föd_©a_devi˚
(
˘æ
->
pci_tmp
, 
≤r
, 0);

521 
p‹t
->
drive
.
ty≥
 = 
DTYPE_AHCI_ATAPI
;

522 
p‹t
->
drive
.
blksize
 = 
CDROM_SECTOR_SIZE
;

523 
p‹t
->
drive
.
£˘‹s
 = (
u64
)-1;

524 
u8
 
iscd
 = ((
buf„r
[0] >> 8) & 0x1f) == 0x05;

525 i‡(!
iscd
) {

526 
	`d¥ötf
(1, "AHCI/%d:áèpòdevi˚ i¢'à®cdrom\n", 
p‹t
->
≤r
);

529 
p‹t
->
desc
 = 
	`z≈rötf
(
MAXDESCSIZE


531 , 
p‹t
->
≤r


532 , 
	`©a_exåa˘_modñ
(
modñ
, 
MAXMODEL
, 
buf„r
)

533 , 
	`©a_exåa˘_vîsi⁄
(
buf„r
));

534 
p‹t
->
¥io
 = 
	`boŸ¥io_föd_©a_devi˚
(
˘æ
->
pci_tmp
, 
≤r
, 0);

537 
	}
}

541 
	$ahci_p‹t_dëe˘
(*
d©a
)

543 
ahci_p‹t_s
 *
p‹t
 = 
d©a
;

544 
rc
;

546 
	`d¥ötf
(2, "AHCI/%d:Örobög\n", 
p‹t
->
≤r
);

547 
	`ahci_p‹t_ª£t
(
p‹t
->
˘æ
,Ö‹t->
≤r
);

548 
rc
 = 
	`ahci_p‹t_£tup
(
p‹t
);

549 i‡(
rc
 < 0)

550 
	`ahci_p‹t_ªÀa£
(
p‹t
);

552 
p‹t
 = 
	`ahci_p‹t_ªÆloc
(port);

553 i‡(
p‹t
 =
NULL
)

555 
	`d¥ötf
(1, "AHCI/%d:Ñegi°îög: \"%s\"\n", 
p‹t
->
≤r
,Ö‹t->
desc
);

556 i‡(!
p‹t
->
©≠i
) {

558 
	`boŸ_add_hd
(&
p‹t
->
drive
,Ö‹t->
desc
,Ö‹t->
¥io
);

561 
	`boŸ_add_cd
(&
p‹t
->
drive
,Ö‹t->
desc
,Ö‹t->
¥io
);

564 
	}
}

568 
	$ahci_c⁄åﬁÀr_£tup
(
pci_devi˚
 *
pci
)

570 
ahci_˘æ_s
 *
˘æ
 = 
	`mÆloc_f£g
((*ctrl));

571 
ahci_p‹t_s
 *
p‹t
;

572 
u16
 
bdf
 = 
pci
->bdf;

573 
u32
 
vÆ
, 
≤r
;

574 
u32
 
max
 = 0x1f;

576 i‡(!
˘æ
) {

577 
	`w¨n_nﬂŒoc
();

581 i‡(
	`¸óã_boun˚_buf
() < 0) {

582 
	`w¨n_nﬂŒoc
();

583 
	`‰ì
(
˘æ
);

587 
˘æ
->
pci_tmp
 = 
pci
;

588 
˘æ
->
pci_bdf
 = 
bdf
;

589 
˘æ
->
ioba£
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_5
);

590 
˘æ
->
úq
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_INTERRUPT_LINE
);

591 
	`d¥ötf
(1, "AHCI controllerát %02x.%x, iobase %x, irq %d\n",

592 
bdf
 >> 3, bd‡& 7, 
˘æ
->
ioba£
, cål->
úq
);

594 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0,

595 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_MASTER
);

597 
vÆ
 = 
	`ahci_˘æ_ªadl
(
˘æ
, 
HOST_CTL
);

598 
	`ahci_˘æ_wrôñ
(
˘æ
, 
HOST_CTL
, 
vÆ
 | 
HOST_CTL_AHCI_EN
);

600 
˘æ
->
ˇps
 = 
	`ahci_˘æ_ªadl
(˘æ, 
HOST_CAP
);

601 
˘æ
->
p‹ts
 = 
	`ahci_˘æ_ªadl
(˘æ, 
HOST_PORTS_IMPL
);

602 
	`d¥ötf
(2, "AHCI: cap 0x%x,Öorts_impl 0x%x\n",

603 
˘æ
->
ˇps
, cål->
p‹ts
);

605 
≤r
 = 0;Öƒ <
max
;Önr++) {

606 i‡(!(
˘æ
->
p‹ts
 & (1 << 
≤r
)))

608 
p‹t
 = 
	`ahci_p‹t_Æloc
(
˘æ
, 
≤r
);

609 i‡(
p‹t
 =
NULL
)

611 
	`run_thªad
(
ahci_p‹t_dëe˘
, 
p‹t
);

613 
	}
}

617 
	$ahci_sˇn
()

620 
pci_devi˚
 *
pci
;

621 
	`f‹óchpci
(
pci
) {

622 i‡(
pci
->
˛ass
 !
PCI_CLASS_STORAGE_SATA
)

624 i‡(
pci
->
¥og_if
 != 1 )

626 
	`ahci_c⁄åﬁÀr_£tup
(
pci
);

628 
	}
}

631 
	$ahci_£tup
()

633 
	`ASSERT32FLAT
();

634 i‡(!
CONFIG_AHCI
)

637 
	`d¥ötf
(3, "initáhci\n");

638 
	`ahci_sˇn
();

639 
	}
}

	@hw/ahci.h

1 #i‚de‡
__AHCI_H


2 
	#__AHCI_H


	)

4 
	~"block.h
"

5 
	~"ty≥s.h
"

7 
	sßè_cmd_fis
 {

8 
u8
 
	mªg
;

9 
u8
 
	mpmp_ty≥
;

10 
u8
 
	mcomm™d
;

11 
u8
 
	m„©uª
;

13 
u8
 
	mlba_low
;

14 
u8
 
	mlba_mid
;

15 
u8
 
	mlba_high
;

16 
u8
 
	mdevi˚
;

18 
u8
 
	mlba_low2
;

19 
u8
 
	mlba_mid2
;

20 
u8
 
	mlba_high2
;

21 
u8
 
	m„©uª2
;

23 
u8
 
	m£˘‹_cou¡
;

24 
u8
 
	m£˘‹_cou¡2
;

25 
u8
 
	mªs_1
;

26 
u8
 
	mc⁄åﬁ
;

28 
u8
 
	mªs_2
[64 - 16];

31 
	sahci_˘æ_s
 {

32 
pci_devi˚
 *
	mpci_tmp
;

33 
u16
 
	mpci_bdf
;

34 
u8
 
	múq
;

35 
u32
 
	mioba£
;

36 
u32
 
	mˇps
;

37 
u32
 
	mp‹ts
;

40 
	sahci_cmd_s
 {

41 
ßè_cmd_fis
 
	mfis
;

42 
u8
 
	m©≠i
[0x20];

43 
u8
 
	mªs
[0x20];

45 
u32
 
	mba£
;

46 
u32
 
	mba£u
;

47 
u32
 
	mªs
;

48 
u32
 
	mÊags
;

49 } 
	m¥dt
[];

53 
	sahci_li°_s
 {

54 
u32
 
	mÊags
;

55 
u32
 
	mbyãs
;

56 
u32
 
	mba£
;

57 
u32
 
	mba£u
;

58 
u32
 
	mªs
[4];

61 
	sahci_fis_s
 {

62 
u8
 
	mdsfis
[0x1c];

63 
u8
 
	mªs_1
[0x04];

64 
u8
 
	mpsfis
[0x14];

65 
u8
 
	mªs_2
[0x0c];

66 
u8
 
	mrfis
[0x14];

67 
u8
 
	mªs_3
[0x04];

68 
u8
 
	msdbfis
[0x08];

69 
u8
 
	mufis
[0x40];

70 
u8
 
	mªs_4
[0x60];

73 
	sahci_p‹t_s
 {

74 
drive_s
 
	mdrive
;

75 
ahci_˘æ_s
 *
	m˘æ
;

76 
ahci_li°_s
 *
	mli°
;

77 
ahci_fis_s
 *
	mfis
;

78 
ahci_cmd_s
 *
	mcmd
;

79 
u32
 
	m≤r
;

80 
u32
 
	m©≠i
;

81 *
	mdesc
;

82 
	m¥io
;

85 
ahci_£tup
();

86 
¥o˚ss_ahci_›
(
disk_›_s
 *
›
);

87 
ahci_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

89 
	#AHCI_IRQ_ON_SG
 (1 << 31)

	)

90 
	#AHCI_CMD_ATAPI
 (1 << 5)

	)

91 
	#AHCI_CMD_WRITE
 (1 << 6)

	)

92 
	#AHCI_CMD_PREFETCH
 (1 << 7)

	)

93 
	#AHCI_CMD_RESET
 (1 << 8)

	)

94 
	#AHCI_CMD_CLR_BUSY
 (1 << 10)

	)

96 
	#RX_FIS_D2H_REG
 0x40

	)

97 
	#RX_FIS_SDB
 0x58

	)

98 
	#RX_FIS_UNK
 0x60

	)

101 
	#HOST_CAP
 0x00

	)

102 
	#HOST_CTL
 0x04

	)

103 
	#HOST_IRQ_STAT
 0x08

	)

104 
	#HOST_PORTS_IMPL
 0x0¯

	)

105 
	#HOST_VERSION
 0x10

	)

108 
	#HOST_CTL_RESET
 (1 << 0Ë

	)

109 
	#HOST_CTL_IRQ_EN
 (1 << 1Ë

	)

110 
	#HOST_CTL_AHCI_EN
 (1 << 31Ë

	)

113 
	#HOST_CAP_SSC
 (1 << 14Ë

	)

114 
	#HOST_CAP_AHCI
 (1 << 18Ë

	)

115 
	#HOST_CAP_CLO
 (1 << 24Ë

	)

116 
	#HOST_CAP_SSS
 (1 << 27Ë

	)

117 
	#HOST_CAP_NCQ
 (1 << 30Ë

	)

118 
	#HOST_CAP_64
 (1 << 31Ë

	)

121 
	#PORT_LST_ADDR
 0x00

	)

122 
	#PORT_LST_ADDR_HI
 0x04

	)

123 
	#PORT_FIS_ADDR
 0x08

	)

124 
	#PORT_FIS_ADDR_HI
 0x0¯

	)

125 
	#PORT_IRQ_STAT
 0x10

	)

126 
	#PORT_IRQ_MASK
 0x14

	)

127 
	#PORT_CMD
 0x18

	)

128 
	#PORT_TFDATA
 0x20

	)

129 
	#PORT_SIG
 0x24

	)

130 
	#PORT_SCR_STAT
 0x28

	)

131 
	#PORT_SCR_CTL
 0x2¯

	)

132 
	#PORT_SCR_ERR
 0x30

	)

133 
	#PORT_SCR_ACT
 0x34

	)

134 
	#PORT_CMD_ISSUE
 0x38

	)

135 
	#PORT_RESERVED
 0x3¯

	)

138 
	#PORT_IRQ_COLD_PRES
 (1 << 31Ë

	)

139 
	#PORT_IRQ_TF_ERR
 (1 << 30Ë

	)

140 
	#PORT_IRQ_HBUS_ERR
 (1 << 29Ë

	)

141 
	#PORT_IRQ_HBUS_DATA_ERR
 (1 << 28Ë

	)

142 
	#PORT_IRQ_IF_ERR
 (1 << 27Ë

	)

143 
	#PORT_IRQ_IF_NONFATAL
 (1 << 26Ë

	)

144 
	#PORT_IRQ_OVERFLOW
 (1 << 24Ë

	)

145 
	#PORT_IRQ_BAD_PMP
 (1 << 23Ë

	)

147 
	#PORT_IRQ_PHYRDY
 (1 << 22Ë

	)

148 
	#PORT_IRQ_DEV_ILCK
 (1 << 7Ë

	)

149 
	#PORT_IRQ_CONNECT
 (1 << 6Ë

	)

150 
	#PORT_IRQ_SG_DONE
 (1 << 5Ë

	)

151 
	#PORT_IRQ_UNK_FIS
 (1 << 4Ë

	)

152 
	#PORT_IRQ_SDB_FIS
 (1 << 3Ë

	)

153 
	#PORT_IRQ_DMAS_FIS
 (1 << 2Ë

	)

154 
	#PORT_IRQ_PIOS_FIS
 (1 << 1Ë

	)

155 
	#PORT_IRQ_D2H_REG_FIS
 (1 << 0Ë

	)

157 
	#PORT_IRQ_FREEZE
 (
PORT_IRQ_HBUS_ERR
 | 
PORT_IRQ_IF_ERR
 | \

158 
PORT_IRQ_CONNECT
 | 
PORT_IRQ_PHYRDY
 | \

159 
PORT_IRQ_UNK_FIS
)

	)

160 
	#PORT_IRQ_ERROR
 (
PORT_IRQ_FREEZE
 | 
PORT_IRQ_TF_ERR
 | \

161 
PORT_IRQ_HBUS_DATA_ERR
)

	)

162 
	#DEF_PORT_IRQ
 (
PORT_IRQ_ERROR
 | 
PORT_IRQ_SG_DONE
 | \

163 
PORT_IRQ_SDB_FIS
 | 
PORT_IRQ_DMAS_FIS
 | \

164 
PORT_IRQ_PIOS_FIS
 | 
PORT_IRQ_D2H_REG_FIS
)

	)

167 
	#PORT_CMD_ATAPI
 (1 << 24Ë

	)

168 
	#PORT_CMD_LIST_ON
 (1 << 15Ë

	)

169 
	#PORT_CMD_FIS_ON
 (1 << 14Ë

	)

170 
	#PORT_CMD_FIS_RX
 (1 << 4Ë

	)

171 
	#PORT_CMD_CLO
 (1 << 3Ë

	)

172 
	#PORT_CMD_POWER_ON
 (1 << 2Ë

	)

173 
	#PORT_CMD_SPIN_UP
 (1 << 1Ë

	)

174 
	#PORT_CMD_START
 (1 << 0Ë

	)

176 
	#PORT_CMD_ICC_MASK
 (0x‡<< 28Ë

	)

177 
	#PORT_CMD_ICC_ACTIVE
 (0x1 << 28Ë

	)

178 
	#PORT_CMD_ICC_PARTIAL
 (0x2 << 28Ë

	)

179 
	#PORT_CMD_ICC_SLUMBER
 (0x6 << 28Ë

	)

181 
	#PORT_IRQ_STAT_DHRS
 (1 << 0Ë

	)

182 
	#PORT_IRQ_STAT_PSS
 (1 << 1Ë

	)

183 
	#PORT_IRQ_STAT_DSS
 (1 << 2Ë

	)

184 
	#PORT_IRQ_STAT_SDBS
 (1 << 3Ë

	)

185 
	#PORT_IRQ_STAT_UFS
 (1 << 4Ë

	)

186 
	#PORT_IRQ_STAT_DPS
 (1 << 5Ë

	)

187 
	#PORT_IRQ_STAT_PCS
 (1 << 6Ë

	)

188 
	#PORT_IRQ_STAT_DMPS
 (1 << 7Ë

	)

190 
	#PORT_IRQ_STAT_PRCS
 (1 << 22Ë

	)

191 
	#PORT_IRQ_STAT_IPMS
 (1 << 23Ë

	)

193 
	#PORT_IRQ_STAT_OFS
 (1 << 24Ë

	)

194 
	#PORT_IRQ_STAT_INFS
 (1 << 26Ë

	)

196 
	#PORT_IRQ_STAT_IFS
 (1 << 27Ë

	)

197 
	#PORT_IRQ_STAT_HBDS
 (1 << 28Ë

	)

198 
	#PORT_IRQ_STAT_HBFS
 (1 << 29Ë

	)

199 
	#PORT_IRQ_STAT_TFES
 (1 << 30Ë

	)

200 
	#PORT_IRQ_STAT_CPDS
 (1 << 31Ë

	)

	@hw/ata.c

8 
	~"©a.h
"

9 
	~"biosv¨.h
"

10 
	~"block.h
"

11 
	~"blockcmd.h
"

12 
	~"byã‹dî.h
"

13 
	~"mÆloc.h
"

14 
	~"ouçut.h
"

15 
	~"pci.h
"

16 
	~"pci_ids.h
"

17 
	~"pci_ªgs.h
"

18 
	~"pic.h
"

19 
	~"°acks.h
"

20 
	~"°d/disk.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

23 
	~"x86.h
"

25 
	#IDE_TIMEOUT
 32000

26 

	)

33 
ölöe
 

34 
	$awaô_ide
(
u8
 
mask
, u8 
Êags
, 
u16
 
ba£
, u16 
timeout
)

36 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

38 
u8
 
°©us
 = 
	`öb
(
ba£
+
ATA_CB_STAT
);

39 i‡((
°©us
 & 
mask
Ë=
Êags
)

40  
°©us
;

41 i‡(
	`timî_check
(
íd
)) {

42 
	`w¨n_timeout
();

45 
	`yõld
();

47 
	}
}

51 
	$awaô_nŸ_bsy
(
u16
 
ba£
)

53  
	`awaô_ide
(
ATA_CB_STAT_BSY
, 0, 
ba£
, 
IDE_TIMEOUT
);

54 
	}
}

58 
	$awaô_rdy
(
u16
 
ba£
)

60  
	`awaô_ide
(
ATA_CB_STAT_RDY
, ATA_CB_STAT_RDY, 
ba£
, 
IDE_TIMEOUT
);

61 
	}
}

64 
ölöe
 

65 
	$∑u£_awaô_nŸ_bsy
(
u16
 
ioba£1
, u16 
ioba£2
)

68 
	`öb
(
ioba£2
 + 
ATA_CB_ASTAT
);

70  
	`awaô_nŸ_bsy
(
ioba£1
);

71 
	}
}

74 
ölöe
 

75 
	$ndñay_awaô_nŸ_bsy
(
u16
 
ioba£1
)

77 
	`ndñay
(400);

78  
	`awaô_nŸ_bsy
(
ioba£1
);

79 
	}
}

83 
	$©a_ª£t
(
©adrive_s
 *
adrive_gf
)

85 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

86 
u8
 
¶ave
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->slave);

87 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

88 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

90 
	`d¥ötf
(6, "©a_ª£àdrive=%p\n", &
adrive_gf
->
drive
);

92 
	`outb
(
ATA_CB_DC_HD15
 | 
ATA_CB_DC_NIEN
 | 
ATA_CB_DC_SRST
, 
ioba£2
+
ATA_CB_DC
);

93 
	`udñay
(5);

94 
	`outb
(
ATA_CB_DC_HD15
 | 
ATA_CB_DC_NIEN
, 
ioba£2
+
ATA_CB_DC
);

95 
	`m¶ìp
(2);

98 
°©us
 = 
	`awaô_nŸ_bsy
(
ioba£1
);

99 i‡(
°©us
 < 0)

100 
d⁄e
;

101 i‡(
¶ave
) {

103 
u32
 
íd
 = 
	`timî_ˇlc
(
IDE_TIMEOUT
);

105 
	`outb
(
ATA_CB_DH_DEV1
, 
ioba£1
 + 
ATA_CB_DH
);

106 
°©us
 = 
	`ndñay_awaô_nŸ_bsy
(
ioba£1
);

107 i‡(
°©us
 < 0)

108 
d⁄e
;

109 i‡(
	`öb
(
ioba£1
 + 
ATA_CB_DH
Ë=
ATA_CB_DH_DEV1
)

112 i‡(
	`timî_check
(
íd
)) {

113 
	`w¨n_timeout
();

114 
d⁄e
;

119 
	`outb
(
ATA_CB_DH_DEV0
, 
ioba£1
 + 
ATA_CB_DH
);

123 
u8
 
ty≥
=
	`GET_GLOBALFLAT
(
adrive_gf
->
drive
.type);

124 i‡(
ty≥
 =
DTYPE_ATA
)

125 
°©us
 = 
	`awaô_rdy
(
ioba£1
);

127 
d⁄e
:

129 
	`outb
(
ATA_CB_DC_HD15
, 
ioba£2
+
ATA_CB_DC
);

131 
	`d¥ötf
(6, "©a_ª£àexô sètus=%x\n", 
°©us
);

132 
	}
}

136 
	$i§ódy
(
©adrive_s
 *
adrive_gf
)

139 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

140 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

141 
u8
 
°©us
 = 
	`öb
(
ioba£1
 + 
ATA_CB_STAT
);

142 i‡((
°©us
 & (
ATA_CB_STAT_BSY
|
ATA_CB_STAT_RDY
)) == ATA_CB_STAT_RDY)

143  
DISK_RET_SUCCESS
;

144  
DISK_RET_ENOTREADY
;

145 
	}
}

152 
	s©a_pio_comm™d
 {

153 
u8
 
	m„©uª
;

154 
u8
 
	m£˘‹_cou¡
;

155 
u8
 
	mlba_low
;

156 
u8
 
	mlba_mid
;

157 
u8
 
	mlba_high
;

158 
u8
 
	mdevi˚
;

159 
u8
 
	mcomm™d
;

161 
u8
 
	m„©uª2
;

162 
u8
 
	m£˘‹_cou¡2
;

163 
u8
 
	mlba_low2
;

164 
u8
 
	mlba_mid2
;

165 
u8
 
	mlba_high2
;

170 
	$£nd_cmd
(
©adrive_s
 *
adrive_gf
, 
©a_pio_comm™d
 *
cmd
)

172 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

173 
u8
 
¶ave
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->slave);

174 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

177 
°©us
 = 
	`awaô_nŸ_bsy
(
ioba£1
);

178 i‡(
°©us
 < 0)

179  
°©us
;

180 
u8
 
√wdh
 = ((
cmd
->
devi˚
 & ~
ATA_CB_DH_DEV1
)

181 | (
¶ave
 ? 
ATA_CB_DH_DEV1
 : 
ATA_CB_DH_DEV0
));

182 
u8
 
ﬁddh
 = 
	`öb
(
ioba£1
 + 
ATA_CB_DH
);

183 
	`outb
(
√wdh
, 
ioba£1
 + 
ATA_CB_DH
);

184 i‡((
ﬁddh
 ^ 
√wdh
) & (1<<4)) {

186 
°©us
 = 
	`ndñay_awaô_nŸ_bsy
(
ioba£1
);

187 i‡(
°©us
 < 0)

188  
°©us
;

192 i‡((
cmd
->
comm™d
 & ~0x11Ë=
ATA_CMD_READ_SECTORS_EXT
) {

193 
	`outb
(
cmd
->
„©uª2
, 
ioba£1
 + 
ATA_CB_FR
);

194 
	`outb
(
cmd
->
£˘‹_cou¡2
, 
ioba£1
 + 
ATA_CB_SC
);

195 
	`outb
(
cmd
->
lba_low2
, 
ioba£1
 + 
ATA_CB_SN
);

196 
	`outb
(
cmd
->
lba_mid2
, 
ioba£1
 + 
ATA_CB_CL
);

197 
	`outb
(
cmd
->
lba_high2
, 
ioba£1
 + 
ATA_CB_CH
);

199 
	`outb
(
cmd
->
„©uª
, 
ioba£1
 + 
ATA_CB_FR
);

200 
	`outb
(
cmd
->
£˘‹_cou¡
, 
ioba£1
 + 
ATA_CB_SC
);

201 
	`outb
(
cmd
->
lba_low
, 
ioba£1
 + 
ATA_CB_SN
);

202 
	`outb
(
cmd
->
lba_mid
, 
ioba£1
 + 
ATA_CB_CL
);

203 
	`outb
(
cmd
->
lba_high
, 
ioba£1
 + 
ATA_CB_CH
);

204 
	`outb
(
cmd
->
comm™d
, 
ioba£1
 + 
ATA_CB_CMD
);

207 
	}
}

211 
	$©a_waô_d©a
(
u16
 
ioba£1
)

213 
°©us
 = 
	`ndñay_awaô_nŸ_bsy
(
ioba£1
);

214 i‡(
°©us
 < 0)

215  
°©us
;

217 i‡(
°©us
 & 
ATA_CB_STAT_ERR
) {

218 
	`d¥ötf
(6, "send_cmd :ÑeadÉrror (status=%02xÉrr=%02x)\n"

219 , 
°©us
, 
	`öb
(
ioba£1
 + 
ATA_CB_ERR
));

222 i‡(!(
°©us
 & 
ATA_CB_STAT_DRQ
)) {

223 
	`d¥ötf
(6, "£nd_cmd : DRQÇŸ së (°©u†%02x)\n", 
°©us
);

228 
	}
}

232 
	$©a_cmd_n⁄d©a
(
©adrive_s
 *
adrive_gf
, 
©a_pio_comm™d
 *
cmd
)

234 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

235 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

236 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

239 
	`outb
(
ATA_CB_DC_HD15
 | 
ATA_CB_DC_NIEN
, 
ioba£2
 + 
ATA_CB_DC
);

241 
ªt
 = 
	`£nd_cmd
(
adrive_gf
, 
cmd
);

242 i‡(
ªt
)

243 
Áû
;

244 
ªt
 = 
	`ndñay_awaô_nŸ_bsy
(
ioba£1
);

245 i‡(
ªt
 < 0)

246 
Áû
;

248 i‡(
ªt
 & 
ATA_CB_STAT_ERR
) {

249 
	`d¥ötf
(6, "nondata cmd :ÑeadÉrror (status=%02xÉrr=%02x)\n"

250 , 
ªt
, 
	`öb
(
ioba£1
 + 
ATA_CB_ERR
));

251 
ªt
 = -4;

252 
Áû
;

254 i‡(
ªt
 & 
ATA_CB_STAT_DRQ
) {

255 
	`d¥ötf
(6, "n⁄d©®cmd : DRQ së (°©u†%02x)\n", 
ªt
);

256 
ªt
 = -5;

257 
Áû
;

260 
Áû
:

262 
	`outb
(
ATA_CB_DC_HD15
, 
ioba£2
+
ATA_CB_DC
);

264  
ªt
;

265 
	}
}

275 
	$©a_pio_å™s„r
(
disk_›_s
 *
›
, 
iswrôe
, 
blocksize
)

277 
	`d¥ötf
(16, "ata_pio_transfer id=%p write=%d count=%d bs=%d buf=%p\n"

278 , 
›
->
drive_gf
, 
iswrôe
, op->
cou¡
, 
blocksize
, op->
buf_Ê
);

280 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

281 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

282 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

283 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

284 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

285 
cou¡
 = 
›
->count;

286 *
buf_Ê
 = 
›
->buf_fl;

287 
°©us
;

289 i‡(
iswrôe
) {

291 
	`d¥ötf
(16, "Wrôê£˘‹ id=%∞de°=%p\n", 
›
->
drive_gf
, 
buf_Ê
);

292 i‡(
CONFIG_ATA_PIO32
)

293 
	`out¶_Ê
(
ioba£1
, 
buf_Ê
, 
blocksize
 / 4);

295 
	`outsw_Ê
(
ioba£1
, 
buf_Ê
, 
blocksize
 / 2);

298 
	`d¥ötf
(16, "Ród se˘‹ id=%∞de°=%p\n", 
›
->
drive_gf
, 
buf_Ê
);

299 i‡(
CONFIG_ATA_PIO32
)

300 
	`ö¶_Ê
(
ioba£1
, 
buf_Ê
, 
blocksize
 / 4);

302 
	`ösw_Ê
(
ioba£1
, 
buf_Ê
, 
blocksize
 / 2);

304 
buf_Ê
 +
blocksize
;

306 
°©us
 = 
	`∑u£_awaô_nŸ_bsy
(
ioba£1
, 
ioba£2
);

307 i‡(
°©us
 < 0) {

309 
›
->
cou¡
 -= count;

310  
°©us
;

313 
cou¡
--;

314 i‡(!
cou¡
)

316 
°©us
 &(
ATA_CB_STAT_BSY
 | 
ATA_CB_STAT_DRQ
 | 
ATA_CB_STAT_ERR
);

317 i‡(
°©us
 !
ATA_CB_STAT_DRQ
) {

318 
	`d¥ötf
(6, "ata_pio_transfer : more sectorsÜeft (status %02x)\n"

319 , 
°©us
);

320 
›
->
cou¡
 -= count;

325 
°©us
 &(
ATA_CB_STAT_BSY
 | 
ATA_CB_STAT_DF
 | 
ATA_CB_STAT_DRQ


326 | 
ATA_CB_STAT_ERR
);

327 i‡(!
iswrôe
)

328 
°©us
 &~
ATA_CB_STAT_DF
;

329 i‡(
°©us
 != 0) {

330 
	`d¥ötf
(6, "©a_pio_å™s„∏:Çÿ£˘‹†À· (°©u†%02x)\n", 
°©us
);

335 
	}
}

342 
	#BM_CMD
 0

	)

343 
	#BM_CMD_MEMWRITE
 0x08

	)

344 
	#BM_CMD_START
 0x01

	)

345 
	#BM_STATUS
 2

	)

346 
	#BM_STATUS_IRQ
 0x04

	)

347 
	#BM_STATUS_ERROR
 0x02

	)

348 
	#BM_STATUS_ACTIVE
 0x01

	)

349 
	#BM_TABLE
 4

	)

351 
	ssff_dma_¥d
 {

352 
u32
 
	mbuf_Ê
;

353 
u32
 
	mcou¡
;

358 
	$©a_åy_dma
(
disk_›_s
 *
›
, 
iswrôe
, 
blocksize
)

360 
	`ASSERT16
();

361 i‡(! 
CONFIG_ATA_DMA
)

363 
u32
 
de°
 = (u32)
›
->
buf_Ê
;

364 i‡(
de°
 & 1)

367 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

368 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

369 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

370 
u16
 
ioma°î
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iomaster);

371 i‡(! 
ioma°î
)

373 
u32
 
byãs
 = 
›
->
cou¡
 * 
blocksize
;

374 i‡(! 
byãs
)

378 
sff_dma_¥d
 *
dma
 = 
	`MAKE_FLATPTR
(
SEG_LOW
, 
ExåaSèck
);

379 
sff_dma_¥d
 *
‹igdma
 = 
dma
;

380 
byãs
) {

381 i‡(
dma
 >&
‹igdma
[16])

384 
u32
 
cou¡
 = 
byãs
;

385 
u32
 
max
 = 0x10000 - (
de°
 & 0xffff);

386 i‡(
cou¡
 > 
max
)

387 
cou¡
 = 
max
;

389 
	`SET_LOWFLAT
(
dma
->
buf_Ê
, 
de°
);

390 
byãs
 -
cou¡
;

391 i‡(!
byãs
)

393 
cou¡
 |= 1<<31;

394 
	`d¥ötf
(16, "dma@%p: %08x %08x\n", 
dma
, 
de°
, 
cou¡
);

395 
de°
 +
cou¡
;

396 
	`SET_LOWFLAT
(
dma
->
cou¡
, count);

397 
dma
++;

401 
	`oué
((
u32
)
‹igdma
, 
ioma°î
 + 
BM_TABLE
);

402 
u8
 
ﬁdcmd
 = 
	`öb
(
ioma°î
 + 
BM_CMD
Ë& ~(
BM_CMD_MEMWRITE
|
BM_CMD_START
);

403 
	`outb
(
ﬁdcmd
 | (
iswrôe
 ? 0x00 : 
BM_CMD_MEMWRITE
), 
ioma°î
 + 
BM_CMD
);

404 
	`outb
(
BM_STATUS_ERROR
|
BM_STATUS_IRQ
, 
ioma°î
 + 
BM_STATUS
);

407 
	}
}

411 
	$©a_dma_å™s„r
(
disk_›_s
 *
›
)

413 i‡(! 
CONFIG_ATA_DMA
)

415 
	`d¥ötf
(16, "©a_dma_å™s„∏id=%∞buf=%p\n", 
›
->
drive_gf
, op->
buf_Ê
);

417 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

418 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

419 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

420 
u16
 
ioma°î
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iomaster);

423 
u8
 
ﬁdcmd
 = 
	`öb
(
ioma°î
 + 
BM_CMD
);

424 
	`outb
(
ﬁdcmd
 | 
BM_CMD_START
, 
ioma°î
 + 
BM_CMD
);

426 
u32
 
íd
 = 
	`timî_ˇlc
(
IDE_TIMEOUT
);

427 
u8
 
°©us
;

429 
°©us
 = 
	`öb
(
ioma°î
 + 
BM_STATUS
);

430 i‡(
°©us
 & 
BM_STATUS_IRQ
)

433 i‡(
	`timî_check
(
íd
)) {

435 
	`w¨n_timeout
();

438 
	`yõld
();

440 
	`outb
(
ﬁdcmd
 & ~
BM_CMD_START
, 
ioma°î
 + 
BM_CMD
);

442 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

443 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

444 
ide°©us
 = 
	`∑u£_awaô_nŸ_bsy
(
ioba£1
, 
ioba£2
);

446 i‡((
°©us
 & (
BM_STATUS_IRQ
|
BM_STATUS_ACTIVE
)) == BM_STATUS_IRQ

447 && 
ide°©us
 >= 0x00

448 && (
ide°©us
 & (
ATA_CB_STAT_BSY
 | 
ATA_CB_STAT_DF
 | 
ATA_CB_STAT_DRQ


449 | 
ATA_CB_STAT_ERR
)) == 0x00)

453 
	`d¥ötf
(6, "IDE DMAÉº‹ (dma=%x ide=%x/%x/%x)\n", 
°©us
, 
ide°©us


454 , 
	`öb
(
ioba£2
 + 
ATA_CB_ASTAT
), inb(
ioba£1
 + 
ATA_CB_ERR
));

456 
	}
}

465 
	$©a_pio_cmd_d©a
(
disk_›_s
 *
›
, 
iswrôe
, 
©a_pio_comm™d
 *
cmd
)

467 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

468 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

469 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

470 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

471 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

474 
	`outb
(
ATA_CB_DC_HD15
 | 
ATA_CB_DC_NIEN
, 
ioba£2
 + 
ATA_CB_DC
);

476 
ªt
 = 
	`£nd_cmd
(
adrive_gf
, 
cmd
);

477 i‡(
ªt
)

478 
Áû
;

479 
ªt
 = 
	`©a_waô_d©a
(
ioba£1
);

480 i‡(
ªt
)

481 
Áû
;

482 
ªt
 = 
	`©a_pio_å™s„r
(
›
, 
iswrôe
, 
DISK_SECTOR_SIZE
);

484 
Áû
:

486 
	`outb
(
ATA_CB_DC_HD15
, 
ioba£2
+
ATA_CB_DC
);

487  
ªt
;

488 
	}
}

492 
	$©a_dma_cmd_d©a
(
disk_›_s
 *
›
, 
©a_pio_comm™d
 *
cmd
)

494 i‡(! 
CONFIG_ATA_DMA
)

496 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

497 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

498 
ªt
 = 
	`£nd_cmd
(
adrive_gf
, 
cmd
);

499 i‡(
ªt
)

500  
ªt
;

501  
	`©a_dma_å™s„r
(
›
);

502 
	}
}

506 
	$©a_ªadwrôe
(
disk_›_s
 *
›
, 
iswrôe
)

508 
u64
 
lba
 = 
›
->lba;

510 
u£pio
 = 
	`©a_åy_dma
(
›
, 
iswrôe
, 
DISK_SECTOR_SIZE
);

512 
©a_pio_comm™d
 
cmd
;

513 
	`mem£t
(&
cmd
, 0, (cmd));

515 i‡(
›
->
cou¡
 >(1<<8Ë|| 
lba
 + op->count >= (1<<28)) {

516 
cmd
.
£˘‹_cou¡2
 = 
›
->
cou¡
 >> 8;

517 
cmd
.
lba_low2
 = 
lba
 >> 24;

518 
cmd
.
lba_mid2
 = 
lba
 >> 32;

519 
cmd
.
lba_high2
 = 
lba
 >> 40;

520 
lba
 &= 0xffffff;

522 i‡(
u£pio
)

523 
cmd
.
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_SECTORS_EXT


524 : 
ATA_CMD_READ_SECTORS_EXT
);

526 
cmd
.
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_DMA_EXT


527 : 
ATA_CMD_READ_DMA_EXT
);

529 i‡(
u£pio
)

530 
cmd
.
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_SECTORS


531 : 
ATA_CMD_READ_SECTORS
);

533 
cmd
.
comm™d
 = (
iswrôe
 ? 
ATA_CMD_WRITE_DMA


534 : 
ATA_CMD_READ_DMA
);

537 
cmd
.
£˘‹_cou¡
 = 
›
->
cou¡
;

538 
cmd
.
lba_low
 = 
lba
;

539 
cmd
.
lba_mid
 = 
lba
 >> 8;

540 
cmd
.
lba_high
 = 
lba
 >> 16;

541 
cmd
.
devi˚
 = ((
lba
 >> 24Ë& 0xfË| 
ATA_CB_DH_LBA
;

543 
ªt
;

544 i‡(
u£pio
)

545 
ªt
 = 
	`©a_pio_cmd_d©a
(
›
, 
iswrôe
, &
cmd
);

547 
ªt
 = 
	`©a_dma_cmd_d©a
(
›
, &
cmd
);

548 i‡(
ªt
)

549  
DISK_RET_EBADTRACK
;

550  
DISK_RET_SUCCESS
;

551 
	}
}

555 
	$¥o˚ss_©a_›
(
disk_›_s
 *
›
)

557 i‡(!
CONFIG_ATA
)

560 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

561 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

562 
›
->
comm™d
) {

563 
CMD_READ
:

564  
	`©a_ªadwrôe
(
›
, 0);

565 
CMD_WRITE
:

566  
	`©a_ªadwrôe
(
›
, 1);

567 
CMD_RESET
:

568 
	`©a_ª£t
(
adrive_gf
);

569  
DISK_RET_SUCCESS
;

570 
CMD_ISREADY
:

571  
	`i§ódy
(
adrive_gf
);

572 
CMD_FORMAT
:

573 
CMD_VERIFY
:

574 
CMD_SEEK
:

575  
DISK_RET_SUCCESS
;

577  
DISK_RET_EPARAM
;

579 
	}
}

586 
	#CDROM_CDB_SIZE
 12

	)

590 
	$©≠i_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

592 i‡(! 
CONFIG_ATA
)

595 
©adrive_s
 *
adrive_gf
 = 
	`c⁄èöî_of
(

596 
›
->
drive_gf
, 
©adrive_s
, 
drive
);

597 
©a_ch™√l_s
 *
ch™_gf
 = 
	`GET_GLOBALFLAT
(
adrive_gf
->chan_gf);

598 
u16
 
ioba£1
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase1);

599 
u16
 
ioba£2
 = 
	`GET_GLOBALFLAT
(
ch™_gf
->iobase2);

601 
©a_pio_comm™d
 
cmd
;

602 
	`mem£t
(&
cmd
, 0, (cmd));

603 
cmd
.
lba_mid
 = 
blocksize
;

604 
cmd
.
lba_high
 = 
blocksize
 >> 8;

605 
cmd
.
comm™d
 = 
ATA_CMD_PACKET
;

608 
	`outb
(
ATA_CB_DC_HD15
 | 
ATA_CB_DC_NIEN
, 
ioba£2
 + 
ATA_CB_DC
);

610 
ªt
 = 
	`£nd_cmd
(
adrive_gf
, &
cmd
);

611 i‡(
ªt
)

612 
Áû
;

613 
ªt
 = 
	`©a_waô_d©a
(
ioba£1
);

614 i‡(
ªt
)

615 
Áû
;

618 
	`outsw_Ê
(
ioba£1
, 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
cdbcmd
), 
CDROM_CDB_SIZE
 / 2);

620 
°©us
 = 
	`∑u£_awaô_nŸ_bsy
(
ioba£1
, 
ioba£2
);

621 i‡(
°©us
 < 0) {

622 
ªt
 = 
°©us
;

623 
Áû
;

626 i‡(
°©us
 & 
ATA_CB_STAT_ERR
) {

627 
u8
 
îr
 = 
	`öb
(
ioba£1
 + 
ATA_CB_ERR
);

629 i‡(
îr
 != 0x20)

630 
	`d¥ötf
(6, "send_atapi_cmd :ÑeadÉrror (status=%02xÉrr=%02x)\n"

631 , 
°©us
, 
îr
);

632 
ªt
 = -2;

633 
Áû
;

635 i‡(
blocksize
) {

636 i‡(!(
°©us
 & 
ATA_CB_STAT_DRQ
)) {

637 
	`d¥ötf
(6, "£nd_©≠i_cmd : DRQÇŸ së (°©u†%02x)\n", 
°©us
);

638 
ªt
 = -3;

639 
Áû
;

642 
ªt
 = 
	`©a_pio_å™s„r
(
›
, 0, 
blocksize
);

645 
Áû
:

647 
	`outb
(
ATA_CB_DC_HD15
, 
ioba£2
+
ATA_CB_DC
);

648 i‡(
ªt
)

649  
DISK_RET_EBADTRACK
;

650  
DISK_RET_SUCCESS
;

651 
	}
}

660 
	$£nd_©a_idítôy
(
©adrive_s
 *
adrive
, 
u16
 *
buf„r
, 
comm™d
)

662 
	`mem£t
(
buf„r
, 0, 
DISK_SECTOR_SIZE
);

664 
disk_›_s
 
d›
;

665 
	`mem£t
(&
d›
, 0, (dop));

666 
d›
.
drive_gf
 = &
adrive
->
drive
;

667 
d›
.
cou¡
 = 1;

668 
d›
.
lba
 = 1;

669 
d›
.
buf_Ê
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
buf„r
);

671 
©a_pio_comm™d
 
cmd
;

672 
	`mem£t
(&
cmd
, 0, (cmd));

673 
cmd
.
comm™d
 = command;

675  
	`©a_pio_cmd_d©a
(&
d›
, 0, &
cmd
);

676 
	}
}

680 
	$©a_exåa˘_vîsi⁄
(
u16
 *
buf„r
)

683 
u16
 
©avîsi⁄
 = 
buf„r
[80];

684 
u8
 
vîsi⁄
;

685 
vîsi⁄
=15; version>0; version--)

686 i‡(
©avîsi⁄
 & (1<<
vîsi⁄
))

688  
vîsi⁄
;

689 
	}
}

691 
	#MAXMODEL
 40

	)

695 
	$©a_exåa˘_modñ
(*
modñ
, 
u32
 
size
, 
u16
 *
buf„r
)

698 
i
;

699 
i
=0; i<
size
/2; i++)

700 *(
u16
*)&
modñ
[
i
*2] = 
	`be16_to_˝u
(
buf„r
[27+i]);

701 
modñ
[
size
] = 0x00;

702 
	`nuŒTøûögS∑˚
(
modñ
);

703  
modñ
;

704 
	}
}

707 
©adrive_s
 *

708 
	$öô_©adrive
(
©adrive_s
 *
dummy
, 
u16
 *
buf„r
)

710 
©adrive_s
 *
adrive
 = 
	`mÆloc_f£g
((*adrive));

711 i‡(!
adrive
) {

712 
	`w¨n_nﬂŒoc
();

713  
NULL
;

715 
	`mem£t
(
adrive
, 0, (*adrive));

716 
adrive
->
ch™_gf
 = 
dummy
->chan_gf;

717 
adrive
->
¶ave
 = 
dummy
->slave;

718 
adrive
->
drive
.
˙é_id
 =ádrive->
ch™_gf
->
ch™id
 * 2 + 
dummy
->
¶ave
;

719 
adrive
->
drive
.
ªmovabÀ
 = (
buf„r
[0] & 0x80) ? 1 : 0;

720  
adrive
;

721 
	}
}

724 
©adrive_s
 *

725 
	$öô_drive_©≠i
(
©adrive_s
 *
dummy
, 
u16
 *
buf„r
)

728 
ªt
 = 
	`£nd_©a_idítôy
(
dummy
, 
buf„r
, 
ATA_CMD_IDENTIFY_PACKET_DEVICE
);

729 i‡(
ªt
)

730  
NULL
;

733 
©adrive_s
 *
adrive
 = 
	`öô_©adrive
(
dummy
, 
buf„r
);

734 i‡(!
adrive
)

735  
NULL
;

736 
adrive
->
drive
.
ty≥
 = 
DTYPE_ATA_ATAPI
;

737 
adrive
->
drive
.
blksize
 = 
CDROM_SECTOR_SIZE
;

738 
adrive
->
drive
.
£˘‹s
 = (
u64
)-1;

739 
u8
 
iscd
 = ((
buf„r
[0] >> 8) & 0x1f) == 0x05;

740 
modñ
[
MAXMODEL
+1];

741 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE


743 , 
adrive
->
ch™_gf
->
ch™id
,ádrive->
¶ave


744 , 
	`©a_exåa˘_modñ
(
modñ
, 
MAXMODEL
, 
buf„r
)

745 , 
	`©a_exåa˘_vîsi⁄
(
buf„r
)

746 , (
iscd
 ? "DVD/CD" : "Device"));

747 
	`d¥ötf
(1, "%s\n", 
desc
);

750 i‡(
iscd
) {

751 
¥io
 = 
	`boŸ¥io_föd_©a_devi˚
(
adrive
->
ch™_gf
->
pci_tmp
,

752 
adrive
->
ch™_gf
->
ch™id
,

753 
adrive
->
¶ave
);

754 
	`boŸ_add_cd
(&
adrive
->
drive
, 
desc
, 
¥io
);

757  
adrive
;

758 
	}
}

761 
©adrive_s
 *

762 
	$öô_drive_©a
(
©adrive_s
 *
dummy
, 
u16
 *
buf„r
)

765 
ªt
 = 
	`£nd_©a_idítôy
(
dummy
, 
buf„r
, 
ATA_CMD_IDENTIFY_DEVICE
);

766 i‡(
ªt
)

767  
NULL
;

770 
©adrive_s
 *
adrive
 = 
	`öô_©adrive
(
dummy
, 
buf„r
);

771 i‡(!
adrive
)

772  
NULL
;

773 
adrive
->
drive
.
ty≥
 = 
DTYPE_ATA
;

774 
adrive
->
drive
.
blksize
 = 
DISK_SECTOR_SIZE
;

776 
adrive
->
drive
.
pchs
.
cylödî
 = 
buf„r
[1];

777 
adrive
->
drive
.
pchs
.
hód
 = 
buf„r
[3];

778 
adrive
->
drive
.
pchs
.
£˘‹
 = 
buf„r
[6];

780 
u64
 
£˘‹s
;

781 i‡(
buf„r
[83] & (1 << 10))

782 
£˘‹s
 = *(
u64
*)&
buf„r
[100];

784 
£˘‹s
 = *(
u32
*)&
buf„r
[60];

785 
adrive
->
drive
.
£˘‹s
 = sectors;

786 
u64
 
adjsize
 = 
£˘‹s
 >> 11;

787 
adj¥efix
 = 'M';

788 i‡(
adjsize
 >= (1 << 16)) {

789 
adjsize
 >>= 10;

790 
adj¥efix
 = 'G';

792 
modñ
[
MAXMODEL
+1];

793 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE


795 , 
adrive
->
ch™_gf
->
ch™id
,ádrive->
¶ave


796 , 
	`©a_exåa˘_modñ
(
modñ
, 
MAXMODEL
, 
buf„r
)

797 , 
	`©a_exåa˘_vîsi⁄
(
buf„r
)

798 , (
u32
)
adjsize
, 
adj¥efix
);

799 
	`d¥ötf
(1, "%s\n", 
desc
);

801 
¥io
 = 
	`boŸ¥io_föd_©a_devi˚
(
adrive
->
ch™_gf
->
pci_tmp
,

802 
adrive
->
ch™_gf
->
ch™id
,

803 
adrive
->
¶ave
);

805 
	`boŸ_add_hd
(&
adrive
->
drive
, 
desc
, 
¥io
);

807  
adrive
;

808 
	}
}

810 
u32
 
	gSpöupEnd
;

814 
	$powîup_awaô_n⁄_bsy
(
u16
 
ba£
)

816 
u8
 
‹°©us
 = 0;

817 
u8
 
°©us
;

819 
°©us
 = 
	`öb
(
ba£
+
ATA_CB_STAT
);

820 i‡(!(
°©us
 & 
ATA_CB_STAT_BSY
))

822 
‹°©us
 |
°©us
;

823 i‡(
‹°©us
 == 0xff) {

824 
	`d¥ötf
(4, "powerup IDE floating\n");

825  
‹°©us
;

827 i‡(
	`timî_check
(
SpöupEnd
)) {

828 
	`w¨n_timeout
();

831 
	`yõld
();

833 
	`d¥ötf
(6, "powîu∞ioba£=%x st=%x\n", 
ba£
, 
°©us
);

834  
°©us
;

835 
	}
}

839 
	$©a_dëe˘
(*
d©a
)

841 
©a_ch™√l_s
 *
ch™_gf
 = 
d©a
;

842 
©adrive_s
 
dummy
;

843 
	`mem£t
(&
dummy
, 0, (dummy));

844 
dummy
.
ch™_gf
 = chan_gf;

846 
didª£t
 = 0;

847 
u8
 
¶ave
;

848 
¶ave
=0; slave<=1; slave++) {

850 
u16
 
ioba£1
 = 
ch™_gf
->iobase1;

851 
°©us
 = 
	`powîup_awaô_n⁄_bsy
(
ioba£1
);

852 i‡(
°©us
 < 0)

854 
u8
 
√wdh
 = 
¶ave
 ? 
ATA_CB_DH_DEV1
 : 
ATA_CB_DH_DEV0
;

855 
	`outb
(
√wdh
, 
ioba£1
+
ATA_CB_DH
);

856 
	`ndñay
(400);

857 
°©us
 = 
	`powîup_awaô_n⁄_bsy
(
ioba£1
);

858 i‡(
°©us
 < 0)

862 
	`outb
(
√wdh
, 
ioba£1
+
ATA_CB_DH
);

863 
u8
 
dh
 = 
	`öb
(
ioba£1
+
ATA_CB_DH
);

864 
	`outb
(0x55, 
ioba£1
+
ATA_CB_SC
);

865 
	`outb
(0xØ, 
ioba£1
+
ATA_CB_SN
);

866 
u8
 
sc
 = 
	`öb
(
ioba£1
+
ATA_CB_SC
);

867 
u8
 
¢
 = 
	`öb
(
ioba£1
+
ATA_CB_SN
);

868 
	`d¥ötf
(6, "ata_detectáta%d-%d: sc=%x sn=%x dh=%x\n"

869 , 
ch™_gf
->
ch™id
, 
¶ave
, 
sc
, 
¢
, 
dh
);

870 i‡(
sc
 !0x55 || 
¢
 !0xØ || 
dh
 !
√wdh
)

874 
dummy
.
¶ave
 = slave;

877 i‡(!
didª£t
) {

878 
	`©a_ª£t
(&
dummy
);

879 
didª£t
 = 1;

883 
u16
 
buf„r
[256];

884 
©adrive_s
 *
adrive
 = 
	`öô_drive_©≠i
(&
dummy
, 
buf„r
);

885 i‡(!
adrive
) {

887 
u8
 
°
 = 
	`öb
(
ioba£1
+
ATA_CB_STAT
);

888 i‡(!
°
)

893 
ªt
 = 
	`awaô_rdy
(
ioba£1
);

894 i‡(
ªt
 < 0)

898 
adrive
 = 
	`öô_drive_©a
(&
dummy
, 
buf„r
);

899 i‡(!
adrive
)

904 
u16
 
ª£åesu…
 = 
buf„r
[93];

905 
	`d¥ötf
(6, "©a_dëe˘Ñe£åesu…=%04x\n", 
ª£åesu…
);

906 i‡(!
¶ave
 && (
ª£åesu…
 & 0xdf61) == 0x4041)

912 
	}
}

916 
	$öô_c⁄åﬁÀr
(
pci_devi˚
 *
pci
, 
úq


917 , 
u32
 
p‹t1
, u32 
p‹t2
, u32 
ma°î
)

919 
ch™id
 = 0;

920 
©a_ch™√l_s
 *
ch™_gf
 = 
	`mÆloc_f£g
((*chan_gf));

921 i‡(!
ch™_gf
) {

922 
	`w¨n_nﬂŒoc
();

925 
ch™_gf
->
ch™id
 = chanid++;

926 
ch™_gf
->
úq
 = irq;

927 
ch™_gf
->
pci_bdf
 = 
pci
 ?Öci->
bdf
 : -1;

928 
ch™_gf
->
pci_tmp
 = 
pci
;

929 
ch™_gf
->
ioba£1
 = 
p‹t1
;

930 
ch™_gf
->
ioba£2
 = 
p‹t2
;

931 
ch™_gf
->
ioma°î
 = 
ma°î
;

932 
	`d¥ötf
(1, "ATA controller %dát %x/%x/%x (irq %d dev %x)\n"

933 , 
ch™id
, 
p‹t1
, 
p‹t2
, 
ma°î
, 
úq
, 
ch™_gf
->
pci_bdf
);

934 
	`run_thªad
(
©a_dëe˘
, 
ch™_gf
);

935 
	}
}

937 
	#IRQ_ATA1
 14

	)

938 
	#IRQ_ATA2
 15

	)

942 
	$öô_pcüè
(
pci_devi˚
 *
pci
, 
u8
 
¥og_if
)

944 
pci
->
have_drivî
 = 1;

945 
u16
 
bdf
 = 
pci
->bdf;

946 
u8
 
pciúq
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_INTERRUPT_LINE
);

947 
ma°î
 = 0;

948 i‡(
CONFIG_ATA_DMA
 && 
¥og_if
 & 0x80) {

950 
u32
 
b¨
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_4
);

951 i‡(
b¨
 & 
PCI_BASE_ADDRESS_SPACE_IO
) {

952 
ma°î
 = 
b¨
 & 
PCI_BASE_ADDRESS_IO_MASK
;

953 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

957 
u32
 
p‹t1
, 
p‹t2
, 
úq
;

958 i‡(
¥og_if
 & 1) {

959 
p‹t1
 = (
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_0
)

960 & 
PCI_BASE_ADDRESS_IO_MASK
);

961 
p‹t2
 = (
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_1
)

962 & 
PCI_BASE_ADDRESS_IO_MASK
);

963 
úq
 = 
pciúq
;

965 
p‹t1
 = 
PORT_ATA1_CMD_BASE
;

966 
p‹t2
 = 
PORT_ATA1_CTRL_BASE
;

967 
úq
 = 
IRQ_ATA1
;

969 
	`öô_c⁄åﬁÀr
(
pci
, 
úq
, 
p‹t1
, 
p‹t2
, 
ma°î
);

971 i‡(
¥og_if
 & 4) {

972 
p‹t1
 = (
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_2
)

973 & 
PCI_BASE_ADDRESS_IO_MASK
);

974 
p‹t2
 = (
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_3
)

975 & 
PCI_BASE_ADDRESS_IO_MASK
);

976 
úq
 = 
pciúq
;

978 
p‹t1
 = 
PORT_ATA2_CMD_BASE
;

979 
p‹t2
 = 
PORT_ATA2_CTRL_BASE
;

980 
úq
 = 
IRQ_ATA2
;

982 
	`öô_c⁄åﬁÀr
(
pci
, 
úq
, 
p‹t1
, 
p‹t2
, 
ma°î
 ? master + 8 : 0);

983 
	}
}

986 
	$found_gíîiˇè
(
pci_devi˚
 *
pci
, *
¨g
)

988 
	`öô_pcüè
(
pci
,Öci->
¥og_if
);

989 
	}
}

992 
	$found_com∑tibÀahci
(
pci_devi˚
 *
pci
, *
¨g
)

994 i‡(
CONFIG_AHCI
)

997 
	`öô_pcüè
(
pci
, 0x8f);

998 
	}
}

1000 c⁄° 
pci_devi˚_id
 
	gpci_©a_tbl
[] = {

1001 
PCI_DEVICE_CLASS
(
PCI_ANY_ID
, PCI_ANY_ID, 
PCI_CLASS_STORAGE_IDE


1002 , 
found_gíîiˇè
),

1003 
PCI_DEVICE
(
PCI_VENDOR_ID_ATI
, 0x4391, 
found_com∑tibÀahci
),

1004 
PCI_DEVICE_END
,

1009 
	$©a_sˇn
()

1011 i‡(
CONFIG_QEMU
 && 
	`hli°_em±y
(&
PCIDevi˚s
)) {

1014 
	`öô_c⁄åﬁÀr
(
NULL
, 
IRQ_ATA1


1015 , 
PORT_ATA1_CMD_BASE
, 
PORT_ATA1_CTRL_BASE
, 0);

1016 
	`öô_c⁄åﬁÀr
(
NULL
, 
IRQ_ATA2


1017 , 
PORT_ATA2_CMD_BASE
, 
PORT_ATA2_CTRL_BASE
, 0);

1022 
pci_devi˚
 *
pci
;

1023 
	`f‹óchpci
(
pci
) {

1024 
	`pci_öô_devi˚
(
pci_©a_tbl
, 
pci
, 
NULL
);

1026 
	}
}

1029 
	$©a_£tup
()

1031 
	`ASSERT32FLAT
();

1032 i‡(!
CONFIG_ATA
)

1035 
	`d¥ötf
(3, "init hard drives\n");

1037 
SpöupEnd
 = 
	`timî_ˇlc
(
IDE_TIMEOUT
);

1038 
	`©a_sˇn
();

1040 
	`SET_BDA
(
disk_c⁄åﬁ_byã
, 0xc0);

1042 
	`íabÀ_hwúq
(14, 
	`FUNC16
(
íåy_76
));

1043 
	}
}

	@hw/ata.h

1 #i‚de‡
__ATA_H


2 
	#__ATA_H


	)

4 
	~"block.h
"

5 
	~"c⁄fig.h
"

6 
	~"ty≥s.h
"

8 
	s©a_ch™√l_s
 {

9 
u16
 
	mioba£1
;

10 
u16
 
	mioba£2
;

11 
u16
 
	mioma°î
;

12 
u8
 
	múq
;

13 
u8
 
	mch™id
;

14 
	mpci_bdf
;

15 
pci_devi˚
 *
	mpci_tmp
;

18 
	s©adrive_s
 {

19 
drive_s
 
	mdrive
;

20 
©a_ch™√l_s
 *
	mch™_gf
;

21 
u8
 
	m¶ave
;

25 *
©a_exåa˘_modñ
(*
modñ
, 
u32
 
size
, 
u16
 *
buf„r
);

26 
©a_exåa˘_vîsi⁄
(
u16
 *
buf„r
);

27 
cdrom_ªad
(
disk_›_s
 *
›
);

28 
©≠i_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

29 
©a_£tup
();

30 
¥o˚ss_©a_›
(
disk_›_s
 *
›
);

32 
	#PORT_ATA2_CMD_BASE
 0x0170

	)

33 
	#PORT_ATA1_CMD_BASE
 0x01f0

	)

34 
	#PORT_ATA2_CTRL_BASE
 0x0374

	)

35 
	#PORT_ATA1_CTRL_BASE
 0x03f4

	)

39 
	#ATA_CB_DATA
 0

40 
	#ATA_CB_ERR
 1

41 
	#ATA_CB_FR
 1

42 
	#ATA_CB_SC
 2

43 
	#ATA_CB_SN
 3

44 
	#ATA_CB_CL
 4

45 
	#ATA_CB_CH
 5

46 
	#ATA_CB_DH
 6

47 
	#ATA_CB_STAT
 7

48 
	#ATA_CB_CMD
 7

49 

	)

50 
	#ATA_CB_ASTAT
 2

51 
	#ATA_CB_DC
 2

52 
	#ATA_CB_DA
 3

53 

	)

54 
	#ATA_CB_ER_ICRC
 0x80

55 
	#ATA_CB_ER_BBK
 0x80

56 
	#ATA_CB_ER_UNC
 0x40

57 
	#ATA_CB_ER_MC
 0x20

58 
	#ATA_CB_ER_IDNF
 0x10

59 
	#ATA_CB_ER_MCR
 0x08

60 
	#ATA_CB_ER_ABRT
 0x04

61 
	#ATA_CB_ER_NTK0
 0x02

62 
	#ATA_CB_ER_NDAM
 0x01

63 

	)

64 
	#ATA_CB_ER_P_SNSKEY
 0xf0

65 
	#ATA_CB_ER_P_MCR
 0x08

66 
	#ATA_CB_ER_P_ABRT
 0x04

67 
	#ATA_CB_ER_P_EOM
 0x02

68 
	#ATA_CB_ER_P_ILI
 0x01

69 

	)

71 
	#ATA_CB_SC_P_TAG
 0xf8

72 
	#ATA_CB_SC_P_REL
 0x04

73 
	#ATA_CB_SC_P_IO
 0x02

74 
	#ATA_CB_SC_P_CD
 0x01

75 

	)

77 
	#ATA_CB_DH_DEV0
 0xa0

78 
	#ATA_CB_DH_DEV1
 0xb0

79 
	#ATA_CB_DH_LBA
 0x40

80 

	)

82 
	#ATA_CB_STAT_BSY
 0x80

83 
	#ATA_CB_STAT_RDY
 0x40

84 
	#ATA_CB_STAT_DF
 0x20

85 
	#ATA_CB_STAT_WFT
 0x20

86 
	#ATA_CB_STAT_SKC
 0x10

87 
	#ATA_CB_STAT_SERV
 0x10

88 
	#ATA_CB_STAT_DRQ
 0x08

89 
	#ATA_CB_STAT_CORR
 0x04

90 
	#ATA_CB_STAT_IDX
 0x02

91 
	#ATA_CB_STAT_ERR
 0x01

92 
	#ATA_CB_STAT_CHK
 0x01

93 

	)

95 
	#ATA_CB_DC_HD15
 0x08

96 
	#ATA_CB_DC_SRST
 0x04

97 
	#ATA_CB_DC_NIEN
 0x02

98 

	)

100 
	#ATA_CMD_NOP
 0x00

	)

101 
	#ATA_CMD_CFA_REQUEST_EXT_ERR_CODE
 0x03

	)

102 
	#ATA_CMD_DEVICE_RESET
 0x08

	)

103 
	#ATA_CMD_RECALIBRATE
 0x10

	)

104 
	#ATA_CMD_READ_SECTORS
 0x20

	)

105 
	#ATA_CMD_READ_SECTORS_EXT
 0x24

	)

106 
	#ATA_CMD_READ_DMA_EXT
 0x25

	)

107 
	#ATA_CMD_READ_DMA_QUEUED_EXT
 0x26

	)

108 
	#ATA_CMD_READ_NATIVE_MAX_ADDRESS_EXT
 0x27

	)

109 
	#ATA_CMD_READ_MULTIPLE_EXT
 0x29

	)

110 
	#ATA_CMD_READ_LOG_EXT
 0x2F

	)

111 
	#ATA_CMD_WRITE_SECTORS
 0x30

	)

112 
	#ATA_CMD_WRITE_SECTORS_EXT
 0x34

	)

113 
	#ATA_CMD_WRITE_DMA_EXT
 0x35

	)

114 
	#ATA_CMD_WRITE_DMA_QUEUED_EXT
 0x36

	)

115 
	#ATA_CMD_SET_MAX_ADDRESS_EXT
 0x37

	)

116 
	#ATA_CMD_CFA_WRITE_SECTORS_WO_ERASE
 0x38

	)

117 
	#ATA_CMD_WRITE_MULTIPLE_EXT
 0x39

	)

118 
	#ATA_CMD_WRITE_VERIFY
 0x3C

	)

119 
	#ATA_CMD_WRITE_LOG_EXT
 0x3F

	)

120 
	#ATA_CMD_READ_VERIFY_SECTORS
 0x40

	)

121 
	#ATA_CMD_READ_VERIFY_SECTORS_EXT
 0x42

	)

122 
	#ATA_CMD_FORMAT_TRACK
 0x50

	)

123 
	#ATA_CMD_SEEK
 0x70

	)

124 
	#ATA_CMD_CFA_TRANSLATE_SECTOR
 0x87

	)

125 
	#ATA_CMD_EXECUTE_DEVICE_DIAGNOSTIC
 0x90

	)

126 
	#ATA_CMD_INITIALIZE_DEVICE_PARAMETERS
 0x91

	)

127 
	#ATA_CMD_STANDBY_IMMEDIATE2
 0x94

	)

128 
	#ATA_CMD_IDLE_IMMEDIATE2
 0x95

	)

129 
	#ATA_CMD_STANDBY2
 0x96

	)

130 
	#ATA_CMD_IDLE2
 0x97

	)

131 
	#ATA_CMD_CHECK_POWER_MODE2
 0x98

	)

132 
	#ATA_CMD_SLEEP2
 0x99

	)

133 
	#ATA_CMD_PACKET
 0xA0

	)

134 
	#ATA_CMD_IDENTIFY_PACKET_DEVICE
 0xA1

	)

135 
	#ATA_CMD_CFA_ERASE_SECTORS
 0xC0

	)

136 
	#ATA_CMD_READ_MULTIPLE
 0xC4

	)

137 
	#ATA_CMD_WRITE_MULTIPLE
 0xC5

	)

138 
	#ATA_CMD_SET_MULTIPLE_MODE
 0xC6

	)

139 
	#ATA_CMD_READ_DMA_QUEUED
 0xC7

	)

140 
	#ATA_CMD_READ_DMA
 0xC8

	)

141 
	#ATA_CMD_WRITE_DMA
 0xCA

	)

142 
	#ATA_CMD_WRITE_DMA_QUEUED
 0xCC

	)

143 
	#ATA_CMD_CFA_WRITE_MULTIPLE_WO_ERASE
 0xCD

	)

144 
	#ATA_CMD_STANDBY_IMMEDIATE
 0xE0

	)

145 
	#ATA_CMD_IDLE_IMMEDIATE
 0xE1

	)

146 
	#ATA_CMD_STANDBY
 0xE2

	)

147 
	#ATA_CMD_IDLE
 0xE3

	)

148 
	#ATA_CMD_READ_BUFFER
 0xE4

	)

149 
	#ATA_CMD_CHECK_POWER_MODE
 0xE5

	)

150 
	#ATA_CMD_SLEEP
 0xE6

	)

151 
	#ATA_CMD_FLUSH_CACHE
 0xE7

	)

152 
	#ATA_CMD_WRITE_BUFFER
 0xE8

	)

153 
	#ATA_CMD_IDENTIFY_DEVICE
 0xEC

	)

154 
	#ATA_CMD_SET_FEATURES
 0xEF

	)

155 
	#ATA_CMD_READ_NATIVE_MAX_ADDRESS
 0xF8

	)

156 
	#ATA_CMD_SET_MAX
 0xF9

	)

	@hw/bar.h

15 #i‚de‡
__BAR_H


16 
	#__BAR_H


	)

18 
	~<°döt.h
>

21 
ölöe
 
	$b¨Wrôe8
–
uöt32_t
 
b¨
, uöt32_à
off£t
, 
uöt8_t
 
vÆue
 )

23 vﬁ©ûê
uöt8_t
* 
pReg
 = (vﬁ©ûêuöt8_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

24 *
pReg
 = 
vÆue
;

25 
	}
}

27 
ölöe
 
	$b¨Wrôe16
–
uöt32_t
 
b¨
, uöt32_à
off£t
, 
uöt16_t
 
vÆue
 )

29 vﬁ©ûê
uöt16_t
* 
pReg
 = (vﬁ©ûêuöt16_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

30 *
pReg
 = 
vÆue
;

31 
	}
}

33 
ölöe
 
	$b¨Wrôe32
–
uöt32_t
 
b¨
, uöt32_à
off£t
, uöt32_à
vÆue
 )

35 vﬁ©ûê
uöt32_t
* 
pReg
 = (vﬁ©ûêuöt32_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

36 *
pReg
 = 
vÆue
;

37 
	}
}

40 
ölöe
 
uöt8_t
 
	$b¨Ród8
–
uöt32_t
 
b¨
, uöt32_à
off£t
 )

42 vﬁ©ûê
uöt8_t
* 
pReg
 = (vﬁ©ûêuöt8_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

43 –*
pReg
 );

44 
	}
}

46 
ölöe
 
uöt16_t
 
	$b¨Ród16
–
uöt32_t
 
b¨
, uöt32_à
off£t
 )

48 vﬁ©ûê
uöt16_t
* 
pReg
 = (vﬁ©ûêuöt16_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

49 –*
pReg
 );

50 
	}
}

52 
ölöe
 
uöt32_t
 
	$b¨Ród32
–
uöt32_t
 
b¨
, uöt32_à
off£t
 )

54 vﬁ©ûê
uöt32_t
* 
pReg
 = (vﬁ©ûêuöt32_t*)(
b¨
 | ( 
off£t
 & 0xFF ) );

55 –*
pReg
 );

56 
	}
}

	@hw/blockcmd.c

8 
	~"ahci.h
"

9 
	~"©a.h
"

10 
	~"biosv¨.h
"

11 
	~"block.h
"

12 
	~"blockcmd.h
"

13 
	~"byã‹dî.h
"

14 
	~"e•-scsi.h
"

15 
	~"lsi-scsi.h
"

16 
	~"megaßs.h
"

17 
	~"pvscsi.h
"

18 
	~"ouçut.h
"

19 
	~"°d/disk.h
"

20 
	~"°rög.h
"

21 
	~"usb-msc.h
"

22 
	~"usb-uas.h
"

23 
	~"utû.h
"

24 
	~"vútio-scsi.h
"

28 
	$cdb_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

30 
u8
 
ty≥
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->type);

31 
ty≥
) {

32 
DTYPE_ATA_ATAPI
:

33  
	`©≠i_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

34 
DTYPE_USB
:

35  
	`usb_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

36 
DTYPE_UAS
:

37  
	`uas_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

38 
DTYPE_VIRTIO_SCSI
:

39  
	`vútio_scsi_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

40 
DTYPE_LSI_SCSI
:

41  
	`lsi_scsi_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

42 
DTYPE_ESP_SCSI
:

43  
	`e•_scsi_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

44 
DTYPE_MEGASAS
:

45  
	`megaßs_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

46 
DTYPE_USB_32
:

47 i‡(!
MODESEGMENT
)

48  
	`usb_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

49 
DTYPE_UAS_32
:

50 i‡(!
MODESEGMENT
)

51  
	`uas_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

52 
DTYPE_PVSCSI
:

53 i‡(!
MODESEGMENT
)

54  
	`pvscsi_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

55 
DTYPE_AHCI_ATAPI
:

56 i‡(!
MODESEGMENT
)

57  
	`ahci_cmd_d©a
(
›
, 
cdbcmd
, 
blocksize
);

59  
DISK_RET_EPARAM
;

61 
	}
}

65 
	$cdb_is_ªad
(
u8
 *
cdbcmd
, 
u16
 
blocksize
)

67  
blocksize
 && 
cdbcmd
[0] !
CDB_CMD_WRITE_10
;

68 
	}
}

71 
	$scsi_is_ªady
(
disk_›_s
 *
›
)

73 
	`d¥ötf
(6, "scsi_is_ªady (drive=%p)\n", 
›
->
drive_gf
);

78 
ö_¥ogªss
 = 0;

79 
u32
 
íd
 = 
	`timî_ˇlc
(5000);

81 i‡(
	`timî_check
(
íd
)) {

82 
	`d¥ötf
(1, "test unitÑeady failed\n");

86 
ªt
 = 
	`cdb_ã°_unô_ªady
(
›
);

87 i‡(!
ªt
)

91 
cdbªs_ªque°_£n£
 
£n£
;

92 
ªt
 = 
	`cdb_gë_£n£
(
›
, &
£n£
);

93 i‡(
ªt
)

98 i‡(
£n£
.
asc
 == 0x3a) {

99 
	`d¥ötf
(1, "DeviceÑeports MEDIUM NOT PRESENT\n");

103 i‡(
£n£
.
asc
 =0x04 && sí£.
ascq
 =0x01 && !
ö_¥ogªss
) {

105 
	`¥ötf
("Waiting for deviceÅo detect medium... ");

107 
íd
 = 
	`timî_ˇlc
(30000);

108 
ö_¥ogªss
 = 1;

112 
	}
}

116 
	$scsi_drive_£tup
(
drive_s
 *
drive
, c⁄° *
s
, 
¥io
)

118 
disk_›_s
 
d›
;

119 
	`mem£t
(&
d›
, 0, (dop));

120 
d›
.
drive_gf
 = 
drive
;

121 
cdbªs_öquúy
 
d©a
;

122 
ªt
 = 
	`cdb_gë_öquúy
(&
d›
, &
d©a
);

123 i‡(
ªt
)

124  
ªt
;

125 
víd‹
[(
d©a
.víd‹)+1], 
¥odu˘
[(data.product)+1];

126 
ªv
[(
d©a
.rev)+1];

127 
	`°π˝y
(
víd‹
, 
d©a
.vendor, (vendor));

128 
	`nuŒTøûögS∑˚
(
víd‹
);

129 
	`°π˝y
(
¥odu˘
, 
d©a
.product, (product));

130 
	`nuŒTøûögS∑˚
(
¥odu˘
);

131 
	`°π˝y
(
ªv
, 
d©a
.rev, (rev));

132 
	`nuŒTøûögS∑˚
(
ªv
);

133 
pdt
 = 
d©a
.pdt & 0x1f;

134 
ªmovabÀ
 = !!(
d©a
.removable & 0x80);

135 
	`d¥ötf
(1, "%s vendor='%s'Öroduct='%s'Ñev='%s'Åype=%dÑemovable=%d\n"

136 , 
s
, 
víd‹
, 
¥odu˘
, 
ªv
, 
pdt
, 
ªmovabÀ
);

137 
drive
->
ªmovabÀ
 =Ñemovable;

139 i‡(
pdt
 =
SCSI_TYPE_CDROM
) {

140 
drive
->
blksize
 = 
CDROM_SECTOR_SIZE
;

141 
drive
->
£˘‹s
 = (
u64
)-1;

143 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "DVD/CD [%s Drive %s %s %s]"

144 , 
s
, 
víd‹
, 
¥odu˘
, 
ªv
);

145 
	`boŸ_add_cd
(
drive
, 
desc
, 
¥io
);

149 
ªt
 = 
	`scsi_is_ªady
(&
d›
);

150 i‡(
ªt
) {

151 
	`d¥ötf
(1, "scsi_is_ªadyÑëu∫ed %d\n", 
ªt
);

152  
ªt
;

155 
cdbªs_ªad_ˇ∑côy
 
ˇpd©a
;

156 
ªt
 = 
	`cdb_ªad_ˇ∑côy
(&
d›
, &
ˇpd©a
);

157 i‡(
ªt
)

158  
ªt
;

163 
drive
->
blksize
 = 
	`be32_to_˝u
(
ˇpd©a
.blksize);

164 i‡(
drive
->
blksize
 !
DISK_SECTOR_SIZE
) {

165 
	`d¥ötf
(1, "%s: unsuµ‹ãd block sizê%d\n", 
s
, 
drive
->
blksize
);

168 
drive
->
£˘‹s
 = (
u64
)
	`be32_to_˝u
(
ˇpd©a
.sectors) + 1;

169 
	`d¥ötf
(1, "%s blksize=%d sectors=%d\n"

170 , 
s
, 
drive
->
blksize
, ()drive->
£˘‹s
);

180 i‡(
CONFIG_QEMU_HARDWARE
 && 
	`memcmp
(
víd‹
, "QEMU", 5) == 0) {

181 
cdbªs_mode_£n£_geom
 
geomd©a
;

182 
ªt
 = 
	`cdb_mode_£n£_geom
(&
d›
, &
geomd©a
);

183 i‡(
ªt
 == 0) {

184 
u32
 
cylödîs
;

185 
cylödîs
 = 
geomd©a
.
cyl
[0] << 16;

186 
cylödîs
 |
geomd©a
.
cyl
[1] << 8;

187 
cylödîs
 |
geomd©a
.
cyl
[2];

188 i‡(
cylödîs
 && 
geomd©a
.
hóds
 &&

189 
drive
->
£˘‹s
 <= 0xFFFFFFFFULL &&

190 ((
u32
)
drive
->
£˘‹s
 % (
geomd©a
.
hóds
 * 
cylödîs
) == 0)) {

191 
drive
->
pchs
.
cylödî
 = 
cylödîs
;

192 
drive
->
pchs
.
hód
 = 
geomd©a
.
hóds
;

193 
drive
->
pchs
.
£˘‹
 = (
u32
)drive->
£˘‹s
 / (
geomd©a
.
hóds
 * 
cylödîs
);

198 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "%s Drive %s %s %s"

199 , 
s
, 
víd‹
, 
¥odu˘
, 
ªv
);

200 
	`boŸ_add_hd
(
drive
, 
desc
, 
¥io
);

202 
	}
}

205 
	$cdb_gë_öquúy
(
disk_›_s
 *
›
, 
cdbªs_öquúy
 *
d©a
)

207 
cdb_ªque°_£n£
 
cmd
;

208 
	`mem£t
(&
cmd
, 0, (cmd));

209 
cmd
.
comm™d
 = 
CDB_CMD_INQUIRY
;

210 
cmd
.
Àngth
 = (*
d©a
);

211 
›
->
cou¡
 = 1;

212 
›
->
buf_Ê
 = 
d©a
;

213  
	`cdb_cmd_d©a
(
›
, &
cmd
, (*
d©a
));

214 
	}
}

218 
	$cdb_gë_£n£
(
disk_›_s
 *
›
, 
cdbªs_ªque°_£n£
 *
d©a
)

220 
cdb_ªque°_£n£
 
cmd
;

221 
	`mem£t
(&
cmd
, 0, (cmd));

222 
cmd
.
comm™d
 = 
CDB_CMD_REQUEST_SENSE
;

223 
cmd
.
Àngth
 = (*
d©a
);

224 
›
->
cou¡
 = 1;

225 
›
->
buf_Ê
 = 
d©a
;

226  
	`cdb_cmd_d©a
(
›
, &
cmd
, (*
d©a
));

227 
	}
}

231 
	$cdb_ã°_unô_ªady
(
disk_›_s
 *
›
)

233 
cdb_ªque°_£n£
 
cmd
;

234 
	`mem£t
(&
cmd
, 0, (cmd));

235 
cmd
.
comm™d
 = 
CDB_CMD_TEST_UNIT_READY
;

236 
›
->
cou¡
 = 0;

237 
›
->
buf_Ê
 = 
NULL
;

238  
	`cdb_cmd_d©a
(
›
, &
cmd
, 0);

239 
	}
}

243 
	$cdb_ªad_ˇ∑côy
(
disk_›_s
 *
›
, 
cdbªs_ªad_ˇ∑côy
 *
d©a
)

245 
cdb_ªad_ˇ∑côy
 
cmd
;

246 
	`mem£t
(&
cmd
, 0, (cmd));

247 
cmd
.
comm™d
 = 
CDB_CMD_READ_CAPACITY
;

248 
›
->
cou¡
 = 1;

249 
›
->
buf_Ê
 = 
d©a
;

250  
	`cdb_cmd_d©a
(
›
, &
cmd
, (*
d©a
));

251 
	}
}

255 
	$cdb_mode_£n£_geom
(
disk_›_s
 *
›
, 
cdbªs_mode_£n£_geom
 *
d©a
)

257 
cdb_mode_£n£
 
cmd
;

258 
	`mem£t
(&
cmd
, 0, (cmd));

259 
cmd
.
comm™d
 = 
CDB_CMD_MODE_SENSE
;

260 
cmd
.
Êags
 = 8;

261 
cmd
.
∑ge
 = 
MODE_PAGE_HD_GEOMETRY
;

262 
cmd
.
cou¡
 = 
	`˝u_to_be16
((*
d©a
));

263 
›
->
cou¡
 = 1;

264 
›
->
buf_Ê
 = 
d©a
;

265  
	`cdb_cmd_d©a
(
›
, &
cmd
, (*
d©a
));

266 
	}
}

270 
	$cdb_ªad
(
disk_›_s
 *
›
)

272 
cdb_rwd©a_10
 
cmd
;

273 
	`mem£t
(&
cmd
, 0, (cmd));

274 
cmd
.
comm™d
 = 
CDB_CMD_READ_10
;

275 
cmd
.
lba
 = 
	`˝u_to_be32
(
›
->lba);

276 
cmd
.
cou¡
 = 
	`˝u_to_be16
(
›
->count);

277  
	`cdb_cmd_d©a
(
›
, &
cmd
, 
	`GET_GLOBALFLAT
(›->
drive_gf
->
blksize
));

278 
	}
}

282 
	$cdb_wrôe
(
disk_›_s
 *
›
)

284 
cdb_rwd©a_10
 
cmd
;

285 
	`mem£t
(&
cmd
, 0, (cmd));

286 
cmd
.
comm™d
 = 
CDB_CMD_WRITE_10
;

287 
cmd
.
lba
 = 
	`˝u_to_be32
(
›
->lba);

288 
cmd
.
cou¡
 = 
	`˝u_to_be16
(
›
->count);

289  
	`cdb_cmd_d©a
(
›
, &
cmd
, 
	`GET_GLOBALFLAT
(›->
drive_gf
->
blksize
));

290 
	}
}

	@hw/blockcmd.h

2 #i‚de‡
__BLOCKCMD_H


3 
	#__BLOCKCMD_H


	)

5 
	~"ty≥s.h
"

7 
	#CDB_CMD_READ_10
 0x28

	)

8 
	#CDB_CMD_VERIFY_10
 0x2f

	)

9 
	#CDB_CMD_WRITE_10
 0x2a

	)

11 
	scdb_rwd©a_10
 {

12 
u8
 
	mcomm™d
;

13 
u8
 
	mÊags
;

14 
u32
 
	mlba
;

15 
u8
 
	mª§eved_06
;

16 
u16
 
	mcou¡
;

17 
u8
 
	mª£rved_09
;

18 
u8
 
	m∑d
[6];

19 } 
	gPACKED
;

21 
	#CDB_CMD_READ_CAPACITY
 0x25

	)

23 
	scdb_ªad_ˇ∑côy
 {

24 
u8
 
	mcomm™d
;

25 
u8
 
	mÊags
;

26 
u8
 
	mª§eved_02
[8];

27 
u8
 
	m∑d
[6];

28 } 
	gPACKED
;

30 
	scdbªs_ªad_ˇ∑côy
 {

31 
u32
 
	m£˘‹s
;

32 
u32
 
	mblksize
;

33 } 
	gPACKED
;

35 
	#CDB_CMD_TEST_UNIT_READY
 0x00

	)

36 
	#CDB_CMD_INQUIRY
 0x12

	)

37 
	#CDB_CMD_REQUEST_SENSE
 0x03

	)

39 
	scdb_ªque°_£n£
 {

40 
u8
 
	mcomm™d
;

41 
u8
 
	mÊags
;

42 
u16
 
	mª£rved_02
;

43 
u8
 
	mÀngth
;

44 
u8
 
	mª£rved_05
;

45 
u8
 
	m∑d
[10];

46 } 
	gPACKED
;

48 
	scdbªs_ªque°_£n£
 {

49 
u8
 
	mîrcode
;

50 
u8
 
	m£gmít
;

51 
u8
 
	mÊags
;

52 
u32
 
	möfo
;

53 
u8
 
	maddôi⁄Æ
;

54 
u32
 
	m•ecific
;

55 
u8
 
	masc
;

56 
u8
 
	mascq
;

57 
u32
 
	mª£rved_0e
;

58 } 
	gPACKED
;

60 
	#SCSI_TYPE_DISK
 0x00

	)

61 
	#SCSI_TYPE_CDROM
 0x05

	)

63 
	scdbªs_öquúy
 {

64 
u8
 
	mpdt
;

65 
u8
 
	mªmovabÀ
;

66 
u8
 
	mª£rved_02
[2];

67 
u8
 
	maddôi⁄Æ
;

68 
u8
 
	mª£rved_05
[3];

69 
	mvíd‹
[8];

70 
	m¥odu˘
[16];

71 
	mªv
[4];

72 } 
	gPACKED
;

74 
	#CDB_CMD_MODE_SENSE
 0x5A

	)

75 
	#MODE_PAGE_HD_GEOMETRY
 0x04

	)

77 
	scdb_mode_£n£
 {

78 
u8
 
	mcomm™d
;

79 
u8
 
	mÊags
;

80 
u8
 
	m∑ge
;

81 
u32
 
	mª£rved_03
;

82 
u16
 
	mcou¡
;

83 
u8
 
	mª£rved_09
;

84 
u8
 
	m∑d
[6];

85 } 
	gPACKED
;

87 
	scdbªs_mode_£n£_geom
 {

88 
u8
 
	munu£d_00
[3];

89 
u8
 
	mªad_⁄ly
;

90 
u32
 
	munu£d_04
;

91 
u8
 
	m∑ge
;

92 
u8
 
	mÀngth
;

93 
u8
 
	mcyl
[3];

94 
u8
 
	mhóds
;

95 
u8
 
	m¥ecomp
[3];

96 
u8
 
	mªdu˚d
[3];

97 
u16
 
	m°ï_øã
;

98 
u8
 
	mœndög
[3];

99 
u16
 
	mΩm
;

100 } 
	gPACKED
;

103 
cdb_is_ªad
(
u8
 *
cdbcmd
, 
u16
 
blocksize
);

104 
	gdisk_›_s
;

105 
cdb_gë_öquúy
(
disk_›_s
 *
›
, 
cdbªs_öquúy
 *
d©a
);

106 
cdb_gë_£n£
(
disk_›_s
 *
›
, 
cdbªs_ªque°_£n£
 *
d©a
);

107 
cdb_ã°_unô_ªady
(
disk_›_s
 *
›
);

108 
cdb_ªad_ˇ∑côy
(
disk_›_s
 *
›
, 
cdbªs_ªad_ˇ∑côy
 *
d©a
);

109 
cdb_mode_£n£_geom
(
disk_›_s
 *
›
, 
cdbªs_mode_£n£_geom
 *
d©a
);

110 
cdb_öquúy
(
disk_›_s
 *
›
, 
cdbªs_öquúy
 *
d©a
);

111 
cdb_ªad
(
disk_›_s
 *
›
);

112 
cdb_wrôe
(
disk_›_s
 *
›
);

114 
scsi_is_ªady
(
disk_›_s
 *
›
);

115 
	gdrive_s
;

116 
scsi_drive_£tup
(
drive_s
 *
drive
, c⁄° *
s
, 
¥io
);

	@hw/dma.c

8 
	~"utû.h
"

9 
	~"x86.h
"

11 
	#PORT_DMA_ADDR_2
 0x0004

	)

12 
	#PORT_DMA_CNT_2
 0x0005

	)

13 
	#PORT_DMA1_MASK_REG
 0x000a

	)

14 
	#PORT_DMA1_MODE_REG
 0x000b

	)

15 
	#PORT_DMA1_CLEAR_FF_REG
 0x000c

	)

16 
	#PORT_DMA1_MASTER_CLEAR
 0x000d

	)

17 
	#PORT_DMA_PAGE_2
 0x0081

	)

18 
	#PORT_DMA2_MASK_REG
 0x00d4

	)

19 
	#PORT_DMA2_MODE_REG
 0x00d6

	)

20 
	#PORT_DMA2_MASTER_CLEAR
 0x00da

	)

24 
	$dma_Ê›py
(
u32
 
addr
, 
cou¡
, 
isWrôe
)

27 
u16
 
íd
 = 
cou¡
 - 1;

28 
u32
 
œ°_addr
 = 
addr
 + 
íd
;

29 i‡((
addr
 >> 16Ë!(
œ°_addr
 >> 16))

32 
u8
 
mode_ªgi°î
 = 0x46;

33 i‡(
isWrôe
)

34 
mode_ªgi°î
 = 0x4a;

36 
	`outb
(0x06, 
PORT_DMA1_MASK_REG
);

37 
	`outb
(0x00, 
PORT_DMA1_CLEAR_FF_REG
);

38 
	`outb
(
addr
, 
PORT_DMA_ADDR_2
);

39 
	`outb
(
addr
>>8, 
PORT_DMA_ADDR_2
);

40 
	`outb
(0x00, 
PORT_DMA1_CLEAR_FF_REG
);

41 
	`outb
(
íd
, 
PORT_DMA_CNT_2
);

42 
	`outb
(
íd
>>8, 
PORT_DMA_CNT_2
);

46 
	`outb
(
mode_ªgi°î
, 
PORT_DMA1_MODE_REG
);

49 
	`outb
(
addr
>>16, 
PORT_DMA_PAGE_2
);

51 
	`outb
(0x02, 
PORT_DMA1_MASK_REG
);

54 
	}
}

58 
	$dma_£tup
()

61 
	`outb
(0, 
PORT_DMA1_MASTER_CLEAR
);

62 
	`outb
(0, 
PORT_DMA2_MASTER_CLEAR
);

65 
	`outb
(0xc0, 
PORT_DMA2_MODE_REG
);

66 
	`outb
(0x00, 
PORT_DMA2_MASK_REG
);

67 
	}
}

	@hw/esp-scsi.c

13 
	~"biosv¨.h
"

14 
	~"block.h
"

15 
	~"blockcmd.h
"

16 
	~"c⁄fig.h
"

17 
	~"fw/∑øvút.h
"

18 
	~"mÆloc.h
"

19 
	~"ouçut.h
"

20 
	~"pci.h
"

21 
	~"pci_ids.h
"

22 
	~"pci_ªgs.h
"

23 
	~"°d/disk.h
"

24 
	~"°rög.h
"

25 
	~"utû.h
"

27 
	#ESP_TCLO
 0x00

	)

28 
	#ESP_TCMID
 0x04

	)

29 
	#ESP_FIFO
 0x08

	)

30 
	#ESP_CMD
 0x0c

	)

31 
	#ESP_WBUSID
 0x10

	)

32 
	#ESP_TCHI
 0x38

	)

34 
	#ESP_RSTAT
 0x10

	)

35 
	#ESP_RINTR
 0x14

	)

36 
	#ESP_RFLAGS
 0x1c

	)

38 
	#ESP_DMA_CMD
 0x40

	)

39 
	#ESP_DMA_STC
 0x44

	)

40 
	#ESP_DMA_SPA
 0x48

	)

41 
	#ESP_DMA_WBC
 0x4c

	)

42 
	#ESP_DMA_WAC
 0x50

	)

43 
	#ESP_DMA_STAT
 0x54

	)

44 
	#ESP_DMA_SMDLA
 0x58

	)

45 
	#ESP_DMA_WMAC
 0x58c

	)

47 
	#ESP_CMD_DMA
 0x80

	)

48 
	#ESP_CMD_RESET
 0x02

	)

49 
	#ESP_CMD_TI
 0x10

	)

50 
	#ESP_CMD_ICCS
 0x11

	)

51 
	#ESP_CMD_SELATN
 0x42

	)

53 
	#ESP_STAT_DI
 0x01

	)

54 
	#ESP_STAT_CD
 0x02

	)

55 
	#ESP_STAT_MSG
 0x04

	)

56 
	#ESP_STAT_TC
 0x10

	)

58 
	#ESP_INTR_DC
 0x20

	)

60 
	se•_lun_s
 {

61 
drive_s
 
	mdrive
;

62 
pci_devi˚
 *
	mpci
;

63 
u32
 
	mioba£
;

64 
u8
 
	mèrgë
;

65 
u8
 
	mlun
;

69 
	$e•_scsi_dma
(
u32
 
ioba£
, u32 
buf
, u32 
Àn
, 
ªad
)

71 
	`outb
(
Àn
 & 0xff, 
ioba£
 + 
ESP_TCLO
);

72 
	`outb
((
Àn
 >> 8Ë& 0xff, 
ioba£
 + 
ESP_TCMID
);

73 
	`outb
((
Àn
 >> 16Ë& 0xff, 
ioba£
 + 
ESP_TCHI
);

74 
	`oué
(
buf
, 
ioba£
 + 
ESP_DMA_SPA
);

75 
	`oué
(
Àn
, 
ioba£
 + 
ESP_DMA_STC
);

76 
	`outb
(
ªad
 ? 0x83 : 0x03, 
ioba£
 + 
ESP_DMA_CMD
);

77 
	}
}

80 
	$e•_scsi_cmd
(
e•_lun_s
 *
Œun_gf
, 
disk_›_s
 *
›
,

81 
u8
 *
cdbcmd
, 
u16
 
èrgë
, u16 
lun
, u16 
blocksize
)

83 
u32
 
ioba£
 = 
	`GET_GLOBALFLAT
(
Œun_gf
->iobase);

84 
i
, 
°©e
;

85 
u8
 
°©us
;

87 
	`outb
(
èrgë
, 
ioba£
 + 
ESP_WBUSID
);

95 
	`outb
(
lun
, 
ioba£
 + 
ESP_FIFO
);

96 
cdbcmd
[1] &= 0x1f;

97 
cdbcmd
[1] |
lun
 << 5;

98 
i
 = 0; i < 12; i++)

99 
	`outb
(
cdbcmd
[
i
], 
ioba£
 + 
ESP_FIFO
);

100 
	`outb
(
ESP_CMD_SELATN
, 
ioba£
 + 
ESP_CMD
);

102 
°©e
 = 0;;) {

103 
u8
 
°©
 = 
	`öb
(
ioba£
 + 
ESP_RSTAT
);

106 i‡(
°©e
 =0 && (
	`öb
(
ioba£
 + 
ESP_RINTR
Ë& 
ESP_INTR_DC
)) {

107  
DISK_RET_ENOTREADY
;

111 i‡(
°©e
 =0 && (
°©
 & 
ESP_STAT_TC
)) {

112 
°©e
++;

113 i‡(
›
->
cou¡
 && 
blocksize
) {

115 
u32
 
cou¡
 = (u32)
›
->cou¡ * 
blocksize
;

116 
	`e•_scsi_dma
(
ioba£
, (
u32
)
›
->
buf_Ê
, 
cou¡
,

117 
	`cdb_is_ªad
(
cdbcmd
, 
blocksize
));

118 
	`outb
(
ESP_CMD_TI
 | 
ESP_CMD_DMA
, 
ioba£
 + 
ESP_CMD
);

124 i‡(
°©e
 =1 && (
°©
 & 
ESP_STAT_TC
)) {

125 
°©e
++;

126 
	`outb
(
ESP_CMD_ICCS
, 
ioba£
 + 
ESP_CMD
);

131 i‡(
°©e
 =2 && (
°©
 & 
ESP_STAT_MSG
)) {

132 
°©e
++;

133 
°©us
 = 
	`öb
(
ioba£
 + 
ESP_FIFO
);

134 
	`öb
(
ioba£
 + 
ESP_FIFO
);

137 
	`u¶ìp
(5);

140 i‡(
°©us
 == 0) {

141  
DISK_RET_SUCCESS
;

144  
DISK_RET_EBADTRACK
;

145 
	}
}

148 
	$e•_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

150 i‡(!
CONFIG_ESP_SCSI
)

151  
DISK_RET_EBADTRACK
;

153 
e•_lun_s
 *
Œun_gf
 =

154 
	`c⁄èöî_of
(
›
->
drive_gf
, 
e•_lun_s
, 
drive
);

156  
	`e•_scsi_cmd
(
Œun_gf
, 
›
, 
cdbcmd
,

157 
	`GET_GLOBALFLAT
(
Œun_gf
->
èrgë
),

158 
	`GET_GLOBALFLAT
(
Œun_gf
->
lun
),

159 
blocksize
);

160 
	}
}

163 
	$e•_scsi_add_lun
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
, 
u8
 
èrgë
, u8 
lun
)

165 
e•_lun_s
 *
Œun
 = 
	`mÆloc_f£g
((*llun));

166 i‡(!
Œun
) {

167 
	`w¨n_nﬂŒoc
();

170 
	`mem£t
(
Œun
, 0, (*llun));

171 
Œun
->
drive
.
ty≥
 = 
DTYPE_ESP_SCSI
;

172 
Œun
->
drive
.
˙é_id
 = 
pci
->
bdf
;

173 
Œun
->
pci
 =Öci;

174 
Œun
->
èrgë
 =Åarget;

175 
Œun
->
lun
 =Üun;

176 
Œun
->
ioba£
 = iobase;

178 *
«me
 = 
	`z≈rötf
(16, "esp %02x:%02x.%x %d:%d",

179 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

180 
	`pci_bdf_to_‚
(
pci
->
bdf
), 
èrgë
, 
lun
);

181 
¥io
 = 
	`boŸ¥io_föd_scsi_devi˚
(
pci
, 
èrgë
, 
lun
);

182 
ªt
 = 
	`scsi_drive_£tup
(&
Œun
->
drive
, 
«me
, 
¥io
);

183 
	`‰ì
(
«me
);

184 i‡(
ªt
)

185 
Áû
;

188 
Áû
:

189 
	`‰ì
(
Œun
);

191 
	}
}

194 
	$e•_scsi_sˇn_èrgë
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
, 
u8
 
èrgë
)

196 
	`e•_scsi_add_lun
(
pci
, 
ioba£
, 
èrgë
, 0);

197 
	}
}

200 
	$öô_e•_scsi
(
pci_devi˚
 *
pci
)

202 
u16
 
bdf
 = 
pci
->bdf;

203 
u32
 
ioba£
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_BASE_ADDRESS_0
)

204 & 
PCI_BASE_ADDRESS_IO_MASK
;

206 
	`d¥ötf
(1, "foundÉspát %02x:%02x.%x, io @ %x\n",

207 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

208 
	`pci_bdf_to_‚
(
bdf
), 
ioba£
);

210 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

213 
	`outb
(
ESP_CMD_RESET
, 
ioba£
 + 
ESP_CMD
);

215 
i
;

216 
i
 = 0; i <= 7; i++)

217 
	`e•_scsi_sˇn_èrgë
(
pci
, 
ioba£
, 
i
);

220 
	}
}

223 
	$e•_scsi_£tup
()

225 
	`ASSERT32FLAT
();

226 i‡(!
CONFIG_ESP_SCSI
 || !
	`ru¬ögOnQEMU
())

229 
	`d¥ötf
(3, "initÉsp\n");

231 
pci_devi˚
 *
pci
;

232 
	`f‹óchpci
(
pci
) {

233 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_AMD


234 || 
pci
->
devi˚
 !
PCI_DEVICE_ID_AMD_SCSI
)

236 
	`öô_e•_scsi
(
pci
);

238 
	}
}

	@hw/esp-scsi.h

1 #i‚de‡
__ESP_SCSI_H


2 
	#__ESP_SCSI_H


	)

4 
	gdisk_›_s
;

5 
e•_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

6 
e•_scsi_£tup
();

	@hw/floppy.c

8 
	~"biosv¨.h
"

9 
	~"block.h
"

10 
	~"bªgs.h
"

11 
	~"c⁄fig.h
"

12 
	~"mÆloc.h
"

13 
	~"ouçut.h
"

14 
	~"pci.h
"

15 
	~"pci_ids.h
"

16 
	~"pic.h
"

17 
	~"romfûe.h
"

18 
	~"πc.h
"

19 
	~"°acks.h
"

20 
	~"°d/disk.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

24 
	#PORT_FD_BASE
 0x03f0

	)

25 
	#PORT_FD_DOR
 0x03f2

	)

26 
	#PORT_FD_STATUS
 0x03f4

	)

27 
	#PORT_FD_DATA
 0x03f5

	)

28 
	#PORT_FD_DIR
 0x03f7

	)

30 
	#FLOPPY_SIZE_CODE
 0x02

31 
	#FLOPPY_DATALEN
 0xff

32 
	#FLOPPY_MOTOR_TICKS
 37

33 
	#FLOPPY_FILLBYTE
 0xf6

	)

34 
	#FLOPPY_GAPLEN
 0x1B

	)

35 
	#FLOPPY_FORMAT_GAPLEN
 0x6c

	)

36 
	#FLOPPY_PIO_TIMEOUT
 1000

	)

42 
Ê›py_ext_dbt_s
 
diskëã_∑øm_èbÀ2
 
	gVARFSEG
 = {

43 .
dbt
 = {

44 .
•ecify1
 = 0xAF,

45 .
	g•ecify2
 = 0x02,

46 .
	gshutoff_ticks
 = 
FLOPPY_MOTOR_TICKS
,

47 .
	gbps_code
 = 
FLOPPY_SIZE_CODE
,

48 .
	g£˘‹s
 = 18,

49 .
	göãrblock_Àn
 = 
FLOPPY_GAPLEN
,

50 .
	gd©a_Àn
 = 
FLOPPY_DATALEN
,

51 .
	gg≠_Àn
 = 
FLOPPY_FORMAT_GAPLEN
,

52 .
	gfûl_byã
 = 
FLOPPY_FILLBYTE
,

53 .
	g£âÀ_time
 = 0x0F,

54 .
	g°¨tup_time
 = 0x08,

56 .
	gmax_åack
 = 79,

57 .
	gd©a_øã
 = 0,

58 .
	gdrive_ty≥
 = 4,

61 
Ê›py_dbt_s
 
diskëã_∑øm_èbÀ
 
VAR16FIXED
(0xefc7);

63 
	sÊ›pyöfo_s
 {

64 
chs_s
 
	mchs
;

65 
u8
 
	mÊ›py_size
;

66 
u8
 
	md©a_øã
;

69 
	#FLOPPY_SIZE_525
 0x01

	)

70 
	#FLOPPY_SIZE_350
 0x02

	)

72 
	#FLOPPY_RATE_500K
 0x00

	)

73 
	#FLOPPY_RATE_300K
 0x01

	)

74 
	#FLOPPY_RATE_250K
 0x02

	)

75 
	#FLOPPY_RATE_1M
 0x03

	)

77 
Ê›pyöfo_s
 
	gFl›pyInfo
[] 
	gVARFSEG
 = {

81 { {2, 40, 9}, 
FLOPPY_SIZE_525
, 
FLOPPY_RATE_300K
},

83 { {2, 80, 15}, 
FLOPPY_SIZE_525
, 
FLOPPY_RATE_500K
},

85 { {2, 80, 9}, 
FLOPPY_SIZE_350
, 
FLOPPY_RATE_250K
},

87 { {2, 80, 18}, 
FLOPPY_SIZE_350
, 
FLOPPY_RATE_500K
},

89 { {2, 80, 36}, 
FLOPPY_SIZE_350
, 
FLOPPY_RATE_1M
},

91 { {1, 40, 8}, 
FLOPPY_SIZE_525
, 
FLOPPY_RATE_250K
},

93 { {1, 40, 9}, 
FLOPPY_SIZE_525
, 
FLOPPY_RATE_300K
},

95 { {2, 40, 8}, 
FLOPPY_SIZE_525
, 
FLOPPY_RATE_250K
},

98 
drive_s
 *

99 
	$öô_Ê›py
(
Ê›pyid
, 
·y≥
)

101 i‡(
·y≥
 <0 || fty≥ >
	`ARRAY_SIZE
(
Fl›pyInfo
)) {

102 
	`d¥ötf
(1, "Bad fl›pyÅy≥ %d\n", 
·y≥
);

103  
NULL
;

106 
drive_s
 *
drive
 = 
	`mÆloc_f£g
((*drive));

107 i‡(!
drive
) {

108 
	`w¨n_nﬂŒoc
();

109  
NULL
;

111 
	`mem£t
(
drive
, 0, (*drive));

112 
drive
->
˙é_id
 = 
Ê›pyid
;

113 
drive
->
ty≥
 = 
DTYPE_FLOPPY
;

114 
drive
->
blksize
 = 
DISK_SECTOR_SIZE
;

115 
drive
->
Ê›py_ty≥
 = 
·y≥
;

116 
drive
->
£˘‹s
 = (
u64
)-1;

118 
	`mem˝y
(&
drive
->
lchs
, &
Fl›pyInfo
[
·y≥
].
chs


119 , (
Fl›pyInfo
[
·y≥
].
chs
));

120  
drive
;

121 
	}
}

124 
	$addFl›py
(
Ê›pyid
, 
·y≥
)

126 
drive_s
 *
drive
 = 
	`öô_Ê›py
(
Ê›pyid
, 
·y≥
);

127 i‡(!
drive
)

129 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "Fl›py [drivê%c]", 'A' + 
Ê›pyid
);

130 
pci_devi˚
 *
pci
 = 
	`pci_föd_˛ass
(
PCI_CLASS_BRIDGE_ISA
);

131 
¥io
 = 
	`boŸ¥io_föd_fdc_devi˚
(
pci
, 
PORT_FD_BASE
, 
Ê›pyid
);

132 
	`boŸ_add_Ê›py
(
drive
, 
desc
, 
¥io
);

133 
	}
}

136 
	$Ê›py_£tup
()

138 
	`mem˝y
(&
diskëã_∑øm_èbÀ
, &
diskëã_∑øm_èbÀ2


139 , (
diskëã_∑øm_èbÀ
));

140 
	`SET_IVT
(0x1E, 
	`SEGOFF
(
SEG_BIOS


141 , (
u32
)&
diskëã_∑øm_èbÀ2
 - 
BUILD_BIOS_ADDR
));

143 i‡(! 
CONFIG_FLOPPY
)

145 
	`d¥ötf
(3, "init floppy drives\n");

147 i‡(
CONFIG_QEMU
) {

148 
u8
 
ty≥
 = 
	`πc_ªad
(
CMOS_FLOPPY_DRIVE_TYPE
);

149 i‡(
ty≥
 & 0xf0)

150 
	`addFl›py
(0, 
ty≥
 >> 4);

151 i‡(
ty≥
 & 0x0f)

152 
	`addFl›py
(1, 
ty≥
 & 0x0f);

154 
u8
 
ty≥
 = 
	`romfûe_lﬂdöt
("etc/floppy0", 0);

155 i‡(
ty≥
)

156 
	`addFl›py
(0, 
ty≥
);

157 
ty≥
 = 
	`romfûe_lﬂdöt
("etc/floppy1", 0);

158 i‡(
ty≥
)

159 
	`addFl›py
(1, 
ty≥
);

162 
	`íabÀ_hwúq
(6, 
	`FUNC16
(
íåy_0e
));

163 
	}
}

167 
	$föd_Ê›py_ty≥
(
u32
 
size
)

169 
i
;

170 
i
=1; i<
	`ARRAY_SIZE
(
Fl›pyInfo
); i++) {

171 
chs_s
 *
c
 = &
Fl›pyInfo
[
i
].
chs
;

172 i‡(
c
->
cylödî
 * c->
hód
 * c->
£˘‹
 * 
DISK_SECTOR_SIZE
 =
size
)

173  
i
;

176 
	}
}

183 
u8
 
Fl›pyDOR
 
	gVARLOW
;

185 
ölöe
 

186 
	$Ê›py_d‹_wrôe
(
u8
 
vÆ
)

188 
	`outb
(
vÆ
, 
PORT_FD_DOR
);

189 
	`SET_LOW
(
Fl›pyDOR
, 
vÆ
);

190 
	}
}

193 
	$Ê›py_dißbÀ_c⁄åﬁÀr
()

195 
	`d¥ötf
(2, "Floppy_disable_controller\n");

196 
	`Ê›py_d‹_wrôe
(0x00);

197 
	}
}

200 
	$Ê›py_waô_úq
()

202 
u8
 
‰s
 = 
	`GET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
);

203 
	`SET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
, 
‰s
 & ~
FRS_IRQ
);

205 i‡(!
	`GET_BDA
(
Ê›py_mŸ‹_cou¡î
)) {

206 
	`w¨n_timeout
();

207 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

208  
DISK_RET_ETIMEOUT
;

210 
‰s
 = 
	`GET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
);

211 i‡(
‰s
 & 
FRS_IRQ
)

215 
	`yõld
();

218 
	`SET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
, 
‰s
 & ~
FRS_IRQ
);

219  
DISK_RET_SUCCESS
;

220 
	}
}

223 
	#FCF_WAITIRQ
 0x10000

	)

224 
	#FC_CHECKIRQ
 (0x08 | (0<<8Ë| (2<<12))

	)

225 
	#FC_SEEK
 (0x0‡| (2<<8Ë| (0<<12Ë| 
FCF_WAITIRQ
)

	)

226 
	#FC_RECALIBRATE
 (0x07 | (1<<8Ë| (0<<12Ë| 
FCF_WAITIRQ
)

	)

227 
	#FC_READID
 (0x4®| (1<<8Ë| (7<<12Ë| 
FCF_WAITIRQ
)

	)

228 
	#FC_READ
 (0xe6 | (8<<8Ë| (7<<12Ë| 
FCF_WAITIRQ
)

	)

229 
	#FC_WRITE
 (0xc5 | (8<<8Ë| (7<<12Ë| 
FCF_WAITIRQ
)

	)

230 
	#FC_FORMAT
 (0x4d | (5<<8Ë| (7<<12Ë| 
FCF_WAITIRQ
)

	)

234 
	$Ê›py_pio
(
comm™d
, 
u8
 *
∑øm
)

236 
	`d¥ötf
(9, "Fl›pyÖiÿcomm™d %x\n", 
comm™d
);

238 
u32
 
íd
 = 
	`timî_ˇlc
(
FLOPPY_PIO_TIMEOUT
);

239 
£nd
 = (
comm™d
 >> 8) & 0xf;

240 
i
 = 0;

242 
u8
 
°s
 = 
	`öb
(
PORT_FD_STATUS
);

243 i‡(!(
°s
 & 0x80)) {

244 i‡(
	`timî_check
(
íd
)) {

245 
	`w¨n_timeout
();

246 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

247  
DISK_RET_ETIMEOUT
;

251 i‡(
°s
 & 0x40) {

252 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

253  
DISK_RET_ECONTROLLER
;

255 i‡(
i
 == 0)

256 
	`outb
(
comm™d
 & 0xff, 
PORT_FD_DATA
);

258 
	`outb
(
∑øm
[
i
-1], 
PORT_FD_DATA
);

259 i‡(
i
++ >
£nd
)

264 i‡(
comm™d
 & 
FCF_WAITIRQ
) {

265 
ªt
 = 
	`Ê›py_waô_úq
();

266 i‡(
ªt
)

267  
ªt
;

271 
íd
 = 
	`timî_ˇlc
(
FLOPPY_PIO_TIMEOUT
);

272 
ª˚ive
 = (
comm™d
 >> 12) & 0xf;

273 
i
 = 0;

275 
u8
 
°s
 = 
	`öb
(
PORT_FD_STATUS
);

276 i‡(!(
°s
 & 0x80)) {

277 i‡(
	`timî_check
(
íd
)) {

278 
	`w¨n_timeout
();

279 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

280  
DISK_RET_ETIMEOUT
;

284 i‡(
i
 >
ª˚ive
) {

285 i‡(
°s
 & 0x40) {

286 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

287  
DISK_RET_ECONTROLLER
;

291 i‡(!(
°s
 & 0x40)) {

292 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

293  
DISK_RET_ECONTROLLER
;

295 
∑øm
[
i
++] = 
	`öb
(
PORT_FD_DATA
);

298  
DISK_RET_SUCCESS
;

299 
	}
}

302 
	$Ê›py_íabÀ_c⁄åﬁÀr
()

304 
	`d¥ötf
(2, "Floppy_enable_controller\n");

305 
	`SET_BDA
(
Ê›py_mŸ‹_cou¡î
, 
FLOPPY_MOTOR_TICKS
);

306 
	`Ê›py_d‹_wrôe
(0x00);

307 
	`Ê›py_d‹_wrôe
(0x0c);

308 
ªt
 = 
	`Ê›py_waô_úq
();

309 i‡(
ªt
)

310  
ªt
;

312 
u8
 
∑øm
[2];

313  
	`Ê›py_pio
(
FC_CHECKIRQ
, 
∑øm
);

314 
	}
}

318 
	$Ê›py_drive_pio
(
u8
 
Ê›pyid
, 
comm™d
, u8 *
∑øm
)

321 i‡(!(
	`GET_LOW
(
Fl›pyDOR
) & 0x04)) {

322 
ªt
 = 
	`Ê›py_íabÀ_c⁄åﬁÀr
();

323 i‡(
ªt
)

324  
ªt
;

328 
	`SET_BDA
(
Ê›py_mŸ‹_cou¡î
, 
FLOPPY_MOTOR_TICKS
);

331 
	`Ê›py_d‹_wrôe
((
Ê›pyid
 ? 0x20 : 0x10) | 0x0c | floppyid);

334 
ªt
 = 
	`Ê›py_pio
(
comm™d
, 
∑øm
);

335 i‡(
ªt
)

336  
ªt
;

339 i‡((
comm™d
 & 
FCF_WAITIRQ
) && ((command >> 12) & 0xf) == 0)

340  
	`Ê›py_pio
(
FC_CHECKIRQ
, 
∑øm
);

341  
DISK_RET_SUCCESS
;

342 
	}
}

350 
	$Ê›py_drive_ªˇl
(
u8
 
Ê›pyid
)

352 
	`d¥ötf
(2, "Fl›py_drive_ªˇ»%d\n", 
Ê›pyid
);

354 
u8
 
∑øm
[2];

355 
∑øm
[0] = 
Ê›pyid
;

356 
ªt
 = 
	`Ê›py_drive_pio
(
Ê›pyid
, 
FC_RECALIBRATE
, 
∑øm
);

357 i‡(
ªt
)

358  
ªt
;

360 
u8
 
‰s
 = 
	`GET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
);

361 
	`SET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
, 
‰s
 | (1<<
Ê›pyid
));

362 
	`SET_BDA
(
Ê›py_åack
[
Ê›pyid
], 0);

363  
DISK_RET_SUCCESS
;

364 
	}
}

367 
	$Ê›py_drive_ªadid
(
u8
 
Ê›pyid
, u8 
d©a_øã
, u8 
hód
)

370 
	`outb
(
d©a_øã
, 
PORT_FD_DIR
);

373 
u8
 
∑øm
[7];

374 
∑øm
[0] = (
hód
 << 2Ë| 
Ê›pyid
;

375 
ªt
 = 
	`Ê›py_drive_pio
(
Ê›pyid
, 
FC_READID
, 
∑øm
);

376 i‡(
ªt
)

377  
ªt
;

378 i‡(
∑øm
[0] & 0xc0)

381 
	}
}

384 
	$Ê›py_medü_£n£
(
drive_s
 *
drive_gf
)

386 
u8
 
·y≥
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
Ê›py_ty≥
), 
°y≥
 = ftype;

387 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
˙é_id
);

389 
u8
 
d©a_øã
 = 
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].data_rate);

390 
ªt
 = 
	`Ê›py_drive_ªadid
(
Ê›pyid
, 
d©a_øã
, 0);

391 i‡(
ªt
) {

393 
°y≥
=1; ; stype++) {

394 i‡(
°y≥
 >
	`ARRAY_SIZE
(
Fl›pyInfo
))

395  
DISK_RET_EMEDIA
;

396 i‡(
°y≥
==
·y≥


397 || (
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].
Ê›py_size
)

398 !
	`GET_GLOBAL
(
Fl›pyInfo
[
·y≥
].
Ê›py_size
))

399 || (
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].
chs
.
hód
)

400 > 
	`GET_GLOBAL
(
Fl›pyInfo
[
·y≥
].
chs
.
hód
))

401 || (
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].
chs
.
cylödî
)

402 > 
	`GET_GLOBAL
(
Fl›pyInfo
[
·y≥
].
chs
.
cylödî
))

403 || (
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].
chs
.
£˘‹
)

404 > 
	`GET_GLOBAL
(
Fl›pyInfo
[
·y≥
].
chs
.
£˘‹
)))

406 
d©a_øã
 = 
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].data_rate);

407 
ªt
 = 
	`Ê›py_drive_ªadid
(
Ê›pyid
, 
d©a_øã
, 0);

408 i‡(!
ªt
)

412 
	`d¥ötf
(2, "Floppy_media_sense on drive %d foundÑate %d\n"

413 , 
Ê›pyid
, 
d©a_øã
);

415 
u8
 
ﬁd_d©a_øã
 = 
	`GET_BDA
(
Ê›py_medü_°©e
[
Ê›pyid
]) >> 6;

416 
	`SET_BDA
(
Ê›py_œ°_d©a_øã
, (
ﬁd_d©a_øã
<<2Ë| (
d©a_øã
<<6));

417 
u8
 
medü
 = (
°y≥
 == 1 ? 0x04 : (stype == 2 ? 0x05 : 0x07));

418 
u8
 
fms
 = (
d©a_øã
<<6Ë| 
FMS_MEDIA_DRIVE_ESTABLISHED
 | 
medü
;

419 i‡(
	`GET_GLOBAL
(
Fl›pyInfo
[
°y≥
].
chs
.
cylödî
)

420 < 
	`GET_GLOBAL
(
Fl›pyInfo
[
·y≥
].
chs
.
cylödî
))

421 
fms
 |
FMS_DOUBLE_STEPPING
;

422 
	`SET_BDA
(
Ê›py_medü_°©e
[
Ê›pyid
], 
fms
);

424  
DISK_RET_SUCCESS
;

425 
	}
}

429 
	$Ê›py_¥ï
(
drive_s
 *
drive_gf
, 
u8
 
cylödî
)

431 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
drive_gf
->
˙é_id
);

432 i‡(!(
	`GET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
Ë& (1<<
Ê›pyid
)) ||

433 !(
	`GET_BDA
(
Ê›py_medü_°©e
[
Ê›pyid
]Ë& 
FMS_MEDIA_DRIVE_ESTABLISHED
)) {

435 
ªt
 = 
	`Ê›py_drive_ªˇl
(
Ê›pyid
);

436 i‡(
ªt
)

437  
ªt
;

440 
ªt
 = 
	`Ê›py_medü_£n£
(
drive_gf
);

441 i‡(
ªt
)

442  
ªt
;

446 
u8
 
œ°cyl
 = 
	`GET_BDA
(
Ê›py_åack
[
Ê›pyid
]);

447 i‡(
cylödî
 !
œ°cyl
) {

448 
u8
 
∑øm
[2];

449 
∑øm
[0] = 
Ê›pyid
;

450 
∑øm
[1] = 
cylödî
;

451 
ªt
 = 
	`Ê›py_drive_pio
(
Ê›pyid
, 
FC_SEEK
, 
∑øm
);

452 i‡(
ªt
)

453  
ªt
;

454 
	`SET_BDA
(
Ê›py_åack
[
Ê›pyid
], 
cylödî
);

457  
DISK_RET_SUCCESS
;

458 
	}
}

467 
	$Ê›py_dma_cmd
(
disk_›_s
 *
›
, 
cou¡
, 
comm™d
, 
u8
 *
∑øm
)

470 
isWrôe
 = 
comm™d
 !
FC_READ
;

471 
ªt
 = 
	`dma_Ê›py
((
u32
)
›
->
buf_Ê
, 
cou¡
, 
isWrôe
);

472 i‡(
ªt
)

473  
DISK_RET_EBOUNDARY
;

476 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
˙é_id
);

477 
ªt
 = 
	`Ê›py_drive_pio
(
Ê›pyid
, 
comm™d
, 
∑øm
);

478 i‡(
ªt
)

479  
ªt
;

482 
i
;

483 
i
=0; i<7; i++)

484 
	`SET_BDA
(
Ê›py_ªtu∫_°©us
[
i
], 
∑øm
[i]);

486 i‡(
∑øm
[0] & 0xc0) {

487 i‡(
∑øm
[1] & 0x02)

488  
DISK_RET_EWRITEPROTECT
;

489 
	`d¥ötf
(1, "floppyÉrror: %02x %02x %02x %02x %02x %02x %02x\n"

490 , 
∑øm
[0],Öaram[1],Öaram[2],Öaram[3]

491 , 
∑øm
[4],Öaram[5],Öaram[6]);

492  
DISK_RET_ECONTROLLER
;

495  
DISK_RET_SUCCESS
;

496 
	}
}

503 
chs_s


504 
	$lba2chs
(
disk_›_s
 *
›
)

506 
chs_s
 
ªs
 = { };

508 
u32
 
tmp
 = 
›
->
lba
;

509 
u16
 
∆s
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
lchs
.
£˘‹
);

510 
ªs
.
£˘‹
 = (
tmp
 % 
∆s
) + 1;

512 
tmp
 /
∆s
;

513 
u16
 
∆h
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
lchs
.
hód
);

514 
ªs
.
hód
 = 
tmp
 % 
∆h
;

516 
tmp
 /
∆h
;

517 
ªs
.
cylödî
 = 
tmp
;

519  
ªs
;

520 
	}
}

524 
	$Ê›py_ª£t
(
disk_›_s
 *
›
)

526 
	`SET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
, 0);

527 
	`SET_BDA
(
Ê›py_medü_°©e
[0], 0);

528 
	`SET_BDA
(
Ê›py_medü_°©e
[1], 0);

529 
	`SET_BDA
(
Ê›py_åack
[0], 0);

530 
	`SET_BDA
(
Ê›py_åack
[1], 0);

531 
	`SET_BDA
(
Ê›py_œ°_d©a_øã
, 0);

532 
	`Ê›py_dißbÀ_c⁄åﬁÀr
();

533  
	`Ê›py_íabÀ_c⁄åﬁÀr
();

534 
	}
}

538 
	$Ê›py_ªad
(
disk_›_s
 *
›
)

540 
chs_s
 
chs
 = 
	`lba2chs
(
›
);

541 
ªt
 = 
	`Ê›py_¥ï
(
›
->
drive_gf
, 
chs
.
cylödî
);

542 i‡(
ªt
)

543  
ªt
;

546 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
˙é_id
);

547 
u8
 
∑øm
[8];

548 
∑øm
[0] = (
chs
.
hód
 << 2Ë| 
Ê›pyid
;

549 
∑øm
[1] = 
chs
.
cylödî
;

550 
∑øm
[2] = 
chs
.
hód
;

551 
∑øm
[3] = 
chs
.
£˘‹
;

552 
∑øm
[4] = 
FLOPPY_SIZE_CODE
;

553 
∑øm
[5] = 
chs
.
£˘‹
 + 
›
->
cou¡
 - 1;

554 
∑øm
[6] = 
FLOPPY_GAPLEN
;

555 
∑øm
[7] = 
FLOPPY_DATALEN
;

556  
	`Ê›py_dma_cmd
(
›
, op->
cou¡
 * 
DISK_SECTOR_SIZE
, 
FC_READ
, 
∑øm
);

557 
	}
}

561 
	$Ê›py_wrôe
(
disk_›_s
 *
›
)

563 
chs_s
 
chs
 = 
	`lba2chs
(
›
);

564 
ªt
 = 
	`Ê›py_¥ï
(
›
->
drive_gf
, 
chs
.
cylödî
);

565 i‡(
ªt
)

566  
ªt
;

569 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
˙é_id
);

570 
u8
 
∑øm
[8];

571 
∑øm
[0] = (
chs
.
hód
 << 2Ë| 
Ê›pyid
;

572 
∑øm
[1] = 
chs
.
cylödî
;

573 
∑øm
[2] = 
chs
.
hód
;

574 
∑øm
[3] = 
chs
.
£˘‹
;

575 
∑øm
[4] = 
FLOPPY_SIZE_CODE
;

576 
∑øm
[5] = 
chs
.
£˘‹
 + 
›
->
cou¡
 - 1;

577 
∑øm
[6] = 
FLOPPY_GAPLEN
;

578 
∑øm
[7] = 
FLOPPY_DATALEN
;

579  
	`Ê›py_dma_cmd
(
›
, op->
cou¡
 * 
DISK_SECTOR_SIZE
, 
FC_WRITE
, 
∑øm
);

580 
	}
}

584 
	$Ê›py_vîify
(
disk_›_s
 *
›
)

586 
chs_s
 
chs
 = 
	`lba2chs
(
›
);

587 
ªt
 = 
	`Ê›py_¥ï
(
›
->
drive_gf
, 
chs
.
cylödî
);

588 i‡(
ªt
)

589  
ªt
;

592  
DISK_RET_SUCCESS
;

593 
	}
}

597 
	$Ê›py_f‹m©
(
disk_›_s
 *
›
)

599 
chs_s
 
chs
 = 
	`lba2chs
(
›
);

600 
ªt
 = 
	`Ê›py_¥ï
(
›
->
drive_gf
, 
chs
.
cylödî
);

601 i‡(
ªt
)

602  
ªt
;

605 
u8
 
Ê›pyid
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
˙é_id
);

606 
u8
 
∑øm
[7];

607 
∑øm
[0] = (
chs
.
hód
 << 2Ë| 
Ê›pyid
;

608 
∑øm
[1] = 
FLOPPY_SIZE_CODE
;

609 
∑øm
[2] = 
›
->
cou¡
;

610 
∑øm
[3] = 
FLOPPY_FORMAT_GAPLEN
;

611 
∑øm
[4] = 
FLOPPY_FILLBYTE
;

612  
	`Ê›py_dma_cmd
(
›
, op->
cou¡
 * 4, 
FC_FORMAT
, 
∑øm
);

613 
	}
}

616 
	$¥o˚ss_Ê›py_›
(
disk_›_s
 *
›
)

618 i‡(!
CONFIG_FLOPPY
)

621 
›
->
comm™d
) {

622 
CMD_RESET
:

623  
	`Ê›py_ª£t
(
›
);

624 
CMD_READ
:

625  
	`Ê›py_ªad
(
›
);

626 
CMD_WRITE
:

627  
	`Ê›py_wrôe
(
›
);

628 
CMD_VERIFY
:

629  
	`Ê›py_vîify
(
›
);

630 
CMD_FORMAT
:

631  
	`Ê›py_f‹m©
(
›
);

633  
DISK_RET_EPARAM
;

635 
	}
}

643 
VISIBLE16


644 
	$h™dÀ_0e
()

646 i‡(! 
CONFIG_FLOPPY
)

648 
	`debug_i§
(
DEBUG_ISR_0e
);

651 
u8
 
‰s
 = 
	`GET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
);

652 
	`SET_BDA
(
Ê›py_ªˇlibøti⁄_°©us
, 
‰s
 | 
FRS_IRQ
);

654 
	`pic_eoi1
();

655 
	}
}

659 
	$Ê›py_tick
()

661 i‡(! 
CONFIG_FLOPPY
)

665 
u8
 
fcou¡
 = 
	`GET_BDA
(
Ê›py_mŸ‹_cou¡î
);

666 i‡(
fcou¡
) {

667 
fcou¡
--;

668 
	`SET_BDA
(
Ê›py_mŸ‹_cou¡î
, 
fcou¡
);

669 i‡(
fcou¡
 == 0)

671 
	`Ê›py_d‹_wrôe
(
	`GET_LOW
(
Fl›pyDOR
) & ~0xf0);

673 
	}
}

	@hw/lsi-scsi.c

13 
	~"biosv¨.h
"

14 
	~"block.h
"

15 
	~"blockcmd.h
"

16 
	~"c⁄fig.h
"

17 
	~"fw/∑øvút.h
"

18 
	~"mÆloc.h
"

19 
	~"ouçut.h
"

20 
	~"pci.h
"

21 
	~"pci_ids.h
"

22 
	~"pci_ªgs.h
"

23 
	~"°d/disk.h
"

24 
	~"°rög.h
"

25 
	~"utû.h
"

27 
	#LSI_REG_DSTAT
 0x0c

	)

28 
	#LSI_REG_ISTAT0
 0x14

	)

29 
	#LSI_REG_DSP0
 0x2c

	)

30 
	#LSI_REG_DSP1
 0x2d

	)

31 
	#LSI_REG_DSP2
 0x2e

	)

32 
	#LSI_REG_DSP3
 0x2f

	)

33 
	#LSI_REG_SIST0
 0x42

	)

34 
	#LSI_REG_SIST1
 0x43

	)

36 
	#LSI_ISTAT0_DIP
 0x01

	)

37 
	#LSI_ISTAT0_SIP
 0x02

	)

38 
	#LSI_ISTAT0_INTF
 0x04

	)

39 
	#LSI_ISTAT0_CON
 0x08

	)

40 
	#LSI_ISTAT0_SEM
 0x10

	)

41 
	#LSI_ISTAT0_SIGP
 0x20

	)

42 
	#LSI_ISTAT0_SRST
 0x40

	)

43 
	#LSI_ISTAT0_ABRT
 0x80

	)

45 
	slsi_lun_s
 {

46 
drive_s
 
	mdrive
;

47 
pci_devi˚
 *
	mpci
;

48 
u32
 
	mioba£
;

49 
u8
 
	mèrgë
;

50 
u8
 
	mlun
;

54 
	$lsi_scsi_cmd
(
lsi_lun_s
 *
Œun_gf
, 
disk_›_s
 *
›
,

55 *
cdbcmd
, 
u16
 
èrgë
, u16 
lun
, u16 
blocksize
)

57 
u32
 
ioba£
 = 
	`GET_GLOBALFLAT
(
Œun_gf
->iobase);

58 
u32
 
dma
 = ((
	`cdb_is_ªad
(
cdbcmd
, 
blocksize
) ? 0x01000000 : 0x00000000) |

59 (
›
->
cou¡
 * 
blocksize
));

60 
u8
 
msgout
[] = {

61 0x80 | 
lun
,

64 
u8
 
°©us
 = 0xff;

65 
u8
 
msgö_tmp
[2];

66 
u8
 
msgö
 = 0xff;

68 
u32
 
s¸ùt
[] = {

70 0x40000000 | 
èrgë
 << 16,

73 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
msgout
),

75 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
cdbcmd
),

81 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
msgö_tmp
),

85 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
msgö_tmp
),

88 
dma
,

89 (
u32
)
›
->
buf_Ê
,

91 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
°©us
),

93 (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
msgö
),

97 
u32
 
d•
 = (u32)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
s¸ùt
);

99 
	`outb
(
d•
 & 0xff, 
ioba£
 + 
LSI_REG_DSP0
);

100 
	`outb
((
d•
 >> 8Ë& 0xff, 
ioba£
 + 
LSI_REG_DSP1
);

101 
	`outb
((
d•
 >> 16Ë& 0xff, 
ioba£
 + 
LSI_REG_DSP2
);

102 
	`outb
((
d•
 >> 24Ë& 0xff, 
ioba£
 + 
LSI_REG_DSP3
);

105 
u8
 
d°©
 = 
	`öb
(
ioba£
 + 
LSI_REG_DSTAT
);

106 
u8
 
si°0
 = 
	`öb
(
ioba£
 + 
LSI_REG_SIST0
);

107 
u8
 
si°1
 = 
	`öb
(
ioba£
 + 
LSI_REG_SIST1
);

108 i‡(
si°0
 || 
si°1
) {

109 
Áû
;

111 i‡(
d°©
 & 0x04) {

114 
	`u¶ìp
(5);

117 i‡(
msgö
 =0 && 
°©us
 == 0) {

118  
DISK_RET_SUCCESS
;

121 
Áû
:

122  
DISK_RET_EBADTRACK
;

123 
	}
}

126 
	$lsi_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

128 i‡(!
CONFIG_LSI_SCSI
)

129  
DISK_RET_EBADTRACK
;

131 
lsi_lun_s
 *
Œun_gf
 =

132 
	`c⁄èöî_of
(
›
->
drive_gf
, 
lsi_lun_s
, 
drive
);

134  
	`lsi_scsi_cmd
(
Œun_gf
, 
›
, 
cdbcmd
,

135 
	`GET_GLOBALFLAT
(
Œun_gf
->
èrgë
),

136 
	`GET_GLOBALFLAT
(
Œun_gf
->
lun
),

137 
blocksize
);

138 
	}
}

141 
	$lsi_scsi_add_lun
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
, 
u8
 
èrgë
, u8 
lun
)

143 
lsi_lun_s
 *
Œun
 = 
	`mÆloc_f£g
((*llun));

144 i‡(!
Œun
) {

145 
	`w¨n_nﬂŒoc
();

148 
	`mem£t
(
Œun
, 0, (*llun));

149 
Œun
->
drive
.
ty≥
 = 
DTYPE_LSI_SCSI
;

150 
Œun
->
drive
.
˙é_id
 = 
pci
->
bdf
;

151 
Œun
->
pci
 =Öci;

152 
Œun
->
èrgë
 =Åarget;

153 
Œun
->
lun
 =Üun;

154 
Œun
->
ioba£
 = iobase;

156 *
«me
 = 
	`z≈rötf
(16, "lsi %02x:%02x.%x %d:%d",

157 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

158 
	`pci_bdf_to_‚
(
pci
->
bdf
), 
èrgë
, 
lun
);

159 
¥io
 = 
	`boŸ¥io_föd_scsi_devi˚
(
pci
, 
èrgë
, 
lun
);

160 
ªt
 = 
	`scsi_drive_£tup
(&
Œun
->
drive
, 
«me
, 
¥io
);

161 
	`‰ì
(
«me
);

162 i‡(
ªt
)

163 
Áû
;

166 
Áû
:

167 
	`‰ì
(
Œun
);

169 
	}
}

172 
	$lsi_scsi_sˇn_èrgë
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
, 
u8
 
èrgë
)

175 
	`lsi_scsi_add_lun
(
pci
, 
ioba£
, 
èrgë
, 0);

176 
	}
}

179 
	$öô_lsi_scsi
(
pci_devi˚
 *
pci
)

181 
u16
 
bdf
 = 
pci
->bdf;

182 
u32
 
ioba£
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_BASE_ADDRESS_0
)

183 & 
PCI_BASE_ADDRESS_IO_MASK
;

185 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

187 
	`d¥ötf
(1, "foundÜsi53c895aát %02x:%02x.%x, io @ %x\n",

188 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

189 
	`pci_bdf_to_‚
(
bdf
), 
ioba£
);

192 
	`outb
(
LSI_ISTAT0_SRST
, 
ioba£
 + 
LSI_REG_ISTAT0
);

194 
i
;

195 
i
 = 0; i < 7; i++)

196 
	`lsi_scsi_sˇn_èrgë
(
pci
, 
ioba£
, 
i
);

199 
	}
}

202 
	$lsi_scsi_£tup
()

204 
	`ASSERT32FLAT
();

205 i‡(!
CONFIG_LSI_SCSI
 || !
	`ru¬ögOnQEMU
())

208 
	`d¥ötf
(3, "initÜsi53c895a\n");

210 
pci_devi˚
 *
pci
;

211 
	`f‹óchpci
(
pci
) {

212 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_LSI_LOGIC


213 || 
pci
->
devi˚
 !
PCI_DEVICE_ID_LSI_53C895A
)

215 
	`öô_lsi_scsi
(
pci
);

217 
	}
}

	@hw/lsi-scsi.h

1 #i‚de‡
__LSI_SCSI_H


2 
	#__LSI_SCSI_H


	)

4 
	gdisk_›_s
;

5 
lsi_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

6 
lsi_scsi_£tup
();

	@hw/megasas.c

13 
	~"biosv¨.h
"

14 
	~"block.h
"

15 
	~"blockcmd.h
"

16 
	~"c⁄fig.h
"

17 
	~"mÆloc.h
"

18 
	~"ouçut.h
"

19 
	~"pci.h
"

20 
	~"pci_ids.h
"

21 
	~"pci_ªgs.h
"

22 
	~"°acks.h
"

23 
	~"°d/disk.h
"

24 
	~"°rög.h
"

25 
	~"utû.h
"

27 
	#MFI_DB
 0x0

28 
	#MFI_OMSG0
 0x18

29 
	#MFI_IDB
 0x20

30 
	#MFI_ODB
 0x2c

31 
	#MFI_IQP
 0x40

32 
	#MFI_OSP0
 0xb0

33 
	#MFI_IQPL
 0xc0

34 
	#MFI_IQPH
 0xc4

35 

	)

36 
	#MFI_STATE_MASK
 0xf0000000

	)

37 
	#MFI_STATE_WAIT_HANDSHAKE
 0x60000000

	)

38 
	#MFI_STATE_BOOT_MESSAGE_PENDING
 0x90000000

	)

39 
	#MFI_STATE_READY
 0xb0000000

	)

40 
	#MFI_STATE_OPERATIONAL
 0xc0000000

	)

41 
	#MFI_STATE_FAULT
 0xf0000000

	)

45 
	mMFI_CMD_INIT
 = 0x00,

46 
	mMFI_CMD_LD_READ
,

47 
	mMFI_CMD_LD_WRITE
,

48 
	mMFI_CMD_LD_SCSI_IO
,

49 
	mMFI_CMD_PD_SCSI_IO
,

50 
	mMFI_CMD_DCMD
,

51 
	mMFI_CMD_ABORT
,

52 
	mMFI_CMD_SMP
,

53 
	mMFI_CMD_STP


54 } 
	tmfi_cmd_t
;

56 
	smegaßs_cmd_‰ame
 {

57 
u8
 
	mcmd
;

58 
u8
 
	m£n£_Àn
;

59 
u8
 
	mcmd_°©us
;

60 
u8
 
	mscsi_°©us
;

62 
u8
 
	mèrgë_id
;

63 
u8
 
	mlun
;

64 
u8
 
	mcdb_Àn
;

65 
u8
 
	msge_cou¡
;

67 
u32
 
	mc⁄ãxt
;

68 
u32
 
	mc⁄ãxt_64
;

70 
u16
 
	mÊags
;

71 
u16
 
	mtimeout
;

72 
u32
 
	md©a_x„r_Àn
;

76 
u32
 
	m›code
;

77 
u8
 
	mmbox
[12];

78 
u32
 
	msgl_addr
;

79 
u32
 
	msgl_Àn
;

80 
u32
 
	m∑d
;

81 } 
	mdcmd
;

83 
u32
 
	m£n£_buf_lo
;

84 
u32
 
	m£n£_buf_hi
;

85 
u8
 
	mcdb
[16];

86 
u32
 
	msgl_addr
;

87 
u32
 
	msgl_Àn
;

88 } 
	m±hru
;

90 
u8
 
	m∑d
[22];

91 } 
	mgí
;

93 } 
__©åibuã__
 ((
∑cked
));

95 
	smfi_ld_li°_s
 {

96 
u32
 
	mcou¡
;

97 
u32
 
	mª£rved_0
;

99 
u8
 
	mèrgë
;

100 
u8
 
	mlun
;

101 
u16
 
	m£q
;

102 
u8
 
	m°©e
;

103 
u8
 
	mª£rved_1
[3];

104 
u64
 
	msize
;

105 } 
	mlds
[64];

106 } 
__©åibuã__
 ((
∑cked
));

108 
	#MEGASAS_POLL_TIMEOUT
 60000

109 

	)

110 
	smegaßs_lun_s
 {

111 
drive_s
 
	mdrive
;

112 
megaßs_cmd_‰ame
 *
	m‰ame
;

113 
u32
 
	mioba£
;

114 
u16
 
	mpci_id
;

115 
u8
 
	mèrgë
;

116 
u8
 
	mlun
;

119 
	$megaßs_fúe_cmd
(
u16
 
pci_id
, 
u32
 
iﬂddr
,

120 
megaßs_cmd_‰ame
 *
‰ame
)

122 
u32
 
‰ame_addr
 = (u32)
‰ame
;

123 
‰ame_cou¡
 = 1;

124 
u8
 
cmd_°©e
;

126 
	`d¥ötf
(2, "Fømê0x%x\n", 
‰ame_addr
);

127 i‡(
pci_id
 =
PCI_DEVICE_ID_LSI_SAS2004
 ||

128 
pci_id
 =
PCI_DEVICE_ID_LSI_SAS2008
) {

129 
	`oué
(0, 
iﬂddr
 + 
MFI_IQPH
);

130 
	`oué
(
‰ame_addr
 | 
‰ame_cou¡
 << 1 | 1, 
iﬂddr
 + 
MFI_IQPL
);

131 } i‡(
pci_id
 =
PCI_DEVICE_ID_DELL_PERC5
 ||

132 
pci_id
 =
PCI_DEVICE_ID_LSI_SAS1064R
 ||

133 
pci_id
 =
PCI_DEVICE_ID_LSI_VERDE_ZCR
) {

134 
	`oué
(
‰ame_addr
 >> 3 | 
‰ame_cou¡
, 
iﬂddr
 + 
MFI_IQP
);

136 
	`oué
(
‰ame_addr
 | 
‰ame_cou¡
 << 1 | 1, 
iﬂddr
 + 
MFI_IQP
);

139 
u32
 
íd
 = 
	`timî_ˇlc
(
MEGASAS_POLL_TIMEOUT
);

142 
cmd_°©e
 = 
	`GET_LOWFLAT
(
‰ame
->
cmd_°©us
);

143 i‡(
cmd_°©e
 != 0xff)

145 i‡(
	`timî_check
(
íd
)) {

146 
	`w¨n_timeout
();

149 
	`yõld
();

151 } 
cmd_°©e
 == 0xff);

153 i‡(
cmd_°©e
 == 0 || cmd_state == 0x2d)

155 
	`d¥ötf
(1, "ERROR: Fømê0x%x, sètu†0x%x\n", 
‰ame_addr
, 
cmd_°©e
);

157 
	}
}

160 
	$megaßs_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

162 
megaßs_lun_s
 *
mlun_gf
 =

163 
	`c⁄èöî_of
(
›
->
drive_gf
, 
megaßs_lun_s
, 
drive
);

164 
u8
 *
cdb
 = 
cdbcmd
;

165 
megaßs_cmd_‰ame
 *
‰ame
 = 
	`GET_GLOBALFLAT
(
mlun_gf
->frame);

166 
u16
 
pci_id
 = 
	`GET_GLOBALFLAT
(
mlun_gf
->pci_id);

167 
i
;

169 i‡(!
CONFIG_MEGASAS
)

170  
DISK_RET_EBADTRACK
;

172 
	`mem£t_Ê
(
‰ame
, 0, (*frame));

173 
	`SET_LOWFLAT
(
‰ame
->
cmd
, 
MFI_CMD_LD_SCSI_IO
);

174 
	`SET_LOWFLAT
(
‰ame
->
cmd_°©us
, 0xFF);

175 
	`SET_LOWFLAT
(
‰ame
->
èrgë_id
, 
	`GET_GLOBALFLAT
(
mlun_gf
->
èrgë
));

176 
	`SET_LOWFLAT
(
‰ame
->
lun
, 
	`GET_GLOBALFLAT
(
mlun_gf
->lun));

177 
	`SET_LOWFLAT
(
‰ame
->
Êags
, 0x0001);

178 
	`SET_LOWFLAT
(
‰ame
->
d©a_x„r_Àn
, 
›
->
cou¡
 * 
blocksize
);

179 
	`SET_LOWFLAT
(
‰ame
->
cdb_Àn
, 16);

181 
i
 = 0; i < 16; i++) {

182 
	`SET_LOWFLAT
(
‰ame
->
±hru
.
cdb
[
i
], cdb[i]);

184 
	`d¥ötf
(2, "pthru cmd 0x%x count %d bs %d\n",

185 
cdb
[0], 
›
->
cou¡
, 
blocksize
);

187 i‡(
›
->
cou¡
) {

188 
	`SET_LOWFLAT
(
‰ame
->
±hru
.
sgl_addr
, (
u32
)
›
->
buf_Ê
);

189 
	`SET_LOWFLAT
(
‰ame
->
±hru
.
sgl_Àn
, 
›
->
cou¡
 * 
blocksize
);

190 
	`SET_LOWFLAT
(
‰ame
->
sge_cou¡
, 1);

192 
	`SET_LOWFLAT
(
‰ame
->
c⁄ãxt
, (
u32
)frame);

194 i‡(
	`megaßs_fúe_cmd
(
pci_id
, 
	`GET_GLOBALFLAT
(
mlun_gf
->
ioba£
), 
‰ame
) == 0)

195  
DISK_RET_SUCCESS
;

197 
	`d¥ötf
(2, "±hru cmd 0x%x faûed\n", 
cdb
[0]);

198  
DISK_RET_EBADTRACK
;

199 
	}
}

202 
	$megaßs_add_lun
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
, 
u8
 
èrgë
, u8 
lun
)

204 
megaßs_lun_s
 *
mlun
 = 
	`mÆloc_f£g
((*mlun));

205 *
«me
;

206 
¥io
, 
ªt
 = 0;

208 i‡(!
mlun
) {

209 
	`w¨n_nﬂŒoc
();

212 
	`mem£t
(
mlun
, 0, (*mlun));

213 
mlun
->
drive
.
ty≥
 = 
DTYPE_MEGASAS
;

214 
mlun
->
drive
.
˙é_id
 = 
pci
->
bdf
;

215 
mlun
->
pci_id
 = 
pci
->
devi˚
;

216 
mlun
->
èrgë
 =Åarget;

217 
mlun
->
lun
 =Üun;

218 
mlun
->
ioba£
 = iobase;

219 
mlun
->
‰ame
 = 
	`memÆign_low
(256, (
megaßs_cmd_‰ame
));

220 i‡(!
mlun
->
‰ame
) {

221 
	`w¨n_nﬂŒoc
();

222 
	`‰ì
(
mlun
);

225 
«me
 = 
	`z≈rötf
(36, "MegaRAID SAS (PCI %02x:%02x.%x) LD %d:%d",

226 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

227 
	`pci_bdf_to_‚
(
pci
->
bdf
), 
èrgë
, 
lun
);

228 
¥io
 = 
	`boŸ¥io_föd_scsi_devi˚
(
pci
, 
èrgë
, 
lun
);

229 
ªt
 = 
	`scsi_drive_£tup
(&
mlun
->
drive
, 
«me
, 
¥io
);

230 
	`‰ì
(
«me
);

231 i‡(
ªt
) {

232 
	`‰ì
(
mlun
->
‰ame
);

233 
	`‰ì
(
mlun
);

234 
ªt
 = -1;

237  
ªt
;

238 
	}
}

240 
	$megaßs_sˇn_èrgë
(
pci_devi˚
 *
pci
, 
u32
 
ioba£
)

242 
mfi_ld_li°_s
 
ld_li°
;

243 
megaßs_cmd_‰ame
 *
‰ame
 = 
	`memÆign_tmp
(256, (*frame));

244 
i
;

246 
	`mem£t
(&
ld_li°
, 0, (ld_list));

247 
	`mem£t_Ê
(
‰ame
, 0, (*frame));

249 
‰ame
->
cmd
 = 
MFI_CMD_DCMD
;

250 
‰ame
->
cmd_°©us
 = 0xFF;

251 
‰ame
->
sge_cou¡
 = 1;

252 
‰ame
->
Êags
 = 0x0011;

253 
‰ame
->
d©a_x„r_Àn
 = (
ld_li°
);

254 
‰ame
->
dcmd
.
›code
 = 0x03010000;

255 
‰ame
->
dcmd
.
sgl_addr
 = (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ld_li°
);

256 
‰ame
->
dcmd
.
sgl_Àn
 = (
ld_li°
);

257 
‰ame
->
c⁄ãxt
 = (
u32
)frame;

259 i‡(
	`megaßs_fúe_cmd
(
pci
->
devi˚
, 
ioba£
, 
‰ame
) == 0) {

260 
	`d¥ötf
(2, "%d LD found\n", 
ld_li°
.
cou¡
);

261 
i
 = 0; i < 
ld_li°
.
cou¡
; i++) {

262 
	`d¥ötf
(2, "LD %d:%d state 0x%x\n",

263 
ld_li°
.
lds
[
i
].
èrgë
,Üd_li°.lds[i].
lun
,

264 
ld_li°
.
lds
[
i
].
°©e
);

265 i‡(
ld_li°
.
lds
[
i
].
°©e
 != 0) {

266 
	`megaßs_add_lun
(
pci
, 
ioba£
,

267 
ld_li°
.
lds
[
i
].
èrgë
,Üd_li°.lds[i].
lun
);

271 
	}
}

273 
	$megaßs_å™sôi⁄_to_ªady
(
pci_devi˚
 *
pci
, 
u32
 
iﬂddr
)

275 
u32
 
fw_°©e
 = 0, 
√w_°©e
, 
mfi_Êags
 = 0;

277 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS1064R
 ||

278 
pci
->
devi˚
 =
PCI_DEVICE_ID_DELL_PERC5
)

279 
√w_°©e
 = 
	`öl
(
iﬂddr
 + 
MFI_OMSG0
Ë& 
MFI_STATE_MASK
;

281 
√w_°©e
 = 
	`öl
(
iﬂddr
 + 
MFI_OSP0
Ë& 
MFI_STATE_MASK
;

283 
fw_°©e
 !
√w_°©e
) {

284 
√w_°©e
) {

285 
MFI_STATE_FAULT
:

286 
	`d¥ötf
(1, "ERROR: fw in fault state\n");

289 
MFI_STATE_WAIT_HANDSHAKE
:

290 
mfi_Êags
 = 0x08;

292 
MFI_STATE_BOOT_MESSAGE_PENDING
:

293 
mfi_Êags
 |= 0x10;

294 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2004
 ||

295 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2008
 ||

296 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2208
 ||

297 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS3108
) {

298 
	`oué
(
iﬂddr
 + 
MFI_DB
, 
mfi_Êags
);

300 
	`oué
(
iﬂddr
 + 
MFI_IDB
, 
mfi_Êags
);

303 
MFI_STATE_OPERATIONAL
:

304 
mfi_Êags
 = 0x07;

305 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2004
 ||

306 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2008
 ||

307 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2208
 ||

308 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS3108
) {

309 
	`oué
(
iﬂddr
 + 
MFI_DB
, 
mfi_Êags
);

310 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2208
 ||

311 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS3108
) {

312 
j
 = 0;

313 
u32
 
do‹bñl
;

315 
j
 < 
MEGASAS_POLL_TIMEOUT
) {

316 
do‹bñl
 = 
	`öl
(
iﬂddr
 + 
MFI_DB
) & 1;

317 i‡(!
do‹bñl
)

319 
	`m¶ìp
(20);

320 
j
++;

324 
	`outw
(
iﬂddr
 + 
MFI_IDB
, 
mfi_Êags
);

327 
MFI_STATE_READY
:

328 
	`d¥ötf
(2, "MegaRAID SAS fwÑeady\n");

332 
u32
 
íd
 = 
	`timî_ˇlc
(
MEGASAS_POLL_TIMEOUT
);

334 i‡(
	`timî_check
(
íd
)) {

337 
	`yõld
();

338 
fw_°©e
 = 
√w_°©e
;

339 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS1064R
 ||

340 
pci
->
devi˚
 =
PCI_DEVICE_ID_DELL_PERC5
)

341 
√w_°©e
 = 
	`öl
(
iﬂddr
 + 
MFI_OMSG0
Ë& 
MFI_STATE_MASK
;

343 
√w_°©e
 = 
	`öl
(
iﬂddr
 + 
MFI_OSP0
Ë& 
MFI_STATE_MASK
;

344 i‡(
√w_°©e
 !
fw_°©e
) {

349 
	`d¥ötf
(1, "ERROR: fw i¿°©ê%x\n", 
√w_°©e
 & 
MFI_STATE_MASK
);

351 
	}
}

354 
	$öô_megaßs
(
pci_devi˚
 *
pci
)

356 
u16
 
bdf
 = 
pci
->bdf;

357 
u32
 
ioba£
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_BASE_ADDRESS_2
)

358 & 
PCI_BASE_ADDRESS_IO_MASK
;

360 
	`d¥ötf
(1, "found MegaRAID SASát %02x:%02x.%x, io @ %x\n",

361 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

362 
	`pci_bdf_to_‚
(
bdf
), 
ioba£
);

364 
	`pci_c⁄fig_maskw
(
pci
->
bdf
, 
PCI_COMMAND
, 0,

365 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
 | 
PCI_COMMAND_MASTER
);

367 i‡(
	`megaßs_å™sôi⁄_to_ªady
(
pci
, 
ioba£
) == 0)

368 
	`megaßs_sˇn_èrgë
(
pci
, 
ioba£
);

371 
	}
}

374 
	$megaßs_£tup
()

376 
	`ASSERT32FLAT
();

377 i‡(!
CONFIG_MEGASAS
)

380 
	`d¥ötf
(3, "init megasas\n");

382 
pci_devi˚
 *
pci
;

383 
	`f‹óchpci
(
pci
) {

384 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_LSI_LOGIC
 &&

385 
pci
->
víd‹
 !
PCI_VENDOR_ID_DELL
)

387 i‡(
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS1064R
 ||

388 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS1078
 ||

389 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS1078DE
 ||

390 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2108
 ||

391 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2108E
 ||

392 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2004
 ||

393 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2008
 ||

394 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_VERDE_ZCR
 ||

395 
pci
->
devi˚
 =
PCI_DEVICE_ID_DELL_PERC5
 ||

396 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS2208
 ||

397 
pci
->
devi˚
 =
PCI_DEVICE_ID_LSI_SAS3108
)

398 
	`öô_megaßs
(
pci
);

400 
	}
}

	@hw/megasas.h

1 #i‚de‡
__MEGASAS_H


2 
	#__MEGASAS_H


	)

4 
	gdisk_›_s
;

5 
megaßs_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

6 
megaßs_£tup
();

	@hw/pci.c

8 
	~"c⁄fig.h
"

9 
	~"ÁΩå.h
"

10 
	~"mÆloc.h
"

11 
	~"ouçut.h
"

12 
	~"pci.h
"

13 
	~"pci_ids.h
"

14 
	~"pci_ªgs.h
"

15 
	~"romfûe.h
"

16 
	~"°acks.h
"

17 
	~"°rög.h
"

18 
	~"utû.h
"

19 
	~"x86.h
"

21 
	$pci_c⁄fig_wrôñ
(
u16
 
bdf
, 
u32
 
addr
, u32 
vÆ
)

23 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

24 
	`oué
(
vÆ
, 
PORT_PCI_DATA
);

25 
	}
}

27 
	$pci_c⁄fig_wrôew
(
u16
 
bdf
, 
u32
 
addr
, u16 
vÆ
)

29 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

30 
	`outw
(
vÆ
, 
PORT_PCI_DATA
 + (
addr
 & 2));

31 
	}
}

33 
	$pci_c⁄fig_wrôeb
(
u16
 
bdf
, 
u32
 
addr
, 
u8
 
vÆ
)

35 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

36 
	`outb
(
vÆ
, 
PORT_PCI_DATA
 + (
addr
 & 3));

37 
	}
}

39 
u32
 
	$pci_c⁄fig_ªadl
(
u16
 
bdf
, 
u32
 
addr
)

41 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

42  
	`öl
(
PORT_PCI_DATA
);

43 
	}
}

45 
u16
 
	$pci_c⁄fig_ªadw
(
u16
 
bdf
, 
u32
 
addr
)

47 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

48  
	`öw
(
PORT_PCI_DATA
 + (
addr
 & 2));

49 
	}
}

51 
u8
 
	$pci_c⁄fig_ªadb
(
u16
 
bdf
, 
u32
 
addr
)

53 
	`oué
(0x80000000 | (
bdf
 << 8Ë| (
addr
 & 0xfc), 
PORT_PCI_CMD
);

54  
	`öb
(
PORT_PCI_DATA
 + (
addr
 & 3));

55 
	}
}

58 
	$pci_c⁄fig_maskw
(
u16
 
bdf
, 
u32
 
addr
, u16 
off
, u16 
⁄
)

60 
u16
 
vÆ
 = 
	`pci_c⁄fig_ªadw
(
bdf
, 
addr
);

61 
vÆ
 = (vÆ & ~
off
Ë| 
⁄
;

62 
	`pci_c⁄fig_wrôew
(
bdf
, 
addr
, 
vÆ
);

63 
	}
}

67 
	$pci_√xt
(
bdf
, 
bus
)

69 i‡(
	`pci_bdf_to_‚
(
bdf
) == 0

70 && (
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_HEADER_TYPE
) & 0x80) == 0)

73 
bdf
 += 8;

75 
bdf
 += 1;

78 i‡(
	`pci_bdf_to_bus
(
bdf
Ë!
bus
)

81 
u16
 
v
 = 
	`pci_c⁄fig_ªadw
(
bdf
, 
PCI_VENDOR_ID
);

82 i‡(
v
 != 0x0000 && v != 0xffff)

84  
bdf
;

86 i‡(
	`pci_bdf_to_‚
(
bdf
) == 0)

87 
bdf
 += 8;

89 
bdf
 += 1;

91 
	}
}

93 
hli°_hód
 
PCIDevi˚s
 
	gVARVERIFY32INIT
;

94 
MaxPCIBus
 
	gVARFSEG
;

98 
	$pci_¥obe_ho°
()

100 
	`oué
(0x80000000, 
PORT_PCI_CMD
);

101 i‡(
	`öl
(
PORT_PCI_CMD
) != 0x80000000) {

102 
	`d¥ötf
(1, "DetectedÇon-PCI system\n");

106 
	}
}

110 
	$pci_¥obe_devi˚s
()

112 
	`d¥ötf
(3, "PCIÖrobe\n");

113 
pci_devi˚
 *
busdevs
[256];

114 
	`mem£t
(
busdevs
, 0, (busdevs));

115 
hli°_node
 **
µªv
 = &
PCIDevi˚s
.
fú°
;

116 
exå¨oŸs
 = 
	`romfûe_lﬂdöt
("etc/extra-pci-roots", 0);

117 
bus
 = -1, 
œ°bus
 = 0, 
roŸbu£s
 = 0, 
cou¡
=0;

118 
bus
 < 0xf‡&& (bu†< 
MaxPCIBus
 || 
roŸbu£s
 < 
exå¨oŸs
)) {

119 
bus
++;

120 
bdf
;

121 
	`f‹óchbdf
(
bdf
, 
bus
) {

123 
pci_devi˚
 *
dev
 = 
	`mÆloc_tmp
((*dev));

124 i‡(!
dev
) {

125 
	`w¨n_nﬂŒoc
();

128 
	`mem£t
(
dev
, 0, (*dev));

129 
	`hli°_add
(&
dev
->
node
, 
µªv
);

130 
µªv
 = &
dev
->
node
.
√xt
;

131 
cou¡
++;

134 
roŸbus
;

135 
pci_devi˚
 *
∑ª¡
 = 
busdevs
[
bus
];

136 i‡(!
∑ª¡
) {

137 i‡(
bus
 !
œ°bus
)

138 
roŸbu£s
++;

139 
œ°bus
 = 
bus
;

140 
roŸbus
 = 
roŸbu£s
;

141 i‡(
bus
 > 
MaxPCIBus
)

142 
MaxPCIBus
 = 
bus
;

144 
roŸbus
 = 
∑ª¡
->rootbus;

148 
dev
->
bdf
 = bdf;

149 
dev
->
∑ª¡
 =Öarent;

150 
dev
->
roŸbus
 =Ñootbus;

151 
u32
 
vídev
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_VENDOR_ID
);

152 
dev
->
víd‹
 = 
vídev
 & 0xffff;

153 
dev
->
devi˚
 = 
vídev
 >> 16;

154 
u32
 
˛as§ev
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_CLASS_REVISION
);

155 
dev
->
˛ass
 = 
˛as§ev
 >> 16;

156 
dev
->
¥og_if
 = 
˛as§ev
 >> 8;

157 
dev
->
ªvisi⁄
 = 
˛as§ev
 & 0xff;

158 
dev
->
hódî_ty≥
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_HEADER_TYPE
);

159 
u8
 
v
 = 
dev
->
hódî_ty≥
 & 0x7f;

160 i‡(
v
 =
PCI_HEADER_TYPE_BRIDGE
 || v =
PCI_HEADER_TYPE_CARDBUS
) {

161 
u8
 
£cbus
 = 
	`pci_c⁄fig_ªadb
(
bdf
, 
PCI_SECONDARY_BUS
);

162 
dev
->
£c⁄d¨y_bus
 = 
£cbus
;

163 i‡(
£cbus
 > 
bus
 && !
busdevs
[secbus])

164 
busdevs
[
£cbus
] = 
dev
;

165 i‡(
£cbus
 > 
MaxPCIBus
)

166 
MaxPCIBus
 = 
£cbus
;

168 
	`d¥ötf
(4, "PCI device %02x:%02x.%x (vd=%04x:%04x c=%04x)\n"

169 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf)

170 , 
	`pci_bdf_to_‚
(
bdf
)

171 , 
dev
->
víd‹
, dev->
devi˚
, dev->
˛ass
);

174 
	`d¥ötf
(1, "Found %d PCI devi˚†(max PCI bu†i†%02x)\n", 
cou¡
, 
MaxPCIBus
);

175 
	}
}

178 
pci_devi˚
 *

179 
	$pci_föd_devi˚
(
u16
 
vídid
, u16 
devid
)

181 
pci_devi˚
 *
pci
;

182 
	`f‹óchpci
(
pci
) {

183 i‡(
pci
->
víd‹
 =
vídid
 &&Öci->
devi˚
 =
devid
)

184  
pci
;

186  
NULL
;

187 
	}
}

190 
pci_devi˚
 *

191 
	$pci_föd_˛ass
(
u16
 
˛assid
)

193 
pci_devi˚
 *
pci
;

194 
	`f‹óchpci
(
pci
) {

195 i‡(
pci
->
˛ass
 =
˛assid
)

196  
pci
;

198  
NULL
;

199 
	}
}

201 
	$pci_öô_devi˚
(c⁄° 
pci_devi˚_id
 *
ids


202 , 
pci_devi˚
 *
pci
, *
¨g
)

204 
ids
->
vídid
 || ids->
˛ass_mask
) {

205 i‡((
ids
->
vídid
 =
PCI_ANY_ID
 || ids->vídid =
pci
->
víd‹
) &&

206 (
ids
->
devid
 =
PCI_ANY_ID
 || ids->devid =
pci
->
devi˚
) &&

207 !((
ids
->
˛ass
 ^ 
pci
->˛assË& ids->
˛ass_mask
)) {

208 i‡(
ids
->
func
)

209 
ids
->
	`func
(
pci
, 
¨g
);

212 
ids
++;

215 
	}
}

217 
pci_devi˚
 *

218 
	$pci_föd_öô_devi˚
(c⁄° 
pci_devi˚_id
 *
ids
, *
¨g
)

220 
pci_devi˚
 *
pci
;

221 
	`f‹óchpci
(
pci
) {

222 i‡(
	`pci_öô_devi˚
(
ids
, 
pci
, 
¨g
) == 0)

223  
pci
;

225  
NULL
;

226 
	}
}

229 
	$pci_ªboŸ
()

231 
u8
 
v
 = 
	`öb
(
PORT_PCI_REBOOT
) & ~6;

232 
	`outb
(
v
|2, 
PORT_PCI_REBOOT
);

233 
	`udñay
(50);

234 
	`outb
(
v
|6, 
PORT_PCI_REBOOT
);

235 
	`udñay
(50);

236 
	}
}

	@hw/pci.h

1 #i‚de‡
__PCI_H


2 
	#__PCI_H


	)

4 
	~"ty≥s.h
"

5 
	~"li°.h
"

7 
	#PORT_PCI_CMD
 0x0cf8

	)

8 
	#PORT_PCI_REBOOT
 0x0cf9

	)

9 
	#PORT_PCI_DATA
 0x0cfc

	)

11 
	#PCI_ROM_SLOT
 6

	)

12 
	#PCI_NUM_REGIONS
 7

	)

13 
	#PCI_BRIDGE_NUM_REGIONS
 2

	)

15 
ölöe
 
u8
 
	$pci_bdf_to_bus
(
u16
 
bdf
) {

16  
bdf
 >> 8;

17 
	}
}

18 
ölöe
 
u8
 
	$pci_bdf_to_dev‚
(
u16
 
bdf
) {

19  
bdf
 & 0xff;

20 
	}
}

21 
ölöe
 
u16
 
	$pci_bdf_to_busdev
(
u16
 
bdf
) {

22  
bdf
 & ~0x07;

23 
	}
}

24 
ölöe
 
u8
 
	$pci_bdf_to_dev
(
u16
 
bdf
) {

25  (
bdf
 >> 3) & 0x1f;

26 
	}
}

27 
ölöe
 
u8
 
	$pci_bdf_to_‚
(
u16
 
bdf
) {

28  
bdf
 & 0x07;

29 
	}
}

30 
ölöe
 
u16
 
	$pci_to_bdf
(
bus
, 
dev
, 
‚
) {

31  (
bus
<<8Ë| (
dev
<<3Ë| 
‚
;

32 
	}
}

33 
ölöe
 
u16
 
	$pci_bus_dev‚_to_bdf
(
bus
, 
u16
 
dev‚
) {

34  (
bus
 << 8Ë| 
dev‚
;

35 
	}
}

37 
pci_c⁄fig_wrôñ
(
u16
 
bdf
, 
u32
 
addr
, u32 
vÆ
);

38 
pci_c⁄fig_wrôew
(
u16
 
bdf
, 
u32
 
addr
, u16 
vÆ
);

39 
pci_c⁄fig_wrôeb
(
u16
 
bdf
, 
u32
 
addr
, 
u8
 
vÆ
);

40 
u32
 
pci_c⁄fig_ªadl
(
u16
 
bdf
, u32 
addr
);

41 
u16
 
pci_c⁄fig_ªadw
(u16 
bdf
, 
u32
 
addr
);

42 
u8
 
pci_c⁄fig_ªadb
(
u16
 
bdf
, 
u32
 
addr
);

43 
pci_c⁄fig_maskw
(
u16
 
bdf
, 
u32
 
addr
, u16 
off
, u16 
⁄
);

45 
pci_devi˚
 *
pci_föd_devi˚
(
u16
 
vídid
, u16 
devid
);

46 
pci_devi˚
 *
pci_föd_˛ass
(
u16
 
˛assid
);

48 
	spci_devi˚
 {

49 
u16
 
	mbdf
;

50 
u8
 
	mroŸbus
;

51 
hli°_node
 
	mnode
;

52 
pci_devi˚
 *
	m∑ª¡
;

55 
u16
 
	mvíd‹
, 
	mdevi˚
;

56 
u16
 
	m˛ass
;

57 
u8
 
	m¥og_if
, 
	mªvisi⁄
;

58 
u8
 
	mhódî_ty≥
;

59 
u8
 
	m£c⁄d¨y_bus
;

62 
	mhave_drivî
;

64 
u64
 
pcimem_°¨t
, 
pcimem_íd
;

65 
u64
 
pcimem64_°¨t
, 
pcimem64_íd
;

66 
hli°_hód
 
PCIDevi˚s
;

67 
MaxPCIBus
;

68 
pci_¥obe_ho°
();

69 
pci_¥obe_devi˚s
();

70 
ölöe
 
u32
 
	$pci_˛as•rog
(
pci_devi˚
 *
pci
) {

71  (
pci
->
˛ass
 << 8Ë|Öci->
¥og_if
;

72 
	}
}

74 
	#f‹óchpci
(
PCI
) \

75 
	`hli°_f‹_óch_íåy
(
PCI
, &
PCIDevi˚s
, 
node
)

	)

77 
pci_√xt
(
bdf
, 
bus
);

78 
	#f‹óchbdf
(
BDF
, 
BUS
) \

79 
BDF
=
	`pci_√xt
(
	`pci_bus_dev‚_to_bdf
((
BUS
), 0)-1, (BUS)) \

80 ; 
BDF
 >= 0 \

81 ; 
BDF
=
	`pci_√xt
(BDF, (
BUS
)))

	)

83 
	#PCI_ANY_ID
 (~0)

	)

84 
	spci_devi˚_id
 {

85 
u32
 
	mvídid
;

86 
u32
 
	mdevid
;

87 
u32
 
	m˛ass
;

88 
u32
 
	m˛ass_mask
;

89 (*
	mfunc
)(
pci_devi˚
 *
	mpci
, *
	m¨g
);

92 
	#PCI_DEVICE
(
víd‹_id
, 
devi˚_id
, 
öô_func
) \

94 .
vídid
 = (
víd‹_id
), \

95 .
devid
 = (
devi˚_id
), \

96 .
˛ass
 = 
PCI_ANY_ID
, \

97 .
˛ass_mask
 = 0, \

98 .
func
 = (
öô_func
) \

99 }

	)

101 
	#PCI_DEVICE_CLASS
(
víd‹_id
, 
devi˚_id
, 
˛ass_code
, 
öô_func
) \

103 .
vídid
 = (
víd‹_id
), \

104 .
devid
 = (
devi˚_id
), \

105 .
˛ass
 = (
˛ass_code
), \

106 .
˛ass_mask
 = ~0, \

107 .
func
 = (
öô_func
) \

108 }

	)

110 
	#PCI_DEVICE_END
 \

112 .
vídid
 = 0, \

113 }

	)

115 
pci_öô_devi˚
(c⁄° 
pci_devi˚_id
 *
ids


116 , 
pci_devi˚
 *
pci
, *
¨g
);

117 
pci_devi˚
 *
pci_föd_öô_devi˚
(c⁄° 
pci_devi˚_id
 *
ids


118 , *
¨g
);

119 
pci_ªboŸ
();

	@hw/pci_ids.h

9 
	#PCI_CLASS_NOT_DEFINED
 0x0000

	)

10 
	#PCI_CLASS_NOT_DEFINED_VGA
 0x0001

	)

12 
	#PCI_BASE_CLASS_STORAGE
 0x01

	)

13 
	#PCI_CLASS_STORAGE_SCSI
 0x0100

	)

14 
	#PCI_CLASS_STORAGE_IDE
 0x0101

	)

15 
	#PCI_CLASS_STORAGE_FLOPPY
 0x0102

	)

16 
	#PCI_CLASS_STORAGE_IPI
 0x0103

	)

17 
	#PCI_CLASS_STORAGE_RAID
 0x0104

	)

18 
	#PCI_CLASS_STORAGE_SATA
 0x0106

	)

19 
	#PCI_CLASS_STORAGE_SATA_AHCI
 0x010601

	)

20 
	#PCI_CLASS_STORAGE_SAS
 0x0107

	)

21 
	#PCI_CLASS_STORAGE_OTHER
 0x0180

	)

23 
	#PCI_BASE_CLASS_NETWORK
 0x02

	)

24 
	#PCI_CLASS_NETWORK_ETHERNET
 0x0200

	)

25 
	#PCI_CLASS_NETWORK_TOKEN_RING
 0x0201

	)

26 
	#PCI_CLASS_NETWORK_FDDI
 0x0202

	)

27 
	#PCI_CLASS_NETWORK_ATM
 0x0203

	)

28 
	#PCI_CLASS_NETWORK_OTHER
 0x0280

	)

30 
	#PCI_BASE_CLASS_DISPLAY
 0x03

	)

31 
	#PCI_CLASS_DISPLAY_VGA
 0x0300

	)

32 
	#PCI_CLASS_DISPLAY_XGA
 0x0301

	)

33 
	#PCI_CLASS_DISPLAY_3D
 0x0302

	)

34 
	#PCI_CLASS_DISPLAY_OTHER
 0x0380

	)

36 
	#PCI_BASE_CLASS_MULTIMEDIA
 0x04

	)

37 
	#PCI_CLASS_MULTIMEDIA_VIDEO
 0x0400

	)

38 
	#PCI_CLASS_MULTIMEDIA_AUDIO
 0x0401

	)

39 
	#PCI_CLASS_MULTIMEDIA_PHONE
 0x0402

	)

40 
	#PCI_CLASS_MULTIMEDIA_OTHER
 0x0480

	)

42 
	#PCI_BASE_CLASS_MEMORY
 0x05

	)

43 
	#PCI_CLASS_MEMORY_RAM
 0x0500

	)

44 
	#PCI_CLASS_MEMORY_FLASH
 0x0501

	)

45 
	#PCI_CLASS_MEMORY_OTHER
 0x0580

	)

47 
	#PCI_BASE_CLASS_BRIDGE
 0x06

	)

48 
	#PCI_CLASS_BRIDGE_HOST
 0x0600

	)

49 
	#PCI_CLASS_BRIDGE_ISA
 0x0601

	)

50 
	#PCI_CLASS_BRIDGE_EISA
 0x0602

	)

51 
	#PCI_CLASS_BRIDGE_MC
 0x0603

	)

52 
	#PCI_CLASS_BRIDGE_PCI
 0x0604

	)

53 
	#PCI_CLASS_BRIDGE_PCMCIA
 0x0605

	)

54 
	#PCI_CLASS_BRIDGE_NUBUS
 0x0606

	)

55 
	#PCI_CLASS_BRIDGE_CARDBUS
 0x0607

	)

56 
	#PCI_CLASS_BRIDGE_RACEWAY
 0x0608

	)

57 
	#PCI_CLASS_BRIDGE_OTHER
 0x0680

	)

59 
	#PCI_BASE_CLASS_COMMUNICATION
 0x07

	)

60 
	#PCI_CLASS_COMMUNICATION_SERIAL
 0x0700

	)

61 
	#PCI_CLASS_COMMUNICATION_PARALLEL
 0x0701

	)

62 
	#PCI_CLASS_COMMUNICATION_MULTISERIAL
 0x0702

	)

63 
	#PCI_CLASS_COMMUNICATION_MODEM
 0x0703

	)

64 
	#PCI_CLASS_COMMUNICATION_OTHER
 0x0780

	)

66 
	#PCI_BASE_CLASS_SYSTEM
 0x08

	)

67 
	#PCI_CLASS_SYSTEM_PIC
 0x0800

	)

68 
	#PCI_CLASS_SYSTEM_PIC_IOAPIC
 0x080010

	)

69 
	#PCI_CLASS_SYSTEM_PIC_IOXAPIC
 0x080020

	)

70 
	#PCI_CLASS_SYSTEM_DMA
 0x0801

	)

71 
	#PCI_CLASS_SYSTEM_TIMER
 0x0802

	)

72 
	#PCI_CLASS_SYSTEM_RTC
 0x0803

	)

73 
	#PCI_CLASS_SYSTEM_PCI_HOTPLUG
 0x0804

	)

74 
	#PCI_CLASS_SYSTEM_SDHCI
 0x0805

	)

75 
	#PCI_CLASS_SYSTEM_OTHER
 0x0880

	)

77 
	#PCI_BASE_CLASS_INPUT
 0x09

	)

78 
	#PCI_CLASS_INPUT_KEYBOARD
 0x0900

	)

79 
	#PCI_CLASS_INPUT_PEN
 0x0901

	)

80 
	#PCI_CLASS_INPUT_MOUSE
 0x0902

	)

81 
	#PCI_CLASS_INPUT_SCANNER
 0x0903

	)

82 
	#PCI_CLASS_INPUT_GAMEPORT
 0x0904

	)

83 
	#PCI_CLASS_INPUT_OTHER
 0x0980

	)

85 
	#PCI_BASE_CLASS_DOCKING
 0x0a

	)

86 
	#PCI_CLASS_DOCKING_GENERIC
 0x0a00

	)

87 
	#PCI_CLASS_DOCKING_OTHER
 0x0a80

	)

89 
	#PCI_BASE_CLASS_PROCESSOR
 0x0b

	)

90 
	#PCI_CLASS_PROCESSOR_386
 0x0b00

	)

91 
	#PCI_CLASS_PROCESSOR_486
 0x0b01

	)

92 
	#PCI_CLASS_PROCESSOR_PENTIUM
 0x0b02

	)

93 
	#PCI_CLASS_PROCESSOR_ALPHA
 0x0b10

	)

94 
	#PCI_CLASS_PROCESSOR_POWERPC
 0x0b20

	)

95 
	#PCI_CLASS_PROCESSOR_MIPS
 0x0b30

	)

96 
	#PCI_CLASS_PROCESSOR_CO
 0x0b40

	)

98 
	#PCI_BASE_CLASS_SERIAL
 0x0c

	)

99 
	#PCI_CLASS_SERIAL_FIREWIRE
 0x0c00

	)

100 
	#PCI_CLASS_SERIAL_FIREWIRE_OHCI
 0x0c0010

	)

101 
	#PCI_CLASS_SERIAL_ACCESS
 0x0c01

	)

102 
	#PCI_CLASS_SERIAL_SSA
 0x0c02

	)

103 
	#PCI_CLASS_SERIAL_USB
 0x0c03

	)

104 
	#PCI_CLASS_SERIAL_USB_UHCI
 0x0c0300

	)

105 
	#PCI_CLASS_SERIAL_USB_OHCI
 0x0c0310

	)

106 
	#PCI_CLASS_SERIAL_USB_EHCI
 0x0c0320

	)

107 
	#PCI_CLASS_SERIAL_USB_XHCI
 0x0c0330

	)

108 
	#PCI_CLASS_SERIAL_FIBER
 0x0c04

	)

109 
	#PCI_CLASS_SERIAL_SMBUS
 0x0c05

	)

111 
	#PCI_BASE_CLASS_WIRELESS
 0x0d

	)

112 
	#PCI_CLASS_WIRELESS_RF_CONTROLLER
 0x0d10

	)

113 
	#PCI_CLASS_WIRELESS_WHCI
 0x0d1010

	)

115 
	#PCI_BASE_CLASS_INTELLIGENT
 0x0e

	)

116 
	#PCI_CLASS_INTELLIGENT_I2O
 0x0e00

	)

118 
	#PCI_BASE_CLASS_SATELLITE
 0x0f

	)

119 
	#PCI_CLASS_SATELLITE_TV
 0x0f00

	)

120 
	#PCI_CLASS_SATELLITE_AUDIO
 0x0f01

	)

121 
	#PCI_CLASS_SATELLITE_VOICE
 0x0f03

	)

122 
	#PCI_CLASS_SATELLITE_DATA
 0x0f04

	)

124 
	#PCI_BASE_CLASS_CRYPT
 0x10

	)

125 
	#PCI_CLASS_CRYPT_NETWORK
 0x1000

	)

126 
	#PCI_CLASS_CRYPT_ENTERTAINMENT
 0x1001

	)

127 
	#PCI_CLASS_CRYPT_OTHER
 0x1080

	)

129 
	#PCI_BASE_CLASS_SIGNAL_PROCESSING
 0x11

	)

130 
	#PCI_CLASS_SP_DPIO
 0x1100

	)

131 
	#PCI_CLASS_SP_OTHER
 0x1180

	)

133 
	#PCI_CLASS_OTHERS
 0xff

	)

137 
	#PCI_VENDOR_ID_TTTECH
 0x0357

	)

138 
	#PCI_DEVICE_ID_TTTECH_MC322
 0x000a

	)

140 
	#PCI_VENDOR_ID_DYNALINK
 0x0675

	)

141 
	#PCI_DEVICE_ID_DYNALINK_IS64PH
 0x1702

	)

143 
	#PCI_VENDOR_ID_BERKOM
 0x0871

	)

144 
	#PCI_DEVICE_ID_BERKOM_A1T
 0xfÁ1

	)

145 
	#PCI_DEVICE_ID_BERKOM_T_CONCEPT
 0xfÁ2

	)

146 
	#PCI_DEVICE_ID_BERKOM_A4T
 0xfÁ4

	)

147 
	#PCI_DEVICE_ID_BERKOM_SCITEL_QUADRO
 0xfÁ8

	)

149 
	#PCI_VENDOR_ID_COMPAQ
 0x0e11

	)

150 
	#PCI_DEVICE_ID_COMPAQ_TOKENRING
 0x0508

	)

151 
	#PCI_DEVICE_ID_COMPAQ_TACHYON
 0xa0fc

	)

152 
	#PCI_DEVICE_ID_COMPAQ_SMART2P
 0x´10

	)

153 
	#PCI_DEVICE_ID_COMPAQ_NETEL100
 0x´32

	)

154 
	#PCI_DEVICE_ID_COMPAQ_NETEL10
 0x´34

	)

155 
	#PCI_DEVICE_ID_COMPAQ_TRIFLEX_IDE
 0x´33

	)

156 
	#PCI_DEVICE_ID_COMPAQ_NETFLEX3I
 0x´35

	)

157 
	#PCI_DEVICE_ID_COMPAQ_NETEL100D
 0x´40

	)

158 
	#PCI_DEVICE_ID_COMPAQ_NETEL100PI
 0x´43

	)

159 
	#PCI_DEVICE_ID_COMPAQ_NETEL100I
 0xb011

	)

160 
	#PCI_DEVICE_ID_COMPAQ_CISS
 0xb060

	)

161 
	#PCI_DEVICE_ID_COMPAQ_CISSB
 0xb178

	)

162 
	#PCI_DEVICE_ID_COMPAQ_CISSC
 0x46

	)

163 
	#PCI_DEVICE_ID_COMPAQ_THUNDER
 0xf130

	)

164 
	#PCI_DEVICE_ID_COMPAQ_NETFLEX3B
 0xf150

	)

166 
	#PCI_VENDOR_ID_NCR
 0x1000

	)

167 
	#PCI_VENDOR_ID_LSI_LOGIC
 0x1000

	)

168 
	#PCI_DEVICE_ID_NCR_53C810
 0x0001

	)

169 
	#PCI_DEVICE_ID_NCR_53C820
 0x0002

	)

170 
	#PCI_DEVICE_ID_NCR_53C825
 0x0003

	)

171 
	#PCI_DEVICE_ID_NCR_53C815
 0x0004

	)

172 
	#PCI_DEVICE_ID_LSI_53C810AP
 0x0005

	)

173 
	#PCI_DEVICE_ID_NCR_53C860
 0x0006

	)

174 
	#PCI_DEVICE_ID_LSI_53C1510
 0x000a

	)

175 
	#PCI_DEVICE_ID_NCR_53C896
 0x000b

	)

176 
	#PCI_DEVICE_ID_NCR_53C895
 0x000c

	)

177 
	#PCI_DEVICE_ID_NCR_53C885
 0x000d

	)

178 
	#PCI_DEVICE_ID_NCR_53C875
 0x000f

	)

179 
	#PCI_DEVICE_ID_NCR_53C1510
 0x0010

	)

180 
	#PCI_DEVICE_ID_LSI_53C895A
 0x0012

	)

181 
	#PCI_DEVICE_ID_LSI_53C875A
 0x0013

	)

182 
	#PCI_DEVICE_ID_LSI_53C1010_33
 0x0020

	)

183 
	#PCI_DEVICE_ID_LSI_53C1010_66
 0x0021

	)

184 
	#PCI_DEVICE_ID_LSI_53C1030
 0x0030

	)

185 
	#PCI_DEVICE_ID_LSI_1030_53C1035
 0x0032

	)

186 
	#PCI_DEVICE_ID_LSI_53C1035
 0x0040

	)

187 
	#PCI_DEVICE_ID_NCR_53C875J
 0x008f

	)

188 
	#PCI_DEVICE_ID_LSI_FC909
 0x0621

	)

189 
	#PCI_DEVICE_ID_LSI_FC929
 0x0622

	)

190 
	#PCI_DEVICE_ID_LSI_FC929_LAN
 0x0623

	)

191 
	#PCI_DEVICE_ID_LSI_FC919
 0x0624

	)

192 
	#PCI_DEVICE_ID_LSI_FC919_LAN
 0x0625

	)

193 
	#PCI_DEVICE_ID_LSI_FC929X
 0x0626

	)

194 
	#PCI_DEVICE_ID_LSI_FC939X
 0x0642

	)

195 
	#PCI_DEVICE_ID_LSI_FC949X
 0x0640

	)

196 
	#PCI_DEVICE_ID_LSI_FC949ES
 0x0646

	)

197 
	#PCI_DEVICE_ID_LSI_FC919X
 0x0628

	)

198 
	#PCI_DEVICE_ID_NCR_YELLOWFIN
 0x0701

	)

199 
	#PCI_DEVICE_ID_LSI_61C102
 0x0901

	)

200 
	#PCI_DEVICE_ID_LSI_63C815
 0x1000

	)

201 
	#PCI_DEVICE_ID_LSI_SAS1064
 0x0050

	)

202 
	#PCI_DEVICE_ID_LSI_SAS1064R
 0x0411

	)

203 
	#PCI_DEVICE_ID_LSI_VERDE_ZCR
 0x0413

	)

204 
	#PCI_DEVICE_ID_LSI_SAS1066
 0x005E

	)

205 
	#PCI_DEVICE_ID_LSI_SAS1068
 0x0054

	)

206 
	#PCI_DEVICE_ID_LSI_SAS1064A
 0x005C

	)

207 
	#PCI_DEVICE_ID_LSI_SAS1064E
 0x0056

	)

208 
	#PCI_DEVICE_ID_LSI_SAS1066E
 0x005A

	)

209 
	#PCI_DEVICE_ID_LSI_SAS1068E
 0x0058

	)

210 
	#PCI_DEVICE_ID_LSI_SAS1078
 0x0060

	)

211 
	#PCI_DEVICE_ID_LSI_SAS1078DE
 0x007C

	)

212 
	#PCI_DEVICE_ID_LSI_SAS2108E
 0x0078

	)

213 
	#PCI_DEVICE_ID_LSI_SAS2108
 0x0079

	)

214 
	#PCI_DEVICE_ID_LSI_SAS2208
 0x005B

	)

215 
	#PCI_DEVICE_ID_LSI_SAS3108
 0x005D

	)

216 
	#PCI_DEVICE_ID_LSI_SAS2004
 0x0071

	)

217 
	#PCI_DEVICE_ID_LSI_SAS2008
 0x0073

	)

219 
	#PCI_VENDOR_ID_ATI
 0x1002

	)

221 
	#PCI_DEVICE_ID_ATI_68800
 0x4158

	)

222 
	#PCI_DEVICE_ID_ATI_215CT222
 0x4354

	)

223 
	#PCI_DEVICE_ID_ATI_210888CX
 0x4358

	)

224 
	#PCI_DEVICE_ID_ATI_215ET222
 0x4554

	)

226 
	#PCI_DEVICE_ID_ATI_215GB
 0x4742

	)

227 
	#PCI_DEVICE_ID_ATI_215GD
 0x4744

	)

228 
	#PCI_DEVICE_ID_ATI_215GI
 0x4749

	)

229 
	#PCI_DEVICE_ID_ATI_215GP
 0x4750

	)

230 
	#PCI_DEVICE_ID_ATI_215GQ
 0x4751

	)

231 
	#PCI_DEVICE_ID_ATI_215XL
 0x4752

	)

232 
	#PCI_DEVICE_ID_ATI_215GT
 0x4754

	)

233 
	#PCI_DEVICE_ID_ATI_215GTB
 0x4755

	)

234 
	#PCI_DEVICE_ID_ATI_215_IV
 0x4756

	)

235 
	#PCI_DEVICE_ID_ATI_215_IW
 0x4757

	)

236 
	#PCI_DEVICE_ID_ATI_215_IZ
 0x475A

	)

237 
	#PCI_DEVICE_ID_ATI_210888GX
 0x4758

	)

238 
	#PCI_DEVICE_ID_ATI_215_LB
 0x4c42

	)

239 
	#PCI_DEVICE_ID_ATI_215_LD
 0x4c44

	)

240 
	#PCI_DEVICE_ID_ATI_215_LG
 0x4c47

	)

241 
	#PCI_DEVICE_ID_ATI_215_LI
 0x4c49

	)

242 
	#PCI_DEVICE_ID_ATI_215_LM
 0x4c4D

	)

243 
	#PCI_DEVICE_ID_ATI_215_LN
 0x4c4E

	)

244 
	#PCI_DEVICE_ID_ATI_215_LR
 0x4c52

	)

245 
	#PCI_DEVICE_ID_ATI_215_LS
 0x4c53

	)

246 
	#PCI_DEVICE_ID_ATI_264_LT
 0x4c54

	)

248 
	#PCI_DEVICE_ID_ATI_264VT
 0x5654

	)

249 
	#PCI_DEVICE_ID_ATI_264VU
 0x5655

	)

250 
	#PCI_DEVICE_ID_ATI_264VV
 0x5656

	)

252 
	#PCI_DEVICE_ID_ATI_RAGE128_RE
 0x5245

	)

253 
	#PCI_DEVICE_ID_ATI_RAGE128_RF
 0x5246

	)

254 
	#PCI_DEVICE_ID_ATI_RAGE128_RG
 0x5247

	)

256 
	#PCI_DEVICE_ID_ATI_RAGE128_RK
 0x524b

	)

257 
	#PCI_DEVICE_ID_ATI_RAGE128_RL
 0x524c

	)

258 
	#PCI_DEVICE_ID_ATI_RAGE128_SE
 0x5345

	)

259 
	#PCI_DEVICE_ID_ATI_RAGE128_SF
 0x5346

	)

260 
	#PCI_DEVICE_ID_ATI_RAGE128_SG
 0x5347

	)

261 
	#PCI_DEVICE_ID_ATI_RAGE128_SH
 0x5348

	)

262 
	#PCI_DEVICE_ID_ATI_RAGE128_SK
 0x534b

	)

263 
	#PCI_DEVICE_ID_ATI_RAGE128_SL
 0x534c

	)

264 
	#PCI_DEVICE_ID_ATI_RAGE128_SM
 0x534d

	)

265 
	#PCI_DEVICE_ID_ATI_RAGE128_SN
 0x534e

	)

267 
	#PCI_DEVICE_ID_ATI_RAGE128_TF
 0x5446

	)

268 
	#PCI_DEVICE_ID_ATI_RAGE128_TL
 0x544c

	)

269 
	#PCI_DEVICE_ID_ATI_RAGE128_TR
 0x5452

	)

270 
	#PCI_DEVICE_ID_ATI_RAGE128_TS
 0x5453

	)

271 
	#PCI_DEVICE_ID_ATI_RAGE128_TT
 0x5454

	)

272 
	#PCI_DEVICE_ID_ATI_RAGE128_TU
 0x5455

	)

274 
	#PCI_DEVICE_ID_ATI_RAGE128_LE
 0x4c45

	)

275 
	#PCI_DEVICE_ID_ATI_RAGE128_LF
 0x4c46

	)

277 
	#PCI_DEVICE_ID_ATI_RAGE128_MF
 0x4d46

	)

278 
	#PCI_DEVICE_ID_ATI_RAGE128_ML
 0x4d4c

	)

280 
	#PCI_DEVICE_ID_ATI_RAGE128_PA
 0x5041

	)

281 
	#PCI_DEVICE_ID_ATI_RAGE128_PB
 0x5042

	)

282 
	#PCI_DEVICE_ID_ATI_RAGE128_PC
 0x5043

	)

283 
	#PCI_DEVICE_ID_ATI_RAGE128_PD
 0x5044

	)

284 
	#PCI_DEVICE_ID_ATI_RAGE128_PE
 0x5045

	)

285 
	#PCI_DEVICE_ID_ATI_RAGE128_PF
 0x5046

	)

287 
	#PCI_DEVICE_ID_ATI_RAGE128_PG
 0x5047

	)

288 
	#PCI_DEVICE_ID_ATI_RAGE128_PH
 0x5048

	)

289 
	#PCI_DEVICE_ID_ATI_RAGE128_PI
 0x5049

	)

290 
	#PCI_DEVICE_ID_ATI_RAGE128_PJ
 0x504A

	)

291 
	#PCI_DEVICE_ID_ATI_RAGE128_PK
 0x504B

	)

292 
	#PCI_DEVICE_ID_ATI_RAGE128_PL
 0x504C

	)

293 
	#PCI_DEVICE_ID_ATI_RAGE128_PM
 0x504D

	)

294 
	#PCI_DEVICE_ID_ATI_RAGE128_PN
 0x504E

	)

295 
	#PCI_DEVICE_ID_ATI_RAGE128_PO
 0x504F

	)

296 
	#PCI_DEVICE_ID_ATI_RAGE128_PP
 0x5050

	)

297 
	#PCI_DEVICE_ID_ATI_RAGE128_PQ
 0x5051

	)

298 
	#PCI_DEVICE_ID_ATI_RAGE128_PR
 0x5052

	)

299 
	#PCI_DEVICE_ID_ATI_RAGE128_PS
 0x5053

	)

300 
	#PCI_DEVICE_ID_ATI_RAGE128_PT
 0x5054

	)

301 
	#PCI_DEVICE_ID_ATI_RAGE128_PU
 0x5055

	)

302 
	#PCI_DEVICE_ID_ATI_RAGE128_PV
 0x5056

	)

303 
	#PCI_DEVICE_ID_ATI_RAGE128_PW
 0x5057

	)

304 
	#PCI_DEVICE_ID_ATI_RAGE128_PX
 0x5058

	)

307 
	#PCI_DEVICE_ID_ATI_RADEON_QD
 0x5144

	)

308 
	#PCI_DEVICE_ID_ATI_RADEON_QE
 0x5145

	)

309 
	#PCI_DEVICE_ID_ATI_RADEON_QF
 0x5146

	)

310 
	#PCI_DEVICE_ID_ATI_RADEON_QG
 0x5147

	)

312 
	#PCI_DEVICE_ID_ATI_RADEON_QY
 0x5159

	)

313 
	#PCI_DEVICE_ID_ATI_RADEON_QZ
 0x515a

	)

315 
	#PCI_DEVICE_ID_ATI_RADEON_QL
 0x514c

	)

316 
	#PCI_DEVICE_ID_ATI_RADEON_QN
 0x514e

	)

317 
	#PCI_DEVICE_ID_ATI_RADEON_QO
 0x514f

	)

318 
	#PCI_DEVICE_ID_ATI_RADEON_Ql
 0x516c

	)

319 
	#PCI_DEVICE_ID_ATI_RADEON_BB
 0x4242

	)

321 
	#PCI_DEVICE_ID_ATI_RADEON_QM
 0x514d

	)

323 
	#PCI_DEVICE_ID_ATI_RADEON_QW
 0x5157

	)

324 
	#PCI_DEVICE_ID_ATI_RADEON_QX
 0x5158

	)

327 
	#PCI_DEVICE_ID_ATI_RADEON_Id
 0x4964

	)

328 
	#PCI_DEVICE_ID_ATI_RADEON_Ie
 0x4965

	)

329 
	#PCI_DEVICE_ID_ATI_RADEON_If
 0x4966

	)

330 
	#PCI_DEVICE_ID_ATI_RADEON_Ig
 0x4967

	)

332 
	#PCI_DEVICE_ID_ATI_RADEON_Ya
 0x5961

	)

333 
	#PCI_DEVICE_ID_ATI_RADEON_Yd
 0x5964

	)

336 
	#PCI_DEVICE_ID_ATI_RADEON_ND
 0x4e44

	)

337 
	#PCI_DEVICE_ID_ATI_RADEON_NE
 0x4e45

	)

338 
	#PCI_DEVICE_ID_ATI_RADEON_NF
 0x4e46

	)

339 
	#PCI_DEVICE_ID_ATI_RADEON_NG
 0x4e47

	)

343 
	#PCI_DEVICE_ID_ATI_RADEON_LY
 0x4c59

	)

344 
	#PCI_DEVICE_ID_ATI_RADEON_LZ
 0x4c5a

	)

346 
	#PCI_DEVICE_ID_ATI_RADEON_LW
 0x4c57

	)

347 
	#PCI_DEVICE_ID_ATI_RADEON_LX
 0x4c58

	)

349 
	#PCI_DEVICE_ID_ATI_RADEON_Ld
 0x4c64

	)

350 
	#PCI_DEVICE_ID_ATI_RADEON_Le
 0x4c65

	)

351 
	#PCI_DEVICE_ID_ATI_RADEON_Lf
 0x4c66

	)

352 
	#PCI_DEVICE_ID_ATI_RADEON_Lg
 0x4c67

	)

355 
	#PCI_DEVICE_ID_ATI_RS100
 0xˇb0

	)

356 
	#PCI_DEVICE_ID_ATI_RS200
 0xˇb2

	)

357 
	#PCI_DEVICE_ID_ATI_RS200_B
 0xcbb2

	)

358 
	#PCI_DEVICE_ID_ATI_RS250
 0xˇb3

	)

359 
	#PCI_DEVICE_ID_ATI_RS300_100
 0x5830

	)

360 
	#PCI_DEVICE_ID_ATI_RS300_133
 0x5831

	)

361 
	#PCI_DEVICE_ID_ATI_RS300_166
 0x5832

	)

362 
	#PCI_DEVICE_ID_ATI_RS300_200
 0x5833

	)

363 
	#PCI_DEVICE_ID_ATI_RS350_100
 0x7830

	)

364 
	#PCI_DEVICE_ID_ATI_RS350_133
 0x7831

	)

365 
	#PCI_DEVICE_ID_ATI_RS350_166
 0x7832

	)

366 
	#PCI_DEVICE_ID_ATI_RS350_200
 0x7833

	)

367 
	#PCI_DEVICE_ID_ATI_RS400_100
 0x5a30

	)

368 
	#PCI_DEVICE_ID_ATI_RS400_133
 0x5a31

	)

369 
	#PCI_DEVICE_ID_ATI_RS400_166
 0x5a32

	)

370 
	#PCI_DEVICE_ID_ATI_RS400_200
 0x5a33

	)

371 
	#PCI_DEVICE_ID_ATI_RS480
 0x5950

	)

373 
	#PCI_DEVICE_ID_ATI_IXP200_IDE
 0x4349

	)

374 
	#PCI_DEVICE_ID_ATI_IXP200_SMBUS
 0x4353

	)

375 
	#PCI_DEVICE_ID_ATI_IXP300_SMBUS
 0x4363

	)

376 
	#PCI_DEVICE_ID_ATI_IXP300_IDE
 0x4369

	)

377 
	#PCI_DEVICE_ID_ATI_IXP300_SATA
 0x436e

	)

378 
	#PCI_DEVICE_ID_ATI_IXP400_SMBUS
 0x4372

	)

379 
	#PCI_DEVICE_ID_ATI_IXP400_IDE
 0x4376

	)

380 
	#PCI_DEVICE_ID_ATI_IXP400_SATA
 0x4379

	)

381 
	#PCI_DEVICE_ID_ATI_IXP400_SATA2
 0x437a

	)

382 
	#PCI_DEVICE_ID_ATI_IXP600_SATA
 0x4380

	)

383 
	#PCI_DEVICE_ID_ATI_SBX00_SMBUS
 0x4385

	)

384 
	#PCI_DEVICE_ID_ATI_IXP600_IDE
 0x438c

	)

385 
	#PCI_DEVICE_ID_ATI_IXP700_SATA
 0x4390

	)

386 
	#PCI_DEVICE_ID_ATI_IXP700_IDE
 0x439c

	)

387 
	#PCI_DEVICE_ID_ATI_SB900_SM
 0x780B

	)

389 
	#PCI_VENDOR_ID_VLSI
 0x1004

	)

390 
	#PCI_DEVICE_ID_VLSI_82C592
 0x0005

	)

391 
	#PCI_DEVICE_ID_VLSI_82C593
 0x0006

	)

392 
	#PCI_DEVICE_ID_VLSI_82C594
 0x0007

	)

393 
	#PCI_DEVICE_ID_VLSI_82C597
 0x0009

	)

394 
	#PCI_DEVICE_ID_VLSI_82C541
 0x000c

	)

395 
	#PCI_DEVICE_ID_VLSI_82C543
 0x000d

	)

396 
	#PCI_DEVICE_ID_VLSI_82C532
 0x0101

	)

397 
	#PCI_DEVICE_ID_VLSI_82C534
 0x0102

	)

398 
	#PCI_DEVICE_ID_VLSI_82C535
 0x0104

	)

399 
	#PCI_DEVICE_ID_VLSI_82C147
 0x0105

	)

400 
	#PCI_DEVICE_ID_VLSI_VAS96011
 0x0702

	)

402 
	#PCI_VENDOR_ID_ADL
 0x1005

	)

403 
	#PCI_DEVICE_ID_ADL_2301
 0x2301

	)

405 
	#PCI_VENDOR_ID_NS
 0x100b

	)

406 
	#PCI_DEVICE_ID_NS_87415
 0x0002

	)

407 
	#PCI_DEVICE_ID_NS_87560_LIO
 0x000e

	)

408 
	#PCI_DEVICE_ID_NS_87560_USB
 0x0012

	)

409 
	#PCI_DEVICE_ID_NS_83815
 0x0020

	)

410 
	#PCI_DEVICE_ID_NS_83820
 0x0022

	)

411 
	#PCI_DEVICE_ID_NS_CS5535_ISA
 0x002b

	)

412 
	#PCI_DEVICE_ID_NS_CS5535_IDE
 0x002d

	)

413 
	#PCI_DEVICE_ID_NS_CS5535_AUDIO
 0x002e

	)

414 
	#PCI_DEVICE_ID_NS_CS5535_USB
 0x002f

	)

415 
	#PCI_DEVICE_ID_NS_GX_VIDEO
 0x0030

	)

416 
	#PCI_DEVICE_ID_NS_SATURN
 0x0035

	)

417 
	#PCI_DEVICE_ID_NS_SCx200_BRIDGE
 0x0500

	)

418 
	#PCI_DEVICE_ID_NS_SCx200_SMI
 0x0501

	)

419 
	#PCI_DEVICE_ID_NS_SCx200_IDE
 0x0502

	)

420 
	#PCI_DEVICE_ID_NS_SCx200_AUDIO
 0x0503

	)

421 
	#PCI_DEVICE_ID_NS_SCx200_VIDEO
 0x0504

	)

422 
	#PCI_DEVICE_ID_NS_SCx200_XBUS
 0x0505

	)

423 
	#PCI_DEVICE_ID_NS_SC1100_BRIDGE
 0x0510

	)

424 
	#PCI_DEVICE_ID_NS_SC1100_SMI
 0x0511

	)

425 
	#PCI_DEVICE_ID_NS_SC1100_XBUS
 0x0515

	)

426 
	#PCI_DEVICE_ID_NS_87410
 0xd001

	)

428 
	#PCI_DEVICE_ID_NS_GX_HOST_BRIDGE
 0x0028

	)

430 
	#PCI_VENDOR_ID_TSENG
 0x100c

	)

431 
	#PCI_DEVICE_ID_TSENG_W32P_2
 0x3202

	)

432 
	#PCI_DEVICE_ID_TSENG_W32P_b
 0x3205

	)

433 
	#PCI_DEVICE_ID_TSENG_W32P_c
 0x3206

	)

434 
	#PCI_DEVICE_ID_TSENG_W32P_d
 0x3207

	)

435 
	#PCI_DEVICE_ID_TSENG_ET6000
 0x3208

	)

437 
	#PCI_VENDOR_ID_WEITEK
 0x100e

	)

438 
	#PCI_DEVICE_ID_WEITEK_P9000
 0x9001

	)

439 
	#PCI_DEVICE_ID_WEITEK_P9100
 0x9100

	)

441 
	#PCI_VENDOR_ID_DEC
 0x1011

	)

442 
	#PCI_DEVICE_ID_DEC_BRD
 0x0001

	)

443 
	#PCI_DEVICE_ID_DEC_TULIP
 0x0002

	)

444 
	#PCI_DEVICE_ID_DEC_TGA
 0x0004

	)

445 
	#PCI_DEVICE_ID_DEC_TULIP_FAST
 0x0009

	)

446 
	#PCI_DEVICE_ID_DEC_TGA2
 0x000D

	)

447 
	#PCI_DEVICE_ID_DEC_FDDI
 0x000F

	)

448 
	#PCI_DEVICE_ID_DEC_TULIP_PLUS
 0x0014

	)

449 
	#PCI_DEVICE_ID_DEC_21142
 0x0019

	)

450 
	#PCI_DEVICE_ID_DEC_21052
 0x0021

	)

451 
	#PCI_DEVICE_ID_DEC_21150
 0x0022

	)

452 
	#PCI_DEVICE_ID_DEC_21152
 0x0024

	)

453 
	#PCI_DEVICE_ID_DEC_21153
 0x0025

	)

454 
	#PCI_DEVICE_ID_DEC_21154
 0x0026

	)

455 
	#PCI_DEVICE_ID_DEC_21285
 0x1065

	)

456 
	#PCI_DEVICE_ID_COMPAQ_42XX
 0x0046

	)

458 
	#PCI_VENDOR_ID_CIRRUS
 0x1013

	)

459 
	#PCI_DEVICE_ID_CIRRUS_7548
 0x0038

	)

460 
	#PCI_DEVICE_ID_CIRRUS_5430
 0x00a0

	)

461 
	#PCI_DEVICE_ID_CIRRUS_5434_4
 0x00a4

	)

462 
	#PCI_DEVICE_ID_CIRRUS_5434_8
 0x00a8

	)

463 
	#PCI_DEVICE_ID_CIRRUS_5436
 0x00ac

	)

464 
	#PCI_DEVICE_ID_CIRRUS_5446
 0x00b8

	)

465 
	#PCI_DEVICE_ID_CIRRUS_5480
 0x00bc

	)

466 
	#PCI_DEVICE_ID_CIRRUS_5462
 0x00d0

	)

467 
	#PCI_DEVICE_ID_CIRRUS_5464
 0x00d4

	)

468 
	#PCI_DEVICE_ID_CIRRUS_5465
 0x00d6

	)

469 
	#PCI_DEVICE_ID_CIRRUS_6729
 0x1100

	)

470 
	#PCI_DEVICE_ID_CIRRUS_6832
 0x1110

	)

471 
	#PCI_DEVICE_ID_CIRRUS_7543
 0x1202

	)

472 
	#PCI_DEVICE_ID_CIRRUS_4610
 0x6001

	)

473 
	#PCI_DEVICE_ID_CIRRUS_4612
 0x6003

	)

474 
	#PCI_DEVICE_ID_CIRRUS_4615
 0x6004

	)

476 
	#PCI_VENDOR_ID_IBM
 0x1014

	)

477 
	#PCI_DEVICE_ID_IBM_TR
 0x0018

	)

478 
	#PCI_DEVICE_ID_IBM_TR_WAKE
 0x003e

	)

479 
	#PCI_DEVICE_ID_IBM_CPC710_PCI64
 0x00fc

	)

480 
	#PCI_DEVICE_ID_IBM_SNIPE
 0x0180

	)

481 
	#PCI_DEVICE_ID_IBM_CITRINE
 0x028C

	)

482 
	#PCI_DEVICE_ID_IBM_GEMSTONE
 0xB166

	)

483 
	#PCI_DEVICE_ID_IBM_OBSIDIAN
 0x02BD

	)

484 
	#PCI_DEVICE_ID_IBM_ICOM_DEV_ID_1
 0x0031

	)

485 
	#PCI_DEVICE_ID_IBM_ICOM_DEV_ID_2
 0x0219

	)

486 
	#PCI_DEVICE_ID_IBM_ICOM_V2_TWO_PORTS_RVX
 0x021A

	)

487 
	#PCI_DEVICE_ID_IBM_ICOM_V2_ONE_PORT_RVX_ONE_PORT_MDM
 0x0251

	)

488 
	#PCI_DEVICE_ID_IBM_ICOM_V2_ONE_PORT_RVX_ONE_PORT_MDM_PCIE
 0x0361

	)

489 
	#PCI_DEVICE_ID_IBM_ICOM_FOUR_PORT_MODEL
 0x252

	)

491 
	#PCI_VENDOR_ID_UNISYS
 0x1018

	)

492 
	#PCI_DEVICE_ID_UNISYS_DMA_DIRECTOR
 0x001C

	)

494 
	#PCI_VENDOR_ID_COMPEX2
 0x101®

	)

495 
	#PCI_DEVICE_ID_COMPEX2_100VG
 0x0005

	)

497 
	#PCI_VENDOR_ID_WD
 0x101c

	)

498 
	#PCI_DEVICE_ID_WD_90C
 0xc24a

	)

500 
	#PCI_VENDOR_ID_AMI
 0x101e

	)

501 
	#PCI_DEVICE_ID_AMI_MEGARAID3
 0x1960

	)

502 
	#PCI_DEVICE_ID_AMI_MEGARAID
 0x9010

	)

503 
	#PCI_DEVICE_ID_AMI_MEGARAID2
 0x9060

	)

505 
	#PCI_VENDOR_ID_AMD
 0x1022

	)

506 
	#PCI_DEVICE_ID_AMD_K8_NB
 0x1100

	)

507 
	#PCI_DEVICE_ID_AMD_K8_NB_ADDRMAP
 0x1101

	)

508 
	#PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
 0x1102

	)

509 
	#PCI_DEVICE_ID_AMD_K8_NB_MISC
 0x1103

	)

510 
	#PCI_DEVICE_ID_AMD_10H_NB_HT
 0x1200

	)

511 
	#PCI_DEVICE_ID_AMD_10H_NB_MAP
 0x1201

	)

512 
	#PCI_DEVICE_ID_AMD_10H_NB_DRAM
 0x1202

	)

513 
	#PCI_DEVICE_ID_AMD_10H_NB_MISC
 0x1203

	)

514 
	#PCI_DEVICE_ID_AMD_10H_NB_LINK
 0x1204

	)

515 
	#PCI_DEVICE_ID_AMD_11H_NB_HT
 0x1300

	)

516 
	#PCI_DEVICE_ID_AMD_11H_NB_MAP
 0x1301

	)

517 
	#PCI_DEVICE_ID_AMD_11H_NB_DRAM
 0x1302

	)

518 
	#PCI_DEVICE_ID_AMD_11H_NB_MISC
 0x1303

	)

519 
	#PCI_DEVICE_ID_AMD_11H_NB_LINK
 0x1304

	)

520 
	#PCI_DEVICE_ID_AMD_LANCE
 0x2000

	)

521 
	#PCI_DEVICE_ID_AMD_LANCE_HOME
 0x2001

	)

522 
	#PCI_DEVICE_ID_AMD_SCSI
 0x2020

	)

523 
	#PCI_DEVICE_ID_AMD_SERENADE
 0x36c0

	)

524 
	#PCI_DEVICE_ID_AMD_FE_GATE_7006
 0x7006

	)

525 
	#PCI_DEVICE_ID_AMD_FE_GATE_7007
 0x7007

	)

526 
	#PCI_DEVICE_ID_AMD_FE_GATE_700C
 0x700C

	)

527 
	#PCI_DEVICE_ID_AMD_FE_GATE_700E
 0x700E

	)

528 
	#PCI_DEVICE_ID_AMD_COBRA_7401
 0x7401

	)

529 
	#PCI_DEVICE_ID_AMD_VIPER_7409
 0x7409

	)

530 
	#PCI_DEVICE_ID_AMD_VIPER_740B
 0x740B

	)

531 
	#PCI_DEVICE_ID_AMD_VIPER_7410
 0x7410

	)

532 
	#PCI_DEVICE_ID_AMD_VIPER_7411
 0x7411

	)

533 
	#PCI_DEVICE_ID_AMD_VIPER_7413
 0x7413

	)

534 
	#PCI_DEVICE_ID_AMD_VIPER_7440
 0x7440

	)

535 
	#PCI_DEVICE_ID_AMD_OPUS_7441
 0x7441

	)

536 
	#PCI_DEVICE_ID_AMD_OPUS_7443
 0x7443

	)

537 
	#PCI_DEVICE_ID_AMD_VIPER_7443
 0x7443

	)

538 
	#PCI_DEVICE_ID_AMD_OPUS_7445
 0x7445

	)

539 
	#PCI_DEVICE_ID_AMD_8111_LPC
 0x7468

	)

540 
	#PCI_DEVICE_ID_AMD_8111_IDE
 0x7469

	)

541 
	#PCI_DEVICE_ID_AMD_8111_SMBUS2
 0x746a

	)

542 
	#PCI_DEVICE_ID_AMD_8111_SMBUS
 0x746b

	)

543 
	#PCI_DEVICE_ID_AMD_8111_AUDIO
 0x746d

	)

544 
	#PCI_DEVICE_ID_AMD_8151_0
 0x7454

	)

545 
	#PCI_DEVICE_ID_AMD_8131_BRIDGE
 0x7450

	)

546 
	#PCI_DEVICE_ID_AMD_8131_APIC
 0x7451

	)

547 
	#PCI_DEVICE_ID_AMD_8132_BRIDGE
 0x7458

	)

548 
	#PCI_DEVICE_ID_AMD_CS5536_ISA
 0x2090

	)

549 
	#PCI_DEVICE_ID_AMD_CS5536_FLASH
 0x2091

	)

550 
	#PCI_DEVICE_ID_AMD_CS5536_AUDIO
 0x2093

	)

551 
	#PCI_DEVICE_ID_AMD_CS5536_OHC
 0x2094

	)

552 
	#PCI_DEVICE_ID_AMD_CS5536_EHC
 0x2095

	)

553 
	#PCI_DEVICE_ID_AMD_CS5536_UDC
 0x2096

	)

554 
	#PCI_DEVICE_ID_AMD_CS5536_UOC
 0x2097

	)

555 
	#PCI_DEVICE_ID_AMD_CS5536_IDE
 0x209A

	)

557 
	#PCI_DEVICE_ID_AMD_LX_VIDEO
 0x2081

	)

558 
	#PCI_DEVICE_ID_AMD_LX_AES
 0x2082

	)

560 
	#PCI_VENDOR_ID_TRIDENT
 0x1023

	)

561 
	#PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
 0x2000

	)

562 
	#PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
 0x2001

	)

563 
	#PCI_DEVICE_ID_TRIDENT_9320
 0x9320

	)

564 
	#PCI_DEVICE_ID_TRIDENT_9388
 0x9388

	)

565 
	#PCI_DEVICE_ID_TRIDENT_9397
 0x9397

	)

566 
	#PCI_DEVICE_ID_TRIDENT_939A
 0x939A

	)

567 
	#PCI_DEVICE_ID_TRIDENT_9520
 0x9520

	)

568 
	#PCI_DEVICE_ID_TRIDENT_9525
 0x9525

	)

569 
	#PCI_DEVICE_ID_TRIDENT_9420
 0x9420

	)

570 
	#PCI_DEVICE_ID_TRIDENT_9440
 0x9440

	)

571 
	#PCI_DEVICE_ID_TRIDENT_9660
 0x9660

	)

572 
	#PCI_DEVICE_ID_TRIDENT_9750
 0x9750

	)

573 
	#PCI_DEVICE_ID_TRIDENT_9850
 0x9850

	)

574 
	#PCI_DEVICE_ID_TRIDENT_9880
 0x9880

	)

575 
	#PCI_DEVICE_ID_TRIDENT_8400
 0x8400

	)

576 
	#PCI_DEVICE_ID_TRIDENT_8420
 0x8420

	)

577 
	#PCI_DEVICE_ID_TRIDENT_8500
 0x8500

	)

579 
	#PCI_VENDOR_ID_AI
 0x1025

	)

580 
	#PCI_DEVICE_ID_AI_M1435
 0x1435

	)

582 
	#PCI_VENDOR_ID_DELL
 0x1028

	)

583 
	#PCI_DEVICE_ID_DELL_RACIII
 0x0008

	)

584 
	#PCI_DEVICE_ID_DELL_RAC4
 0x0012

	)

585 
	#PCI_DEVICE_ID_DELL_PERC5
 0x0015

	)

587 
	#PCI_VENDOR_ID_MATROX
 0x102B

	)

588 
	#PCI_DEVICE_ID_MATROX_MGA_2
 0x0518

	)

589 
	#PCI_DEVICE_ID_MATROX_MIL
 0x0519

	)

590 
	#PCI_DEVICE_ID_MATROX_MYS
 0x051A

	)

591 
	#PCI_DEVICE_ID_MATROX_MIL_2
 0x051b

	)

592 
	#PCI_DEVICE_ID_MATROX_MYS_AGP
 0x051e

	)

593 
	#PCI_DEVICE_ID_MATROX_MIL_2_AGP
 0x051f

	)

594 
	#PCI_DEVICE_ID_MATROX_MGA_IMP
 0x0d10

	)

595 
	#PCI_DEVICE_ID_MATROX_G100_MM
 0x1000

	)

596 
	#PCI_DEVICE_ID_MATROX_G100_AGP
 0x1001

	)

597 
	#PCI_DEVICE_ID_MATROX_G200_PCI
 0x0520

	)

598 
	#PCI_DEVICE_ID_MATROX_G200_AGP
 0x0521

	)

599 
	#PCI_DEVICE_ID_MATROX_G400
 0x0525

	)

600 
	#PCI_DEVICE_ID_MATROX_G200EV_PCI
 0x0530

	)

601 
	#PCI_DEVICE_ID_MATROX_G550
 0x2527

	)

602 
	#PCI_DEVICE_ID_MATROX_VIA
 0x4536

	)

604 
	#PCI_VENDOR_ID_CT
 0x102c

	)

605 
	#PCI_DEVICE_ID_CT_69000
 0x00c0

	)

606 
	#PCI_DEVICE_ID_CT_65545
 0x00d8

	)

607 
	#PCI_DEVICE_ID_CT_65548
 0x00dc

	)

608 
	#PCI_DEVICE_ID_CT_65550
 0x00e0

	)

609 
	#PCI_DEVICE_ID_CT_65554
 0x00e4

	)

610 
	#PCI_DEVICE_ID_CT_65555
 0x00e5

	)

612 
	#PCI_VENDOR_ID_MIRO
 0x1031

	)

613 
	#PCI_DEVICE_ID_MIRO_36050
 0x5601

	)

614 
	#PCI_DEVICE_ID_MIRO_DC10PLUS
 0x7e„

	)

615 
	#PCI_DEVICE_ID_MIRO_DC30PLUS
 0xd801

	)

617 
	#PCI_VENDOR_ID_NEC
 0x1033

	)

618 
	#PCI_DEVICE_ID_NEC_CBUS_1
 0x0001

	)

619 
	#PCI_DEVICE_ID_NEC_LOCAL
 0x0002

	)

620 
	#PCI_DEVICE_ID_NEC_ATM
 0x0003

	)

621 
	#PCI_DEVICE_ID_NEC_R4000
 0x0004

	)

622 
	#PCI_DEVICE_ID_NEC_486
 0x0005

	)

623 
	#PCI_DEVICE_ID_NEC_ACCEL_1
 0x0006

	)

624 
	#PCI_DEVICE_ID_NEC_UXBUS
 0x0007

	)

625 
	#PCI_DEVICE_ID_NEC_ACCEL_2
 0x0008

	)

626 
	#PCI_DEVICE_ID_NEC_GRAPH
 0x0009

	)

627 
	#PCI_DEVICE_ID_NEC_VL
 0x0016

	)

628 
	#PCI_DEVICE_ID_NEC_STARALPHA2
 0x002¯

	)

629 
	#PCI_DEVICE_ID_NEC_CBUS_2
 0x002d

	)

630 
	#PCI_DEVICE_ID_NEC_USB
 0x0035

	)

631 
	#PCI_DEVICE_ID_NEC_CBUS_3
 0x003b

	)

632 
	#PCI_DEVICE_ID_NEC_NAPCCARD
 0x003e

	)

633 
	#PCI_DEVICE_ID_NEC_PCX2
 0x0046

	)

634 
	#PCI_DEVICE_ID_NEC_VRC5476
 0x009b

	)

635 
	#PCI_DEVICE_ID_NEC_VRC4173
 0x00a5

	)

636 
	#PCI_DEVICE_ID_NEC_VRC5477_AC97
 0x00a6

	)

637 
	#PCI_DEVICE_ID_NEC_PC9821CS01
 0x800¯

	)

638 
	#PCI_DEVICE_ID_NEC_PC9821NRB06
 0x800d

	)

640 
	#PCI_VENDOR_ID_FD
 0x1036

	)

641 
	#PCI_DEVICE_ID_FD_36C70
 0x0000

	)

643 
	#PCI_VENDOR_ID_SI
 0x1039

	)

644 
	#PCI_DEVICE_ID_SI_5591_AGP
 0x0001

	)

645 
	#PCI_DEVICE_ID_SI_6202
 0x0002

	)

646 
	#PCI_DEVICE_ID_SI_503
 0x0008

	)

647 
	#PCI_DEVICE_ID_SI_ACPI
 0x0009

	)

648 
	#PCI_DEVICE_ID_SI_SMBUS
 0x0016

	)

649 
	#PCI_DEVICE_ID_SI_LPC
 0x0018

	)

650 
	#PCI_DEVICE_ID_SI_5597_VGA
 0x0200

	)

651 
	#PCI_DEVICE_ID_SI_6205
 0x0205

	)

652 
	#PCI_DEVICE_ID_SI_501
 0x0406

	)

653 
	#PCI_DEVICE_ID_SI_496
 0x0496

	)

654 
	#PCI_DEVICE_ID_SI_300
 0x0300

	)

655 
	#PCI_DEVICE_ID_SI_315H
 0x0310

	)

656 
	#PCI_DEVICE_ID_SI_315
 0x0315

	)

657 
	#PCI_DEVICE_ID_SI_315PRO
 0x0325

	)

658 
	#PCI_DEVICE_ID_SI_530
 0x0530

	)

659 
	#PCI_DEVICE_ID_SI_540
 0x0540

	)

660 
	#PCI_DEVICE_ID_SI_550
 0x0550

	)

661 
	#PCI_DEVICE_ID_SI_540_VGA
 0x5300

	)

662 
	#PCI_DEVICE_ID_SI_550_VGA
 0x5315

	)

663 
	#PCI_DEVICE_ID_SI_620
 0x0620

	)

664 
	#PCI_DEVICE_ID_SI_630
 0x0630

	)

665 
	#PCI_DEVICE_ID_SI_633
 0x0633

	)

666 
	#PCI_DEVICE_ID_SI_635
 0x0635

	)

667 
	#PCI_DEVICE_ID_SI_640
 0x0640

	)

668 
	#PCI_DEVICE_ID_SI_645
 0x0645

	)

669 
	#PCI_DEVICE_ID_SI_646
 0x0646

	)

670 
	#PCI_DEVICE_ID_SI_648
 0x0648

	)

671 
	#PCI_DEVICE_ID_SI_650
 0x0650

	)

672 
	#PCI_DEVICE_ID_SI_651
 0x0651

	)

673 
	#PCI_DEVICE_ID_SI_655
 0x0655

	)

674 
	#PCI_DEVICE_ID_SI_661
 0x0661

	)

675 
	#PCI_DEVICE_ID_SI_730
 0x0730

	)

676 
	#PCI_DEVICE_ID_SI_733
 0x0733

	)

677 
	#PCI_DEVICE_ID_SI_630_VGA
 0x6300

	)

678 
	#PCI_DEVICE_ID_SI_735
 0x0735

	)

679 
	#PCI_DEVICE_ID_SI_740
 0x0740

	)

680 
	#PCI_DEVICE_ID_SI_741
 0x0741

	)

681 
	#PCI_DEVICE_ID_SI_745
 0x0745

	)

682 
	#PCI_DEVICE_ID_SI_746
 0x0746

	)

683 
	#PCI_DEVICE_ID_SI_755
 0x0755

	)

684 
	#PCI_DEVICE_ID_SI_760
 0x0760

	)

685 
	#PCI_DEVICE_ID_SI_900
 0x0900

	)

686 
	#PCI_DEVICE_ID_SI_961
 0x0961

	)

687 
	#PCI_DEVICE_ID_SI_962
 0x0962

	)

688 
	#PCI_DEVICE_ID_SI_963
 0x0963

	)

689 
	#PCI_DEVICE_ID_SI_965
 0x0965

	)

690 
	#PCI_DEVICE_ID_SI_966
 0x0966

	)

691 
	#PCI_DEVICE_ID_SI_968
 0x0968

	)

692 
	#PCI_DEVICE_ID_SI_1180
 0x1180

	)

693 
	#PCI_DEVICE_ID_SI_5511
 0x5511

	)

694 
	#PCI_DEVICE_ID_SI_5513
 0x5513

	)

695 
	#PCI_DEVICE_ID_SI_5517
 0x5517

	)

696 
	#PCI_DEVICE_ID_SI_5518
 0x5518

	)

697 
	#PCI_DEVICE_ID_SI_5571
 0x5571

	)

698 
	#PCI_DEVICE_ID_SI_5581
 0x5581

	)

699 
	#PCI_DEVICE_ID_SI_5582
 0x5582

	)

700 
	#PCI_DEVICE_ID_SI_5591
 0x5591

	)

701 
	#PCI_DEVICE_ID_SI_5596
 0x5596

	)

702 
	#PCI_DEVICE_ID_SI_5597
 0x5597

	)

703 
	#PCI_DEVICE_ID_SI_5598
 0x5598

	)

704 
	#PCI_DEVICE_ID_SI_5600
 0x5600

	)

705 
	#PCI_DEVICE_ID_SI_7012
 0x7012

	)

706 
	#PCI_DEVICE_ID_SI_7013
 0x7013

	)

707 
	#PCI_DEVICE_ID_SI_7016
 0x7016

	)

708 
	#PCI_DEVICE_ID_SI_7018
 0x7018

	)

710 
	#PCI_VENDOR_ID_HP
 0x103c

	)

711 
	#PCI_DEVICE_ID_HP_VISUALIZE_EG
 0x1005

	)

712 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX6
 0x1006

	)

713 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX4
 0x1008

	)

714 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX2
 0x100a

	)

715 
	#PCI_DEVICE_ID_HP_TACHYON
 0x1028

	)

716 
	#PCI_DEVICE_ID_HP_TACHLITE
 0x1029

	)

717 
	#PCI_DEVICE_ID_HP_J2585A
 0x1030

	)

718 
	#PCI_DEVICE_ID_HP_J2585B
 0x1031

	)

719 
	#PCI_DEVICE_ID_HP_J2973A
 0x1040

	)

720 
	#PCI_DEVICE_ID_HP_J2970A
 0x1042

	)

721 
	#PCI_DEVICE_ID_HP_DIVA
 0x1048

	)

722 
	#PCI_DEVICE_ID_HP_DIVA_TOSCA1
 0x1049

	)

723 
	#PCI_DEVICE_ID_HP_DIVA_TOSCA2
 0x104A

	)

724 
	#PCI_DEVICE_ID_HP_DIVA_MAESTRO
 0x104B

	)

725 
	#PCI_DEVICE_ID_HP_REO_IOC
 0x10f1

	)

726 
	#PCI_DEVICE_ID_HP_VISUALIZE_FXE
 0x108b

	)

727 
	#PCI_DEVICE_ID_HP_DIVA_HALFDOME
 0x1223

	)

728 
	#PCI_DEVICE_ID_HP_DIVA_KEYSTONE
 0x1226

	)

729 
	#PCI_DEVICE_ID_HP_DIVA_POWERBAR
 0x1227

	)

730 
	#PCI_DEVICE_ID_HP_ZX1_IOC
 0x122a

	)

731 
	#PCI_DEVICE_ID_HP_PCIX_LBA
 0x122e

	)

732 
	#PCI_DEVICE_ID_HP_SX1000_IOC
 0x127c

	)

733 
	#PCI_DEVICE_ID_HP_DIVA_EVEREST
 0x1282

	)

734 
	#PCI_DEVICE_ID_HP_DIVA_AUX
 0x1290

	)

735 
	#PCI_DEVICE_ID_HP_DIVA_RMP3
 0x1301

	)

736 
	#PCI_DEVICE_ID_HP_DIVA_HURRICANE
 0x132a

	)

737 
	#PCI_DEVICE_ID_HP_CISSA
 0x3220

	)

738 
	#PCI_DEVICE_ID_HP_CISSC
 0x3230

	)

739 
	#PCI_DEVICE_ID_HP_CISSD
 0x3238

	)

740 
	#PCI_DEVICE_ID_HP_CISSE
 0x323a

	)

741 
	#PCI_DEVICE_ID_HP_ZX2_IOC
 0x4031

	)

743 
	#PCI_VENDOR_ID_PCTECH
 0x1042

	)

744 
	#PCI_DEVICE_ID_PCTECH_RZ1000
 0x1000

	)

745 
	#PCI_DEVICE_ID_PCTECH_RZ1001
 0x1001

	)

746 
	#PCI_DEVICE_ID_PCTECH_SAMURAI_IDE
 0x3020

	)

748 
	#PCI_VENDOR_ID_ASUSTEK
 0x1043

	)

749 
	#PCI_DEVICE_ID_ASUSTEK_0675
 0x0675

	)

751 
	#PCI_VENDOR_ID_DPT
 0x1044

	)

752 
	#PCI_DEVICE_ID_DPT
 0xa400

	)

754 
	#PCI_VENDOR_ID_OPTI
 0x1045

	)

755 
	#PCI_DEVICE_ID_OPTI_82C558
 0xc558

	)

756 
	#PCI_DEVICE_ID_OPTI_82C621
 0xc621

	)

757 
	#PCI_DEVICE_ID_OPTI_82C700
 0xc700

	)

758 
	#PCI_DEVICE_ID_OPTI_82C825
 0xd568

	)

760 
	#PCI_VENDOR_ID_ELSA
 0x1048

	)

761 
	#PCI_DEVICE_ID_ELSA_MICROLINK
 0x1000

	)

762 
	#PCI_DEVICE_ID_ELSA_QS3000
 0x3000

	)

764 
	#PCI_VENDOR_ID_BUSLOGIC
 0x104B

	)

765 
	#PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER_NC
 0x0140

	)

766 
	#PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER
 0x1040

	)

767 
	#PCI_DEVICE_ID_BUSLOGIC_FLASHPOINT
 0x8130

	)

769 
	#PCI_VENDOR_ID_TI
 0x104c

	)

770 
	#PCI_DEVICE_ID_TI_TVP4020
 0x3d07

	)

771 
	#PCI_DEVICE_ID_TI_4450
 0x8011

	)

772 
	#PCI_DEVICE_ID_TI_TSB43AB22
 0x8023

	)

773 
	#PCI_DEVICE_ID_TI_XX21_XX11
 0x8031

	)

774 
	#PCI_DEVICE_ID_TI_XX21_XX11_FM
 0x8033

	)

775 
	#PCI_DEVICE_ID_TI_XX21_XX11_SD
 0x8034

	)

776 
	#PCI_DEVICE_ID_TI_X515
 0x8036

	)

777 
	#PCI_DEVICE_ID_TI_XX12
 0x8039

	)

778 
	#PCI_DEVICE_ID_TI_XX12_FM
 0x803b

	)

779 
	#PCI_DEVICE_ID_TI_1130
 0xac12

	)

780 
	#PCI_DEVICE_ID_TI_1031
 0xac13

	)

781 
	#PCI_DEVICE_ID_TI_1131
 0xac15

	)

782 
	#PCI_DEVICE_ID_TI_1250
 0xac16

	)

783 
	#PCI_DEVICE_ID_TI_1220
 0xac17

	)

784 
	#PCI_DEVICE_ID_TI_1221
 0xac19

	)

785 
	#PCI_DEVICE_ID_TI_1210
 0xac1a

	)

786 
	#PCI_DEVICE_ID_TI_1450
 0xac1b

	)

787 
	#PCI_DEVICE_ID_TI_1225
 0xac1c

	)

788 
	#PCI_DEVICE_ID_TI_1251A
 0xac1d

	)

789 
	#PCI_DEVICE_ID_TI_1211
 0xac1e

	)

790 
	#PCI_DEVICE_ID_TI_1251B
 0xac1f

	)

791 
	#PCI_DEVICE_ID_TI_4410
 0xac41

	)

792 
	#PCI_DEVICE_ID_TI_4451
 0xac42

	)

793 
	#PCI_DEVICE_ID_TI_4510
 0xac44

	)

794 
	#PCI_DEVICE_ID_TI_4520
 0xac46

	)

795 
	#PCI_DEVICE_ID_TI_7510
 0xac47

	)

796 
	#PCI_DEVICE_ID_TI_7610
 0xac48

	)

797 
	#PCI_DEVICE_ID_TI_7410
 0xac49

	)

798 
	#PCI_DEVICE_ID_TI_1410
 0xac50

	)

799 
	#PCI_DEVICE_ID_TI_1420
 0xac51

	)

800 
	#PCI_DEVICE_ID_TI_1451A
 0xac52

	)

801 
	#PCI_DEVICE_ID_TI_1620
 0xac54

	)

802 
	#PCI_DEVICE_ID_TI_1520
 0xac55

	)

803 
	#PCI_DEVICE_ID_TI_1510
 0xac56

	)

804 
	#PCI_DEVICE_ID_TI_X620
 0xac8d

	)

805 
	#PCI_DEVICE_ID_TI_X420
 0xac8e

	)

806 
	#PCI_DEVICE_ID_TI_XX20_FM
 0xac8f

	)

808 
	#PCI_VENDOR_ID_SONY
 0x104d

	)

811 
	#PCI_VENDOR_ID_WINBOND2
 0x1050

	)

812 
	#PCI_DEVICE_ID_WINBOND2_89C940F
 0x5a5a

	)

813 
	#PCI_DEVICE_ID_WINBOND2_6692
 0x6692

	)

815 
	#PCI_VENDOR_ID_ANIGMA
 0x1051

	)

816 
	#PCI_DEVICE_ID_ANIGMA_MC145575
 0x0100

	)

818 
	#PCI_VENDOR_ID_EFAR
 0x1055

	)

819 
	#PCI_DEVICE_ID_EFAR_SLC90E66_1
 0x9130

	)

820 
	#PCI_DEVICE_ID_EFAR_SLC90E66_3
 0x9463

	)

822 
	#PCI_VENDOR_ID_MOTOROLA
 0x1057

	)

823 
	#PCI_DEVICE_ID_MOTOROLA_MPC105
 0x0001

	)

824 
	#PCI_DEVICE_ID_MOTOROLA_MPC106
 0x0002

	)

825 
	#PCI_DEVICE_ID_MOTOROLA_MPC107
 0x0004

	)

826 
	#PCI_DEVICE_ID_MOTOROLA_RAVEN
 0x4801

	)

827 
	#PCI_DEVICE_ID_MOTOROLA_FALCON
 0x4802

	)

828 
	#PCI_DEVICE_ID_MOTOROLA_HAWK
 0x4803

	)

829 
	#PCI_DEVICE_ID_MOTOROLA_HARRIER
 0x480b

	)

830 
	#PCI_DEVICE_ID_MOTOROLA_MPC5200
 0x5803

	)

831 
	#PCI_DEVICE_ID_MOTOROLA_MPC5200B
 0x5809

	)

833 
	#PCI_VENDOR_ID_PROMISE
 0x105a

	)

834 
	#PCI_DEVICE_ID_PROMISE_20265
 0x0d30

	)

835 
	#PCI_DEVICE_ID_PROMISE_20267
 0x4d30

	)

836 
	#PCI_DEVICE_ID_PROMISE_20246
 0x4d33

	)

837 
	#PCI_DEVICE_ID_PROMISE_20262
 0x4d38

	)

838 
	#PCI_DEVICE_ID_PROMISE_20263
 0x0D38

	)

839 
	#PCI_DEVICE_ID_PROMISE_20268
 0x4d68

	)

840 
	#PCI_DEVICE_ID_PROMISE_20269
 0x4d69

	)

841 
	#PCI_DEVICE_ID_PROMISE_20270
 0x6268

	)

842 
	#PCI_DEVICE_ID_PROMISE_20271
 0x6269

	)

843 
	#PCI_DEVICE_ID_PROMISE_20275
 0x1275

	)

844 
	#PCI_DEVICE_ID_PROMISE_20276
 0x5275

	)

845 
	#PCI_DEVICE_ID_PROMISE_20277
 0x7275

	)

847 
	#PCI_VENDOR_ID_UMC
 0x1060

	)

848 
	#PCI_DEVICE_ID_UMC_UM8673F
 0x0101

	)

849 
	#PCI_DEVICE_ID_UMC_UM8886BF
 0x673a

	)

850 
	#PCI_DEVICE_ID_UMC_UM8886A
 0x886a

	)

852 
	#PCI_VENDOR_ID_PICOPOWER
 0x1066

	)

853 
	#PCI_DEVICE_ID_PICOPOWER_PT86C523
 0x0002

	)

854 
	#PCI_DEVICE_ID_PICOPOWER_PT86C523BBP
 0x8002

	)

856 
	#PCI_VENDOR_ID_MYLEX
 0x1069

	)

857 
	#PCI_DEVICE_ID_MYLEX_DAC960_P
 0x0001

	)

858 
	#PCI_DEVICE_ID_MYLEX_DAC960_PD
 0x0002

	)

859 
	#PCI_DEVICE_ID_MYLEX_DAC960_PG
 0x0010

	)

860 
	#PCI_DEVICE_ID_MYLEX_DAC960_LA
 0x0020

	)

861 
	#PCI_DEVICE_ID_MYLEX_DAC960_LP
 0x0050

	)

862 
	#PCI_DEVICE_ID_MYLEX_DAC960_BA
 0xBA56

	)

863 
	#PCI_DEVICE_ID_MYLEX_DAC960_GEM
 0xB166

	)

865 
	#PCI_VENDOR_ID_APPLE
 0x106b

	)

866 
	#PCI_DEVICE_ID_APPLE_BANDIT
 0x0001

	)

867 
	#PCI_DEVICE_ID_APPLE_HYDRA
 0x000e

	)

868 
	#PCI_DEVICE_ID_APPLE_UNI_N_FW
 0x0018

	)

869 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP
 0x0020

	)

870 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMAC
 0x0021

	)

871 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMACP
 0x0024

	)

872 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP_P
 0x0027

	)

873 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP15
 0x002d

	)

874 
	#PCI_DEVICE_ID_APPLE_UNI_N_PCI15
 0x002e

	)

875 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMAC2
 0x0032

	)

876 
	#PCI_DEVICE_ID_APPLE_UNI_N_ATA
 0x0033

	)

877 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP2
 0x0034

	)

878 
	#PCI_DEVICE_ID_APPLE_IPID_ATA100
 0x003b

	)

879 
	#PCI_DEVICE_ID_APPLE_K2_ATA100
 0x0043

	)

880 
	#PCI_DEVICE_ID_APPLE_U3_AGP
 0x004b

	)

881 
	#PCI_DEVICE_ID_APPLE_K2_GMAC
 0x004c

	)

882 
	#PCI_DEVICE_ID_APPLE_SH_ATA
 0x0050

	)

883 
	#PCI_DEVICE_ID_APPLE_SH_SUNGEM
 0x0051

	)

884 
	#PCI_DEVICE_ID_APPLE_U3L_AGP
 0x0058

	)

885 
	#PCI_DEVICE_ID_APPLE_U3H_AGP
 0x0059

	)

886 
	#PCI_DEVICE_ID_APPLE_IPID2_AGP
 0x0066

	)

887 
	#PCI_DEVICE_ID_APPLE_IPID2_ATA
 0x0069

	)

888 
	#PCI_DEVICE_ID_APPLE_IPID2_FW
 0x006a

	)

889 
	#PCI_DEVICE_ID_APPLE_IPID2_GMAC
 0x006b

	)

890 
	#PCI_DEVICE_ID_APPLE_TIGON3
 0x1645

	)

892 
	#PCI_VENDOR_ID_YAMAHA
 0x1073

	)

893 
	#PCI_DEVICE_ID_YAMAHA_724
 0x0004

	)

894 
	#PCI_DEVICE_ID_YAMAHA_724F
 0x000d

	)

895 
	#PCI_DEVICE_ID_YAMAHA_740
 0x000a

	)

896 
	#PCI_DEVICE_ID_YAMAHA_740C
 0x000c

	)

897 
	#PCI_DEVICE_ID_YAMAHA_744
 0x0010

	)

898 
	#PCI_DEVICE_ID_YAMAHA_754
 0x0012

	)

900 
	#PCI_VENDOR_ID_QLOGIC
 0x1077

	)

901 
	#PCI_DEVICE_ID_QLOGIC_ISP10160
 0x1016

	)

902 
	#PCI_DEVICE_ID_QLOGIC_ISP1020
 0x1020

	)

903 
	#PCI_DEVICE_ID_QLOGIC_ISP1080
 0x1080

	)

904 
	#PCI_DEVICE_ID_QLOGIC_ISP12160
 0x1216

	)

905 
	#PCI_DEVICE_ID_QLOGIC_ISP1240
 0x1240

	)

906 
	#PCI_DEVICE_ID_QLOGIC_ISP1280
 0x1280

	)

907 
	#PCI_DEVICE_ID_QLOGIC_ISP2100
 0x2100

	)

908 
	#PCI_DEVICE_ID_QLOGIC_ISP2200
 0x2200

	)

909 
	#PCI_DEVICE_ID_QLOGIC_ISP2300
 0x2300

	)

910 
	#PCI_DEVICE_ID_QLOGIC_ISP2312
 0x2312

	)

911 
	#PCI_DEVICE_ID_QLOGIC_ISP2322
 0x2322

	)

912 
	#PCI_DEVICE_ID_QLOGIC_ISP6312
 0x6312

	)

913 
	#PCI_DEVICE_ID_QLOGIC_ISP6322
 0x6322

	)

914 
	#PCI_DEVICE_ID_QLOGIC_ISP2422
 0x2422

	)

915 
	#PCI_DEVICE_ID_QLOGIC_ISP2432
 0x2432

	)

916 
	#PCI_DEVICE_ID_QLOGIC_ISP2512
 0x2512

	)

917 
	#PCI_DEVICE_ID_QLOGIC_ISP2522
 0x2522

	)

918 
	#PCI_DEVICE_ID_QLOGIC_ISP5422
 0x5422

	)

919 
	#PCI_DEVICE_ID_QLOGIC_ISP5432
 0x5432

	)

921 
	#PCI_VENDOR_ID_CYRIX
 0x1078

	)

922 
	#PCI_DEVICE_ID_CYRIX_5510
 0x0000

	)

923 
	#PCI_DEVICE_ID_CYRIX_PCI_MASTER
 0x0001

	)

924 
	#PCI_DEVICE_ID_CYRIX_5520
 0x0002

	)

925 
	#PCI_DEVICE_ID_CYRIX_5530_LEGACY
 0x0100

	)

926 
	#PCI_DEVICE_ID_CYRIX_5530_IDE
 0x0102

	)

927 
	#PCI_DEVICE_ID_CYRIX_5530_AUDIO
 0x0103

	)

928 
	#PCI_DEVICE_ID_CYRIX_5530_VIDEO
 0x0104

	)

930 
	#PCI_VENDOR_ID_CONTAQ
 0x1080

	)

931 
	#PCI_DEVICE_ID_CONTAQ_82C693
 0xc693

	)

933 
	#PCI_VENDOR_ID_OLICOM
 0x108d

	)

934 
	#PCI_DEVICE_ID_OLICOM_OC2325
 0x0012

	)

935 
	#PCI_DEVICE_ID_OLICOM_OC2183
 0x0013

	)

936 
	#PCI_DEVICE_ID_OLICOM_OC2326
 0x0014

	)

938 
	#PCI_VENDOR_ID_SUN
 0x108e

	)

939 
	#PCI_DEVICE_ID_SUN_EBUS
 0x1000

	)

940 
	#PCI_DEVICE_ID_SUN_HAPPYMEAL
 0x1001

	)

941 
	#PCI_DEVICE_ID_SUN_RIO_EBUS
 0x1100

	)

942 
	#PCI_DEVICE_ID_SUN_RIO_GEM
 0x1101

	)

943 
	#PCI_DEVICE_ID_SUN_RIO_1394
 0x1102

	)

944 
	#PCI_DEVICE_ID_SUN_RIO_USB
 0x1103

	)

945 
	#PCI_DEVICE_ID_SUN_GEM
 0x2bad

	)

946 
	#PCI_DEVICE_ID_SUN_SIMBA
 0x5000

	)

947 
	#PCI_DEVICE_ID_SUN_PBM
 0x8000

	)

948 
	#PCI_DEVICE_ID_SUN_SCHIZO
 0x8001

	)

949 
	#PCI_DEVICE_ID_SUN_SABRE
 0xa000

	)

950 
	#PCI_DEVICE_ID_SUN_HUMMINGBIRD
 0xa001

	)

951 
	#PCI_DEVICE_ID_SUN_TOMATILLO
 0xa801

	)

952 
	#PCI_DEVICE_ID_SUN_CASSINI
 0xabba

	)

954 
	#PCI_VENDOR_ID_CMD
 0x1095

	)

955 
	#PCI_DEVICE_ID_CMD_643
 0x0643

	)

956 
	#PCI_DEVICE_ID_CMD_646
 0x0646

	)

957 
	#PCI_DEVICE_ID_CMD_648
 0x0648

	)

958 
	#PCI_DEVICE_ID_CMD_649
 0x0649

	)

960 
	#PCI_DEVICE_ID_SII_680
 0x0680

	)

961 
	#PCI_DEVICE_ID_SII_3112
 0x3112

	)

962 
	#PCI_DEVICE_ID_SII_1210SA
 0x0240

	)

964 
	#PCI_VENDOR_ID_BROOKTREE
 0x109e

	)

965 
	#PCI_DEVICE_ID_BROOKTREE_878
 0x0878

	)

966 
	#PCI_DEVICE_ID_BROOKTREE_879
 0x0879

	)

968 
	#PCI_VENDOR_ID_SGI
 0x10a9

	)

969 
	#PCI_DEVICE_ID_SGI_IOC3
 0x0003

	)

970 
	#PCI_DEVICE_ID_SGI_LITHIUM
 0x1002

	)

971 
	#PCI_DEVICE_ID_SGI_IOC4
 0x100a

	)

973 
	#PCI_VENDOR_ID_WINBOND
 0x10ad

	)

974 
	#PCI_DEVICE_ID_WINBOND_82C105
 0x0105

	)

975 
	#PCI_DEVICE_ID_WINBOND_83C553
 0x0565

	)

977 
	#PCI_VENDOR_ID_PLX
 0x10b5

	)

978 
	#PCI_DEVICE_ID_PLX_R685
 0x1030

	)

979 
	#PCI_DEVICE_ID_PLX_ROMULUS
 0x106a

	)

980 
	#PCI_DEVICE_ID_PLX_SPCOM800
 0x1076

	)

981 
	#PCI_DEVICE_ID_PLX_1077
 0x1077

	)

982 
	#PCI_DEVICE_ID_PLX_SPCOM200
 0x1103

	)

983 
	#PCI_DEVICE_ID_PLX_DJINN_ITOO
 0x1151

	)

984 
	#PCI_DEVICE_ID_PLX_R753
 0x1152

	)

985 
	#PCI_DEVICE_ID_PLX_OLITEC
 0x1187

	)

986 
	#PCI_DEVICE_ID_PLX_PCI200SYN
 0x3196

	)

987 
	#PCI_DEVICE_ID_PLX_9030
 0x9030

	)

988 
	#PCI_DEVICE_ID_PLX_9050
 0x9050

	)

989 
	#PCI_DEVICE_ID_PLX_9080
 0x9080

	)

990 
	#PCI_DEVICE_ID_PLX_GTEK_SERIAL2
 0xa001

	)

992 
	#PCI_VENDOR_ID_MADGE
 0x10b6

	)

993 
	#PCI_DEVICE_ID_MADGE_MK2
 0x0002

	)

995 
	#PCI_VENDOR_ID_3COM
 0x10b7

	)

996 
	#PCI_DEVICE_ID_3COM_3C985
 0x0001

	)

997 
	#PCI_DEVICE_ID_3COM_3C940
 0x1700

	)

998 
	#PCI_DEVICE_ID_3COM_3C339
 0x3390

	)

999 
	#PCI_DEVICE_ID_3COM_3C359
 0x3590

	)

1000 
	#PCI_DEVICE_ID_3COM_3C940B
 0x80eb

	)

1001 
	#PCI_DEVICE_ID_3COM_3CR990
 0x9900

	)

1002 
	#PCI_DEVICE_ID_3COM_3CR990_TX_95
 0x9902

	)

1003 
	#PCI_DEVICE_ID_3COM_3CR990_TX_97
 0x9903

	)

1004 
	#PCI_DEVICE_ID_3COM_3CR990B
 0x9904

	)

1005 
	#PCI_DEVICE_ID_3COM_3CR990_FX
 0x9905

	)

1006 
	#PCI_DEVICE_ID_3COM_3CR990SVR95
 0x9908

	)

1007 
	#PCI_DEVICE_ID_3COM_3CR990SVR97
 0x9909

	)

1008 
	#PCI_DEVICE_ID_3COM_3CR990SVR
 0x990a

	)

1010 
	#PCI_VENDOR_ID_AL
 0x10b9

	)

1011 
	#PCI_DEVICE_ID_AL_M1533
 0x1533

	)

1012 
	#PCI_DEVICE_ID_AL_M1535
 0x1535

	)

1013 
	#PCI_DEVICE_ID_AL_M1541
 0x1541

	)

1014 
	#PCI_DEVICE_ID_AL_M1563
 0x1563

	)

1015 
	#PCI_DEVICE_ID_AL_M1621
 0x1621

	)

1016 
	#PCI_DEVICE_ID_AL_M1631
 0x1631

	)

1017 
	#PCI_DEVICE_ID_AL_M1632
 0x1632

	)

1018 
	#PCI_DEVICE_ID_AL_M1641
 0x1641

	)

1019 
	#PCI_DEVICE_ID_AL_M1644
 0x1644

	)

1020 
	#PCI_DEVICE_ID_AL_M1647
 0x1647

	)

1021 
	#PCI_DEVICE_ID_AL_M1651
 0x1651

	)

1022 
	#PCI_DEVICE_ID_AL_M1671
 0x1671

	)

1023 
	#PCI_DEVICE_ID_AL_M1681
 0x1681

	)

1024 
	#PCI_DEVICE_ID_AL_M1683
 0x1683

	)

1025 
	#PCI_DEVICE_ID_AL_M1689
 0x1689

	)

1026 
	#PCI_DEVICE_ID_AL_M5219
 0x5219

	)

1027 
	#PCI_DEVICE_ID_AL_M5228
 0x5228

	)

1028 
	#PCI_DEVICE_ID_AL_M5229
 0x5229

	)

1029 
	#PCI_DEVICE_ID_AL_M5451
 0x5451

	)

1030 
	#PCI_DEVICE_ID_AL_M7101
 0x7101

	)

1032 
	#PCI_VENDOR_ID_NEOMAGIC
 0x10c8

	)

1033 
	#PCI_DEVICE_ID_NEOMAGIC_NM256AV_AUDIO
 0x8005

	)

1034 
	#PCI_DEVICE_ID_NEOMAGIC_NM256ZX_AUDIO
 0x8006

	)

1035 
	#PCI_DEVICE_ID_NEOMAGIC_NM256XL_PLUS_AUDIO
 0x8016

	)

1037 
	#PCI_VENDOR_ID_TCONRAD
 0x10da

	)

1038 
	#PCI_DEVICE_ID_TCONRAD_TOKENRING
 0x0508

	)

1040 
	#PCI_VENDOR_ID_NVIDIA
 0x10de

	)

1041 
	#PCI_DEVICE_ID_NVIDIA_TNT
 0x0020

	)

1042 
	#PCI_DEVICE_ID_NVIDIA_TNT2
 0x0028

	)

1043 
	#PCI_DEVICE_ID_NVIDIA_UTNT2
 0x0029

	)

1044 
	#PCI_DEVICE_ID_NVIDIA_TNT_UNKNOWN
 0x002a

	)

1045 
	#PCI_DEVICE_ID_NVIDIA_VTNT2
 0x002C

	)

1046 
	#PCI_DEVICE_ID_NVIDIA_UVTNT2
 0x002D

	)

1047 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SMBUS
 0x0034

	)

1048 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_IDE
 0x0035

	)

1049 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA
 0x0036

	)

1050 
	#PCI_DEVICE_ID_NVIDIA_NVENET_10
 0x0037

	)

1051 
	#PCI_DEVICE_ID_NVIDIA_NVENET_11
 0x0038

	)

1052 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA2
 0x003e

	)

1053 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_ULTRA
 0x0040

	)

1054 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800
 0x0041

	)

1055 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_LE
 0x0042

	)

1056 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_GT
 0x0045

	)

1057 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_4000
 0x004E

	)

1058 
	#PCI_DEVICE_ID_NVIDIA_NFORCE4_SMBUS
 0x0052

	)

1059 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_IDE
 0x0053

	)

1060 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA
 0x0054

	)

1061 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA2
 0x0055

	)

1062 
	#PCI_DEVICE_ID_NVIDIA_NVENET_8
 0x0056

	)

1063 
	#PCI_DEVICE_ID_NVIDIA_NVENET_9
 0x0057

	)

1064 
	#PCI_DEVICE_ID_NVIDIA_CK804_AUDIO
 0x0059

	)

1065 
	#PCI_DEVICE_ID_NVIDIA_CK804_PCIE
 0x005d

	)

1066 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2_SMBUS
 0x0064

	)

1067 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2_IDE
 0x0065

	)

1068 
	#PCI_DEVICE_ID_NVIDIA_NVENET_2
 0x0066

	)

1069 
	#PCI_DEVICE_ID_NVIDIA_MCP2_MODEM
 0x0069

	)

1070 
	#PCI_DEVICE_ID_NVIDIA_MCP2_AUDIO
 0x006a

	)

1071 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_SMBUS
 0x0084

	)

1072 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_IDE
 0x0085

	)

1073 
	#PCI_DEVICE_ID_NVIDIA_NVENET_4
 0x0086

	)

1074 
	#PCI_DEVICE_ID_NVIDIA_MCP2S_MODEM
 0x0089

	)

1075 
	#PCI_DEVICE_ID_NVIDIA_CK8_AUDIO
 0x008a

	)

1076 
	#PCI_DEVICE_ID_NVIDIA_NVENET_5
 0x008c

	)

1077 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_SATA
 0x008e

	)

1078 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_7800_GT
 0x0090

	)

1079 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_7800_GTX
 0x0091

	)

1080 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_7800
 0x0098

	)

1081 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_7800_GTX
 0x0099

	)

1082 
	#PCI_DEVICE_ID_NVIDIA_ITNT2
 0x00A0

	)

1083 
	#PCI_DEVICE_ID_GEFORCE_6800A
 0x00c1

	)

1084 
	#PCI_DEVICE_ID_GEFORCE_6800A_LE
 0x00c2

	)

1085 
	#PCI_DEVICE_ID_GEFORCE_GO_6800
 0x00c8

	)

1086 
	#PCI_DEVICE_ID_GEFORCE_GO_6800_ULTRA
 0x00c9

	)

1087 
	#PCI_DEVICE_ID_QUADRO_FX_GO1400
 0x00cc

	)

1088 
	#PCI_DEVICE_ID_QUADRO_FX_1400
 0x00˚

	)

1089 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3
 0x00d1

	)

1090 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3_SMBUS
 0x00d4

	)

1091 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3_IDE
 0x00d5

	)

1092 
	#PCI_DEVICE_ID_NVIDIA_NVENET_3
 0x00d6

	)

1093 
	#PCI_DEVICE_ID_NVIDIA_MCP3_MODEM
 0x00d9

	)

1094 
	#PCI_DEVICE_ID_NVIDIA_MCP3_AUDIO
 0x00da

	)

1095 
	#PCI_DEVICE_ID_NVIDIA_NVENET_7
 0x00df

	)

1096 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S
 0x00e1

	)

1097 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA
 0x00e3

	)

1098 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SMBUS
 0x00e4

	)

1099 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_IDE
 0x00e5

	)

1100 
	#PCI_DEVICE_ID_NVIDIA_NVENET_6
 0x00e6

	)

1101 
	#PCI_DEVICE_ID_NVIDIA_CK8S_AUDIO
 0x00ó

	)

1102 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA2
 0x00ì

	)

1103 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6800_ALT1
 0x00f0

	)

1104 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6600_ALT1
 0x00f1

	)

1105 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6600_ALT2
 0x00f2

	)

1106 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6200_ALT1
 0x00f3

	)

1107 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6800_GT
 0x00f9

	)

1108 
	#PCIE_DEVICE_ID_NVIDIA_QUADRO_NVS280
 0x00fd

	)

1109 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_SDR
 0x0100

	)

1110 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_DDR
 0x0101

	)

1111 
	#PCI_DEVICE_ID_NVIDIA_QUADRO
 0x0103

	)

1112 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_MX
 0x0110

	)

1113 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_MX2
 0x0111

	)

1114 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GO
 0x0112

	)

1115 
	#PCI_DEVICE_ID_NVIDIA_QUADRO2_MXR
 0x0113

	)

1116 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6600_GT
 0x0140

	)

1117 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6600
 0x0141

	)

1118 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6610_XL
 0x0145

	)

1119 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_540
 0x014E

	)

1120 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6200
 0x014F

	)

1121 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GTS
 0x0150

	)

1122 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GTS2
 0x0151

	)

1123 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_ULTRA
 0x0152

	)

1124 
	#PCI_DEVICE_ID_NVIDIA_QUADRO2_PRO
 0x0153

	)

1125 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6200_TURBOCACHE
 0x0161

	)

1126 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6200
 0x0164

	)

1127 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6250
 0x0166

	)

1128 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6200_1
 0x0167

	)

1129 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6250_1
 0x0168

	)

1130 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_460
 0x0170

	)

1131 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440
 0x0171

	)

1132 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_420
 0x0172

	)

1133 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440_SE
 0x0173

	)

1134 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_440_GO
 0x0174

	)

1135 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_420_GO
 0x0175

	)

1136 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_420_GO_M32
 0x0176

	)

1137 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_460_GO
 0x0177

	)

1138 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_500XGL
 0x0178

	)

1139 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_440_GO_M64
 0x0179

	)

1140 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_200
 0x017A

	)

1141 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_550XGL
 0x017B

	)

1142 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_500_GOGL
 0x017C

	)

1143 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_410_GO_M16
 0x017D

	)

1144 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440_8X
 0x0181

	)

1145 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440SE_8X
 0x0182

	)

1146 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_420_8X
 0x0183

	)

1147 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_4000
 0x0185

	)

1148 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_448_GO
 0x0186

	)

1149 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_488_GO
 0x0187

	)

1150 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_580_XGL
 0x0188

	)

1151 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_MAC
 0x0189

	)

1152 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_280_NVS
 0x018A

	)

1153 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_380_XGL
 0x018B

	)

1154 
	#PCI_DEVICE_ID_NVIDIA_IGEFORCE2
 0x01a0

	)

1155 
	#PCI_DEVICE_ID_NVIDIA_NFORCE
 0x01a4

	)

1156 
	#PCI_DEVICE_ID_NVIDIA_MCP1_AUDIO
 0x01b1

	)

1157 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_SMBUS
 0x01b4

	)

1158 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_IDE
 0x01bc

	)

1159 
	#PCI_DEVICE_ID_NVIDIA_MCP1_MODEM
 0x01c1

	)

1160 
	#PCI_DEVICE_ID_NVIDIA_NVENET_1
 0x01c3

	)

1161 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2
 0x01e0

	)

1162 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3
 0x0200

	)

1163 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3_1
 0x0201

	)

1164 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3_2
 0x0202

	)

1165 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_DDC
 0x0203

	)

1166 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B
 0x0211

	)

1167 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B_LE
 0x0212

	)

1168 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B_GT
 0x0215

	)

1169 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4600
 0x0250

	)

1170 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4400
 0x0251

	)

1171 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4200
 0x0253

	)

1172 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_900XGL
 0x0258

	)

1173 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_750XGL
 0x0259

	)

1174 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_700XGL
 0x025B

	)

1175 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SMBUS
 0x0264

	)

1176 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_IDE
 0x0265

	)

1177 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA
 0x0266

	)

1178 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA2
 0x0267

	)

1179 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SMBUS
 0x0368

	)

1180 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_IDE
 0x036E

	)

1181 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA
 0x037E

	)

1182 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA2
 0x037F

	)

1183 
	#PCI_DEVICE_ID_NVIDIA_NVENET_12
 0x0268

	)

1184 
	#PCI_DEVICE_ID_NVIDIA_NVENET_13
 0x0269

	)

1185 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800
 0x0280

	)

1186 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800_8X
 0x0281

	)

1187 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800SE
 0x0282

	)

1188 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_4200_GO
 0x0286

	)

1189 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_980_XGL
 0x0288

	)

1190 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_780_XGL
 0x0289

	)

1191 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_700_GOGL
 0x028C

	)

1192 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5800_ULTRA
 0x0301

	)

1193 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5800
 0x0302

	)

1194 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_2000
 0x0308

	)

1195 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_1000
 0x0309

	)

1196 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600_ULTRA
 0x0311

	)

1197 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600
 0x0312

	)

1198 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600SE
 0x0314

	)

1199 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5600
 0x031A

	)

1200 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5650
 0x031B

	)

1201 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_GO700
 0x031C

	)

1202 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200
 0x0320

	)

1203 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200_ULTRA
 0x0321

	)

1204 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200_1
 0x0322

	)

1205 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200SE
 0x0323

	)

1206 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5200
 0x0324

	)

1207 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5250
 0x0325

	)

1208 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5500
 0x0326

	)

1209 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5100
 0x0327

	)

1210 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5250_32
 0x0328

	)

1211 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO_5200
 0x0329

	)

1212 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_NVS_280_PCI
 0x032A

	)

1213 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_500
 0x032B

	)

1214 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5300
 0x032C

	)

1215 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5100
 0x032D

	)

1216 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900_ULTRA
 0x0330

	)

1217 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900
 0x0331

	)

1218 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900XT
 0x0332

	)

1219 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5950_ULTRA
 0x0333

	)

1220 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900ZT
 0x0334

	)

1221 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_3000
 0x0338

	)

1222 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_700
 0x033F

	)

1223 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700_ULTRA
 0x0341

	)

1224 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700
 0x0342

	)

1225 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700LE
 0x0343

	)

1226 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700VE
 0x0344

	)

1227 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5700_1
 0x0347

	)

1228 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5700_2
 0x0348

	)

1229 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_GO1000
 0x034C

	)

1230 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_1100
 0x034E

	)

1231 
	#PCI_DEVICE_ID_NVIDIA_NVENET_14
 0x0372

	)

1232 
	#PCI_DEVICE_ID_NVIDIA_NVENET_15
 0x0373

	)

1233 
	#PCI_DEVICE_ID_NVIDIA_NVENET_16
 0x03E5

	)

1234 
	#PCI_DEVICE_ID_NVIDIA_NVENET_17
 0x03E6

	)

1235 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA
 0x03E7

	)

1236 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SMBUS
 0x03EB

	)

1237 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_IDE
 0x03EC

	)

1238 
	#PCI_DEVICE_ID_NVIDIA_NVENET_18
 0x03EE

	)

1239 
	#PCI_DEVICE_ID_NVIDIA_NVENET_19
 0x03EF

	)

1240 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA2
 0x03F6

	)

1241 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA3
 0x03F7

	)

1242 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP65_SMBUS
 0x0446

	)

1243 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP65_IDE
 0x0448

	)

1244 
	#PCI_DEVICE_ID_NVIDIA_NVENET_20
 0x0450

	)

1245 
	#PCI_DEVICE_ID_NVIDIA_NVENET_21
 0x0451

	)

1246 
	#PCI_DEVICE_ID_NVIDIA_NVENET_22
 0x0452

	)

1247 
	#PCI_DEVICE_ID_NVIDIA_NVENET_23
 0x0453

	)

1248 
	#PCI_DEVICE_ID_NVIDIA_NVENET_24
 0x054C

	)

1249 
	#PCI_DEVICE_ID_NVIDIA_NVENET_25
 0x054D

	)

1250 
	#PCI_DEVICE_ID_NVIDIA_NVENET_26
 0x054E

	)

1251 
	#PCI_DEVICE_ID_NVIDIA_NVENET_27
 0x054F

	)

1252 
	#PCI_DEVICE_ID_NVIDIA_NVENET_28
 0x07DC

	)

1253 
	#PCI_DEVICE_ID_NVIDIA_NVENET_29
 0x07DD

	)

1254 
	#PCI_DEVICE_ID_NVIDIA_NVENET_30
 0x07DE

	)

1255 
	#PCI_DEVICE_ID_NVIDIA_NVENET_31
 0x07DF

	)

1256 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP67_IDE
 0x0560

	)

1257 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP73_IDE
 0x056C

	)

1258 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP77_IDE
 0x0759

	)

1259 
	#PCI_DEVICE_ID_NVIDIA_NVENET_32
 0x0760

	)

1260 
	#PCI_DEVICE_ID_NVIDIA_NVENET_33
 0x0761

	)

1261 
	#PCI_DEVICE_ID_NVIDIA_NVENET_34
 0x0762

	)

1262 
	#PCI_DEVICE_ID_NVIDIA_NVENET_35
 0x0763

	)

1263 
	#PCI_DEVICE_ID_NVIDIA_NVENET_36
 0x0AB0

	)

1264 
	#PCI_DEVICE_ID_NVIDIA_NVENET_37
 0x0AB1

	)

1265 
	#PCI_DEVICE_ID_NVIDIA_NVENET_38
 0x0AB2

	)

1266 
	#PCI_DEVICE_ID_NVIDIA_NVENET_39
 0x0AB3

	)

1268 
	#PCI_VENDOR_ID_IMS
 0x10e0

	)

1269 
	#PCI_DEVICE_ID_IMS_TT128
 0x9128

	)

1270 
	#PCI_DEVICE_ID_IMS_TT3D
 0x9135

	)

1272 
	#PCI_VENDOR_ID_INTERG
 0x10ó

	)

1273 
	#PCI_DEVICE_ID_INTERG_1682
 0x1682

	)

1274 
	#PCI_DEVICE_ID_INTERG_2000
 0x2000

	)

1275 
	#PCI_DEVICE_ID_INTERG_2010
 0x2010

	)

1276 
	#PCI_DEVICE_ID_INTERG_5000
 0x5000

	)

1277 
	#PCI_DEVICE_ID_INTERG_5050
 0x5050

	)

1279 
	#PCI_VENDOR_ID_REALTEK
 0x10ec

	)

1280 
	#PCI_DEVICE_ID_REALTEK_8139
 0x8139

	)

1282 
	#PCI_VENDOR_ID_XILINX
 0x10ì

	)

1283 
	#PCI_DEVICE_ID_RME_DIGI96
 0x3fc0

	)

1284 
	#PCI_DEVICE_ID_RME_DIGI96_8
 0x3fc1

	)

1285 
	#PCI_DEVICE_ID_RME_DIGI96_8_PRO
 0x3fc2

	)

1286 
	#PCI_DEVICE_ID_RME_DIGI96_8_PAD_OR_PST
 0x3fc3

	)

1287 
	#PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP
 0x3fc5

	)

1288 
	#PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP_MADI
 0x3fc6

	)

1290 
	#PCI_VENDOR_ID_INIT
 0x1101

	)

1292 
	#PCI_VENDOR_ID_CREATIVE
 0x1102

	)

1293 
	#PCI_DEVICE_ID_CREATIVE_EMU10K1
 0x0002

	)

1295 
	#PCI_VENDOR_ID_ECTIVA
 0x1102

	)

1296 
	#PCI_DEVICE_ID_ECTIVA_EV1938
 0x8938

	)

1298 
	#PCI_VENDOR_ID_TTI
 0x1103

	)

1299 
	#PCI_DEVICE_ID_TTI_HPT343
 0x0003

	)

1300 
	#PCI_DEVICE_ID_TTI_HPT366
 0x0004

	)

1301 
	#PCI_DEVICE_ID_TTI_HPT372
 0x0005

	)

1302 
	#PCI_DEVICE_ID_TTI_HPT302
 0x0006

	)

1303 
	#PCI_DEVICE_ID_TTI_HPT371
 0x0007

	)

1304 
	#PCI_DEVICE_ID_TTI_HPT374
 0x0008

	)

1305 
	#PCI_DEVICE_ID_TTI_HPT372N
 0x0009

	)

1307 
	#PCI_VENDOR_ID_VIA
 0x1106

	)

1308 
	#PCI_DEVICE_ID_VIA_8763_0
 0x0198

	)

1309 
	#PCI_DEVICE_ID_VIA_8380_0
 0x0204

	)

1310 
	#PCI_DEVICE_ID_VIA_3238_0
 0x0238

	)

1311 
	#PCI_DEVICE_ID_VIA_PT880
 0x0258

	)

1312 
	#PCI_DEVICE_ID_VIA_PT880ULTRA
 0x0308

	)

1313 
	#PCI_DEVICE_ID_VIA_PX8X0_0
 0x0259

	)

1314 
	#PCI_DEVICE_ID_VIA_3269_0
 0x0269

	)

1315 
	#PCI_DEVICE_ID_VIA_K8T800PRO_0
 0x0282

	)

1316 
	#PCI_DEVICE_ID_VIA_3296_0
 0x0296

	)

1317 
	#PCI_DEVICE_ID_VIA_8363_0
 0x0305

	)

1318 
	#PCI_DEVICE_ID_VIA_P4M800CE
 0x0314

	)

1319 
	#PCI_DEVICE_ID_VIA_P4M890
 0x0327

	)

1320 
	#PCI_DEVICE_ID_VIA_VT3324
 0x0324

	)

1321 
	#PCI_DEVICE_ID_VIA_VT3336
 0x0336

	)

1322 
	#PCI_DEVICE_ID_VIA_VT3351
 0x0351

	)

1323 
	#PCI_DEVICE_ID_VIA_VT3364
 0x0364

	)

1324 
	#PCI_DEVICE_ID_VIA_8371_0
 0x0391

	)

1325 
	#PCI_DEVICE_ID_VIA_8501_0
 0x0501

	)

1326 
	#PCI_DEVICE_ID_VIA_82C561
 0x0561

	)

1327 
	#PCI_DEVICE_ID_VIA_82C586_1
 0x0571

	)

1328 
	#PCI_DEVICE_ID_VIA_82C576
 0x0576

	)

1329 
	#PCI_DEVICE_ID_VIA_82C586_0
 0x0586

	)

1330 
	#PCI_DEVICE_ID_VIA_82C596
 0x0596

	)

1331 
	#PCI_DEVICE_ID_VIA_82C597_0
 0x0597

	)

1332 
	#PCI_DEVICE_ID_VIA_82C598_0
 0x0598

	)

1333 
	#PCI_DEVICE_ID_VIA_8601_0
 0x0601

	)

1334 
	#PCI_DEVICE_ID_VIA_8605_0
 0x0605

	)

1335 
	#PCI_DEVICE_ID_VIA_82C686
 0x0686

	)

1336 
	#PCI_DEVICE_ID_VIA_82C691_0
 0x0691

	)

1337 
	#PCI_DEVICE_ID_VIA_82C576_1
 0x1571

	)

1338 
	#PCI_DEVICE_ID_VIA_82C586_2
 0x3038

	)

1339 
	#PCI_DEVICE_ID_VIA_82C586_3
 0x3040

	)

1340 
	#PCI_DEVICE_ID_VIA_82C596_3
 0x3050

	)

1341 
	#PCI_DEVICE_ID_VIA_82C596B_3
 0x3051

	)

1342 
	#PCI_DEVICE_ID_VIA_82C686_4
 0x3057

	)

1343 
	#PCI_DEVICE_ID_VIA_82C686_5
 0x3058

	)

1344 
	#PCI_DEVICE_ID_VIA_8233_5
 0x3059

	)

1345 
	#PCI_DEVICE_ID_VIA_8233_0
 0x3074

	)

1346 
	#PCI_DEVICE_ID_VIA_8633_0
 0x3091

	)

1347 
	#PCI_DEVICE_ID_VIA_8367_0
 0x3099

	)

1348 
	#PCI_DEVICE_ID_VIA_8653_0
 0x3101

	)

1349 
	#PCI_DEVICE_ID_VIA_8622
 0x3102

	)

1350 
	#PCI_DEVICE_ID_VIA_8235_USB_2
 0x3104

	)

1351 
	#PCI_DEVICE_ID_VIA_8233C_0
 0x3109

	)

1352 
	#PCI_DEVICE_ID_VIA_8361
 0x3112

	)

1353 
	#PCI_DEVICE_ID_VIA_XM266
 0x3116

	)

1354 
	#PCI_DEVICE_ID_VIA_612X
 0x3119

	)

1355 
	#PCI_DEVICE_ID_VIA_862X_0
 0x3123

	)

1356 
	#PCI_DEVICE_ID_VIA_8753_0
 0x3128

	)

1357 
	#PCI_DEVICE_ID_VIA_8233A
 0x3147

	)

1358 
	#PCI_DEVICE_ID_VIA_8703_51_0
 0x3148

	)

1359 
	#PCI_DEVICE_ID_VIA_8237_SATA
 0x3149

	)

1360 
	#PCI_DEVICE_ID_VIA_XN266
 0x3156

	)

1361 
	#PCI_DEVICE_ID_VIA_6410
 0x3164

	)

1362 
	#PCI_DEVICE_ID_VIA_8754C_0
 0x3168

	)

1363 
	#PCI_DEVICE_ID_VIA_8235
 0x3177

	)

1364 
	#PCI_DEVICE_ID_VIA_8385_0
 0x3188

	)

1365 
	#PCI_DEVICE_ID_VIA_8377_0
 0x3189

	)

1366 
	#PCI_DEVICE_ID_VIA_8378_0
 0x3205

	)

1367 
	#PCI_DEVICE_ID_VIA_8783_0
 0x3208

	)

1368 
	#PCI_DEVICE_ID_VIA_8237
 0x3227

	)

1369 
	#PCI_DEVICE_ID_VIA_8251
 0x3287

	)

1370 
	#PCI_DEVICE_ID_VIA_8237A
 0x3337

	)

1371 
	#PCI_DEVICE_ID_VIA_8237S
 0x3372

	)

1372 
	#PCI_DEVICE_ID_VIA_SATA_EIDE
 0x5324

	)

1373 
	#PCI_DEVICE_ID_VIA_8231
 0x8231

	)

1374 
	#PCI_DEVICE_ID_VIA_8231_4
 0x8235

	)

1375 
	#PCI_DEVICE_ID_VIA_8365_1
 0x8305

	)

1376 
	#PCI_DEVICE_ID_VIA_CX700
 0x8324

	)

1377 
	#PCI_DEVICE_ID_VIA_CX700_IDE
 0x0581

	)

1378 
	#PCI_DEVICE_ID_VIA_VX800
 0x8353

	)

1379 
	#PCI_DEVICE_ID_VIA_8371_1
 0x8391

	)

1380 
	#PCI_DEVICE_ID_VIA_82C598_1
 0x8598

	)

1381 
	#PCI_DEVICE_ID_VIA_838X_1
 0xB188

	)

1382 
	#PCI_DEVICE_ID_VIA_83_87XX_1
 0xB198

	)

1384 
	#PCI_VENDOR_ID_SIEMENS
 0x110A

	)

1385 
	#PCI_DEVICE_ID_SIEMENS_DSCC4
 0x2102

	)

1387 
	#PCI_VENDOR_ID_VORTEX
 0x1119

	)

1388 
	#PCI_DEVICE_ID_VORTEX_GDT60x0
 0x0000

	)

1389 
	#PCI_DEVICE_ID_VORTEX_GDT6000B
 0x0001

	)

1390 
	#PCI_DEVICE_ID_VORTEX_GDT6x10
 0x0002

	)

1391 
	#PCI_DEVICE_ID_VORTEX_GDT6x20
 0x0003

	)

1392 
	#PCI_DEVICE_ID_VORTEX_GDT6530
 0x0004

	)

1393 
	#PCI_DEVICE_ID_VORTEX_GDT6550
 0x0005

	)

1394 
	#PCI_DEVICE_ID_VORTEX_GDT6x17
 0x0006

	)

1395 
	#PCI_DEVICE_ID_VORTEX_GDT6x27
 0x0007

	)

1396 
	#PCI_DEVICE_ID_VORTEX_GDT6537
 0x0008

	)

1397 
	#PCI_DEVICE_ID_VORTEX_GDT6557
 0x0009

	)

1398 
	#PCI_DEVICE_ID_VORTEX_GDT6x15
 0x000a

	)

1399 
	#PCI_DEVICE_ID_VORTEX_GDT6x25
 0x000b

	)

1400 
	#PCI_DEVICE_ID_VORTEX_GDT6535
 0x000c

	)

1401 
	#PCI_DEVICE_ID_VORTEX_GDT6555
 0x000d

	)

1402 
	#PCI_DEVICE_ID_VORTEX_GDT6x17RP
 0x0100

	)

1403 
	#PCI_DEVICE_ID_VORTEX_GDT6x27RP
 0x0101

	)

1404 
	#PCI_DEVICE_ID_VORTEX_GDT6537RP
 0x0102

	)

1405 
	#PCI_DEVICE_ID_VORTEX_GDT6557RP
 0x0103

	)

1406 
	#PCI_DEVICE_ID_VORTEX_GDT6x11RP
 0x0104

	)

1407 
	#PCI_DEVICE_ID_VORTEX_GDT6x21RP
 0x0105

	)

1409 
	#PCI_VENDOR_ID_EF
 0x111a

	)

1410 
	#PCI_DEVICE_ID_EF_ATM_FPGA
 0x0000

	)

1411 
	#PCI_DEVICE_ID_EF_ATM_ASIC
 0x0002

	)

1412 
	#PCI_DEVICE_ID_EF_ATM_LANAI2
 0x0003

	)

1413 
	#PCI_DEVICE_ID_EF_ATM_LANAIHB
 0x0005

	)

1415 
	#PCI_VENDOR_ID_IDT
 0x111d

	)

1416 
	#PCI_DEVICE_ID_IDT_IDT77201
 0x0001

	)

1418 
	#PCI_VENDOR_ID_FORE
 0x1127

	)

1419 
	#PCI_DEVICE_ID_FORE_PCA200E
 0x0300

	)

1421 
	#PCI_VENDOR_ID_PHILIPS
 0x1131

	)

1422 
	#PCI_DEVICE_ID_PHILIPS_SAA7146
 0x7146

	)

1423 
	#PCI_DEVICE_ID_PHILIPS_SAA9730
 0x9730

	)

1425 
	#PCI_VENDOR_ID_EICON
 0x1133

	)

1426 
	#PCI_DEVICE_ID_EICON_DIVA20
 0xe002

	)

1427 
	#PCI_DEVICE_ID_EICON_DIVA20_U
 0xe004

	)

1428 
	#PCI_DEVICE_ID_EICON_DIVA201
 0xe005

	)

1429 
	#PCI_DEVICE_ID_EICON_DIVA202
 0xe00b

	)

1430 
	#PCI_DEVICE_ID_EICON_MAESTRA
 0xe010

	)

1431 
	#PCI_DEVICE_ID_EICON_MAESTRAQ
 0xe012

	)

1432 
	#PCI_DEVICE_ID_EICON_MAESTRAQ_U
 0xe013

	)

1433 
	#PCI_DEVICE_ID_EICON_MAESTRAP
 0xe014

	)

1435 
	#PCI_VENDOR_ID_CISCO
 0x1137

	)

1437 
	#PCI_VENDOR_ID_ZIATECH
 0x1138

	)

1438 
	#PCI_DEVICE_ID_ZIATECH_5550_HC
 0x5550

	)

1441 
	#PCI_VENDOR_ID_SYSKONNECT
 0x1148

	)

1442 
	#PCI_DEVICE_ID_SYSKONNECT_TR
 0x4200

	)

1443 
	#PCI_DEVICE_ID_SYSKONNECT_GE
 0x4300

	)

1444 
	#PCI_DEVICE_ID_SYSKONNECT_YU
 0x4320

	)

1445 
	#PCI_DEVICE_ID_SYSKONNECT_9DXX
 0x4400

	)

1446 
	#PCI_DEVICE_ID_SYSKONNECT_9MXX
 0x4500

	)

1448 
	#PCI_VENDOR_ID_DIGI
 0x114f

	)

1449 
	#PCI_DEVICE_ID_DIGI_DF_M_IOM2_E
 0x0070

	)

1450 
	#PCI_DEVICE_ID_DIGI_DF_M_E
 0x0071

	)

1451 
	#PCI_DEVICE_ID_DIGI_DF_M_IOM2_A
 0x0072

	)

1452 
	#PCI_DEVICE_ID_DIGI_DF_M_A
 0x0073

	)

1453 
	#PCI_DEVICE_ID_NEO_2DB9
 0x00C8

	)

1454 
	#PCI_DEVICE_ID_NEO_2DB9PRI
 0x00C9

	)

1455 
	#PCI_DEVICE_ID_NEO_2RJ45
 0x00CA

	)

1456 
	#PCI_DEVICE_ID_NEO_2RJ45PRI
 0x00CB

	)

1457 
	#PCIE_DEVICE_ID_NEO_4_IBM
 0x00F4

	)

1459 
	#PCI_VENDOR_ID_XIRCOM
 0x115d

	)

1460 
	#PCI_DEVICE_ID_XIRCOM_RBM56G
 0x0101

	)

1461 
	#PCI_DEVICE_ID_XIRCOM_X3201_MDM
 0x0103

	)

1463 
	#PCI_VENDOR_ID_SERVERWORKS
 0x1166

	)

1464 
	#PCI_DEVICE_ID_SERVERWORKS_HE
 0x0008

	)

1465 
	#PCI_DEVICE_ID_SERVERWORKS_LE
 0x0009

	)

1466 
	#PCI_DEVICE_ID_SERVERWORKS_GCNB_LE
 0x0017

	)

1467 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000_PXB
 0x0036

	)

1468 
	#PCI_DEVICE_ID_SERVERWORKS_EPB
 0x0103

	)

1469 
	#PCI_DEVICE_ID_SERVERWORKS_HT2000_PCIE
 0x0132

	)

1470 
	#PCI_DEVICE_ID_SERVERWORKS_OSB4
 0x0200

	)

1471 
	#PCI_DEVICE_ID_SERVERWORKS_CSB5
 0x0201

	)

1472 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6
 0x0203

	)

1473 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000SB
 0x0205

	)

1474 
	#PCI_DEVICE_ID_SERVERWORKS_OSB4IDE
 0x0211

	)

1475 
	#PCI_DEVICE_ID_SERVERWORKS_CSB5IDE
 0x0212

	)

1476 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6IDE
 0x0213

	)

1477 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000IDE
 0x0214

	)

1478 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6IDE2
 0x0217

	)

1479 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6LPC
 0x0227

	)

1481 
	#PCI_VENDOR_ID_SBE
 0x1176

	)

1482 
	#PCI_DEVICE_ID_SBE_WANXL100
 0x0301

	)

1483 
	#PCI_DEVICE_ID_SBE_WANXL200
 0x0302

	)

1484 
	#PCI_DEVICE_ID_SBE_WANXL400
 0x0104

	)

1486 
	#PCI_VENDOR_ID_TOSHIBA
 0x1179

	)

1487 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO
 0x0102

	)

1488 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO_1
 0x0103

	)

1489 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO_2
 0x0105

	)

1490 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC95
 0x060a

	)

1491 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC97
 0x060f

	)

1492 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC100
 0x0617

	)

1494 
	#PCI_VENDOR_ID_TOSHIBA_2
 0x102f

	)

1495 
	#PCI_DEVICE_ID_TOSHIBA_TC35815CF
 0x0030

	)

1496 
	#PCI_DEVICE_ID_TOSHIBA_TC35815_NWU
 0x0031

	)

1497 
	#PCI_DEVICE_ID_TOSHIBA_TC35815_TX4939
 0x0032

	)

1498 
	#PCI_DEVICE_ID_TOSHIBA_TC86C001_IDE
 0x0105

	)

1499 
	#PCI_DEVICE_ID_TOSHIBA_TC86C001_MISC
 0x0108

	)

1500 
	#PCI_DEVICE_ID_TOSHIBA_SPIDER_NET
 0x01b3

	)

1502 
	#PCI_VENDOR_ID_ATTO
 0x117c

	)

1504 
	#PCI_VENDOR_ID_RICOH
 0x1180

	)

1505 
	#PCI_DEVICE_ID_RICOH_RL5C465
 0x0465

	)

1506 
	#PCI_DEVICE_ID_RICOH_RL5C466
 0x0466

	)

1507 
	#PCI_DEVICE_ID_RICOH_RL5C475
 0x0475

	)

1508 
	#PCI_DEVICE_ID_RICOH_RL5C476
 0x0476

	)

1509 
	#PCI_DEVICE_ID_RICOH_RL5C478
 0x0478

	)

1510 
	#PCI_DEVICE_ID_RICOH_R5C822
 0x0822

	)

1511 
	#PCI_DEVICE_ID_RICOH_R5C832
 0x0832

	)

1512 
	#PCI_DEVICE_ID_RICOH_R5C843
 0x0843

	)

1514 
	#PCI_VENDOR_ID_DLINK
 0x1186

	)

1515 
	#PCI_DEVICE_ID_DLINK_DGE510T
 0x4c00

	)

1517 
	#PCI_VENDOR_ID_ARTOP
 0x1191

	)

1518 
	#PCI_DEVICE_ID_ARTOP_ATP850UF
 0x0005

	)

1519 
	#PCI_DEVICE_ID_ARTOP_ATP860
 0x0006

	)

1520 
	#PCI_DEVICE_ID_ARTOP_ATP860R
 0x0007

	)

1521 
	#PCI_DEVICE_ID_ARTOP_ATP865
 0x0008

	)

1522 
	#PCI_DEVICE_ID_ARTOP_ATP865R
 0x0009

	)

1523 
	#PCI_DEVICE_ID_ARTOP_AEC7610
 0x8002

	)

1524 
	#PCI_DEVICE_ID_ARTOP_AEC7612UW
 0x8010

	)

1525 
	#PCI_DEVICE_ID_ARTOP_AEC7612U
 0x8020

	)

1526 
	#PCI_DEVICE_ID_ARTOP_AEC7612S
 0x8030

	)

1527 
	#PCI_DEVICE_ID_ARTOP_AEC7612D
 0x8040

	)

1528 
	#PCI_DEVICE_ID_ARTOP_AEC7612SUW
 0x8050

	)

1529 
	#PCI_DEVICE_ID_ARTOP_8060
 0x8060

	)

1531 
	#PCI_VENDOR_ID_ZEITNET
 0x1193

	)

1532 
	#PCI_DEVICE_ID_ZEITNET_1221
 0x0001

	)

1533 
	#PCI_DEVICE_ID_ZEITNET_1225
 0x0002

	)

1535 
	#PCI_VENDOR_ID_FUJITSU_ME
 0x119e

	)

1536 
	#PCI_DEVICE_ID_FUJITSU_FS155
 0x0001

	)

1537 
	#PCI_DEVICE_ID_FUJITSU_FS50
 0x0003

	)

1539 
	#PCI_SUBVENDOR_ID_KEYSPAN
 0x11a9

	)

1540 
	#PCI_SUBDEVICE_ID_KEYSPAN_SX2
 0x5334

	)

1542 
	#PCI_VENDOR_ID_MARVELL
 0x11ab

	)

1543 
	#PCI_DEVICE_ID_MARVELL_GT64111
 0x4146

	)

1544 
	#PCI_DEVICE_ID_MARVELL_GT64260
 0x6430

	)

1545 
	#PCI_DEVICE_ID_MARVELL_MV64360
 0x6460

	)

1546 
	#PCI_DEVICE_ID_MARVELL_MV64460
 0x6480

	)

1547 
	#PCI_DEVICE_ID_MARVELL_88ALP01_NAND
 0x4100

	)

1548 
	#PCI_DEVICE_ID_MARVELL_88ALP01_SD
 0x4101

	)

1549 
	#PCI_DEVICE_ID_MARVELL_88ALP01_CCIC
 0x4102

	)

1551 
	#PCI_VENDOR_ID_V3
 0x11b0

	)

1552 
	#PCI_DEVICE_ID_V3_V960
 0x0001

	)

1553 
	#PCI_DEVICE_ID_V3_V351
 0x0002

	)

1555 
	#PCI_VENDOR_ID_ATT
 0x11c1

	)

1556 
	#PCI_DEVICE_ID_ATT_VENUS_MODEM
 0x480

	)

1558 
	#PCI_VENDOR_ID_SPECIALIX
 0x11cb

	)

1559 
	#PCI_DEVICE_ID_SPECIALIX_IO8
 0x2000

	)

1560 
	#PCI_DEVICE_ID_SPECIALIX_RIO
 0x8000

	)

1561 
	#PCI_SUBDEVICE_ID_SPECIALIX_SPEED4
 0xa004

	)

1563 
	#PCI_VENDOR_ID_ANALOG_DEVICES
 0x11d4

	)

1564 
	#PCI_DEVICE_ID_AD1889JS
 0x1889

	)

1566 
	#PCI_DEVICE_ID_SEGA_BBA
 0x1234

	)

1568 
	#PCI_VENDOR_ID_ZORAN
 0x11de

	)

1569 
	#PCI_DEVICE_ID_ZORAN_36057
 0x6057

	)

1570 
	#PCI_DEVICE_ID_ZORAN_36120
 0x6120

	)

1572 
	#PCI_VENDOR_ID_COMPEX
 0x11f6

	)

1573 
	#PCI_DEVICE_ID_COMPEX_ENET100VG4
 0x0112

	)

1575 
	#PCI_VENDOR_ID_RP
 0x11„

	)

1576 
	#PCI_DEVICE_ID_RP32INTF
 0x0001

	)

1577 
	#PCI_DEVICE_ID_RP8INTF
 0x0002

	)

1578 
	#PCI_DEVICE_ID_RP16INTF
 0x0003

	)

1579 
	#PCI_DEVICE_ID_RP4QUAD
 0x0004

	)

1580 
	#PCI_DEVICE_ID_RP8OCTA
 0x0005

	)

1581 
	#PCI_DEVICE_ID_RP8J
 0x0006

	)

1582 
	#PCI_DEVICE_ID_RP4J
 0x0007

	)

1583 
	#PCI_DEVICE_ID_RP8SNI
 0x0008

	)

1584 
	#PCI_DEVICE_ID_RP16SNI
 0x0009

	)

1585 
	#PCI_DEVICE_ID_RPP4
 0x000A

	)

1586 
	#PCI_DEVICE_ID_RPP8
 0x000B

	)

1587 
	#PCI_DEVICE_ID_RP4M
 0x000D

	)

1588 
	#PCI_DEVICE_ID_RP2_232
 0x000E

	)

1589 
	#PCI_DEVICE_ID_RP2_422
 0x000F

	)

1590 
	#PCI_DEVICE_ID_URP32INTF
 0x0801

	)

1591 
	#PCI_DEVICE_ID_URP8INTF
 0x0802

	)

1592 
	#PCI_DEVICE_ID_URP16INTF
 0x0803

	)

1593 
	#PCI_DEVICE_ID_URP8OCTA
 0x0805

	)

1594 
	#PCI_DEVICE_ID_UPCI_RM3_8PORT
 0x080C

	)

1595 
	#PCI_DEVICE_ID_UPCI_RM3_4PORT
 0x080D

	)

1596 
	#PCI_DEVICE_ID_CRP16INTF
 0x0903

	)

1598 
	#PCI_VENDOR_ID_CYCLADES
 0x120e

	)

1599 
	#PCI_DEVICE_ID_CYCLOM_Y_Lo
 0x0100

	)

1600 
	#PCI_DEVICE_ID_CYCLOM_Y_Hi
 0x0101

	)

1601 
	#PCI_DEVICE_ID_CYCLOM_4Y_Lo
 0x0102

	)

1602 
	#PCI_DEVICE_ID_CYCLOM_4Y_Hi
 0x0103

	)

1603 
	#PCI_DEVICE_ID_CYCLOM_8Y_Lo
 0x0104

	)

1604 
	#PCI_DEVICE_ID_CYCLOM_8Y_Hi
 0x0105

	)

1605 
	#PCI_DEVICE_ID_CYCLOM_Z_Lo
 0x0200

	)

1606 
	#PCI_DEVICE_ID_CYCLOM_Z_Hi
 0x0201

	)

1607 
	#PCI_DEVICE_ID_PC300_RX_2
 0x0300

	)

1608 
	#PCI_DEVICE_ID_PC300_RX_1
 0x0301

	)

1609 
	#PCI_DEVICE_ID_PC300_TE_2
 0x0310

	)

1610 
	#PCI_DEVICE_ID_PC300_TE_1
 0x0311

	)

1611 
	#PCI_DEVICE_ID_PC300_TE_M_2
 0x0320

	)

1612 
	#PCI_DEVICE_ID_PC300_TE_M_1
 0x0321

	)

1614 
	#PCI_VENDOR_ID_ESSENTIAL
 0x120f

	)

1615 
	#PCI_DEVICE_ID_ESSENTIAL_ROADRUNNER
 0x0001

	)

1617 
	#PCI_VENDOR_ID_O2
 0x1217

	)

1618 
	#PCI_DEVICE_ID_O2_6729
 0x6729

	)

1619 
	#PCI_DEVICE_ID_O2_6730
 0x673a

	)

1620 
	#PCI_DEVICE_ID_O2_6832
 0x6832

	)

1621 
	#PCI_DEVICE_ID_O2_6836
 0x6836

	)

1623 
	#PCI_VENDOR_ID_3DFX
 0x121a

	)

1624 
	#PCI_DEVICE_ID_3DFX_VOODOO
 0x0001

	)

1625 
	#PCI_DEVICE_ID_3DFX_VOODOO2
 0x0002

	)

1626 
	#PCI_DEVICE_ID_3DFX_BANSHEE
 0x0003

	)

1627 
	#PCI_DEVICE_ID_3DFX_VOODOO3
 0x0005

	)

1628 
	#PCI_DEVICE_ID_3DFX_VOODOO5
 0x0009

	)

1630 
	#PCI_VENDOR_ID_AVM
 0x1244

	)

1631 
	#PCI_DEVICE_ID_AVM_B1
 0x0700

	)

1632 
	#PCI_DEVICE_ID_AVM_C4
 0x0800

	)

1633 
	#PCI_DEVICE_ID_AVM_A1
 0x0a00

	)

1634 
	#PCI_DEVICE_ID_AVM_A1_V2
 0x0e00

	)

1635 
	#PCI_DEVICE_ID_AVM_C2
 0x1100

	)

1636 
	#PCI_DEVICE_ID_AVM_T1
 0x1200

	)

1638 
	#PCI_VENDOR_ID_STALLION
 0x124d

	)

1641 
	#PCI_VENDOR_ID_AT
 0x1259

	)

1642 
	#PCI_SUBDEVICE_ID_AT_2700FX
 0x2701

	)

1643 
	#PCI_SUBDEVICE_ID_AT_2701FX
 0x2703

	)

1645 
	#PCI_VENDOR_ID_ESS
 0x125d

	)

1646 
	#PCI_DEVICE_ID_ESS_ESS1968
 0x1968

	)

1647 
	#PCI_DEVICE_ID_ESS_ESS1978
 0x1978

	)

1648 
	#PCI_DEVICE_ID_ESS_ALLEGRO_1
 0x1988

	)

1649 
	#PCI_DEVICE_ID_ESS_ALLEGRO
 0x1989

	)

1650 
	#PCI_DEVICE_ID_ESS_CANYON3D_2LE
 0x1990

	)

1651 
	#PCI_DEVICE_ID_ESS_CANYON3D_2
 0x1992

	)

1652 
	#PCI_DEVICE_ID_ESS_MAESTRO3
 0x1998

	)

1653 
	#PCI_DEVICE_ID_ESS_MAESTRO3_1
 0x1999

	)

1654 
	#PCI_DEVICE_ID_ESS_MAESTRO3_HW
 0x199a

	)

1655 
	#PCI_DEVICE_ID_ESS_MAESTRO3_2
 0x199b

	)

1657 
	#PCI_VENDOR_ID_SATSAGEM
 0x1267

	)

1658 
	#PCI_DEVICE_ID_SATSAGEM_NICCY
 0x1016

	)

1660 
	#PCI_VENDOR_ID_ENSONIQ
 0x1274

	)

1661 
	#PCI_DEVICE_ID_ENSONIQ_CT5880
 0x5880

	)

1662 
	#PCI_DEVICE_ID_ENSONIQ_ES1370
 0x5000

	)

1663 
	#PCI_DEVICE_ID_ENSONIQ_ES1371
 0x1371

	)

1665 
	#PCI_VENDOR_ID_TRANSMETA
 0x1279

	)

1666 
	#PCI_DEVICE_ID_EFFICEON
 0x0060

	)

1668 
	#PCI_VENDOR_ID_ROCKWELL
 0x127A

	)

1670 
	#PCI_VENDOR_ID_ITE
 0x1283

	)

1671 
	#PCI_DEVICE_ID_ITE_8211
 0x8211

	)

1672 
	#PCI_DEVICE_ID_ITE_8212
 0x8212

	)

1673 
	#PCI_DEVICE_ID_ITE_8213
 0x8213

	)

1674 
	#PCI_DEVICE_ID_ITE_8152
 0x8152

	)

1675 
	#PCI_DEVICE_ID_ITE_8872
 0x8872

	)

1676 
	#PCI_DEVICE_ID_ITE_IT8330G_0
 0xe886

	)

1679 
	#PCI_DEVICE_ID_ESS_ESS0100
 0x0100

	)

1681 
	#PCI_VENDOR_ID_ALTEON
 0x12´

	)

1683 
	#PCI_SUBVENDOR_ID_CONNECT_TECH
 0x12c4

	)

1684 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_232
 0x0001

	)

1685 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_232
 0x0002

	)

1686 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_232
 0x0003

	)

1687 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485
 0x0004

	)

1688 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485_4_4
 0x0005

	)

1689 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_485
 0x0006

	)

1690 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_485_2_2
 0x0007

	)

1691 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_485
 0x0008

	)

1692 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485_2_6
 0x0009

	)

1693 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH081101V1
 0x000A

	)

1694 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH041101V1
 0x000B

	)

1695 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_20MHZ
 0x000C

	)

1696 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_PTM
 0x000D

	)

1697 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_NT960PCI
 0x0100

	)

1698 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_TITAN_2
 0x0201

	)

1699 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_TITAN_4
 0x0202

	)

1700 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_232
 0x0300

	)

1701 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_232
 0x0301

	)

1702 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8_232
 0x0302

	)

1703 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_1_1
 0x0310

	)

1704 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_2
 0x0311

	)

1705 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_4
 0x0312

	)

1706 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2
 0x0320

	)

1707 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4
 0x0321

	)

1708 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8
 0x0322

	)

1709 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_485
 0x0330

	)

1710 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_485
 0x0331

	)

1711 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8_485
 0x0332

	)

1713 
	#PCI_VENDOR_ID_NVIDIA_SGS
 0x12d2

	)

1714 
	#PCI_DEVICE_ID_NVIDIA_SGS_RIVA128
 0x0018

	)

1716 
	#PCI_SUBVENDOR_ID_CHASE_PCIFAST
 0x12E0

	)

1717 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST4
 0x0031

	)

1718 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST8
 0x0021

	)

1719 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST16
 0x0011

	)

1720 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST16FMC
 0x0041

	)

1721 
	#PCI_SUBVENDOR_ID_CHASE_PCIRAS
 0x124D

	)

1722 
	#PCI_SUBDEVICE_ID_CHASE_PCIRAS4
 0xF001

	)

1723 
	#PCI_SUBDEVICE_ID_CHASE_PCIRAS8
 0xF010

	)

1725 
	#PCI_VENDOR_ID_AUREAL
 0x12eb

	)

1726 
	#PCI_DEVICE_ID_AUREAL_VORTEX_1
 0x0001

	)

1727 
	#PCI_DEVICE_ID_AUREAL_VORTEX_2
 0x0002

	)

1728 
	#PCI_DEVICE_ID_AUREAL_ADVANTAGE
 0x0003

	)

1730 
	#PCI_VENDOR_ID_ELECTRONICDESIGNGMBH
 0x12f8

	)

1731 
	#PCI_DEVICE_ID_LML_33R10
 0x8a02

	)

1733 
	#PCI_VENDOR_ID_ESDGMBH
 0x12„

	)

1734 
	#PCI_DEVICE_ID_ESDGMBH_CPCIASIO4
 0x0111

	)

1736 
	#PCI_VENDOR_ID_SIIG
 0x131f

	)

1737 
	#PCI_SUBVENDOR_ID_SIIG
 0x131f

	)

1738 
	#PCI_DEVICE_ID_SIIG_1S_10x_550
 0x1000

	)

1739 
	#PCI_DEVICE_ID_SIIG_1S_10x_650
 0x1001

	)

1740 
	#PCI_DEVICE_ID_SIIG_1S_10x_850
 0x1002

	)

1741 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_550
 0x1010

	)

1742 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_650
 0x1011

	)

1743 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_850
 0x1012

	)

1744 
	#PCI_DEVICE_ID_SIIG_1P_10x
 0x1020

	)

1745 
	#PCI_DEVICE_ID_SIIG_2P_10x
 0x1021

	)

1746 
	#PCI_DEVICE_ID_SIIG_2S_10x_550
 0x1030

	)

1747 
	#PCI_DEVICE_ID_SIIG_2S_10x_650
 0x1031

	)

1748 
	#PCI_DEVICE_ID_SIIG_2S_10x_850
 0x1032

	)

1749 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_550
 0x1034

	)

1750 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_650
 0x1035

	)

1751 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_850
 0x1036

	)

1752 
	#PCI_DEVICE_ID_SIIG_4S_10x_550
 0x1050

	)

1753 
	#PCI_DEVICE_ID_SIIG_4S_10x_650
 0x1051

	)

1754 
	#PCI_DEVICE_ID_SIIG_4S_10x_850
 0x1052

	)

1755 
	#PCI_DEVICE_ID_SIIG_1S_20x_550
 0x2000

	)

1756 
	#PCI_DEVICE_ID_SIIG_1S_20x_650
 0x2001

	)

1757 
	#PCI_DEVICE_ID_SIIG_1S_20x_850
 0x2002

	)

1758 
	#PCI_DEVICE_ID_SIIG_1P_20x
 0x2020

	)

1759 
	#PCI_DEVICE_ID_SIIG_2P_20x
 0x2021

	)

1760 
	#PCI_DEVICE_ID_SIIG_2S_20x_550
 0x2030

	)

1761 
	#PCI_DEVICE_ID_SIIG_2S_20x_650
 0x2031

	)

1762 
	#PCI_DEVICE_ID_SIIG_2S_20x_850
 0x2032

	)

1763 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_550
 0x2040

	)

1764 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_650
 0x2041

	)

1765 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_850
 0x2042

	)

1766 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_550
 0x2010

	)

1767 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_650
 0x2011

	)

1768 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_850
 0x2012

	)

1769 
	#PCI_DEVICE_ID_SIIG_4S_20x_550
 0x2050

	)

1770 
	#PCI_DEVICE_ID_SIIG_4S_20x_650
 0x2051

	)

1771 
	#PCI_DEVICE_ID_SIIG_4S_20x_850
 0x2052

	)

1772 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_550
 0x2060

	)

1773 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_650
 0x2061

	)

1774 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_850
 0x2062

	)

1775 
	#PCI_DEVICE_ID_SIIG_8S_20x_550
 0x2080

	)

1776 
	#PCI_DEVICE_ID_SIIG_8S_20x_650
 0x2081

	)

1777 
	#PCI_DEVICE_ID_SIIG_8S_20x_850
 0x2082

	)

1778 
	#PCI_SUBDEVICE_ID_SIIG_QUARTET_SERIAL
 0x2050

	)

1780 
	#PCI_VENDOR_ID_RADISYS
 0x1331

	)

1782 
	#PCI_VENDOR_ID_MICRO_MEMORY
 0x1332

	)

1783 
	#PCI_DEVICE_ID_MICRO_MEMORY_5415CN
 0x5415

	)

1784 
	#PCI_DEVICE_ID_MICRO_MEMORY_5425CN
 0x5425

	)

1785 
	#PCI_DEVICE_ID_MICRO_MEMORY_6155
 0x6155

	)

1787 
	#PCI_VENDOR_ID_DOMEX
 0x134a

	)

1788 
	#PCI_DEVICE_ID_DOMEX_DMX3191D
 0x0001

	)

1790 
	#PCI_VENDOR_ID_INTASHIELD
 0x135a

	)

1791 
	#PCI_DEVICE_ID_INTASHIELD_IS200
 0x0d80

	)

1792 
	#PCI_DEVICE_ID_INTASHIELD_IS400
 0x0dc0

	)

1794 
	#PCI_VENDOR_ID_QUATECH
 0x135C

	)

1795 
	#PCI_DEVICE_ID_QUATECH_QSC100
 0x0010

	)

1796 
	#PCI_DEVICE_ID_QUATECH_DSC100
 0x0020

	)

1797 
	#PCI_DEVICE_ID_QUATECH_ESC100D
 0x0050

	)

1798 
	#PCI_DEVICE_ID_QUATECH_ESC100M
 0x0060

	)

1799 
	#PCI_DEVICE_ID_QUATECH_SPPXP_100
 0x0278

	)

1801 
	#PCI_VENDOR_ID_SEALEVEL
 0x135e

	)

1802 
	#PCI_DEVICE_ID_SEALEVEL_U530
 0x7101

	)

1803 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM2
 0x7201

	)

1804 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM422
 0x7402

	)

1805 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM232
 0x7202

	)

1806 
	#PCI_DEVICE_ID_SEALEVEL_COMM4
 0x7401

	)

1807 
	#PCI_DEVICE_ID_SEALEVEL_COMM8
 0x7801

	)

1808 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM8
 0x7804

	)

1810 
	#PCI_VENDOR_ID_HYPERCOPE
 0x1365

	)

1811 
	#PCI_DEVICE_ID_HYPERCOPE_PLX
 0x9050

	)

1812 
	#PCI_SUBDEVICE_ID_HYPERCOPE_OLD_ERGO
 0x0104

	)

1813 
	#PCI_SUBDEVICE_ID_HYPERCOPE_ERGO
 0x0106

	)

1814 
	#PCI_SUBDEVICE_ID_HYPERCOPE_METRO
 0x0107

	)

1815 
	#PCI_SUBDEVICE_ID_HYPERCOPE_CHAMP2
 0x0108

	)

1817 
	#PCI_VENDOR_ID_KAWASAKI
 0x136b

	)

1818 
	#PCI_DEVICE_ID_MCHIP_KL5A72002
 0xff01

	)

1820 
	#PCI_VENDOR_ID_CNET
 0x1371

	)

1821 
	#PCI_DEVICE_ID_CNET_GIGACARD
 0x434e

	)

1823 
	#PCI_VENDOR_ID_LMC
 0x1376

	)

1824 
	#PCI_DEVICE_ID_LMC_HSSI
 0x0003

	)

1825 
	#PCI_DEVICE_ID_LMC_DS3
 0x0004

	)

1826 
	#PCI_DEVICE_ID_LMC_SSI
 0x0005

	)

1827 
	#PCI_DEVICE_ID_LMC_T1
 0x0006

	)

1829 
	#PCI_VENDOR_ID_NETGEAR
 0x1385

	)

1830 
	#PCI_DEVICE_ID_NETGEAR_GA620
 0x620a

	)

1832 
	#PCI_VENDOR_ID_APPLICOM
 0x1389

	)

1833 
	#PCI_DEVICE_ID_APPLICOM_PCIGENERIC
 0x0001

	)

1834 
	#PCI_DEVICE_ID_APPLICOM_PCI2000IBS_CAN
 0x0002

	)

1835 
	#PCI_DEVICE_ID_APPLICOM_PCI2000PFB
 0x0003

	)

1837 
	#PCI_VENDOR_ID_MOXA
 0x1393

	)

1838 
	#PCI_DEVICE_ID_MOXA_RC7000
 0x0001

	)

1839 
	#PCI_DEVICE_ID_MOXA_CP102
 0x1020

	)

1840 
	#PCI_DEVICE_ID_MOXA_CP102UL
 0x1021

	)

1841 
	#PCI_DEVICE_ID_MOXA_CP102U
 0x1022

	)

1842 
	#PCI_DEVICE_ID_MOXA_C104
 0x1040

	)

1843 
	#PCI_DEVICE_ID_MOXA_CP104U
 0x1041

	)

1844 
	#PCI_DEVICE_ID_MOXA_CP104JU
 0x1042

	)

1845 
	#PCI_DEVICE_ID_MOXA_CP104EL
 0x1043

	)

1846 
	#PCI_DEVICE_ID_MOXA_CT114
 0x1140

	)

1847 
	#PCI_DEVICE_ID_MOXA_CP114
 0x1141

	)

1848 
	#PCI_DEVICE_ID_MOXA_CP118U
 0x1180

	)

1849 
	#PCI_DEVICE_ID_MOXA_CP118EL
 0x1181

	)

1850 
	#PCI_DEVICE_ID_MOXA_CP132
 0x1320

	)

1851 
	#PCI_DEVICE_ID_MOXA_CP132U
 0x1321

	)

1852 
	#PCI_DEVICE_ID_MOXA_CP134U
 0x1340

	)

1853 
	#PCI_DEVICE_ID_MOXA_C168
 0x1680

	)

1854 
	#PCI_DEVICE_ID_MOXA_CP168U
 0x1681

	)

1855 
	#PCI_DEVICE_ID_MOXA_CP168EL
 0x1682

	)

1856 
	#PCI_DEVICE_ID_MOXA_CP204J
 0x2040

	)

1857 
	#PCI_DEVICE_ID_MOXA_C218
 0x2180

	)

1858 
	#PCI_DEVICE_ID_MOXA_C320
 0x3200

	)

1860 
	#PCI_VENDOR_ID_CCD
 0x1397

	)

1861 
	#PCI_DEVICE_ID_CCD_HFC4S
 0x08B4

	)

1862 
	#PCI_SUBDEVICE_ID_CCD_PMX2S
 0x1234

	)

1863 
	#PCI_DEVICE_ID_CCD_HFC8S
 0x16B8

	)

1864 
	#PCI_DEVICE_ID_CCD_2BD0
 0x2bd0

	)

1865 
	#PCI_DEVICE_ID_CCD_HFCE1
 0x30B1

	)

1866 
	#PCI_SUBDEVICE_ID_CCD_SPD4S
 0x3136

	)

1867 
	#PCI_SUBDEVICE_ID_CCD_SPDE1
 0x3137

	)

1868 
	#PCI_DEVICE_ID_CCD_B000
 0xb000

	)

1869 
	#PCI_DEVICE_ID_CCD_B006
 0xb006

	)

1870 
	#PCI_DEVICE_ID_CCD_B007
 0xb007

	)

1871 
	#PCI_DEVICE_ID_CCD_B008
 0xb008

	)

1872 
	#PCI_DEVICE_ID_CCD_B009
 0xb009

	)

1873 
	#PCI_DEVICE_ID_CCD_B00A
 0xb00a

	)

1874 
	#PCI_DEVICE_ID_CCD_B00B
 0xb00b

	)

1875 
	#PCI_DEVICE_ID_CCD_B00C
 0xb00c

	)

1876 
	#PCI_DEVICE_ID_CCD_B100
 0xb100

	)

1877 
	#PCI_SUBDEVICE_ID_CCD_IOB4ST
 0xB520

	)

1878 
	#PCI_SUBDEVICE_ID_CCD_IOB8STR
 0xB521

	)

1879 
	#PCI_SUBDEVICE_ID_CCD_IOB8ST
 0xB522

	)

1880 
	#PCI_SUBDEVICE_ID_CCD_IOB1E1
 0xB523

	)

1881 
	#PCI_SUBDEVICE_ID_CCD_SWYX4S
 0xB540

	)

1882 
	#PCI_SUBDEVICE_ID_CCD_JH4S20
 0xB550

	)

1883 
	#PCI_SUBDEVICE_ID_CCD_IOB8ST_1
 0xB552

	)

1884 
	#PCI_SUBDEVICE_ID_CCD_BN4S
 0xB560

	)

1885 
	#PCI_SUBDEVICE_ID_CCD_BN8S
 0xB562

	)

1886 
	#PCI_SUBDEVICE_ID_CCD_BNE1
 0xB563

	)

1887 
	#PCI_SUBDEVICE_ID_CCD_BNE1D
 0xB564

	)

1888 
	#PCI_SUBDEVICE_ID_CCD_BNE1DP
 0xB565

	)

1889 
	#PCI_SUBDEVICE_ID_CCD_BN2S
 0xB566

	)

1890 
	#PCI_SUBDEVICE_ID_CCD_BN1SM
 0xB567

	)

1891 
	#PCI_SUBDEVICE_ID_CCD_BN4SM
 0xB568

	)

1892 
	#PCI_SUBDEVICE_ID_CCD_BN2SM
 0xB569

	)

1893 
	#PCI_SUBDEVICE_ID_CCD_BNE1M
 0xB56A

	)

1894 
	#PCI_SUBDEVICE_ID_CCD_BN8SP
 0xB56B

	)

1895 
	#PCI_SUBDEVICE_ID_CCD_HFC4S
 0xB620

	)

1896 
	#PCI_SUBDEVICE_ID_CCD_HFC8S
 0xB622

	)

1897 
	#PCI_DEVICE_ID_CCD_B700
 0xb700

	)

1898 
	#PCI_DEVICE_ID_CCD_B701
 0xb701

	)

1899 
	#PCI_SUBDEVICE_ID_CCD_HFCE1
 0xC523

	)

1900 
	#PCI_SUBDEVICE_ID_CCD_OV2S
 0xE884

	)

1901 
	#PCI_SUBDEVICE_ID_CCD_OV4S
 0xE888

	)

1902 
	#PCI_SUBDEVICE_ID_CCD_OV8S
 0xE998

	)

1904 
	#PCI_VENDOR_ID_EXAR
 0x13a8

	)

1905 
	#PCI_DEVICE_ID_EXAR_XR17C152
 0x0152

	)

1906 
	#PCI_DEVICE_ID_EXAR_XR17C154
 0x0154

	)

1907 
	#PCI_DEVICE_ID_EXAR_XR17C158
 0x0158

	)

1909 
	#PCI_VENDOR_ID_MICROGATE
 0x13c0

	)

1910 
	#PCI_DEVICE_ID_MICROGATE_USC
 0x0010

	)

1911 
	#PCI_DEVICE_ID_MICROGATE_SCA
 0x0030

	)

1913 
	#PCI_VENDOR_ID_3WARE
 0x13C1

	)

1914 
	#PCI_DEVICE_ID_3WARE_1000
 0x1000

	)

1915 
	#PCI_DEVICE_ID_3WARE_7000
 0x1001

	)

1916 
	#PCI_DEVICE_ID_3WARE_9000
 0x1002

	)

1918 
	#PCI_VENDOR_ID_IOMEGA
 0x13ˇ

	)

1919 
	#PCI_DEVICE_ID_IOMEGA_BUZ
 0x4231

	)

1921 
	#PCI_VENDOR_ID_ABOCOM
 0x13D1

	)

1922 
	#PCI_DEVICE_ID_ABOCOM_2BD1
 0x2BD1

	)

1924 
	#PCI_VENDOR_ID_SUNDANCE
 0x13f0

	)

1926 
	#PCI_VENDOR_ID_CMEDIA
 0x13f6

	)

1927 
	#PCI_DEVICE_ID_CMEDIA_CM8338A
 0x0100

	)

1928 
	#PCI_DEVICE_ID_CMEDIA_CM8338B
 0x0101

	)

1929 
	#PCI_DEVICE_ID_CMEDIA_CM8738
 0x0111

	)

1930 
	#PCI_DEVICE_ID_CMEDIA_CM8738B
 0x0112

	)

1932 
	#PCI_VENDOR_ID_LAVA
 0x1407

	)

1933 
	#PCI_DEVICE_ID_LAVA_DSERIAL
 0x0100

	)

1934 
	#PCI_DEVICE_ID_LAVA_QUATRO_A
 0x0101

	)

1935 
	#PCI_DEVICE_ID_LAVA_QUATRO_B
 0x0102

	)

1936 
	#PCI_DEVICE_ID_LAVA_OCTO_A
 0x0180

	)

1937 
	#PCI_DEVICE_ID_LAVA_OCTO_B
 0x0181

	)

1938 
	#PCI_DEVICE_ID_LAVA_PORT_PLUS
 0x0200

	)

1939 
	#PCI_DEVICE_ID_LAVA_QUAD_A
 0x0201

	)

1940 
	#PCI_DEVICE_ID_LAVA_QUAD_B
 0x0202

	)

1941 
	#PCI_DEVICE_ID_LAVA_SSERIAL
 0x0500

	)

1942 
	#PCI_DEVICE_ID_LAVA_PORT_650
 0x0600

	)

1943 
	#PCI_DEVICE_ID_LAVA_PARALLEL
 0x8000

	)

1944 
	#PCI_DEVICE_ID_LAVA_DUAL_PAR_A
 0x8002

	)

1945 
	#PCI_DEVICE_ID_LAVA_DUAL_PAR_B
 0x8003

	)

1946 
	#PCI_DEVICE_ID_LAVA_BOCA_IOPPAR
 0x8800

	)

1948 
	#PCI_VENDOR_ID_TIMEDIA
 0x1409

	)

1949 
	#PCI_DEVICE_ID_TIMEDIA_1889
 0x7168

	)

1951 
	#PCI_VENDOR_ID_ICE
 0x1412

	)

1952 
	#PCI_DEVICE_ID_ICE_1712
 0x1712

	)

1953 
	#PCI_DEVICE_ID_VT1724
 0x1724

	)

1955 
	#PCI_VENDOR_ID_OXSEMI
 0x1415

	)

1956 
	#PCI_DEVICE_ID_OXSEMI_12PCI840
 0x8403

	)

1957 
	#PCI_DEVICE_ID_OXSEMI_PCIe840
 0xC000

	)

1958 
	#PCI_DEVICE_ID_OXSEMI_PCIe840_G
 0xC004

	)

1959 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_0
 0xC100

	)

1960 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_0_G
 0xC104

	)

1961 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1
 0xC110

	)

1962 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_G
 0xC114

	)

1963 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_U
 0xC118

	)

1964 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_GU
 0xC11C

	)

1965 
	#PCI_DEVICE_ID_OXSEMI_16PCI954
 0x9501

	)

1966 
	#PCI_DEVICE_ID_OXSEMI_16PCI95N
 0x9511

	)

1967 
	#PCI_DEVICE_ID_OXSEMI_16PCI954PP
 0x9513

	)

1968 
	#PCI_DEVICE_ID_OXSEMI_16PCI952
 0x9521

	)

1969 
	#PCI_DEVICE_ID_OXSEMI_16PCI952PP
 0x9523

	)

1971 
	#PCI_VENDOR_ID_CHELSIO
 0x1425

	)

1973 
	#PCI_VENDOR_ID_SAMSUNG
 0x144d

	)

1975 
	#PCI_VENDOR_ID_MYRICOM
 0x14c1

	)

1977 
	#PCI_VENDOR_ID_TITAN
 0x14D2

	)

1978 
	#PCI_DEVICE_ID_TITAN_010L
 0x8001

	)

1979 
	#PCI_DEVICE_ID_TITAN_100L
 0x8010

	)

1980 
	#PCI_DEVICE_ID_TITAN_110L
 0x8011

	)

1981 
	#PCI_DEVICE_ID_TITAN_200L
 0x8020

	)

1982 
	#PCI_DEVICE_ID_TITAN_210L
 0x8021

	)

1983 
	#PCI_DEVICE_ID_TITAN_400L
 0x8040

	)

1984 
	#PCI_DEVICE_ID_TITAN_800L
 0x8080

	)

1985 
	#PCI_DEVICE_ID_TITAN_100
 0xA001

	)

1986 
	#PCI_DEVICE_ID_TITAN_200
 0xA005

	)

1987 
	#PCI_DEVICE_ID_TITAN_400
 0xA003

	)

1988 
	#PCI_DEVICE_ID_TITAN_800B
 0xA004

	)

1990 
	#PCI_VENDOR_ID_PANACOM
 0x14d4

	)

1991 
	#PCI_DEVICE_ID_PANACOM_QUADMODEM
 0x0400

	)

1992 
	#PCI_DEVICE_ID_PANACOM_DUALMODEM
 0x0402

	)

1994 
	#PCI_VENDOR_ID_SIPACKETS
 0x14d9

	)

1995 
	#PCI_DEVICE_ID_SP1011
 0x0010

	)

1997 
	#PCI_VENDOR_ID_AFAVLAB
 0x14db

	)

1998 
	#PCI_DEVICE_ID_AFAVLAB_P028
 0x2180

	)

1999 
	#PCI_DEVICE_ID_AFAVLAB_P030
 0x2182

	)

2000 
	#PCI_SUBDEVICE_ID_AFAVLAB_P061
 0x2150

	)

2002 
	#PCI_VENDOR_ID_BROADCOM
 0x14e4

	)

2003 
	#PCI_DEVICE_ID_TIGON3_5752
 0x1600

	)

2004 
	#PCI_DEVICE_ID_TIGON3_5752M
 0x1601

	)

2005 
	#PCI_DEVICE_ID_NX2_5709
 0x1639

	)

2006 
	#PCI_DEVICE_ID_NX2_5709S
 0x163a

	)

2007 
	#PCI_DEVICE_ID_TIGON3_5700
 0x1644

	)

2008 
	#PCI_DEVICE_ID_TIGON3_5701
 0x1645

	)

2009 
	#PCI_DEVICE_ID_TIGON3_5702
 0x1646

	)

2010 
	#PCI_DEVICE_ID_TIGON3_5703
 0x1647

	)

2011 
	#PCI_DEVICE_ID_TIGON3_5704
 0x1648

	)

2012 
	#PCI_DEVICE_ID_TIGON3_5704S_2
 0x1649

	)

2013 
	#PCI_DEVICE_ID_NX2_5706
 0x164a

	)

2014 
	#PCI_DEVICE_ID_NX2_5708
 0x164c

	)

2015 
	#PCI_DEVICE_ID_TIGON3_5702FE
 0x164d

	)

2016 
	#PCI_DEVICE_ID_NX2_57710
 0x164e

	)

2017 
	#PCI_DEVICE_ID_NX2_57711
 0x164f

	)

2018 
	#PCI_DEVICE_ID_NX2_57711E
 0x1650

	)

2019 
	#PCI_DEVICE_ID_TIGON3_5705
 0x1653

	)

2020 
	#PCI_DEVICE_ID_TIGON3_5705_2
 0x1654

	)

2021 
	#PCI_DEVICE_ID_TIGON3_5720
 0x1658

	)

2022 
	#PCI_DEVICE_ID_TIGON3_5721
 0x1659

	)

2023 
	#PCI_DEVICE_ID_TIGON3_5722
 0x165a

	)

2024 
	#PCI_DEVICE_ID_TIGON3_5723
 0x165b

	)

2025 
	#PCI_DEVICE_ID_TIGON3_5705M
 0x165d

	)

2026 
	#PCI_DEVICE_ID_TIGON3_5705M_2
 0x165e

	)

2027 
	#PCI_DEVICE_ID_TIGON3_5714
 0x1668

	)

2028 
	#PCI_DEVICE_ID_TIGON3_5714S
 0x1669

	)

2029 
	#PCI_DEVICE_ID_TIGON3_5780
 0x166a

	)

2030 
	#PCI_DEVICE_ID_TIGON3_5780S
 0x166b

	)

2031 
	#PCI_DEVICE_ID_TIGON3_5705F
 0x166e

	)

2032 
	#PCI_DEVICE_ID_TIGON3_5754M
 0x1672

	)

2033 
	#PCI_DEVICE_ID_TIGON3_5755M
 0x1673

	)

2034 
	#PCI_DEVICE_ID_TIGON3_5756
 0x1674

	)

2035 
	#PCI_DEVICE_ID_TIGON3_5750
 0x1676

	)

2036 
	#PCI_DEVICE_ID_TIGON3_5751
 0x1677

	)

2037 
	#PCI_DEVICE_ID_TIGON3_5715
 0x1678

	)

2038 
	#PCI_DEVICE_ID_TIGON3_5715S
 0x1679

	)

2039 
	#PCI_DEVICE_ID_TIGON3_5754
 0x167a

	)

2040 
	#PCI_DEVICE_ID_TIGON3_5755
 0x167b

	)

2041 
	#PCI_DEVICE_ID_TIGON3_5750M
 0x167c

	)

2042 
	#PCI_DEVICE_ID_TIGON3_5751M
 0x167d

	)

2043 
	#PCI_DEVICE_ID_TIGON3_5751F
 0x167e

	)

2044 
	#PCI_DEVICE_ID_TIGON3_5787F
 0x167f

	)

2045 
	#PCI_DEVICE_ID_TIGON3_5761E
 0x1680

	)

2046 
	#PCI_DEVICE_ID_TIGON3_5761
 0x1681

	)

2047 
	#PCI_DEVICE_ID_TIGON3_5764
 0x1684

	)

2048 
	#PCI_DEVICE_ID_TIGON3_5787M
 0x1693

	)

2049 
	#PCI_DEVICE_ID_TIGON3_5782
 0x1696

	)

2050 
	#PCI_DEVICE_ID_TIGON3_5784
 0x1698

	)

2051 
	#PCI_DEVICE_ID_TIGON3_5785
 0x1699

	)

2052 
	#PCI_DEVICE_ID_TIGON3_5786
 0x169a

	)

2053 
	#PCI_DEVICE_ID_TIGON3_5787
 0x169b

	)

2054 
	#PCI_DEVICE_ID_TIGON3_5788
 0x169c

	)

2055 
	#PCI_DEVICE_ID_TIGON3_5789
 0x169d

	)

2056 
	#PCI_DEVICE_ID_TIGON3_5702X
 0x16a6

	)

2057 
	#PCI_DEVICE_ID_TIGON3_5703X
 0x16a7

	)

2058 
	#PCI_DEVICE_ID_TIGON3_5704S
 0x16a8

	)

2059 
	#PCI_DEVICE_ID_NX2_5706S
 0x16Ø

	)

2060 
	#PCI_DEVICE_ID_NX2_5708S
 0x16ac

	)

2061 
	#PCI_DEVICE_ID_TIGON3_5702A3
 0x16c6

	)

2062 
	#PCI_DEVICE_ID_TIGON3_5703A3
 0x16c7

	)

2063 
	#PCI_DEVICE_ID_TIGON3_5781
 0x16dd

	)

2064 
	#PCI_DEVICE_ID_TIGON3_5753
 0x16f7

	)

2065 
	#PCI_DEVICE_ID_TIGON3_5753M
 0x16fd

	)

2066 
	#PCI_DEVICE_ID_TIGON3_5753F
 0x16„

	)

2067 
	#PCI_DEVICE_ID_TIGON3_5901
 0x170d

	)

2068 
	#PCI_DEVICE_ID_BCM4401B1
 0x170c

	)

2069 
	#PCI_DEVICE_ID_TIGON3_5901_2
 0x170e

	)

2070 
	#PCI_DEVICE_ID_TIGON3_5906
 0x1712

	)

2071 
	#PCI_DEVICE_ID_TIGON3_5906M
 0x1713

	)

2072 
	#PCI_DEVICE_ID_BCM4401
 0x4401

	)

2073 
	#PCI_DEVICE_ID_BCM4401B0
 0x4402

	)

2075 
	#PCI_VENDOR_ID_TOPIC
 0x151f

	)

2076 
	#PCI_DEVICE_ID_TOPIC_TP560
 0x0000

	)

2078 
	#PCI_VENDOR_ID_MAINPINE
 0x1522

	)

2079 
	#PCI_DEVICE_ID_MAINPINE_PBRIDGE
 0x0100

	)

2080 
	#PCI_VENDOR_ID_ENE
 0x1524

	)

2081 
	#PCI_DEVICE_ID_ENE_CB712_SD
 0x0550

	)

2082 
	#PCI_DEVICE_ID_ENE_CB712_SD_2
 0x0551

	)

2083 
	#PCI_DEVICE_ID_ENE_CB714_SD
 0x0750

	)

2084 
	#PCI_DEVICE_ID_ENE_CB714_SD_2
 0x0751

	)

2085 
	#PCI_DEVICE_ID_ENE_1211
 0x1211

	)

2086 
	#PCI_DEVICE_ID_ENE_1225
 0x1225

	)

2087 
	#PCI_DEVICE_ID_ENE_1410
 0x1410

	)

2088 
	#PCI_DEVICE_ID_ENE_710
 0x1411

	)

2089 
	#PCI_DEVICE_ID_ENE_712
 0x1412

	)

2090 
	#PCI_DEVICE_ID_ENE_1420
 0x1420

	)

2091 
	#PCI_DEVICE_ID_ENE_720
 0x1421

	)

2092 
	#PCI_DEVICE_ID_ENE_722
 0x1422

	)

2094 
	#PCI_SUBVENDOR_ID_PERLE
 0x155f

	)

2095 
	#PCI_SUBDEVICE_ID_PCI_RAS4
 0xf001

	)

2096 
	#PCI_SUBDEVICE_ID_PCI_RAS8
 0xf010

	)

2098 
	#PCI_VENDOR_ID_SYBA
 0x1592

	)

2099 
	#PCI_DEVICE_ID_SYBA_2P_EPP
 0x0782

	)

2100 
	#PCI_DEVICE_ID_SYBA_1P_ECP
 0x0783

	)

2102 
	#PCI_VENDOR_ID_MORETON
 0x15Ø

	)

2103 
	#PCI_DEVICE_ID_RASTEL_2PORT
 0x2000

	)

2105 
	#PCI_VENDOR_ID_ZOLTRIX
 0x15b0

	)

2106 
	#PCI_DEVICE_ID_ZOLTRIX_2BD0
 0x2bd0

	)

2108 
	#PCI_VENDOR_ID_MELLANOX
 0x15b3

	)

2109 
	#PCI_DEVICE_ID_MELLANOX_TAVOR
 0x5a44

	)

2110 
	#PCI_DEVICE_ID_MELLANOX_TAVOR_BRIDGE
 0x5a46

	)

2111 
	#PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT
 0x6278

	)

2112 
	#PCI_DEVICE_ID_MELLANOX_ARBEL
 0x6282

	)

2113 
	#PCI_DEVICE_ID_MELLANOX_SINAI_OLD
 0x5e8c

	)

2114 
	#PCI_DEVICE_ID_MELLANOX_SINAI
 0x6274

	)

2116 
	#PCI_VENDOR_ID_QUICKNET
 0x15e2

	)

2117 
	#PCI_DEVICE_ID_QUICKNET_XJ
 0x0500

	)

2122 
	#PCI_VENDOR_ID_ADDIDATA_OLD
 0x10E8

	)

2123 
	#PCI_VENDOR_ID_ADDIDATA
 0x15B8

	)

2124 
	#PCI_DEVICE_ID_ADDIDATA_APCI7500
 0x7000

	)

2125 
	#PCI_DEVICE_ID_ADDIDATA_APCI7420
 0x7001

	)

2126 
	#PCI_DEVICE_ID_ADDIDATA_APCI7300
 0x7002

	)

2127 
	#PCI_DEVICE_ID_ADDIDATA_APCI7800
 0x818E

	)

2128 
	#PCI_DEVICE_ID_ADDIDATA_APCI7500_2
 0x7009

	)

2129 
	#PCI_DEVICE_ID_ADDIDATA_APCI7420_2
 0x700A

	)

2130 
	#PCI_DEVICE_ID_ADDIDATA_APCI7300_2
 0x700B

	)

2131 
	#PCI_DEVICE_ID_ADDIDATA_APCI7500_3
 0x700C

	)

2132 
	#PCI_DEVICE_ID_ADDIDATA_APCI7420_3
 0x700D

	)

2133 
	#PCI_DEVICE_ID_ADDIDATA_APCI7300_3
 0x700E

	)

2134 
	#PCI_DEVICE_ID_ADDIDATA_APCI7800_3
 0x700F

	)

2136 
	#PCI_VENDOR_ID_PDC
 0x15e9

	)

2138 
	#PCI_VENDOR_ID_FARSITE
 0x1619

	)

2139 
	#PCI_DEVICE_ID_FARSITE_T2P
 0x0400

	)

2140 
	#PCI_DEVICE_ID_FARSITE_T4P
 0x0440

	)

2141 
	#PCI_DEVICE_ID_FARSITE_T1U
 0x0610

	)

2142 
	#PCI_DEVICE_ID_FARSITE_T2U
 0x0620

	)

2143 
	#PCI_DEVICE_ID_FARSITE_T4U
 0x0640

	)

2144 
	#PCI_DEVICE_ID_FARSITE_TE1
 0x1610

	)

2145 
	#PCI_DEVICE_ID_FARSITE_TE1C
 0x1612

	)

2147 
	#PCI_VENDOR_ID_ARIMA
 0x161f

	)

2149 
	#PCI_VENDOR_ID_BROCADE
 0x1657

	)

2151 
	#PCI_VENDOR_ID_SIBYTE
 0x166d

	)

2152 
	#PCI_DEVICE_ID_BCM1250_PCI
 0x0001

	)

2153 
	#PCI_DEVICE_ID_BCM1250_HT
 0x0002

	)

2155 
	#PCI_VENDOR_ID_ATHEROS
 0x168c

	)

2157 
	#PCI_VENDOR_ID_NETCELL
 0x169c

	)

2158 
	#PCI_DEVICE_ID_REVOLUTION
 0x0044

	)

2160 
	#PCI_VENDOR_ID_CENATEK
 0x16CA

	)

2161 
	#PCI_DEVICE_ID_CENATEK_IDE
 0x0001

	)

2163 
	#PCI_VENDOR_ID_VITESSE
 0x1725

	)

2164 
	#PCI_DEVICE_ID_VITESSE_VSC7174
 0x7174

	)

2166 
	#PCI_VENDOR_ID_LINKSYS
 0x1737

	)

2167 
	#PCI_DEVICE_ID_LINKSYS_EG1064
 0x1064

	)

2169 
	#PCI_VENDOR_ID_ALTIMA
 0x173b

	)

2170 
	#PCI_DEVICE_ID_ALTIMA_AC1000
 0x03e8

	)

2171 
	#PCI_DEVICE_ID_ALTIMA_AC1001
 0x03e9

	)

2172 
	#PCI_DEVICE_ID_ALTIMA_AC9100
 0x03ó

	)

2173 
	#PCI_DEVICE_ID_ALTIMA_AC1003
 0x03eb

	)

2175 
	#PCI_VENDOR_ID_BELKIN
 0x1799

	)

2176 
	#PCI_DEVICE_ID_BELKIN_F5D7010V7
 0x701f

	)

2178 
	#PCI_VENDOR_ID_RDC
 0x17f3

	)

2179 
	#PCI_DEVICE_ID_RDC_R6020
 0x6020

	)

2180 
	#PCI_DEVICE_ID_RDC_R6030
 0x6030

	)

2181 
	#PCI_DEVICE_ID_RDC_R6040
 0x6040

	)

2182 
	#PCI_DEVICE_ID_RDC_R6060
 0x6060

	)

2183 
	#PCI_DEVICE_ID_RDC_R6061
 0x6061

	)

2185 
	#PCI_VENDOR_ID_LENOVO
 0x17Ø

	)

2187 
	#PCI_VENDOR_ID_ARECA
 0x17d3

	)

2188 
	#PCI_DEVICE_ID_ARECA_1110
 0x1110

	)

2189 
	#PCI_DEVICE_ID_ARECA_1120
 0x1120

	)

2190 
	#PCI_DEVICE_ID_ARECA_1130
 0x1130

	)

2191 
	#PCI_DEVICE_ID_ARECA_1160
 0x1160

	)

2192 
	#PCI_DEVICE_ID_ARECA_1170
 0x1170

	)

2193 
	#PCI_DEVICE_ID_ARECA_1200
 0x1200

	)

2194 
	#PCI_DEVICE_ID_ARECA_1201
 0x1201

	)

2195 
	#PCI_DEVICE_ID_ARECA_1202
 0x1202

	)

2196 
	#PCI_DEVICE_ID_ARECA_1210
 0x1210

	)

2197 
	#PCI_DEVICE_ID_ARECA_1220
 0x1220

	)

2198 
	#PCI_DEVICE_ID_ARECA_1230
 0x1230

	)

2199 
	#PCI_DEVICE_ID_ARECA_1260
 0x1260

	)

2200 
	#PCI_DEVICE_ID_ARECA_1270
 0x1270

	)

2201 
	#PCI_DEVICE_ID_ARECA_1280
 0x1280

	)

2202 
	#PCI_DEVICE_ID_ARECA_1380
 0x1380

	)

2203 
	#PCI_DEVICE_ID_ARECA_1381
 0x1381

	)

2204 
	#PCI_DEVICE_ID_ARECA_1680
 0x1680

	)

2205 
	#PCI_DEVICE_ID_ARECA_1681
 0x1681

	)

2207 
	#PCI_VENDOR_ID_S2IO
 0x17d5

	)

2208 
	#PCI_DEVICE_ID_S2IO_WIN
 0x5731

	)

2209 
	#PCI_DEVICE_ID_S2IO_UNI
 0x5831

	)

2210 
	#PCI_DEVICE_ID_HERC_WIN
 0x5732

	)

2211 
	#PCI_DEVICE_ID_HERC_UNI
 0x5832

	)

2213 
	#PCI_VENDOR_ID_SITECOM
 0x182d

	)

2214 
	#PCI_DEVICE_ID_SITECOM_DC105V2
 0x3069

	)

2216 
	#PCI_VENDOR_ID_TOPSPIN
 0x1867

	)

2218 
	#PCI_VENDOR_ID_TDI
 0x192E

	)

2219 
	#PCI_DEVICE_ID_TDI_EHCI
 0x0101

	)

2221 
	#PCI_VENDOR_ID_FREESCALE
 0x1957

	)

2222 
	#PCI_DEVICE_ID_MPC8548E
 0x0012

	)

2223 
	#PCI_DEVICE_ID_MPC8548
 0x0013

	)

2224 
	#PCI_DEVICE_ID_MPC8543E
 0x0014

	)

2225 
	#PCI_DEVICE_ID_MPC8543
 0x0015

	)

2226 
	#PCI_DEVICE_ID_MPC8547E
 0x0018

	)

2227 
	#PCI_DEVICE_ID_MPC8545E
 0x0019

	)

2228 
	#PCI_DEVICE_ID_MPC8545
 0x001a

	)

2229 
	#PCI_DEVICE_ID_MPC8568E
 0x0020

	)

2230 
	#PCI_DEVICE_ID_MPC8568
 0x0021

	)

2231 
	#PCI_DEVICE_ID_MPC8567E
 0x0022

	)

2232 
	#PCI_DEVICE_ID_MPC8567
 0x0023

	)

2233 
	#PCI_DEVICE_ID_MPC8533E
 0x0030

	)

2234 
	#PCI_DEVICE_ID_MPC8533
 0x0031

	)

2235 
	#PCI_DEVICE_ID_MPC8544E
 0x0032

	)

2236 
	#PCI_DEVICE_ID_MPC8544
 0x0033

	)

2237 
	#PCI_DEVICE_ID_MPC8572E
 0x0040

	)

2238 
	#PCI_DEVICE_ID_MPC8572
 0x0041

	)

2239 
	#PCI_DEVICE_ID_MPC8536E
 0x0050

	)

2240 
	#PCI_DEVICE_ID_MPC8536
 0x0051

	)

2241 
	#PCI_DEVICE_ID_MPC8641
 0x7010

	)

2242 
	#PCI_DEVICE_ID_MPC8641D
 0x7011

	)

2243 
	#PCI_DEVICE_ID_MPC8610
 0x7018

	)

2245 
	#PCI_VENDOR_ID_PASEMI
 0x1959

	)

2247 
	#PCI_VENDOR_ID_ATTANSIC
 0x1969

	)

2248 
	#PCI_DEVICE_ID_ATTANSIC_L1
 0x1048

	)

2249 
	#PCI_DEVICE_ID_ATTANSIC_L2
 0x2048

	)

2251 
	#PCI_VENDOR_ID_JMICRON
 0x197B

	)

2252 
	#PCI_DEVICE_ID_JMICRON_JMB360
 0x2360

	)

2253 
	#PCI_DEVICE_ID_JMICRON_JMB361
 0x2361

	)

2254 
	#PCI_DEVICE_ID_JMICRON_JMB363
 0x2363

	)

2255 
	#PCI_DEVICE_ID_JMICRON_JMB365
 0x2365

	)

2256 
	#PCI_DEVICE_ID_JMICRON_JMB366
 0x2366

	)

2257 
	#PCI_DEVICE_ID_JMICRON_JMB368
 0x2368

	)

2258 
	#PCI_DEVICE_ID_JMICRON_JMB38X_SD
 0x2381

	)

2259 
	#PCI_DEVICE_ID_JMICRON_JMB38X_MMC
 0x2382

	)

2260 
	#PCI_DEVICE_ID_JMICRON_JMB38X_MS
 0x2383

	)

2262 
	#PCI_VENDOR_ID_KORENIX
 0x1982

	)

2263 
	#PCI_DEVICE_ID_KORENIX_JETCARDF0
 0x1600

	)

2264 
	#PCI_DEVICE_ID_KORENIX_JETCARDF1
 0x16ff

	)

2266 
	#PCI_VENDOR_ID_TEKRAM
 0x1de1

	)

2267 
	#PCI_DEVICE_ID_TEKRAM_DC290
 0xdc29

	)

2269 
	#PCI_VENDOR_ID_TEHUTI
 0x1fc9

	)

2270 
	#PCI_DEVICE_ID_TEHUTI_3009
 0x3009

	)

2271 
	#PCI_DEVICE_ID_TEHUTI_3010
 0x3010

	)

2272 
	#PCI_DEVICE_ID_TEHUTI_3014
 0x3014

	)

2274 
	#PCI_VENDOR_ID_HINT
 0x3388

	)

2275 
	#PCI_DEVICE_ID_HINT_VXPROII_IDE
 0x8013

	)

2277 
	#PCI_VENDOR_ID_3DLABS
 0x3d3d

	)

2278 
	#PCI_DEVICE_ID_3DLABS_PERMEDIA2
 0x0007

	)

2279 
	#PCI_DEVICE_ID_3DLABS_PERMEDIA2V
 0x0009

	)

2281 
	#PCI_VENDOR_ID_NETXEN
 0x4040

	)

2282 
	#PCI_DEVICE_ID_NX2031_10GXSR
 0x0001

	)

2283 
	#PCI_DEVICE_ID_NX2031_10GCX4
 0x0002

	)

2284 
	#PCI_DEVICE_ID_NX2031_4GCU
 0x0003

	)

2285 
	#PCI_DEVICE_ID_NX2031_IMEZ
 0x0004

	)

2286 
	#PCI_DEVICE_ID_NX2031_HMEZ
 0x0005

	)

2287 
	#PCI_DEVICE_ID_NX2031_XG_MGMT
 0x0024

	)

2288 
	#PCI_DEVICE_ID_NX2031_XG_MGMT2
 0x0025

	)

2289 
	#PCI_DEVICE_ID_NX3031
 0x0100

	)

2291 
	#PCI_VENDOR_ID_AKS
 0x416c

	)

2292 
	#PCI_DEVICE_ID_AKS_ALADDINCARD
 0x0100

	)

2294 
	#PCI_VENDOR_ID_S3
 0x5333

	)

2295 
	#PCI_DEVICE_ID_S3_TRIO
 0x8811

	)

2296 
	#PCI_DEVICE_ID_S3_868
 0x8880

	)

2297 
	#PCI_DEVICE_ID_S3_968
 0x88f0

	)

2298 
	#PCI_DEVICE_ID_S3_SAVAGE4
 0x8a25

	)

2299 
	#PCI_DEVICE_ID_S3_PROSAVAGE8
 0x8d04

	)

2300 
	#PCI_DEVICE_ID_S3_SONICVIBES
 0xˇ00

	)

2302 
	#PCI_VENDOR_ID_DUNORD
 0x5544

	)

2303 
	#PCI_DEVICE_ID_DUNORD_I3000
 0x0001

	)

2305 
	#PCI_VENDOR_ID_DCI
 0x6666

	)

2306 
	#PCI_DEVICE_ID_DCI_PCCOM4
 0x0001

	)

2307 
	#PCI_DEVICE_ID_DCI_PCCOM8
 0x0002

	)

2308 
	#PCI_DEVICE_ID_DCI_PCCOM2
 0x0004

	)

2310 
	#PCI_VENDOR_ID_INTEL
 0x8086

	)

2311 
	#PCI_DEVICE_ID_INTEL_EESSC
 0x0008

	)

2312 
	#PCI_DEVICE_ID_INTEL_PXHD_0
 0x0320

	)

2313 
	#PCI_DEVICE_ID_INTEL_PXHD_1
 0x0321

	)

2314 
	#PCI_DEVICE_ID_INTEL_PXH_0
 0x0329

	)

2315 
	#PCI_DEVICE_ID_INTEL_PXH_1
 0x032A

	)

2316 
	#PCI_DEVICE_ID_INTEL_PXHV
 0x032C

	)

2317 
	#PCI_DEVICE_ID_INTEL_82375
 0x0482

	)

2318 
	#PCI_DEVICE_ID_INTEL_82424
 0x0483

	)

2319 
	#PCI_DEVICE_ID_INTEL_82378
 0x0484

	)

2320 
	#PCI_DEVICE_ID_INTEL_I960
 0x0960

	)

2321 
	#PCI_DEVICE_ID_INTEL_I960RM
 0x0962

	)

2322 
	#PCI_DEVICE_ID_INTEL_82815_MC
 0x1130

	)

2323 
	#PCI_DEVICE_ID_INTEL_82815_CGC
 0x1132

	)

2324 
	#PCI_DEVICE_ID_INTEL_82092AA_0
 0x1221

	)

2325 
	#PCI_DEVICE_ID_INTEL_7505_0
 0x2550

	)

2326 
	#PCI_DEVICE_ID_INTEL_7205_0
 0x255d

	)

2327 
	#PCI_DEVICE_ID_INTEL_82437
 0x122d

	)

2328 
	#PCI_DEVICE_ID_INTEL_82371FB_0
 0x122e

	)

2329 
	#PCI_DEVICE_ID_INTEL_82371FB_1
 0x1230

	)

2330 
	#PCI_DEVICE_ID_INTEL_82371MX
 0x1234

	)

2331 
	#PCI_DEVICE_ID_INTEL_82441
 0x1237

	)

2332 
	#PCI_DEVICE_ID_INTEL_82380FB
 0x124b

	)

2333 
	#PCI_DEVICE_ID_INTEL_82439
 0x1250

	)

2334 
	#PCI_DEVICE_ID_INTEL_80960_RP
 0x1960

	)

2335 
	#PCI_DEVICE_ID_INTEL_82840_HB
 0x1a21

	)

2336 
	#PCI_DEVICE_ID_INTEL_82845_HB
 0x1a30

	)

2337 
	#PCI_DEVICE_ID_INTEL_IOAT
 0x1a38

	)

2338 
	#PCI_DEVICE_ID_INTEL_82801AA_0
 0x2410

	)

2339 
	#PCI_DEVICE_ID_INTEL_82801AA_1
 0x2411

	)

2340 
	#PCI_DEVICE_ID_INTEL_82801AA_3
 0x2413

	)

2341 
	#PCI_DEVICE_ID_INTEL_82801AA_5
 0x2415

	)

2342 
	#PCI_DEVICE_ID_INTEL_82801AA_6
 0x2416

	)

2343 
	#PCI_DEVICE_ID_INTEL_82801AA_8
 0x2418

	)

2344 
	#PCI_DEVICE_ID_INTEL_82801AB_0
 0x2420

	)

2345 
	#PCI_DEVICE_ID_INTEL_82801AB_1
 0x2421

	)

2346 
	#PCI_DEVICE_ID_INTEL_82801AB_3
 0x2423

	)

2347 
	#PCI_DEVICE_ID_INTEL_82801AB_5
 0x2425

	)

2348 
	#PCI_DEVICE_ID_INTEL_82801AB_6
 0x2426

	)

2349 
	#PCI_DEVICE_ID_INTEL_82801AB_8
 0x2428

	)

2350 
	#PCI_DEVICE_ID_INTEL_82801BA_0
 0x2440

	)

2351 
	#PCI_DEVICE_ID_INTEL_82801BA_2
 0x2443

	)

2352 
	#PCI_DEVICE_ID_INTEL_82801BA_4
 0x2445

	)

2353 
	#PCI_DEVICE_ID_INTEL_82801BA_6
 0x2448

	)

2354 
	#PCI_DEVICE_ID_INTEL_82801BA_8
 0x244a

	)

2355 
	#PCI_DEVICE_ID_INTEL_82801BA_9
 0x244b

	)

2356 
	#PCI_DEVICE_ID_INTEL_82801BA_10
 0x244c

	)

2357 
	#PCI_DEVICE_ID_INTEL_82801BA_11
 0x244e

	)

2358 
	#PCI_DEVICE_ID_INTEL_82801E_0
 0x2450

	)

2359 
	#PCI_DEVICE_ID_INTEL_82801E_11
 0x245b

	)

2360 
	#PCI_DEVICE_ID_INTEL_82801CA_0
 0x2480

	)

2361 
	#PCI_DEVICE_ID_INTEL_82801CA_3
 0x2483

	)

2362 
	#PCI_DEVICE_ID_INTEL_82801CA_5
 0x2485

	)

2363 
	#PCI_DEVICE_ID_INTEL_82801CA_6
 0x2486

	)

2364 
	#PCI_DEVICE_ID_INTEL_82801CA_10
 0x248a

	)

2365 
	#PCI_DEVICE_ID_INTEL_82801CA_11
 0x248b

	)

2366 
	#PCI_DEVICE_ID_INTEL_82801CA_12
 0x248c

	)

2367 
	#PCI_DEVICE_ID_INTEL_82801DB_0
 0x24c0

	)

2368 
	#PCI_DEVICE_ID_INTEL_82801DB_1
 0x24c1

	)

2369 
	#PCI_DEVICE_ID_INTEL_82801DB_3
 0x24c3

	)

2370 
	#PCI_DEVICE_ID_INTEL_82801DB_5
 0x24c5

	)

2371 
	#PCI_DEVICE_ID_INTEL_82801DB_6
 0x24c6

	)

2372 
	#PCI_DEVICE_ID_INTEL_82801DB_9
 0x24c9

	)

2373 
	#PCI_DEVICE_ID_INTEL_82801DB_10
 0x24ˇ

	)

2374 
	#PCI_DEVICE_ID_INTEL_82801DB_11
 0x24cb

	)

2375 
	#PCI_DEVICE_ID_INTEL_82801DB_12
 0x24cc

	)

2376 
	#PCI_DEVICE_ID_INTEL_82801EB_0
 0x24d0

	)

2377 
	#PCI_DEVICE_ID_INTEL_82801EB_1
 0x24d1

	)

2378 
	#PCI_DEVICE_ID_INTEL_82801EB_3
 0x24d3

	)

2379 
	#PCI_DEVICE_ID_INTEL_82801EB_5
 0x24d5

	)

2380 
	#PCI_DEVICE_ID_INTEL_82801EB_6
 0x24d6

	)

2381 
	#PCI_DEVICE_ID_INTEL_82801EB_11
 0x24db

	)

2382 
	#PCI_DEVICE_ID_INTEL_82801EB_12
 0x24dc

	)

2383 
	#PCI_DEVICE_ID_INTEL_82801EB_13
 0x24dd

	)

2384 
	#PCI_DEVICE_ID_INTEL_ESB_1
 0x25a1

	)

2385 
	#PCI_DEVICE_ID_INTEL_ESB_2
 0x25a2

	)

2386 
	#PCI_DEVICE_ID_INTEL_ESB_4
 0x25a4

	)

2387 
	#PCI_DEVICE_ID_INTEL_ESB_5
 0x25a6

	)

2388 
	#PCI_DEVICE_ID_INTEL_ESB_9
 0x25ab

	)

2389 
	#PCI_DEVICE_ID_INTEL_82820_HB
 0x2500

	)

2390 
	#PCI_DEVICE_ID_INTEL_82820_UP_HB
 0x2501

	)

2391 
	#PCI_DEVICE_ID_INTEL_82850_HB
 0x2530

	)

2392 
	#PCI_DEVICE_ID_INTEL_82860_HB
 0x2531

	)

2393 
	#PCI_DEVICE_ID_INTEL_E7501_MCH
 0x254c

	)

2394 
	#PCI_DEVICE_ID_INTEL_82845G_HB
 0x2560

	)

2395 
	#PCI_DEVICE_ID_INTEL_82845G_IG
 0x2562

	)

2396 
	#PCI_DEVICE_ID_INTEL_82865_HB
 0x2570

	)

2397 
	#PCI_DEVICE_ID_INTEL_82865_IG
 0x2572

	)

2398 
	#PCI_DEVICE_ID_INTEL_82875_HB
 0x2578

	)

2399 
	#PCI_DEVICE_ID_INTEL_82915G_HB
 0x2580

	)

2400 
	#PCI_DEVICE_ID_INTEL_82915G_IG
 0x2582

	)

2401 
	#PCI_DEVICE_ID_INTEL_82915GM_HB
 0x2590

	)

2402 
	#PCI_DEVICE_ID_INTEL_82915GM_IG
 0x2592

	)

2403 
	#PCI_DEVICE_ID_INTEL_5000_ERR
 0x25F0

	)

2404 
	#PCI_DEVICE_ID_INTEL_5000_FBD0
 0x25F5

	)

2405 
	#PCI_DEVICE_ID_INTEL_5000_FBD1
 0x25F6

	)

2406 
	#PCI_DEVICE_ID_INTEL_82945G_HB
 0x2770

	)

2407 
	#PCI_DEVICE_ID_INTEL_82945G_IG
 0x2772

	)

2408 
	#PCI_DEVICE_ID_INTEL_3000_HB
 0x2778

	)

2409 
	#PCI_DEVICE_ID_INTEL_82945GM_HB
 0x27A0

	)

2410 
	#PCI_DEVICE_ID_INTEL_82945GM_IG
 0x27A2

	)

2411 
	#PCI_DEVICE_ID_INTEL_ICH6_0
 0x2640

	)

2412 
	#PCI_DEVICE_ID_INTEL_ICH6_1
 0x2641

	)

2413 
	#PCI_DEVICE_ID_INTEL_ICH6_2
 0x2642

	)

2414 
	#PCI_DEVICE_ID_INTEL_ICH6_16
 0x266a

	)

2415 
	#PCI_DEVICE_ID_INTEL_ICH6_17
 0x266d

	)

2416 
	#PCI_DEVICE_ID_INTEL_ICH6_18
 0x266e

	)

2417 
	#PCI_DEVICE_ID_INTEL_ICH6_19
 0x266f

	)

2418 
	#PCI_DEVICE_ID_INTEL_ESB2_0
 0x2670

	)

2419 
	#PCI_DEVICE_ID_INTEL_ESB2_14
 0x2698

	)

2420 
	#PCI_DEVICE_ID_INTEL_ESB2_17
 0x269b

	)

2421 
	#PCI_DEVICE_ID_INTEL_ESB2_18
 0x269e

	)

2422 
	#PCI_DEVICE_ID_INTEL_ICH7_0
 0x27b8

	)

2423 
	#PCI_DEVICE_ID_INTEL_ICH7_1
 0x27b9

	)

2424 
	#PCI_DEVICE_ID_INTEL_ICH7_30
 0x27b0

	)

2425 
	#PCI_DEVICE_ID_INTEL_ICH7_31
 0x27bd

	)

2426 
	#PCI_DEVICE_ID_INTEL_ICH7_17
 0x27da

	)

2427 
	#PCI_DEVICE_ID_INTEL_ICH7_19
 0x27dd

	)

2428 
	#PCI_DEVICE_ID_INTEL_ICH7_20
 0x27de

	)

2429 
	#PCI_DEVICE_ID_INTEL_ICH7_21
 0x27df

	)

2430 
	#PCI_DEVICE_ID_INTEL_ICH8_0
 0x2810

	)

2431 
	#PCI_DEVICE_ID_INTEL_ICH8_1
 0x2811

	)

2432 
	#PCI_DEVICE_ID_INTEL_ICH8_2
 0x2812

	)

2433 
	#PCI_DEVICE_ID_INTEL_ICH8_3
 0x2814

	)

2434 
	#PCI_DEVICE_ID_INTEL_ICH8_4
 0x2815

	)

2435 
	#PCI_DEVICE_ID_INTEL_ICH8_5
 0x283e

	)

2436 
	#PCI_DEVICE_ID_INTEL_ICH8_6
 0x2850

	)

2437 
	#PCI_DEVICE_ID_INTEL_ICH9_0
 0x2910

	)

2438 
	#PCI_DEVICE_ID_INTEL_ICH9_1
 0x2917

	)

2439 
	#PCI_DEVICE_ID_INTEL_ICH9_2
 0x2912

	)

2440 
	#PCI_DEVICE_ID_INTEL_ICH9_3
 0x2913

	)

2441 
	#PCI_DEVICE_ID_INTEL_ICH9_4
 0x2914

	)

2442 
	#PCI_DEVICE_ID_INTEL_ICH9_5
 0x2919

	)

2443 
	#PCI_DEVICE_ID_INTEL_ICH9_6
 0x2930

	)

2444 
	#PCI_DEVICE_ID_INTEL_ICH9_7
 0x2916

	)

2445 
	#PCI_DEVICE_ID_INTEL_ICH9_8
 0x2918

	)

2446 
	#PCI_DEVICE_ID_INTEL_82855PM_HB
 0x3340

	)

2447 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG4
 0x3429

	)

2448 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG5
 0x342a

	)

2449 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG6
 0x342b

	)

2450 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG7
 0x342c

	)

2451 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG0
 0x3430

	)

2452 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG1
 0x3431

	)

2453 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG2
 0x3432

	)

2454 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG3
 0x3433

	)

2455 
	#PCI_DEVICE_ID_INTEL_82830_HB
 0x3575

	)

2456 
	#PCI_DEVICE_ID_INTEL_82830_CGC
 0x3577

	)

2457 
	#PCI_DEVICE_ID_INTEL_82855GM_HB
 0x3580

	)

2458 
	#PCI_DEVICE_ID_INTEL_82855GM_IG
 0x3582

	)

2459 
	#PCI_DEVICE_ID_INTEL_E7520_MCH
 0x3590

	)

2460 
	#PCI_DEVICE_ID_INTEL_E7320_MCH
 0x3592

	)

2461 
	#PCI_DEVICE_ID_INTEL_MCH_PA
 0x3595

	)

2462 
	#PCI_DEVICE_ID_INTEL_MCH_PA1
 0x3596

	)

2463 
	#PCI_DEVICE_ID_INTEL_MCH_PB
 0x3597

	)

2464 
	#PCI_DEVICE_ID_INTEL_MCH_PB1
 0x3598

	)

2465 
	#PCI_DEVICE_ID_INTEL_MCH_PC
 0x3599

	)

2466 
	#PCI_DEVICE_ID_INTEL_MCH_PC1
 0x359a

	)

2467 
	#PCI_DEVICE_ID_INTEL_E7525_MCH
 0x359e

	)

2468 
	#PCI_DEVICE_ID_INTEL_IOAT_CNB
 0x360b

	)

2469 
	#PCI_DEVICE_ID_INTEL_FBD_CNB
 0x360c

	)

2470 
	#PCI_DEVICE_ID_INTEL_ICH10_0
 0x3a14

	)

2471 
	#PCI_DEVICE_ID_INTEL_ICH10_1
 0x3a16

	)

2472 
	#PCI_DEVICE_ID_INTEL_ICH10_2
 0x3a18

	)

2473 
	#PCI_DEVICE_ID_INTEL_ICH10_3
 0x3a1a

	)

2474 
	#PCI_DEVICE_ID_INTEL_ICH10_4
 0x3a30

	)

2475 
	#PCI_DEVICE_ID_INTEL_ICH10_5
 0x3a60

	)

2476 
	#PCI_DEVICE_ID_INTEL_PCH_LPC_MIN
 0x3b00

	)

2477 
	#PCI_DEVICE_ID_INTEL_PCH_LPC_MAX
 0x3b1f

	)

2478 
	#PCI_DEVICE_ID_INTEL_PCH_SMBUS
 0x3b30

	)

2479 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB
 0x402f

	)

2480 
	#PCI_DEVICE_ID_INTEL_5100_16
 0x65f0

	)

2481 
	#PCI_DEVICE_ID_INTEL_5100_21
 0x65f5

	)

2482 
	#PCI_DEVICE_ID_INTEL_5100_22
 0x65f6

	)

2483 
	#PCI_DEVICE_ID_INTEL_5400_ERR
 0x4030

	)

2484 
	#PCI_DEVICE_ID_INTEL_5400_FBD0
 0x4035

	)

2485 
	#PCI_DEVICE_ID_INTEL_5400_FBD1
 0x4036

	)

2486 
	#PCI_DEVICE_ID_INTEL_IOAT_SCNB
 0x65ff

	)

2487 
	#PCI_DEVICE_ID_INTEL_TOLAPAI_0
 0x5031

	)

2488 
	#PCI_DEVICE_ID_INTEL_TOLAPAI_1
 0x5032

	)

2489 
	#PCI_DEVICE_ID_INTEL_82371SB_0
 0x7000

	)

2490 
	#PCI_DEVICE_ID_INTEL_82371SB_1
 0x7010

	)

2491 
	#PCI_DEVICE_ID_INTEL_82371SB_2
 0x7020

	)

2492 
	#PCI_DEVICE_ID_INTEL_82437VX
 0x7030

	)

2493 
	#PCI_DEVICE_ID_INTEL_82439TX
 0x7100

	)

2494 
	#PCI_DEVICE_ID_INTEL_82371AB_0
 0x7110

	)

2495 
	#PCI_DEVICE_ID_INTEL_82371AB
 0x7111

	)

2496 
	#PCI_DEVICE_ID_INTEL_82371AB_2
 0x7112

	)

2497 
	#PCI_DEVICE_ID_INTEL_82371AB_3
 0x7113

	)

2498 
	#PCI_DEVICE_ID_INTEL_82810_MC1
 0x7120

	)

2499 
	#PCI_DEVICE_ID_INTEL_82810_IG1
 0x7121

	)

2500 
	#PCI_DEVICE_ID_INTEL_82810_MC3
 0x7122

	)

2501 
	#PCI_DEVICE_ID_INTEL_82810_IG3
 0x7123

	)

2502 
	#PCI_DEVICE_ID_INTEL_82810E_MC
 0x7124

	)

2503 
	#PCI_DEVICE_ID_INTEL_82810E_IG
 0x7125

	)

2504 
	#PCI_DEVICE_ID_INTEL_82443LX_0
 0x7180

	)

2505 
	#PCI_DEVICE_ID_INTEL_82443LX_1
 0x7181

	)

2506 
	#PCI_DEVICE_ID_INTEL_82443BX_0
 0x7190

	)

2507 
	#PCI_DEVICE_ID_INTEL_82443BX_1
 0x7191

	)

2508 
	#PCI_DEVICE_ID_INTEL_82443BX_2
 0x7192

	)

2509 
	#PCI_DEVICE_ID_INTEL_440MX
 0x7195

	)

2510 
	#PCI_DEVICE_ID_INTEL_440MX_6
 0x7196

	)

2511 
	#PCI_DEVICE_ID_INTEL_82443MX_0
 0x7198

	)

2512 
	#PCI_DEVICE_ID_INTEL_82443MX_1
 0x7199

	)

2513 
	#PCI_DEVICE_ID_INTEL_82443MX_3
 0x719b

	)

2514 
	#PCI_DEVICE_ID_INTEL_82443GX_0
 0x71a0

	)

2515 
	#PCI_DEVICE_ID_INTEL_82443GX_2
 0x71a2

	)

2516 
	#PCI_DEVICE_ID_INTEL_82372FB_1
 0x7601

	)

2517 
	#PCI_DEVICE_ID_INTEL_SCH_LPC
 0x8119

	)

2518 
	#PCI_DEVICE_ID_INTEL_SCH_IDE
 0x811a

	)

2519 
	#PCI_DEVICE_ID_INTEL_82454GX
 0x84c4

	)

2520 
	#PCI_DEVICE_ID_INTEL_82450GX
 0x84c5

	)

2521 
	#PCI_DEVICE_ID_INTEL_82451NX
 0x84ˇ

	)

2522 
	#PCI_DEVICE_ID_INTEL_82454NX
 0x84cb

	)

2523 
	#PCI_DEVICE_ID_INTEL_84460GX
 0x84ó

	)

2524 
	#PCI_DEVICE_ID_INTEL_IXP4XX
 0x8500

	)

2525 
	#PCI_DEVICE_ID_INTEL_IXP2800
 0x9004

	)

2526 
	#PCI_DEVICE_ID_INTEL_S21152BB
 0xb152

	)

2528 
	#PCI_VENDOR_ID_SCALEMP
 0x8686

	)

2529 
	#PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 0x1010

	)

2531 
	#PCI_VENDOR_ID_COMPUTONE
 0x8e0e

	)

2532 
	#PCI_DEVICE_ID_COMPUTONE_IP2EX
 0x0291

	)

2533 
	#PCI_DEVICE_ID_COMPUTONE_PG
 0x0302

	)

2534 
	#PCI_SUBVENDOR_ID_COMPUTONE
 0x8e0e

	)

2535 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG4
 0x0001

	)

2536 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG8
 0x0002

	)

2537 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG6
 0x0003

	)

2539 
	#PCI_VENDOR_ID_KTI
 0x8e2e

	)

2541 
	#PCI_VENDOR_ID_ADAPTEC
 0x9004

	)

2542 
	#PCI_DEVICE_ID_ADAPTEC_7810
 0x1078

	)

2543 
	#PCI_DEVICE_ID_ADAPTEC_7821
 0x2178

	)

2544 
	#PCI_DEVICE_ID_ADAPTEC_38602
 0x3860

	)

2545 
	#PCI_DEVICE_ID_ADAPTEC_7850
 0x5078

	)

2546 
	#PCI_DEVICE_ID_ADAPTEC_7855
 0x5578

	)

2547 
	#PCI_DEVICE_ID_ADAPTEC_3860
 0x6038

	)

2548 
	#PCI_DEVICE_ID_ADAPTEC_1480A
 0x6075

	)

2549 
	#PCI_DEVICE_ID_ADAPTEC_7860
 0x6078

	)

2550 
	#PCI_DEVICE_ID_ADAPTEC_7861
 0x6178

	)

2551 
	#PCI_DEVICE_ID_ADAPTEC_7870
 0x7078

	)

2552 
	#PCI_DEVICE_ID_ADAPTEC_7871
 0x7178

	)

2553 
	#PCI_DEVICE_ID_ADAPTEC_7872
 0x7278

	)

2554 
	#PCI_DEVICE_ID_ADAPTEC_7873
 0x7378

	)

2555 
	#PCI_DEVICE_ID_ADAPTEC_7874
 0x7478

	)

2556 
	#PCI_DEVICE_ID_ADAPTEC_7895
 0x7895

	)

2557 
	#PCI_DEVICE_ID_ADAPTEC_7880
 0x8078

	)

2558 
	#PCI_DEVICE_ID_ADAPTEC_7881
 0x8178

	)

2559 
	#PCI_DEVICE_ID_ADAPTEC_7882
 0x8278

	)

2560 
	#PCI_DEVICE_ID_ADAPTEC_7883
 0x8378

	)

2561 
	#PCI_DEVICE_ID_ADAPTEC_7884
 0x8478

	)

2562 
	#PCI_DEVICE_ID_ADAPTEC_7885
 0x8578

	)

2563 
	#PCI_DEVICE_ID_ADAPTEC_7886
 0x8678

	)

2564 
	#PCI_DEVICE_ID_ADAPTEC_7887
 0x8778

	)

2565 
	#PCI_DEVICE_ID_ADAPTEC_7888
 0x8878

	)

2567 
	#PCI_VENDOR_ID_ADAPTEC2
 0x9005

	)

2568 
	#PCI_DEVICE_ID_ADAPTEC2_2940U2
 0x0010

	)

2569 
	#PCI_DEVICE_ID_ADAPTEC2_2930U2
 0x0011

	)

2570 
	#PCI_DEVICE_ID_ADAPTEC2_7890B
 0x0013

	)

2571 
	#PCI_DEVICE_ID_ADAPTEC2_7890
 0x001f

	)

2572 
	#PCI_DEVICE_ID_ADAPTEC2_3940U2
 0x0050

	)

2573 
	#PCI_DEVICE_ID_ADAPTEC2_3950U2D
 0x0051

	)

2574 
	#PCI_DEVICE_ID_ADAPTEC2_7896
 0x005f

	)

2575 
	#PCI_DEVICE_ID_ADAPTEC2_7892A
 0x0080

	)

2576 
	#PCI_DEVICE_ID_ADAPTEC2_7892B
 0x0081

	)

2577 
	#PCI_DEVICE_ID_ADAPTEC2_7892D
 0x0083

	)

2578 
	#PCI_DEVICE_ID_ADAPTEC2_7892P
 0x008f

	)

2579 
	#PCI_DEVICE_ID_ADAPTEC2_7899A
 0x00c0

	)

2580 
	#PCI_DEVICE_ID_ADAPTEC2_7899B
 0x00c1

	)

2581 
	#PCI_DEVICE_ID_ADAPTEC2_7899D
 0x00c3

	)

2582 
	#PCI_DEVICE_ID_ADAPTEC2_7899P
 0x00cf

	)

2583 
	#PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN
 0x0500

	)

2584 
	#PCI_DEVICE_ID_ADAPTEC2_SCAMP
 0x0503

	)

2586 
	#PCI_VENDOR_ID_HOLTEK
 0x9412

	)

2587 
	#PCI_DEVICE_ID_HOLTEK_6565
 0x6565

	)

2589 
	#PCI_VENDOR_ID_NETMOS
 0x9710

	)

2590 
	#PCI_DEVICE_ID_NETMOS_9705
 0x9705

	)

2591 
	#PCI_DEVICE_ID_NETMOS_9715
 0x9715

	)

2592 
	#PCI_DEVICE_ID_NETMOS_9735
 0x9735

	)

2593 
	#PCI_DEVICE_ID_NETMOS_9745
 0x9745

	)

2594 
	#PCI_DEVICE_ID_NETMOS_9755
 0x9755

	)

2595 
	#PCI_DEVICE_ID_NETMOS_9805
 0x9805

	)

2596 
	#PCI_DEVICE_ID_NETMOS_9815
 0x9815

	)

2597 
	#PCI_DEVICE_ID_NETMOS_9835
 0x9835

	)

2598 
	#PCI_DEVICE_ID_NETMOS_9845
 0x9845

	)

2599 
	#PCI_DEVICE_ID_NETMOS_9855
 0x9855

	)

2601 
	#PCI_VENDOR_ID_3COM_2
 0xa727

	)

2603 
	#PCI_VENDOR_ID_DIGIUM
 0xd161

	)

2604 
	#PCI_DEVICE_ID_DIGIUM_HFC4S
 0xb410

	)

2606 
	#PCI_SUBVENDOR_ID_EXSYS
 0xd84d

	)

2607 
	#PCI_SUBDEVICE_ID_EXSYS_4014
 0x4014

	)

2608 
	#PCI_SUBDEVICE_ID_EXSYS_4055
 0x4055

	)

2610 
	#PCI_VENDOR_ID_TIGERJET
 0xe159

	)

2611 
	#PCI_DEVICE_ID_TIGERJET_300
 0x0001

	)

2612 
	#PCI_DEVICE_ID_TIGERJET_100
 0x0002

	)

2614 
	#PCI_VENDOR_ID_XILINX_RME
 0xó60

	)

2615 
	#PCI_DEVICE_ID_RME_DIGI32
 0x9896

	)

2616 
	#PCI_DEVICE_ID_RME_DIGI32_PRO
 0x9897

	)

2617 
	#PCI_DEVICE_ID_RME_DIGI32_8
 0x9898

	)

2619 
	#PCI_VENDOR_ID_REDHAT_QUMRANET
 0x1af4

	)

2620 
	#PCI_DEVICE_ID_VIRTIO_BLK
 0x1001

	)

2621 
	#PCI_DEVICE_ID_VIRTIO_SCSI
 0x1004

	)

2623 
	#PCI_VENDOR_ID_VMWARE
 0x15ad

	)

2624 
	#PCI_DEVICE_ID_VMWARE_PVSCSI
 0x07C0

	)

	@hw/pci_regs.h

22 #i‚de‡
LINUX_PCI_REGS_H


23 
	#LINUX_PCI_REGS_H


	)

29 
	#PCI_VENDOR_ID
 0x00

	)

30 
	#PCI_DEVICE_ID
 0x02

	)

31 
	#PCI_COMMAND
 0x04

	)

32 
	#PCI_COMMAND_IO
 0x1

	)

33 
	#PCI_COMMAND_MEMORY
 0x2

	)

34 
	#PCI_COMMAND_MASTER
 0x4

	)

35 
	#PCI_COMMAND_SPECIAL
 0x8

	)

36 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

37 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

38 
	#PCI_COMMAND_PARITY
 0x40

	)

39 
	#PCI_COMMAND_WAIT
 0x80

	)

40 
	#PCI_COMMAND_SERR
 0x100

	)

41 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

42 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

44 
	#PCI_STATUS
 0x06

	)

45 
	#PCI_STATUS_CAP_LIST
 0x10

	)

46 
	#PCI_STATUS_66MHZ
 0x20

	)

47 
	#PCI_STATUS_UDF
 0x40

	)

48 
	#PCI_STATUS_FAST_BACK
 0x80

	)

49 
	#PCI_STATUS_PARITY
 0x100

	)

50 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

51 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

52 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

53 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

54 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

55 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

56 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

57 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

58 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

60 
	#PCI_CLASS_REVISION
 0x08

	)

61 
	#PCI_REVISION_ID
 0x08

	)

62 
	#PCI_CLASS_PROG
 0x09

	)

63 
	#PCI_CLASS_DEVICE
 0x0®

	)

65 
	#PCI_CACHE_LINE_SIZE
 0x0¯

	)

66 
	#PCI_LATENCY_TIMER
 0x0d

	)

67 
	#PCI_HEADER_TYPE
 0x0ê

	)

68 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

69 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

70 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

72 
	#PCI_BIST
 0x0‡

	)

73 
	#PCI_BIST_CODE_MASK
 0x0‡

	)

74 
	#PCI_BIST_START
 0x40

	)

75 
	#PCI_BIST_CAPABLE
 0x80

	)

83 
	#PCI_BASE_ADDRESS_0
 0x10

	)

84 
	#PCI_BASE_ADDRESS_1
 0x14

	)

85 
	#PCI_BASE_ADDRESS_2
 0x18

	)

86 
	#PCI_BASE_ADDRESS_3
 0x1¯

	)

87 
	#PCI_BASE_ADDRESS_4
 0x20

	)

88 
	#PCI_BASE_ADDRESS_5
 0x24

	)

89 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

90 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

91 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

92 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

93 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

94 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

95 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

96 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

97 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

98 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

102 
	#PCI_CARDBUS_CIS
 0x28

	)

103 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

104 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

105 
	#PCI_ROM_ADDRESS
 0x30

	)

106 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

107 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffUL)

	)

109 
	#PCI_CAPABILITY_LIST
 0x34

	)

112 
	#PCI_INTERRUPT_LINE
 0x3¯

	)

113 
	#PCI_INTERRUPT_PIN
 0x3d

	)

114 
	#PCI_MIN_GNT
 0x3ê

	)

115 
	#PCI_MAX_LAT
 0x3‡

	)

118 
	#PCI_PRIMARY_BUS
 0x18

	)

119 
	#PCI_SECONDARY_BUS
 0x19

	)

120 
	#PCI_SUBORDINATE_BUS
 0x1®

	)

121 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

122 
	#PCI_IO_BASE
 0x1¯

	)

123 
	#PCI_IO_LIMIT
 0x1d

	)

124 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

125 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

126 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

127 
	#PCI_IO_RANGE_MASK
 (~0x0fUL)

	)

128 
	#PCI_SEC_STATUS
 0x1ê

	)

129 
	#PCI_MEMORY_BASE
 0x20

	)

130 
	#PCI_MEMORY_LIMIT
 0x22

	)

131 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

132 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

133 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

134 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

135 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

136 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

137 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

138 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

139 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

140 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

141 
	#PCI_IO_BASE_UPPER16
 0x30

	)

142 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

145 
	#PCI_ROM_ADDRESS1
 0x38

	)

147 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

148 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

149 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

150 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

151 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

152 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

153 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

154 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

157 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

159 
	#PCI_CB_SEC_STATUS
 0x16

	)

160 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

161 
	#PCI_CB_CARD_BUS
 0x19

	)

162 
	#PCI_CB_SUBORDINATE_BUS
 0x1®

	)

163 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

164 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

165 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

166 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

167 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

168 
	#PCI_CB_IO_BASE_0
 0x2c

	)

169 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

170 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

171 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

172 
	#PCI_CB_IO_BASE_1
 0x34

	)

173 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

174 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

175 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

176 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

178 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

179 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

180 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

181 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

182 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

183 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

184 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

185 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

186 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

187 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

188 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

189 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

190 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

191 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

196 
	#PCI_CAP_LIST_ID
 0

	)

197 
	#PCI_CAP_ID_PM
 0x01

	)

198 
	#PCI_CAP_ID_AGP
 0x02

	)

199 
	#PCI_CAP_ID_VPD
 0x03

	)

200 
	#PCI_CAP_ID_SLOTID
 0x04

	)

201 
	#PCI_CAP_ID_MSI
 0x05

	)

202 
	#PCI_CAP_ID_CHSWP
 0x06

	)

203 
	#PCI_CAP_ID_PCIX
 0x07

	)

204 
	#PCI_CAP_ID_HT
 0x08

	)

205 
	#PCI_CAP_ID_VNDR
 0x09

	)

206 
	#PCI_CAP_ID_DBG
 0x0A

	)

207 
	#PCI_CAP_ID_CCRC
 0x0B

	)

208 
	#PCI_CAP_ID_SHPC
 0x0C

	)

209 
	#PCI_CAP_ID_SSVID
 0x0D

	)

210 
	#PCI_CAP_ID_AGP3
 0x0E

	)

211 
	#PCI_CAP_ID_EXP
 0x10

	)

212 
	#PCI_CAP_ID_MSIX
 0x11

	)

213 
	#PCI_CAP_LIST_NEXT
 1

	)

214 
	#PCI_CAP_FLAGS
 2

	)

215 
	#PCI_CAP_SIZEOF
 4

	)

219 
	#PCI_PM_PMC
 2

	)

220 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

221 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

222 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

223 
	#PCI_PM_CAP_DSI
 0x0020

	)

224 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

225 
	#PCI_PM_CAP_D1
 0x0200

	)

226 
	#PCI_PM_CAP_D2
 0x0400

	)

227 
	#PCI_PM_CAP_PME
 0x0800

	)

228 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

229 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

230 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

231 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

232 
	#PCI_PM_CAP_PME_D3
 0x4000

	)

233 
	#PCI_PM_CAP_PME_D3cﬁd
 0x8000

	)

234 
	#PCI_PM_CAP_PME_SHIFT
 11

	)

235 
	#PCI_PM_CTRL
 4

	)

236 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

237 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0004

	)

238 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

239 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

240 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

241 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

242 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

243 
	#PCI_PM_PPB_B2_B3
 0x40

	)

244 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

245 
	#PCI_PM_DATA_REGISTER
 7

	)

246 
	#PCI_PM_SIZEOF
 8

	)

250 
	#PCI_AGP_VERSION
 2

	)

251 
	#PCI_AGP_RFU
 3

	)

252 
	#PCI_AGP_STATUS
 4

	)

253 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

254 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

255 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

256 
	#PCI_AGP_STATUS_FW
 0x0010

	)

257 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

258 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

259 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

260 
	#PCI_AGP_COMMAND
 8

	)

261 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

262 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

263 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

264 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

265 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

266 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

267 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

268 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

269 
	#PCI_AGP_SIZEOF
 12

	)

273 
	#PCI_VPD_ADDR
 2

	)

274 
	#PCI_VPD_ADDR_MASK
 0x7ff‡

	)

275 
	#PCI_VPD_ADDR_F
 0x8000

	)

276 
	#PCI_VPD_DATA
 4

	)

280 
	#PCI_SID_ESR
 2

	)

281 
	#PCI_SID_ESR_NSLOTS
 0x1‡

	)

282 
	#PCI_SID_ESR_FIC
 0x20

	)

283 
	#PCI_SID_CHASSIS_NR
 3

	)

287 
	#PCI_MSI_FLAGS
 2

	)

288 
	#PCI_MSI_FLAGS_64BIT
 0x80

	)

289 
	#PCI_MSI_FLAGS_QSIZE
 0x70

	)

290 
	#PCI_MSI_FLAGS_QMASK
 0x0ê

	)

291 
	#PCI_MSI_FLAGS_ENABLE
 0x01

	)

292 
	#PCI_MSI_FLAGS_MASKBIT
 0x100

	)

293 
	#PCI_MSI_RFU
 3

	)

294 
	#PCI_MSI_ADDRESS_LO
 4

	)

295 
	#PCI_MSI_ADDRESS_HI
 8

	)

296 
	#PCI_MSI_DATA_32
 8

	)

297 
	#PCI_MSI_DATA_64
 12

	)

298 
	#PCI_MSI_MASK_BIT
 16

	)

301 
	#PCI_MSIX_FLAGS
 2

	)

302 
	#PCI_MSIX_FLAGS_QSIZE
 0x7FF

	)

303 
	#PCI_MSIX_FLAGS_ENABLE
 (1 << 15)

	)

304 
	#PCI_MSIX_FLAGS_MASKALL
 (1 << 14)

	)

305 
	#PCI_MSIX_FLAGS_BIRMASK
 (7 << 0)

	)

306 
	#PCI_MSIX_FLAGS_BITMASK
 (1 << 0)

	)

310 
	#PCI_CHSWP_CSR
 2

	)

311 
	#PCI_CHSWP_DHA
 0x01

	)

312 
	#PCI_CHSWP_EIM
 0x02

	)

313 
	#PCI_CHSWP_PIE
 0x04

	)

314 
	#PCI_CHSWP_LOO
 0x08

	)

315 
	#PCI_CHSWP_PI
 0x30

	)

316 
	#PCI_CHSWP_EXT
 0x40

	)

317 
	#PCI_CHSWP_INS
 0x80

	)

321 
	#PCI_X_CMD
 2

	)

322 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

323 
	#PCI_X_CMD_ERO
 0x0002

	)

324 
	#PCI_X_CMD_READ_512
 0x0000

	)

325 
	#PCI_X_CMD_READ_1K
 0x0004

	)

326 
	#PCI_X_CMD_READ_2K
 0x0008

	)

327 
	#PCI_X_CMD_READ_4K
 0x000¯

	)

328 
	#PCI_X_CMD_MAX_READ
 0x000¯

	)

330 
	#PCI_X_CMD_SPLIT_1
 0x0000

	)

331 
	#PCI_X_CMD_SPLIT_2
 0x0010

	)

332 
	#PCI_X_CMD_SPLIT_3
 0x0020

	)

333 
	#PCI_X_CMD_SPLIT_4
 0x0030

	)

334 
	#PCI_X_CMD_SPLIT_8
 0x0040

	)

335 
	#PCI_X_CMD_SPLIT_12
 0x0050

	)

336 
	#PCI_X_CMD_SPLIT_16
 0x0060

	)

337 
	#PCI_X_CMD_SPLIT_32
 0x0070

	)

338 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

339 
	#PCI_X_CMD_VERSION
(
x
Ë(((xË>> 12Ë& 3Ë

	)

340 
	#PCI_X_STATUS
 4

	)

341 
	#PCI_X_STATUS_DEVFN
 0x000000f‡

	)

342 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

343 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

344 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

345 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

346 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

347 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

348 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

349 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

350 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

351 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

352 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

353 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

357 
	#PCI_EXP_FLAGS
 2

	)

358 
	#PCI_EXP_FLAGS_VERS
 0x000‡

	)

359 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

360 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

361 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

362 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

363 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

364 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

365 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

366 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

367 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

368 
	#PCI_EXP_DEVCAP
 4

	)

369 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x07

	)

370 
	#PCI_EXP_DEVCAP_PHANTOM
 0x18

	)

371 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x20

	)

372 
	#PCI_EXP_DEVCAP_L0S
 0x1c0

	)

373 
	#PCI_EXP_DEVCAP_L1
 0xe00

	)

374 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x1000

	)

375 
	#PCI_EXP_DEVCAP_ATN_IND
 0x2000

	)

376 
	#PCI_EXP_DEVCAP_PWR_IND
 0x4000

	)

377 
	#PCI_EXP_DEVCAP_RBER
 0x8000

	)

378 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x3fc0000

	)

379 
	#PCI_EXP_DEVCAP_PWR_SCL
 0xc000000

	)

380 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

381 
	#PCI_EXP_DEVCTL
 8

	)

382 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

383 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

384 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

385 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

386 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

387 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

388 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

389 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

390 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

391 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

392 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

393 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

394 
	#PCI_EXP_DEVSTA
 10

	)

395 
	#PCI_EXP_DEVSTA_CED
 0x01

	)

396 
	#PCI_EXP_DEVSTA_NFED
 0x02

	)

397 
	#PCI_EXP_DEVSTA_FED
 0x04

	)

398 
	#PCI_EXP_DEVSTA_URD
 0x08

	)

399 
	#PCI_EXP_DEVSTA_AUXPD
 0x10

	)

400 
	#PCI_EXP_DEVSTA_TRPND
 0x20

	)

401 
	#PCI_EXP_LNKCAP
 12

	)

402 
	#PCI_EXP_LNKCAP_ASPMS
 0xc00

	)

403 
	#PCI_EXP_LNKCAP_L0SEL
 0x7000

	)

404 
	#PCI_EXP_LNKCAP_L1EL
 0x38000

	)

405 
	#PCI_EXP_LNKCAP_CLKPM
 0x40000

	)

406 
	#PCI_EXP_LNKCTL
 16

	)

407 
	#PCI_EXP_LNKCTL_RL
 0x20

	)

408 
	#PCI_EXP_LNKCTL_CCC
 0x40

	)

409 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x100

	)

410 
	#PCI_EXP_LNKSTA
 18

	)

411 
	#PCI_EXP_LNKSTA_LT
 0x800

	)

412 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

413 
	#PCI_EXP_SLTCAP
 20

	)

414 
	#PCI_EXP_SLTCTL
 24

	)

415 
	#PCI_EXP_SLTSTA
 26

	)

416 
	#PCI_EXP_RTCTL
 28

	)

417 
	#PCI_EXP_RTCTL_SECEE
 0x01

	)

418 
	#PCI_EXP_RTCTL_SENFEE
 0x02

	)

419 
	#PCI_EXP_RTCTL_SEFEE
 0x04

	)

420 
	#PCI_EXP_RTCTL_PMEIE
 0x08

	)

421 
	#PCI_EXP_RTCTL_CRSSVE
 0x10

	)

422 
	#PCI_EXP_RTCAP
 30

	)

423 
	#PCI_EXP_RTSTA
 32

	)

424 
	#PCI_EXP_DEVCAP2
 36

	)

425 
	#PCI_EXP_DEVCAP2_ARI
 0x20

	)

426 
	#PCI_EXP_DEVCTL2
 40

	)

427 
	#PCI_EXP_DEVCTL2_ARI
 0x20

	)

430 
	#PCI_EXT_CAP_ID
(
hódî
Ë(hódî & 0x0000ffff)

	)

431 
	#PCI_EXT_CAP_VER
(
hódî
Ë((hódî >> 16Ë& 0xf)

	)

432 
	#PCI_EXT_CAP_NEXT
(
hódî
Ë((hódî >> 20Ë& 0xffc)

	)

434 
	#PCI_EXT_CAP_ID_ERR
 1

	)

435 
	#PCI_EXT_CAP_ID_VC
 2

	)

436 
	#PCI_EXT_CAP_ID_DSN
 3

	)

437 
	#PCI_EXT_CAP_ID_PWR
 4

	)

438 
	#PCI_EXT_CAP_ID_ARI
 14

	)

441 
	#PCI_ERR_UNCOR_STATUS
 4

	)

442 
	#PCI_ERR_UNC_TRAIN
 0x00000001

	)

443 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

444 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

445 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

446 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

447 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

448 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

449 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

450 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

451 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

452 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

453 
	#PCI_ERR_UNCOR_MASK
 8

	)

455 
	#PCI_ERR_UNCOR_SEVER
 12

	)

457 
	#PCI_ERR_COR_STATUS
 16

	)

458 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

459 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

460 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

461 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

462 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

463 
	#PCI_ERR_COR_MASK
 20

	)

465 
	#PCI_ERR_CAP
 24

	)

466 
	#PCI_ERR_CAP_FEP
(
x
Ë((xË& 31Ë

	)

467 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

468 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

469 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

470 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

471 
	#PCI_ERR_HEADER_LOG
 28

	)

472 
	#PCI_ERR_ROOT_COMMAND
 44

	)

474 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

476 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

478 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

479 
	#PCI_ERR_ROOT_STATUS
 48

	)

480 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

482 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

484 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

486 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

487 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

488 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

489 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

490 
	#PCI_ERR_ROOT_COR_SRC
 52

	)

491 
	#PCI_ERR_ROOT_SRC
 54

	)

494 
	#PCI_VC_PORT_REG1
 4

	)

495 
	#PCI_VC_PORT_REG2
 8

	)

496 
	#PCI_VC_PORT_CTRL
 12

	)

497 
	#PCI_VC_PORT_STATUS
 14

	)

498 
	#PCI_VC_RES_CAP
 16

	)

499 
	#PCI_VC_RES_CTRL
 20

	)

500 
	#PCI_VC_RES_STATUS
 26

	)

503 
	#PCI_PWR_DSR
 4

	)

504 
	#PCI_PWR_DATA
 8

	)

505 
	#PCI_PWR_DATA_BASE
(
x
Ë((xË& 0xffË

	)

506 
	#PCI_PWR_DATA_SCALE
(
x
Ë(((xË>> 8Ë& 3Ë

	)

507 
	#PCI_PWR_DATA_PM_SUB
(
x
Ë(((xË>> 10Ë& 7Ë

	)

508 
	#PCI_PWR_DATA_PM_STATE
(
x
Ë(((xË>> 13Ë& 3Ë

	)

509 
	#PCI_PWR_DATA_TYPE
(
x
Ë(((xË>> 15Ë& 7Ë

	)

510 
	#PCI_PWR_DATA_RAIL
(
x
Ë(((xË>> 18Ë& 7Ë

	)

511 
	#PCI_PWR_CAP
 12

	)

512 
	#PCI_PWR_CAP_BUDGET
(
x
Ë((xË& 1Ë

	)

522 
	#HT_3BIT_CAP_MASK
 0xE0

	)

523 
	#HT_CAPTYPE_SLAVE
 0x00

	)

524 
	#HT_CAPTYPE_HOST
 0x20

	)

526 
	#HT_5BIT_CAP_MASK
 0xF8

	)

527 
	#HT_CAPTYPE_IRQ
 0x80

	)

528 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

529 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

530 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

531 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

532 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

533 
	#HT_MSI_FLAGS
 0x02

	)

534 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

535 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

536 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

537 
	#HT_MSI_ADDR_LO
 0x04

	)

538 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

539 
	#HT_MSI_ADDR_HI
 0x08

	)

540 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

541 
	#HT_CAPTYPE_VCSET
 0xB8

	)

542 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

543 
	#HT_CAPTYPE_GEN3
 0xD0

	)

544 
	#HT_CAPTYPE_PM
 0xE0

	)

547 
	#PCI_ARI_CAP
 0x04

	)

548 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

549 
	#PCI_ARI_CAP_ACS
 0x0002

	)

550 
	#PCI_ARI_CAP_NFN
(
x
Ë(((xË>> 8Ë& 0xffË

	)

551 
	#PCI_ARI_CTRL
 0x06

	)

552 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

553 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

554 
	#PCI_ARI_CTRL_FG
(
x
Ë(((xË>> 4Ë& 7Ë

	)

	@hw/pic.c

8 
	~"biosv¨.h
"

9 
	~"c⁄fig.h
"

10 
	~"ouçut.h
"

11 
	~"pic.h
"

13 
u16


14 
	$pic_úqmask_ªad
()

16  
	`öb
(
PORT_PIC1_DATA
Ë| (öb(
PORT_PIC2_DATA
) << 8);

17 
	}
}

20 
	$pic_úqmask_wrôe
(
u16
 
mask
)

22 
	`outb
(
mask
, 
PORT_PIC1_DATA
);

23 
	`outb
(
mask
 >> 8, 
PORT_PIC2_DATA
);

24 
	}
}

27 
	$pic_úqmask_mask
(
u16
 
off
, u16 
⁄
)

29 
u8
 
pic1off
 = 
off
, 
pic1⁄
 = 
⁄
, 
pic2off
 = off>>8, 
pic2⁄
 = on>>8;

30 
	`outb
((
	`öb
(
PORT_PIC1_DATA
Ë& ~
pic1off
Ë| 
pic1⁄
, PORT_PIC1_DATA);

31 
	`outb
((
	`öb
(
PORT_PIC2_DATA
Ë& ~
pic2off
Ë| 
pic2⁄
, PORT_PIC2_DATA);

32 
	}
}

35 
	$pic_ª£t
(
u8
 
úq0
, u8 
úq8
)

38 
	`outb
(0x11, 
PORT_PIC1_CMD
);

39 
	`outb
(0x11, 
PORT_PIC2_CMD
);

41 
	`outb
(
úq0
, 
PORT_PIC1_DATA
);

42 
	`outb
(
úq8
, 
PORT_PIC2_DATA
);

44 
	`outb
(0x04, 
PORT_PIC1_DATA
);

45 
	`outb
(0x02, 
PORT_PIC2_DATA
);

47 
	`outb
(0x01, 
PORT_PIC1_DATA
);

48 
	`outb
(0x01, 
PORT_PIC2_DATA
);

50 
	`pic_úqmask_wrôe
(
PIC_IRQMASK_DEFAULT
);

51 
	}
}

54 
	$pic_£tup
()

56 
	`d¥ötf
(3, "initÖic\n");

57 
	`pic_ª£t
(
BIOS_HWIRQ0_VECTOR
, 
BIOS_HWIRQ8_VECTOR
);

58 
	}
}

61 
	$íabÀ_hwúq
(
hwúq
, 
£goff_s
 
func
)

63 
	`pic_úqmask_mask
(1 << 
hwúq
, 0);

64 
ve˘‹
;

65 i‡(
hwúq
 < 8)

66 
ve˘‹
 = 
BIOS_HWIRQ0_VECTOR
 + 
hwúq
;

68 
ve˘‹
 = 
BIOS_HWIRQ8_VECTOR
 + 
hwúq
 - 8;

69 
	`SET_IVT
(
ve˘‹
, 
func
);

70 
	}
}

72 
u8


73 
	$pic_i§1_ªad
()

76 
	`outb
(0x0b, 
PORT_PIC1_CMD
);

77  
	`öb
(
PORT_PIC1_CMD
);

78 
	}
}

80 
u8


81 
	$pic_i§2_ªad
()

84 
	`outb
(0x0b, 
PORT_PIC2_CMD
);

85  
	`öb
(
PORT_PIC2_CMD
);

86 
	}
}

89 
VISIBLE16


90 
	$h™dÀ_hwpic1
(
bªgs
 *
ªgs
)

92 
	`d¥ötf
(
DEBUG_ISR_hwpic1
, "h™dÀ_hwpic1 irq=%x\n", 
	`pic_i§1_ªad
());

93 
	`pic_eoi1
();

94 
	}
}

96 
VISIBLE16


97 
	$h™dÀ_hwpic2
(
bªgs
 *
ªgs
)

99 
	`d¥ötf
(
DEBUG_ISR_hwpic2
, "h™dÀ_hwpic2 irq=%x\n", 
	`pic_i§2_ªad
());

100 
	`pic_eoi2
();

101 
	}
}

	@hw/pic.h

7 #i‚de‡
__PIC_H


8 
	#__PIC_H


	)

10 
	~"x86.h
"

12 
	#PORT_PIC1_CMD
 0x0020

	)

13 
	#PORT_PIC1_DATA
 0x0021

	)

14 
	#PORT_PIC2_CMD
 0x00a0

	)

15 
	#PORT_PIC2_DATA
 0x00a1

	)

18 
	#PIC1_IRQ0
 (1<<0)

	)

19 
	#PIC1_IRQ1
 (1<<1)

	)

20 
	#PIC1_IRQ2
 (1<<2)

	)

21 
	#PIC1_IRQ5
 (1<<5)

	)

22 
	#PIC1_IRQ6
 (1<<6)

	)

24 
	#PIC2_IRQ8
 (1<<8)

	)

25 
	#PIC2_IRQ12
 (1<<12)

	)

26 
	#PIC2_IRQ13
 (1<<13)

	)

27 
	#PIC2_IRQ14
 (1<<14)

	)

29 
	#PIC_IRQMASK_DEFAULT
 ((
u16
)~
PIC1_IRQ2
)

	)

31 
	#BIOS_HWIRQ0_VECTOR
 0x08

	)

32 
	#BIOS_HWIRQ8_VECTOR
 0x70

	)

34 
ölöe
 

35 
	$pic_eoi1
()

38 
	`outb
(0x20, 
PORT_PIC1_CMD
);

39 
	}
}

41 
ölöe
 

42 
	$pic_eoi2
()

45 
	`outb
(0x20, 
PORT_PIC2_CMD
);

46 
	`pic_eoi1
();

47 
	}
}

49 
u16
 
pic_úqmask_ªad
();

50 
pic_úqmask_wrôe
(
u16
 
mask
);

51 
pic_úqmask_mask
(
u16
 
off
, u16 
⁄
);

52 
pic_ª£t
(
u8
 
úq0
, u8 
úq8
);

53 
pic_£tup
();

54 
íabÀ_hwúq
(
hwúq
, 
£goff_s
 
func
);

	@hw/ps2port.c

8 
	~"biosv¨.h
"

9 
	~"ouçut.h
"

10 
	~"pic.h
"

11 
	~"ps2p‹t.h
"

12 
	~"romfûe.h
"

13 
	~"°acks.h
"

14 
	~"utû.h
"

15 
	~"x86.h
"

23 
	#I8042_CTL_TIMEOUT
 10000

	)

25 
	#I8042_BUFFER_SIZE
 16

	)

28 
	$i8042_waô_ªad
()

30 
	`d¥ötf
(7, "i8042_wait_read\n");

31 
i
;

32 
i
=0; i<
I8042_CTL_TIMEOUT
; i++) {

33 
u8
 
°©us
 = 
	`öb
(
PORT_PS2_STATUS
);

34 i‡(
°©us
 & 
I8042_STR_OBF
)

36 
	`udñay
(50);

38 
	`w¨n_timeout
();

40 
	}
}

43 
	$i8042_waô_wrôe
()

45 
	`d¥ötf
(7, "i8042_wait_write\n");

46 
i
;

47 
i
=0; i<
I8042_CTL_TIMEOUT
; i++) {

48 
u8
 
°©us
 = 
	`öb
(
PORT_PS2_STATUS
);

49 i‡(! (
°©us
 & 
I8042_STR_IBF
))

51 
	`udñay
(50);

53 
	`w¨n_timeout
();

55 
	}
}

58 
	$i8042_Êush
()

60 
	`d¥ötf
(7, "i8042_flush\n");

61 
i
;

62 
i
=0; i<
I8042_BUFFER_SIZE
; i++) {

63 
u8
 
°©us
 = 
	`öb
(
PORT_PS2_STATUS
);

64 i‡(! (
°©us
 & 
I8042_STR_OBF
))

66 
	`udñay
(50);

67 
u8
 
d©a
 = 
	`öb
(
PORT_PS2_DATA
);

68 
	`d¥ötf
(7, "i8042 flushed %x (°©us=%x)\n", 
d©a
, 
°©us
);

71 
	`w¨n_timeout
();

73 
	}
}

76 
	$__i8042_comm™d
(
comm™d
, 
u8
 *
∑øm
)

78 
ª˚ive
 = (
comm™d
 >> 8) & 0xf;

79 
£nd
 = (
comm™d
 >> 12) & 0xf;

82 
ªt
 = 
	`i8042_waô_wrôe
();

83 i‡(
ªt
)

84  
ªt
;

85 
	`outb
(
comm™d
, 
PORT_PS2_STATUS
);

88 
i
;

89 
i
 = 0; i < 
£nd
; i++) {

90 
ªt
 = 
	`i8042_waô_wrôe
();

91 i‡(
ªt
)

92  
ªt
;

93 
	`outb
(
∑øm
[
i
], 
PORT_PS2_DATA
);

97 
i
 = 0; i < 
ª˚ive
; i++) {

98 
ªt
 = 
	`i8042_waô_ªad
();

99 i‡(
ªt
)

100  
ªt
;

101 
∑øm
[
i
] = 
	`öb
(
PORT_PS2_DATA
);

102 
	`d¥ötf
(7, "i8042Ö¨am=%x\n", 
∑øm
[
i
]);

106 
	}
}

109 
	$i8042_comm™d
(
comm™d
, 
u8
 *
∑øm
)

111 
	`d¥ötf
(7, "i8042_comm™d cmd=%x\n", 
comm™d
);

112 
ªt
 = 
	`__i8042_comm™d
(
comm™d
, 
∑øm
);

113 i‡(
ªt
)

114 
	`d¥ötf
(2, "i8042 comm™d %x faûed\n", 
comm™d
);

115  
ªt
;

116 
	}
}

119 
	$i8042_kbd_wrôe
(
u8
 
c
)

121 
	`d¥ötf
(7, "i8042_kbd_wrôêc=%d\n", 
c
);

122 
ªt
 = 
	`i8042_waô_wrôe
();

123 i‡(! 
ªt
)

124 
	`outb
(
c
, 
PORT_PS2_DATA
);

125  
ªt
;

126 
	}
}

129 
	$i8042_aux_wrôe
(
u8
 
c
)

131  
	`i8042_comm™d
(
I8042_CMD_AUX_SEND
, &
c
);

132 
	}
}

135 
	$i8042_ªboŸ
()

137 i‡(! 
CONFIG_PS2PORT
)

139 
i
;

140 
i
=0; i<10; i++) {

141 
	`i8042_waô_wrôe
();

142 
	`udñay
(50);

143 
	`outb
(0x„, 
PORT_PS2_STATUS
);

144 
	`udñay
(50);

146 
	}
}

153 
	#PS2_RET_ACK
 0xÁ

	)

154 
	#PS2_RET_NAK
 0x„

	)

157 
	$ps2_ªcvbyã
(
aux
, 
√edack
, 
timeout
)

159 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

161 
u8
 
°©us
 = 
	`öb
(
PORT_PS2_STATUS
);

162 i‡(
°©us
 & 
I8042_STR_OBF
) {

163 
u8
 
d©a
 = 
	`öb
(
PORT_PS2_DATA
);

164 
	`d¥ötf
(7, "ps2Ñód %x\n", 
d©a
);

166 i‡(!!(
°©us
 & 
I8042_STR_AUXDATA
Ë=
aux
) {

167 i‡(!
√edack
)

168  
d©a
;

169 i‡(
d©a
 =
PS2_RET_ACK
)

170  
d©a
;

171 i‡(
d©a
 =
PS2_RET_NAK
) {

172 
	`d¥ötf
(1, "GŸÖs2Çak (°©us=%x)\n", 
°©us
);

173  
d©a
;

178 
	`d¥ötf
(1, "DisˇrdögÖs2 d©®%02x (°©us=%02x)\n", 
d©a
, 
°©us
);

181 i‡(
	`timî_check
(
íd
)) {

183 i‡(
timeout
 > 100)

184 
	`w¨n_timeout
();

187 
	`yõld
();

189 
	}
}

192 
	$ps2_£ndbyã
(
aux
, 
u8
 
comm™d
, 
timeout
)

194 
	`d¥ötf
(7, "ps2_£ndbyãáux=%d cmd=%x\n", 
aux
, 
comm™d
);

195 
ªt
;

196 i‡(
aux
)

197 
ªt
 = 
	`i8042_aux_wrôe
(
comm™d
);

199 
ªt
 = 
	`i8042_kbd_wrôe
(
comm™d
);

200 i‡(
ªt
)

201  
ªt
;

204 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 1, 
timeout
);

205 i‡(
ªt
 < 0)

206  
ªt
;

207 i‡(
ªt
 !
PS2_RET_ACK
)

211 
	}
}

213 
u8
 
Ps2˘r
 
	gVARLOW
;

216 
	$__ps2_comm™d
(
aux
, 
comm™d
, 
u8
 *
∑øm
)

218 
ªt2
;

219 
ª˚ive
 = (
comm™d
 >> 8) & 0xf;

220 
£nd
 = (
comm™d
 >> 12) & 0xf;

223 
u8
 
ps2˘r
 = 
	`GET_LOW
(
Ps2˘r
);

224 
u8
 
√w˘r
 = ((
ps2˘r
 | 
I8042_CTR_AUXDIS
 | 
I8042_CTR_KBDDIS
)

225 & ~(
I8042_CTR_KBDINT
|
I8042_CTR_AUXINT
));

226 
	`d¥ötf
(6, "i8042 cå old=%xÇew=%x\n", 
ps2˘r
, 
√w˘r
);

227 
ªt
 = 
	`i8042_comm™d
(
I8042_CMD_CTL_WCTR
, &
√w˘r
);

228 i‡(
ªt
)

229  
ªt
;

232 
	`yõld
();

235 i‡(
aux
)

236 
√w˘r
 &~
I8042_CTR_AUXDIS
;

238 
√w˘r
 &~
I8042_CTR_KBDDIS
;

239 
ªt
 = 
	`i8042_comm™d
(
I8042_CMD_CTL_WCTR
, &
√w˘r
);

240 i‡(
ªt
)

241 
Áû
;

243 i‡(
comm™d
 =
ATKBD_CMD_RESET_BAT
) {

247 
ªt
 = 
	`ps2_£ndbyã
(
aux
, 
comm™d
, 1000);

248 i‡(
ªt
)

249 
Áû
;

252 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 0, 4000);

253 i‡(
ªt
 < 0)

254 
Áû
;

255 
∑øm
[0] = 
ªt
;

256 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 0, 100);

257 i‡(
ªt
 < 0)

259 
ªt
 = 0;

260 
∑øm
[1] = 
ªt
;

261 } i‡(
comm™d
 =
ATKBD_CMD_GETID
) {

265 
ªt
 = 
	`ps2_£ndbyã
(
aux
, 
comm™d
, 200);

266 i‡(
ªt
)

267 
Áû
;

270 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 0, 500);

271 i‡(
ªt
 < 0)

272 
Áû
;

273 
∑øm
[0] = 
ªt
;

274 i‡(
ªt
 == 0xab ||Ñet == 0xac ||Ñet == 0x2b ||Ñet == 0x5d

275 || 
ªt
 == 0x60 ||Ñet == 0x47) {

277 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 0, 500);

278 i‡(
ªt
 < 0)

279 
Áû
;

280 
∑øm
[1] = 
ªt
;

282 
∑øm
[1] = 0;

286 
ªt
 = 
	`ps2_£ndbyã
(
aux
, 
comm™d
, 200);

287 i‡(
ªt
)

288 
Áû
;

291 
i
;

292 
i
 = 0; i < 
£nd
; i++) {

293 
ªt
 = 
	`ps2_£ndbyã
(
aux
, 
∑øm
[
i
], 200);

294 i‡(
ªt
)

295 
Áû
;

299 
i
 = 0; i < 
ª˚ive
; i++) {

300 
ªt
 = 
	`ps2_ªcvbyã
(
aux
, 0, 500);

301 i‡(
ªt
 < 0)

302 
Áû
;

303 
∑øm
[
i
] = 
ªt
;

307 
ªt
 = 0;

309 
Áû
:

311 
ªt2
 = 
	`i8042_comm™d
(
I8042_CMD_CTL_WCTR
, &
ps2˘r
);

312 i‡(
ªt2
)

313  
ªt2
;

315  
ªt
;

316 
	}
}

319 
	$ps2_comm™d
(
aux
, 
comm™d
, 
u8
 *
∑øm
)

321 
	`d¥ötf
(7, "ps2_comm™dáux=%d cmd=%x\n", 
aux
, 
comm™d
);

322 
ªt
 = 
	`__ps2_comm™d
(
aux
, 
comm™d
, 
∑øm
);

323 i‡(
ªt
)

324 
	`d¥ötf
(2, "ps2 comm™d %x faûed (aux=%d)\n", 
comm™d
, 
aux
);

325  
ªt
;

326 
	}
}

329 
	$ps2_kbd_comm™d
(
comm™d
, 
u8
 *
∑øm
)

331 i‡(! 
CONFIG_PS2PORT
)

333  
	`ps2_comm™d
(0, 
comm™d
, 
∑øm
);

334 
	}
}

337 
	$ps2_mou£_comm™d
(
comm™d
, 
u8
 *
∑øm
)

339 i‡(! 
CONFIG_PS2PORT
)

343 i‡(
comm™d
 =
PSMOUSE_CMD_ENABLE
 || comm™d =
PSMOUSE_CMD_DISABLE
) {

344 
u8
 
ps2˘r
 = 
	`GET_LOW
(
Ps2˘r
);

345 i‡(
comm™d
 =
PSMOUSE_CMD_ENABLE
)

346 
ps2˘r
 = (ps2˘∏| 
I8042_CTR_AUXINT
Ë& ~
I8042_CTR_AUXDIS
;

348 
ps2˘r
 = (ps2˘∏| 
I8042_CTR_AUXDIS
Ë& ~
I8042_CTR_AUXINT
;

349 
	`SET_LOW
(
Ps2˘r
, 
ps2˘r
);

352  
	`ps2_comm™d
(1, 
comm™d
, 
∑øm
);

353 
	}
}

361 
VISIBLE16


362 
	$h™dÀ_74
()

364 i‡(! 
CONFIG_PS2PORT
)

367 
	`debug_i§
(
DEBUG_ISR_74
);

369 
u8
 
v
 = 
	`öb
(
PORT_PS2_STATUS
);

370 i‡((
v
 & (
I8042_STR_OBF
|
I8042_STR_AUXDATA
))

371 !(
I8042_STR_OBF
|
I8042_STR_AUXDATA
)) {

372 
	`d¥ötf
(1, "ps2 mouse irq butÇo mouse data.\n");

373 
d⁄e
;

375 
v
 = 
	`öb
(
PORT_PS2_DATA
);

377 i‡(!(
	`GET_LOW
(
Ps2˘r
Ë& 
I8042_CTR_AUXINT
))

379 
d⁄e
;

381 
	`¥o˚ss_mou£
(
v
);

383 
d⁄e
:

384 
	`pic_eoi2
();

385 
	}
}

388 
VISIBLE16


389 
	$h™dÀ_09
()

391 i‡(! 
CONFIG_PS2PORT
)

394 
	`debug_i§
(
DEBUG_ISR_09
);

397 
u8
 
v
 = 
	`öb
(
PORT_PS2_STATUS
);

398 i‡(
v
 & 
I8042_STR_AUXDATA
) {

399 
	`d¥ötf
(1, "ps2 keyboard irq but found mouse data?!\n");

400 
d⁄e
;

402 
v
 = 
	`öb
(
PORT_PS2_DATA
);

404 i‡(!(
	`GET_LOW
(
Ps2˘r
Ë& 
I8042_CTR_KBDINT
))

406 
d⁄e
;

408 
	`¥o˚ss_key
(
v
);

411 
	`i8042_comm™d
(
I8042_CMD_KBD_ENABLE
, 
NULL
);

413 
d⁄e
:

414 
	`pic_eoi1
();

415 
	}
}

423 
	$ps2_keybﬂrd_£tup
(*
d©a
)

426 
ªt
 = 
	`i8042_Êush
();

427 i‡(
ªt
)

431 
u8
 
∑øm
[2];

432 
ªt
 = 
	`i8042_comm™d
(
I8042_CMD_CTL_TEST
, 
∑øm
);

433 i‡(
ªt
)

435 i‡(
∑øm
[0] != 0x55) {

436 
	`d¥ötf
(1, "i8042 sñ‡ã° faûed (gŸ %xÇŸ 0x55)\n", 
∑øm
[0]);

441 
ªt
 = 
	`i8042_comm™d
(
I8042_CMD_KBD_TEST
, 
∑øm
);

442 i‡(
ªt
)

444 i‡(
∑øm
[0] != 0x00) {

445 
	`d¥ötf
(1, "i8042 keybﬂrdÅe° faûed (gŸ %xÇŸ 0x00)\n", 
∑øm
[0]);

450 
	`SET_LOW
(
Ps2˘r
, 
I8042_CTR_KBDDIS
 | 
I8042_CTR_AUXDIS
);

455 
•öupdñay
 = 
	`romfûe_lﬂdöt
("etc/ps2-keyboard-spinup", 0);

456 
u32
 
íd
 = 
	`timî_ˇlc
(
•öupdñay
);

458 
ªt
 = 
	`ps2_kbd_comm™d
(
ATKBD_CMD_RESET_BAT
, 
∑øm
);

459 i‡(!
ªt
)

461 i‡(
	`timî_check
(
íd
)) {

462 i‡(
•öupdñay
)

463 
	`w¨n_timeout
();

466 
	`yõld
();

468 i‡(
∑øm
[0] != 0xaa) {

469 
	`d¥ötf
(1, "keybﬂrd sñ‡ã° faûed (gŸ %xÇŸ 0xØ)\n", 
∑øm
[0]);

474 
ªt
 = 
	`ps2_kbd_comm™d
(
ATKBD_CMD_RESET_DIS
, 
NULL
);

475 i‡(
ªt
)

479 
∑øm
[0] = 0x02;

480 
ªt
 = 
	`ps2_kbd_comm™d
(
ATKBD_CMD_SSCANSET
, 
∑øm
);

481 i‡(
ªt
)

485 
	`SET_LOW
(
Ps2˘r
, 
I8042_CTR_AUXDIS
 | 
I8042_CTR_XLATE
 | 
I8042_CTR_KBDINT
);

488 
ªt
 = 
	`ps2_kbd_comm™d
(
ATKBD_CMD_ENABLE
, 
NULL
);

489 i‡(
ªt
)

492 
	`d¥ötf
(1, "PS2 keyboard initialized\n");

493 
	}
}

496 
	$ps2p‹t_£tup
()

498 
	`ASSERT32FLAT
();

499 i‡(! 
CONFIG_PS2PORT
)

501 
	`d¥ötf
(3, "initÖs2port\n");

503 
	`íabÀ_hwúq
(1, 
	`FUNC16
(
íåy_09
));

504 
	`íabÀ_hwúq
(12, 
	`FUNC16
(
íåy_74
));

506 
	`run_thªad
(
ps2_keybﬂrd_£tup
, 
NULL
);

507 
	}
}

	@hw/ps2port.h

2 #i‚de‡
__PS2PORT_H


3 
	#__PS2PORT_H


	)

5 
	#PORT_PS2_DATA
 0x0060

	)

6 
	#PORT_PS2_CTRLB
 0x0061

	)

7 
	#PORT_PS2_STATUS
 0x0064

	)

8 
	#PORT_A20
 0x0092

	)

11 
	#A20_ENABLE_BIT
 0x02

	)

14 
	#I8042_CMD_CTL_RCTR
 0x0120

	)

15 
	#I8042_CMD_CTL_WCTR
 0x1060

	)

16 
	#I8042_CMD_CTL_TEST
 0x01Ø

	)

18 
	#I8042_CMD_KBD_TEST
 0x01ab

	)

19 
	#I8042_CMD_KBD_DISABLE
 0x00ad

	)

20 
	#I8042_CMD_KBD_ENABLE
 0x00´

	)

22 
	#I8042_CMD_AUX_DISABLE
 0x00a7

	)

23 
	#I8042_CMD_AUX_ENABLE
 0x00a8

	)

24 
	#I8042_CMD_AUX_SEND
 0x10d4

	)

27 
	#ATKBD_CMD_SETLEDS
 0x10ed

	)

28 
	#ATKBD_CMD_SSCANSET
 0x10f0

	)

29 
	#ATKBD_CMD_GETID
 0x02f2

	)

30 
	#ATKBD_CMD_ENABLE
 0x00f4

	)

31 
	#ATKBD_CMD_RESET_DIS
 0x00f5

	)

32 
	#ATKBD_CMD_RESET_BAT
 0x02ff

	)

35 
	#PSMOUSE_CMD_SETSCALE11
 0x00e6

	)

36 
	#PSMOUSE_CMD_SETSCALE21
 0x00e7

	)

37 
	#PSMOUSE_CMD_SETRES
 0x10e8

	)

38 
	#PSMOUSE_CMD_GETINFO
 0x03e9

	)

39 
	#PSMOUSE_CMD_GETID
 0x02f2

	)

40 
	#PSMOUSE_CMD_SETRATE
 0x10f3

	)

41 
	#PSMOUSE_CMD_ENABLE
 0x00f4

	)

42 
	#PSMOUSE_CMD_DISABLE
 0x00f5

	)

43 
	#PSMOUSE_CMD_RESET_BAT
 0x02ff

	)

46 
	#I8042_STR_PARITY
 0x80

	)

47 
	#I8042_STR_TIMEOUT
 0x40

	)

48 
	#I8042_STR_AUXDATA
 0x20

	)

49 
	#I8042_STR_KEYLOCK
 0x10

	)

50 
	#I8042_STR_CMDDAT
 0x08

	)

51 
	#I8042_STR_MUXERR
 0x04

	)

52 
	#I8042_STR_IBF
 0x02

	)

53 
	#I8042_STR_OBF
 0x01

	)

56 
	#I8042_CTR_KBDINT
 0x01

	)

57 
	#I8042_CTR_AUXINT
 0x02

	)

58 
	#I8042_CTR_IGNKEYLOCK
 0x08

	)

59 
	#I8042_CTR_KBDDIS
 0x10

	)

60 
	#I8042_CTR_AUXDIS
 0x20

	)

61 
	#I8042_CTR_XLATE
 0x40

	)

63 #i‚de‡
__ASSEMBLY__


65 
	~"ty≥s.h
"

68 
i8042_ªboŸ
();

69 
ps2_kbd_comm™d
(
comm™d
, 
u8
 *
∑øm
);

70 
ps2_mou£_comm™d
(
comm™d
, 
u8
 *
∑øm
);

71 
ps2p‹t_£tup
();

	@hw/pvscsi.c

10 
	~"block.h
"

11 
	~"blockcmd.h
"

12 
	~"c⁄fig.h
"

13 
	~"mÆloc.h
"

14 
	~"ouçut.h
"

15 
	~"pci.h
"

16 
	~"pci_ids.h
"

17 
	~"pci_ªgs.h
"

18 
	~"pvscsi.h
"

19 
	~"°d/disk.h
"

20 
	~"°rög.h
"

21 
	~"utû.h
"

22 
	~"vútio-rög.h
"

23 
	~"x86.h
"

25 
	#MASK
(
n
Ë((1 << (n)Ë- 1)

	)

27 
	#SIMPLE_QUEUE_TAG
 0x20

	)

29 
	#PVSCSI_INTR_CMPL_0
 (1 << 0)

	)

30 
	#PVSCSI_INTR_CMPL_1
 (1 << 1)

	)

31 
	#PVSCSI_INTR_CMPL_MASK
 
	`MASK
(2)

	)

33 
	#PVSCSI_INTR_MSG_0
 (1 << 2)

	)

34 
	#PVSCSI_INTR_MSG_1
 (1 << 3)

	)

35 
	#PVSCSI_INTR_MSG_MASK
 (
	`MASK
(2Ë<< 2)

	)

36 
	#PVSCSI_INTR_ALL_SUPPORTED
 
	`MASK
(4)

	)

38 
	#PVSCSI_FLAG_CMD_WITH_SG_LIST
 (1 << 0)

	)

39 
	#PVSCSI_FLAG_CMD_OUT_OF_BAND_CDB
 (1 << 1)

	)

40 
	#PVSCSI_FLAG_CMD_DIR_NONE
 (1 << 2)

	)

41 
	#PVSCSI_FLAG_CMD_DIR_TOHOST
 (1 << 3)

	)

42 
	#PVSCSI_FLAG_CMD_DIR_TODEVICE
 (1 << 4)

	)

44 
	ePVSCSIRegOff£t
 {

45 
	mPVSCSI_REG_OFFSET_COMMAND
 = 0x0,

46 
	mPVSCSI_REG_OFFSET_COMMAND_DATA
 = 0x4,

47 
	mPVSCSI_REG_OFFSET_COMMAND_STATUS
 = 0x8,

48 
	mPVSCSI_REG_OFFSET_LAST_STS_0
 = 0x100,

49 
	mPVSCSI_REG_OFFSET_LAST_STS_1
 = 0x104,

50 
	mPVSCSI_REG_OFFSET_LAST_STS_2
 = 0x108,

51 
	mPVSCSI_REG_OFFSET_LAST_STS_3
 = 0x10c,

52 
	mPVSCSI_REG_OFFSET_INTR_STATUS
 = 0x100c,

53 
	mPVSCSI_REG_OFFSET_INTR_MASK
 = 0x2010,

54 
	mPVSCSI_REG_OFFSET_KICK_NON_RW_IO
 = 0x3014,

55 
	mPVSCSI_REG_OFFSET_DEBUG
 = 0x3018,

56 
	mPVSCSI_REG_OFFSET_KICK_RW_IO
 = 0x4018,

59 
	ePVSCSIComm™ds
 {

60 
	mPVSCSI_CMD_FIRST
 = 0,

61 
	mPVSCSI_CMD_ADAPTER_RESET
 = 1,

62 
	mPVSCSI_CMD_ISSUE_SCSI
 = 2,

63 
	mPVSCSI_CMD_SETUP_RINGS
 = 3,

64 
	mPVSCSI_CMD_RESET_BUS
 = 4,

65 
	mPVSCSI_CMD_RESET_DEVICE
 = 5,

66 
	mPVSCSI_CMD_ABORT_CMD
 = 6,

67 
	mPVSCSI_CMD_CONFIG
 = 7,

68 
	mPVSCSI_CMD_SETUP_MSG_RING
 = 8,

69 
	mPVSCSI_CMD_DEVICE_UNPLUG
 = 9,

70 
	mPVSCSI_CMD_LAST
 = 10

73 
	#PVSCSI_SETUP_RINGS_MAX_NUM_PAGES
 32

	)

74 
	sPVSCSICmdDescSëupRögs
 {

75 
u32
 
	mªqRögNumPages
;

76 
u32
 
	mcmpRögNumPages
;

77 
u64
 
	mrögsSèãPPN
;

78 
u64
 
	mªqRögPPNs
[
PVSCSI_SETUP_RINGS_MAX_NUM_PAGES
];

79 
u64
 
	mcmpRögPPNs
[
PVSCSI_SETUP_RINGS_MAX_NUM_PAGES
];

80 } 
	gPACKED
;

82 
	sPVSCSIRögCmpDesc
 {

83 
u64
 
	mc⁄ãxt
;

84 
u64
 
	md©aLí
;

85 
u32
 
	m£n£Lí
;

86 
u16
 
	mho°Sètus
;

87 
u16
 
	mscsiSètus
;

88 
u32
 
	m∑d
[2];

89 } 
	gPACKED
;

91 
	sPVSCSIRögsSèã
 {

92 
u32
 
	mªqProdIdx
;

93 
u32
 
	mªqC⁄sIdx
;

94 
u32
 
	mªqNumE¡rõsLog2
;

96 
u32
 
	mcmpProdIdx
;

97 
u32
 
	mcmpC⁄sIdx
;

98 
u32
 
	mcmpNumE¡rõsLog2
;

100 
u8
 
	m∑d
[104];

102 
u32
 
	mmsgProdIdx
;

103 
u32
 
	mmsgC⁄sIdx
;

104 
u32
 
	mmsgNumE¡rõsLog2
;

105 } 
	gPACKED
;

107 
	sPVSCSIRögReqDesc
 {

108 
u64
 
	mc⁄ãxt
;

109 
u64
 
	md©aAddr
;

110 
u64
 
	md©aLí
;

111 
u64
 
	m£n£Addr
;

112 
u32
 
	m£n£Lí
;

113 
u32
 
	mÊags
;

114 
u8
 
	mcdb
[16];

115 
u8
 
	mcdbLí
;

116 
u8
 
	mlun
[8];

117 
u8
 
	mèg
;

118 
u8
 
	mbus
;

119 
u8
 
	mèrgë
;

120 
u8
 
	mv˝uHöt
;

121 
u8
 
	munu£d
[59];

122 } 
	gPACKED
;

124 
	spvscsi_rög_dsc_s
 {

125 
PVSCSIRögsSèã
 *
	mrög_°©e
;

126 
PVSCSIRögReqDesc
 *
	mrög_ªqs
;

127 
PVSCSIRögCmpDesc
 *
	mrög_cmps
;

130 
	spvscsi_lun_s
 {

131 
drive_s
 
	mdrive
;

132 *
	mioba£
;

133 
u8
 
	mèrgë
;

134 
u8
 
	mlun
;

135 
pvscsi_rög_dsc_s
 *
	mrög_dsc
;

139 
	$pvscsi_wrôe_cmd_desc
(*
ioba£
, 
u32
 
cmd
, c⁄° *
desc
, 
size_t
 
Àn
)

141 c⁄° 
u32
 *
±r
 = 
desc
;

142 
size_t
 
i
;

144 
Àn
 /(*
±r
);

145 
	`wrôñ
(
ioba£
 + 
PVSCSI_REG_OFFSET_COMMAND
, 
cmd
);

146 
i
 = 0; i < 
Àn
; i++)

147 
	`wrôñ
(
ioba£
 + 
PVSCSI_REG_OFFSET_COMMAND_DATA
, 
±r
[
i
]);

148 
	}
}

151 
	$pvscsi_kick_rw_io
(*
ioba£
)

153 
	`wrôñ
(
ioba£
 + 
PVSCSI_REG_OFFSET_KICK_RW_IO
, 0);

154 
	}
}

157 
	$pvscsi_waô_öå_cm∂
(*
ioba£
)

159 !(
	`ªadl
(
ioba£
 + 
PVSCSI_REG_OFFSET_INTR_STATUS
Ë& 
PVSCSI_INTR_CMPL_MASK
))

160 
	`u¶ìp
(5);

161 
	`wrôñ
(
ioba£
 + 
PVSCSI_REG_OFFSET_INTR_STATUS
, 
PVSCSI_INTR_CMPL_MASK
);

162 
	}
}

165 
	$pvscsi_öô_rögs
(*
ioba£
, 
pvscsi_rög_dsc_s
 **
rög_dsc
)

167 
PVSCSICmdDescSëupRögs
 
cmd
 = {0,};

169 
pvscsi_rög_dsc_s
 *
dsc
 = 
	`memÆign_low
((*dsc), 
PAGE_SIZE
);

170 i‡(!
dsc
) {

171 
	`w¨n_nﬂŒoc
();

175 
dsc
->
rög_°©e
 =

176 (
PVSCSIRögsSèã
 *)
	`memÆign_low
(
PAGE_SIZE
, PAGE_SIZE);

177 
dsc
->
rög_ªqs
 =

178 (
PVSCSIRögReqDesc
 *)
	`memÆign_low
(
PAGE_SIZE
, PAGE_SIZE);

179 
dsc
->
rög_cmps
 =

180 (
PVSCSIRögCmpDesc
 *)
	`memÆign_low
(
PAGE_SIZE
, PAGE_SIZE);

181 i‡(!
dsc
->
rög_°©e
 || !dsc->
rög_ªqs
 || !dsc->
rög_cmps
) {

182 
	`w¨n_nﬂŒoc
();

185 
	`mem£t
(
dsc
->
rög_°©e
, 0, 
PAGE_SIZE
);

186 
	`mem£t
(
dsc
->
rög_ªqs
, 0, 
PAGE_SIZE
);

187 
	`mem£t
(
dsc
->
rög_cmps
, 0, 
PAGE_SIZE
);

189 
cmd
.
ªqRögNumPages
 = 1;

190 
cmd
.
cmpRögNumPages
 = 1;

191 
cmd
.
rögsSèãPPN
 = 
	`vút_to_phys
(
dsc
->
rög_°©e
Ë>> 
PAGE_SHIFT
;

192 
cmd
.
ªqRögPPNs
[0] = 
	`vút_to_phys
(
dsc
->
rög_ªqs
Ë>> 
PAGE_SHIFT
;

193 
cmd
.
cmpRögPPNs
[0] = 
	`vút_to_phys
(
dsc
->
rög_cmps
Ë>> 
PAGE_SHIFT
;

195 
	`pvscsi_wrôe_cmd_desc
(
ioba£
, 
PVSCSI_CMD_SETUP_RINGS
,

196 &
cmd
, (cmd));

197 *
rög_dsc
 = 
dsc
;

198 
	}
}

200 
	$pvscsi_fûl_ªq
(
PVSCSIRögsSèã
 *
s
,

201 
PVSCSIRögReqDesc
 *
ªq
,

202 
u16
 
èrgë
, u16 
lun
, *
cdbcmd
, u16 
blocksize
,

203 
disk_›_s
 *
›
)

205 
ªq
->
bus
 = 0;

206 
ªq
->
èrgë
 =Åarget;

207 
	`mem£t
(
ªq
->
lun
, 0, (req->lun));

208 
ªq
->
lun
[1] =Üun;

209 
ªq
->
£n£Lí
 = 0;

210 
ªq
->
£n£Addr
 = 0;

211 
ªq
->
cdbLí
 = 16;

212 
ªq
->
v˝uHöt
 = 0;

213 
	`mem˝y
(
ªq
->
cdb
, 
cdbcmd
, 16);

214 
ªq
->
èg
 = 
SIMPLE_QUEUE_TAG
;

215 
ªq
->
Êags
 = 
	`cdb_is_ªad
(
cdbcmd
, 
blocksize
) ?

216 
PVSCSI_FLAG_CMD_DIR_TOHOST
 : 
PVSCSI_FLAG_CMD_DIR_TODEVICE
;

218 
ªq
->
d©aLí
 = 
›
->
cou¡
 * 
blocksize
;

219 
ªq
->
d©aAddr
 = (
u32
)
›
->
buf_Ê
;

220 
s
->
ªqProdIdx
 = s->reqProdIdx + 1;

221 
	}
}

223 
u32


224 
	$pvscsi_gë_r•
(
PVSCSIRögsSèã
 *
s
,

225 
PVSCSIRögCmpDesc
 *
r•
)

227 
u32
 
°©us
 = 
r•
->
ho°Sètus
;

228 
s
->
cmpC⁄sIdx
 = s->cmpConsIdx + 1;

229  
°©us
;

230 
	}
}

233 
	$pvscsi_cmd
(
pvscsi_lun_s
 *
∂un
, 
disk_›_s
 *
›
,

234 *
cdbcmd
, 
u16
 
èrgë
, u16 
lun
, u16 
blocksize
)

236 
pvscsi_rög_dsc_s
 *
rög_dsc
 = 
∂un
->ring_dsc;

237 
PVSCSIRögsSèã
 *
s
 = 
rög_dsc
->
rög_°©e
;

238 
u32
 
ªq_íåõs
 = 
s
->
ªqNumE¡rõsLog2
;

239 
u32
 
cmp_íåõs
 = 
s
->
cmpNumE¡rõsLog2
;

240 
PVSCSIRögReqDesc
 *
ªq
;

241 
PVSCSIRögCmpDesc
 *
r•
;

242 
u32
 
°©us
;

244 i‡(
s
->
ªqProdIdx
 - s->
cmpC⁄sIdx
 >1 << 
ªq_íåõs
) {

245 
	`d¥ötf
(1, "pvscsi:Ñing full:ÑeqProdIdx=%d cmpConsIdx=%d\n",

246 
s
->
ªqProdIdx
, s->
cmpC⁄sIdx
);

247  
DISK_RET_EBADTRACK
;

250 
ªq
 = 
rög_dsc
->
rög_ªqs
 + (
s
->
ªqProdIdx
 & 
	`MASK
(
ªq_íåõs
));

251 
	`pvscsi_fûl_ªq
(
s
, 
ªq
, 
èrgë
, 
lun
, 
cdbcmd
, 
blocksize
, 
›
);

253 
	`pvscsi_kick_rw_io
(
∂un
->
ioba£
);

254 
	`pvscsi_waô_öå_cm∂
(
∂un
->
ioba£
);

256 
r•
 = 
rög_dsc
->
rög_cmps
 + (
s
->
cmpC⁄sIdx
 & 
	`MASK
(
cmp_íåõs
));

257 
°©us
 = 
	`pvscsi_gë_r•
(
s
, 
r•
);

259  
°©us
 =0 ? 
DISK_RET_SUCCESS
 : 
DISK_RET_EBADTRACK
;

260 
	}
}

263 
	$pvscsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

265 i‡(!
CONFIG_PVSCSI
)

266  
DISK_RET_EBADTRACK
;

268 
pvscsi_lun_s
 *
∂un
 =

269 
	`c⁄èöî_of
(
›
->
drive_gf
, 
pvscsi_lun_s
, 
drive
);

271  
	`pvscsi_cmd
(
∂un
, 
›
, 
cdbcmd
,Ölun->
èrgë
,Ölun->
lun
, 
blocksize
);

272 
	}
}

275 
	$pvscsi_add_lun
(
pci_devi˚
 *
pci
, *
ioba£
,

276 
pvscsi_rög_dsc_s
 *
rög_dsc
, 
u8
 
èrgë
, u8 
lun
)

278 
pvscsi_lun_s
 *
∂un
 = 
	`mÆloc_f£g
((*plun));

279 i‡(!
∂un
) {

280 
	`w¨n_nﬂŒoc
();

283 
	`mem£t
(
∂un
, 0, (*plun));

284 
∂un
->
drive
.
ty≥
 = 
DTYPE_PVSCSI
;

285 
∂un
->
drive
.
˙é_id
 = 
pci
->
bdf
;

286 
∂un
->
èrgë
 =Åarget;

287 
∂un
->
lun
 =Üun;

288 
∂un
->
ioba£
 = iobase;

289 
∂un
->
rög_dsc
 =Ñing_dsc;

291 *
«me
 = 
	`z≈rötf
(16, "pvscsi %02x:%02x.%x %d:%d",

292 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf),

293 
	`pci_bdf_to_‚
(
pci
->
bdf
), 
èrgë
, 
lun
);

294 
¥io
 = 
	`boŸ¥io_föd_scsi_devi˚
(
pci
, 
èrgë
, 
lun
);

295 
ªt
 = 
	`scsi_drive_£tup
(&
∂un
->
drive
, 
«me
, 
¥io
);

296 
	`‰ì
(
«me
);

297 i‡(
ªt
)

298 
Áû
;

301 
Áû
:

302 
	`‰ì
(
∂un
);

304 
	}
}

307 
	$pvscsi_sˇn_èrgë
(
pci_devi˚
 *
pci
, *
ioba£
,

308 
pvscsi_rög_dsc_s
 *
rög_dsc
, 
u8
 
èrgë
)

311 
	`pvscsi_add_lun
(
pci
, 
ioba£
, 
rög_dsc
, 
èrgë
, 0);

312 
	}
}

315 
	$öô_pvscsi
(
pci_devi˚
 *
pci
)

317 
pvscsi_rög_dsc_s
 *
rög_dsc
 = 
NULL
;

318 
i
;

319 
u16
 
bdf
 = 
pci
->bdf;

320 *
ioba£
 = (*)(
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_BASE_ADDRESS_0
)

321 & 
PCI_BASE_ADDRESS_MEM_MASK
);

323 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

325 
	`d¥ötf
(1, "foundÖvscsiát %02x:%02x.%x, io @ %p\n",

326 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

327 
	`pci_bdf_to_‚
(
bdf
), 
ioba£
);

329 
	`pvscsi_wrôe_cmd_desc
(
ioba£
, 
PVSCSI_CMD_ADAPTER_RESET
, 
NULL
, 0);

331 
	`pvscsi_öô_rögs
(
ioba£
, &
rög_dsc
);

332 
i
 = 0; i < 7; i++)

333 
	`pvscsi_sˇn_èrgë
(
pci
, 
ioba£
, 
rög_dsc
, 
i
);

336 
	}
}

339 
	$pvscsi_£tup
()

341 
	`ASSERT32FLAT
();

342 i‡(! 
CONFIG_PVSCSI
)

345 
	`d¥ötf
(3, "initÖvscsi\n");

347 
pci_devi˚
 *
pci
;

348 
	`f‹óchpci
(
pci
) {

349 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_VMWARE


350 || 
pci
->
devi˚
 !
PCI_DEVICE_ID_VMWARE_PVSCSI
)

352 
	`öô_pvscsi
(
pci
);

354 
	}
}

	@hw/pvscsi.h

1 #i‚de‡
_PVSCSI_H_


2 
	#_PVSCSI_H_


	)

4 
	gdisk_›_s
;

5 
pvscsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

6 
pvscsi_£tup
();

	@hw/ramdisk.c

7 
	~"biosv¨.h
"

8 
	~"block.h
"

9 
	~"bªgs.h
"

10 
	~"mÆloc.h
"

11 
	~"memm≠.h
"

12 
	~"ouçut.h
"

13 
	~"romfûe.h
"

14 
	~"°acks.h
"

15 
	~"°d/disk.h
"

16 
	~"°rög.h
"

17 
	~"utû.h
"

20 
	$ømdisk_£tup
()

22 i‡(!
CONFIG_FLASH_FLOPPY
)

26 
romfûe_s
 *
fûe
 = 
	`romfûe_föd¥efix
("Ê›pyimg/", 
NULL
);

27 i‡(!
fûe
)

29 c⁄° *
fûíame
 = 
fûe
->
«me
;

30 
u32
 
size
 = 
fûe
->size;

31 
	`d¥ötf
(3, "Found fl›py fûê%†o‡sizê%d\n", 
fûíame
, 
size
);

32 
·y≥
 = 
	`föd_Ê›py_ty≥
(
size
);

33 i‡(
·y≥
 < 0) {

34 
	`d¥ötf
(3, "No floppyÅype found forÑamdisk size\n");

39 *
pos
 = 
	`memÆign_tmphigh
(
PAGE_SIZE
, 
size
);

40 i‡(!
pos
) {

41 
	`w¨n_nﬂŒoc
();

44 
	`add_e820
((
u32
)
pos
, 
size
, 
E820_RESERVED
);

47 
ªt
 = 
fûe
->
	`c›y
(fûe, 
pos
, 
size
);

48 i‡(
ªt
 < 0)

52 
drive_s
 *
drive
 = 
	`öô_Ê›py
((
u32
)
pos
, 
·y≥
);

53 i‡(!
drive
)

55 
drive
->
ty≥
 = 
DTYPE_RAMDISK
;

56 
	`d¥ötf
(1, "M≠pög CBFS fl›py %†tÿadd∏%p\n", 
fûíame
, 
pos
);

57 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "Ramdisk [%s]", &
fûíame
[10]);

58 
	`boŸ_add_Ê›py
(
drive
, 
desc
, 
	`boŸ¥io_föd_«med_rom
(
fûíame
, 0));

59 
	}
}

62 
	$ømdisk_c›y
(
disk_›_s
 *
›
, 
iswrôe
)

64 
u32
 
off£t
 = 
	`GET_GLOBALFLAT
(
›
->
drive_gf
->
˙é_id
);

65 
off£t
 +(
u32
)
›
->
lba
 * 
DISK_SECTOR_SIZE
;

66 
u64
 
›d
 = 
GDT_DATA
 | 
	`GDT_LIMIT
(0xfffffË| 
	`GDT_BASE
((
u32
)
›
->
buf_Ê
);

67 
u64
 
ømd
 = 
GDT_DATA
 | 
	`GDT_LIMIT
(0xfffffË| 
	`GDT_BASE
(
off£t
);

69 
u64
 
gdt
[6];

70 i‡(
iswrôe
) {

71 
gdt
[2] = 
›d
;

72 
gdt
[3] = 
ømd
;

74 
gdt
[2] = 
ømd
;

75 
gdt
[3] = 
›d
;

79 
bªgs
 
br
;

80 
	`mem£t
(&
br
, 0, (br));

81 
br
.
Êags
 = 
F_CF
|
F_IF
;

82 
br
.
ah
 = 0x87;

83 
br
.
es
 = 
	`GET_SEG
(
SS
);

84 
br
.
si
 = (
u32
)
gdt
;

85 
br
.
cx
 = 
›
->
cou¡
 * 
DISK_SECTOR_SIZE
 / 2;

86 
	`ˇŒ16_öt
(0x15, &
br
);

88 i‡(
br
.
Êags
 & 
F_CF
)

89  
DISK_RET_EBADTRACK
;

90  
DISK_RET_SUCCESS
;

91 
	}
}

94 
	$¥o˚ss_ømdisk_›
(
disk_›_s
 *
›
)

96 i‡(!
CONFIG_FLASH_FLOPPY
)

99 
›
->
comm™d
) {

100 
CMD_READ
:

101  
	`ømdisk_c›y
(
›
, 0);

102 
CMD_WRITE
:

103  
	`ømdisk_c›y
(
›
, 1);

104 
CMD_VERIFY
:

105 
CMD_FORMAT
:

106 
CMD_RESET
:

107  
DISK_RET_SUCCESS
;

109  
DISK_RET_EPARAM
;

111 
	}
}

	@hw/rtc.c

8 
	~"biosv¨.h
"

9 
	~"πc.h
"

10 
	~"°acks.h
"

11 
	~"utû.h
"

12 
	~"x86.h
"

14 
u8


15 
	$πc_ªad
(
u8
 
ödex
)

17 
ödex
 |
NMI_DISABLE_BIT
;

18 
	`outb
(
ödex
, 
PORT_CMOS_INDEX
);

19  
	`öb
(
PORT_CMOS_DATA
);

20 
	}
}

23 
	$πc_wrôe
(
u8
 
ödex
, u8 
vÆ
)

25 
ödex
 |
NMI_DISABLE_BIT
;

26 
	`outb
(
ödex
, 
PORT_CMOS_INDEX
);

27 
	`outb
(
vÆ
, 
PORT_CMOS_DATA
);

28 
	}
}

31 
	$πc_mask
(
u8
 
ödex
, u8 
off
, u8 
⁄
)

33 
	`outb
(
ödex
, 
PORT_CMOS_INDEX
);

34 
u8
 
vÆ
 = 
	`öb
(
PORT_CMOS_DATA
);

35 
	`outb
((
vÆ
 & ~
off
Ë| 
⁄
, 
PORT_CMOS_DATA
);

36 
	}
}

39 
	$πc_upd©ög
()

49 i‡((
	`πc_ªad
(
CMOS_STATUS_A
Ë& 
RTC_A_UIP
) == 0)

51 
u32
 
íd
 = 
	`timî_ˇlc
(15);

53 i‡((
	`πc_ªad
(
CMOS_STATUS_A
Ë& 
RTC_A_UIP
) == 0)

55 i‡(
	`timî_check
(
íd
))

58 
	`yõld
();

60 
	}
}

63 
	$πc_£tup
()

65 
	`πc_wrôe
(
CMOS_STATUS_A
, 0x26);

66 
	`πc_mask
(
CMOS_STATUS_B
, ~
RTC_B_DSE
, 
RTC_B_24HR
);

67 
	`πc_ªad
(
CMOS_STATUS_C
);

68 
	`πc_ªad
(
CMOS_STATUS_D
);

69 
	}
}

71 
RTCu£rs
 
	gVARLOW
;

74 
	$πc_u£
()

76 
cou¡
 = 
	`GET_LOW
(
RTCu£rs
);

77 
	`SET_LOW
(
RTCu£rs
, 
cou¡
+1);

78 i‡(
cou¡
)

81 
	`πc_mask
(
CMOS_STATUS_B
, 0, 
RTC_B_PIE
);

82 
	}
}

85 
	$πc_ªÀa£
()

87 
cou¡
 = 
	`GET_LOW
(
RTCu£rs
);

88 
	`SET_LOW
(
RTCu£rs
, 
cou¡
-1);

89 i‡(
cou¡
 != 1)

92 
	`πc_mask
(
CMOS_STATUS_B
, 
RTC_B_PIE
, 0);

93 
	}
}

	@hw/rtc.h

1 #i‚de‡
__RTC_H


2 
	#__RTC_H


	)

4 
	#PORT_CMOS_INDEX
 0x0070

	)

5 
	#PORT_CMOS_DATA
 0x0071

	)

8 
	#NMI_DISABLE_BIT
 0x80

	)

11 
	#CMOS_RTC_SECONDS
 0x00

	)

12 
	#CMOS_RTC_SECONDS_ALARM
 0x01

	)

13 
	#CMOS_RTC_MINUTES
 0x02

	)

14 
	#CMOS_RTC_MINUTES_ALARM
 0x03

	)

15 
	#CMOS_RTC_HOURS
 0x04

	)

16 
	#CMOS_RTC_HOURS_ALARM
 0x05

	)

17 
	#CMOS_RTC_DAY_WEEK
 0x06

	)

18 
	#CMOS_RTC_DAY_MONTH
 0x07

	)

19 
	#CMOS_RTC_MONTH
 0x08

	)

20 
	#CMOS_RTC_YEAR
 0x09

	)

21 
	#CMOS_STATUS_A
 0x0a

	)

22 
	#CMOS_STATUS_B
 0x0b

	)

23 
	#CMOS_STATUS_C
 0x0c

	)

24 
	#CMOS_STATUS_D
 0x0d

	)

25 
	#CMOS_RESET_CODE
 0x0f

	)

29 
	#CMOS_FLOPPY_DRIVE_TYPE
 0x10

	)

30 
	#CMOS_DISK_DATA
 0x12

	)

31 
	#CMOS_EQUIPMENT_INFO
 0x14

	)

32 
	#CMOS_DISK_DRIVE1_TYPE
 0x19

	)

33 
	#CMOS_DISK_DRIVE2_TYPE
 0x1a

	)

34 
	#CMOS_DISK_DRIVE1_CYL
 0x1b

	)

35 
	#CMOS_DISK_DRIVE2_CYL
 0x24

	)

36 
	#CMOS_MEM_EXTMEM_LOW
 0x30

	)

37 
	#CMOS_MEM_EXTMEM_HIGH
 0x31

	)

38 
	#CMOS_CENTURY
 0x32

	)

39 
	#CMOS_MEM_EXTMEM2_LOW
 0x34

	)

40 
	#CMOS_MEM_EXTMEM2_HIGH
 0x35

	)

41 
	#CMOS_BIOS_BOOTFLAG1
 0x38

	)

42 
	#CMOS_BIOS_DISKTRANSFLAG
 0x39

	)

43 
	#CMOS_BIOS_BOOTFLAG2
 0x3d

	)

44 
	#CMOS_MEM_HIGHMEM_LOW
 0x5b

	)

45 
	#CMOS_MEM_HIGHMEM_MID
 0x5c

	)

46 
	#CMOS_MEM_HIGHMEM_HIGH
 0x5d

	)

47 
	#CMOS_BIOS_SMP_COUNT
 0x5f

	)

50 
	#RTC_A_UIP
 0x80

	)

52 
	#RTC_B_SET
 0x80

	)

53 
	#RTC_B_PIE
 0x40

	)

54 
	#RTC_B_AIE
 0x20

	)

55 
	#RTC_B_UIE
 0x10

	)

56 
	#RTC_B_BIN
 0x04

	)

57 
	#RTC_B_24HR
 0x02

	)

58 
	#RTC_B_DSE
 0x01

	)

60 #i‚de‡
__ASSEMBLY__


62 
	~"ty≥s.h
"

65 
u8
 
πc_ªad
(u8 
ödex
);

66 
πc_wrôe
(
u8
 
ödex
, u8 
vÆ
);

67 
πc_mask
(
u8
 
ödex
, u8 
off
, u8 
⁄
);

68 
πc_upd©ög
();

69 
πc_£tup
();

70 
πc_u£
();

71 
πc_ªÀa£
();

74 
	scmos_íåõs
 {

75 
u32
 
	mèg
;

76 
u32
 
	msize
;

77 
u32
 
	mbô
;

78 
u32
 
	mÀngth
;

79 
u32
 
	mc⁄fig
;

80 
u32
 
	mc⁄fig_id
;

81 
	#CMOS_MAX_NAME_LENGTH
 32

	)

82 
u8
 
	m«me
[
CMOS_MAX_NAME_LENGTH
];

	@hw/sd.c

15 
	~<°döt.h
>

16 
	~<°dboﬁ.h
>

17 
	~"°rög.h
"

18 
	~"utû.h
"

19 
	~"mÆloc.h
"

20 
	~"ouçut.h
"

21 
	~"c⁄fig.h
"

22 
	~"sd.h
"

27 
boﬁ
 
sdHo°X„r
–
sdHc_t
* 
pHo°
, 
sdX„r_t
* 
pX„r
 );

28 
boﬁ
 
sdAµS≥cificHo°X„r
–
sdHc_t
* 
pHo°
, 
sdX„r_t
* 
pX„r
 );

31 
boﬁ
 
sdSñe˘De£À˘C¨d
–
sdC¨d_t
* 
pC¨d
 );

34 
boﬁ
 
sdIdÀ
–
sdC¨d_t
* 
pC¨d
 );

35 
boﬁ
 
sdSídIfC⁄d
–
sdC¨d_t
* 
pC¨d
 );

36 
boﬁ
 
sdSídOpC⁄d
–
sdC¨d_t
* 
pC¨d
 );

37 
boﬁ
 
sdSídCSD
–
sdC¨d_t
* 
pC¨d
 );

38 
boﬁ
 
sdAŒSídCID
–
sdC¨d_t
* 
pC¨d
 );

39 
boﬁ
 
sdSídRñ©iveAddr
–
sdC¨d_t
* 
pC¨d
 );

40 
boﬁ
 
sdC¨dIdítifiˇti⁄Mode
–
sdC¨d_t
* 
pC¨d
 );

53 
boﬁ
 
	$sdHo°X„r
–
sdHc_t
* 
pHo°
, 
sdX„r_t
* 
pX„r
 )

55 
boﬁ
 
°©us
 = 
Ál£
;

57 
	`d¥ötf
–
DEBUG_HDL_SD
,

58 "SD c¨d: Sídög CMD%u wôhárg1 0x%08x\n", 
pX„r
->
cmdIdx
,ÖX„r->
¨g1
 );

60 
°©us
 = 
pHo°
->
	`sdhcCmd
–pHo°, 
pX„r
 );

61 if–
°©us
 )

63  
pX„r
->
r•Ty≥
 )

65 
eR•136
:

66 
	`d¥ötf
–
DEBUG_HDL_SD
,

68 
pX„r
->
ª•⁄£
[0],

69 
pX„r
->
ª•⁄£
[1],

70 
pX„r
->
ª•⁄£
[2],

71 
pX„r
->
ª•⁄£
[3] );

74 
eR•48
:

75 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD card: Response 48: 0x%08x\n",

76 
pX„r
->
ª•⁄£
[0] );

79 
eR•48_busy
:

80 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD card: Response 48 with busy signal: 0x%08x\n",

81 
pX„r
->
ª•⁄£
[0] );

84 
eR•N⁄e
:

92 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD c¨d: FaûedÅÿª•⁄dÅÿCMD%u\n", 
pX„r
->
cmdIdx
 );

95  
°©us
;

96 
	}
}

109 
boﬁ
 
	$sdAµS≥cificHo°X„r
–
sdHc_t
* 
pHo°
, 
sdX„r_t
* 
pX„r
 )

111 
boﬁ
 
°©us
 = 
Ál£
;

112 
sdX„r_t
 
x„r
;

114 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

115 
x„r
.
cmdIdx
 = 
MMC_APP_CMD55
;

116 
x„r
.
¨g1
 = 0;

117 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

118 
x„r
.
r•Ty≥
 = 
eR•48
;

119 
x„r
.
x„rTy≥
 = 
eWrX„r
;

120 
x„r
.
pD©a
 = 
NULL
;

123 
°©us
 = 
	`sdHo°X„r
–
pHo°
, &
x„r
 );

124 if–
°©us
 )

127 
°©us
 = 
	`sdHo°X„r
–
pHo°
, 
pX„r
 );

130  
°©us
;

131 
	}
}

141 
boﬁ
 
	$sdSñe˘De£À˘C¨d
–
sdC¨d_t
* 
pC¨d
 )

143 
boﬁ
 
°©us
 = 
Ál£
;

144 
sdX„r_t
 
x„r
;

147 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

148 
x„r
.
cmdIdx
 = 
MMC_SELECT_CARD_CMD7
;

149 
x„r
.
¨g1
 = (
uöt32_t
)(
pC¨d
->
rˇ
) << 16;

150 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

151 
x„r
.
r•Ty≥
 = 
eR•48_busy
;

152 
x„r
.
x„rTy≥
 = 
eWrX„r
;

153 
x„r
.
pD©a
 = 
NULL
;

156 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

158 if(
°©us
)

160 
pC¨d
->
isSñe˘ed
 =ÖC¨d->isSñe˘ed =
åue
 ? 
Ál£
 :Årue;

163  
°©us
;

164 
	}
}

175 
boﬁ
 
	$sdRódSögÀBlock
–
sdC¨d_t
* 
pC¨d
, 
uöt8_t
* 
pD©a
, 
uöt32_t
 
addr
 )

177 
boﬁ
 
°©us
 = 
Ál£
;

178 
sdX„r_t
 
x„r
;

180 if–!
pC¨d
->
isSñe˘ed
 )

183 
	`sdSñe˘De£À˘C¨d
–
pC¨d
 );

187 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

188 
x„r
.
cmdIdx
 = 
MMC_READ_SINGLE_BLOCK_CMD17
;

189 
x„r
.
¨g1
 = 
addr
;

190 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

191 
x„r
.
r•Ty≥
 = 
eR•48
;

192 
x„r
.
x„rTy≥
 = 
eRdX„r
;

193 
x„r
.
pD©a
 =ÖData;

194 
	`d¥ötf
–
DEBUG_HDL_SD
, "----ÖD©®addªss: 0x%08x ----\n", (
uöt32_t
)
pD©a
);

197 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

199  
°©us
;

200 
	}
}

202 
boﬁ
 
	$sdRódMu…ùÀBlock
–
sdC¨d_t
* 
pC¨d
 )

204 
boﬁ
 
°©us
 = 
Ál£
;

206  
°©us
;

207 
	}
}

209 
boﬁ
 
	$sdSt›Tønsmissi⁄
–
sdC¨d_t
* 
pC¨d
 )

211 
boﬁ
 
°©us
 = 
Ál£
;

213  
°©us
;

214 
	}
}

224 
boﬁ
 
	$sdIdÀ
–
sdC¨d_t
* 
pC¨d
 )

226 
boﬁ
 
°©us
 = 
Ál£
;

227 
sdX„r_t
 
x„r
;

230 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

231 
x„r
.
cmdIdx
 = 
MMC_GO_IDLE_STATE_CMD0
;

232 
x„r
.
¨g1
 = 0;

233 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

234 
x„r
.
r•Ty≥
 = 
eR•N⁄e
;

235 
x„r
.
x„rTy≥
 = 
eWrX„r
;

236 
x„r
.
pD©a
 = 
NULL
;

239 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

241  
°©us
;

242 
	}
}

252 
boﬁ
 
	$sdSídIfC⁄d
–
sdC¨d_t
* 
pC¨d
 )

254 
boﬁ
 
°©us
 = 
Ál£
;

255 
sdX„r_t
 
x„r
;

256 
uöt32_t
 
cy˛eTrõs
 = 1;

266 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

267 
x„r
.
cmdIdx
 = 
SD_SEND_IF_COND_CMD8
;

270 
x„r
.
¨g1
 = 
SD_VOLTAGE_RANGE_270_360
 | 
SD_IF_COND_ECHO
;

271 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

272 
x„r
.
r•Ty≥
 = 
eR•48
;

273 
x„r
.
x„rTy≥
 = 
eWrX„r
;

274 
x„r
.
pD©a
 = 
NULL
;

277  
cy˛eTrõs
-- )

279 if–
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 ) )

281 if–
x„r
.
ª•⁄£
[0] =x„r.
¨g1
 )

283 
°©us
 = 
åue
;

286 
	`u¶ìp
(100);

289 if–!
°©us
 )

291 
	`d¥ötf
( 6, "SD: cardÇotÖresent orÇot supported inÅheÖresent operating conditions\n" );

293  
°©us
;

294 
	}
}

306 
boﬁ
 
	$sdSídOpC⁄d
–
sdC¨d_t
* 
pC¨d
 )

308 
boﬁ
 
°©us
 = 
Ál£
;

309 
sdX„r_t
 
x„r
;

310 
uöt32_t
 
cy˛eTrõs
 = 
SD_STATE_CHANGE_ATTEMPTS
;

314 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

315 
x„r
.
cmdIdx
 = 
SD_APP_SEND_OP_COND_CMD41
;

316 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

317 
x„r
.
r•Ty≥
 = 
eR•48
;

318 
x„r
.
x„rTy≥
 = 
eWrX„r
;

319 
x„r
.
pD©a
 = 
NULL
;

322 
x„r
.
¨g1
 |
pC¨d
->
pHo°
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_180
 ? 
VDD_S18A
 : 0;

323 
x„r
.
¨g1
 |
pC¨d
->
pHo°
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_300
 ? 
VDD_RANGE_27_30
 : 0;

324 
x„r
.
¨g1
 |
pC¨d
->
pHo°
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_330
 ? 
VDD_RANGE_30_33
 : 0;

327 
x„r
.
¨g1
 |
HCS
;

329  
cy˛eTrõs
-- )

331 
°©us
 = 
	`sdAµS≥cificHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

332 if–
°©us
 )

336 if–
x„r
.
ª•⁄£
[0] & 
OCR_DONE_BSY_N
 )

338 
pC¨d
->
o¸
 = 
x„r
.
ª•⁄£
[0];

339 
pC¨d
->
xchcC¨d
 = (
HCS
 =’C¨d->
o¸
 & HCS));

344 
	`udñay
(100);

348  
°©us
;

349 
	}
}

358 
boﬁ
 
	$sdSídCSD
–
sdC¨d_t
* 
pC¨d
 )

360 
boﬁ
 
°©us
 = 
Ál£
;

361 
sdX„r_t
 
x„r
;

362 
uöt32_t
 
cy˛eTrõs
 = 
SD_TRY_AGAIN
;

364 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

365 
x„r
.
cmdIdx
 = 
MMC_SEND_CSD_CMD9
;

366 
x„r
.
¨g1
 = (
uöt32_t
)(
pC¨d
->
rˇ
) << 16;

367 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

368 
x„r
.
r•Ty≥
 = 
eR•136
;

369 
x„r
.
x„rTy≥
 = 
eWrX„r
;

370 
x„r
.
pD©a
 = 
NULL
;

371  
cy˛eTrõs
-- )

373 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

374 if–
°©us
 )

377 
	`memmove
–
x„r
.
ª•⁄£
, (*)(((
uöt8_t
*)(xfer.response)) - 1), (xfer.response ) );

378 
pC¨d
->
csd
[0] = 
x„r
.
ª•⁄£
[3];

379 
pC¨d
->
csd
[1] = 
x„r
.
ª•⁄£
[2];

380 
pC¨d
->
csd
[2] = 
x„r
.
ª•⁄£
[1];

381 
pC¨d
->
csd
[3] = 
x„r
.
ª•⁄£
[0];

382 
	`decode_csd_sd
–
pC¨d
->
csd
, &pC¨d->
decode
.
csdDecode
 );

387  
°©us
;

388 
	}
}

399 
boﬁ
 
	$sdAŒSídCID
–
sdC¨d_t
* 
pC¨d
 )

401 
boﬁ
 
°©us
 = 
Ál£
;

402 
sdX„r_t
 
x„r
;

403 
uöt32_t
 
cy˛eTrõs
 = 
SD_TRY_AGAIN
;

405 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

406 
x„r
.
cmdIdx
 = 
MMC_ALL_SEND_CID_CMD2
;

407 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

408 
x„r
.
r•Ty≥
 = 
eR•136
;

409 
x„r
.
x„rTy≥
 = 
eWrX„r
;

410 
x„r
.
pD©a
 = 
NULL
;

411  
cy˛eTrõs
-- )

413 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

414 if–
°©us
 )

417 
	`memmove
–
x„r
.
ª•⁄£
, (*)(((
uöt8_t
*)(xfer.response)) - 1), (xfer.response ) );

420 
pC¨d
->
cid
[0] = 
x„r
.
ª•⁄£
[3];

421 
pC¨d
->
cid
[1] = 
x„r
.
ª•⁄£
[2];

422 
pC¨d
->
cid
[2] = 
x„r
.
ª•⁄£
[1];

423 
pC¨d
->
cid
[3] = 
x„r
.
ª•⁄£
[0];

424 
	`decode_cid_sd
–
pC¨d
->
cid
, &pC¨d->
decode
.
cidDecode
 );

429  
°©us
;

431 
	}
}

443 
boﬁ
 
	$sdSídRñ©iveAddr
–
sdC¨d_t
* 
pC¨d
 )

445 
boﬁ
 
°©us
 = 
Ál£
;

446 
sdX„r_t
 
x„r
;

447 
uöt32_t
 
cy˛eTrõs
 = 
SD_TRY_AGAIN
;

448 
sdC¨dSèã_e
 
cuºítSèã
 = 
eInvÆid
;

450 
	`mem£t
–&
x„r
, 0, –
sdX„r_t
 ) );

451 
x„r
.
cmdIdx
 = 
MMC_SET_RELATIVE_ADDR_CMD3
;

452 
x„r
.
cmdTy≥
 = 
eCmdN‹mÆ
;

453 
x„r
.
r•Ty≥
 = 
eR•48
;

454 
x„r
.
x„rTy≥
 = 
eWrX„r
;

455 
x„r
.
pD©a
 = 
NULL
;

456  
cy˛eTrõs
-- )

458 
°©us
 = 
	`sdHo°X„r
–
pC¨d
->
pHo°
, &
x„r
 );

459 if–
°©us
 )

463 
pC¨d
->
rˇ
 = (
uöt16_t
)(
x„r
.
ª•⁄£
[0] >> 16);

464 if–
x„r
.
ª•⁄£
[0] & 
RCAERROR_MSK
 )

466 
	`d¥ötf
–
DEBUG_HDL_SD
,

468 
x„r
.
ª•⁄£
[0] & 
RCAERROR_MSK
 );

469 
°©us
 = 
Ál£
;

475 
cuºítSèã
 = (
sdC¨dSèã_e
)((
x„r
.
ª•⁄£
[0] & 
RCASTATUS_CURRENT_STATE
) >> 9);

476 if–
cuºítSèã
 =
eStby
 )

478 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD c¨d: Cuºíà°©êi†°by: 0x%02x - \n", 
cuºítSèã
 );

483  
°©us
;

485 
	}
}

496 
boﬁ
 
	$sdC¨dIdítifiˇti⁄Mode
–
sdC¨d_t
* 
pC¨d
 )

498 
boﬁ
 
°©us
 = 
Ál£
;

499 
uöt32_t
 
cy˛eTrõs
 = 
NUM_INIT_ATTEMPTS
;

501 
	`ASSERT32FLAT
();

502  
cy˛eTrõs
-- )

505 if–!(
°©us
 = 
	`sdSídIfC⁄d
–
pC¨d
 )) )

509 if–!(
°©us
 = 
	`sdSídOpC⁄d
–
pC¨d
 )) )

517 if–!(
°©us
 = 
	`sdAŒSídCID
–
pC¨d
 )) )

521 if–!(
°©us
 = 
	`sdSídRñ©iveAddr
–
pC¨d
 )) )

525 if–!(
°©us
 = 
	`sdSídCSD
–
pC¨d
 )) )

529 if–
°©us
 =
åue
 )

531 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD card: Initialization of sd card is complete:\n" );

532 
	`d¥ötf
–
DEBUG_HDL_SD
, " - currrent card state: standby\n");

533 
	`d¥ötf
–
DEBUG_HDL_SD
, " - RCA: 0x%04x\n", 
pC¨d
->
rˇ
 );

534 
	`d¥ötf
–
DEBUG_HDL_SD
, " - OCR: 0x%08x\n", 
pC¨d
->
o¸
 );

535 
	`d¥ötf
–
DEBUG_HDL_SD
,

537 
pC¨d
->
cid
[0],ÖCard->cid[1],ÖCard->cid[2],ÖCard->cid[3] );

538 
	`d¥ötf
–
DEBUG_HDL_SD
,

540 
pC¨d
->
csd
[0],ÖCard->csd[1],ÖCard->csd[2],ÖCard->csd[3] );

541 
	`d¥ötf
–
DEBUG_HDL_SD
, " - cardÅype is ");

542 if–
pC¨d
->
xchcC¨d
 )

544 
	`d¥ötf
–
DEBUG_HDL_SD
, "SDXC/SDHC\n" );

548 
	`d¥ötf
–
DEBUG_HDL_SD
, "Normal SD\n" );

555  
°©us
;

556 
	}
}

570 
boﬁ
 
	$sdC¨dBusInô
–
sdHc_t
* 
pHc
 )

572 
boﬁ
 
°©us
 = 
Ál£
;

575 
sdC¨d_t
* 
pC¨d
 = 
	`mÆloc_f£g
( ( sdCard_t ) );

576 if–!
pC¨d
 )

578 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: card failedÅoállocate\n" );

579  
°©us
;

581 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:ÖC¨dáddªss: 0x%08x\n", (
uöt32_t
)
pC¨d
);

584 
pC¨d
->
pHo°
 = 
pHc
;

587 
°©us
 = 
	`sdIdÀ
–
pC¨d
 );

589 if–
°©us
 )

592 
pC¨d
->
ˇrdInôülized
 = 
	`sdC¨dIdítifiˇti⁄Mode
(ÖCard );

595 if–!
pC¨d
->
ˇrdInôülized
 )

597 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: Card init failed, check card...\n");

598 
°©us
 = 
pC¨d
->
ˇrdInôülized
;

599 
	`‰ì
–
pC¨d
 );

605 
pHc
->
pC¨d
 =ÖCard;

607  
°©us
;

608 
	}
}

	@hw/sd.h

15 #i‚de‡
__SD_H


16 
	#__SD_H


	)

18 
	~<°döt.h
>

19 
	~<°dboﬁ.h
>

20 
	~"sd_utûs.h
"

24 
	~"sdhci.h
"

29 
uöt32_t
 
	mˇp1
;

30 
uöt32_t
 
	mˇp2
;

31 }
	tˇ∑bûôõs_t
;

35 
	meCmdN‹mÆ
 = 
SDHCI_CMD_TYPE_NORMAL
,

36 
	meCmdSu•íd
 = 
SDHCI_CMD_TYPE_SUSPEND
,

37 
	meCmdResume
 = 
SDHCI_CMD_TYPE_RESUME
,

38 
	meCmdAb‹t
 = 
SDHCI_CMD_TYPE_ABORT


39 }
	tsdCmdTy≥_e
;

43 
	meR•N⁄e
 = 
SDHCI_CMD_RESP_NONE
,

44 
	meR•136
 = 
SDHCI_CMD_RESP_LONG
,

45 
	meR•48
 = 
SDHCI_CMD_RESP_SHORT
,

46 
	meR•48_busy
 = 
SDHCI_CMD_RESP_SHORT_BUSY


47 }
	tsdR•Ty≥_e
;

51 
	meSdS≥cV_1_00
 = 0,

52 
	meSdS≥cV_2_00
,

53 
	meSdS≥cV_3_00


54 }
	tsdS≥cVî_e
;

58 
	meRdX„r
 = 0,

59 
	meWrX„r


60 }
	tsdX„rTy≥_e
;

64 
boﬁ
 
	midxChkEn
;

65 
boﬁ
 
	m¸cChkEn
;

66 }
	tsdX„rFœgs_t
;

71 
uöt8_t
 
	mcmdIdx
;

72 
uöt32_t
 
	m¨g1
;

73 
sdCmdTy≥_e
 
	mcmdTy≥
;

74 
sdR•Ty≥_e
 
	mr•Ty≥
;

75 
sdX„rTy≥_e
 
	mx„rTy≥
;

76 
uöt32_t
 
	mª•⁄£
[4];

77 
boﬁ
 
	mr•VÆid
;

78 * 
	mpD©a
;

79 }
	tsdX„r_t
;

84 
sd_cid_t
 
	mcidDecode
;

85 
sd_csd_t
 
	mcsdDecode
;

86 }
	tsdRegDecode_t
;

89 
	gsdC¨d_t
;

90 
sdC¨d_t
 
	tsdC¨d_t
;

92 
	ssdHc_t


94 
uöt32_t
 
	mb¨Addªss
;

95 
ˇ∑bûôõs_t
 
	mˇrdC≠abûôõs
;

96 
uöt32_t
 
	mmaxClk
;

97 
uöt32_t
 
	mtmoClk
;

98 
uöt32_t
 
	mcurClk
;

99 
uöt32_t
 
	mblkSize
;

100 
uöt32_t
 
	mpwrMode
;

101 
boﬁ
 
	m¸cCheckE«bÀ
;

102 
boﬁ
 
	mödexCheckE«bÀ
;

103 
boﬁ
 
	mxchcSuµ‹ãd
;

104 
boﬁ
 
	misInôülized
;

105 
uöt8_t
 
	mho°Víd‹Id
;

106 
uöt8_t
 
	mho°S≥cId
;

107 
sdC¨d_t
* 
	mpC¨d
;

110 
boﬁ
 (*
sdhcCmd
)–
sdHc_t
* 
	mpSdCål
, 
sdX„r_t
* 
	mx„r
 );

111 }
	tsdHc_t
;

116 
	ssdC¨d_t


118 
sdHc_t
* 
	mpHo°
;

119 
uöt32_t
 
	mcid
[4];

120 
uöt16_t
 
	mrˇ
;

121 
uöt16_t
 
	md§
;

122 
uöt32_t
 
	mcsd
[4];

123 
uöt32_t
 
	ms¸
[2];

124 
uöt32_t
 
	mo¸
;

125 
uöt32_t
 
	ms§
[16];

126 
uöt32_t
 
	mc§
;

127 
sdRegDecode_t
 
	mdecode
;

128 
boﬁ
 
	mxchcC¨d
;

129 
boﬁ
 
	mˇrdInôülized
;

130 
boﬁ
 
	misSñe˘ed
;

131 }
	tsdC¨d_t
;

133 
	#BLOCK_SIZE8
 512

	)

134 
	#MHZ
 1000000

	)

135 
	#KHZ
 1000

	)

136 
	#BLOCK_MASK
 0x00000FFF

	)

139 
	#MMC_GO_IDLE_STATE_CMD0
 0

	)

140 
	#MMC_SEND_OP_COND_CMD1
 1

	)

141 
	#MMC_ALL_SEND_CID_CMD2
 2

	)

142 
	#MMC_SET_RELATIVE_ADDR_CMD3
 3

	)

143 
	#MMC_SET_DSR_CMD4
 4

	)

144 
	#MMC_SWITCH_CMD6
 6

	)

145 
	#MMC_SELECT_CARD_CMD7
 7

	)

146 
	#MMC_SEND_EXT_CSD_CMD8
 8

	)

147 
	#MMC_SEND_CSD_CMD9
 9

	)

148 
	#MMC_SEND_CID_CMD10
 10

	)

149 
	#MMC_STOP_TRANSMISSION_CMD12
 12

	)

150 
	#MMC_SEND_STATUS_CMD13
 13

	)

151 
	#MMC_SET_BLOCKLEN_CMD16
 16

	)

152 
	#MMC_READ_SINGLE_BLOCK_CMD17
 17

	)

153 
	#MMC_READ_MULTIPLE_BLOCK_CMD18
 18

	)

154 
	#MMC_WRITE_SINGLE_BLOCK_CMD24
 24

	)

155 
	#MMC_WRITE_MULTIPLE_BLOCK_CMD25
 25

	)

156 
	#MMC_ERASE_GROUP_START_CMD35
 35

	)

157 
	#MMC_ERASE_GROUP_END_CMD36
 36

	)

158 
	#MMC_ERASE_CMD38
 38

	)

159 
	#MMC_APP_CMD55
 55

	)

160 
	#MMC_SPI_READ_OCR_CMD58
 58

	)

161 
	#MMC_SPI_CRC_ON_OFF_CMD59
 59

	)

164 
	#SD_SEND_RELATIVE_ADDR_CMD3
 3

	)

165 
	#SD_SWITCH_FUNC_CMD6
 6

	)

166 
	#SD_SEND_IF_COND_CMD8
 8

	)

167 
	#SD_APP_SET_BUS_WIDTH_CMD6
 6

	)

168 
	#SD_ERASE_WR_BLK_START_CMD32
 32

	)

169 
	#SD_ERASE_WR_BLK_END_CMD33
 33

	)

170 
	#SD_APP_SEND_OP_COND_CMD41
 41

	)

171 
	#SD_APP_SEND_SCR_CMD51
 51

	)

174 
	#SD_VOLTAGE_RANGE_270_360
 0x00000100

	)

175 
	#SD_IF_COND_ECHO
 0x000000AA

	)

176 
	#SD_STATE_CHANGE_ATTEMPTS
 1000

	)

177 
	#SD_TRY_AGAIN
 10

	)

181 
	#OCR_DONE_BSY_N
 (1 << 31)

	)

182 
	#HCS_SHIFT
 30

	)

183 
	#HCS
 (1 << 
HCS_SHIFT
)

	)

184 
	#XPC_SHIFT
 28

	)

185 
	#XPC
 (1 << 
XPC_SHIFT
)

	)

186 
	#S18R_SHIFT
 24

	)

187 
	#S18R
 (1 << 
S18R_SHIFT
)

	)

188 
	#OCR_SHIFT
 8

	)

189 
	#OCR
 (0xFF << 
OCR_SHIFT
)

	)

192 
	#VDD_27_28
 (1 << 15)

	)

193 
	#VDD_28_29
 (1 << 16)

	)

194 
	#VDD_29_30
 (1 << 17)

	)

195 
	#VDD_30_31
 (1 << 18)

	)

196 
	#VDD_31_32
 (1 << 19)

	)

197 
	#VDD_32_33
 (1 << 20)

	)

198 
	#VDD
 33
	`_34
 (1 << 21)

	)

199 
	#VDD_34_35
 (1 << 22)

	)

200 
	#VDD_35_36
 (1 << 23)

	)

201 
	#VDD_S18A
 (1 << 24)

	)

204 
	#VDD_MASK
 ( 
VDD_27_28
 | 
VDD_28_29
 | 
VDD_29_30
 | 
VDD_30_31
 | 
VDD_31_32
 | 
VDD_32_33
 | 
VDD
 33
_34
 | 
VDD_34_35
 | 
VDD_35_36
 )

	)

205 
	#VDD_RANGE_27_30
 ( 
VDD_27_28
 | 
VDD_28_29
 | 
VDD_29_30
 )

	)

206 
	#VDD_RANGE_30_33
 ( 
VDD_30_31
 | 
VDD_31_32
 | 
VDD_32_33
 )

	)

207 
	#VDD_RANGE_33_36
 ( 
VDD
 33
_34
 | 
VDD_34_35
 | 
VDD_35_36
 )

	)

209 
	#CARD_UHS_II_STATUS
 (1 << 29)

	)

210 
	#CARD_CAPACITY_STATUS
 (1 << 30)

	)

211 
	#CARD_POWER_UP_BUSY
 (1 << 31)

	)

214 
	#SDCARD_OUT_OF_RANGE
 (1 << 31)

	)

215 
	#SDCARD_ADDRESS_ERROR
 (1 << 30)

	)

216 
	#SDCARD_BLOCK_LEN_ERROR
 (1 << 29)

	)

217 
	#SDCARD_ERASE_SEQ_ERROR
 (1 << 28)

	)

218 
	#SDCARD_ERASE_PARAM
 (1 << 27)

	)

219 
	#SDCARD_WP_VIOLATION
 (1 << 26)

	)

220 
	#SDCARD_CARD_IS_LOCKED
 (1 << 25)

	)

221 
	#SDCARD_LOCK_UNLOCK_FAILED
 (1 << 24)

	)

222 
	#SDCARD_COM_CRC_ERROR
 (1 << 23)

	)

223 
	#SDCARD_ILLEGAL_COMMAND
 (1 << 22)

	)

224 
	#SDCARD_CARD_ECC_FAILED
 (1 << 21)

	)

225 
	#SDCARD_CC_ERROR
 (1 << 20)

	)

226 
	#SDCARD_ERROR
 (1 << 19)

	)

227 
	#SDCARD_CSD_OVERWRITE
 (1 << 16)

	)

228 
	#SDCARD_WP_ERASE_SKIP
 (1 << 15)

	)

229 
	#SDCARD_CARD_ECC_DISABLED
 (1 << 14)

	)

230 
	#SDCARD_ERASE_RESET
 (1 << 13)

	)

231 
	#SDCARD_CURRENT_STATE
 (0xF << 9)

	)

232 
	#SDCARD_READY_FOR_DATA
 (1 << 8)

	)

233 
	#SDCARD_APP_CMD
 (1 << 5)

	)

234 
	#SDCARD_AKE_SEQ_ERROR
 (1 << 3)

	)

237 
	#RCASTATUS_COM_CRC_ERROR
 (1 << 15)

	)

238 
	#RCASTATUS_ILLEGAL_COMMAND
 (1 << 14)

	)

239 
	#RCASTATUS_ERROR
 (1 << 13)

	)

240 
	#RCASTATUS_CURRENT_STATE
 (
SDCARD_CURRENT_STATE
)

	)

241 
	#RCASTATUS_READY_FOR_DATA
 (
SDCARD_READY_FOR_DATA
)

	)

242 
	#RCASTATUS_APP_CMD
 (
SDCARD_APP_CMD
)

	)

243 
	#RCASTATUS_AKE_SEQ_ERROR
 (
SDCARD_AKE_SEQ_ERROR
)

	)

245 
	#RCAERROR_MSK
 (
RCASTATUS_COM_CRC_ERROR
 | 
RCASTATUS_ILLEGAL_COMMAND
 | 
RCASTATUS_ERROR
)

	)

249 
	meIdÀ
 = 0,

250 
	meRódy
,

251 
	meIdít
,

252 
	meStby
,

253 
	meTøn
,

254 
	meD©a
,

255 
	meRcv
,

256 
	mePrg
,

257 
	meDis
,

258 
	meInvÆid


259 }
	tsdC¨dSèã_e
;

261 
	#NUM_INIT_ATTEMPTS
 2

	)

263 
boﬁ
 
sdC¨dBusInô
–
sdHc_t
* 
pHc
 );

264 
boﬁ
 
sdRódSögÀBlock
–
sdC¨d_t
* 
pC¨d
, 
uöt8_t
* 
pD©a
, 
uöt32_t
 
addr
 );

265 
boﬁ
 
sdRódMu…ùÀBlock
–
sdC¨d_t
* 
pC¨d
 );

266 
boﬁ
 
sdSt›Tønsmissi⁄
–
sdC¨d_t
* 
pC¨d
 );

	@hw/sd_if.c

15 
	~"°acks.h
"

16 
	~"°rög.h
"

17 
	~"mÆloc.h
"

18 
	~"utû.h
"

19 
	~"ouçut.h
"

20 
	~"biosv¨.h
"

21 
	~"pci.h
"

22 
	~"pci_ids.h
"

23 
	~"°d/disk.h
"

24 
	~"b¨.h
"

25 
	~"sdhci.h
"

26 
	~"sdhc_gíîic.h
"

27 
	~"sd_if.h
"

30 
sdDiskIf_t
* 
	gg_pDev
;

32 
sd_disk_ªad
–
disk_›_s
* 
›
 );

33 
sd_disk_ªad_Æig√d
–
disk_›_s
* 
›
 );

42 
	$sd_disk_öô
–
sdDiskIf_t
* 
pSdIf
 )

44 
pSdIf
->
drive
.
blksize
 =ÖSdIf->
pHo°Cål
->
blkSize
;

45 
pSdIf
->
drive
.
ty≥
 = 
DTYPE_SD
;

46 
pSdIf
->
drive
.
˙é_id
 = 0;

47 
pSdIf
->
drive
.
ªmovabÀ
 = 
Ál£
;

48 
pSdIf
->
drive
.
å™¶©i⁄
 = 
TRANSLATION_LBA
;

50 
pSdIf
->
drive
.
£˘‹s
 =ÖSdIf->
pHo°Cål
->
pC¨d
->
decode
.
csdDecode
.
ˇ∑côy
 >> 9;

51 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:Çum se˘‹s: %d\n", (
uöt32_t
)
pSdIf
->
drive
.
£˘‹s
 );

54 
pSdIf
->
desc
 = 
	`z≈rötf
–
MAXDESCSIZE
,

56 
pSdIf
->
pHo°Cål
->
ho°Víd‹Id
 );

58 
pSdIf
->
boŸPri‹ôy
 = 
	`boŸ¥io_föd_pci_devi˚
–(
pci_devi˚
*ÌSdIf->
pPci
 );

59 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD c¨d boŸÖri‹ôy: 0x%08x\n", 
pSdIf
->
boŸPri‹ôy
 );

62 
	`boŸ_add_hd
(&
pSdIf
->
drive
,ÖSdIf->
desc
, (ÌSdIf->
boŸPri‹ôy
 );

63 
	}
}

74 
boﬁ
 
	$sd_ho°_£tup
–
sdDiskIf_t
* 
pSdIf
)

76 
boﬁ
 
°©us
 = 
Ál£
;

79 if–
	`sdhc_öô
–
pSdIf
->
pHo°Cål
 ) )

82 if–
	`sdC¨dBusInô
–
pSdIf
->
pHo°Cål
 ) )

84 
	`sd_disk_öô
–
pSdIf
 );

87 
	`sdhc_¥ïBoŸ
–
pSdIf
->
pHo°Cål
 );

88 
°©us
 = 
åue
;

91  
°©us
;

92 
	}
}

102 
boﬁ
 
	$sd_ˇrd_dëe˘
–
sdDiskIf_t
* 
pSdIf
 )

104 
boﬁ
 
°©us
 = 
Ál£
;

105 
uöt32_t
 
ªgVÆ32
 = 0;

108 
ªgVÆ32
 = 
	`b¨Ród32
(
pSdIf
->
pHo°Cål
->
b¨Addªss
, 
SDHCI_PRESENT_STATE
);

109 
°©us
 = (
ªgVÆ32
 & 
SDHCI_CARD_PRESENT
Ë=SDHCI_CARD_PRESENT ? 
åue
 : 
Ál£
;

112 if–
°©us
 )

114 
°©us
 = 
	`sd_ho°_£tup
–
pSdIf
 );

117  
°©us
;

118 
	}
}

128 
	$sd_c⁄fig_£tup
(
pci_devi˚
* 
pci
)

130 
	`d¥ötf
(6, "sd_c⁄fig_£tup: 0x%04x\n", 
pci
->
bdf
 );

133 
g_pDev
 = (
sdDiskIf_t
*)
	`mÆloc_f£g
( (*g_pDev) );

134 if–!
g_pDev
 )

136 
	`w¨n_nﬂŒoc
();

139 
	`mem£t
–
g_pDev
, 0, ( *g_pDev ) );

142 
g_pDev
->
pHo°Cål
 = (
sdHc_t
*)
	`mÆloc_f£g
( (*g_pDev->pHostCtrl) );

143 if–!(
g_pDev
->
pHo°Cål
) )

145 
	`w¨n_nﬂŒoc
();

146 
	`‰ì
(
g_pDev
);

149 
	`mem£t
–
g_pDev
->
pHo°Cål
, 0, ( *g_pDev->pHostCtrl) );

150 
g_pDev
->
pHo°Cål
->
isInôülized
 = 
Ál£
;

153 
g_pDev
->
pPci
 = 
pci
;

156 
g_pDev
->
pHo°Cål
->
b¨Addªss
 = 
	`pci_c⁄fig_ªadl
(g_pDev->
pPci
->
bdf
, 0x10) & 0xFFFFFF00;

159 if–!
	`sd_ˇrd_dëe˘
(
g_pDev
) )

161 
	`d¥ötf
–
DEBUG_HDL_SD
, "No SD card detected\n");

162 
	`‰ì
–
g_pDev
->
pHo°Cål
 );

163 
	`‰ì
–
g_pDev
 );

168 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD card is inserted\n");

171 if–
	`¸óã_boun˚_buf
() < 0 )

173 
	`w¨n_nﬂŒoc
();

174 
	`‰ì
–
g_pDev
);

177 
	}
}

187 
	$sd_sˇn
()

189 
pci_devi˚
 *
pci
 = 
NULL
;

190 
	`d¥ötf
(6, "SD: Scanning for SD Host controllers\n" );

193 
	`f‹óchpci
(
pci
)

195 if–
pci
->
˛ass
 !
PCI_CLASS_SYSTEM_SDHCI
 )

200 if–
pci
->
¥og_if
 != 1 )

204 
	`d¥ötf
(6, "Found PCI SDHCI controller\n");

207 
	`sd_c⁄fig_£tup
(
pci
);

209 
	}
}

220 
	$sd_£tup
( )

222 
	`ASSERT32FLAT
();

223 if–
CONFIG_SD
 )

225 
	`d¥ötf
(3, "init SD drives\n");

226 
	`sd_sˇn
();

228 
	}
}

238 
	$sd_cmd_d©a
–
disk_›_s
 *
›
, *
cdbcmd
, 
uöt16_t
 
blocksize
 )

240 
ªtVÆ
 = 
DISK_RET_EPARAM
;

241 
	`d¥ötf
(3, "sd_cmd_data\n");

243  
›
->
comm™d
 )

245 
CMD_READ
:

246 
ªtVÆ
 = 
	`sd_disk_ªad
–
›
 );

248 
CMD_WRITE
:

250 
CMD_RESET
:

251 
CMD_ISREADY
:

252 
CMD_FORMAT
:

253 
CMD_VERIFY
:

254 
CMD_SEEK
:

255 
ªtVÆ
 = 
DISK_RET_SUCCESS
;

258 
ªtVÆ
 = 
DISK_RET_EPARAM
;

261  
ªtVÆ
;

262 
	}
}

272 
	$sd_disk_ªad_Æig√d
–
disk_›_s
* 
›
 )

274 
ªtVÆ
 = 
DISK_RET_SUCCESS
;

275 
sdDiskIf_t
* 
pSdIf
 = 
	`GET_GLOBAL
–
g_pDev
 );

276 
uöt16_t
 
i
 = 0;

277 
uöt8_t
* 
curPosôi⁄
 = (uöt8_t*)
›
->
buf_Ê
;

279  
i
 = 0; i < 
›
->
cou¡
; i++ )

281 if–!
	`sdRódSögÀBlock
–
pSdIf
->
pHo°Cål
->
pC¨d
, 
curPosôi⁄
, (
uöt32_t
)(
›
->
lba
 + 
i
)) )

283 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD Read Fail\n");

284 
ªtVÆ
 = 
DISK_RET_EPARAM
;

289 
	`d¥ötf
–
DEBUG_HDL_SD
, "sd disk %s,Üba %6x, count %3x, buf %p,Ñc %d\n",

290 "ªad", (
u32
)
›
->
lba
 + 
i
, op->
cou¡
 - i, 
curPosôi⁄
, 
ªtVÆ
);

291 
curPosôi⁄
 +
BLOCK_SIZE8
;

294 
	`d¥ötf
–
DEBUG_HDL_SD
, "ªtu∫ fromÑódÑëvÆ = %u\n", 
ªtVÆ
 );

295  
ªtVÆ
;

296 
	}
}

305 
	$sd_disk_ªad
–
disk_›_s
* 
›
 )

307 
ªtVÆ
 = 
DISK_RET_EPARAM
;

308 
disk_›_s
 
loˇlOp
;

309 
uöt8_t
* 
Æig√dBuf
 = 
NULL
;

310 
uöt8_t
* 
curPosôi⁄
 = 
NULL
;

311 
uöt16_t
 
i
 = 0;

314 if––(
uöt32_t
)
›
->
buf_Ê
 & 1 ) == 0 )

316 
	`d¥ötf
–
DEBUG_HDL_SD
, "sdÑead: bufferálreadyálligned\n");

317 
ªtVÆ
 = 
	`sd_disk_ªad_Æig√d
–
›
 );

321 
	`d¥ötf
–
DEBUG_HDL_SD
, "sdÑead: unaligned buffer,ÖerformingÑealligendÑead\n");

323 
loˇlOp
 = *
›
;

324 
Æig√dBuf
 = 
	`GET_GLOBAL
–
boun˚_buf_Ê
 );

325 
curPosôi⁄
 = 
›
->
buf_Ê
;

328 
loˇlOp
.
buf_Ê
 = 
Æig√dBuf
;

329 
loˇlOp
.
cou¡
 = 1;

331  
i
 = 0; i < 
›
->
cou¡
; i++ )

333 
ªtVÆ
 = 
	`sd_disk_ªad_Æig√d
–&
loˇlOp
 );

334 if–
ªtVÆ
 )

336 
	`d¥ötf
–
DEBUG_HDL_SD
, " -álignedÑead fail\n");

339 
	`mem˝y_Ê
–
curPosôi⁄
, 
Æig√dBuf
, 
BLOCK_SIZE8
 );

340 
curPosôi⁄
 +
BLOCK_SIZE8
;

341 
loˇlOp
.
lba
++;

345  
ªtVÆ
;

346 
	}
}

360 
VISIBLE32FLAT
 
	$¥o˚ss_sd_›
–
disk_›_s
 *
›
 )

362 
ªtVÆ
 = 
DISK_RET_EPARAM
;

365 i‡(!
CONFIG_SD
)

368 
	`d¥ötf
–
DEBUG_HDL_SD
, "Executög SD diskÅønß˘i⁄: %d\r\n", 
›
->
comm™d
 );

370  
›
->
comm™d
 )

372 
CMD_READ
:

373 
	`d¥ötf
–
DEBUG_HDL_SD
,

374 "SD CMD_READ:Üba: 0x%08x%08x\n", (
uöt32_t
)(
›
->
lba
 >> 32), (uint32_t)(op->lba) );

375 
	`d¥ötf
–
DEBUG_HDL_SD
, " op->cou¡ = %d\n", 
›
->
cou¡
 );

376 
ªtVÆ
 = 
	`sd_disk_ªad
–
›
 );

378 
CMD_WRITE
:

380 
CMD_RESET
:

381 
CMD_ISREADY
:

382 
CMD_FORMAT
:

383 
CMD_VERIFY
:

384 
CMD_SEEK
:

385 
ªtVÆ
 = 
DISK_RET_SUCCESS
;

388 
›
->
cou¡
 = 0;

389 
ªtVÆ
 = 
DISK_RET_EPARAM
;

393  
ªtVÆ
;

394 
	}
}

396 
	$SD_DEBUG
–c⁄° * 
func
, 
löe
 )

398 vﬁ©ûê
uöt8_t
 
exô
 = 0;

399 vﬁ©ûê
uöt32_t
 
i
 = 0;

401 
	`d¥ötf
–
DEBUG_HDL_SD
, "%s, %d\n", 
func
, 
löe
 );

403  !
exô
 )

405 
i
++;

407 
	}
}

	@hw/sd_if.h

15 #i‚de‡
__SD_IF_H


16 
	#__SD_IF_H


	)

18 
	~<°döt.h
>

19 
	~"block.h
"

20 
	~"c⁄fig.h
"

21 
	~"pci.h
"

22 
	~"sd.h
"

30 
drive_s
 
	mdrive
;

31 
öt32_t
 
	mboŸPri‹ôy
;

32 c⁄° * 
	mdesc
;

33 
pci_devi˚
* 
	mpPci
;

34 
sdHc_t
* 
	mpHo°Cål
;

35 }
	tsdDiskIf_t
;

37 
sd_£tup
 ();

38 
sd_cmd_d©a
–
disk_›_s
 *
›
, *
cdbcmd
, 
uöt16_t
 
blocksize
 );

39 
¥o˚ss_sd_›
–
disk_›_s
 *
›
 );

40 
SD_DEBUG
(c⁄° * 
func
, 
löe
);

41 
	#SD_STOP
–Ë
	`SD_DEBUG
–
__FUNCTION__
, 
__LINE__
 )

	)

	@hw/sd_utils.c

60 
	~"c⁄fig.h
"

61 
	~"°rög.h
"

62 
	~"ouçut.h
"

63 
	~"sd_utûs.h
"

65 
uöt32_t
 
gë_bôs
(uöt32_à*
bôs
, 
bô_Àn
, 
°¨t
, 
size
);

67 c⁄° 
	gexp
[8] = {

71 c⁄° 
	gm™t
[16] = {

75 c⁄° 
	gcur_mö
[8] = {

79 c⁄° 
	gcur_max
[8] = {

83 
uöt32_t
 
	$gë_bôs
(
uöt32_t
 *
bôs
, 
bô_Àn
, 
°¨t
, 
size
)

85 c⁄° 
i
 = (
bô_Àn
 / 32Ë- (
°¨t
 / 32) - 1;

86 c⁄° 
shi·
 = 
°¨t
 & 31;

87 
uöt32_t
 
ªtvÆ
 = 
bôs
[
i
] >> 
shi·
;

88 i‡(
size
 + 
shi·
 > 32)

89 
ªtvÆ
 |
bôs
[
i
 - 1] << (32 - 
shi·
);

90  (
ªtvÆ
 & ((1Œu << 
size
) - 1));

91 
	}
}

93 
	$decode_cid_sd
(
uöt32_t
 *
øw_cid
, 
sd_cid_t
* 
cid
)

95 
i
;

98 
	`mem£t
(
cid
, 0, (*cid));

99 
cid
->
mid
 = 
	`gë_bôs
(
øw_cid
, 128, 120, 8);

100 
cid
->
oid
 = 
	`gë_bôs
(
øw_cid
, 128, 104, 16);

101 
i
 = 0; i < 5; i++)

102 
cid
->
≤m
[
i
] = 
	`gë_bôs
(
øw_cid
, 128, 96 - i * 8, 8);

103 
cid
->
≤m
[5] = 0;

104 
cid
->
¥v
 = 
	`gë_bôs
(
øw_cid
, 128, 56, 8);

105 
cid
->
p¢
 = 
	`gë_bôs
(
øw_cid
, 128, 24, 32);

106 
cid
->
mdt_yór
 = 
	`gë_bôs
(
øw_cid
, 128, 12, 8) + 2000;

107 
cid
->
mdt_m⁄th
 = 
	`gë_bôs
(
øw_cid
, 128, 8, 4);

108 
	}
}

110 
	$decode_csd_sd
(
uöt32_t
 *
øw_csd
, 
sd_csd_t
* 
csd
)

112 
v
;

113 
m
;

114 
e
;

115 
t°
;

117 
	`mem£t
(
csd
, 0, (*csd));

118 
csd
->
csd_°ru˘uª
 = 
v
 = 
	`gë_bôs
(
øw_csd
, 128, 126, 2);

119 
	`d¥ötf
–
DEBUG_HDL_SD
, "CSD Register Info:\n" );

120 i‡(
v
 == 0) {

121 
	`d¥ötf
–
DEBUG_HDL_SD
, " CSD Version 1.0\n");

122 
m
 = 
	`gë_bôs
(
øw_csd
, 128, 115, 4);

123 
e
 = 
	`gë_bôs
(
øw_csd
, 128, 112, 3);

125 
t°
 = 
	`gë_bôs
(
øw_csd
, 128, 112, 8 );

126 
	`d¥ötf
–
DEBUG_HDL_SD
, " RAW TAAC: 0x%02x\n", (
uöt8_t
)
t°
 );

128 
csd
->
ècc
 = (
exp
[
e
] * 
m™t
[
m
] + 9) / 10;

129 
csd
->
nßc
 = 
	`gë_bôs
(
øw_csd
, 128, 104, 8) * 100;

130 
m
 = 
	`gë_bôs
(
øw_csd
, 128, 99, 4);

131 
e
 = 
	`gë_bôs
(
øw_csd
, 128, 96, 3);

132 
csd
->
å™_•ìd
 = 
exp
[
e
] * 10000 * 
m™t
[
m
];

133 
csd
->
ccc
 = 
	`gë_bôs
(
øw_csd
, 128, 84, 12);

134 
csd
->
ªad_bl_Àn
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 80, 4);

135 
csd
->
ªad_bl_∑πül
 = 
	`gë_bôs
(
øw_csd
, 128, 79, 1);

136 
csd
->
wrôe_blk_mißlign
 = 
	`gë_bôs
(
øw_csd
, 128, 78, 1);

137 
csd
->
ªad_blk_mißlign
 = 
	`gë_bôs
(
øw_csd
, 128, 77, 1);

138 
csd
->
d§_imp
 = 
	`gë_bôs
(
øw_csd
, 128, 76, 1);

139 
csd
->
vdd_r_cuº_mö
 = 
cur_mö
[
	`gë_bôs
(
øw_csd
, 128, 59, 3)];

140 
csd
->
vdd_r_cuº_max
 = 
cur_max
[
	`gë_bôs
(
øw_csd
, 128, 56, 3)];

141 
csd
->
vdd_w_cuº_mö
 = 
cur_mö
[
	`gë_bôs
(
øw_csd
, 128, 53, 3)];

142 
csd
->
vdd_w_cuº_max
 = 
cur_max
[
	`gë_bôs
(
øw_csd
, 128, 50, 3)];

143 
m
 = 
	`gë_bôs
(
øw_csd
, 128, 62, 12);

144 
e
 = 
	`gë_bôs
(
øw_csd
, 128, 47, 3);

145 
csd
->
ˇ∑côy
 = ((1 + 
m
Ë<< (
e
 + 2)Ë* csd->
ªad_bl_Àn
;

146 
csd
->
îa£_blk_í
 = 
	`gë_bôs
(
øw_csd
, 128, 46, 1);

147 
csd
->
îa£_£˘‹
 = 
	`gë_bôs
(
øw_csd
, 128, 39, 7) + 1;

148 
csd
->
wp_gΩ_size
 = 
	`gë_bôs
(
øw_csd
, 128, 32, 7);

149 
csd
->
wp_gΩ_íabÀ
 = 
	`gë_bôs
(
øw_csd
, 128, 31, 1);

150 
csd
->
r2w_Á˘‹
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 26, 3);

151 
csd
->
wrôe_bl_Àn
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 22, 4);

152 
csd
->
wrôe_bl_∑πül
 = 
	`gë_bôs
(
øw_csd
, 128, 21, 1);

153 } i‡(
v
 == 1) {

154 
	`d¥ötf
–
DEBUG_HDL_SD
, "CSD Version 2.0\n");

155 
m
 = 
	`gë_bôs
(
øw_csd
, 128, 115, 4);

156 
e
 = 
	`gë_bôs
(
øw_csd
, 128, 112, 3);

158 
t°
 = 
	`gë_bôs
(
øw_csd
, 128, 112, 8 );

159 
	`d¥ötf
–
DEBUG_HDL_SD
, " RAW TAAC: 0x%02x\n", (
uöt8_t
)
t°
 );

161 
csd
->
ècc
 = (
exp
[
e
] * 
m™t
[
m
] + 9) / 10;

162 
csd
->
nßc
 = 
	`gë_bôs
(
øw_csd
, 128, 104, 8) * 100;

163 
m
 = 
	`gë_bôs
(
øw_csd
, 128, 99, 4);

164 
e
 = 
	`gë_bôs
(
øw_csd
, 128, 96, 3);

165 
csd
->
å™_•ìd
 = 
exp
[
e
] * 10000 * 
m™t
[
m
];

166 
csd
->
ccc
 = 
	`gë_bôs
(
øw_csd
, 128, 84, 12);

167 
csd
->
ªad_bl_Àn
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 80, 4);

168 
csd
->
ªad_bl_∑πül
 = 
	`gë_bôs
(
øw_csd
, 128, 79, 1);

169 
csd
->
wrôe_blk_mißlign
 = 
	`gë_bôs
(
øw_csd
, 128, 78, 1);

170 
csd
->
ªad_blk_mißlign
 = 
	`gë_bôs
(
øw_csd
, 128, 77, 1);

171 
csd
->
d§_imp
 = 
	`gë_bôs
(
øw_csd
, 128, 76, 1);

172 
csd
->
ˇ∑côy
 = ((
uöt64_t
)
	`gë_bôs
(
øw_csd
, 128, 48, 22) + 1) *

174 
	`d¥ötf
–
DEBUG_HDL_SD
, " C_SIZE: 0x%08x\n", 
	`gë_bôs
(
øw_csd
, 128, 48, 22) );

175 
csd
->
îa£_blk_í
 = 
	`gë_bôs
(
øw_csd
, 128, 46, 1);

176 
csd
->
îa£_£˘‹
 = 
	`gë_bôs
(
øw_csd
, 128, 39, 7) + 1;

177 
csd
->
wp_gΩ_size
 = 
	`gë_bôs
(
øw_csd
, 128, 32, 7);

178 
csd
->
wp_gΩ_íabÀ
 = 
	`gë_bôs
(
øw_csd
, 128, 31, 1);

179 
csd
->
r2w_Á˘‹
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 26, 3);

180 
csd
->
wrôe_bl_Àn
 = 1 << 
	`gë_bôs
(
øw_csd
, 128, 22, 4);

181 
csd
->
wrôe_bl_∑πül
 = 
	`gë_bôs
(
øw_csd
, 128, 21, 1);

184 
	`d¥ötf
–
DEBUG_HDL_SD
, "unknown SD CSD version\n");

187 
	`d¥ötf
–
DEBUG_HDL_SD
, " READ_BL_LEN: %d\n", 
csd
->
ªad_bl_Àn
 );

189 
	`d¥ötf
–
DEBUG_HDL_SD
, " CAPACITY: 0x%08x%08x\n", (
uöt32_t
)–
csd
->
ˇ∑côy
 >> 32), (uint32_t)(csd->capacity) );

190 
	}
}

	@hw/sd_utils.h

59 #i‚de‡
__SD_UTILS_H


60 
	#__SD_UTILS_H


	)

62 
	~<°döt.h
>

67 
uöt32_t
 
	mmid
;

68 
	m≤m
[8];

69 
uöt32_t
 
	mp¢
;

70 
uöt16_t
 
	moid
;

71 
uöt16_t
 
	mmdt_yór
;

72 
uöt8_t
 
	mmdt_m⁄th
;

73 
uöt8_t
 
	m¥v
;

74 
uöt8_t
 
	mfwªv
;

75 }
	tsd_cid_t
;

79 
uöt8_t
 
	mcsd_°ru˘uª
;

80 
uöt8_t
 
	m•ec_vîs
;

81 
uöt16_t
 
	mccc
;

82 
uöt16_t
 
	mècc
;

83 
uöt32_t
 
	mnßc
;

84 
uöt32_t
 
	mr2w_Á˘‹
;

85 
uöt32_t
 
	må™_•ìd
;

86 
uöt32_t
 
	mªad_bl_Àn
;

87 
uöt32_t
 
	mwrôe_bl_Àn
;

88 
uöt32_t
 
	mvdd_r_cuº_mö
;

89 
uöt32_t
 
	mvdd_r_cuº_max
;

90 
uöt32_t
 
	mvdd_w_cuº_mö
;

91 
uöt32_t
 
	mvdd_w_cuº_max
;

92 
uöt32_t
 
	mwp_gΩ_size
;

93 
uöt32_t
 
	mîa£_£˘‹
;

94 
uöt64_t
 
	mˇ∑côy
;

95 
	mªad_bl_∑πül
:1,

96 
	mªad_blk_mißlign
:1,

97 
	mwrôe_bl_∑πül
:1,

98 
	mwrôe_blk_mißlign
:1,

99 
	md§_imp
:1,

100 
	mîa£_blk_í
:1,

101 
	mwp_gΩ_íabÀ
:1;

102 }
	tsd_csd_t
;

105 
decode_cid_sd
(
uöt32_t
 *
øw_cid
, 
sd_cid_t
* 
cid
);

106 
decode_csd_sd
(
uöt32_t
 *
øw_csd
, 
sd_csd_t
* 
csd
);

	@hw/sdhc_generic.c

15 
	~<°döt.h
>

16 
	~<°dboﬁ.h
>

17 
	~"°rög.h
"

18 
	~"mÆloc.h
"

19 
	~"utû.h
"

20 
	~"ouçut.h
"

21 
	~"biosv¨.h
"

22 
	~"pci.h
"

23 
	~"pci_ids.h
"

24 
	~"°d/disk.h
"

25 
	~"b¨.h
"

26 
	~"sdhci.h
"

27 
	~"sd.h
"

28 
	~"sdhc_gíîic.h
"

31 
sdhc_ªadRe•⁄£
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
 );

32 
boﬁ
 
sdhc_pﬁlI¡rSètus
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
, 
uöt32_t
 
öåNum
, uöt32_à
pﬁlC¡
, uöt32_à
uSecTmo
 );

33 
sdhc_gëVîInfo
–
sdHc_t
* 
pSdCål
 );

34 
sdhc_£tClock
–
sdHc_t
* 
pSdCål
, 
uöt32_t
 
˛ockVÆ
 );

35 
sdhc_£tPowî
–
sdHc_t
* 
pSdCål
, 
uöt32_t
 
pwrMode
 );

36 
boﬁ
 
sdhc_ª£t
–
sdHc_t
* 
pSdCål
, 
uöt8_t
 
ª£tFœgs
 );

37 
sdhc_ªadBlock
–
sdHc_t
* 
pSdCål
, 
uöt8_t
* 
pBuf
, 
uöt32_t
 
cou¡
 );

40 
boﬁ
 
sdhc_Cmd
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
 );

52 
	$sdhc_ªadRe•⁄£
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
 )

54 
	`mem£t
–
pX„r
->
ª•⁄£
, 0, (ÖXfer->response[0] * 4 ) );

55 
pX„r
->
r•VÆid
 = 
Ál£
;

57  
pX„r
->
r•Ty≥
 )

59 
eR•136
:

60 
pX„r
->
ª•⁄£
[0] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 );

61 
pX„r
->
ª•⁄£
[1] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 + 0x04 );

62 
pX„r
->
ª•⁄£
[2] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 + 0x08 );

63 
pX„r
->
ª•⁄£
[3] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 + 0x0C );

64 
pX„r
->
r•VÆid
 = 
åue
;

67 
eR•48
:

68 
pX„r
->
ª•⁄£
[0] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 );

69 
pX„r
->
r•VÆid
 = 
åue
;

72 
eR•48_busy
:

73 
pX„r
->
ª•⁄£
[0] = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_RESPONSE
 + 0x0C );

74 
pX„r
->
r•VÆid
 = 
åue
;

77 
eR•N⁄e
:

81 
	}
}

94 
boﬁ
 
	$sdhc_pﬁlI¡rSètus
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
, 
uöt32_t
 
öåNum
, uöt32_à
pﬁlC¡
, uöt32_à
uSecTmo
 )

96 
boﬁ
 
°©us
 = 
Ál£
;

97 
uöt32_t
 
ªgVÆ32
= 0;

100 if–!
pﬁlC¡
 )

102 
pﬁlC¡
 = 1;

106  
pﬁlC¡
-- )

108 
ªgVÆ32
 = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_INT_STATUS
 );

110 if––
öåNum
 & 
ªgVÆ32
 ) == intrNum )

113 if–
öåNum
 =
SDHCI_INT_RESPONSE
 )

115 
	`sdhc_ªadRe•⁄£
–
pSdCål
, 
pX„r
);

120 
ªgVÆ32
 &~
öåNum
;

121 
	`b¨Wrôe32
–
pSdCål
->
b¨Addªss
, 
SDHCI_INT_STATUS
, 
ªgVÆ32
 );

122 
°©us
 = 
åue
;

123 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:Ñeque°ed i¡îru± occuªd: %u\n", 
öåNum
 );

126 if–
ªgVÆ32
 & 
SDHCI_INT_ERROR_MASK
 )

129 if–
ªgVÆ32
 & 
SDHCI_INT_TIMEOUT
 )

131 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: ERROR Timeout\n" );

136 
	`d¥ötf
–
DEBUG_HDL_SD
,

138 
	`sdhc_ª£t
–
pSdCål
, 
SDHCI_RESET_CMD
 | 
SDHCI_RESET_DATA
 );

140 
	`b¨Wrôe32
–
pSdCål
->
b¨Addªss
, 
SDHCI_INT_STATUS
, ~
SDHCI_INT_ERROR_MASK
 );

141 
°©us
 = 
Ál£
;

145 
	`udñay
–
uSecTmo
 );

148 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: Cuºíàöãºu± sètu†ªgi°î: 0x%08x\n", 
ªgVÆ32
 );

150  
°©us
;

151 
	}
}

161 
	$sdhc_gëVîInfo
–
sdHc_t
* 
pSdCål
 )

163 
uöt16_t
 
ªgVÆ16
 = 0;

165 
ªgVÆ16
 = 
	`b¨Ród16
–
pSdCål
->
b¨Addªss
, 
SDHCI_HOST_VERSION
 );

166 
pSdCål
->
ho°Víd‹Id
 =

167 (
uöt8_t
)––
ªgVÆ16
 & 
SDHCI_VENDOR_VER_MASK
 ) >> 
SDHCI_VENDOR_VER_SHIFT
 );

168 
pSdCål
->
ho°S≥cId
 =

169 (
uöt8_t
)––
ªgVÆ16
 & 
SDHCI_SPEC_VER_MASK
 ) >> 
SDHCI_SPEC_VER_SHIFT
 );

170 
	}
}

183 
	$sdhc_£tPowî
–
sdHc_t
* 
pSdCål
, 
uöt32_t
 
pwrMode
 )

185 
uöt8_t
 
pwr
 = 0;

187 
pSdCål
->
pwrMode
 =ÖwrMode;

190 
	`b¨Wrôe8
(
pSdCål
->
b¨Addªss
, 
SDHCI_POWER_CONTROL
, 
pwr
);

192 i‡(
pwrMode
 == 0)

196  
pwrMode
 )

198 
SDHCI_CAN_VDD_180
:

199 
pwr
 |
SDHCI_POWER_180
;

201 
SDHCI_CAN_VDD_300
:

202 
pwr
 |
SDHCI_POWER_300
;

204 
SDHCI_CAN_VDD_330
:

205 
pwr
 |
SDHCI_POWER_330
;

209 
	`b¨Wrôe8
(
pSdCål
->
b¨Addªss
, 
SDHCI_POWER_CONTROL
, 
pwr
);

211 
pwr
 |
SDHCI_POWER_ON
;

212 
	`b¨Wrôe8
(
pSdCål
->
b¨Addªss
, 
SDHCI_POWER_CONTROL
, 
pwr
);

213 
	}
}

226 
	$sdhc_£tClock
–
sdHc_t
* 
pSdCål
, 
uöt32_t
 
˛ockVÆ
 )

228 
uöt32_t
 
ªs
 = 0;

229 
uöt16_t
 
˛k
 = 0;

230 
öt32_t
 
timeout
 = 0;

232 
pSdCål
->
curClk
 = 
˛ockVÆ
;

235 
	`b¨Wrôe16
(
pSdCål
->
b¨Addªss
, 
SDHCI_CLOCK_CONTROL
, 0 );

238 
ªs
 = 
pSdCål
->
maxClk
;

239 
˛k
 = 1; clk < 256; clk <<= 1)

241 if–
ªs
 <
˛ockVÆ
 )

245 
ªs
 >>= 1;

249 
˛k
 >>= 1;

250 
˛k
 <<
SDHCI_DIVIDER_SHIFT
;

251 
˛k
 |
SDHCI_CLOCK_INT_EN
;

252 
	`b¨Wrôe16
–
pSdCål
->
b¨Addªss
, 
SDHCI_CLOCK_CONTROL
, 
˛k
);

255 
timeout
 = 10;

256  !((
˛k
 = 
	`b¨Ród16
(
pSdCål
->
b¨Addªss
, 
SDHCI_CLOCK_CONTROL
) )

257 & 
SDHCI_CLOCK_INT_STABLE
) )

259 if–
timeout
 == 0 )

261 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: card internal clockÇever stabilized\n");

264 
timeout
--;

265 
	`udñay
(1000);

268 if–
timeout
 > 0)

271 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: c¨d i¡î«»˛ock sèbûizedáà%u Hz\n", 
pSdCål
->
curClk
 );

272 
˛k
 |
SDHCI_CLOCK_CARD_EN
;

273 
	`b¨Wrôe16
–
pSdCål
->
b¨Addªss
, 
SDHCI_CLOCK_CONTROL
, 
˛k
 );

275 
	}
}

288 
boﬁ
 
	$sdhc_ª£t
–
sdHc_t
* 
pSdCål
, 
uöt8_t
 
ª£tFœgs
 )

290 
uöt8_t
 
ª£tResu…
 = 0;

291 
uöt32_t
 
timeout
 = 0;

292 
boﬁ
 
°©us
 = 
Ál£
;

295 
	`b¨Wrôe8
–(
uöt32_t
)
pSdCål
->
b¨Addªss
, 
SDHCI_SOFTWARE_RESET
, 
ª£tFœgs
 );

298 
timeout
 = 10;

299  ( 
ª£tResu…
 = 
	`b¨Ród8
–
pSdCål
->
b¨Addªss
, 
SDHCI_SOFTWARE_RESET
Ë& 
ª£tFœgs
 ) )

301 if–
timeout
 == 0 )

303 
	`d¥ötf
–
DEBUG_HDL_SD
,

304 "SDHC Re£àTimeouàf‹Ñe£àªque°Åy≥: 0x%02x\n", 
ª£tFœgs
 );

306 
timeout
--;

307 
	`udñay
(100);

309 if–
timeout
 > 0)

311 
	`d¥ötf
–
DEBUG_HDL_SD
,

312 "SDHC Re£àSuc˚ssfu»f‹Ñe£àªque°Åy≥: 0x%02x\n", 
ª£tFœgs
 );

313 
°©us
 = 
åue
;

315  
°©us
;

316 
	}
}

329 
boﬁ
 
	$sdhc_Cmd
–
sdHc_t
* 
pSdCål
, 
sdX„r_t
* 
pX„r
 )

331 
uöt32_t
 
curSèã
 = 0;

332 
uöt32_t
 
°©eMsk
 = 0;

333 
uöt8_t
 
ªgVÆ8
 = 0;

334 
uöt8_t
 
tmo
 = 10;

335 
uöt16_t
 
mode
 = 0;

336 
boﬁ
 
°©us
 = 
Ál£
;

337 
uöt32_t
 
ötFœgs
 = 0;

340 
°©eMsk
 = 
SDHCI_CMD_INHIBIT
;

341 if–
pX„r
->
r•Ty≥
 =
eR•48_busy
 )

343 
°©eMsk
 |
SDHCI_DAT_INHIBIT
;

347  
curSèã
 & 
°©eMsk
 )

349 if–
tmo
 == 0 )

351 
	`d¥ötf
–
DEBUG_HDL_SD
,

355 
tmo
--;

356 
	`udñay
(1000);

357 
curSèã
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_PRESENT_STATE
 );

360 if–
tmo
 > 0 )

363 
	`b¨Wrôe32
(
pSdCål
->
b¨Addªss
, 
SDHCI_ARGUMENT
, 
pX„r
->
¨g1
);

365 if–
pX„r
->
pD©a
 &&ÖX„r->
x„rTy≥
 =
eRdX„r
 )

368 
mode
 = 
	`b¨Ród16
–
pSdCål
->
b¨Addªss
, 
SDHCI_TRANSFER_MODE
 );

369 
mode
 |–
SDHCI_TRNS_READ
 );

370 
mode
 &~–
SDHCI_TRNS_MULTI
 | 
SDHCI_TRNS_DMA
 );

371 
	`b¨Wrôe16
(
pSdCål
->
b¨Addªss
, 
SDHCI_TRANSFER_MODE
, 
mode
 );

376 
mode
 = 
	`b¨Ród16
–
pSdCål
->
b¨Addªss
, 
SDHCI_TRANSFER_MODE
 );

377 
mode
 &~–
SDHCI_TRNS_READ
 | 
SDHCI_TRNS_MULTI
 | 
SDHCI_TRNS_DMA
 );

378 
	`b¨Wrôe16
(
pSdCål
->
b¨Addªss
, 
SDHCI_TRANSFER_MODE
, 
mode
 );

382 
ªgVÆ8
 = (
pSdCål
->
¸cCheckE«bÀ
Ë? 
SDHCI_CMD_CRC
 : 0;

383 
ªgVÆ8
 |(
pSdCål
->
ödexCheckE«bÀ
Ë? 
SDHCI_CMD_INDEX
 : 0;

384 
ªgVÆ8
 |(
pX„r
->
pD©a
 !
NULL
Ë? 
SDHCI_CMD_DATA
 : 0;

385 
ªgVÆ8
 |(
uöt8_t
)(
pX„r
->
cmdTy≥
);

386 
ªgVÆ8
 |(
uöt8_t
)(
pX„r
->
r•Ty≥
);

387 
	`b¨Wrôe8
–
pSdCål
->
b¨Addªss
, 
SDHCI_COMMAND_FLAGS
, 
ªgVÆ8
 );

390 
	`b¨Wrôe8
(
pSdCål
->
b¨Addªss
, 
SDHCI_COMMAND
, 
pX„r
->
cmdIdx
);

392 
tmo
 = 10;

393 if–
pX„r
->
r•Ty≥
 !
eR•N⁄e
 )

395 
ötFœgs
 = 
SDHCI_INT_RESPONSE
;

396 if–(
pX„r
->
pD©a
Ë&& (pX„r->
x„rTy≥
 =
eRdX„r
) )

399 
ötFœgs
 |
SDHCI_INT_DATA_AVAIL
;

402  !
	`sdhc_pﬁlI¡rSètus
–
pSdCål
, 
pX„r
, 
ötFœgs
, 100, 1000) )

404 if–
tmo
 == 0 )

406 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: failedÅoÑeceiveÑesponseÅo command\n");

409 
tmo
--;

413 if–(
pX„r
->
pD©a
Ë&& (pX„r->
x„rTy≥
 =
eRdX„r
) )

415 
	`sdhc_ªadBlock
–
pSdCål
, 
pX„r
->
pD©a
, 
BLOCK_SIZE8
 );

421 
°©us
 = (
tmo
 > 0);

422  
°©us
;

423 
	}
}

436 
	$sdhc_ªadBlock
–
sdHc_t
* 
pSdCål
, 
uöt8_t
* 
pBuf
, 
uöt32_t
 
cou¡
 )

438 
uöt32_t
 
lim
 = 0;

439 
uöt32_t
 
d©aReg
 = 0;

440 
uöt8_t
* 
pBufLoˇl
 = 
NULL
;

442 
pBufLoˇl
 = 
pBuf
;

445 
lim
 = 
BLOCK_SIZE8
;

452 if–
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_PRESENT_STATE
 ) & 
SDHCI_DATA_AVAILABLE
 )

454 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:Ñódög %d byã†o‡d©a\n", 
lim
 );

458 
lim
 >>= 2;

459  
lim
 > 0 )

461 
d©aReg
 = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_BUFFER
);

462 
pBufLoˇl
[0] = (
uöt8_t
)(
d©aReg
);

463 
pBufLoˇl
[1] = (
uöt8_t
)(
d©aReg
 >> 8);

464 
pBufLoˇl
[2] = (
uöt8_t
)(
d©aReg
 >> 16);

465 
pBufLoˇl
[3] = (
uöt8_t
)(
d©aReg
 >> 24);

466 
pBufLoˇl
 += 4;

467 
lim
--;

471 
lim
 = 
cou¡
 & 0x03;

472 if–
lim
 > 0 )

474 
d©aReg
 = 
	`b¨Ród32
(
pSdCål
->
b¨Addªss
, 
SDHCI_BUFFER
);

475  
lim
 > 0 )

477 *(
pBufLoˇl
++Ë(
uöt8_t
)
d©aReg
;

478 
d©aReg
 >>= 8;

479 
lim
--;

483 #if–
CONFIG_DEBUG_LEVEL
 > 9 )

484 
	`hexdump
–
pBuf
, 
BLOCK_SIZE8
 );

487 
	}
}

498 
	$sdhc_¥ïBoŸ
–
sdHc_t
* 
pSdCål
 )

502 
	`sdhc_£tClock
–
pSdCål
, 25 * 
MHZ
 );

505 
	}
}

514 
boﬁ
 
	$sdhc_isInôülized
–
sdHc_t
* 
pSdCål
 )

516  
pSdCål
->
isInôülized
;

517 
	}
}

528 
boﬁ
 
	$sdhc_öô
–
sdHc_t
* 
pSdCål
 )

530 
uöt32_t
 
ªgVÆ32
 = 0;

531 
uöt8_t
 
ªgVÆ8
 = 0;

534 if–
	`sdhc_ª£t
–
pSdCål
, 
SDHCI_RESET_ALL
 ) )

537 
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 =

538 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_CAPABILITIES
 );

539 
pSdCål
->
ˇrdC≠abûôõs
.
ˇp2
 =

540 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, (
SDHCI_CAPABILITIES
 + 4) );

542 
ªgVÆ8
 = 
	`b¨Ród8
(
pSdCål
->
b¨Addªss
, 
SDHCI_HOST_CONTROL
 );

543 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: Ho° C⁄åﬁÑegi°î: 0x%02x\n", 
ªgVÆ8
 );

546 
ªgVÆ8
 = 
	`b¨Ród8
(
pSdCål
->
b¨Addªss
, 
SDHCI_POWER_CONTROL
 );

547 if–!(
ªgVÆ8
 & 
SDHCI_POWER_ON
) )

549 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: card currentlyÇotÖowered,Öower onÅo");

551 if–
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_330
 )

553 
	`sdhc_£tPowî
–
pSdCål
, 
SDHCI_CAN_VDD_330
 );

554 
	`d¥ötf
–
DEBUG_HDL_SD
, ": 3.3V\n");

556 if–
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_300
 )

558 
	`sdhc_£tPowî
–
pSdCål
, 
SDHCI_CAN_VDD_300
 );

559 
	`d¥ötf
–
DEBUG_HDL_SD
, ": 3.0V\n");

561 if–
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CAN_VDD_180
 )

563 
	`sdhc_£tPowî
–
pSdCål
, 
SDHCI_CAN_VDD_180
 );

564 
	`d¥ötf
–
DEBUG_HDL_SD
, ": 1.8V\n");

569 
	`d¥ötf
(6, "SD: card bus isÖowered on\n");

573 
pSdCål
->
maxClk
 =

574 (
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_CLOCK_BASE_MASK
)

575 >> 
SDHCI_CLOCK_BASE_SHIFT
;

576 if–
pSdCål
->
maxClk
 == 0 )

578 
	`d¥ötf
–
DEBUG_HDL_SD
,

585 
pSdCål
->
maxClk
 *
MHZ
;

586 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: ba£ clock fªquícy %u Hz\n", 
pSdCål
->
maxClk
 );

591 
	`sdhc_£tClock
–
pSdCål
, 400000 );

594 
pSdCål
->
tmoClk
 = (pSdCål->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_TIMEOUT_CLK_MASK
Ë>> 
SDHCI_TIMEOUT_CLK_SHIFT
;

595 if–
pSdCål
->
tmoClk
 == 0 )

597 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:ÇoÅimeout clock frequency specified by card capabilities\n");

602 
pSdCål
->
tmoClk
 =

603 (
pSdCål
->
ˇrdC≠abûôõs
.
ˇp1
 & 
SDHCI_TIMEOUT_CLK_UNIT
)

604 ? 
pSdCål
->
tmoClk
 * 
MHZ
 :ÖSdCål->tmoClk * 
KHZ
;

605 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:Åimeouà‰equícy clock %u\n", 
pSdCål
->
tmoClk
 );

608 
	`b¨Wrôe8
–
pSdCål
->
b¨Addªss
, 
SDHCI_TIMEOUT_CONTROL
, 0x0E );

612 
ªgVÆ32
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_BLOCK_SIZE
 );

615 
pSdCål
->
blkSize
 &
BLOCK_MASK
;

616 if–
pSdCål
->
blkSize
 == 0 )

618 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD:Ço block size set...\n");

622 
	`d¥ötf
–
DEBUG_HDL_SD
, "SD: cuºíàblock size: %u\n", 
pSdCål
->
blkSize
 );

626 if–
pSdCål
->
blkSize
 !
BLOCK_SIZE8
 )

628 
pSdCål
->
blkSize
 = 
BLOCK_SIZE8
;

629 
	`d¥ötf
–
DEBUG_HDL_SD
, " - settingÇew block sizeÅo 512 bytes\n");

632 
ªgVÆ32
 &~
BLOCK_MASK
;

633 
ªgVÆ32
 |
pSdCål
->
blkSize
;

634 
	`b¨Wrôe32
–
pSdCål
->
b¨Addªss
, 
SDHCI_BLOCK_SIZE
, 
ªgVÆ32
 );

637 
ªgVÆ32
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_BLOCK_SIZE
 ) & 
BLOCK_MASK
;

638 if–
ªgVÆ32
 !
BLOCK_SIZE8
 )

640 
	`d¥ötf
–
DEBUG_HDL_SD
, " - setÇew block size failed!");

645 
	`d¥ötf
–
DEBUG_HDL_SD
, " -Çew block sizê£àto: %u\n", 
pSdCål
->
blkSize
 );

650 
	`sdhc_ª£t
–
pSdCål
, 
SDHCI_RESET_CMD
 | 
SDHCI_RESET_DATA
 );

653 
	`b¨Wrôe32
–
pSdCål
->
b¨Addªss
, 
SDHCI_INT_ENABLE
, 
SDHCI_INT_BUS_POWER
 |

654 
SDHCI_INT_DATA_END_BIT
 |

655 
SDHCI_INT_DATA_CRC
 | 
SDHCI_INT_DATA_TIMEOUT
 | 
SDHCI_INT_INDEX
 |

656 
SDHCI_INT_END_BIT
 | 
SDHCI_INT_CRC
 | 
SDHCI_INT_TIMEOUT
 |

657 
SDHCI_INT_CARD_REMOVE
 | 
SDHCI_INT_CARD_INSERT
 |

658 
SDHCI_INT_DATA_AVAIL
 | 
SDHCI_INT_SPACE_AVAIL
 |

659 
SDHCI_INT_DMA_END
 | 
SDHCI_INT_DATA_END
 | 
SDHCI_INT_RESPONSE
 |

660 
SDHCI_INT_ACMD12ERR
 );

663 
	`b¨Wrôe32
–
pSdCål
->
b¨Addªss
, 
SDHCI_SIGNAL_ENABLE
, 
SDHCI_INT_BUS_POWER
 |

664 
SDHCI_INT_DATA_END_BIT
 |

665 
SDHCI_INT_DATA_CRC
 | 
SDHCI_INT_DATA_TIMEOUT
 | 
SDHCI_INT_INDEX
 |

666 
SDHCI_INT_END_BIT
 | 
SDHCI_INT_CRC
 | 
SDHCI_INT_TIMEOUT
 |

667 
SDHCI_INT_CARD_REMOVE
 | 
SDHCI_INT_CARD_INSERT
 |

668 
SDHCI_INT_DATA_AVAIL
 | 
SDHCI_INT_SPACE_AVAIL
 |

669 
SDHCI_INT_DMA_END
 | 
SDHCI_INT_DATA_END
 | 
SDHCI_INT_RESPONSE
 |

670 
SDHCI_INT_ACMD12ERR
 );

672 
ªgVÆ32
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_INT_ENABLE
 );

673 
	`d¥ötf
(6, "SD: i¡îru±†íabÀdÅo: 0x%08x\n", 
ªgVÆ32
 );

675 
ªgVÆ32
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_INT_STATUS
 );

676 
	`d¥ötf
(6, "SD: Cuºíàöãºu± sètus: 0x%08x\n", 
ªgVÆ32
 );

678 
ªgVÆ32
 = 
	`b¨Ród32
–
pSdCål
->
b¨Addªss
, 
SDHCI_PRESENT_STATE
 );

679 
	`d¥ötf
(6, "SD: Pª£¡ Sèã: 0x%08x\n", 
ªgVÆ32
 );

682 
	`sdhc_gëVîInfo
–
pSdCål
 );

685 
pSdCål
->
sdhcCmd
 = &
sdhc_Cmd
;

687 
pSdCål
->
isInôülized
 = 
åue
;

689 –
pSdCål
->
isInôülized
 );

690 
	}
}

	@hw/sdhc_generic.h

15 #i‚de‡
__SDHC_GENERIC_H


16 
	#__SDHC_GENERIC_H


	)

24 
	~<°döt.h
>

25 
	~"block.h
"

26 
	~"c⁄fig.h
"

27 
	~"sd.h
"

30 
boﬁ
 
sdhc_öô
–
sdHc_t
* 
pSdCål
 );

31 
sdhc_¥ïBoŸ
–
sdHc_t
* 
pSdCål
 );

32 
boﬁ
 
sdhc_isInôülized
–
sdHc_t
* 
pSdCål
 );

	@hw/sdhci.h

39 
	#PCI_SDHCI_IFPIO
 0x00

	)

40 
	#PCI_SDHCI_IFDMA
 0x01

	)

41 
	#PCI_SDHCI_IFVENDOR
 0x02

	)

43 
	#PCI_SLOT_INFO
 0x40

	)

44 
	#PCI_SLOT_INFO_SLOTS
(
x
Ë(((x >> 4Ë& 7Ë+ 1)

	)

45 
	#PCI_SLOT_INFO_FIRST_BAR
(
x
Ë((xË& 7)

	)

50 
	#SDHC_PCI_MODE_KEY
 0xf9

	)

51 
	#SDHC_PCI_MODE
 0x150

	)

52 
	#SDHC_PCI_MODE_SD20
 0x10

	)

53 
	#SDHC_PCI_BASE_FREQ_KEY
 0xfc

	)

54 
	#SDHC_PCI_BASE_FREQ
 0xe1

	)

60 
	#SDHCI_DMA_ADDRESS
 0x00

	)

62 
	#SDHCI_BLOCK_SIZE
 0x04

	)

63 
	#SDHCI_MAKE_BLKSZ
(
dma
, 
blksz
Ë(((dm®& 0x7Ë<< 12Ë| (blksz & 0xFFF))

	)

65 
	#SDHCI_BLOCK_COUNT
 0x06

	)

67 
	#SDHCI_ARGUMENT
 0x08

	)

69 
	#SDHCI_TRANSFER_MODE
 0x0C

	)

70 
	#SDHCI_TRNS_DMA
 0x01

	)

71 
	#SDHCI_TRNS_BLK_CNT_EN
 0x02

	)

72 
	#SDHCI_TRNS_ACMD12
 0x04

	)

73 
	#SDHCI_TRNS_READ
 0x10

	)

74 
	#SDHCI_TRNS_MULTI
 0x20

	)

76 
	#SDHCI_COMMAND_FLAGS
 0x0E

	)

77 
	#SDHCI_CMD_RESP_NONE
 0x00

	)

78 
	#SDHCI_CMD_RESP_LONG
 0x01

	)

79 
	#SDHCI_CMD_RESP_SHORT
 0x02

	)

80 
	#SDHCI_CMD_RESP_SHORT_BUSY
 0x03

	)

81 
	#SDHCI_CMD_RESP_MASK
 0x03

	)

82 
	#SDHCI_CMD_CRC
 0x08

	)

83 
	#SDHCI_CMD_INDEX
 0x10

	)

84 
	#SDHCI_CMD_DATA
 0x20

	)

85 
	#SDHCI_CMD_TYPE_NORMAL
 0x00

	)

86 
	#SDHCI_CMD_TYPE_SUSPEND
 0x40

	)

87 
	#SDHCI_CMD_TYPE_RESUME
 0x80

	)

88 
	#SDHCI_CMD_TYPE_ABORT
 0xc0

	)

89 
	#SDHCI_CMD_TYPE_MASK
 0xc0

	)

91 
	#SDHCI_COMMAND
 0x0F

	)

93 
	#SDHCI_RESPONSE
 0x10

	)

95 
	#SDHCI_BUFFER
 0x20

	)

97 
	#SDHCI_PRESENT_STATE
 0x24

	)

98 
	#SDHCI_CMD_INHIBIT
 0x00000001

	)

99 
	#SDHCI_DAT_INHIBIT
 0x00000002

	)

100 
	#SDHCI_DAT_ACTIVE
 0x00000004

	)

101 
	#SDHCI_DOING_WRITE
 0x00000100

	)

102 
	#SDHCI_DOING_READ
 0x00000200

	)

103 
	#SDHCI_SPACE_AVAILABLE
 0x00000400

	)

104 
	#SDHCI_DATA_AVAILABLE
 0x00000800

	)

105 
	#SDHCI_CARD_PRESENT
 0x00010000

	)

106 
	#SDHCI_CARD_STABLE
 0x00020000

	)

107 
	#SDHCI_CARD_PIN
 0x00040000

	)

108 
	#SDHCI_WRITE_PROTECT
 0x00080000

	)

109 
	#SDHCI_STATE_DAT
 0x00700000

	)

110 
	#SDHCI_STATE_CMD
 0x00800000

	)

112 
	#SDHCI_HOST_CONTROL
 0x28

	)

113 
	#SDHCI_CTRL_LED
 0x01

	)

114 
	#SDHCI_CTRL_4BITBUS
 0x02

	)

115 
	#SDHCI_CTRL_HISPD
 0x04

	)

116 
	#SDHCI_CTRL_SDMA
 0x08

	)

117 
	#SDHCI_CTRL_ADMA2
 0x10

	)

118 
	#SDHCI_CTRL_ADMA264
 0x18

	)

119 
	#SDHCI_CTRL_CARD_DET
 0x40

	)

120 
	#SDHCI_CTRL_FORCE_CARD
 0x80

	)

122 
	#SDHCI_POWER_CONTROL
 0x29

	)

123 
	#SDHCI_POWER_ON
 0x01

	)

124 
	#SDHCI_POWER_180
 0x0A

	)

125 
	#SDHCI_POWER_300
 0x0C

	)

126 
	#SDHCI_POWER_330
 0x0E

	)

128 
	#SDHCI_BLOCK_GAP_CONTROL
 0x2A

	)

130 
	#SDHCI_WAKE_UP_CONTROL
 0x2B

	)

133 
	#SDHCI_CLOCK_CONTROL
 0x2C

	)

134 
	#SDHCI_DIVIDER_SHIFT
 8

	)

135 
	#SDHCI_CLOCK_CARD_EN
 0x0004

	)

136 
	#SDHCI_CLOCK_INT_STABLE
 0x0002

	)

137 
	#SDHCI_CLOCK_INT_EN
 0x0001

	)

139 
	#SDHCI_TIMEOUT_CONTROL
 0x2E

	)

141 
	#SDHCI_SOFTWARE_RESET
 0x2F

	)

142 
	#SDHCI_RESET_ALL
 0x01

	)

143 
	#SDHCI_RESET_CMD
 0x02

	)

144 
	#SDHCI_RESET_DATA
 0x04

	)

146 
	#SDHCI_INT_STATUS
 0x30

	)

147 
	#SDHCI_INT_ENABLE
 0x34

	)

148 
	#SDHCI_SIGNAL_ENABLE
 0x38

	)

149 
	#SDHCI_INT_RESPONSE
 0x00000001

	)

150 
	#SDHCI_INT_DATA_END
 0x00000002

	)

151 
	#SDHCI_INT_BLOCK_GAP
 0x00000004

	)

152 
	#SDHCI_INT_DMA_END
 0x00000008

	)

153 
	#SDHCI_INT_SPACE_AVAIL
 0x00000010

	)

154 
	#SDHCI_INT_DATA_AVAIL
 0x00000020

	)

155 
	#SDHCI_INT_CARD_INSERT
 0x00000040

	)

156 
	#SDHCI_INT_CARD_REMOVE
 0x00000080

	)

157 
	#SDHCI_INT_CARD_INT
 0x00000100

	)

158 
	#SDHCI_INT_ERROR
 0x00008000

	)

159 
	#SDHCI_INT_TIMEOUT
 0x00010000

	)

160 
	#SDHCI_INT_CRC
 0x00020000

	)

161 
	#SDHCI_INT_END_BIT
 0x00040000

	)

162 
	#SDHCI_INT_INDEX
 0x00080000

	)

163 
	#SDHCI_INT_DATA_TIMEOUT
 0x00100000

	)

164 
	#SDHCI_INT_DATA_CRC
 0x00200000

	)

165 
	#SDHCI_INT_DATA_END_BIT
 0x00400000

	)

166 
	#SDHCI_INT_BUS_POWER
 0x00800000

	)

167 
	#SDHCI_INT_ACMD12ERR
 0x01000000

	)

168 
	#SDHCI_INT_ADMAERR
 0x02000000

	)

170 
	#SDHCI_INT_NORMAL_MASK
 0x00007FFF

	)

171 
	#SDHCI_INT_ERROR_MASK
 0xFFFF8000

	)

173 
	#SDHCI_INT_CMD_MASK
 (
SDHCI_INT_RESPONSE
 | 
SDHCI_INT_TIMEOUT
 | \

174 
SDHCI_INT_CRC
 | 
SDHCI_INT_END_BIT
 | 
SDHCI_INT_INDEX
)

	)

175 
	#SDHCI_INT_DATA_MASK
 (
SDHCI_INT_DATA_END
 | 
SDHCI_INT_DMA_END
 | \

176 
SDHCI_INT_DATA_AVAIL
 | 
SDHCI_INT_SPACE_AVAIL
 | \

177 
SDHCI_INT_DATA_TIMEOUT
 | 
SDHCI_INT_DATA_CRC
 | \

178 
SDHCI_INT_DATA_END_BIT
)

	)

180 
	#SDHCI_ACMD12_ERR
 0x3C

	)

182 
	#SDHCI_CAPABILITIES
 0x40

	)

183 
	#SDHCI_TIMEOUT_CLK_MASK
 0x0000003F

	)

184 
	#SDHCI_TIMEOUT_CLK_SHIFT
 0

	)

185 
	#SDHCI_TIMEOUT_CLK_UNIT
 0x00000080

	)

186 
	#SDHCI_CLOCK_BASE_MASK
 0x00003F00

	)

187 
	#SDHCI_CLOCK_BASE_SHIFT
 8

	)

188 
	#SDHCI_MAX_BLOCK_MASK
 0x00030000

	)

189 
	#SDHCI_MAX_BLOCK_SHIFT
 16

	)

190 
	#SDHCI_CAN_DO_ADMA2
 0x00080000

	)

191 
	#SDHCI_CAN_DO_HISPD
 0x00200000

	)

192 
	#SDHCI_CAN_DO_DMA
 0x00400000

	)

193 
	#SDHCI_CAN_DO_SUSPEND
 0x00800000

	)

194 
	#SDHCI_CAN_VDD_330
 0x01000000

	)

195 
	#SDHCI_CAN_VDD_300
 0x02000000

	)

196 
	#SDHCI_CAN_VDD_180
 0x04000000

	)

197 
	#SDHCI_CAN_DO_64BIT
 0x10000000

	)

199 
	#SDHCI_MAX_CURRENT
 0x48

	)

201 
	#SDHCI_SLOT_INT_STATUS
 0xFC

	)

203 
	#SDHCI_HOST_VERSION
 0xFE

	)

204 
	#SDHCI_VENDOR_VER_MASK
 0xFF00

	)

205 
	#SDHCI_VENDOR_VER_SHIFT
 8

	)

206 
	#SDHCI_SPEC_VER_MASK
 0x00FF

	)

207 
	#SDHCI_SPEC_VER_SHIFT
 0

	)

	@hw/serialio.c

8 
	~"c⁄fig.h
"

9 
	~"fw/∑øvút.h
"

10 
	~"ouçut.h
"

11 
	~"£rülio.h
"

12 
	~"x86.h
"

13 
	~"hw/pci.h
"

14 
	~"hw/pci_ids.h
"

15 
	~"hw/pci_ªgs.h
"

16 
	~"hw/πc.h
"

17 
	~"°rög.h
"

23 
	#DEBUG_TIMEOUT
 100000

	)

25 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


26 
	gcmos_£rül_c⁄sﬁe_debug_Àvñ
 = 1;

31 
	$£rül_debug_¥eöô
()

33 i‡(!
CONFIG_DEBUG_SERIAL
)

35 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


36 i‡(
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE
)

37 
	`check_cmos_debug_Àvñ
();

41 
u8
 
ﬁd∑øm
, 
√w∑øm
 = 0x03;

42 
ﬁd∑øm
 = 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_LCR
);

43 
	`outb
(
√w∑øm
, 
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_LCR
);

45 
u8
 
ﬁdõr
, 
√wõr
 = 0;

46 
ﬁdõr
 = 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_IER
);

47 
	`outb
(
√wõr
, 
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_IER
);

49 i‡(
ﬁd∑øm
 !
√w∑øm
 || 
ﬁdõr
 !
√wõr
)

50 
	`d¥ötf
(1, "Changing serial settings was %x/%xÇow %x/%x\n"

51 , 
ﬁd∑øm
, 
ﬁdõr
, 
√w∑øm
, 
√wõr
);

52 
	}
}

56 
	$£rül_debug
(
c
)

58 i‡(!
CONFIG_DEBUG_SERIAL
)

60 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


61 i‡(
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE
 && !
cmos_£rül_c⁄sﬁe_debug_Àvñ
)

64 
timeout
 = 
DEBUG_TIMEOUT
;

65 (
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_LSR
) & 0x20) != 0x20)

66 i‡(!
timeout
--)

69 
	`outb
(
c
, 
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_DATA
);

70 
	}
}

73 
	$£rül_debug_putc
(
c
)

75 i‡(
c
 == '\n')

76 
	`£rül_debug
('\r');

77 
	`£rül_debug
(
c
);

78 
	}
}

82 
	$£rül_debug_Êush
()

84 i‡(!
CONFIG_DEBUG_SERIAL
)

86 
timeout
 = 
DEBUG_TIMEOUT
;

87 (
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
+
SEROFF_LSR
) & 0x60) != 0x60)

88 i‡(!
timeout
--)

91 
	}
}

98 
u16
 
DebugOuçutP‹t
 
	gVARFSEG
 = 0x402;

102 
	$qemu_debug_putc
(
c
)

104 i‡(
CONFIG_DEBUG_IO
 && 
	`ru¬ögOnQEMU
())

106 
	`outb
(
c
, 
	`GET_GLOBAL
(
DebugOuçutP‹t
));

107 
	}
}

109 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


115 
VISIBLE32FLAT


116 
	$check_cmos_debug_Àvñ
()

118 c⁄° *
rom_addªss
 = (*)0xFF000000;

119 c⁄° 
°rög
[] = {"debug_level"};

120 
u8
 
cmos_byã_addªss
 = 0;

121 
u8
 
cmos_byã_ªmaödî
 = 0;

122 
u8
 
cmos_byã_mask
 = 0;

123 
u8
 
i
;

124 
cmos_íåõs
 *
cmos_èbÀ
;

127  *(
u32
 *)
rom_addªss
 == 0xffffffff)

128 
rom_addªss
 = (*)(((
u32
)rom_address >> 1) | 0x80000000);

130 
	`°∫icmp
(
rom_addªss
, 
°rög
, 
	`°æí
(string))) {

131 
rom_addªss
++;

132 i‡(
rom_addªss
 == (*)0xffffffff)

136 
cmos_èbÀ
 = (
cmos_íåõs
 *)((
u32
)
rom_addªss
 - (cmos_íåõsË+ 
CMOS_MAX_NAME_LENGTH
);

137 
cmos_byã_addªss
 = 
cmos_èbÀ
->
bô
 / 8;

138 
cmos_byã_ªmaödî
 = 
cmos_èbÀ
->
bô
 % 8;

139 
i
 = 0; i < 
cmos_èbÀ
->
Àngth
; i++)

140 
cmos_byã_mask
 = (cmos_byte_mask << 1) | 1;

141 
cmos_£rül_c⁄sﬁe_debug_Àvñ
 = (
	`πc_ªad
(
cmos_byã_addªss
Ë>> 
cmos_byã_ªmaödî
Ë& 
cmos_byã_mask
;

142 
	}
}

	@hw/serialio.h

7 #i‚de‡
__SERIALIO_H


8 
	#__SERIALIO_H


	)

10 
	~"ty≥s.h
"

12 
	#PORT_LPT2
 0x0278

	)

13 
	#PORT_SERIAL4
 0x02e8

	)

14 
	#PORT_SERIAL2
 0x02f8

	)

15 
	#PORT_LPT1
 0x0378

	)

16 
	#PORT_SERIAL3
 0x03e8

	)

17 
	#PORT_SERIAL1
 0x03f8

	)

20 
	#SEROFF_DATA
 0

	)

21 
	#SEROFF_DLL
 0

	)

22 
	#SEROFF_IER
 1

	)

23 
	#SEROFF_DLH
 1

	)

24 
	#SEROFF_IIR
 2

	)

25 
	#SEROFF_LCR
 3

	)

26 
	#SEROFF_LSR
 5

	)

27 
	#SEROFF_MSR
 6

	)

29 #i‡
CONFIG_INT10_SERIAL_CONSOLE


30 
	#UART_OUTPUT_ENABLED
 0xED

	)

31 
	#UART_OUTPUT_DISABLED
 0xDE

	)

34 
£rül_debug_¥eöô
();

35 
£rül_debug_putc
(
c
);

36 
£rül_debug_Êush
();

37 
u16
 
DebugOuçutP‹t
;

38 
qemu_debug_putc
(
c
);

39 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


40 
check_cmos_debug_Àvñ
();

	@hw/timer.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"ouçut.h
"

10 
	~"ps2p‹t.h
"

11 
	~"°acks.h
"

12 
	~"utû.h
"

13 
	~"x86.h
"

15 
	#PORT_PIT_COUNTER0
 0x0040

	)

16 
	#PORT_PIT_COUNTER1
 0x0041

	)

17 
	#PORT_PIT_COUNTER2
 0x0042

	)

18 
	#PORT_PIT_MODE
 0x0043

	)

21 
	#PM_SEL_TIMER0
 (0<<6)

	)

22 
	#PM_SEL_TIMER1
 (1<<6)

	)

23 
	#PM_SEL_TIMER2
 (2<<6)

	)

24 
	#PM_SEL_READBACK
 (3<<6)

	)

25 
	#PM_ACCESS_LATCH
 (0<<4)

	)

26 
	#PM_ACCESS_LOBYTE
 (1<<4)

	)

27 
	#PM_ACCESS_HIBYTE
 (2<<4)

	)

28 
	#PM_ACCESS_WORD
 (3<<4)

	)

29 
	#PM_MODE0
 (0<<1)

	)

30 
	#PM_MODE1
 (1<<1)

	)

31 
	#PM_MODE2
 (2<<1)

	)

32 
	#PM_MODE3
 (3<<1)

	)

33 
	#PM_MODE4
 (4<<1)

	)

34 
	#PM_MODE5
 (5<<1)

	)

35 
	#PM_CNT_BINARY
 (0<<0)

	)

36 
	#PM_CNT_BCD
 (1<<0)

	)

37 
	#PM_READ_COUNTER0
 (1<<1)

	)

38 
	#PM_READ_COUNTER1
 (1<<2)

	)

39 
	#PM_READ_COUNTER2
 (1<<3)

	)

40 
	#PM_READ_STATUSVALUE
 (0<<4)

	)

41 
	#PM_READ_VALUE
 (1<<4)

	)

42 
	#PM_READ_STATUS
 (2<<4)

	)

45 
	#PPCB_T2GATE
 (1<<0)

	)

46 
	#PPCB_SPKR
 (1<<1)

	)

47 
	#PPCB_T2OUT
 (1<<5)

	)

49 
	#PMTIMER_HZ
 3579545

50 
	#PMTIMER_TO_PIT
 3

51 

	)

52 
u32
 
TimîKHz
 
	gVARFSEG
;

53 
u16
 
TimîP‹t
 
	gVARFSEG
;

54 
u8
 
Shi·TSC
 
	gVARFSEG
;

61 
	#CALIBRATE_COUNT
 0x800

62 

	)

65 
	$ts˘imî_£tup
()

68 
u8
 
‹ig
 = 
	`öb
(
PORT_PS2_CTRLB
);

69 
	`outb
((
‹ig
 & ~
PPCB_SPKR
Ë| 
PPCB_T2GATE
, 
PORT_PS2_CTRLB
);

71 
	`outb
(
PM_SEL_TIMER2
|
PM_ACCESS_WORD
|
PM_MODE0
|
PM_CNT_BINARY
, 
PORT_PIT_MODE
);

73 
	`outb
(
CALIBRATE_COUNT
 & 0xFF, 
PORT_PIT_COUNTER2
);

75 
	`outb
(
CALIBRATE_COUNT
 >> 8, 
PORT_PIT_COUNTER2
);

77 
u64
 
°¨t
 = 
	`rdts˛l
();

78 (
	`öb
(
PORT_PS2_CTRLB
Ë& 
PPCB_T2OUT
) == 0)

80 
u64
 
íd
 = 
	`rdts˛l
();

83 
	`outb
(
‹ig
, 
PORT_PS2_CTRLB
);

86 
u64
 
diff
 = 
íd
 - 
°¨t
;

87 
	`d¥ötf
(6, "tsc calibrate start=%uÉnd=%u diff=%u\n"

88 , (
u32
)
°¨t
, (u32)
íd
, (u32)
diff
);

89 
u64
 
t
 = 
	`DIV_ROUND_UP
(
diff
 * 
PMTIMER_HZ
, 
CALIBRATE_COUNT
);

90 
t
 >= (1<<24)) {

91 
Shi·TSC
++;

92 
t
 = (t + 1) >> 1;

94 
TimîKHz
 = 
	`DIV_ROUND_UP
((
u32
)
t
, 1000 * 
PMTIMER_TO_PIT
);

96 
	`d¥ötf
(1, "CPU Mhz=%u\n", (
TimîKHz
 << 
Shi·TSC
) / 1000);

97 
	}
}

101 
	$timî_£tup
()

103 i‡(
CONFIG_PMTIMER
 && 
TimîP‹t
) {

104 
	`d¥ötf
(3, "pmtimerálready configured; willÇot calibrate TSC\n");

108 
u32
 
óx
, 
ebx
, 
ecx
, 
edx
, 
˝uid_„©uªs
 = 0;

109 
	`˝uid
(0, &
óx
, &
ebx
, &
ecx
, &
edx
);

110 i‡(
óx
 > 0)

111 
	`˝uid
(1, &
óx
, &
ebx
, &
ecx
, &
˝uid_„©uªs
);

113 i‡(!(
˝uid_„©uªs
 & 
CPUID_TSC
)) {

114 
TimîP‹t
 = 
PORT_PIT_COUNTER0
;

115 
TimîKHz
 = 
	`DIV_ROUND_UP
(
PMTIMER_HZ
, 1000 * 
PMTIMER_TO_PIT
);

116 
	`d¥ötf
(3, "386/486 class CPU. Using TSCÉmulation\n");

120 
	`ts˘imî_£tup
();

121 
	}
}

124 
	$pmtimî_£tup
(
u16
 
i›‹t
)

126 i‡(!
CONFIG_PMTIMER
)

128 
	`d¥ötf
(1, "UsögÖmtimî, i›‹à0x%x\n", 
i›‹t
);

129 
TimîP‹t
 = 
i›‹t
;

130 
TimîKHz
 = 
	`DIV_ROUND_UP
(
PMTIMER_HZ
, 1000);

131 
	}
}

138 
u32
 
TimîLa°
 
	gVARLOW
;

141 
u32


142 
	$timî_adju°_bôs
(
u32
 
vÆue
, u32 
vÆidbôs
)

144 
u32
 
œ°
 = 
	`GET_LOW
(
TimîLa°
);

145 
vÆue
 = (
œ°
 & ~
vÆidbôs
) | (value & validbits);

146 i‡(
vÆue
 < 
œ°
)

147 
vÆue
 +
vÆidbôs
 + 1;

148 
	`SET_LOW
(
TimîLa°
, 
vÆue
);

149  
vÆue
;

150 
	}
}

153 
u32


154 
	$timî_ªad
()

156 
u16
 
p‹t
 = 
	`GET_GLOBAL
(
TimîP‹t
);

157 i‡(!
p‹t
)

159  
	`rdts˛l
(Ë>> 
	`GET_GLOBAL
(
Shi·TSC
);

160 i‡(
CONFIG_PMTIMER
 && 
p‹t
 !
PORT_PIT_COUNTER0
)

162  
	`timî_adju°_bôs
(
	`öl
(
p‹t
), 0xffffff);

164 
	`outb
(
PM_SEL_READBACK
 | 
PM_READ_VALUE
 | 
PM_READ_COUNTER0
, 
PORT_PIT_MODE
);

165 
u16
 
v
 = 
	`öb
(
PORT_PIT_COUNTER0
) | (inb(PORT_PIT_COUNTER0) << 8);

166  
	`timî_adju°_bôs
(
v
, 0xffff);

167 
	}
}

171 
	$timî_check
(
u32
 
íd
)

173  (
s32
)(
	`timî_ªad
(Ë- 
íd
) > 0;

174 
	}
}

177 
	$timî_dñay
(
u32
 
diff
)

179 
u32
 
°¨t
 = 
	`timî_ªad
();

180 
u32
 
íd
 = 
°¨t
 + 
diff
;

181 !
	`timî_check
(
íd
))

182 
	`˝u_ªœx
();

183 
	}
}

186 
	$timî_¶ìp
(
u32
 
diff
)

188 
u32
 
°¨t
 = 
	`timî_ªad
();

189 
u32
 
íd
 = 
°¨t
 + 
diff
;

190 !
	`timî_check
(
íd
))

191 
	`yõld
();

192 
	}
}

194 
	$ndñay
(
u32
 
cou¡
) {

195 
	`timî_dñay
(
	`DIV_ROUND_UP
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
), 1000000));

196 
	}
}

197 
	$udñay
(
u32
 
cou¡
) {

198 
	`timî_dñay
(
	`DIV_ROUND_UP
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
), 1000));

199 
	}
}

200 
	$mdñay
(
u32
 
cou¡
) {

201 
	`timî_dñay
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
));

202 
	}
}

204 
	$n¶ìp
(
u32
 
cou¡
) {

205 
	`timî_¶ìp
(
	`DIV_ROUND_UP
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
), 1000000));

206 
	}
}

207 
	$u¶ìp
(
u32
 
cou¡
) {

208 
	`timî_¶ìp
(
	`DIV_ROUND_UP
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
), 1000));

209 
	}
}

210 
	$m¶ìp
(
u32
 
cou¡
) {

211 
	`timî_¶ìp
(
cou¡
 * 
	`GET_GLOBAL
(
TimîKHz
));

212 
	}
}

215 
u32


216 
	$timî_ˇlc
(
u32
 
m£cs
)

218  
	`timî_ªad
(Ë+ (
	`GET_GLOBAL
(
TimîKHz
Ë* 
m£cs
);

219 
	}
}

220 
u32


221 
	$timî_ˇlc_u£c
(
u32
 
u£cs
)

223  
	`timî_ªad
(Ë+ 
	`DIV_ROUND_UP
(
	`GET_GLOBAL
(
TimîKHz
Ë* 
u£cs
, 1000);

224 
	}
}

231 
	#PIT_TICK_INTERVAL
 65536

232 

	)

234 
u32


235 
	$ticks_to_ms
(
u32
 
ticks
)

237 
u32
 
t
 = 
PIT_TICK_INTERVAL
 * 1000 * 
PMTIMER_TO_PIT
 * 
ticks
;

238  
	`DIV_ROUND_UP
(
t
, 
PMTIMER_HZ
);

239 
	}
}

242 
u32


243 
	$ticks_‰om_ms
(
u32
 
ms
)

245 
u32
 
t
 = 
	`DIV_ROUND_UP
((
u64
)
ms
 * 
PMTIMER_HZ
, 
PIT_TICK_INTERVAL
);

246  
	`DIV_ROUND_UP
(
t
, 1000 * 
PMTIMER_TO_PIT
);

247 
	}
}

250 
	$pô_£tup
()

253 
	`outb
(
PM_SEL_TIMER0
|
PM_ACCESS_WORD
|
PM_MODE2
|
PM_CNT_BINARY
, 
PORT_PIT_MODE
);

255 
	`outb
(0x0, 
PORT_PIT_COUNTER0
);

256 
	`outb
(0x0, 
PORT_PIT_COUNTER0
);

257 
	}
}

	@hw/usb-ehci.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"ouçut.h
"

10 
	~"mÆloc.h
"

11 
	~"pci.h
"

12 
	~"pci_ids.h
"

13 
	~"pci_ªgs.h
"

14 
	~"°rög.h
"

15 
	~"usb.h
"

16 
	~"usb-ehci.h
"

17 
	~"utû.h
"

18 
	~"x86.h
"

20 
	susb_ehci_s
 {

21 
usb_s
 
	musb
;

22 
ehci_ˇps
 *
	mˇps
;

23 
ehci_ªgs
 *
	mªgs
;

24 
ehci_qh
 *
	masync_qh
;

25 
	mcheckp‹ts
;

28 
	sehci_pùe
 {

29 
ehci_qh
 
	mqh
;

30 
ehci_qtd
 *
	m√xt_td
, *
	mtds
;

31 *
	md©a
;

32 
usb_pùe
 
	mpùe
;

35 
	gPídögEHCIP‹ts
;

42 
	#EHCI_TIME_POSTPOWER
 20

	)

43 
	#EHCI_TIME_POSTRESET
 2

	)

47 
	$ehci_hub_dëe˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

49 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ehci_s, 
usb
);

50 
u32
 *
p‹åeg
 = &
˙é
->
ªgs
->
p‹tsc
[
p‹t
];

51 
u32
 
p‹tsc
 = 
	`ªadl
(
p‹åeg
);

54 i‡(!(
p‹tsc
 & 
PORT_POWER
)) {

55 
p‹tsc
 |
PORT_POWER
;

56 
	`wrôñ
(
p‹åeg
, 
p‹tsc
);

57 
	`m¶ìp
(
EHCI_TIME_POSTPOWER
);

61 
	`m¶ìp
(
EHCI_TIME_POSTPOWER
);

63 
p‹tsc
 = 
	`ªadl
(
p‹åeg
);

65 i‡(!(
p‹tsc
 & 
PORT_CONNECT
))

67 
d⁄ì¨ly
;

69 i‡((
p‹tsc
 & 
PORT_LINESTATUS_MASK
Ë=
PORT_LINESTATUS_KSTATE
) {

71 
	`wrôñ
(
p‹åeg
, 
p‹tsc
 | 
PORT_OWNER
);

72 
d⁄ì¨ly
;

78 
p‹tsc
 = (p‹ts¯& ~
PORT_PE
Ë| 
PORT_RESET
;

79 
	`wrôñ
(
p‹åeg
, 
p‹tsc
);

80 
	`m¶ìp
(
USB_TIME_DRSTR
);

83 
d⁄ì¨ly
:

84 
PídögEHCIP‹ts
--;

86 
	}
}

90 
	$ehci_hub_ª£t
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

92 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ehci_s, 
usb
);

93 
u32
 *
p‹åeg
 = &
˙é
->
ªgs
->
p‹tsc
[
p‹t
];

94 
u32
 
p‹tsc
 = 
	`ªadl
(
p‹åeg
);

97 
p‹tsc
 &~
PORT_RESET
;

98 
	`wrôñ
(
p‹åeg
, 
p‹tsc
);

99 
	`m¶ìp
(
EHCI_TIME_POSTRESET
);

101 
rv
 = -1;

102 
p‹tsc
 = 
	`ªadl
(
p‹åeg
);

103 i‡(!(
p‹tsc
 & 
PORT_CONNECT
))

105 
ª£tÁû
;

106 i‡(!(
p‹tsc
 & 
PORT_PE
)) {

108 
	`wrôñ
(
p‹åeg
, 
p‹tsc
 | 
PORT_OWNER
);

109 
ª£tÁû
;

112 
rv
 = 
USB_HIGHSPEED
;

113 
ª£tÁû
:

114 
PídögEHCIP‹ts
--;

115  
rv
;

116 
	}
}

120 
	$ehci_hub_disc⁄√˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

122 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ehci_s, 
usb
);

123 
u32
 *
p‹åeg
 = &
˙é
->
ªgs
->
p‹tsc
[
p‹t
];

124 
u32
 
p‹tsc
 = 
	`ªadl
(
p‹åeg
);

125 
	`wrôñ
(
p‹åeg
, 
p‹tsc
 & ~
PORT_PE
);

126 
	}
}

128 
usbhub_›_s
 
	gehci_HubOp
 = {

129 .
dëe˘
 = 
ehci_hub_dëe˘
,

130 .
	gª£t
 = 
ehci_hub_ª£t
,

131 .
	gdisc⁄√˘
 = 
ehci_hub_disc⁄√˘
,

136 
	$check_ehci_p‹ts
(
usb_ehci_s
 *
˙é
)

138 
	`ASSERT32FLAT
();

139 
usbhub_s
 
hub
;

140 
	`mem£t
(&
hub
, 0, (hub));

141 
hub
.
˙é
 = &˙é->
usb
;

142 
hub
.
p‹tcou¡
 = 
˙é
->
checkp‹ts
;

143 
hub
.
›
 = &
ehci_HubOp
;

144 
	`usb_íumî©e
(&
hub
);

145  
hub
.
devcou¡
;

146 
	}
}

155 
	$ehci_waôtick
(
usb_ehci_s
 *
˙é
)

157 i‡(
MODE16
) {

158 
	`m¶ìp
(10);

162 
	`b¨rõr
();

163 
u32
 
cmd
, 
°s
;

164 
u32
 
íd
 = 
	`timî_ˇlc
(100);

166 
°s
 = 
	`ªadl
(&
˙é
->
ªgs
->
usb°s
);

167 i‡(!(
°s
 & 
STS_IAA
)) {

168 
cmd
 = 
	`ªadl
(&
˙é
->
ªgs
->
usbcmd
);

169 i‡(!(
cmd
 & 
CMD_IAAD
))

172 i‡(
	`timî_check
(
íd
)) {

173 
	`w¨n_timeout
();

176 
	`yõld
();

179 
	`wrôñ
(&
˙é
->
ªgs
->
usbcmd
, 
cmd
 | 
CMD_IAAD
);

182 
°s
 = 
	`ªadl
(&
˙é
->
ªgs
->
usb°s
);

183 i‡(
°s
 & 
STS_IAA
)

185 i‡(
	`timî_check
(
íd
)) {

186 
	`w¨n_timeout
();

189 
	`yõld
();

192 
	`wrôñ
(&
˙é
->
ªgs
->
usb°s
, 
STS_IAA
);

193 
	}
}

196 
	$ehci_‰ì_pùes
(
usb_ehci_s
 *
˙é
)

198 
	`d¥ötf
(7, "ehci_‰ì_pùe†%p\n", 
˙é
);

200 
ehci_qh
 *
°¨t
 = 
˙é
->
async_qh
;

201 
ehci_qh
 *
pos
 = 
°¨t
;

203 
ehci_qh
 *
√xt
 = (*)(
pos
->√xà& ~
EHCI_PTR_BITS
);

204 i‡(
√xt
 =
°¨t
)

206 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
√xt
, ehci_pùe, 
qh
);

207 i‡(
pùe
->pùe.
˙é
 !&˙é->
usb
)

208 
pos
->
√xt
 =Çext->next;

210 
pos
 = 
√xt
;

212 
	`ehci_waôtick
(
˙é
);

214 
usb_pùe
 *
usbpùe
 = 
˙é
->
usb
.
‰ìli°
;

215 i‡(!
usbpùe
)

217 
˙é
->
usb
.
‰ìli°
 = 
usbpùe
->
‰ì√xt
;

218 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
usbpùe
, ehci_pipe,Öipe);

219 
	`‰ì
(
pùe
);

221 
	}
}

224 
	$c⁄figuª_ehci
(*
d©a
)

226 
usb_ehci_s
 *
˙é
 = 
d©a
;

229 
ehci_‰amñi°
 *
Ê
 = 
	`memÆign_high
((*fl), (*fl));

230 
ehci_qh
 *
öå_qh
 = 
	`memÆign_high
(
EHCI_QH_ALIGN
, (*intr_qh));

231 
ehci_qh
 *
async_qh
 = 
	`memÆign_high
(
EHCI_QH_ALIGN
, (*async_qh));

232 i‡(!
Ê
 || !
öå_qh
 || !
async_qh
) {

233 
	`w¨n_nﬂŒoc
();

234 
Áû
;

240 
u32
 
cmd
 = 
	`ªadl
(&
˙é
->
ªgs
->
usbcmd
);

241 
	`wrôñ
(&
˙é
->
ªgs
->
usbcmd
, (
cmd
 & ~(
CMD_ASE
 | 
CMD_PSE
)Ë| 
CMD_HCRESET
);

242 
u32
 
íd
 = 
	`timî_ˇlc
(250);

244 
cmd
 = 
	`ªadl
(&
˙é
->
ªgs
->
usbcmd
);

245 i‡(!(
cmd
 & 
CMD_HCRESET
))

247 i‡(
	`timî_check
(
íd
)) {

248 
	`w¨n_timeout
();

249 
Áû
;

251 
	`yõld
();

255 
	`wrôñ
(&
˙é
->
ªgs
->
usböå
, 0);

258 
	`mem£t
(
öå_qh
, 0, (*intr_qh));

259 
öå_qh
->
√xt
 = 
EHCI_PTR_TERM
;

260 
öå_qh
->
öfo2
 = (0x01 << 
QH_SMASK_SHIFT
);

261 
öå_qh
->
tokí
 = 
QTD_STS_HALT
;

262 
öå_qh
->
qtd_√xt
 = i¡r_qh->
Æt_√xt
 = 
EHCI_PTR_TERM
;

263 
i
;

264 
i
=0; i<
	`ARRAY_SIZE
(
Ê
->
löks
); i++)

265 
Ê
->
löks
[
i
] = (
u32
)
öå_qh
 | 
EHCI_PTR_QH
;

266 
	`wrôñ
(&
˙é
->
ªgs
->
≥riodi˛i°ba£
, (
u32
)
Ê
);

269 
	`mem£t
(
async_qh
, 0, (*async_qh));

270 
async_qh
->
√xt
 = (
u32
Ôsync_qh | 
EHCI_PTR_QH
;

271 
async_qh
->
öfo1
 = 
QH_HEAD
;

272 
async_qh
->
tokí
 = 
QTD_STS_HALT
;

273 
async_qh
->
qtd_√xt
 =ásync_qh->
Æt_√xt
 = 
EHCI_PTR_TERM
;

274 
˙é
->
async_qh
 =ásync_qh;

275 
	`wrôñ
(&
˙é
->
ªgs
->
asyn˛i°ba£
, (
u32
)
async_qh
);

278 
	`wrôñ
(&
˙é
->
ªgs
->
usbcmd
, 
cmd
 | 
CMD_ASE
 | 
CMD_PSE
 | 
CMD_RUN
);

281 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄figÊag
, 1);

284 
cou¡
 = 
	`check_ehci_p‹ts
(
˙é
);

285 
	`ehci_‰ì_pùes
(
˙é
);

286 i‡(
cou¡
)

291 
	`wrôñ
(&
˙é
->
ªgs
->
usbcmd
, 
cmd
 & ~
CMD_RUN
);

292 
	`m¶ìp
(4);

293 
Áû
:

294 
	`‰ì
(
Ê
);

295 
	`‰ì
(
öå_qh
);

296 
	`‰ì
(
async_qh
);

297 
	`‰ì
(
˙é
);

298 
	}
}

301 
	$ehci_c⁄åﬁÀr_£tup
(
pci_devi˚
 *
pci
)

303 
	`waô_¥ìm±
();

304 
u16
 
bdf
 = 
pci
->bdf;

305 
u32
 
ba£addr
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_0
);

306 
ehci_ˇps
 *
ˇps
 = (*)(
ba£addr
 & 
PCI_BASE_ADDRESS_MEM_MASK
);

307 
u32
 
hcc_∑øms
 = 
	`ªadl
(&
ˇps
->
hc˝¨ams
);

309 
usb_ehci_s
 *
˙é
 = 
	`mÆloc_tmphigh
((*cntl));

310 i‡(!
˙é
) {

311 
	`w¨n_nﬂŒoc
();

314 
	`mem£t
(
˙é
, 0, (*cntl));

315 
˙é
->
usb
.
pci
 =Öci;

316 
˙é
->
usb
.
ty≥
 = 
USB_TYPE_EHCI
;

317 
˙é
->
ˇps
 = caps;

318 
˙é
->
checkp‹ts
 = 
	`ªadl
(&˙é->
ˇps
->
hc•¨ams
Ë& 
HCS_N_PORTS_MASK
;

319 
˙é
->
ªgs
 = (*)
ˇps
 + 
	`ªadb
(&ˇps->
ˇ∂ígth
);

320 i‡(
hcc_∑øms
 & 
HCC_64BIT_ADDR
)

321 
˙é
->
ªgs
->
˘æds£gmít
 = 0;

322 
PídögEHCIP‹ts
 +
˙é
->
checkp‹ts
;

324 
	`d¥ötf
(1, "EHCI init on dev %02x:%02x.%x (regs=%p)\n"

325 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf)

326 , 
	`pci_bdf_to_‚
(
bdf
), 
˙é
->
ªgs
);

328 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

332 
	`run_thªad
(
c⁄figuª_ehci
, 
˙é
);

333 
	}
}

336 
	$ehci_£tup
()

338 i‡(! 
CONFIG_USB_EHCI
)

340 
pci_devi˚
 *
pci
;

341 
	`f‹óchpci
(
pci
) {

342 i‡(
	`pci_˛as•rog
(
pci
Ë=
PCI_CLASS_SERIAL_USB_EHCI
)

343 
	`ehci_c⁄åﬁÀr_£tup
(
pci
);

347 
PídögEHCIP‹ts
)

348 
	`yõld
();

349 
	}
}

358 
	$ehci_desc2pùe
(
ehci_pùe
 *
pùe
, 
usbdevi˚_s
 *
usbdev


359 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

361 
	`usb_desc2pùe
(&
pùe
->pùe, 
usbdev
, 
ïdesc
);

363 
pùe
->
qh
.
öfo1
 = (’ùe->pùe.
max∑ckë
 << 
QH_MAXPACKET_SHIFT
)

364 | (
pùe
->pùe.
•ìd
 << 
QH_SPEED_SHIFT
)

365 | (
pùe
->pùe.
ï
 << 
QH_EP_SHIFT
)

366 | (
pùe
->pùe.
devaddr
 << 
QH_DEVADDR_SHIFT
));

368 
pùe
->
qh
.
öfo2
 = (1 << 
QH_MULT_SHIFT
);

369 
usbdevi˚_s
 *
hubdev
 = 
usbdev
->
hub
->usbdev;

370 i‡(
hubdev
) {

371 
ehci_pùe
 *
hpùe
 = 
	`c⁄èöî_of
(

372 
hubdev
->
deÂùe
, 
ehci_pùe
, 
pùe
);

373 i‡(
hpùe
->
pùe
.
•ìd
 =
USB_HIGHSPEED
)

374 
pùe
->
qh
.
öfo2
 |((
usbdev
->
p‹t
 << 
QH_HUBPORT_SHIFT
)

375 | (
hpùe
->
pùe
.
devaddr
 << 
QH_HUBADDR_SHIFT
));

377 
pùe
->
qh
.
öfo2
 = 
hpùe
->qh.info2;

380 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

381 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

382 
pùe
->
qh
.
öfo1
 |(’ùe->pùe.
•ìd
 !
USB_HIGHSPEED
 ? 
QH_CONTROL
 : 0)

383 | 
QH_TOGGLECONTROL
);

384 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

385 
pùe
->
qh
.
öfo2
 |(0x01 << 
QH_SMASK_SHIFT
Ë| (0x1¯<< 
QH_CMASK_SHIFT
);

386 
	}
}

388 
usb_pùe
 *

389 
	$ehci_Æloc_öå_pùe
(
usbdevi˚_s
 *
usbdev


390 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

392 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(

393 
usbdev
->
hub
->
˙é
, 
usb_ehci_s
, 
usb
);

394 
‰amìxp
 = 
	`usb_gëFømeExp
(
usbdev
, 
ïdesc
);

395 
	`d¥ötf
(7, "ehci_Æloc_öå_pùê%∞%d\n", &
˙é
->
usb
, 
‰amìxp
);

397 i‡(
‰amìxp
 > 10)

398 
‰amìxp
 = 10;

399 
max∑ckë
 = 
ïdesc
->
wMaxPackëSize
;

401 
ms
 = 1<<
‰amìxp
;

402 
cou¡
 = 
	`DIV_ROUND_UP
(
	`ticks_to_ms
(2), 
ms
);

403 
ehci_pùe
 *
pùe
 = 
	`memÆign_low
(
EHCI_QH_ALIGN
, (*pipe));

404 
ehci_qtd
 *
tds
 = 
	`memÆign_low
(
EHCI_QTD_ALIGN
, (*tdsË* 
cou¡
);

405 *
d©a
 = 
	`mÆloc_low
(
max∑ckë
 * 
cou¡
);

406 i‡(!
pùe
 || !
tds
 || !
d©a
) {

407 
	`w¨n_nﬂŒoc
();

408 
Áû
;

410 
	`mem£t
(
pùe
, 0, (*pipe));

411 
	`mem£t
(
tds
, 0, (*tdsË* 
cou¡
);

412 
	`mem£t
(
d©a
, 0, 
max∑ckë
 * 
cou¡
);

413 
	`ehci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

414 
pùe
->
√xt_td
 =Öùe->
tds
 =Åds;

415 
pùe
->
d©a
 = data;

416 
pùe
->
qh
.
qtd_√xt
 = (
u32
)
tds
;

418 
i
;

419 
i
=0; i<
cou¡
; i++) {

420 
ehci_qtd
 *
td
 = &
tds
[
i
];

421 
td
->
qtd_√xt
 = (
i
==
cou¡
-1 ? (
u32
)
tds
 : (u32)&td[1]);

422 
td
->
Æt_√xt
 = 
EHCI_PTR_TERM
;

423 
td
->
tokí
 = (
	`ehci_ex∂í
(
max∑ckë
Ë| 
QTD_STS_ACTIVE


424 | 
QTD_PID_IN
 | 
	`ehci_maxîr
(3));

425 
td
->
buf
[0] = (
u32
)
d©a
 + 
max∑ckë
 * 
i
;

429 
ehci_‰amñi°
 *
Ê
 = (*)
	`ªadl
(&
˙é
->
ªgs
->
≥riodi˛i°ba£
);

430 i‡(
‰amìxp
 == 0) {

432 
ehci_qh
 *
öå_qh
 = (*)(
Ê
->
löks
[0] & ~
EHCI_PTR_BITS
);

433 
pùe
->
qh
.
√xt
 = 
öå_qh
->next;

434 
	`b¨rõr
();

435 
öå_qh
->
√xt
 = (
u32
)&
pùe
->
qh
 | 
EHCI_PTR_QH
;

437 
°¨ços
 = 1<<(
‰amìxp
-1);

438 
pùe
->
qh
.
√xt
 = 
Ê
->
löks
[
°¨ços
];

439 
	`b¨rõr
();

440 
i
=
°¨ços
; i<
	`ARRAY_SIZE
(
Ê
->
löks
); i+=
ms
)

441 
Ê
->
löks
[
i
] = (
u32
)&
pùe
->
qh
 | 
EHCI_PTR_QH
;

444  &
pùe
->pipe;

445 
Áû
:

446 
	`‰ì
(
pùe
);

447 
	`‰ì
(
tds
);

448 
	`‰ì
(
d©a
);

449  
NULL
;

450 
	}
}

452 
usb_pùe
 *

453 
	$ehci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


454 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

456 i‡(! 
CONFIG_USB_EHCI
)

457  
NULL
;

458 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

459 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

460  
	`ehci_Æloc_öå_pùe
(
usbdev
, 
ïdesc
);

461 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(

462 
usbdev
->
hub
->
˙é
, 
usb_ehci_s
, 
usb
);

463 
	`d¥ötf
(7, "ehci_Æloc_async_pùê%∞%d\n", &
˙é
->
usb
, 
ïty≥
);

465 
usb_pùe
 *
usbpùe
 = 
	`usb_gëFªePùe
(&
˙é
->
usb
, 
ïty≥
);

466 i‡(
usbpùe
) {

468 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
usbpùe
, ehci_pipe,Öipe);

469 
	`ehci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

470  
usbpùe
;

474 
ehci_pùe
 *
pùe
;

475 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

476 
pùe
 = 
	`memÆign_tmphigh
(
EHCI_QH_ALIGN
, (*pipe));

478 
pùe
 = 
	`memÆign_low
(
EHCI_QH_ALIGN
, (*pipe));

479 i‡(!
pùe
) {

480 
	`w¨n_nﬂŒoc
();

481  
NULL
;

483 
	`mem£t
(
pùe
, 0, (*pipe));

484 
	`ehci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

485 
pùe
->
qh
.
qtd_√xt
 =Öùe->qh.
Æt_√xt
 = 
EHCI_PTR_TERM
;

488 
ehci_qh
 *
async_qh
 = 
˙é
->async_qh;

489 
pùe
->
qh
.
√xt
 = 
async_qh
->next;

490 
	`b¨rõr
();

491 
async_qh
->
√xt
 = (
u32
)&
pùe
->
qh
 | 
EHCI_PTR_QH
;

492  &
pùe
->pipe;

493 
	}
}

496 
	$ehci_ª£t_pùe
(
ehci_pùe
 *
pùe
)

498 
	`SET_LOWFLAT
(
pùe
->
qh
.
qtd_√xt
, 
EHCI_PTR_TERM
);

499 
	`SET_LOWFLAT
(
pùe
->
qh
.
Æt_√xt
, 
EHCI_PTR_TERM
);

500 
	`b¨rõr
();

501 
	`SET_LOWFLAT
(
pùe
->
qh
.
tokí
, 
	`GET_LOWFLAT
’ùe->qh.tokíË& 
QTD_TOGGLE
);

502 
	}
}

505 
	$ehci_waô_td
(
ehci_pùe
 *
pùe
, 
ehci_qtd
 *
td
, 
timeout
)

507 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

508 
u32
 
°©us
;

510 
°©us
 = 
td
->
tokí
;

511 i‡(!(
°©us
 & 
QTD_STS_ACTIVE
))

513 i‡(
	`timî_check
(
íd
)) {

514 
u32
 
cur
 = 
	`GET_LOWFLAT
(
pùe
->
qh
.
cuºít
);

515 
u32
 
tok
 = 
	`GET_LOWFLAT
(
pùe
->
qh
.
tokí
);

516 
u32
 
√xt
 = 
	`GET_LOWFLAT
(
pùe
->
qh
.
qtd_√xt
);

517 
	`w¨n_timeout
();

518 
	`d¥ötf
(1, "ehciÖipe=%p cur=%08xÅok=%08xÇext=%xÅd=%p status=%x\n"

519 , 
pùe
, 
cur
, 
tok
, 
√xt
, 
td
, 
°©us
);

520 
	`ehci_ª£t_pùe
(
pùe
);

521 
usb_ehci_s
 *
˙é
 = 
	`c⁄èöî_of
(

522 
	`GET_LOWFLAT
(
pùe
->pùe.
˙é
), 
usb_ehci_s
, 
usb
);

523 
	`ehci_waôtick
(
˙é
);

526 
	`yõld
();

528 i‡(
°©us
 & 
QTD_STS_HALT
) {

529 
	`d¥ötf
(1, "ehci_waô_tdÉº‹ - sètus=%x\n", 
°©us
);

530 
	`ehci_ª£t_pùe
(
pùe
);

534 
	}
}

537 
	$fûlTDbuf„r
(
ehci_qtd
 *
td
, 
u16
 
max∑ckë
, c⁄° *
buf
, 
byãs
)

539 
u32
 
de°
 = (u32)
buf
;

540 
u32
 *
pos
 = 
td
->
buf
;

541 
byãs
) {

542 i‡(
pos
 >&
td
->
buf
[
	`ARRAY_SIZE
(td->buf)])

545  
	`ALIGN_DOWN
(
de°
 - (
u32
)
buf
, 
max∑ckë
);

546 
u32
 
cou¡
 = 
byãs
;

547 
u32
 
max
 = 0x1000 - (
de°
 & 0xfff);

548 i‡(
cou¡
 > 
max
)

549 
cou¡
 = 
max
;

550 *
pos
 = 
de°
;

551 
byãs
 -
cou¡
;

552 
de°
 +
cou¡
;

553 
pos
++;

555  
de°
 - (
u32
)
buf
;

556 
	}
}

559 
	$ehci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


560 , *
d©a
, 
d©asize
)

562 
	`ASSERT32FLAT
();

563 i‡(! 
CONFIG_USB_EHCI
)

565 
	`d¥ötf
(5, "ehci_control %p (dir=%d cmd=%d data=%d)\n"

566 , 
p
, 
dú
, 
cmdsize
, 
d©asize
);

567 i‡(
d©asize
 > 4*4096 || 
cmdsize
 > 4*4096) {

569 
	`w¨n_nﬂŒoc
();

572 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, ehci_pipe,Öipe);

575 
ehci_qtd
 *
tds
 = 
	`memÆign_tmphigh
(
EHCI_QTD_ALIGN
, (*tds) * 3);

576 i‡(!
tds
) {

577 
	`w¨n_nﬂŒoc
();

580 
	`mem£t
(
tds
, 0, (*tds) * 3);

581 
ehci_qtd
 *
td
 = 
tds
;

583 
td
->
qtd_√xt
 = (
u32
)&td[1];

584 
td
->
Æt_√xt
 = 
EHCI_PTR_TERM
;

585 
td
->
tokí
 = (
	`ehci_ex∂í
(
cmdsize
Ë| 
QTD_STS_ACTIVE


586 | 
QTD_PID_SETUP
 | 
	`ehci_maxîr
(3));

587 
u16
 
max∑ckë
 = 
pùe
->pipe.maxpacket;

588 
	`fûlTDbuf„r
(
td
, 
max∑ckë
, 
cmd
, 
cmdsize
);

589 
td
++;

591 i‡(
d©asize
) {

592 
td
->
qtd_√xt
 = (
u32
)&td[1];

593 
td
->
Æt_√xt
 = 
EHCI_PTR_TERM
;

594 
td
->
tokí
 = (
QTD_TOGGLE
 | 
	`ehci_ex∂í
(
d©asize
Ë| 
QTD_STS_ACTIVE


595 | (
dú
 ? 
QTD_PID_IN
 : 
QTD_PID_OUT
Ë| 
	`ehci_maxîr
(3));

596 
	`fûlTDbuf„r
(
td
, 
max∑ckë
, 
d©a
, 
d©asize
);

597 
td
++;

600 
td
->
qtd_√xt
 = 
EHCI_PTR_TERM
;

601 
td
->
Æt_√xt
 = 
EHCI_PTR_TERM
;

602 
td
->
tokí
 = (
QTD_TOGGLE
 | 
QTD_STS_ACTIVE


603 | (
dú
 ? 
QTD_PID_OUT
 : 
QTD_PID_IN
Ë| 
	`ehci_maxîr
(3));

606 
	`b¨rõr
();

607 
pùe
->
qh
.
qtd_√xt
 = (
u32
)
tds
;

608 
i
, 
ªt
=0;

609 
i
=0; i<3; i++) {

610 
ehci_qtd
 *
td
 = &
tds
[
i
];

611 
ªt
 = 
	`ehci_waô_td
(
pùe
, 
td
, 500);

612 i‡(
ªt
)

615 
	`‰ì
(
tds
);

616  
ªt
;

617 
	}
}

619 
	#STACKQTDS
 4

	)

622 
	$ehci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
)

624 i‡(! 
CONFIG_USB_EHCI
)

626 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, ehci_pipe,Öipe);

627 
	`d¥ötf
(7, "ehci_send_bulk qh=%p dir=%d data=%p size=%d\n"

628 , &
pùe
->
qh
, 
dú
, 
d©a
, 
d©asize
);

631 
u8
 
tdsbuf
[(
ehci_qtd
Ë* 
STACKQTDS
 + 
EHCI_QTD_ALIGN
 - 1];

632 
ehci_qtd
 *
tds
 = (*)
	`ALIGN
((
u32
)
tdsbuf
, 
EHCI_QTD_ALIGN
);

633 
	`mem£t
(
tds
, 0, (*tdsË* 
STACKQTDS
);

634 
	`b¨rõr
();

635 
	`SET_LOWFLAT
(
pùe
->
qh
.
qtd_√xt
, (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
tds
));

637 
u16
 
max∑ckë
 = 
	`GET_LOWFLAT
(
pùe
->pipe.maxpacket);

638 
tdpos
 = 0;

639 
d©asize
) {

640 
ehci_qtd
 *
td
 = &
tds
[
tdpos
++ % 
STACKQTDS
];

641 
ªt
 = 
	`ehci_waô_td
(
pùe
, 
td
, 5000);

642 i‡(
ªt
)

645 
ehci_qtd
 *
√xâd_Ê
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
)

646 , &
tds
[
tdpos
 % 
STACKQTDS
]);

648 
å™s„r
 = 
	`fûlTDbuf„r
(
td
, 
max∑ckë
, 
d©a
, 
d©asize
);

649 
td
->
qtd_√xt
 = (
å™s„r
==
d©asize
 ? 
EHCI_PTR_TERM
 : (
u32
)
√xâd_Ê
);

650 
td
->
Æt_√xt
 = 
EHCI_PTR_TERM
;

651 
	`b¨rõr
();

652 
td
->
tokí
 = (
	`ehci_ex∂í
(
å™s„r
Ë| 
QTD_STS_ACTIVE


653 | (
dú
 ? 
QTD_PID_IN
 : 
QTD_PID_OUT
Ë| 
	`ehci_maxîr
(3));

655 
d©a
 +
å™s„r
;

656 
d©asize
 -
å™s„r
;

658 
i
;

659 
i
=0; i<
STACKQTDS
; i++) {

660 
ehci_qtd
 *
td
 = &
tds
[
tdpos
++ % 
STACKQTDS
];

661 
ªt
 = 
	`ehci_waô_td
(
pùe
, 
td
, 5000);

662 i‡(
ªt
)

667 
	}
}

670 
	$ehci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
)

672 
	`ASSERT16
();

673 i‡(! 
CONFIG_USB_EHCI
)

675 
ehci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, ehci_pipe,Öipe);

676 
ehci_qtd
 *
td
 = 
	`GET_LOWFLAT
(
pùe
->
√xt_td
);

677 
u32
 
tokí
 = 
	`GET_LOWFLAT
(
td
->token);

678 i‡(
tokí
 & 
QTD_STS_ACTIVE
)

684 
max∑ckë
 = 
	`GET_LOWFLAT
(
pùe
->pipe.maxpacket);

685 
pos
 = 
td
 - 
	`GET_LOWFLAT
(
pùe
->
tds
);

686 *
tdd©a
 = 
	`GET_LOWFLAT
(
pùe
->
d©a
Ë+ 
max∑ckë
 * 
pos
;

687 
	`mem˝y_Ár
(
	`GET_SEG
(
SS
), 
d©a
, 
SEG_LOW
, 
	`LOWFLAT2LOW
(
tdd©a
), 
max∑ckë
);

690 
ehci_qtd
 *
√xt
 = (*)(
	`GET_LOWFLAT
(
td
->
qtd_√xt
Ë& ~
EHCI_PTR_BITS
);

691 
	`SET_LOWFLAT
(
pùe
->
√xt_td
, 
√xt
);

692 
	`SET_LOWFLAT
(
td
->
buf
[0], (
u32
)
tdd©a
);

693 
	`b¨rõr
();

694 
	`SET_LOWFLAT
(
td
->
tokí
, (
	`ehci_ex∂í
(
max∑ckë
Ë| 
QTD_STS_ACTIVE


695 | 
QTD_PID_IN
 | 
	`ehci_maxîr
(3)));

698 
	}
}

	@hw/usb-ehci.h

1 #i‚de‡
__USB_EHCI_H


2 
	#__USB_EHCI_H


	)

5 
ehci_£tup
();

6 
	gusbdevi˚_s
;

7 
	gusb_ídpoöt_des¸ùt‹
;

8 
usb_pùe
 *
ehci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


9 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

10 
	gusb_pùe
;

11 
ehci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


12 , *
d©a
, 
d©asize
);

13 
ehci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
);

14 
ehci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
);

21 
	sehci_ˇps
 {

22 
u8
 
	mˇ∂ígth
;

23 
u8
 
	mª£rved_01
;

24 
u16
 
	mhcivîsi⁄
;

25 
u32
 
	mhc•¨ams
;

26 
u32
 
	mhc˝¨ams
;

27 
u64
 
	mp‹åouã
;

28 } 
	gPACKED
;

30 
	#HCC_64BIT_ADDR
 1

	)

32 
	#HCS_N_PORTS_MASK
 0xf

	)

34 
	sehci_ªgs
 {

35 
u32
 
	musbcmd
;

36 
u32
 
	musb°s
;

37 
u32
 
	musböå
;

38 
u32
 
	m‰ödex
;

39 
u32
 
	m˘æds£gmít
;

40 
u32
 
	m≥riodi˛i°ba£
;

41 
u32
 
	masyn˛i°ba£
;

42 
u32
 
	mª£rved
[9];

43 
u32
 
	mc⁄figÊag
;

44 
u32
 
	mp‹tsc
[0];

45 } 
	gPACKED
;

47 
	#CMD_PARK
 (1<<11)

	)

48 
	#CMD_PARK_CNT
(
c
Ë(((c)>>8)&3)

	)

49 
	#CMD_LRESET
 (1<<7)

	)

50 
	#CMD_IAAD
 (1<<6)

	)

51 
	#CMD_ASE
 (1<<5)

	)

52 
	#CMD_PSE
 (1<<4)

	)

53 
	#CMD_HCRESET
 (1<<1)

	)

54 
	#CMD_RUN
 (1<<0)

	)

56 
	#STS_ASS
 (1<<15)

	)

57 
	#STS_PSS
 (1<<14)

	)

58 
	#STS_RECL
 (1<<13)

	)

59 
	#STS_HALT
 (1<<12)

	)

60 
	#STS_IAA
 (1<<5)

	)

61 
	#STS_FATAL
 (1<<4)

	)

62 
	#STS_FLR
 (1<<3)

	)

63 
	#STS_PCD
 (1<<2)

	)

64 
	#STS_ERR
 (1<<1)

	)

65 
	#STS_INT
 (1<<0)

	)

67 
	#FLAG_CF
 (1<<0)

	)

69 
	#PORT_WKOC_E
 (1<<22)

	)

70 
	#PORT_WKDISC_E
 (1<<21)

	)

71 
	#PORT_WKCONN_E
 (1<<20)

	)

72 
	#PORT_TEST_PKT
 (0x4<<16)

	)

73 
	#PORT_LED_OFF
 (0<<14)

	)

74 
	#PORT_LED_AMBER
 (1<<14)

	)

75 
	#PORT_LED_GREEN
 (2<<14)

	)

76 
	#PORT_LED_MASK
 (3<<14)

	)

77 
	#PORT_OWNER
 (1<<13)

	)

78 
	#PORT_POWER
 (1<<12)

	)

79 
	#PORT_LINESTATUS_MASK
 (3<<10)

	)

80 
	#PORT_LINESTATUS_KSTATE
 (1<<10)

	)

81 
	#PORT_RESET
 (1<<8)

	)

82 
	#PORT_SUSPEND
 (1<<7)

	)

83 
	#PORT_RESUME
 (1<<6)

	)

84 
	#PORT_OCC
 (1<<5)

	)

85 
	#PORT_OC
 (1<<4)

	)

86 
	#PORT_PEC
 (1<<3)

	)

87 
	#PORT_PE
 (1<<2)

	)

88 
	#PORT_CSC
 (1<<1)

	)

89 
	#PORT_CONNECT
 (1<<0)

	)

90 
	#PORT_RWC_BITS
 (
PORT_CSC
 | 
PORT_PEC
 | 
PORT_OCC
)

	)

93 
	#EHCI_QH_ALIGN
 128

94 

	)

95 
	sehci_qh
 {

96 
u32
 
	m√xt
;

97 
u32
 
	möfo1
;

98 
u32
 
	möfo2
;

99 
u32
 
	mcuºít
;

101 
u32
 
	mqtd_√xt
;

102 
u32
 
	mÆt_√xt
;

103 
u32
 
	mtokí
;

104 
u32
 
	mbuf
[5];

105 
u32
 
	mbuf_hi
[5];

106 } 
	gPACKED
;

108 
	#QH_CONTROL
 (1 << 27)

	)

109 
	#QH_MAXPACKET_SHIFT
 16

	)

110 
	#QH_MAXPACKET_MASK
 (0x7f‡<< 
QH_MAXPACKET_SHIFT
)

	)

111 
	#QH_HEAD
 (1 << 15)

	)

112 
	#QH_TOGGLECONTROL
 (1 << 14)

	)

113 
	#QH_SPEED_SHIFT
 12

	)

114 
	#QH_SPEED_MASK
 (0x3 << 
QH_SPEED_SHIFT
)

	)

115 
	#QH_EP_SHIFT
 8

	)

116 
	#QH_EP_MASK
 (0x‡<< 
QH_EP_SHIFT
)

	)

117 
	#QH_DEVADDR_SHIFT
 0

	)

118 
	#QH_DEVADDR_MASK
 (0x7‡<< 
QH_DEVADDR_SHIFT
)

	)

120 
	#QH_SMASK_SHIFT
 0

	)

121 
	#QH_SMASK_MASK
 (0xf‡<< 
QH_SMASK_SHIFT
)

	)

122 
	#QH_CMASK_SHIFT
 8

	)

123 
	#QH_CMASK_MASK
 (0xf‡<< 
QH_CMASK_SHIFT
)

	)

124 
	#QH_HUBADDR_SHIFT
 16

	)

125 
	#QH_HUBADDR_MASK
 (0x7‡<< 
QH_HUBADDR_SHIFT
)

	)

126 
	#QH_HUBPORT_SHIFT
 23

	)

127 
	#QH_HUBPORT_MASK
 (0x7‡<< 
QH_HUBPORT_SHIFT
)

	)

128 
	#QH_MULT_SHIFT
 30

	)

129 
	#QH_MULT_MASK
 (0x3 << 
QH_MULT_SHIFT
)

	)

131 
	#EHCI_PTR_BITS
 0x001F

	)

132 
	#EHCI_PTR_TERM
 0x0001

	)

133 
	#EHCI_PTR_QH
 0x0002

	)

136 
	#EHCI_QTD_ALIGN
 64

137 

	)

138 
	sehci_qtd
 {

139 
u32
 
	mqtd_√xt
;

140 
u32
 
	mÆt_√xt
;

141 
u32
 
	mtokí
;

142 
u32
 
	mbuf
[5];

143 
u32
 
	mbuf_hi
[5];

147 } 
PACKED
 
__Æig√d
(
EHCI_QTD_ALIGN
);

149 
	#QTD_TOGGLE
 (1 << 31)

	)

150 
	#QTD_LENGTH_SHIFT
 16

	)

151 
	#QTD_LENGTH_MASK
 (0x7ff‡<< 
QTD_LENGTH_SHIFT
)

	)

152 
	#QTD_CERR_SHIFT
 10

	)

153 
	#QTD_CERR_MASK
 (0x3 << 
QTD_CERR_SHIFT
)

	)

154 
	#QTD_IOC
 (1 << 15)

	)

155 
	#QTD_PID_OUT
 (0x0 << 8)

	)

156 
	#QTD_PID_IN
 (0x1 << 8)

	)

157 
	#QTD_PID_SETUP
 (0x2 << 8)

	)

158 
	#QTD_STS_ACTIVE
 (1 << 7)

	)

159 
	#QTD_STS_HALT
 (1 << 6)

	)

160 
	#QTD_STS_DBE
 (1 << 5)

	)

161 
	#QTD_STS_BABBLE
 (1 << 4)

	)

162 
	#QTD_STS_XACT
 (1 << 3)

	)

163 
	#QTD_STS_MMF
 (1 << 2)

	)

164 
	#QTD_STS_STS
 (1 << 1)

	)

165 
	#QTD_STS_PING
 (1 << 0)

	)

167 
	#ehci_ex∂í
(
Àn
Ë((÷íË<< 
QTD_LENGTH_SHIFT
Ë& 
QTD_LENGTH_MASK
)

	)

169 
	#ehci_maxîr
(
îr
Ë((”ºË<< 
QTD_CERR_SHIFT
Ë& 
QTD_CERR_MASK
)

	)

172 
	sehci_‰amñi°
 {

173 
u32
 
	mlöks
[1024];

174 } 
	gPACKED
;

	@hw/usb-hid.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"ouçut.h
"

10 
	~"ps2p‹t.h
"

11 
	~"usb.h
"

12 
	~"usb-hid.h
"

13 
	~"utû.h
"

15 
usb_pùe
 *
keybﬂrd_pùe
 
	gVARFSEG
;

16 
usb_pùe
 *
mou£_pùe
 
	gVARFSEG
;

25 
	$£t_¥Ÿocﬁ
(
usb_pùe
 *
pùe
, 
u16
 
vÆ
)

27 
usb_˘æªque°
 
ªq
;

28 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
;

29 
ªq
.
bReque°
 = 
HID_REQ_SET_PROTOCOL
;

30 
ªq
.
wVÆue
 = 
vÆ
;

31 
ªq
.
wIndex
 = 0;

32 
ªq
.
wLígth
 = 0;

33  
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
NULL
);

34 
	}
}

38 
	$£t_idÀ
(
usb_pùe
 *
pùe
, 
ms
)

40 
usb_˘æªque°
 
ªq
;

41 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
;

42 
ªq
.
bReque°
 = 
HID_REQ_SET_IDLE
;

43 
ªq
.
wVÆue
 = (
ms
/4)<<8;

44 
ªq
.
wIndex
 = 0;

45 
ªq
.
wLígth
 = 0;

46  
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
NULL
);

47 
	}
}

49 
	#KEYREPEATWAITMS
 500

	)

50 
	#KEYREPEATMS
 33

	)

53 
	$usb_kbd_£tup
(
usbdevi˚_s
 *
usbdev


54 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

56 i‡(! 
CONFIG_USB_KEYBOARD
)

58 i‡(
keybﬂrd_pùe
)

62 i‡(
ïdesc
->
wMaxPackëSize
 != 8)

66 
ªt
 = 
	`£t_¥Ÿocﬁ
(
usbdev
->
deÂùe
, 0);

67 i‡(
ªt
)

70 
ªt
 = 
	`£t_idÀ
(
usbdev
->
deÂùe
, 
KEYREPEATMS
);

71 i‡(
ªt
)

74 
keybﬂrd_pùe
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ïdesc
);

75 i‡(!
keybﬂrd_pùe
)

78 
	`d¥ötf
(1, "USB keyboard initialized\n");

80 
	}
}

83 
	$usb_mou£_£tup
(
usbdevi˚_s
 *
usbdev


84 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

86 i‡(! 
CONFIG_USB_MOUSE
)

88 i‡(
mou£_pùe
)

92 i‡(
ïdesc
->
wMaxPackëSize
 < 3 ||Épdesc->wMaxPacketSize > 8)

96 
ªt
 = 
	`£t_¥Ÿocﬁ
(
usbdev
->
deÂùe
, 0);

97 i‡(
ªt
)

100 
mou£_pùe
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ïdesc
);

101 i‡(!
mou£_pùe
)

104 
	`d¥ötf
(1, "USB mouse initialized\n");

106 
	}
}

110 
	$usb_hid_£tup
(
usbdevi˚_s
 *
usbdev
)

112 i‡(! (
CONFIG_USB_KEYBOARD
 || 
CONFIG_USB_MOUSE
))

114 
	`d¥ötf
(2, "usb_hid_£tu∞%p\n", 
usbdev
->
deÂùe
);

116 
usb_öãrÁ˚_des¸ùt‹
 *
iÁ˚
 = 
usbdev
->iface;

117 i‡(
iÁ˚
->
bI¡îÁ˚SubCœss
 !
USB_INTERFACE_SUBCLASS_BOOT
)

122 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
 = 
	`födEndPoötDesc
(

123 
usbdev
, 
USB_ENDPOINT_XFER_INT
, 
USB_DIR_IN
);

124 i‡(!
ïdesc
) {

125 
	`d¥ötf
(1, "No usb hid intr in?\n");

129 i‡(
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 =
USB_INTERFACE_PROTOCOL_KEYBOARD
)

130  
	`usb_kbd_£tup
(
usbdev
, 
ïdesc
);

131 i‡(
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 =
USB_INTERFACE_PROTOCOL_MOUSE
)

132  
	`usb_mou£_£tup
(
usbdev
, 
ïdesc
);

134 
	}
}

142 
u16
 
	gKeyToSˇnCode
[] 
	gVAR16
 = {

159 
u16
 
	gModifõrToSˇnCode
[] 
	gVAR16
 = {

164 
	#RELEASEBIT
 0x80

	)

167 
	skeyevít
 {

168 
u8
 
	mmodifõrs
;

169 
u8
 
	mª£rved
;

170 
u8
 
	mkeys
[6];

175 
	$¥ockeys
(
u16
 
keys
)

177 i‡(
keys
 > 0xff) {

178 
u8
 
key
 = 
keys
>>8;

179 i‡(
key
 == 0xe1) {

181 
	`¥o˚ss_key
(0xe1);

182 
	`¥o˚ss_key
(0x1d | (
keys
 & 
RELEASEBIT
));

183 
	`¥o˚ss_key
(0x45 | (
keys
 & 
RELEASEBIT
));

186 
	`¥o˚ss_key
(
key
);

188 
	`¥o˚ss_key
(
keys
);

189 
	}
}

193 
	$¥ocsˇnkey
(
u8
 
key
, u8 
Êags
)

195 i‡(
key
 >
	`ARRAY_SIZE
(
KeyToSˇnCode
))

197 
u16
 
keys
 = 
	`GET_GLOBAL
(
KeyToSˇnCode
[
key
]);

198 i‡(
keys
)

199 
	`¥ockeys
(
keys
 | 
Êags
);

200 
	}
}

204 
	$¥ocmodkey
(
u8
 
mods
, u8 
Êags
)

206 
i
;

207 
i
=0; 
mods
; i++)

208 i‡(
mods
 & (1<<
i
)) {

210 
	`¥ockeys
(
	`GET_GLOBAL
(
ModifõrToSˇnCode
[
i
]Ë| 
Êags
);

211 
mods
 &~(1<<
i
);

213 
	}
}

215 
	susbkeyöfo
 {

218 
u8
 
	mmodifõrs
;

219 
u8
 
	mª≥©cou¡
;

220 
u8
 
	mkeys
[6];

222 
u64
 
	md©a
;

225 
usbkeyöfo
 
La°USBkey
 
	gVARLOW
;

229 
	$h™dÀ_key
(
keyevít
 *
d©a
)

231 
	`d¥ötf
(9, "GŸ key %x %x\n", 
d©a
->
modifõrs
, d©a->
keys
[0]);

234 
usbkeyöfo
 
ﬁd
;

235 
ﬁd
.
d©a
 = 
	`GET_LOW
(
La°USBkey
.data);

238 
addpos
 = 0;

239 
i
;

240 
i
=0; i<
	`ARRAY_SIZE
(
ﬁd
.
keys
); i++) {

241 
u8
 
key
 = 
ﬁd
.
keys
[
i
];

242 i‡(!
key
)

244 
j
;

245 
j
=0;; j++) {

246 i‡(
j
>=
	`ARRAY_SIZE
(
d©a
->
keys
)) {

248 
	`¥ocsˇnkey
(
key
, 
RELEASEBIT
);

249 i‡(
i
+1 >
	`ARRAY_SIZE
(
ﬁd
.
keys
) || !old.keys[i+1])

251 
ﬁd
.
ª≥©cou¡
 = 0xff;

254 i‡(
d©a
->
keys
[
j
] =
key
) {

256 
d©a
->
keys
[
j
] = 0;

257 
ﬁd
.
keys
[
addpos
++] = 
key
;

262 
	`¥ocmodkey
(
ﬁd
.
modifõrs
 & ~
d©a
->modifõrs, 
RELEASEBIT
);

265 
	`¥ocmodkey
(
d©a
->
modifõrs
 & ~
ﬁd
.modifiers, 0);

266 
ﬁd
.
modifõrs
 = 
d©a
->modifiers;

267 
i
=0; i<
	`ARRAY_SIZE
(
d©a
->
keys
); i++) {

268 
u8
 
key
 = 
d©a
->
keys
[
i
];

269 i‡(!
key
)

272 
	`¥ocsˇnkey
(
key
, 0);

273 
ﬁd
.
keys
[
addpos
++] = 
key
;

274 
ﬁd
.
ª≥©cou¡
 = 
KEYREPEATWAITMS
 / 
KEYREPEATMS
 + 1;

276 i‡(
addpos
 < 
	`ARRAY_SIZE
(
ﬁd
.
keys
))

277 
ﬁd
.
keys
[
addpos
] = 0;

280 i‡(
addpos
) {

281 i‡(!
ﬁd
.
ª≥©cou¡
)

282 
	`¥ocsˇnkey
(
ﬁd
.
keys
[
addpos
-1], 0);

283 i‡(
ﬁd
.
ª≥©cou¡
 != 0xff)

284 
ﬁd
.
ª≥©cou¡
--;

288 
	`SET_LOW
(
La°USBkey
.
d©a
, 
ﬁd
.data);

289 
	}
}

293 
	$usb_check_key
()

295 i‡(! 
CONFIG_USB_KEYBOARD
)

297 
usb_pùe
 *
pùe
 = 
	`GET_GLOBAL
(
keybﬂrd_pùe
);

298 i‡(!
pùe
)

302 
keyevít
 
d©a
;

303 
ªt
 = 
	`usb_pﬁl_öå
(
pùe
, &
d©a
);

304 i‡(
ªt
)

306 
	`h™dÀ_key
(&
d©a
);

308 
	}
}

311 
ölöe
 

312 
	$usb_kbd_a˘ive
()

314 i‡(! 
CONFIG_USB_KEYBOARD
)

316  
	`GET_GLOBAL
(
keybﬂrd_pùe
Ë!
NULL
;

317 
	}
}

320 
ölöe
 

321 
	$usb_kbd_comm™d
(
comm™d
, 
u8
 *
∑øm
)

323 i‡(! 
CONFIG_USB_KEYBOARD
)

325 
	`d¥ötf
(9, "usb keybﬂrd cmd=%x\n", 
comm™d
);

326 
comm™d
) {

327 
ATKBD_CMD_GETID
:

329 
∑øm
[0] = 0xab;

330 
∑øm
[1] = 0x83;

335 
	}
}

343 
	smou£evít
 {

344 
u8
 
	mbuâ⁄s
;

345 
u8
 
	mx
, 
	my
;

346 
u8
 
	mª£rved
[5];

351 
	$h™dÀ_mou£
(
mou£evít
 *
d©a
)

353 
	`d¥ötf
(9, "GŸ mou£ b=%x x=%x y=%x\n", 
d©a
->
buâ⁄s
, d©a->
x
, d©a->
y
);

355 
s8
 
x
 = 
d©a
->x, 
y
 = -data->y;

356 
u8
 
Êag
 = ((
d©a
->
buâ⁄s
 & 0x7) | (1<<3)

357 | (
x
 & 0x80 ? (1<<4Ë: 0Ë| (
y
 & 0x80 ? (1<<5) : 0));

358 
	`¥o˚ss_mou£
(
Êag
);

359 
	`¥o˚ss_mou£
(
x
);

360 
	`¥o˚ss_mou£
(
y
);

361 
	}
}

365 
	$usb_check_mou£
()

367 i‡(! 
CONFIG_USB_MOUSE
)

369 
usb_pùe
 *
pùe
 = 
	`GET_GLOBAL
(
mou£_pùe
);

370 i‡(!
pùe
)

374 
mou£evít
 
d©a
;

375 
ªt
 = 
	`usb_pﬁl_öå
(
pùe
, &
d©a
);

376 i‡(
ªt
)

378 
	`h™dÀ_mou£
(&
d©a
);

380 
	}
}

383 
ölöe
 

384 
	$usb_mou£_a˘ive
()

386 i‡(! 
CONFIG_USB_MOUSE
)

388  
	`GET_GLOBAL
(
mou£_pùe
Ë!
NULL
;

389 
	}
}

392 
ölöe
 

393 
	$usb_mou£_comm™d
(
comm™d
, 
u8
 *
∑øm
)

395 i‡(! 
CONFIG_USB_MOUSE
)

397 
	`d¥ötf
(9, "usb mou£ cmd=%x\n", 
comm™d
);

398 
comm™d
) {

399 
PSMOUSE_CMD_ENABLE
:

400 
PSMOUSE_CMD_DISABLE
:

401 
PSMOUSE_CMD_SETSCALE11
:

403 
PSMOUSE_CMD_SETSCALE21
:

404 
PSMOUSE_CMD_SETRATE
:

405 
PSMOUSE_CMD_SETRES
:

408 
PSMOUSE_CMD_RESET_BAT
:

409 
PSMOUSE_CMD_GETID
:

411 
∑øm
[0] = 0xaa;

412 
∑øm
[1] = 0x00;

415 
PSMOUSE_CMD_GETINFO
:

416 
∑øm
[0] = 0x00;

417 
∑øm
[1] = 4;

418 
∑øm
[2] = 100;

424 
	}
}

428 
	$usb_check_evít
()

430 
	`usb_check_key
();

431 
	`usb_check_mou£
();

432 
	}
}

	@hw/usb-hid.h

1 #i‚de‡
__USB_HID_H


2 
	#__USB_HID_H


	)

5 
	gusbdevi˚_s
;

6 
usb_hid_£tup
(
usbdevi˚_s
 *
usbdev
);

7 
ölöe
 
usb_kbd_a˘ive
();

8 
ölöe
 
usb_kbd_comm™d
(
comm™d
, 
u8
 *
∑øm
);

9 
ölöe
 
usb_mou£_a˘ive
();

10 
ölöe
 
usb_mou£_comm™d
(
comm™d
, 
u8
 *
∑øm
);

11 
usb_check_evít
();

18 
	#USB_INTERFACE_SUBCLASS_BOOT
 1

	)

19 
	#USB_INTERFACE_PROTOCOL_KEYBOARD
 1

	)

20 
	#USB_INTERFACE_PROTOCOL_MOUSE
 2

	)

22 
	#HID_REQ_GET_REPORT
 0x01

	)

23 
	#HID_REQ_GET_IDLE
 0x02

	)

24 
	#HID_REQ_GET_PROTOCOL
 0x03

	)

25 
	#HID_REQ_SET_REPORT
 0x09

	)

26 
	#HID_REQ_SET_IDLE
 0x0A

	)

27 
	#HID_REQ_SET_PROTOCOL
 0x0B

	)

	@hw/usb-hub.c

7 
	~"c⁄fig.h
"

8 
	~"ouçut.h
"

9 
	~"°rög.h
"

10 
	~"usb.h
"

11 
	~"usb-hub.h
"

12 
	~"utû.h
"

15 
	$gë_hub_desc
(
usb_pùe
 *
pùe
, 
usb_hub_des¸ùt‹
 *
desc
)

17 
usb_˘æªque°
 
ªq
;

18 
ªq
.
bReque°Ty≥
 = 
USB_DIR_IN
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_DEVICE
;

19 
ªq
.
bReque°
 = 
USB_REQ_GET_DESCRIPTOR
;

20 
ªq
.
wVÆue
 = 
USB_DT_HUB
<<8;

21 
ªq
.
wIndex
 = 0;

22 
ªq
.
wLígth
 = (*
desc
);

23  
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
desc
);

24 
	}
}

27 
	$£t_p‹t_„©uª
(
usbhub_s
 *
hub
, 
p‹t
, 
„©uª
)

29 
usb_˘æªque°
 
ªq
;

30 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_OTHER
;

31 
ªq
.
bReque°
 = 
USB_REQ_SET_FEATURE
;

32 
ªq
.
wVÆue
 = 
„©uª
;

33 
ªq
.
wIndex
 = 
p‹t
 + 1;

34 
ªq
.
wLígth
 = 0;

35 
	`muãx_lock
(&
hub
->
lock
);

36 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
hub
->
usbdev
->
deÂùe
, &
ªq
, 
NULL
);

37 
	`muãx_u∆ock
(&
hub
->
lock
);

38  
ªt
;

39 
	}
}

42 
	$˛ór_p‹t_„©uª
(
usbhub_s
 *
hub
, 
p‹t
, 
„©uª
)

44 
usb_˘æªque°
 
ªq
;

45 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_OTHER
;

46 
ªq
.
bReque°
 = 
USB_REQ_CLEAR_FEATURE
;

47 
ªq
.
wVÆue
 = 
„©uª
;

48 
ªq
.
wIndex
 = 
p‹t
 + 1;

49 
ªq
.
wLígth
 = 0;

50 
	`muãx_lock
(&
hub
->
lock
);

51 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
hub
->
usbdev
->
deÂùe
, &
ªq
, 
NULL
);

52 
	`muãx_u∆ock
(&
hub
->
lock
);

53  
ªt
;

54 
	}
}

57 
	$gë_p‹t_°©us
(
usbhub_s
 *
hub
, 
p‹t
, 
usb_p‹t_°©us
 *
°s
)

59 
usb_˘æªque°
 
ªq
;

60 
ªq
.
bReque°Ty≥
 = 
USB_DIR_IN
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_OTHER
;

61 
ªq
.
bReque°
 = 
USB_REQ_GET_STATUS
;

62 
ªq
.
wVÆue
 = 0;

63 
ªq
.
wIndex
 = 
p‹t
 + 1;

64 
ªq
.
wLígth
 = (*
°s
);

65 
	`muãx_lock
(&
hub
->
lock
);

66 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
hub
->
usbdev
->
deÂùe
, &
ªq
, 
°s
);

67 
	`muãx_u∆ock
(&
hub
->
lock
);

68  
ªt
;

69 
	}
}

73 
	$usb_hub_dëe˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

76 
ªt
 = 
	`£t_p‹t_„©uª
(
hub
, 
p‹t
, 
USB_PORT_FEAT_POWER
);

77 i‡(
ªt
)

78 
Áû
;

81 
	`m¶ìp
(
hub
->
powîwaô
);

84 
usb_p‹t_°©us
 
°s
;

85 
u32
 
íd
 = 
	`timî_ˇlc
(
USB_TIME_SIGATT
);

87 
ªt
 = 
	`gë_p‹t_°©us
(
hub
, 
p‹t
, &
°s
);

88 i‡(
ªt
)

89 
Áû
;

90 i‡(
°s
.
wP‹tSètus
 & 
USB_PORT_STAT_CONNECTION
)

93 i‡(
	`timî_check
(
íd
))

96 
	`m¶ìp
(5);

103 
Áû
:

104 
	`d¥ötf
(1, "Faûuª o¿hubÖ‹à%d dëe˘\n", 
p‹t
);

106 
	}
}

110 
	$usb_hub_disc⁄√˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

112 
ªt
 = 
	`˛ór_p‹t_„©uª
(
hub
, 
p‹t
, 
USB_PORT_FEAT_ENABLE
);

113 i‡(
ªt
)

114 
	`d¥ötf
(1, "Faûuª o¿hubÖ‹à%d disc⁄√˘\n", 
p‹t
);

115 
	}
}

119 
	$usb_hub_ª£t
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

121 
ªt
 = 
	`£t_p‹t_„©uª
(
hub
, 
p‹t
, 
USB_PORT_FEAT_RESET
);

122 i‡(
ªt
)

123 
Áû
;

126 
usb_p‹t_°©us
 
°s
;

127 
u32
 
íd
 = 
	`timî_ˇlc
(
USB_TIME_DRST
 * 2);

129 
ªt
 = 
	`gë_p‹t_°©us
(
hub
, 
p‹t
, &
°s
);

130 i‡(
ªt
)

131 
Áû
;

132 i‡(!(
°s
.
wP‹tSètus
 & 
USB_PORT_STAT_RESET
))

134 i‡(
	`timî_check
(
íd
)) {

135 
	`w¨n_timeout
();

136 
Áû
;

138 
	`m¶ìp
(5);

142 i‡(!(
°s
.
wP‹tSètus
 & 
USB_PORT_STAT_CONNECTION
))

146  ((
°s
.
wP‹tSètus
 & 
USB_PORT_STAT_SPEED_MASK
)

147 >> 
USB_PORT_STAT_SPEED_SHIFT
);

149 
Áû
:

150 
	`d¥ötf
(1, "Faûuª o¿hubÖ‹à%dÑe£t\n", 
p‹t
);

151 
	`usb_hub_disc⁄√˘
(
hub
, 
p‹t
);

153 
	}
}

155 
usbhub_›_s
 
	gHubOp
 = {

156 .
dëe˘
 = 
usb_hub_dëe˘
,

157 .
	gª£t
 = 
usb_hub_ª£t
,

158 .
	gdisc⁄√˘
 = 
usb_hub_disc⁄√˘
,

163 
	$usb_hub_£tup
(
usbdevi˚_s
 *
usbdev
)

165 
	`ASSERT32FLAT
();

166 i‡(!
CONFIG_USB_HUB
)

169 
usb_hub_des¸ùt‹
 
desc
;

170 
ªt
 = 
	`gë_hub_desc
(
usbdev
->
deÂùe
, &
desc
);

171 i‡(
ªt
)

172  
ªt
;

174 
usbhub_s
 
hub
;

175 
	`mem£t
(&
hub
, 0, (hub));

176 
hub
.
usbdev
 = usbdev;

177 
hub
.
˙é
 = 
usbdev
->
deÂùe
->cntl;

178 
hub
.
powîwaô
 = 
desc
.
bPwrOn2PwrGood
 * 2;

179 
hub
.
p‹tcou¡
 = 
desc
.
bNbrP‹ts
;

180 
hub
.
›
 = &
HubOp
;

181 
	`usb_íumî©e
(&
hub
);

183 
	`d¥ötf
(1, "Inôülized USB HUB (%dÖ‹t†u£d)\n", 
hub
.
devcou¡
);

184 i‡(
hub
.
devcou¡
)

187 
	}
}

	@hw/usb-hub.h

1 #i‚de‡
__USB_HUB_H


2 
	#__USB_HUB_H


	)

5 
	gusbdevi˚_s
;

6 
usb_hub_£tup
(
usbdevi˚_s
 *
usbdev
);

13 
	#USB_DT_HUB
 (
USB_TYPE_CLASS
 | 0x09)

	)

15 
	susb_hub_des¸ùt‹
 {

16 
u8
 
	mbDescLígth
;

17 
u8
 
	mbDes¸ùt‹Ty≥
;

18 
u8
 
	mbNbrP‹ts
;

19 
u16
 
	mwHubCh¨a˘îi°ics
;

20 
u8
 
	mbPwrOn2PwrGood
;

21 
u8
 
	mbHubC⁄åCuºít
;

23 } 
	gPACKED
;

25 
	#USB_PORT_FEAT_CONNECTION
 0

	)

26 
	#USB_PORT_FEAT_ENABLE
 1

	)

27 
	#USB_PORT_FEAT_SUSPEND
 2

	)

28 
	#USB_PORT_FEAT_OVER_CURRENT
 3

	)

29 
	#USB_PORT_FEAT_RESET
 4

	)

30 
	#USB_PORT_FEAT_POWER
 8

	)

31 
	#USB_PORT_FEAT_LOWSPEED
 9

	)

32 
	#USB_PORT_FEAT_C_CONNECTION
 16

	)

33 
	#USB_PORT_FEAT_C_ENABLE
 17

	)

34 
	#USB_PORT_FEAT_C_SUSPEND
 18

	)

35 
	#USB_PORT_FEAT_C_OVER_CURRENT
 19

	)

36 
	#USB_PORT_FEAT_C_RESET
 20

	)

37 
	#USB_PORT_FEAT_TEST
 21

	)

38 
	#USB_PORT_FEAT_INDICATOR
 22

	)

39 
	#USB_PORT_FEAT_C_PORT_L1
 23

	)

41 
	susb_p‹t_°©us
 {

42 
u16
 
	mwP‹tSètus
;

43 
u16
 
	mwP‹tCh™ge
;

44 } 
	gPACKED
;

46 
	#USB_PORT_STAT_CONNECTION
 0x0001

	)

47 
	#USB_PORT_STAT_ENABLE
 0x0002

	)

48 
	#USB_PORT_STAT_SUSPEND
 0x0004

	)

49 
	#USB_PORT_STAT_OVERCURRENT
 0x0008

	)

50 
	#USB_PORT_STAT_RESET
 0x0010

	)

51 
	#USB_PORT_STAT_L1
 0x0020

	)

52 
	#USB_PORT_STAT_POWER
 0x0100

	)

53 
	#USB_PORT_STAT_SPEED_SHIFT
 9

	)

54 
	#USB_PORT_STAT_SPEED_MASK
 (0x3 << 
USB_PORT_STAT_SPEED_SHIFT
)

	)

55 
	#USB_PORT_STAT_LOW_SPEED
 0x0200

	)

56 
	#USB_PORT_STAT_HIGH_SPEED
 0x0400

	)

57 
	#USB_PORT_STAT_TEST
 0x0800

	)

58 
	#USB_PORT_STAT_INDICATOR
 0x1000

	)

	@hw/usb-msc.c

7 
	~"biosv¨.h
"

8 
	~"block.h
"

9 
	~"blockcmd.h
"

10 
	~"c⁄fig.h
"

11 
	~"mÆloc.h
"

12 
	~"ouçut.h
"

13 
	~"°d/disk.h
"

14 
	~"°rög.h
"

15 
	~"usb.h
"

16 
	~"usb-msc.h
"

17 
	~"utû.h
"

19 
	susbdrive_s
 {

20 
drive_s
 
	mdrive
;

21 
usb_pùe
 *
	mbulkö
, *
	mbulkout
;

22 
	mlun
;

30 
	#USB_CDB_SIZE
 12

	)

32 
	#CBW_SIGNATURE
 0x43425355

33 

	)

34 
	scbw_s
 {

35 
u32
 
	mdCBWSig«tuª
;

36 
u32
 
	mdCBWTag
;

37 
u32
 
	mdCBWD©aTøns„rLígth
;

38 
u8
 
	mbmCBWFœgs
;

39 
u8
 
	mbCBWLUN
;

40 
u8
 
	mbCBWCBLígth
;

41 
u8
 
	mCBWCB
[16];

42 } 
	gPACKED
;

44 
	#CSW_SIGNATURE
 0x53425355

45 

	)

46 
	scsw_s
 {

47 
u32
 
	mdCSWSig«tuª
;

48 
u32
 
	mdCSWTag
;

49 
u32
 
	mdCSWD©aResidue
;

50 
u8
 
	mbCSWSètus
;

51 } 
	gPACKED
;

54 
	$usb_msc_£nd
(
usbdrive_s
 *
udrive_gf
, 
dú
, *
buf
, 
u32
 
byãs
)

56 
usb_pùe
 *
pùe
;

57 i‡(
dú
 =
USB_DIR_OUT
)

58 
pùe
 = 
	`GET_GLOBALFLAT
(
udrive_gf
->
bulkout
);

60 
pùe
 = 
	`GET_GLOBALFLAT
(
udrive_gf
->
bulkö
);

61  
	`usb_£nd_bulk
(
pùe
, 
dú
, 
buf
, 
byãs
);

62 
	}
}

66 
	$usb_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

68 i‡(!
CONFIG_USB_MSC
)

71 
	`d¥ötf
(16, "usb_cmd_data id=%p write=%d count=%d bs=%d buf=%p\n"

72 , 
›
->
drive_gf
, 0, op->
cou¡
, 
blocksize
, op->
buf_Ê
);

73 
usbdrive_s
 *
udrive_gf
 = 
	`c⁄èöî_of
(

74 
›
->
drive_gf
, 
usbdrive_s
, 
drive
);

77 
u32
 
byãs
 = 
blocksize
 * 
›
->
cou¡
;

78 
cbw_s
 
cbw
;

79 
	`mem£t
(&
cbw
, 0, (cbw));

80 
	`mem˝y
(
cbw
.
CBWCB
, 
cdbcmd
, 
USB_CDB_SIZE
);

81 
cbw
.
dCBWSig«tuª
 = 
CBW_SIGNATURE
;

82 
cbw
.
dCBWTag
 = 999;

83 
cbw
.
dCBWD©aTøns„rLígth
 = 
byãs
;

84 
cbw
.
bmCBWFœgs
 = 
	`cdb_is_ªad
(
cdbcmd
, 
blocksize
Ë? 
USB_DIR_IN
 : 
USB_DIR_OUT
;

85 
cbw
.
bCBWLUN
 = 
	`GET_GLOBALFLAT
(
udrive_gf
->
lun
);

86 
cbw
.
bCBWCBLígth
 = 
USB_CDB_SIZE
;

89 
ªt
 = 
	`usb_msc_£nd
(
udrive_gf
, 
USB_DIR_OUT


90 , 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
cbw
), (cbw));

91 i‡(
ªt
)

92 
Áû
;

95 i‡(
byãs
) {

96 
ªt
 = 
	`usb_msc_£nd
(
udrive_gf
, 
cbw
.
bmCBWFœgs
, 
›
->
buf_Ê
, 
byãs
);

97 i‡(
ªt
)

98 
Áû
;

102 
csw_s
 
csw
;

103 
ªt
 = 
	`usb_msc_£nd
(
udrive_gf
, 
USB_DIR_IN


104 , 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
csw
), (csw));

105 i‡(
ªt
)

106 
Áû
;

108 i‡(!
csw
.
bCSWSètus
)

109  
DISK_RET_SUCCESS
;

110 i‡(
csw
.
bCSWSètus
 == 2)

111 
Áû
;

113 i‡(
blocksize
)

114 
›
->
cou¡
 -
csw
.
dCSWD©aResidue
 / 
blocksize
;

115  
DISK_RET_EBADTRACK
;

117 
Áû
:

119 
	`d¥ötf
(1, "USBÅransmission failed\n");

120  
DISK_RET_EBADTRACK
;

121 
	}
}

124 
	$usb_msc_maxlun
(
usb_pùe
 *
pùe
)

126 
usb_˘æªque°
 
ªq
;

127 
ªq
.
bReque°Ty≥
 = 
USB_DIR_IN
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
;

128 
ªq
.
bReque°
 = 0xfe;

129 
ªq
.
wVÆue
 = 0;

130 
ªq
.
wIndex
 = 0;

131 
ªq
.
wLígth
 = 1;

132 
maxlun
;

133 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, &
maxlun
);

134 i‡(
ªt
)

136  
maxlun
;

137 
	}
}

140 
	$usb_msc_lun_£tup
(
usb_pùe
 *
öpùe
, usb_pùê*
ouçùe
,

141 
usbdevi˚_s
 *
usbdev
, 
lun
)

144 
usbdrive_s
 *
drive
 = 
	`mÆloc_f£g
((*drive));

145 i‡(!
drive
) {

146 
	`w¨n_nﬂŒoc
();

149 
	`mem£t
(
drive
, 0, (*drive));

150 i‡(
	`usb_32bô_pùe
(
öpùe
))

151 
drive
->drive.
ty≥
 = 
DTYPE_USB_32
;

153 
drive
->drive.
ty≥
 = 
DTYPE_USB
;

154 
drive
->
bulkö
 = 
öpùe
;

155 
drive
->
bulkout
 = 
ouçùe
;

156 
drive
->
lun
 =Üun;

158 
¥io
 = 
	`boŸ¥io_föd_usb
(
usbdev
, 
lun
);

159 
ªt
 = 
	`scsi_drive_£tup
(&
drive
->drive, "USB MSC", 
¥io
);

160 i‡(
ªt
) {

161 
	`d¥ötf
(1, "UnableÅo configure USB MSC drive.\n");

162 
	`‰ì
(
drive
);

166 
	}
}

174 
	$usb_msc_£tup
(
usbdevi˚_s
 *
usbdev
)

176 i‡(!
CONFIG_USB_MSC
)

180 
usb_öãrÁ˚_des¸ùt‹
 *
iÁ˚
 = 
usbdev
->iface;

181 i‡((
iÁ˚
->
bI¡îÁ˚SubCœss
 !
US_SC_SCSI
 &&

182 
iÁ˚
->
bI¡îÁ˚SubCœss
 !
US_SC_ATAPI_8070
 &&

183 
iÁ˚
->
bI¡îÁ˚SubCœss
 !
US_SC_ATAPI_8020
)

184 || 
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 !
US_PR_BULK
) {

185 
	`d¥ötf
(1, "Unsupported MSC USB device (subclass=%02xÖroto=%02x)\n"

186 , 
iÁ˚
->
bI¡îÁ˚SubCœss
, iÁ˚->
bI¡îÁ˚PrŸocﬁ
);

191 
usb_pùe
 *
öpùe
 = 
NULL
, *
ouçùe
 = NULL;

192 
usb_ídpoöt_des¸ùt‹
 *
ödesc
 = 
	`födEndPoötDesc
(

193 
usbdev
, 
USB_ENDPOINT_XFER_BULK
, 
USB_DIR_IN
);

194 
usb_ídpoöt_des¸ùt‹
 *
outdesc
 = 
	`födEndPoötDesc
(

195 
usbdev
, 
USB_ENDPOINT_XFER_BULK
, 
USB_DIR_OUT
);

196 i‡(!
ödesc
 || !
outdesc
)

197 
Áû
;

198 
öpùe
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ödesc
);

199 
ouçùe
 = 
	`usb_Æloc_pùe
(
usbdev
, 
outdesc
);

200 i‡(!
öpùe
 || !
ouçùe
)

201 
Áû
;

203 
maxlun
 = 
	`usb_msc_maxlun
(
usbdev
->
deÂùe
);

204 
lun
, 
pùesu£d
 = 0;

205 
lun
 = 0;Üu¿< 
maxlun
 + 1;Üun++) {

206 
ªt
 = 
	`usb_msc_lun_£tup
(
öpùe
, 
ouçùe
, 
usbdev
, 
lun
);

207 i‡(!
ªt
)

208 
pùesu£d
 = 1;

211 i‡(!
pùesu£d
)

212 
Áû
;

215 
Áû
:

216 
	`d¥ötf
(1, "UnableÅo configure USB MSC device.\n");

217 
	`‰ì_pùe
(
öpùe
);

218 
	`‰ì_pùe
(
ouçùe
);

220 
	}
}

	@hw/usb-msc.h

1 #i‚de‡
__USB_MSC_H


2 
	#__USB_MSC_H


	)

5 
	gdisk_›_s
;

6 
usb_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

7 
	gusbdevi˚_s
;

8 
usb_msc_£tup
(
usbdevi˚_s
 *
usbdev
);

	@hw/usb-ohci.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"mÆloc.h
"

10 
	~"ouçut.h
"

11 
	~"pci.h
"

12 
	~"pci_ids.h
"

13 
	~"pci_ªgs.h
"

14 
	~"°rög.h
"

15 
	~"usb.h
"

16 
	~"usb-ohci.h
"

17 
	~"utû.h
"

18 
	~"x86.h
"

20 
	#FIT
 (1 << 31)

	)

22 
	susb_ohci_s
 {

23 
usb_s
 
	musb
;

24 
ohci_ªgs
 *
	mªgs
;

27 
	sohci_pùe
 {

28 
ohci_ed
 
	med
;

29 
usb_pùe
 
	mpùe
;

30 *
	md©a
;

31 
	mcou¡
;

32 
ohci_td
 *
	mtds
;

42 
	$ohci_hub_dëe˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

44 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ohci_s, 
usb
);

45 
u32
 
°s
 = 
	`ªadl
(&
˙é
->
ªgs
->
roŸhub_p‹t°©us
[
p‹t
]);

46 i‡(!(
°s
 & 
RH_PS_CCS
))

53 
	}
}

57 
	$ohci_hub_disc⁄√˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

59 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ohci_s, 
usb
);

60 
	`wrôñ
(&
˙é
->
ªgs
->
roŸhub_p‹t°©us
[
p‹t
], 
RH_PS_CCS
|
RH_PS_LSDA
);

61 
	}
}

65 
	$ohci_hub_ª£t
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

67 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_ohci_s, 
usb
);

68 
	`wrôñ
(&
˙é
->
ªgs
->
roŸhub_p‹t°©us
[
p‹t
], 
RH_PS_PRS
);

69 
u32
 
°s
;

70 
u32
 
íd
 = 
	`timî_ˇlc
(
USB_TIME_DRSTR
 * 2);

72 
°s
 = 
	`ªadl
(&
˙é
->
ªgs
->
roŸhub_p‹t°©us
[
p‹t
]);

73 i‡(!(
°s
 & 
RH_PS_PRS
))

76 i‡(
	`timî_check
(
íd
)) {

78 
	`w¨n_timeout
();

79 
	`ohci_hub_disc⁄√˘
(
hub
, 
p‹t
);

82 
	`yõld
();

85 i‡((
°s
 & (
RH_PS_CCS
|
RH_PS_PES
)) != (RH_PS_CCS|RH_PS_PES))

89  !!(
°s
 & 
RH_PS_LSDA
);

90 
	}
}

92 
usbhub_›_s
 
	gohci_HubOp
 = {

93 .
dëe˘
 = 
ohci_hub_dëe˘
,

94 .
	gª£t
 = 
ohci_hub_ª£t
,

95 .
	gdisc⁄√˘
 = 
ohci_hub_disc⁄√˘
,

100 
	$check_ohci_p‹ts
(
usb_ohci_s
 *
˙é
)

102 
	`ASSERT32FLAT
();

104 
u32
 
rha
 = 
	`ªadl
(&
˙é
->
ªgs
->
roŸhub_a
);

105 
rha
 &~(
RH_A_PSM
 | 
RH_A_OCPM
);

106 
	`wrôñ
(&
˙é
->
ªgs
->
roŸhub_°©us
, 
RH_HS_LPSC
);

107 
	`wrôñ
(&
˙é
->
ªgs
->
roŸhub_b
, 
RH_B_PPCM
);

108 
	`m¶ìp
((
rha
 >> 24) * 2);

111 
usbhub_s
 
hub
;

112 
	`mem£t
(&
hub
, 0, (hub));

113 
hub
.
˙é
 = &˙é->
usb
;

114 
hub
.
p‹tcou¡
 = 
rha
 & 
RH_A_NDP
;

115 
hub
.
›
 = &
ohci_HubOp
;

116 
	`usb_íumî©e
(&
hub
);

117  
hub
.
devcou¡
;

118 
	}
}

127 
	$ohci_waôtick
(
usb_ohci_s
 *
˙é
)

129 
	`b¨rõr
();

130 
ohci_hcˇ
 *
hcˇ
 = (*)
˙é
->
ªgs
->hcca;

131 
u32
 
°¨t‰ame
 = 
hcˇ
->
‰ame_no
;

132 
u32
 
íd
 = 
	`timî_ˇlc
(1000 * 5);

134 i‡(
hcˇ
->
‰ame_no
 !
°¨t‰ame
)

136 i‡(
	`timî_check
(
íd
)) {

137 
	`w¨n_timeout
();

140 
	`yõld
();

142 
	}
}

145 
	$ohci_‰ì_pùes
(
usb_ohci_s
 *
˙é
)

147 
	`d¥ötf
(7, "ohci_‰ì_pùe†%p\n", 
˙é
);

149 
u32
 
¸eg
 = 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
);

150 i‡(
¸eg
 & (
OHCI_CTRL_CLE
|
OHCI_CTRL_BLE
)) {

151 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄åﬁ
, 
¸eg
 & ~(
OHCI_CTRL_CLE
|
OHCI_CTRL_BLE
));

152 
	`ohci_waôtick
(
˙é
);

155 
u32
 *
pos
 = &
˙é
->
ªgs
->
ed_c⁄åﬁhód
;

157 
ohci_ed
 *
√xt
 = (*)*
pos
;

158 i‡(!
√xt
)

160 
ohci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
√xt
, ohci_pùe, 
ed
);

161 i‡(
pùe
->pùe.
˙é
 !&˙é->
usb
) {

162 *
pos
 = 
√xt
->
hwNextED
;

163 
	`‰ì
(
pùe
);

165 
pos
 = &
√xt
->
hwNextED
;

169 
	`wrôñ
(&
˙é
->
ªgs
->
ed_c⁄åﬁcuºít
, 0);

170 
	`wrôñ
(&
˙é
->
ªgs
->
ed_bulkcuºít
, 0);

171 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄åﬁ
, 
¸eg
);

172 
˙é
->
usb
.
‰ìli°
 = 
NULL
;

173 
	}
}

176 
	$°¨t_ohci
(
usb_ohci_s
 *
˙é
, 
ohci_hcˇ
 *
hcˇ
)

178 
u32
 
ﬁdfmöãrvÆ
 = 
	`ªadl
(&
˙é
->
ªgs
->
fmöãrvÆ
);

179 
u32
 
ﬁdrwc
 = 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
Ë& 
OHCI_CTRL_RWC
;

184 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄åﬁ
, 
OHCI_USB_RESET
 | 
ﬁdrwc
);

185 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
);

186 
	`m¶ìp
(
USB_TIME_DRSTR
);

189 
u32
 
íd
 = 
	`timî_ˇlc_u£c
(10);

190 
	`wrôñ
(&
˙é
->
ªgs
->
cmd°©us
, 
OHCI_HCR
);

192 
u32
 
°©us
 = 
	`ªadl
(&
˙é
->
ªgs
->
cmd°©us
);

193 i‡(! 
°©us
 & 
OHCI_HCR
)

195 i‡(
	`timî_check
(
íd
)) {

196 
	`w¨n_timeout
();

202 
	`wrôñ
(&
˙é
->
ªgs
->
ed_c⁄åﬁhód
, 0);

203 
	`wrôñ
(&
˙é
->
ªgs
->
ed_bulkhód
, 0);

204 
	`wrôñ
(&
˙é
->
ªgs
->
hcˇ
, (
u32
)hcca);

207 
u32
 
fi
 = 
ﬁdfmöãrvÆ
 & 0x3fff;

208 
	`wrôñ
(&
˙é
->
ªgs
->
fmöãrvÆ


209 , (((
ﬁdfmöãrvÆ
 & 
FIT
) ^ FIT)

210 | 
fi
 | (((6 * (fi - 210)) / 7) << 16)));

211 
	`wrôñ
(&
˙é
->
ªgs
->
≥riodic°¨t
, ((9 * 
fi
) / 10) & 0x3fff);

212 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
);

217 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄åﬁ


218 , (
OHCI_CTRL_CBSR
 | 
OHCI_CTRL_CLE
 | 
OHCI_CTRL_PLE


219 | 
OHCI_USB_OPER
 | 
ﬁdrwc
));

220 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
);

223 
	}
}

226 
	$°›_ohci
(
usb_ohci_s
 *
˙é
)

228 
u32
 
ﬁdrwc
 = 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
Ë& 
OHCI_CTRL_RWC
;

229 
	`wrôñ
(&
˙é
->
ªgs
->
c⁄åﬁ
, 
ﬁdrwc
);

230 
	`ªadl
(&
˙é
->
ªgs
->
c⁄åﬁ
);

231 
	}
}

234 
	$c⁄figuª_ohci
(*
d©a
)

236 
usb_ohci_s
 *
˙é
 = 
d©a
;

239 
ohci_hcˇ
 *
hcˇ
 = 
	`memÆign_high
(256, (*hcca));

240 
ohci_ed
 *
öå_ed
 = 
	`mÆloc_high
((*intr_ed));

241 i‡(!
hcˇ
 || !
öå_ed
) {

242 
	`w¨n_nﬂŒoc
();

243 
‰ì
;

245 
	`mem£t
(
hcˇ
, 0, (*hcca));

246 
	`mem£t
(
öå_ed
, 0, (*intr_ed));

247 
öå_ed
->
hwINFO
 = 
ED_SKIP
;

248 
i
;

249 
i
=0; i<
	`ARRAY_SIZE
(
hcˇ
->
öt_èbÀ
); i++)

250 
hcˇ
->
öt_èbÀ
[
i
] = (
u32
)
öå_ed
;

252 
ªt
 = 
	`°¨t_ohci
(
˙é
, 
hcˇ
);

253 i‡(
ªt
)

254 
îr
;

256 
cou¡
 = 
	`check_ohci_p‹ts
(
˙é
);

257 
	`ohci_‰ì_pùes
(
˙é
);

258 i‡(! 
cou¡
)

259 
îr
;

262 
îr
:

263 
	`°›_ohci
(
˙é
);

264 
‰ì
:

265 
	`‰ì
(
hcˇ
);

266 
	`‰ì
(
öå_ed
);

267 
	}
}

270 
	$ohci_c⁄åﬁÀr_£tup
(
pci_devi˚
 *
pci
)

272 
usb_ohci_s
 *
˙é
 = 
	`mÆloc_tmphigh
((*cntl));

273 i‡(!
˙é
) {

274 
	`w¨n_nﬂŒoc
();

277 
	`mem£t
(
˙é
, 0, (*cntl));

278 
˙é
->
usb
.
pci
 =Öci;

279 
˙é
->
usb
.
ty≥
 = 
USB_TYPE_OHCI
;

281 
	`waô_¥ìm±
();

282 
u16
 
bdf
 = 
pci
->bdf;

283 
u32
 
ba£addr
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_0
);

284 
˙é
->
ªgs
 = (*)(
ba£addr
 & 
PCI_BASE_ADDRESS_MEM_MASK
);

286 
	`d¥ötf
(1, "OHCI init on dev %02x:%02x.%x (regs=%p)\n"

287 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf)

288 , 
	`pci_bdf_to_‚
(
bdf
), 
˙é
->
ªgs
);

291 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND


292 , 0, 
PCI_COMMAND_MASTER
|
PCI_COMMAND_MEMORY
);

297 
	`wrôñ
(&
˙é
->
ªgs
->
öådißbÀ
, ~0);

298 
	`wrôñ
(&
˙é
->
ªgs
->
öå°©us
, ~0);

300 
	`run_thªad
(
c⁄figuª_ohci
, 
˙é
);

301 
	}
}

304 
	$ohci_£tup
()

306 i‡(! 
CONFIG_USB_OHCI
)

308 
pci_devi˚
 *
pci
;

309 
	`f‹óchpci
(
pci
) {

310 i‡(
	`pci_˛as•rog
(
pci
Ë=
PCI_CLASS_SERIAL_USB_OHCI
)

311 
	`ohci_c⁄åﬁÀr_£tup
(
pci
);

313 
	}
}

322 
	$ohci_desc2pùe
(
ohci_pùe
 *
pùe
, 
usbdevi˚_s
 *
usbdev


323 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

325 
	`usb_desc2pùe
(&
pùe
->pùe, 
usbdev
, 
ïdesc
);

326 
pùe
->
ed
.
hwINFO
 = (
ED_SKIP
 | 
usbdev
->
devaddr
 | (pùe->pùe.
ï
 << 7)

327 | (
ïdesc
->
wMaxPackëSize
 << 16)

328 | (
usbdev
->
•ìd
 ? 
ED_LOWSPEED
 : 0));

329 
	}
}

331 
usb_pùe
 *

332 
	$ohci_Æloc_öå_pùe
(
usbdevi˚_s
 *
usbdev


333 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

335 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(

336 
usbdev
->
hub
->
˙é
, 
usb_ohci_s
, 
usb
);

337 
‰amìxp
 = 
	`usb_gëFømeExp
(
usbdev
, 
ïdesc
);

338 
	`d¥ötf
(7, "ohci_Æloc_öå_pùê%∞%d\n", &
˙é
->
usb
, 
‰amìxp
);

340 i‡(
‰amìxp
 > 5)

341 
‰amìxp
 = 5;

342 
max∑ckë
 = 
ïdesc
->
wMaxPackëSize
;

344 
ms
 = 1<<
‰amìxp
;

345 
cou¡
 = 
	`DIV_ROUND_UP
(
	`ticks_to_ms
(2), 
ms
) + 1;

346 
ohci_pùe
 *
pùe
 = 
	`mÆloc_low
((*pipe));

347 
ohci_td
 *
tds
 = 
	`mÆloc_low
((*tdsË* 
cou¡
);

348 *
d©a
 = 
	`mÆloc_low
(
max∑ckë
 * 
cou¡
);

349 i‡(!
pùe
 || !
tds
 || !
d©a
)

350 
îr
;

351 
	`mem£t
(
pùe
, 0, (*pipe));

352 
	`ohci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

353 
pùe
->
ed
.
hwINFO
 &~
ED_SKIP
;

354 
pùe
->
d©a
 = data;

355 
pùe
->
cou¡
 = count;

356 
pùe
->
tds
 =Åds;

358 
ohci_ed
 *
ed
 = &
pùe
->ed;

359 
ed
->
hwHódP
 = (
u32
)&
tds
[0];

360 
ed
->
hwTaûP
 = (
u32
)&
tds
[
cou¡
-1];

362 
i
;

363 
i
=0; i<
cou¡
-1; i++) {

364 
tds
[
i
].
hwINFO
 = 
TD_DP_IN
 | 
TD_T_TOGGLE
 | 
TD_CC
;

365 
tds
[
i
].
hwCBP
 = (
u32
)
d©a
 + 
max∑ckë
 * i;

366 
tds
[
i
].
hwNextTD
 = (
u32
)&tds[i+1];

367 
tds
[
i
].
hwBE
 =Åds[i].
hwCBP
 + 
max∑ckë
 - 1;

371 
ohci_hcˇ
 *
hcˇ
 = (*)
˙é
->
ªgs
->hcca;

372 i‡(
‰amìxp
 == 0) {

374 
ohci_ed
 *
öå_ed
 = (*)
hcˇ
->
öt_èbÀ
[0];

375 
ed
->
hwNextED
 = 
öå_ed
->hwNextED;

376 
	`b¨rõr
();

377 
öå_ed
->
hwNextED
 = (
u32
)
ed
;

379 
°¨ços
 = 1<<(
‰amìxp
-1);

380 
ed
->
hwNextED
 = 
hcˇ
->
öt_èbÀ
[
°¨ços
];

381 
	`b¨rõr
();

382 
i
=
°¨ços
; i<
	`ARRAY_SIZE
(
hcˇ
->
öt_èbÀ
); i+=
ms
)

383 
hcˇ
->
öt_èbÀ
[
i
] = (
u32
)
ed
;

386  &
pùe
->pipe;

388 
îr
:

389 
	`‰ì
(
pùe
);

390 
	`‰ì
(
tds
);

391 
	`‰ì
(
d©a
);

392  
NULL
;

393 
	}
}

395 
usb_pùe
 *

396 
	$ohci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


397 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

399 i‡(! 
CONFIG_USB_OHCI
)

400  
NULL
;

401 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

402 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

403  
	`ohci_Æloc_öå_pùe
(
usbdev
, 
ïdesc
);

404 i‡(
ïty≥
 !
USB_ENDPOINT_XFER_CONTROL
) {

405 
	`d¥ötf
(1, "OHCI BulkÅransfersÇot supported.\n");

406  
NULL
;

408 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(

409 
usbdev
->
hub
->
˙é
, 
usb_ohci_s
, 
usb
);

410 
	`d¥ötf
(7, "ohci_Æloc_async_pùê%p\n", &
˙é
->
usb
);

412 
usb_pùe
 *
usbpùe
 = 
	`usb_gëFªePùe
(&
˙é
->
usb
, 
ïty≥
);

413 i‡(
usbpùe
) {

415 
ohci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
usbpùe
, ohci_pipe,Öipe);

416 
	`ohci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

417  
usbpùe
;

421 
ohci_pùe
 *
pùe
 = 
	`mÆloc_tmphigh
((*pipe));

422 i‡(!
pùe
) {

423 
	`w¨n_nﬂŒoc
();

424  
NULL
;

426 
	`mem£t
(
pùe
, 0, (*pipe));

427 
	`ohci_desc2pùe
(
pùe
, 
usbdev
, 
ïdesc
);

430 
pùe
->
ed
.
hwNextED
 = 
˙é
->
ªgs
->
ed_c⁄åﬁhód
;

431 
	`b¨rõr
();

432 
˙é
->
ªgs
->
ed_c⁄åﬁhód
 = (
u32
)&
pùe
->
ed
;

433  &
pùe
->pipe;

434 
	}
}

437 
	$waô_ed
(
ohci_ed
 *
ed
)

440 
u32
 
íd
 = 
	`timî_ˇlc
(500);

442 i‡(
ed
->
hwHódP
 =ed->
hwTaûP
)

444 i‡(
	`timî_check
(
íd
)) {

445 
	`w¨n_timeout
();

448 
	`yõld
();

450 
	}
}

453 
	$ohci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


454 , *
d©a
, 
d©asize
)

456 i‡(! 
CONFIG_USB_OHCI
)

458 
	`d¥ötf
(5, "ohci_c⁄åﬁ %p\n", 
p
);

459 i‡(
d©asize
 > 4096) {

461 
	`w¨n_nﬂŒoc
();

464 
ohci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, ohci_pipe,Öipe);

465 
usb_ohci_s
 *
˙é
 = 
	`c⁄èöî_of
(

466 
pùe
->pùe.
˙é
, 
usb_ohci_s
, 
usb
);

469 
ohci_td
 *
tds
 = 
	`mÆloc_tmphigh
((*tds) * 3);

470 i‡(!
tds
) {

471 
	`w¨n_nﬂŒoc
();

474 
ohci_td
 *
td
 = 
tds
;

475 
td
->
hwINFO
 = 
TD_DP_SETUP
 | 
TD_T_DATA0
 | 
TD_CC
;

476 
td
->
hwCBP
 = (
u32
)
cmd
;

477 
td
->
hwNextTD
 = (
u32
)&td[1];

478 
td
->
hwBE
 = (
u32
)
cmd
 + 
cmdsize
 - 1;

479 
td
++;

480 i‡(
d©asize
) {

481 
td
->
hwINFO
 = (
dú
 ? 
TD_DP_IN
 : 
TD_DP_OUT
Ë| 
TD_T_DATA1
 | 
TD_CC
;

482 
td
->
hwCBP
 = (
u32
)
d©a
;

483 
td
->
hwNextTD
 = (
u32
)&td[1];

484 
td
->
hwBE
 = (
u32
)
d©a
 + 
d©asize
 - 1;

485 
td
++;

487 
td
->
hwINFO
 = (
dú
 ? 
TD_DP_OUT
 : 
TD_DP_IN
Ë| 
TD_T_DATA1
 | 
TD_CC
;

488 
td
->
hwCBP
 = 0;

489 
td
->
hwNextTD
 = (
u32
)&td[1];

490 
td
->
hwBE
 = 0;

491 
td
++;

494 
pùe
->
ed
.
hwHódP
 = (
u32
)
tds
;

495 
pùe
->
ed
.
hwTaûP
 = (
u32
)
td
;

496 
	`b¨rõr
();

497 
pùe
->
ed
.
hwINFO
 &~
ED_SKIP
;

498 
	`wrôñ
(&
˙é
->
ªgs
->
cmd°©us
, 
OHCI_CLF
);

500 
ªt
 = 
	`waô_ed
(&
pùe
->
ed
);

501 
pùe
->
ed
.
hwINFO
 |
ED_SKIP
;

502 i‡(
ªt
)

503 
	`ohci_waôtick
(
˙é
);

504 
	`‰ì
(
tds
);

505  
ªt
;

506 
	}
}

509 
	$ohci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
)

512 
	}
}

515 
	$ohci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
)

517 
	`ASSERT16
();

518 i‡(! 
CONFIG_USB_OHCI
)

521 
ohci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, ohci_pipe,Öipe);

522 
ohci_td
 *
tds
 = 
	`GET_LOWFLAT
(
pùe
->tds);

523 
ohci_td
 *
hód
 = (*)(
	`GET_LOWFLAT
(
pùe
->
ed
.
hwHódP
Ë& ~(
ED_C
|
ED_H
));

524 
ohci_td
 *
èû
 = (*)
	`GET_LOWFLAT
(
pùe
->
ed
.
hwTaûP
);

525 
cou¡
 = 
	`GET_LOWFLAT
(
pùe
->count);

526 
pos
 = (
èû
 - 
tds
 + 1Ë% 
cou¡
;

527 
ohci_td
 *
√xt
 = &
tds
[
pos
];

528 i‡(
hód
 =
√xt
)

534 
max∑ckë
 = 
	`GET_LOWFLAT
(
pùe
->pipe.maxpacket);

535 *
pùed©a
 = 
	`GET_LOWFLAT
((
pùe
->
d©a
));

536 *
öåd©a
 = 
pùed©a
 + 
max∑ckë
 * 
pos
;

537 
	`mem˝y_Ár
(
	`GET_SEG
(
SS
), 
d©a
, 
SEG_LOW
, 
	`LOWFLAT2LOW
(
öåd©a
), 
max∑ckë
);

540 
	`SET_LOWFLAT
(
èû
->
hwINFO
, 
TD_DP_IN
 | 
TD_T_TOGGLE
 | 
TD_CC
);

541 
öåd©a
 = 
pùed©a
 + 
max∑ckë
 * (
èû
-
tds
);

542 
	`SET_LOWFLAT
(
èû
->
hwCBP
, (
u32
)
öåd©a
);

543 
	`SET_LOWFLAT
(
èû
->
hwNextTD
, (
u32
)
√xt
);

544 
	`SET_LOWFLAT
(
èû
->
hwBE
, (
u32
)
öåd©a
 + 
max∑ckë
 - 1);

545 
	`b¨rõr
();

546 
	`SET_LOWFLAT
(
pùe
->
ed
.
hwTaûP
, (
u32
)
√xt
);

549 
	}
}

	@hw/usb-ohci.h

1 #i‚de‡
__USB_OHCI_H


2 
	#__USB_OHCI_H


	)

5 
ohci_£tup
();

6 
	gusbdevi˚_s
;

7 
	gusb_ídpoöt_des¸ùt‹
;

8 
usb_pùe
 *
ohci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


9 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

10 
	gusb_pùe
;

11 
ohci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


12 , *
d©a
, 
d©asize
);

13 
ohci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
);

14 
ohci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
);

21 
	sohci_ed
 {

22 
u32
 
	mhwINFO
;

23 
u32
 
	mhwTaûP
;

24 
u32
 
	mhwHódP
;

25 
u32
 
	mhwNextED
;

26 } 
	gPACKED
;

28 
	#ED_ISO
 (1 << 15)

	)

29 
	#ED_SKIP
 (1 << 14)

	)

30 
	#ED_LOWSPEED
 (1 << 13)

	)

31 
	#ED_OUT
 (0x01 << 11)

	)

32 
	#ED_IN
 (0x02 << 11)

	)

34 
	#ED_C
 (0x02)

	)

35 
	#ED_H
 (0x01)

	)

37 
	sohci_td
 {

38 
u32
 
	mhwINFO
;

39 
u32
 
	mhwCBP
;

40 
u32
 
	mhwNextTD
;

41 
u32
 
	mhwBE
;

42 } 
	gPACKED
;

44 
	#TD_CC
 0xf0000000

	)

45 
	#TD_CC_GET
(
td_p
Ë(—d_∞>>28Ë& 0x0f)

	)

46 
	#TD_DI
 0x00E00000

	)

48 
	#TD_DONE
 0x00020000

	)

49 
	#TD_ISO
 0x00010000

	)

51 
	#TD_EC
 0x0C000000

	)

52 
	#TD_T
 0x03000000

	)

53 
	#TD_T_DATA0
 0x02000000

	)

54 
	#TD_T_DATA1
 0x03000000

	)

55 
	#TD_T_TOGGLE
 0x00000000

	)

56 
	#TD_DP
 0x00180000

	)

57 
	#TD_DP_SETUP
 0x00000000

	)

58 
	#TD_DP_IN
 0x00100000

	)

59 
	#TD_DP_OUT
 0x00080000

	)

61 
	#TD_R
 0x00040000

	)

63 
	sohci_hcˇ
 {

64 
u32
 
	möt_èbÀ
[32];

65 
u32
 
	m‰ame_no
;

66 
u32
 
	md⁄e_hód
;

67 
u8
 
	mª£rved
[120];

68 } 
	gPACKED
;

70 
	sohci_ªgs
 {

71 
u32
 
	mªvisi⁄
;

72 
u32
 
	mc⁄åﬁ
;

73 
u32
 
	mcmd°©us
;

74 
u32
 
	möå°©us
;

75 
u32
 
	möåíabÀ
;

76 
u32
 
	möådißbÀ
;

78 
u32
 
	mhcˇ
;

79 
u32
 
	med_≥riodcuºít
;

80 
u32
 
	med_c⁄åﬁhód
;

81 
u32
 
	med_c⁄åﬁcuºít
;

82 
u32
 
	med_bulkhód
;

83 
u32
 
	med_bulkcuºít
;

84 
u32
 
	md⁄ehód
;

86 
u32
 
	mfmöãrvÆ
;

87 
u32
 
	mfmªmaöög
;

88 
u32
 
	mfmnumbî
;

89 
u32
 
	m≥riodic°¨t
;

90 
u32
 
	ml°hªsh
;

92 
u32
 
	mroŸhub_a
;

93 
u32
 
	mroŸhub_b
;

94 
u32
 
	mroŸhub_°©us
;

95 
u32
 
	mroŸhub_p‹t°©us
[15];

96 } 
	gPACKED
;

98 
	#OHCI_CTRL_CBSR
 (3 << 0)

	)

99 
	#OHCI_CTRL_PLE
 (1 << 2)

	)

100 
	#OHCI_CTRL_CLE
 (1 << 4)

	)

101 
	#OHCI_CTRL_BLE
 (1 << 5)

	)

102 
	#OHCI_CTRL_HCFS
 (3 << 6)

	)

103 
	#OHCI_USB_RESET
 (0 << 6)

	)

104 
	#OHCI_USB_OPER
 (2 << 6)

	)

105 
	#OHCI_CTRL_RWC
 (1 << 9)

	)

107 
	#OHCI_HCR
 (1 << 0)

	)

108 
	#OHCI_CLF
 (1 << 1)

	)

110 
	#OHCI_INTR_MIE
 (1 << 31)

	)

112 
	#RH_PS_CCS
 0x00000001

	)

113 
	#RH_PS_PES
 0x00000002

	)

114 
	#RH_PS_PSS
 0x00000004

	)

115 
	#RH_PS_POCI
 0x00000008

	)

116 
	#RH_PS_PRS
 0x00000010

	)

117 
	#RH_PS_PPS
 0x00000100

	)

118 
	#RH_PS_LSDA
 0x00000200

	)

119 
	#RH_PS_CSC
 0x00010000

	)

120 
	#RH_PS_PESC
 0x00020000

	)

121 
	#RH_PS_PSSC
 0x00040000

	)

122 
	#RH_PS_OCIC
 0x00080000

	)

123 
	#RH_PS_PRSC
 0x00100000

	)

125 
	#RH_HS_LPS
 0x00000001

	)

126 
	#RH_HS_OCI
 0x00000002

	)

127 
	#RH_HS_DRWE
 0x00008000

	)

128 
	#RH_HS_LPSC
 0x00010000

	)

129 
	#RH_HS_OCIC
 0x00020000

	)

130 
	#RH_HS_CRWE
 0x80000000

	)

132 
	#RH_B_DR
 0x0000ffff

	)

133 
	#RH_B_PPCM
 0xffff0000

	)

135 
	#RH_A_NDP
 (0xf‡<< 0)

	)

136 
	#RH_A_PSM
 (1 << 8)

	)

137 
	#RH_A_NPS
 (1 << 9)

	)

138 
	#RH_A_DT
 (1 << 10)

	)

139 
	#RH_A_OCPM
 (1 << 11)

	)

140 
	#RH_A_NOCP
 (1 << 12)

	)

141 
	#RH_A_POTPGT
 (0xf‡<< 24)

	)

	@hw/usb-uas.c

17 
	~"biosv¨.h
"

18 
	~"block.h
"

19 
	~"blockcmd.h
"

20 
	~"c⁄fig.h
"

21 
	~"mÆloc.h
"

22 
	~"ouçut.h
"

23 
	~"°d/disk.h
"

24 
	~"°rög.h
"

25 
	~"usb.h
"

26 
	~"usb-uas.h
"

27 
	~"utû.h
"

29 
	#UAS_UI_COMMAND
 0x01

	)

30 
	#UAS_UI_SENSE
 0x03

	)

31 
	#UAS_UI_RESPONSE
 0x04

	)

32 
	#UAS_UI_TASK_MGMT
 0x05

	)

33 
	#UAS_UI_READ_READY
 0x06

	)

34 
	#UAS_UI_WRITE_READY
 0x07

	)

36 
	#UAS_PIPE_ID_COMMAND
 0x01

	)

37 
	#UAS_PIPE_ID_STATUS
 0x02

	)

38 
	#UAS_PIPE_ID_DATA_IN
 0x03

	)

39 
	#UAS_PIPE_ID_DATA_OUT
 0x04

	)

42 
u8
 
	mid
;

43 
u8
 
	mª£rved
;

44 
u16
 
	mèg
;

45 } 
	tPACKED
 
	tuas_ui_hódî
;

48 
u8
 
	m¥io_èsk©å
;

49 
u8
 
	mª£rved_1
;

50 
u8
 
	madd_cdb_Àngth
;

51 
u8
 
	mª£rved_2
;

52 
u8
 
	mlun
[8];

53 
u8
 
	mcdb
[16];

54 
u8
 
	madd_cdb
[];

55 } 
	tPACKED
 
	tuas_ui_comm™d
;

58 
u16
 
	m°©us_quÆifõr
;

59 
u8
 
	m°©us
;

60 
u8
 
	mª£rved
[7];

61 
u16
 
	m£n£_Àngth
;

62 
u8
 
	m£n£_d©a
[18];

63 } 
	tPACKED
 
	tuas_ui_£n£
;

66 
u16
 
	madd_ª•⁄£_öfo
;

67 
u8
 
	mª•⁄£_code
;

68 } 
	tPACKED
 
	tuas_ui_ª•⁄£
;

71 
u8
 
	mfun˘i⁄
;

72 
u8
 
	mª£rved
;

73 
u16
 
	mèsk_èg
;

74 
u8
 
	mlun
[8];

75 } 
	tPACKED
 
	tuas_ui_èsk_mgmt
;

78 
uas_ui_hódî
 
	mhdr
;

80 
uas_ui_comm™d
 
	mcomm™d
;

81 
uas_ui_£n£
 
	m£n£
;

82 
uas_ui_èsk_mgmt
 
	mèsk
;

83 
uas_ui_ª•⁄£
 
	mª•⁄£
;

85 } 
	tPACKED
 
	tuas_ui
;

87 
	suasdrive_s
 {

88 
drive_s
 
	mdrive
;

89 
usb_pùe
 *
	mcomm™d
, *
	m°©us
, *
	md©a_ö
, *
	md©a_out
;

90 
	mlun
;

94 
	$uas_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

96 i‡(!
CONFIG_USB_UAS
)

97  
DISK_RET_EBADTRACK
;

99 
uasdrive_s
 *
drive_gf
 = 
	`c⁄èöî_of
(

100 
›
->
drive_gf
, 
uasdrive_s
, 
drive
);

102 
uas_ui
 
ui
;

103 
	`mem£t
(&
ui
, 0, (ui));

104 
ui
.
hdr
.
id
 = 
UAS_UI_COMMAND
;

105 
ui
.
hdr
.
èg
 = 0xdead;

106 
ui
.
comm™d
.
lun
[1] = 
	`GET_GLOBALFLAT
(
drive_gf
->lun);

107 
	`mem˝y
(
ui
.
comm™d
.
cdb
, 
cdbcmd
, (ui.command.cdb));

108 
ªt
 = 
	`usb_£nd_bulk
(
	`GET_GLOBALFLAT
(
drive_gf
->
comm™d
),

109 
USB_DIR_OUT
, 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ui
),

110 (
ui
.
hdr
Ë+ (ui.
comm™d
));

111 i‡(
ªt
) {

112 
	`d¥ötf
(1, "uas: command send fail");

113 
Áû
;

116 
	`mem£t
(&
ui
, 0xff, (ui));

117 
ªt
 = 
	`usb_£nd_bulk
(
	`GET_GLOBALFLAT
(
drive_gf
->
°©us
),

118 
USB_DIR_IN
, 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ui
), (ui));

119 i‡(
ªt
) {

120 
	`d¥ötf
(1, "uas: statusÑecv fail");

121 
Áû
;

124 
ui
.
hdr
.
id
) {

125 
UAS_UI_SENSE
:

126 
have_£n£
;

127 
UAS_UI_READ_READY
:

128 
ªt
 = 
	`usb_£nd_bulk
(
	`GET_GLOBALFLAT
(
drive_gf
->
d©a_ö
),

129 
USB_DIR_IN
, 
›
->
buf_Ê
, op->
cou¡
 * 
blocksize
);

130 i‡(
ªt
) {

131 
	`d¥ötf
(1, "uas: dataÑead fail");

132 
Áû
;

135 
UAS_UI_WRITE_READY
:

136 
ªt
 = 
	`usb_£nd_bulk
(
	`GET_GLOBALFLAT
(
drive_gf
->
d©a_out
),

137 
USB_DIR_OUT
, 
›
->
buf_Ê
, op->
cou¡
 * 
blocksize
);

138 i‡(
ªt
) {

139 
	`d¥ötf
(1, "uas: data write fail");

140 
Áû
;

144 
	`d¥ötf
(1, "uas: unknow¿°©u†uòid %d", 
ui
.
hdr
.
id
);

145 
Áû
;

148 
	`mem£t
(&
ui
, 0xff, (ui));

149 
ªt
 = 
	`usb_£nd_bulk
(
	`GET_GLOBALFLAT
(
drive_gf
->
°©us
),

150 
USB_DIR_IN
, 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ui
), (ui));

151 i‡(
ªt
) {

152 
	`d¥ötf
(1, "uas: statusÑecv fail");

153 
Áû
;

155 i‡(
ui
.
hdr
.
id
 !
UAS_UI_SENSE
) {

156 
	`d¥ötf
(1, "uas:Éx≥˘ed sí£ ui, gŸ uòid %d", 
ui
.
hdr
.
id
);

157 
Áû
;

160 
have_£n£
:

161 i‡(
ui
.
£n£
.
°©us
 == 0) {

162  
DISK_RET_SUCCESS
;

165 
Áû
:

166  
DISK_RET_EBADTRACK
;

167 
	}
}

170 
	$uas_lun_£tup
(
usbdevi˚_s
 *
usbdev
,

171 
usb_pùe
 *
comm™d
, usb_pùê*
°©us
,

172 
usb_pùe
 *
d©a_ö
, usb_pùê*
d©a_out
,

173 
lun
)

176 
uasdrive_s
 *
drive
 = 
	`mÆloc_f£g
((*drive));

177 i‡(!
drive
) {

178 
	`w¨n_nﬂŒoc
();

181 
	`mem£t
(
drive
, 0, (*drive));

182 i‡(
	`usb_32bô_pùe
(
d©a_ö
))

183 
drive
->drive.
ty≥
 = 
DTYPE_UAS_32
;

185 
drive
->drive.
ty≥
 = 
DTYPE_UAS
;

186 
drive
->
comm™d
 = command;

187 
drive
->
°©us
 = status;

188 
drive
->
d©a_ö
 = data_in;

189 
drive
->
d©a_out
 = data_out;

190 
drive
->
lun
 =Üun;

192 
¥io
 = 
	`boŸ¥io_föd_usb
(
usbdev
, 
lun
);

193 
ªt
 = 
	`scsi_drive_£tup
(&
drive
->drive, "USB UAS", 
¥io
);

194 i‡(
ªt
) {

195 
	`‰ì
(
drive
);

199 
	}
}

202 
	$usb_uas_£tup
(
usbdevi˚_s
 *
usbdev
)

204 i‡(!
CONFIG_USB_UAS
)

208 
usb_öãrÁ˚_des¸ùt‹
 *
iÁ˚
 = 
usbdev
->iface;

209 i‡(
iÁ˚
->
bI¡îÁ˚SubCœss
 !
US_SC_SCSI
 ||

210 
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 !
US_PR_UAS
) {

211 
	`d¥ötf
(1, "Unsupported UAS device (subclass=%02xÖroto=%02x)\n"

212 , 
iÁ˚
->
bI¡îÁ˚SubCœss
, iÁ˚->
bI¡îÁ˚PrŸocﬁ
);

217 
usb_ídpoöt_des¸ùt‹
 *
ï
 = 
NULL
;

218 
usb_pùe
 *
comm™d
 = 
NULL
;

219 
usb_pùe
 *
°©us
 = 
NULL
;

220 
usb_pùe
 *
d©a_ö
 = 
NULL
;

221 
usb_pùe
 *
d©a_out
 = 
NULL
;

222 
u8
 *
desc
 = (u8*)
iÁ˚
;

223 
desc
) {

224 
desc
 += desc[0];

225 
desc
[1]) {

226 
USB_DT_ENDPOINT
:

227 
ï
 = (*)
desc
;

229 
USB_DT_ENDPOINT_COMPANION
:

231 
	`d¥ötf
(1, "Superspeed UAS devicesÇot supported (yet)\n");

232 
Áû
;

234 
desc
[2]) {

235 
UAS_PIPE_ID_COMMAND
:

236 
comm™d
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ï
);

238 
UAS_PIPE_ID_STATUS
:

239 
°©us
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ï
);

241 
UAS_PIPE_ID_DATA_IN
:

242 
d©a_ö
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ï
);

244 
UAS_PIPE_ID_DATA_OUT
:

245 
d©a_out
 = 
	`usb_Æloc_pùe
(
usbdev
, 
ï
);

248 
Áû
;

252 
desc
 = 
NULL
;

256 i‡(!
comm™d
 || !
°©us
 || !
d©a_ö
 || !
d©a_out
)

257 
Áû
;

260 
ªt
 = 
	`uas_lun_£tup
(
usbdev
, 
comm™d
, 
°©us
, 
d©a_ö
, 
d©a_out
, 0);

261 i‡(
ªt
 < 0) {

262 
	`d¥ötf
(1, "UnableÅo configure UAS drive.\n");

263 
Áû
;

268 
Áû
:

269 
	`‰ì_pùe
(
comm™d
);

270 
	`‰ì_pùe
(
°©us
);

271 
	`‰ì_pùe
(
d©a_ö
);

272 
	`‰ì_pùe
(
d©a_out
);

274 
	}
}

	@hw/usb-uas.h

1 #i‚de‡
__USB_UAS_H


2 
	#__USB_UAS_H


	)

4 
	gdisk_›_s
;

5 
uas_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

6 
	gusbdevi˚_s
;

7 
usb_uas_£tup
(
usbdevi˚_s
 *
usbdev
);

	@hw/usb-uhci.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"mÆloc.h
"

10 
	~"ouçut.h
"

11 
	~"pci.h
"

12 
	~"pci_ids.h
"

13 
	~"pci_ªgs.h
"

14 
	~"°rög.h
"

15 
	~"usb.h
"

16 
	~"usb-uhci.h
"

17 
	~"utû.h
"

18 
	~"x86.h
"

20 
	susb_uhci_s
 {

21 
usb_s
 
	musb
;

22 
u16
 
	mioba£
;

23 
uhci_qh
 *
	mc⁄åﬁ_qh
;

24 
uhci_‰amñi°
 *
	m‰amñi°
;

27 
	suhci_pùe
 {

28 
uhci_qh
 
	mqh
;

29 
uhci_td
 *
	m√xt_td
;

30 
usb_pùe
 
	mpùe
;

31 
u16
 
	mioba£
;

32 
u8
 
	mtoggÀ
;

42 
	$uhci_hub_dëe˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

44 
usb_uhci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_uhci_s, 
usb
);

45 
u16
 
i›‹t
 = 
˙é
->
ioba£
 + 
USBPORTSC1
 + 
p‹t
 * 2;

47 
u16
 
°©us
 = 
	`öw
(
i›‹t
);

48 i‡(!(
°©us
 & 
USBPORTSC_CCS
))

55 
	`outw
(
USBPORTSC_PR
, 
i›‹t
);

56 
	`m¶ìp
(
USB_TIME_DRSTR
);

58 
	}
}

62 
	$uhci_hub_ª£t
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

64 
usb_uhci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_uhci_s, 
usb
);

65 
u16
 
i›‹t
 = 
˙é
->
ioba£
 + 
USBPORTSC1
 + 
p‹t
 * 2;

68 
	`outw
(0, 
i›‹t
);

69 
	`udñay
(6);

70 
u16
 
°©us
 = 
	`öw
(
i›‹t
);

71 i‡(!(
°©us
 & 
USBPORTSC_CCS
))

74 
	`outw
(
USBPORTSC_PE
, 
i›‹t
);

75  !!(
°©us
 & 
USBPORTSC_LSDA
);

76 
	}
}

80 
	$uhci_hub_disc⁄√˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

82 
usb_uhci_s
 *
˙é
 = 
	`c⁄èöî_of
(
hub
->˙é, usb_uhci_s, 
usb
);

83 
u16
 
i›‹t
 = 
˙é
->
ioba£
 + 
USBPORTSC1
 + 
p‹t
 * 2;

84 
	`outw
(0, 
i›‹t
);

85 
	}
}

87 
usbhub_›_s
 
	guhci_HubOp
 = {

88 .
dëe˘
 = 
uhci_hub_dëe˘
,

89 .
	gª£t
 = 
uhci_hub_ª£t
,

90 .
	gdisc⁄√˘
 = 
uhci_hub_disc⁄√˘
,

95 
	$check_uhci_p‹ts
(
usb_uhci_s
 *
˙é
)

97 
	`ASSERT32FLAT
();

98 
usbhub_s
 
hub
;

99 
	`mem£t
(&
hub
, 0, (hub));

100 
hub
.
˙é
 = &˙é->
usb
;

101 
hub
.
p‹tcou¡
 = 2;

102 
hub
.
›
 = &
uhci_HubOp
;

103 
	`usb_íumî©e
(&
hub
);

104  
hub
.
devcou¡
;

105 
	}
}

114 
	$uhci_waôtick
(
u16
 
ioba£
)

116 
	`b¨rõr
();

117 
u16
 
°¨t‰ame
 = 
	`öw
(
ioba£
 + 
USBFRNUM
);

118 
u32
 
íd
 = 
	`timî_ˇlc
(1000 * 5);

120 i‡(
	`öw
(
ioba£
 + 
USBFRNUM
Ë!
°¨t‰ame
)

122 i‡(
	`timî_check
(
íd
)) {

123 
	`w¨n_timeout
();

126 
	`yõld
();

128 
	}
}

131 
	$uhci_‰ì_pùes
(
usb_uhci_s
 *
˙é
)

133 
	`d¥ötf
(7, "uhci_‰ì_pùe†%p\n", 
˙é
);

135 
uhci_qh
 *
pos
 = (*)(
˙é
->
‰amñi°
->
löks
[0] & ~
UHCI_PTR_BITS
);

137 
u32
 
lök
 = 
pos
->link;

138 i‡(
lök
 =
UHCI_PTR_TERM
)

140 
uhci_qh
 *
√xt
 = (*)(
lök
 & ~
UHCI_PTR_BITS
);

141 
uhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
√xt
, uhci_pùe, 
qh
);

142 i‡(
pùe
->pùe.
˙é
 !&˙é->
usb
)

143 
pos
->
lök
 = 
√xt
->link;

145 
pos
 = 
√xt
;

147 
	`uhci_waôtick
(
˙é
->
ioba£
);

149 
usb_pùe
 *
usbpùe
 = 
˙é
->
usb
.
‰ìli°
;

150 i‡(!
usbpùe
)

152 
˙é
->
usb
.
‰ìli°
 = 
usbpùe
->
‰ì√xt
;

153 
uhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
usbpùe
, uhci_pipe,Öipe);

154 
	`‰ì
(
pùe
);

156 
	}
}

159 
	$ª£t_uhci
(
usb_uhci_s
 *
˙é
, 
u16
 
bdf
)

164 
	`pci_c⁄fig_wrôew
(
bdf
, 
USBLEGSUP
, 
USBLEGSUP_RWC
);

167 
	`outw
(
USBCMD_HCRESET
, 
˙é
->
ioba£
 + 
USBCMD
);

168 
	`udñay
(5);

171 
	`outw
(0, 
˙é
->
ioba£
 + 
USBINTR
);

172 
	`outw
(0, 
˙é
->
ioba£
 + 
USBCMD
);

173 
	}
}

176 
	$c⁄figuª_uhci
(*
d©a
)

178 
usb_uhci_s
 *
˙é
 = 
d©a
;

181 
uhci_td
 *
ãrm_td
 = 
	`mÆloc_high
((*term_td));

182 
uhci_‰amñi°
 *
Ê
 = 
	`memÆign_high
((*fl), (*fl));

183 
uhci_pùe
 *
öå_pùe
 = 
	`mÆloc_high
((*intr_pipe));

184 
uhci_pùe
 *
ãrm_pùe
 = 
	`mÆloc_high
((*term_pipe));

185 i‡(!
ãrm_td
 || !
Ê
 || !
öå_pùe
 || !
ãrm_pùe
) {

186 
	`w¨n_nﬂŒoc
();

187 
Áû
;

191 
	`mem£t
(
ãrm_td
, 0, (*term_td));

192 
ãrm_td
->
lök
 = 
UHCI_PTR_TERM
;

193 
ãrm_td
->
tokí
 = (
	`uhci_ex∂í
(0Ë| (0x7‡<< 
TD_TOKEN_DEVADDR_SHIFT
)

194 | 
USB_PID_IN
);

195 
	`mem£t
(
ãrm_pùe
, 0, (*term_pipe));

196 
ãrm_pùe
->
qh
.
ñemít
 = (
u32
)
ãrm_td
;

197 
ãrm_pùe
->
qh
.
lök
 = 
UHCI_PTR_TERM
;

198 
ãrm_pùe
->
pùe
.
˙é
 = &˙é->
usb
;

201 
	`mem£t
(
öå_pùe
, 0, (*intr_pipe));

202 
öå_pùe
->
qh
.
ñemít
 = 
UHCI_PTR_TERM
;

203 
öå_pùe
->
qh
.
lök
 = (
u32
)&
ãrm_pùe
->qh | 
UHCI_PTR_QH
;

204 
öå_pùe
->
pùe
.
˙é
 = &˙é->
usb
;

205 
i
;

206 
i
=0; i<
	`ARRAY_SIZE
(
Ê
->
löks
); i++)

207 
Ê
->
löks
[
i
] = (
u32
)&
öå_pùe
->
qh
 | 
UHCI_PTR_QH
;

208 
˙é
->
‰amñi°
 = 
Ê
;

209 
˙é
->
c⁄åﬁ_qh
 = &
öå_pùe
->
qh
;

210 
	`b¨rõr
();

213 
	`outb
(
USBSOF_DEFAULT
, 
˙é
->
ioba£
 + 
USBSOF
);

216 
	`oué
((
u32
)
Ê
->
löks
, 
˙é
->
ioba£
 + 
USBFLBASEADD
);

219 
	`outw
(0, 
˙é
->
ioba£
 + 
USBFRNUM
);

222 
	`outw
(
USBCMD_RS
 | 
USBCMD_CF
 | 
USBCMD_MAXP
, 
˙é
->
ioba£
 + 
USBCMD
);

225 
cou¡
 = 
	`check_uhci_p‹ts
(
˙é
);

226 
	`uhci_‰ì_pùes
(
˙é
);

227 i‡(
cou¡
)

232 
	`outw
(0, 
˙é
->
ioba£
 + 
USBCMD
);

233 
Áû
:

234 
	`‰ì
(
ãrm_td
);

235 
	`‰ì
(
Ê
);

236 
	`‰ì
(
öå_pùe
);

237 
	`‰ì
(
ãrm_pùe
);

238 
	`‰ì
(
˙é
);

239 
	}
}

242 
	$uhci_c⁄åﬁÀr_£tup
(
pci_devi˚
 *
pci
)

244 
u16
 
bdf
 = 
pci
->bdf;

245 
usb_uhci_s
 *
˙é
 = 
	`mÆloc_tmphigh
((*cntl));

246 i‡(!
˙é
) {

247 
	`w¨n_nﬂŒoc
();

250 
	`waô_¥ìm±
();

251 
	`mem£t
(
˙é
, 0, (*cntl));

252 
˙é
->
usb
.
pci
 =Öci;

253 
˙é
->
usb
.
ty≥
 = 
USB_TYPE_UHCI
;

254 
˙é
->
ioba£
 = (
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_4
)

255 & 
PCI_BASE_ADDRESS_IO_MASK
);

257 
	`d¥ötf
(1, "UHCI init on dev %02x:%02x.%x (io=%x)\n"

258 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf)

259 , 
	`pci_bdf_to_‚
(
bdf
), 
˙é
->
ioba£
);

261 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

263 
	`ª£t_uhci
(
˙é
, 
bdf
);

265 
	`run_thªad
(
c⁄figuª_uhci
, 
˙é
);

266 
	}
}

269 
	$uhci_£tup
()

271 i‡(! 
CONFIG_USB_UHCI
)

273 
pci_devi˚
 *
pci
;

274 
	`f‹óchpci
(
pci
) {

275 i‡(
	`pci_˛as•rog
(
pci
Ë=
PCI_CLASS_SERIAL_USB_UHCI
)

276 
	`uhci_c⁄åﬁÀr_£tup
(
pci
);

278 
	}
}

285 
usb_pùe
 *

286 
	$uhci_Æloc_öå_pùe
(
usbdevi˚_s
 *
usbdev


287 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

289 
usb_uhci_s
 *
˙é
 = 
	`c⁄èöî_of
(

290 
usbdev
->
hub
->
˙é
, 
usb_uhci_s
, 
usb
);

291 
‰amìxp
 = 
	`usb_gëFømeExp
(
usbdev
, 
ïdesc
);

292 
	`d¥ötf
(7, "uhci_Æloc_öå_pùê%∞%d\n", &
˙é
->
usb
, 
‰amìxp
);

294 i‡(
‰amìxp
 > 10)

295 
‰amìxp
 = 10;

296 
max∑ckë
 = 
ïdesc
->
wMaxPackëSize
;

298 
ms
 = 1<<
‰amìxp
;

299 
cou¡
 = 
	`DIV_ROUND_UP
(
	`ticks_to_ms
(2), 
ms
);

300 
cou¡
 = 
	`ALIGN
(count, 2);

301 
uhci_pùe
 *
pùe
 = 
	`mÆloc_low
((*pipe));

302 
uhci_td
 *
tds
 = 
	`mÆloc_low
((*tdsË* 
cou¡
);

303 *
d©a
 = 
	`mÆloc_low
(
max∑ckë
 * 
cou¡
);

304 i‡(!
pùe
 || !
tds
 || !
d©a
) {

305 
	`w¨n_nﬂŒoc
();

306 
Áû
;

308 
	`mem£t
(
pùe
, 0, (*pipe));

309 
	`usb_desc2pùe
(&
pùe
->pùe, 
usbdev
, 
ïdesc
);

310 
low•ìd
 = 
pùe
->pùe.
•ìd
;

311 
devaddr
 = 
pùe
->pùe.devadd∏| (pùe->pùe.
ï
 << 7);

312 
pùe
->
qh
.
ñemít
 = (
u32
)
tds
;

313 
pùe
->
√xt_td
 = &
tds
[0];

314 
pùe
->
ioba£
 = 
˙é
->iobase;

316 
toggÀ
 = 0;

317 
i
;

318 
i
=0; i<
cou¡
; i++) {

319 
tds
[
i
].
lök
 = (i==
cou¡
-1 ? (
u32
)&tds[0] : (u32)&tds[i+1]);

320 
tds
[
i
].
°©us
 = (
	`uhci_maxîr
(3Ë| (
low•ìd
 ? 
TD_CTRL_LS
 : 0)

321 | 
TD_CTRL_ACTIVE
);

322 
tds
[
i
].
tokí
 = (
	`uhci_ex∂í
(
max∑ckë
Ë| 
toggÀ


323 | (
devaddr
 << 
TD_TOKEN_DEVADDR_SHIFT
)

324 | 
USB_PID_IN
);

325 
tds
[
i
].
buf„r
 = 
d©a
 + 
max∑ckë
 * i;

326 
toggÀ
 ^
TD_TOKEN_TOGGLE
;

330 
uhci_‰amñi°
 *
Ê
 = 
˙é
->
‰amñi°
;

331 i‡(
‰amìxp
 == 0) {

333 
uhci_qh
 *
öå_qh
 = (*)(
Ê
->
löks
[0] & ~
UHCI_PTR_BITS
);

334 
pùe
->
qh
.
lök
 = 
öå_qh
->link;

335 
	`b¨rõr
();

336 
öå_qh
->
lök
 = (
u32
)&
pùe
->
qh
 | 
UHCI_PTR_QH
;

337 i‡(
˙é
->
c⁄åﬁ_qh
 =
öå_qh
)

338 
˙é
->
c⁄åﬁ_qh
 = &
pùe
->
qh
;

340 
°¨ços
 = 1<<(
‰amìxp
-1);

341 
pùe
->
qh
.
lök
 = 
Ê
->
löks
[
°¨ços
];

342 
	`b¨rõr
();

343 
i
=
°¨ços
; i<
	`ARRAY_SIZE
(
Ê
->
löks
); i+=
ms
)

344 
Ê
->
löks
[
i
] = (
u32
)&
pùe
->
qh
 | 
UHCI_PTR_QH
;

347  &
pùe
->pipe;

348 
Áû
:

349 
	`‰ì
(
pùe
);

350 
	`‰ì
(
tds
);

351 
	`‰ì
(
d©a
);

352  
NULL
;

353 
	}
}

355 
usb_pùe
 *

356 
	$uhci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


357 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

359 i‡(! 
CONFIG_USB_UHCI
)

360  
NULL
;

361 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

362 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

363  
	`uhci_Æloc_öå_pùe
(
usbdev
, 
ïdesc
);

364 
usb_uhci_s
 *
˙é
 = 
	`c⁄èöî_of
(

365 
usbdev
->
hub
->
˙é
, 
usb_uhci_s
, 
usb
);

366 
	`d¥ötf
(7, "uhci_Æloc_async_pùê%∞%d\n", &
˙é
->
usb
, 
ïty≥
);

368 
usb_pùe
 *
usbpùe
 = 
	`usb_gëFªePùe
(&
˙é
->
usb
, 
ïty≥
);

369 i‡(
usbpùe
) {

371 
	`usb_desc2pùe
(
usbpùe
, 
usbdev
, 
ïdesc
);

372  
usbpùe
;

376 
uhci_pùe
 *
pùe
;

377 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

378 
pùe
 = 
	`mÆloc_tmphigh
((*pipe));

380 
pùe
 = 
	`mÆloc_low
((*pipe));

381 i‡(!
pùe
) {

382 
	`w¨n_nﬂŒoc
();

383  
NULL
;

385 
	`mem£t
(
pùe
, 0, (*pipe));

386 
	`usb_desc2pùe
(&
pùe
->pùe, 
usbdev
, 
ïdesc
);

387 
pùe
->
qh
.
ñemít
 = 
UHCI_PTR_TERM
;

388 
pùe
->
ioba£
 = 
˙é
->iobase;

391 
uhci_qh
 *
c⁄åﬁ_qh
 = 
˙é
->control_qh;

392 
pùe
->
qh
.
lök
 = 
c⁄åﬁ_qh
->link;

393 
	`b¨rõr
();

394 
c⁄åﬁ_qh
->
lök
 = (
u32
)&
pùe
->
qh
 | 
UHCI_PTR_QH
;

395 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

396 
˙é
->
c⁄åﬁ_qh
 = &
pùe
->
qh
;

397  &
pùe
->pipe;

398 
	}
}

401 
	$waô_pùe
(
uhci_pùe
 *
pùe
, 
timeout
)

403 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

405 
u32
 
ñ_lök
 = 
	`GET_LOWFLAT
(
pùe
->
qh
.
ñemít
);

406 i‡(
ñ_lök
 & 
UHCI_PTR_TERM
)

408 i‡(
	`timî_check
(
íd
)) {

409 
	`w¨n_timeout
();

410 
u16
 
ioba£
 = 
	`GET_LOWFLAT
(
pùe
->iobase);

411 
uhci_td
 *
td
 = (*)(
ñ_lök
 & ~
UHCI_PTR_BITS
);

412 
	`d¥ötf
(1, "Timeout on wait_pipe %p (td=%p s=%x c=%x/%x)\n"

413 , 
pùe
, (*)
ñ_lök
, 
	`GET_LOWFLAT
(
td
->
°©us
)

414 , 
	`öw
(
ioba£
 + 
USBCMD
)

415 , 
	`öw
(
ioba£
 + 
USBSTS
));

416 
	`SET_LOWFLAT
(
pùe
->
qh
.
ñemít
, 
UHCI_PTR_TERM
);

417 
	`uhci_waôtick
(
ioba£
);

420 
	`yõld
();

422 
	}
}

425 
	$waô_td
(
uhci_td
 *
td
)

427 
u32
 
íd
 = 
	`timî_ˇlc
(5000);

428 
u32
 
°©us
;

430 
°©us
 = 
td
->status;

431 i‡(!(
°©us
 & 
TD_CTRL_ACTIVE
))

433 i‡(
	`timî_check
(
íd
)) {

434 
	`w¨n_timeout
();

437 
	`yõld
();

439 i‡(
°©us
 & 
TD_CTRL_ANY_ERROR
) {

440 
	`d¥ötf
(1, "waô_tdÉº‹ - sètus=%x\n", 
°©us
);

444 
	}
}

447 
	$uhci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


448 , *
d©a
, 
d©asize
)

450 
	`ASSERT32FLAT
();

451 i‡(! 
CONFIG_USB_UHCI
)

453 
	`d¥ötf
(5, "uhci_c⁄åﬁ %p\n", 
p
);

454 
uhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, uhci_pipe,Öipe);

456 
max∑ckë
 = 
pùe
->pipe.maxpacket;

457 
low•ìd
 = 
pùe
->pùe.
•ìd
;

458 
devaddr
 = 
pùe
->pùe.devadd∏| (pùe->pùe.
ï
 << 7);

461 
cou¡
 = 2 + 
	`DIV_ROUND_UP
(
d©asize
, 
max∑ckë
);

462 
uhci_td
 *
tds
 = 
	`mÆloc_tmphigh
((*tdsË* 
cou¡
);

463 i‡(!
tds
) {

464 
	`w¨n_nﬂŒoc
();

468 
tds
[0].
lök
 = (
u32
)&tds[1] | 
UHCI_PTR_DEPTH
;

469 
tds
[0].
°©us
 = (
	`uhci_maxîr
(3Ë| (
low•ìd
 ? 
TD_CTRL_LS
 : 0)

470 | 
TD_CTRL_ACTIVE
);

471 
tds
[0].
tokí
 = (
	`uhci_ex∂í
(
cmdsize
Ë| (
devaddr
 << 
TD_TOKEN_DEVADDR_SHIFT
)

472 | 
USB_PID_SETUP
);

473 
tds
[0].
buf„r
 = (*)
cmd
;

474 
toggÀ
 = 
TD_TOKEN_TOGGLE
;

475 
i
;

476 
i
=1; i<
cou¡
-1; i++) {

477 
tds
[
i
].
lök
 = (
u32
)&tds[i+1] | 
UHCI_PTR_DEPTH
;

478 
tds
[
i
].
°©us
 = (
	`uhci_maxîr
(3Ë| (
low•ìd
 ? 
TD_CTRL_LS
 : 0)

479 | 
TD_CTRL_ACTIVE
);

480 
Àn
 = (
i
 =
cou¡
-2 ? (
d©asize
 - (i-1)*
max∑ckë
) : maxpacket);

481 
tds
[
i
].
tokí
 = (
	`uhci_ex∂í
(
Àn
Ë| 
toggÀ


482 | (
devaddr
 << 
TD_TOKEN_DEVADDR_SHIFT
)

483 | (
dú
 ? 
USB_PID_IN
 : 
USB_PID_OUT
));

484 
tds
[
i
].
buf„r
 = 
d©a
 + (i-1Ë* 
max∑ckë
;

485 
toggÀ
 ^
TD_TOKEN_TOGGLE
;

487 
tds
[
i
].
lök
 = 
UHCI_PTR_TERM
;

488 
tds
[
i
].
°©us
 = (
	`uhci_maxîr
(0Ë| (
low•ìd
 ? 
TD_CTRL_LS
 : 0)

489 | 
TD_CTRL_ACTIVE
);

490 
tds
[
i
].
tokí
 = (
	`uhci_ex∂í
(0Ë| 
TD_TOKEN_TOGGLE


491 | (
devaddr
 << 
TD_TOKEN_DEVADDR_SHIFT
)

492 | (
dú
 ? 
USB_PID_OUT
 : 
USB_PID_IN
));

493 
tds
[
i
].
buf„r
 = 0;

496 
	`b¨rõr
();

497 
pùe
->
qh
.
ñemít
 = (
u32
)&
tds
[0];

498 
ªt
 = 
	`waô_pùe
(
pùe
, 500);

499 
	`‰ì
(
tds
);

500  
ªt
;

501 
	}
}

503 
	#STACKTDS
 4

	)

504 
	#TDALIGN
 16

	)

507 
	$uhci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
)

509 i‡(! 
CONFIG_USB_UHCI
)

511 
uhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, uhci_pipe,Öipe);

512 
	`d¥ötf
(7, "uhci_send_bulk qh=%p dir=%d data=%p size=%d\n"

513 , &
pùe
->
qh
, 
dú
, 
d©a
, 
d©asize
);

514 
max∑ckë
 = 
	`GET_LOWFLAT
(
pùe
->pipe.maxpacket);

515 
low•ìd
 = 
	`GET_LOWFLAT
(
pùe
->pùe.
•ìd
);

516 
devaddr
 = (
	`GET_LOWFLAT
(
pùe
->pipe.devaddr)

517 | (
	`GET_LOWFLAT
(
pùe
->pùe.
ï
) << 7));

518 
toggÀ
 = 
	`GET_LOWFLAT
(
pùe
->toggÀË? 
TD_TOKEN_TOGGLE
 : 0;

521 
u8
 
tdsbuf
[(
uhci_td
Ë* 
STACKTDS
 + 
TDALIGN
 - 1];

522 
uhci_td
 *
tds
 = (*)
	`ALIGN
((
u32
)
tdsbuf
, 
TDALIGN
);

523 
	`mem£t
(
tds
, 0, (*tdsË* 
STACKTDS
);

526 
	`b¨rõr
();

527 
	`SET_LOWFLAT
(
pùe
->
qh
.
ñemít
, (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
tds
));

529 
tdpos
 = 0;

530 
d©asize
) {

531 
uhci_td
 *
td
 = &
tds
[
tdpos
++ % 
STACKTDS
];

532 
ªt
 = 
	`waô_td
(
td
);

533 i‡(
ªt
)

534 
Áû
;

536 
å™s„r
 = 
d©asize
;

537 i‡(
å™s„r
 > 
max∑ckë
)

538 
å™s„r
 = 
max∑ckë
;

539 
uhci_td
 *
√xâd_Ê
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
)

540 , &
tds
[
tdpos
 % 
STACKTDS
]);

541 
td
->
lök
 = (
å™s„r
==
d©asize
 ? 
UHCI_PTR_TERM
 : (
u32
)
√xâd_Ê
);

542 
td
->
tokí
 = (
	`uhci_ex∂í
(
å™s„r
Ë| 
toggÀ


543 | (
devaddr
 << 
TD_TOKEN_DEVADDR_SHIFT
)

544 | (
dú
 ? 
USB_PID_IN
 : 
USB_PID_OUT
));

545 
td
->
buf„r
 = 
d©a
;

546 
	`b¨rõr
();

547 
td
->
°©us
 = (
	`uhci_maxîr
(3Ë| (
low•ìd
 ? 
TD_CTRL_LS
 : 0)

548 | 
TD_CTRL_ACTIVE
);

549 
toggÀ
 ^
TD_TOKEN_TOGGLE
;

551 
d©a
 +
å™s„r
;

552 
d©asize
 -
å™s„r
;

554 
	`SET_LOWFLAT
(
pùe
->
toggÀ
, !!toggle);

555  
	`waô_pùe
(
pùe
, 5000);

556 
Áû
:

557 
	`d¥ötf
(1, "uhci_send_bulk failed\n");

558 
	`SET_LOWFLAT
(
pùe
->
qh
.
ñemít
, 
UHCI_PTR_TERM
);

559 
	`uhci_waôtick
(
	`GET_LOWFLAT
(
pùe
->
ioba£
));

561 
	}
}

564 
	$uhci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
)

566 
	`ASSERT16
();

567 i‡(! 
CONFIG_USB_UHCI
)

570 
uhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, uhci_pipe,Öipe);

571 
uhci_td
 *
td
 = 
	`GET_LOWFLAT
(
pùe
->
√xt_td
);

572 
u32
 
°©us
 = 
	`GET_LOWFLAT
(
td
->status);

573 
u32
 
tokí
 = 
	`GET_LOWFLAT
(
td
->token);

574 i‡(
°©us
 & 
TD_CTRL_ACTIVE
)

580 *
tdd©a
 = 
	`GET_LOWFLAT
(
td
->
buf„r
);

581 
	`mem˝y_Ár
(
	`GET_SEG
(
SS
), 
d©a
, 
SEG_LOW
, 
	`LOWFLAT2LOW
(
tdd©a
)

582 , 
	`uhci_ex≥˘ed_Àngth
(
tokí
));

585 
uhci_td
 *
√xt
 = (*)(
	`GET_LOWFLAT
(
td
->
lök
Ë& ~
UHCI_PTR_BITS
);

586 
	`SET_LOWFLAT
(
pùe
->
√xt_td
, 
√xt
);

587 
	`b¨rõr
();

588 
	`SET_LOWFLAT
(
td
->
°©us
, (
	`uhci_maxîr
(0Ë| (°©u†& 
TD_CTRL_LS
)

589 | 
TD_CTRL_ACTIVE
));

592 
	}
}

	@hw/usb-uhci.h

1 #i‚de‡
__USB_UHCI_H


2 
	#__USB_UHCI_H


	)

5 
uhci_£tup
();

6 
	gusbdevi˚_s
;

7 
	gusb_ídpoöt_des¸ùt‹
;

8 
usb_pùe
 *
uhci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


9 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

10 
	gusb_pùe
;

11 
uhci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


12 , *
d©a
, 
d©asize
);

13 
uhci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
);

14 
uhci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
);

22 
	#USBPORTSC1
 16

	)

23 
	#USBPORTSC2
 18

	)

24 
	#USBPORTSC_CCS
 0x0001

	)

26 
	#USBPORTSC_CSC
 0x0002

	)

27 
	#USBPORTSC_PE
 0x0004

	)

28 
	#USBPORTSC_PEC
 0x0008

	)

29 
	#USBPORTSC_DPLUS
 0x0010

	)

30 
	#USBPORTSC_DMINUS
 0x0020

	)

31 
	#USBPORTSC_RD
 0x0040

	)

32 
	#USBPORTSC_RES1
 0x0080

	)

33 
	#USBPORTSC_LSDA
 0x0100

	)

34 
	#USBPORTSC_PR
 0x0200

	)

37 
	#USBLEGSUP
 0xc0

	)

38 
	#USBLEGSUP_RWC
 0x8f00

	)

41 
	#USBCMD
 0

	)

42 
	#USBCMD_RS
 0x0001

	)

43 
	#USBCMD_HCRESET
 0x0002

	)

44 
	#USBCMD_GRESET
 0x0004

	)

45 
	#USBCMD_EGSM
 0x0008

	)

46 
	#USBCMD_FGR
 0x0010

	)

47 
	#USBCMD_SWDBG
 0x0020

	)

48 
	#USBCMD_CF
 0x0040

	)

49 
	#USBCMD_MAXP
 0x0080

	)

52 
	#USBSTS
 2

	)

53 
	#USBSTS_USBINT
 0x0001

	)

54 
	#USBSTS_ERROR
 0x0002

	)

55 
	#USBSTS_RD
 0x0004

	)

56 
	#USBSTS_HSE
 0x0008

	)

57 
	#USBSTS_HCPE
 0x0010

	)

59 
	#USBSTS_HCH
 0x0020

	)

62 
	#USBINTR
 4

	)

63 
	#USBINTR_TIMEOUT
 0x0001

	)

64 
	#USBINTR_RESUME
 0x0002

	)

65 
	#USBINTR_IOC
 0x0004

	)

66 
	#USBINTR_SP
 0x0008

	)

68 
	#USBFRNUM
 6

	)

69 
	#USBFLBASEADD
 8

	)

70 
	#USBSOF
 12

	)

71 
	#USBSOF_DEFAULT
 64

	)

73 
	suhci_‰amñi°
 {

74 
u32
 
	mlöks
[1024];

75 } 
	gPACKED
;

77 
	#TD_CTRL_SPD
 (1 << 29Ë

	)

78 
	#TD_CTRL_C_ERR_MASK
 (3 << 27Ë

	)

79 
	#TD_CTRL_C_ERR_SHIFT
 27

	)

80 
	#TD_CTRL_LS
 (1 << 26Ë

	)

81 
	#TD_CTRL_IOS
 (1 << 25Ë

	)

82 
	#TD_CTRL_IOC
 (1 << 24Ë

	)

83 
	#TD_CTRL_ACTIVE
 (1 << 23Ë

	)

84 
	#TD_CTRL_STALLED
 (1 << 22Ë

	)

85 
	#TD_CTRL_DBUFERR
 (1 << 21Ë

	)

86 
	#TD_CTRL_BABBLE
 (1 << 20Ë

	)

87 
	#TD_CTRL_NAK
 (1 << 19Ë

	)

88 
	#TD_CTRL_CRCTIMEO
 (1 << 18Ë

	)

89 
	#TD_CTRL_BITSTUFF
 (1 << 17Ë

	)

90 
	#TD_CTRL_ACTLEN_MASK
 0x7FF

	)

92 
	#TD_CTRL_ANY_ERROR
 (
TD_CTRL_STALLED
 | 
TD_CTRL_DBUFERR
 | \

93 
TD_CTRL_BABBLE
 | 
TD_CTRL_CRCTIMEO
 | \

94 
TD_CTRL_BITSTUFF
)

	)

95 
	#uhci_maxîr
(
îr
Ë(”ºË<< 
TD_CTRL_C_ERR_SHIFT
)

	)

97 
	#TD_TOKEN_DEVADDR_SHIFT
 8

	)

98 
	#TD_TOKEN_TOGGLE_SHIFT
 19

	)

99 
	#TD_TOKEN_TOGGLE
 (1 << 19)

	)

100 
	#TD_TOKEN_EXPLEN_SHIFT
 21

	)

101 
	#TD_TOKEN_EXPLEN_MASK
 0x7FF

	)

102 
	#TD_TOKEN_PID_MASK
 0xFF

	)

104 
	#uhci_ex∂í
(
Àn
Ë(((÷íË- 1Ë& 
TD_TOKEN_EXPLEN_MASK
) << \

105 
TD_TOKEN_EXPLEN_SHIFT
)

	)

107 
	#uhci_ex≥˘ed_Àngth
(
tokí
Ë(((—okíË>> 
TD_TOKEN_EXPLEN_SHIFT
) + \

108 1Ë& 
TD_TOKEN_EXPLEN_MASK
)

	)

110 
	suhci_td
 {

111 
u32
 
	mlök
;

112 
u32
 
	m°©us
;

113 
u32
 
	mtokí
;

114 *
	mbuf„r
;

115 } 
	gPACKED
;

117 
	suhci_qh
 {

118 
u32
 
	mlök
;

119 
u32
 
	mñemít
;

120 } 
	gPACKED
;

122 
	#UHCI_PTR_BITS
 0x000F

	)

123 
	#UHCI_PTR_TERM
 0x0001

	)

124 
	#UHCI_PTR_QH
 0x0002

	)

125 
	#UHCI_PTR_DEPTH
 0x0004

	)

126 
	#UHCI_PTR_BREADTH
 0x0000

	)

	@hw/usb-xhci.c

8 
	~"biosv¨.h
"

9 
	~"c⁄fig.h
"

10 
	~"mÆloc.h
"

11 
	~"memm≠.h
"

12 
	~"ouçut.h
"

13 
	~"pci.h
"

14 
	~"pci_ids.h
"

15 
	~"pci_ªgs.h
"

16 
	~"°rög.h
"

17 
	~"usb.h
"

18 
	~"usb-xhci.h
"

19 
	~"utû.h
"

20 
	~"x86.h
"

25 
	#XHCI_RING_ITEMS
 16

	)

26 
	#XHCI_RING_SIZE
 (
XHCI_RING_ITEMS
*(
xhci_åb
))

	)

32 
	#XHCI_RING
(
_åb
) \

33 ((
xhci_rög
*)((
u32
)(
_åb
Ë& ~(
XHCI_RING_SIZE
-1)))

	)

38 
	#XHCI_CMD_RS
 (1<<0)

	)

39 
	#XHCI_CMD_HCRST
 (1<<1)

	)

40 
	#XHCI_CMD_INTE
 (1<<2)

	)

41 
	#XHCI_CMD_HSEE
 (1<<3)

	)

42 
	#XHCI_CMD_LHCRST
 (1<<7)

	)

43 
	#XHCI_CMD_CSS
 (1<<8)

	)

44 
	#XHCI_CMD_CRS
 (1<<9)

	)

45 
	#XHCI_CMD_EWE
 (1<<10)

	)

46 
	#XHCI_CMD_EU3S
 (1<<11)

	)

48 
	#XHCI_STS_HCH
 (1<<0)

	)

49 
	#XHCI_STS_HSE
 (1<<2)

	)

50 
	#XHCI_STS_EINT
 (1<<3)

	)

51 
	#XHCI_STS_PCD
 (1<<4)

	)

52 
	#XHCI_STS_SSS
 (1<<8)

	)

53 
	#XHCI_STS_RSS
 (1<<9)

	)

54 
	#XHCI_STS_SRE
 (1<<10)

	)

55 
	#XHCI_STS_CNR
 (1<<11)

	)

56 
	#XHCI_STS_HCE
 (1<<12)

	)

58 
	#XHCI_PORTSC_CCS
 (1<<0)

	)

59 
	#XHCI_PORTSC_PED
 (1<<1)

	)

60 
	#XHCI_PORTSC_OCA
 (1<<3)

	)

61 
	#XHCI_PORTSC_PR
 (1<<4)

	)

62 
	#XHCI_PORTSC_PLS_SHIFT
 5

	)

63 
	#XHCI_PORTSC_PLS_MASK
 0xf

	)

64 
	#XHCI_PORTSC_PP
 (1<<9)

	)

65 
	#XHCI_PORTSC_SPEED_SHIFT
 10

	)

66 
	#XHCI_PORTSC_SPEED_MASK
 0xf

	)

67 
	#XHCI_PORTSC_SPEED_FULL
 (1<<10)

	)

68 
	#XHCI_PORTSC_SPEED_LOW
 (2<<10)

	)

69 
	#XHCI_PORTSC_SPEED_HIGH
 (3<<10)

	)

70 
	#XHCI_PORTSC_SPEED_SUPER
 (4<<10)

	)

71 
	#XHCI_PORTSC_PIC_SHIFT
 14

	)

72 
	#XHCI_PORTSC_PIC_MASK
 0x3

	)

73 
	#XHCI_PORTSC_LWS
 (1<<16)

	)

74 
	#XHCI_PORTSC_CSC
 (1<<17)

	)

75 
	#XHCI_PORTSC_PEC
 (1<<18)

	)

76 
	#XHCI_PORTSC_WRC
 (1<<19)

	)

77 
	#XHCI_PORTSC_OCC
 (1<<20)

	)

78 
	#XHCI_PORTSC_PRC
 (1<<21)

	)

79 
	#XHCI_PORTSC_PLC
 (1<<22)

	)

80 
	#XHCI_PORTSC_CEC
 (1<<23)

	)

81 
	#XHCI_PORTSC_CAS
 (1<<24)

	)

82 
	#XHCI_PORTSC_WCE
 (1<<25)

	)

83 
	#XHCI_PORTSC_WDE
 (1<<26)

	)

84 
	#XHCI_PORTSC_WOE
 (1<<27)

	)

85 
	#XHCI_PORTSC_DR
 (1<<30)

	)

86 
	#XHCI_PORTSC_WPR
 (1<<31)

	)

88 
	#TRB_C
 (1<<0)

	)

89 
	#TRB_TYPE_SHIFT
 10

	)

90 
	#TRB_TYPE_MASK
 0x3f

	)

91 
	#TRB_TYPE
(
t
Ë((—Ë>> 
TRB_TYPE_SHIFT
Ë& 
TRB_TYPE_MASK
)

	)

93 
	#TRB_EV_ED
 (1<<2)

	)

95 
	#TRB_TR_ENT
 (1<<1)

	)

96 
	#TRB_TR_ISP
 (1<<2)

	)

97 
	#TRB_TR_NS
 (1<<3)

	)

98 
	#TRB_TR_CH
 (1<<4)

	)

99 
	#TRB_TR_IOC
 (1<<5)

	)

100 
	#TRB_TR_IDT
 (1<<6)

	)

101 
	#TRB_TR_TBC_SHIFT
 7

	)

102 
	#TRB_TR_TBC_MASK
 0x3

	)

103 
	#TRB_TR_BEI
 (1<<9)

	)

104 
	#TRB_TR_TLBPC_SHIFT
 16

	)

105 
	#TRB_TR_TLBPC_MASK
 0xf

	)

106 
	#TRB_TR_FRAMEID_SHIFT
 20

	)

107 
	#TRB_TR_FRAMEID_MASK
 0x7ff

	)

108 
	#TRB_TR_SIA
 (1<<31)

	)

110 
	#TRB_TR_DIR
 (1<<16)

	)

112 
	#TRB_CR_SLOTID_SHIFT
 24

	)

113 
	#TRB_CR_SLOTID_MASK
 0xff

	)

114 
	#TRB_CR_EPID_SHIFT
 16

	)

115 
	#TRB_CR_EPID_MASK
 0x1f

	)

117 
	#TRB_CR_BSR
 (1<<9)

	)

118 
	#TRB_CR_DC
 (1<<9)

	)

120 
	#TRB_LK_TC
 (1<<1)

	)

122 
	#TRB_INTR_SHIFT
 22

	)

123 
	#TRB_INTR_MASK
 0x3ff

	)

124 
	#TRB_INTR
(
t
Ë((—).
°©us
 >> 
TRB_INTR_SHIFT
Ë& 
TRB_INTR_MASK
)

	)

126 
	eTRBTy≥
 {

127 
	mTRB_RESERVED
 = 0,

128 
	mTR_NORMAL
,

129 
	mTR_SETUP
,

130 
	mTR_DATA
,

131 
	mTR_STATUS
,

132 
	mTR_ISOCH
,

133 
	mTR_LINK
,

134 
	mTR_EVDATA
,

135 
	mTR_NOOP
,

136 
	mCR_ENABLE_SLOT
,

137 
	mCR_DISABLE_SLOT
,

138 
	mCR_ADDRESS_DEVICE
,

139 
	mCR_CONFIGURE_ENDPOINT
,

140 
	mCR_EVALUATE_CONTEXT
,

141 
	mCR_RESET_ENDPOINT
,

142 
	mCR_STOP_ENDPOINT
,

143 
	mCR_SET_TR_DEQUEUE
,

144 
	mCR_RESET_DEVICE
,

145 
	mCR_FORCE_EVENT
,

146 
	mCR_NEGOTIATE_BW
,

147 
	mCR_SET_LATENCY_TOLERANCE
,

148 
	mCR_GET_PORT_BANDWIDTH
,

149 
	mCR_FORCE_HEADER
,

150 
	mCR_NOOP
,

151 
	mER_TRANSFER
 = 32,

152 
	mER_COMMAND_COMPLETE
,

153 
	mER_PORT_STATUS_CHANGE
,

154 
	mER_BANDWIDTH_REQUEST
,

155 
	mER_DOORBELL
,

156 
	mER_HOST_CONTROLLER
,

157 
	mER_DEVICE_NOTIFICATION
,

158 
	mER_MFINDEX_WRAP
,

159 } 
	tTRBTy≥
;

161 
	eTRBCCode
 {

162 
	mCC_INVALID
 = 0,

163 
	mCC_SUCCESS
,

164 
	mCC_DATA_BUFFER_ERROR
,

165 
	mCC_BABBLE_DETECTED
,

166 
	mCC_USB_TRANSACTION_ERROR
,

167 
	mCC_TRB_ERROR
,

168 
	mCC_STALL_ERROR
,

169 
	mCC_RESOURCE_ERROR
,

170 
	mCC_BANDWIDTH_ERROR
,

171 
	mCC_NO_SLOTS_ERROR
,

172 
	mCC_INVALID_STREAM_TYPE_ERROR
,

173 
	mCC_SLOT_NOT_ENABLED_ERROR
,

174 
	mCC_EP_NOT_ENABLED_ERROR
,

175 
	mCC_SHORT_PACKET
,

176 
	mCC_RING_UNDERRUN
,

177 
	mCC_RING_OVERRUN
,

178 
	mCC_VF_ER_FULL
,

179 
	mCC_PARAMETER_ERROR
,

180 
	mCC_BANDWIDTH_OVERRUN
,

181 
	mCC_CONTEXT_STATE_ERROR
,

182 
	mCC_NO_PING_RESPONSE_ERROR
,

183 
	mCC_EVENT_RING_FULL_ERROR
,

184 
	mCC_INCOMPATIBLE_DEVICE_ERROR
,

185 
	mCC_MISSED_SERVICE_ERROR
,

186 
	mCC_COMMAND_RING_STOPPED
,

187 
	mCC_COMMAND_ABORTED
,

188 
	mCC_STOPPED
,

189 
	mCC_STOPPED_LENGTH_INVALID
,

190 
	mCC_MAX_EXIT_LATENCY_TOO_LARGE_ERROR
 = 29,

191 
	mCC_ISOCH_BUFFER_OVERRUN
 = 31,

192 
	mCC_EVENT_LOST_ERROR
,

193 
	mCC_UNDEFINED_ERROR
,

194 
	mCC_INVALID_STREAM_ID_ERROR
,

195 
	mCC_SECONDARY_BANDWIDTH_ERROR
,

196 
	mCC_SPLIT_TRANSACTION_ERROR


197 } 
	tTRBCCode
;

200 
	mPLS_U0
 = 0,

201 
	mPLS_U1
 = 1,

202 
	mPLS_U2
 = 2,

203 
	mPLS_U3
 = 3,

204 
	mPLS_DISABLED
 = 4,

205 
	mPLS_RX_DETECT
 = 5,

206 
	mPLS_INACTIVE
 = 6,

207 
	mPLS_POLLING
 = 7,

208 
	mPLS_RECOVERY
 = 8,

209 
	mPLS_HOT_RESET
 = 9,

210 
	mPLS_COMPILANCE_MODE
 = 10,

211 
	mPLS_TEST_MODE
 = 11,

212 
	mPLS_RESUME
 = 15,

215 
	#xhci_gë_fõld
(
d©a
, 
fõld
) \

216 (((
d©a
Ë>> 
fõld
##
_SHIFT
Ë& fõld##
_MASK
)

	)

221 
	sxhci_rög
 {

222 
xhci_åb
 
	mrög
[
XHCI_RING_ITEMS
];

223 
xhci_åb
 
	mevt
;

224 
u32
 
	meidx
;

225 
u32
 
	mnidx
;

226 
u32
 
	mcs
;

227 
muãx_s
 
	mlock
;

230 
	susb_xhci_s
 {

231 
usb_s
 
	musb
;

232 
usbhub_s
 
	mhub
;

235 
u32
 
	mba£addr
;

236 
u32
 
	mxˇp
;

237 
u32
 
	mp‹ts
;

238 
u32
 
	m¶Ÿs
;

239 
u8
 
	mc⁄ãxt64
;

242 
xhci_ˇps
 *
	mˇps
;

243 
xhci_›
 *
	m›
;

244 
xhci_¥
 *
	m¥
;

245 
xhci_ú
 *
	mú
;

246 
xhci_db
 *
	mdb
;

249 
xhci_devli°
 *
	mdevs
;

250 
xhci_rög
 *
	mcmds
;

251 
xhci_rög
 *
	mevts
;

252 
xhci_î_£g
 *
	me£g
;

255 
	sxhci_pùe
 {

256 
xhci_rög
 
	mªqs
;

258 
usb_pùe
 
	mpùe
;

259 
u32
 
	m¶Ÿid
;

260 
u32
 
	mïid
;

261 *
	mbuf
;

262 
	mbufu£d
;

268 c⁄° *
	g•ìd_«me
[16] = {

276 c⁄° 
	g•ìd_‰om_xhci
[16] = {

278 [ 1 ] = 
USB_FULLSPEED
,

279 [ 2 ] = 
USB_LOWSPEED
,

280 [ 3 ] = 
USB_HIGHSPEED
,

281 [ 4 ] = 
USB_SUPERSPEED
,

285 c⁄° 
	g•ìd_to_xhci
[] = {

286 [ 
USB_FULLSPEED
 ] = 1,

287 [ 
USB_LOWSPEED
 ] = 2,

288 [ 
USB_HIGHSPEED
 ] = 3,

289 [ 
USB_SUPERSPEED
 ] = 4,

292 c⁄° 
	gïty≥_to_xhci_ö
[] = {

293 [ 
USB_ENDPOINT_XFER_CONTROL
] = 4,

294 [ 
USB_ENDPOINT_XFER_ISOC
 ] = 5,

295 [ 
USB_ENDPOINT_XFER_BULK
 ] = 6,

296 [ 
USB_ENDPOINT_XFER_INT
 ] = 7,

299 c⁄° 
	gïty≥_to_xhci_out
[] = {

300 [ 
USB_ENDPOINT_XFER_CONTROL
] = 4,

301 [ 
USB_ENDPOINT_XFER_ISOC
 ] = 1,

302 [ 
USB_ENDPOINT_XFER_BULK
 ] = 2,

303 [ 
USB_ENDPOINT_XFER_INT
 ] = 3,

309 
	$xhci_do‹bñl
(
usb_xhci_s
 *
xhci
, 
u32
 
¶Ÿid
, u32 
vÆue
)

311 
xhci_db
 *
db
 = 
	`GET_LOWFLAT
(
xhci
->db);

312 *
addr
 = &
db
[
¶Ÿid
].
do‹bñl
;

313 
	`wrôñ
(
addr
, 
vÆue
);

314 
	}
}

316 
	$xhci_¥o˚ss_evíts
(
usb_xhci_s
 *
xhci
)

318 
xhci_rög
 *
evts
 = 
	`GET_LOWFLAT
(
xhci
->evts);

322 
u32
 
nidx
 = 
	`GET_LOWFLAT
(
evts
->nidx);

323 
u32
 
cs
 = 
	`GET_LOWFLAT
(
evts
->cs);

324 
xhci_åb
 *
ërb
 = 
evts
->
rög
 + 
nidx
;

325 
u32
 
c⁄åﬁ
 = 
	`GET_LOWFLAT
(
ërb
->control);

326 i‡((
c⁄åﬁ
 & 
TRB_C
Ë!(
cs
 ? 1 : 0))

330 
u32
 
evt_ty≥
 = 
	`TRB_TYPE
(
c⁄åﬁ
);

331 
u32
 
evt_cc
 = (
	`GET_LOWFLAT
(
ërb
->
°©us
) >> 24) & 0xff;

332 
evt_ty≥
) {

333 
ER_TRANSFER
:

334 
ER_COMMAND_COMPLETE
:

336 
xhci_åb
 *
πrb
 = (*)
	`GET_LOWFLAT
(
ërb
->
±r_low
);

337 
xhci_rög
 *
rög
 = 
	`XHCI_RING
(
πrb
);

338 
xhci_åb
 *
evt
 = &
rög
->evt;

339 
u32
 
eidx
 = 
πrb
 - 
rög
->ring + 1;

340 
	`d¥ötf
(5, "%s:Ñing %p [trb %p,Évt %p,Åype %d,Éidx %d, cc %d]\n",

341 
__func__
, 
rög
, 
πrb
, 
evt
, 
evt_ty≥
, 
eidx
, 
evt_cc
);

342 
	`mem˝y_Ê
(
evt
, 
ërb
, (*etrb));

343 
	`SET_LOWFLAT
(
rög
->
eidx
,Éidx);

346 
ER_PORT_STATUS_CHANGE
:

348 
u32
 
p‹tid
 = (
	`GET_LOWFLAT
(
ërb
->
±r_low
) >> 24) & 0xff;

349 
	`d¥ötf
(3, "%s: status changeÖort #%d\n",

350 
__func__
, 
p‹tid
);

354 
	`d¥ötf
(1, "%s: unknownÉvent,Åype %d, cc %d\n",

355 
__func__
, 
evt_ty≥
, 
evt_cc
);

360 
nidx
++;

361 i‡(
nidx
 =
XHCI_RING_ITEMS
) {

362 
nidx
 = 0;

363 
cs
 = cs ? 0 : 1;

364 
	`SET_LOWFLAT
(
evts
->
cs
, cs);

366 
	`SET_LOWFLAT
(
evts
->
nidx
,Çidx);

367 
xhci_ú
 *
ú
 = 
	`GET_LOWFLAT
(
xhci
->ir);

368 
u32
 
îdp
 = (u32)(
evts
->
rög
 + 
nidx
);

369 
	`wrôñ
(&
ú
->
îdp_low
, 
îdp
);

370 
	`wrôñ
(&
ú
->
îdp_high
, 0);

372 
	}
}

374 
	$xhci_rög_busy
(
xhci_rög
 *
rög
)

376 
u32
 
eidx
 = 
	`GET_LOWFLAT
(
rög
->eidx);

377 
u32
 
nidx
 = 
	`GET_LOWFLAT
(
rög
->nidx);

378  (
eidx
 !
nidx
);

379 
	}
}

381 
	$xhci_evít_waô
(
usb_xhci_s
 *
xhci
,

382 
xhci_rög
 *
rög
,

383 
u32
 
timeout
)

385 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

388 
	`xhci_¥o˚ss_evíts
(
xhci
);

389 i‡(!
	`xhci_rög_busy
(
rög
)) {

390 
u32
 
°©us
 = 
	`GET_LOWFLAT
(
rög
->
evt
.status);

391  (
°©us
 >> 24) & 0xff;

393 i‡(
	`timî_check
(
íd
)) {

394 
	`w¨n_timeout
();

397 
	`yõld
();

399 
	}
}

401 
	$xhci_åb_queue
(
xhci_rög
 *
rög
,

402 
xhci_åb
 *
åb
)

404 
u32
 
nidx
 = 
	`GET_LOWFLAT
(
rög
->nidx);

405 
u32
 
cs
 = 
	`GET_LOWFLAT
(
rög
->cs);

406 
xhci_åb
 *
d°
;

407 
u32
 
c⁄åﬁ
;

409 i‡(
nidx
 =
XHCI_RING_ITEMS
-1) {

410 
d°
 = 
rög
->rög + 
nidx
;

411 
c⁄åﬁ
 = (
TR_LINK
 << 10);

412 
c⁄åﬁ
 |
TRB_LK_TC
;

413 
c⁄åﬁ
 |(
cs
 ? 
TRB_C
 : 0);

414 
	`SET_LOWFLAT
(
d°
->
±r_low
, (
u32
)&
rög
[0]);

415 
	`SET_LOWFLAT
(
d°
->
±r_high
, 0);

416 
	`SET_LOWFLAT
(
d°
->
°©us
, 0);

417 
	`SET_LOWFLAT
(
d°
->
c⁄åﬁ
, control);

418 
nidx
 = 0;

419 
cs
 = cs ? 0 : 1;

420 
	`SET_LOWFLAT
(
rög
->
nidx
,Çidx);

421 
	`SET_LOWFLAT
(
rög
->
cs
, cs);

423 
	`d¥ötf
(5, "%s:Ñög %∞[löked]\n", 
__func__
, 
rög
);

426 
d°
 = 
rög
->rög + 
nidx
;

427 
c⁄åﬁ
 = 
	`GET_LOWFLAT
(
åb
->c⁄åﬁË| (
cs
 ? 
TRB_C
 : 0);

429 
	`SET_LOWFLAT
(
d°
->
±r_low
, 
	`GET_LOWFLAT
(
åb
->ptr_low));

430 
	`SET_LOWFLAT
(
d°
->
±r_high
, 
	`GET_LOWFLAT
(
åb
->ptr_high));

431 
	`SET_LOWFLAT
(
d°
->
°©us
, 
	`GET_LOWFLAT
(
åb
->status));

432 
	`SET_LOWFLAT
(
d°
->
c⁄åﬁ
, control);

433 
nidx
++;

434 
	`SET_LOWFLAT
(
rög
->
nidx
,Çidx);

436 
	`d¥ötf
(5, "%s:Ñing %p [nidx %d,Üen %d]\n",

437 
__func__
, 
rög
, 
nidx
,

438 
	`GET_LOWFLAT
(
åb
->
°©us
) & 0xffff);

439 
	}
}

441 
	$xhci_x„r_queue
(
xhci_pùe
 *
pùe
,

442 
xhci_åb
 *
åb
)

444 
	`xhci_åb_queue
(&
pùe
->
ªqs
, 
åb
);

445 
	}
}

447 
	$xhci_x„r_kick
(
xhci_pùe
 *
pùe
)

449 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

450 
	`GET_LOWFLAT
(
pùe
->pùe.
˙é
), 
usb_xhci_s
, 
usb
);

451 
u32
 
¶Ÿid
 = 
	`GET_LOWFLAT
(
pùe
->slotid);

452 
u32
 
ïid
 = 
	`GET_LOWFLAT
(
pùe
->epid);

454 
	`d¥ötf
(5, "%s:Ñing %p, slotid %d,Épid %d\n",

455 
__func__
, &
pùe
->
ªqs
, 
¶Ÿid
, 
ïid
);

456 
	`xhci_do‹bñl
(
xhci
, 
¶Ÿid
, 
ïid
);

457 
	}
}

459 
	$xhci_x„r_n‹mÆ
(
xhci_pùe
 *
pùe
,

460 *
d©a
, 
d©Æí
)

462 
xhci_åb
 
åb
;

464 
	`mem£t
(&
åb
, 0, (trb));

465 
åb
.
±r_low
 = (
u32
)
d©a
;

466 
åb
.
°©us
 = 
d©Æí
;

467 
åb
.
c⁄åﬁ
 |(
TR_NORMAL
 << 10);

468 
åb
.
c⁄åﬁ
 |
TRB_TR_IOC
;

470 
	`xhci_x„r_queue
(
pùe
, 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
åb
));

471 
	`xhci_x„r_kick
(
pùe
);

472 
	}
}

477 
	$waô_bô
(
u32
 *
ªg
, u32 
mask
, 
vÆue
, u32 
timeout
)

479 
	`ASSERT32FLAT
();

480 
u32
 
íd
 = 
	`timî_ˇlc
(
timeout
);

482 (
	`ªadl
(
ªg
Ë& 
mask
Ë!
vÆue
) {

483 i‡(
	`timî_check
(
íd
)) {

484 
	`w¨n_timeout
();

487 
	`yõld
();

490 
	}
}

492 
	$xhci_cmd_submô
(
usb_xhci_s
 *
xhci
,

493 
xhci_åb
 *
cmd
)

495 
	`ASSERT32FLAT
();

496 
rc
;

498 
	`muãx_lock
(&
xhci
->
cmds
->
lock
);

499 
	`xhci_åb_queue
(
xhci
->
cmds
, 
cmd
);

500 
	`xhci_do‹bñl
(
xhci
, 0, 0);

501 
rc
 = 
	`xhci_evít_waô
(
xhci
, xhci->
cmds
, 1000);

502 
	`muãx_u∆ock
(&
xhci
->
cmds
->
lock
);

503  
rc
;

504 
	}
}

506 
	$xhci_cmd_íabÀ_¶Ÿ
(
usb_xhci_s
 *
xhci
)

508 
	`ASSERT32FLAT
();

509 
xhci_åb
 
cmd
 = {

510 .
±r_low
 = 0,

511 .
±r_high
 = 0,

512 .
°©us
 = 0,

513 .
c⁄åﬁ
 = (
CR_ENABLE_SLOT
 << 10)

515 
	`d¥ötf
(3, "%s:\n", 
__func__
);

516 
cc
 = 
	`xhci_cmd_submô
(
xhci
, &
cmd
);

517 i‡(
cc
 !
CC_SUCCESS
)

519  (
xhci
->
cmds
->
evt
.
c⁄åﬁ
 >> 24) & 0xff;

520 
	}
}

523 
	$xhci_cmd_dißbÀ_¶Ÿ
(
usb_xhci_s
 *
xhci
, 
u32
 
¶Ÿid
)

525 
	`ASSERT32FLAT
();

526 
xhci_åb
 
cmd
 = {

527 .
±r_low
 = 0,

528 .
±r_high
 = 0,

529 .
°©us
 = 0,

530 .
c⁄åﬁ
 = (
¶Ÿid
 << 24Ë| (
CR_DISABLE_SLOT
 << 10)

532 
	`d¥ötf
(3, "%s: slŸid %d\n", 
__func__
, 
¶Ÿid
);

533  
	`xhci_cmd_submô
(
xhci
, &
cmd
);

534 
	}
}

537 
	$xhci_cmd_addªss_devi˚
(
usb_xhci_s
 *
xhci
, 
u32
 
¶Ÿid


538 , 
xhci_ö˘x
 *
ö˘x
)

540 
	`ASSERT32FLAT
();

541 
xhci_åb
 
cmd
 = {

542 .
±r_low
 = (
u32
)
ö˘x
,

543 .
±r_high
 = 0,

544 .
°©us
 = 0,

545 .
c⁄åﬁ
 = (
¶Ÿid
 << 24Ë| (
CR_ADDRESS_DEVICE
 << 10)

547 
	`d¥ötf
(3, "%s: slŸid %d\n", 
__func__
, 
¶Ÿid
);

548  
	`xhci_cmd_submô
(
xhci
, &
cmd
);

549 
	}
}

551 
	$xhci_cmd_c⁄figuª_ídpoöt
(
usb_xhci_s
 *
xhci
, 
u32
 
¶Ÿid


552 , 
xhci_ö˘x
 *
ö˘x
)

554 
	`ASSERT32FLAT
();

555 
xhci_åb
 
cmd
 = {

556 .
±r_low
 = (
u32
)
ö˘x
,

557 .
±r_high
 = 0,

558 .
°©us
 = 0,

559 .
c⁄åﬁ
 = (
¶Ÿid
 << 24Ë| (
CR_CONFIGURE_ENDPOINT
 << 10)

561 
	`d¥ötf
(3, "%s: slŸid %d,ádd 0x%x, dñ 0x%x\n", 
__func__
,

562 
¶Ÿid
, 
ö˘x
->
add
, in˘x->
dñ
);

563  
	`xhci_cmd_submô
(
xhci
, &
cmd
);

564 
	}
}

566 
	$xhci_cmd_evÆu©e_c⁄ãxt
(
usb_xhci_s
 *
xhci
, 
u32
 
¶Ÿid


567 , 
xhci_ö˘x
 *
ö˘x
)

569 
	`ASSERT32FLAT
();

570 
xhci_åb
 
cmd
 = {

571 .
±r_low
 = (
u32
)
ö˘x
,

572 .
±r_high
 = 0,

573 .
°©us
 = 0,

574 .
c⁄åﬁ
 = (
¶Ÿid
 << 24Ë| (
CR_EVALUATE_CONTEXT
 << 10)

576 
	`d¥ötf
(3, "%s: slŸid %d,ádd 0x%x, dñ 0x%x\n", 
__func__
,

577 
¶Ÿid
, 
ö˘x
->
add
, in˘x->
dñ
);

578  
	`xhci_cmd_submô
(
xhci
, &
cmd
);

579 
	}
}

581 
	$xhci_x„r_£tup
(
xhci_pùe
 *
pùe
,

582 c⁄° 
usb_˘æªque°
 *
ªq
,

583 
dú
, 
d©Æí
)

585 
	`ASSERT32FLAT
();

586 
xhci_åb
 
åb
;

588 
	`mem£t
(&
åb
, 0, (trb));

589 
åb
.
±r_low
 |
ªq
->
bReque°Ty≥
;

590 
åb
.
±r_low
 |(
ªq
->
bReque°
) << 8;

591 
åb
.
±r_low
 |(
ªq
->
wVÆue
) << 16;

592 
åb
.
±r_high
 |
ªq
->
wIndex
;

593 
åb
.
±r_high
 |(
ªq
->
wLígth
) << 16;

594 
åb
.
°©us
 |= 8;

595 
åb
.
c⁄åﬁ
 |(
TR_SETUP
 << 10);

596 
åb
.
c⁄åﬁ
 |
TRB_TR_IDT
;

597 i‡(
d©Æí
)

598 
åb
.
c⁄åﬁ
 |(
dú
 ? 3 : 2) << 16;

599 
	`xhci_x„r_queue
(
pùe
, &
åb
);

600 
	}
}

602 
	$xhci_x„r_d©a
(
xhci_pùe
 *
pùe
,

603 
dú
, *
d©a
, 
d©Æí
)

605 
	`ASSERT32FLAT
();

606 
xhci_åb
 
åb
;

608 
	`mem£t
(&
åb
, 0, (trb));

609 
åb
.
±r_low
 = (
u32
)
d©a
;

610 
åb
.
°©us
 = 
d©Æí
;

611 
åb
.
c⁄åﬁ
 |(
TR_DATA
 << 10);

612 i‡(
dú
)

613 
åb
.
c⁄åﬁ
 |= (1 << 16);

614 
	`xhci_x„r_queue
(
pùe
, &
åb
);

615 
	}
}

617 
	$xhci_x„r_°©us
(
xhci_pùe
 *
pùe
, 
dú
, 
d©Æí
)

619 
	`ASSERT32FLAT
();

620 
xhci_åb
 
åb
;

622 
	`mem£t
(&
åb
, 0, (trb));

623 
åb
.
c⁄åﬁ
 |(
TR_STATUS
 << 10);

624 
åb
.
c⁄åﬁ
 |
TRB_TR_IOC
;

625 i‡(!
d©Æí
 || !
dú
)

626 
åb
.
c⁄åﬁ
 |= (1 << 16);

628 
	`xhci_x„r_queue
(
pùe
, &
åb
);

629 
	`xhci_x„r_kick
(
pùe
);

630 
	}
}

633 
	$c⁄figuª_xhci
(*
d©a
)

635 
	`ASSERT32FLAT
();

636 
usb_xhci_s
 *
xhci
 = 
d©a
;

637 
u32
 
ªg
;

639 
xhci
->
devs
 = 
	`memÆign_high
(64, (*xhci->devsË* (xhci->
¶Ÿs
 + 1));

640 
xhci
->
e£g
 = 
	`memÆign_high
(64, (*xhci->eseg));

641 
xhci
->
cmds
 = 
	`memÆign_high
(
XHCI_RING_SIZE
, (*xhci->cmds));

642 
xhci
->
evts
 = 
	`memÆign_low
(
XHCI_RING_SIZE
, (*xhci->evts));

643 i‡(!
xhci
->
devs
 || !xhci->
cmds
 || !xhci->
evts
 || !xhci->
e£g
) {

644 
	`w¨n_nﬂŒoc
();

645 
Áû
;

647 
	`mem£t
(
xhci
->
devs
, 0, (*xhci->devsË* (xhci->
¶Ÿs
 + 1));

648 
	`mem£t
(
xhci
->
cmds
, 0, (*xhci->cmds));

649 
	`mem£t
(
xhci
->
evts
, 0, (*xhci->evts));

650 
	`mem£t
(
xhci
->
e£g
, 0, (*xhci->eseg));

652 
ªg
 = 
	`ªadl
(&
xhci
->
›
->
usbcmd
);

653 i‡(
ªg
 & 
XHCI_CMD_RS
) {

654 
ªg
 &~
XHCI_CMD_RS
;

655 
	`wrôñ
(&
xhci
->
›
->
usbcmd
, 
ªg
);

656 i‡(
	`waô_bô
(&
xhci
->
›
->
usb°s
, 
XHCI_STS_HCH
, XHCI_STS_HCH, 32) != 0)

657 
Áû
;

660 
	`d¥ötf
(3, "%s:Ñe£âög\n", 
__func__
);

661 
	`wrôñ
(&
xhci
->
›
->
usbcmd
, 
XHCI_CMD_HCRST
);

662 i‡(
	`waô_bô
(&
xhci
->
›
->
usbcmd
, 
XHCI_CMD_HCRST
, 0, 100) != 0)

663 
Áû
;

664 i‡(
	`waô_bô
(&
xhci
->
›
->
usb°s
, 
XHCI_STS_CNR
, 0, 100) != 0)

665 
Áû
;

667 
	`wrôñ
(&
xhci
->
›
->
c⁄fig
, xhci->
¶Ÿs
);

668 
	`wrôñ
(&
xhci
->
›
->
dcbØp_low
, (
u32
)xhci->
devs
);

669 
	`wrôñ
(&
xhci
->
›
->
dcbØp_high
, 0);

670 
	`wrôñ
(&
xhci
->
›
->
¸¸_low
, (
u32
)xhci->
cmds
 | 1);

671 
	`wrôñ
(&
xhci
->
›
->
¸¸_high
, 0);

672 
xhci
->
cmds
->
cs
 = 1;

674 
xhci
->
e£g
->
±r_low
 = (
u32
)xhci->
evts
;

675 
xhci
->
e£g
->
±r_high
 = 0;

676 
xhci
->
e£g
->
size
 = 
XHCI_RING_ITEMS
;

677 
	`wrôñ
(&
xhci
->
ú
->
î°sz
, 1);

678 
	`wrôñ
(&
xhci
->
ú
->
îdp_low
, (
u32
)xhci->
evts
);

679 
	`wrôñ
(&
xhci
->
ú
->
îdp_high
, 0);

680 
	`wrôñ
(&
xhci
->
ú
->
î°ba_low
, (
u32
)xhci->
e£g
);

681 
	`wrôñ
(&
xhci
->
ú
->
î°ba_high
, 0);

682 
xhci
->
evts
->
cs
 = 1;

684 
ªg
 = 
	`ªadl
(&
xhci
->
ˇps
->
hc•¨ams2
);

685 
u32
 
•b
 = 
ªg
 >> 27;

686 i‡(
•b
) {

687 
	`d¥ötf
(3, "%s: sëu∞%d s¸©chÖad buf„rs\n", 
__func__
, 
•b
);

688 
u64
 *
•ba
 = 
	`memÆign_high
(64, (*•baË* 
•b
);

689 *
∑d
 = 
	`memÆign_high
(
PAGE_SIZE
, PAGE_SIZE * 
•b
);

690 i‡(!
•ba
 || !
∑d
) {

691 
	`w¨n_nﬂŒoc
();

692 
	`‰ì
(
•ba
);

693 
	`‰ì
(
∑d
);

694 
Áû
;

696 
i
;

697 
i
 = 0; i < 
•b
; i++)

698 
•ba
[
i
] = (
u32
)
∑d
 + (ò* 
PAGE_SIZE
);

699 
xhci
->
devs
[0].
±r_low
 = (
u32
)
•ba
;

700 
xhci
->
devs
[0].
±r_high
 = 0;

703 
ªg
 = 
	`ªadl
(&
xhci
->
›
->
usbcmd
);

704 
ªg
 |
XHCI_CMD_RS
;

705 
	`wrôñ
(&
xhci
->
›
->
usbcmd
, 
ªg
);

708 
	`mdñay
(100);

710 
	`usb_íumî©e
(&
xhci
->
hub
);

712 i‡(
xhci
->
hub
.
devcou¡
)

716 
	`d¥ötf
(1, "XHCIÇo devices found\n");

717 
ªg
 = 
	`ªadl
(&
xhci
->
›
->
usbcmd
);

718 
ªg
 &~
XHCI_CMD_RS
;

719 
	`wrôñ
(&
xhci
->
›
->
usbcmd
, 
ªg
);

720 
	`waô_bô
(&
xhci
->
›
->
usb°s
, 
XHCI_STS_HCH
, XHCI_STS_HCH, 32);

722 
Áû
:

723 
	`‰ì
(
xhci
->
e£g
);

724 
	`‰ì
(
xhci
->
evts
);

725 
	`‰ì
(
xhci
->
cmds
);

726 
	`‰ì
(
xhci
->
devs
);

727 
	`‰ì
(
xhci
);

728 
	}
}

735 
	$xhci_¥öt_p‹t_°©e
(
logÀvñ
, c⁄° *
¥efix
, 
u32
 
p‹t
, u32 
p‹tsc
)

737 
	`ASSERT32FLAT
();

738 
u32
 
∂s
 = 
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_PLS
);

739 
u32
 
•ìd
 = 
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_SPEED
);

741 
	`d¥ötf
(
logÀvñ
, "%sÖort #%d: 0x%08x,%s%sÖls %d, speed %d [%s]\n",

742 
¥efix
, 
p‹t
 + 1, 
p‹tsc
,

743 (
p‹tsc
 & 
XHCI_PORTSC_PP
) ? "Öowered," : "",

744 (
p‹tsc
 & 
XHCI_PORTSC_PED
) ? "Énabled," : "",

745 
∂s
, 
•ìd
, 
•ìd_«me
[speed]);

746 
	}
}

749 
	$xhci_hub_dëe˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

751 
	`ASSERT32FLAT
();

752 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(
hub
->
˙é
, usb_xhci_s, 
usb
);

753 
u32
 
p‹tsc
 = 
	`ªadl
(&
xhci
->
¥
[
p‹t
].portsc);

755 
	`xhci_¥öt_p‹t_°©e
(3, 
__func__
, 
p‹t
, 
p‹tsc
);

756 
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_PLS
)) {

757 
PLS_U0
:

758 
PLS_POLLING
:

763 
	}
}

767 
	$xhci_hub_ª£t
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

769 
	`ASSERT32FLAT
();

770 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(
hub
->
˙é
, usb_xhci_s, 
usb
);

771 
u32
 
p‹tsc
 = 
	`ªadl
(&
xhci
->
¥
[
p‹t
].portsc);

772 
rc
;

774 
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_PLS
)) {

775 
PLS_U0
:

776 
rc
 = 
•ìd_‰om_xhci
[
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_SPEED
)];

778 
PLS_POLLING
:

779 
	`xhci_¥öt_p‹t_°©e
(3, 
__func__
, 
p‹t
, 
p‹tsc
);

780 
p‹tsc
 |
XHCI_PORTSC_PR
;

781 
	`wrôñ
(&
xhci
->
¥
[
p‹t
].
p‹tsc
,Öortsc);

782 i‡(
	`waô_bô
(&
xhci
->
¥
[
p‹t
].
p‹tsc
, 
XHCI_PORTSC_PED
, XHCI_PORTSC_PED, 100) != 0)

784 
p‹tsc
 = 
	`ªadl
(&
xhci
->
¥
[
p‹t
].portsc);

785 
rc
 = 
•ìd_‰om_xhci
[
	`xhci_gë_fõld
(
p‹tsc
, 
XHCI_PORTSC_SPEED
)];

788 
rc
 = -1;

792 
	`xhci_¥öt_p‹t_°©e
(1, "XHCI", 
p‹t
, 
p‹tsc
);

793  
rc
;

794 
	}
}

797 
	$xhci_hub_disc⁄√˘
(
usbhub_s
 *
hub
, 
u32
 
p‹t
)

799 
	`ASSERT32FLAT
();

801 
	}
}

803 
usbhub_›_s
 
	gxhci_hub_›s
 = {

804 .
dëe˘
 = 
xhci_hub_dëe˘
,

805 .
	gª£t
 = 
xhci_hub_ª£t
,

806 .
	gdisc⁄√˘
 = 
xhci_hub_disc⁄√˘
,

813 
xhci_ö˘x
 *

814 
	$xhci_Æloc_ö˘x
(
usbdevi˚_s
 *
usbdev
, 
maxïid
)

816 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

817 
usbdev
->
hub
->
˙é
, 
usb_xhci_s
, 
usb
);

818 
size
 = ((
xhci_ö˘x
Ë* 33Ë<< 
xhci
->
c⁄ãxt64
;

819 
xhci_ö˘x
 *
ö
 = 
	`memÆign_tmphigh
(2048 << 
xhci
->
c⁄ãxt64
, 
size
);

820 i‡(!
ö
) {

821 
	`w¨n_nﬂŒoc
();

822  
NULL
;

824 
	`mem£t
(
ö
, 0, 
size
);

826 
xhci_¶Ÿ˘x
 *
¶Ÿ
 = (*)&
ö
[1 << 
xhci
->
c⁄ãxt64
];

827 
¶Ÿ
->
˘x
[0] |
maxïid
 << 27;

828 
¶Ÿ
->
˘x
[0] |
•ìd_to_xhci
[
usbdev
->
•ìd
] << 20;

831 
usbdevi˚_s
 *
hubdev
 = 
usbdev
->
hub
->usbdev;

832 i‡(
hubdev
) {

833 i‡(
usbdev
->
•ìd
 =
USB_LOWSPEED
 || usbdev->•ìd =
USB_FULLSPEED
) {

834 
xhci_pùe
 *
hpùe
 = 
	`c⁄èöî_of
(

835 
hubdev
->
deÂùe
, 
xhci_pùe
, 
pùe
);

836 i‡(
hubdev
->
•ìd
 =
USB_HIGHSPEED
) {

837 
¶Ÿ
->
˘x
[2] |
hpùe
->
¶Ÿid
;

838 
¶Ÿ
->
˘x
[2] |(
usbdev
->
p‹t
+1) << 8;

840 
xhci_¶Ÿ˘x
 *
h¶Ÿ
 = (*)
xhci
->
devs
[
hpùe
->
¶Ÿid
].
±r_low
;

841 
¶Ÿ
->
˘x
[2] = 
h¶Ÿ
->ctx[2];

844 
u32
 
rouã
 = 0;

845 
usbdev
->
hub
->usbdev) {

846 
rouã
 <<= 4;

847 
rouã
 |(
usbdev
->
p‹t
+1) & 0xf;

848 
usbdev
 = usbdev->
hub
->usbdev;

850 
¶Ÿ
->
˘x
[0] |
rouã
;

853 
¶Ÿ
->
˘x
[1] |(
usbdev
->
p‹t
+1) << 16;

855  
ö
;

856 
	}
}

858 
	$xhci_c⁄fig_hub
(
usbhub_s
 *
hub
)

860 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

861 
hub
->
˙é
, 
usb_xhci_s
, 
usb
);

862 
xhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(

863 
hub
->
usbdev
->
deÂùe
, 
xhci_pùe
, 
pùe
);

864 
xhci_¶Ÿ˘x
 *
hd¶Ÿ
 = (*)
xhci
->
devs
[
pùe
->
¶Ÿid
].
±r_low
;

865 i‡((
hd¶Ÿ
->
˘x
[3] >> 27) == 3)

868 
xhci_ö˘x
 *
ö
 = 
	`xhci_Æloc_ö˘x
(
hub
->
usbdev
, 1);

869 i‡(!
ö
)

871 
ö
->
add
 = 0x01;

872 
xhci_¶Ÿ˘x
 *
¶Ÿ
 = (*)&
ö
[1 << 
xhci
->
c⁄ãxt64
];

873 
¶Ÿ
->
˘x
[0] |= 1 << 26;

874 
¶Ÿ
->
˘x
[1] |
hub
->
p‹tcou¡
 << 24;

876 
cc
 = 
	`xhci_cmd_c⁄figuª_ídpoöt
(
xhci
, 
pùe
->
¶Ÿid
, 
ö
);

877 
	`‰ì
(
ö
);

878 i‡(
cc
 !
CC_SUCCESS
) {

879 
	`d¥ötf
(1, "%s: c⁄figuª hub: faûed (c¯%d)\n", 
__func__
, 
cc
);

883 
	}
}

885 
usb_pùe
 *

886 
	$xhci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


887 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

889 
	`ASSERT32FLAT
();

890 i‡(!
CONFIG_USB_XHCI
)

891  
NULL
;

892 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

893 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

894 
usbdev
->
hub
->
˙é
, 
usb_xhci_s
, 
usb
);

895 
xhci_pùe
 *
pùe
;

896 
u32
 
ïid
;

898 i‡(
ïdesc
->
bEndpoötAddªss
 == 0) {

899 
ïid
 = 1;

901 
ïid
 = (
ïdesc
->
bEndpoötAddªss
 & 0x0f) * 2;

902 
ïid
 +(
ïdesc
->
bEndpoötAddªss
 & 
USB_DIR_IN
) ? 1 : 0;

905 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

906 
pùe
 = 
	`memÆign_high
(
XHCI_RING_SIZE
, (*pipe));

908 
pùe
 = 
	`memÆign_low
(
XHCI_RING_SIZE
, (*pipe));

909 i‡(!
pùe
) {

910 
	`w¨n_nﬂŒoc
();

911  
NULL
;

913 
	`mem£t
(
pùe
, 0, (*pipe));

915 
	`usb_desc2pùe
(&
pùe
->pùe, 
usbdev
, 
ïdesc
);

916 
pùe
->
ïid
 =Épid;

917 
pùe
->
ªqs
.
cs
 = 1;

918 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

919 
pùe
->
buf
 = 
	`mÆloc_low
’ùe->pùe.
max∑ckë
);

922 
xhci_ö˘x
 *
ö
 = 
	`xhci_Æloc_ö˘x
(
usbdev
, 
ïid
);

923 i‡(!
ö
)

924 
Áû
;

925 
ö
->
add
 = 0x01 | (1 << 
ïid
);

926 
xhci_ï˘x
 *
ï
 = (*)&
ö
[(
pùe
->
ïid
+1Ë<< 
xhci
->
c⁄ãxt64
];

927 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_INT
)

928 
ï
->
˘x
[0] = (
	`usb_gëFømeExp
(
usbdev
, 
ïdesc
) + 3) << 16;

929 
ï
->
˘x
[1] |
ïty≥
 << 3;

930 i‡(
ïdesc
->
bEndpoötAddªss
 & 
USB_DIR_IN


931 || 
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
)

932 
ï
->
˘x
[1] |= 1 << 5;

933 
ï
->
˘x
[1] |
pùe
->pùe.
max∑ckë
 << 16;

934 
ï
->
deq_low
 = (
u32
)&
pùe
->
ªqs
.
rög
[0];

935 
ï
->
deq_low
 |= 1;

936 
ï
->
Àngth
 = 
pùe
->pùe.
max∑ckë
;

938 
	`d¥ötf
(3, "%s: usbdev %p,Ñög %p, slŸid %d,Épid %d\n", 
__func__
,

939 
usbdev
, &
pùe
->
ªqs
,Öùe->
¶Ÿid
,Öùe->
ïid
);

940 i‡(
pùe
->
ïid
 == 1) {

941 i‡(
usbdev
->
hub
->usbdev) {

943 
ªt
 = 
	`xhci_c⁄fig_hub
(
usbdev
->
hub
);

944 i‡(
ªt
)

945 
Áû
;

948 
u32
 
size
 = ((
xhci_¶Ÿ˘x
Ë* 32Ë<< 
xhci
->
c⁄ãxt64
;

949 
xhci_¶Ÿ˘x
 *
dev
 = 
	`memÆign_high
(1024 << 
xhci
->
c⁄ãxt64
, 
size
);

950 i‡(!
dev
) {

951 
	`w¨n_nﬂŒoc
();

952 
Áû
;

954 
¶Ÿid
 = 
	`xhci_cmd_íabÀ_¶Ÿ
(
xhci
);

955 i‡(
¶Ÿid
 < 0) {

956 
	`d¥ötf
(1, "%s:É«bÀ slŸ: faûed\n", 
__func__
);

957 
	`‰ì
(
dev
);

958 
Áû
;

960 
	`d¥ötf
(3, "%s:É«bÀ slŸ: gŸ slŸid %d\n", 
__func__
, 
¶Ÿid
);

961 
	`mem£t
(
dev
, 0, 
size
);

962 
pùe
->
¶Ÿid
 = 
usbdev
->slotid = slotid;

963 
xhci
->
devs
[
¶Ÿid
].
±r_low
 = (
u32
)
dev
;

964 
xhci
->
devs
[
¶Ÿid
].
±r_high
 = 0;

967 
cc
 = 
	`xhci_cmd_addªss_devi˚
(
xhci
, 
¶Ÿid
, 
ö
);

968 i‡(
cc
 !
CC_SUCCESS
) {

969 
	`d¥ötf
(1, "%s:áddªs†devi˚: faûed (c¯%d)\n", 
__func__
, 
cc
);

970 
Áû
;

973 
pùe
->
¶Ÿid
 = 
usbdev
->slotid;

975 
cc
 = 
	`xhci_cmd_c⁄figuª_ídpoöt
(
xhci
, 
pùe
->
¶Ÿid
, 
ö
);

976 i‡(
cc
 !
CC_SUCCESS
) {

977 
	`d¥ötf
(1, "%s: c⁄figuªÉndpoöt: faûed (c¯%d)\n", 
__func__
, 
cc
);

978 
Áû
;

981 
	`‰ì
(
ö
);

982  &
pùe
->pipe;

984 
Áû
:

985 
	`‰ì
(
pùe
);

986 
	`‰ì
(
ö
);

987  
NULL
;

988 
	}
}

990 
usb_pùe
 *

991 
	$xhci_upd©e_pùe
(
usbdevi˚_s
 *
usbdev
, 
usb_pùe
 *
upùe


992 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

994 
	`ASSERT32FLAT
();

995 i‡(!
CONFIG_USB_XHCI
)

996  
NULL
;

997 
u8
 
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

998 
xhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
upùe
, xhci_pipe,Öipe);

999 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

1000 
pùe
->pùe.
˙é
, 
usb_xhci_s
, 
usb
);

1001 
	`d¥ötf
(3, "%s: usbdev %p,Ñög %p, slŸid %d,Épid %d\n", 
__func__
,

1002 
usbdev
, &
pùe
->
ªqs
,Öùe->
¶Ÿid
,Öùe->
ïid
);

1003 i‡(
ïty≥
 =
USB_ENDPOINT_XFER_CONTROL
 &&

1004 
pùe
->pùe.
max∑ckë
 !
ïdesc
->
wMaxPackëSize
) {

1005 
	`d¥ötf
(1, "%s:Ñeconf ctlÉndpointÖkt size: %d -> %d\n",

1006 
__func__
, 
pùe
->pùe.
max∑ckë
, 
ïdesc
->
wMaxPackëSize
);

1007 
pùe
->pùe.
max∑ckë
 = 
ïdesc
->
wMaxPackëSize
;

1008 
xhci_ö˘x
 *
ö
 = 
	`xhci_Æloc_ö˘x
(
usbdev
, 1);

1009 i‡(!
ö
)

1010  
upùe
;

1011 
ö
->
add
 = (1 << 1);

1012 
xhci_ï˘x
 *
ï
 = (*)&
ö
[2 << 
xhci
->
c⁄ãxt64
];

1013 
ï
->
˘x
[1] |(
pùe
->pùe.
max∑ckë
 << 16);

1014 
cc
 = 
	`xhci_cmd_evÆu©e_c⁄ãxt
(
xhci
, 
pùe
->
¶Ÿid
, 
ö
);

1015 i‡(
cc
 !
CC_SUCCESS
) {

1016 
	`d¥ötf
(1, "%s:Ñeconf ctlÉndpoint: failed (cc %d)\n",

1017 
__func__
, 
cc
);

1019 
	`‰ì
(
ö
);

1021  
upùe
;

1022 
	}
}

1025 
	$xhci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


1026 , *
d©a
, 
d©Æí
)

1028 
	`ASSERT32FLAT
();

1029 i‡(!
CONFIG_USB_XHCI
)

1031 c⁄° 
usb_˘æªque°
 *
ªq
 = 
cmd
;

1032 
xhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, xhci_pipe,Öipe);

1033 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

1034 
pùe
->pùe.
˙é
, 
usb_xhci_s
, 
usb
);

1036 i‡(
ªq
->
bReque°
 =
USB_REQ_SET_ADDRESS
)

1040 
	`xhci_x„r_£tup
(
pùe
, 
ªq
, 
dú
, 
d©Æí
);

1041 i‡(
d©Æí
)

1042 
	`xhci_x„r_d©a
(
pùe
, 
dú
, 
d©a
, 
d©Æí
);

1043 
	`xhci_x„r_°©us
(
pùe
, 
dú
, 
d©Æí
);

1045 
cc
 = 
	`xhci_evít_waô
(
xhci
, &
pùe
->
ªqs
, 1000);

1046 i‡(
cc
 !
CC_SUCCESS
) {

1047 
	`d¥ötf
(1, "%s: c⁄åﬁ x„∏Áûed (c¯%d)\n", 
__func__
, 
cc
);

1052 
	}
}

1054 
VISIBLE32FLAT


1055 
	$xhci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©Æí
)

1057 i‡(!
CONFIG_USB_XHCI
)

1060 
xhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, xhci_pipe,Öipe);

1061 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

1062 
	`GET_LOWFLAT
(
pùe
->pùe.
˙é
), 
usb_xhci_s
, 
usb
);

1064 
	`xhci_x„r_n‹mÆ
(
pùe
, 
d©a
, 
d©Æí
);

1065 
cc
 = 
	`xhci_evít_waô
(
xhci
, &
pùe
->
ªqs
, 1000);

1066 i‡(
cc
 !
CC_SUCCESS
) {

1067 
	`d¥ötf
(1, "%s: bulk x„∏Áûed (c¯%d)\n", 
__func__
, 
cc
);

1071 
	}
}

1073 
VISIBLE32FLAT


1074 
	$xhci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
)

1076 i‡(!
CONFIG_USB_XHCI
)

1079 
xhci_pùe
 *
pùe
 = 
	`c⁄èöî_of
(
p
, xhci_pipe,Öipe);

1080 
usb_xhci_s
 *
xhci
 = 
	`c⁄èöî_of
(

1081 
	`GET_LOWFLAT
(
pùe
->pùe.
˙é
), 
usb_xhci_s
, 
usb
);

1082 
u32
 
Àn
 = 
	`GET_LOWFLAT
(
pùe
->pùe.
max∑ckë
);

1083 *
buf
 = 
	`GET_LOWFLAT
(
pùe
->buf);

1084 
bufu£d
 = 
	`GET_LOWFLAT
(
pùe
->bufused);

1086 i‡(!
bufu£d
) {

1087 
	`xhci_x„r_n‹mÆ
(
pùe
, 
buf
, 
Àn
);

1088 
bufu£d
 = 1;

1089 
	`SET_LOWFLAT
(
pùe
->
bufu£d
, bufused);

1093 
	`xhci_¥o˚ss_evíts
(
xhci
);

1094 i‡(
	`xhci_rög_busy
(&
pùe
->
ªqs
))

1096 
	`d¥ötf
(5, "%s: sà%x cà%x [ %∞<%∞/ %d ]\n", 
__func__
,

1097 
	`GET_LOWFLAT
(
pùe
->
ªqs
.
evt
.
°©us
),

1098 
	`GET_LOWFLAT
(
pùe
->
ªqs
.
evt
.
c⁄åﬁ
),

1099 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
d©a
), 
buf
, 
Àn
);

1100 
	`mem˝y_Ê
(
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 
d©a
), 
buf
, 
Àn
);

1101 
	`xhci_x„r_n‹mÆ
(
pùe
, 
buf
, 
Àn
);

1103 
	}
}

1106 
	$xhci_c⁄åﬁÀr_£tup
(
pci_devi˚
 *
pci
)

1108 
usb_xhci_s
 *
xhci
 = 
	`mÆloc_low
((*xhci));

1109 i‡(!
xhci
) {

1110 
	`w¨n_nﬂŒoc
();

1113 
	`mem£t
(
xhci
, 0, (*xhci));

1115 
	`waô_¥ìm±
();

1116 
xhci
->
ba£addr
 = 
	`pci_c⁄fig_ªadl
(
pci
->
bdf
, 
PCI_BASE_ADDRESS_0
)

1117 & 
PCI_BASE_ADDRESS_MEM_MASK
;

1118 
xhci
->
ˇps
 = (*)(xhci->
ba£addr
);

1119 
xhci
->
›
 = (*)(xhci->
ba£addr
 + 
	`ªadb
(&xhci->
ˇps
->
ˇ∂ígth
));

1120 
xhci
->
¥
 = (*)(xhci->
ba£addr
 + 
	`ªadb
(&xhci->
ˇps
->
ˇ∂ígth
) + 0x400);

1121 
xhci
->
db
 = (*)(xhci->
ba£addr
 + 
	`ªadl
(&xhci->
ˇps
->
dboff
));

1122 
xhci
->
ú
 = (*)(xhci->
ba£addr
 + 
	`ªadl
(&xhci->
ˇps
->
πsoff
) + 0x20);

1124 
u32
 
hcs1
 = 
	`ªadl
(&
xhci
->
ˇps
->
hc•¨ams1
);

1125 
u32
 
hcc
 = 
	`ªadl
(&
xhci
->
ˇps
->
hc˝¨ams
);

1126 
xhci
->
p‹ts
 = (
hcs1
 >> 24) & 0xff;

1127 
xhci
->
¶Ÿs
 = 
hcs1
 & 0xff;

1128 
xhci
->
xˇp
 = ((
hcc
 >> 16) & 0xffff) << 2;

1129 
xhci
->
c⁄ãxt64
 = (
hcc
 & 0x04) ? 1 : 0;

1131 
xhci
->
usb
.
pci
 =Öci;

1132 
xhci
->
usb
.
ty≥
 = 
USB_TYPE_XHCI
;

1133 
xhci
->
hub
.
˙é
 = &xhci->
usb
;

1134 
xhci
->
hub
.
p‹tcou¡
 = xhci->
p‹ts
;

1135 
xhci
->
hub
.
›
 = &
xhci_hub_›s
;

1137 
	`d¥ötf
(1, "XHCI init on dev %02x:%02x.%x:Ñegs @ %p, %dÖorts, %d slots"

1139 , 
	`pci_bdf_to_bus
(
pci
->
bdf
), 
	`pci_bdf_to_dev
(pci->bdf)

1140 , 
	`pci_bdf_to_‚
(
pci
->
bdf
), 
xhci
->
ˇps


1141 , 
xhci
->
p‹ts
, xhci->
¶Ÿs
, xhci->
c⁄ãxt64
 ? 64 : 32);

1143 i‡(
xhci
->
xˇp
) {

1144 
u32
 
off
, 
addr
 = 
xhci
->
ba£addr
 + xhci->
xˇp
;

1146 
xhci_xˇp
 *
xˇp
 = (*)
addr
;

1147 
u32
 
p‹ts
, 
«me
, 
ˇp
 = 
	`ªadl
(&
xˇp
->cap);

1148 
ˇp
 & 0xff) {

1150 
«me
 = 
	`ªadl
(&
xˇp
->
d©a
[0]);

1151 
p‹ts
 = 
	`ªadl
(&
xˇp
->
d©a
[1]);

1152 
	`d¥ötf
(1, "XHCIÖrotocol %c%c%c%c %x.%02x"

1154 , (
«me
 >> 0) & 0xff

1155 , (
«me
 >> 8) & 0xff

1156 , (
«me
 >> 16) & 0xff

1157 , (
«me
 >> 24) & 0xff

1158 , (
ˇp
 >> 24) & 0xff

1159 , (
ˇp
 >> 16) & 0xff

1160 , (
p‹ts
 >> 8) & 0xff

1161 , (
p‹ts
 >> 0) & 0xff

1162 , 
p‹ts
 >> 16);

1165 
	`d¥ötf
(1, "XHCIÉxtˇ∞0x%x @ %x\n", 
ˇp
 & 0xff, 
addr
);

1168 
off
 = (
ˇp
 >> 8) & 0xff;

1169 
addr
 +
off
 << 2;

1170 } 
off
 > 0);

1173 
u32
 
∑gesize
 = 
	`ªadl
(&
xhci
->
›
->pagesize);

1174 i‡(
PAGE_SIZE
 !(
∑gesize
<<12)) {

1175 
	`d¥ötf
(1, "XHCI driver doesÇot supportÖage size code %d\n"

1176 , 
∑gesize
<<12);

1177 
	`‰ì
(
xhci
);

1181 
	`pci_c⁄fig_maskw
(
pci
->
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

1183 
	`run_thªad
(
c⁄figuª_xhci
, 
xhci
);

1184 
	}
}

1187 
	$xhci_£tup
()

1189 i‡(! 
CONFIG_USB_XHCI
)

1191 
pci_devi˚
 *
pci
;

1192 
	`f‹óchpci
(
pci
) {

1193 i‡(
	`pci_˛as•rog
(
pci
Ë=
PCI_CLASS_SERIAL_USB_XHCI
)

1194 
	`xhci_c⁄åﬁÀr_£tup
(
pci
);

1196 
	}
}

	@hw/usb-xhci.h

1 #i‚de‡
__USB_XHCI_H


2 
	#__USB_XHCI_H


	)

4 
	gusbdevi˚_s
;

5 
	gusb_ídpoöt_des¸ùt‹
;

6 
	gusb_pùe
;

11 
xhci_£tup
();

12 
usb_pùe
 *
xhci_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


13 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

14 
usb_pùe
 *
xhci_upd©e_pùe
(
usbdevi˚_s
 *
usbdev


15 , 
usb_pùe
 *
pùe


16 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

17 
xhci_c⁄åﬁ
(
usb_pùe
 *
p
, 
dú
, c⁄° *
cmd
, 
cmdsize


18 , *
d©a
, 
d©asize
);

19 
xhci_£nd_bulk
(
usb_pùe
 *
p
, 
dú
, *
d©a
, 
d©asize
);

20 
xhci_pﬁl_öå
(
usb_pùe
 *
p
, *
d©a
);

26 
	sxhci_ˇps
 {

27 
u8
 
	mˇ∂ígth
;

28 
u8
 
	mª£rved_01
;

29 
u16
 
	mhcivîsi⁄
;

30 
u32
 
	mhc•¨ams1
;

31 
u32
 
	mhc•¨ams2
;

32 
u32
 
	mhc•¨ams3
;

33 
u32
 
	mhc˝¨ams
;

34 
u32
 
	mdboff
;

35 
u32
 
	mπsoff
;

36 } 
	gPACKED
;

39 
	sxhci_xˇp
 {

40 
u32
 
	mˇp
;

41 
u32
 
	md©a
[];

42 } 
	gPACKED
;

45 
	sxhci_›
 {

46 
u32
 
	musbcmd
;

47 
u32
 
	musb°s
;

48 
u32
 
	m∑gesize
;

49 
u32
 
	mª£rved_01
[2];

50 
u32
 
	mdn˘l
;

51 
u32
 
	m¸¸_low
;

52 
u32
 
	m¸¸_high
;

53 
u32
 
	mª£rved_02
[4];

54 
u32
 
	mdcbØp_low
;

55 
u32
 
	mdcbØp_high
;

56 
u32
 
	mc⁄fig
;

57 } 
	gPACKED
;

60 
	sxhci_¥
 {

61 
u32
 
	mp‹tsc
;

62 
u32
 
	mp‹çmsc
;

63 
u32
 
	mp‹éi
;

64 
u32
 
	mª£rved_01
;

65 } 
	gPACKED
;

68 
	sxhci_db
 {

69 
u32
 
	mdo‹bñl
;

70 } 
	gPACKED
;

73 
	sxhci_πs
 {

74 
u32
 
	mmfödex
;

75 } 
	gPACKED
;

78 
	sxhci_ú
 {

79 
u32
 
	mim™
;

80 
u32
 
	mimod
;

81 
u32
 
	mî°sz
;

82 
u32
 
	mª£rved_01
;

83 
u32
 
	mî°ba_low
;

84 
u32
 
	mî°ba_high
;

85 
u32
 
	mîdp_low
;

86 
u32
 
	mîdp_high
;

87 } 
	gPACKED
;

93 
	sxhci_¶Ÿ˘x
 {

94 
u32
 
	m˘x
[4];

95 
u32
 
	mª£rved_01
[4];

96 } 
	gPACKED
;

99 
	sxhci_ï˘x
 {

100 
u32
 
	m˘x
[2];

101 
u32
 
	mdeq_low
;

102 
u32
 
	mdeq_high
;

103 
u32
 
	mÀngth
;

104 
u32
 
	mª£rved_01
[3];

105 } 
	gPACKED
;

108 
	sxhci_devli°
 {

109 
u32
 
	m±r_low
;

110 
u32
 
	m±r_high
;

111 } 
	gPACKED
;

114 
	sxhci_ö˘x
 {

115 
u32
 
	mdñ
;

116 
u32
 
	madd
;

117 
u32
 
	mª£rved_01
[6];

118 } 
	gPACKED
;

121 
	sxhci_åb
 {

122 
u32
 
	m±r_low
;

123 
u32
 
	m±r_high
;

124 
u32
 
	m°©us
;

125 
u32
 
	mc⁄åﬁ
;

126 } 
	gPACKED
;

129 
	sxhci_î_£g
 {

130 
u32
 
	m±r_low
;

131 
u32
 
	m±r_high
;

132 
u32
 
	msize
;

133 
u32
 
	mª£rved_01
;

134 } 
	gPACKED
;

	@hw/usb.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"mÆloc.h
"

10 
	~"ouçut.h
"

11 
	~"°rög.h
"

12 
	~"usb.h
"

13 
	~"usb-ehci.h
"

14 
	~"usb-xhci.h
"

15 
	~"usb-hid.h
"

16 
	~"usb-hub.h
"

17 
	~"usb-msc.h
"

18 
	~"usb-ohci.h
"

19 
	~"usb-uas.h
"

20 
	~"usb-uhci.h
"

21 
	~"utû.h
"

22 
	~"x86.h
"

30 
usb_pùe
 *

31 
	$usb_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


32 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

34 
usbdev
->
hub
->
˙é
->
ty≥
) {

36 
USB_TYPE_UHCI
:

37  
	`uhci_Æloc_pùe
(
usbdev
, 
ïdesc
);

38 
USB_TYPE_OHCI
:

39  
	`ohci_Æloc_pùe
(
usbdev
, 
ïdesc
);

40 
USB_TYPE_EHCI
:

41  
	`ehci_Æloc_pùe
(
usbdev
, 
ïdesc
);

42 
USB_TYPE_XHCI
:

43  
	`xhci_Æloc_pùe
(
usbdev
, 
ïdesc
);

45 
	}
}

48 
usb_pùe
 *

49 
	$usb_upd©e_pùe
(
usbdevi˚_s
 *
usbdev
, 
usb_pùe
 *
pùe


50 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

52 
usbdev
->
hub
->
˙é
->
ty≥
) {

53 
USB_TYPE_XHCI
:

54  
	`xhci_upd©e_pùe
(
usbdev
, 
pùe
, 
ïdesc
);

56 
	`‰ì_pùe
(
pùe
);

57  
	`usb_Æloc_pùe
(
usbdev
, 
ïdesc
);

59 
	}
}

63 
	$£nd_c⁄åﬁ
(
usb_pùe
 *
pùe
, 
dú
, c⁄° *
cmd
, 
cmdsize


64 , *
d©a
, 
d©asize
)

66 
	`ASSERT32FLAT
();

67 
pùe
->
ty≥
) {

69 
USB_TYPE_UHCI
:

70  
	`uhci_c⁄åﬁ
(
pùe
, 
dú
, 
cmd
, 
cmdsize
, 
d©a
, 
d©asize
);

71 
USB_TYPE_OHCI
:

72  
	`ohci_c⁄åﬁ
(
pùe
, 
dú
, 
cmd
, 
cmdsize
, 
d©a
, 
d©asize
);

73 
USB_TYPE_EHCI
:

74  
	`ehci_c⁄åﬁ
(
pùe
, 
dú
, 
cmd
, 
cmdsize
, 
d©a
, 
d©asize
);

75 
USB_TYPE_XHCI
:

76  
	`xhci_c⁄åﬁ
(
pùe
, 
dú
, 
cmd
, 
cmdsize
, 
d©a
, 
d©asize
);

78 
	}
}

81 
	$usb_£nd_bulk
(
usb_pùe
 *
pùe_Ê
, 
dú
, *
d©a
, 
d©asize
)

83 
	`GET_LOWFLAT
(
pùe_Ê
->
ty≥
)) {

85 
USB_TYPE_UHCI
:

86  
	`uhci_£nd_bulk
(
pùe_Ê
, 
dú
, 
d©a
, 
d©asize
);

87 
USB_TYPE_OHCI
:

88  
	`ohci_£nd_bulk
(
pùe_Ê
, 
dú
, 
d©a
, 
d©asize
);

89 
USB_TYPE_EHCI
:

90  
	`ehci_£nd_bulk
(
pùe_Ê
, 
dú
, 
d©a
, 
d©asize
);

91 
USB_TYPE_XHCI
:

92 i‡(
MODESEGMENT
)

94  
	`xhci_£nd_bulk
(
pùe_Ê
, 
dú
, 
d©a
, 
d©asize
);

96 
	}
}

99 
	$usb_pﬁl_öå
(
usb_pùe
 *
pùe_Ê
, *
d©a
)

101 
	`ASSERT16
();

102 
	`GET_LOWFLAT
(
pùe_Ê
->
ty≥
)) {

104 
USB_TYPE_UHCI
:

105  
	`uhci_pﬁl_öå
(
pùe_Ê
, 
d©a
);

106 
USB_TYPE_OHCI
:

107  
	`ohci_pﬁl_öå
(
pùe_Ê
, 
d©a
);

108 
USB_TYPE_EHCI
:

109  
	`ehci_pﬁl_öå
(
pùe_Ê
, 
d©a
);

110 
USB_TYPE_XHCI
: ;

111 
	`_cfunc32Ê©_xhci_pﬁl_öå
();

112  
	`ˇŒ32_∑øms
(
_cfunc32Ê©_xhci_pﬁl_öå
, (
u32
)
pùe_Ê


113 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), (u32)
d©a
), 0, -1);

115 
	}
}

117 
	$usb_32bô_pùe
(
usb_pùe
 *
pùe_Ê
)

119  
CONFIG_USB_XHCI
 && 
	`GET_LOWFLAT
(
pùe_Ê
->
ty≥
Ë=
USB_TYPE_XHCI
;

120 
	}
}

128 
	$£nd_deÁu…_c⁄åﬁ
(
usb_pùe
 *
pùe
, c⁄° 
usb_˘æªque°
 *
ªq


129 , *
d©a
)

131  
	`£nd_c⁄åﬁ
(
pùe
, 
ªq
->
bReque°Ty≥
 & 
USB_DIR_IN


132 , 
ªq
, (*ªq), 
d©a
,Ñeq->
wLígth
);

133 
	}
}

137 
	$‰ì_pùe
(
usb_pùe
 *
pùe
)

139 
	`ASSERT32FLAT
();

140 i‡(!
pùe
)

143 
usb_s
 *
˙é
 = 
pùe
->cntl;

144 
pùe
->
‰ì√xt
 = 
˙é
->
‰ìli°
;

145 
˙é
->
‰ìli°
 = 
pùe
;

146 
	}
}

149 
usb_pùe
 *

150 
	$usb_gëFªePùe
(
usb_s
 *
˙é
, 
u8
 
ïty≥
)

152 
usb_pùe
 **
p‰ì
 = &
˙é
->
‰ìli°
;

154 
usb_pùe
 *
pùe
 = *
p‰ì
;

155 i‡(!
pùe
)

156  
NULL
;

157 i‡(
pùe
->
ïty≥
 ==Éptype) {

158 *
p‰ì
 = 
pùe
->
‰ì√xt
;

159  
pùe
;

161 
p‰ì
 = &
pùe
->
‰ì√xt
;

163 
	}
}

167 
	$usb_desc2pùe
(
usb_pùe
 *
pùe
, 
usbdevi˚_s
 *
usbdev


168 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

170 
pùe
->
˙é
 = 
usbdev
->
hub
->cntl;

171 
pùe
->
ty≥
 = 
usbdev
->
hub
->
˙é
->type;

172 
pùe
->
ï
 = 
ïdesc
->
bEndpoötAddªss
 & 
USB_ENDPOINT_NUMBER_MASK
;

173 
pùe
->
devaddr
 = 
usbdev
->devaddr;

174 
pùe
->
•ìd
 = 
usbdev
->speed;

175 
pùe
->
max∑ckë
 = 
ïdesc
->
wMaxPackëSize
;

176 
pùe
->
ïty≥
 = 
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
;

177 
	}
}

181 
	$usb_gëFømeExp
(
usbdevi˚_s
 *
usbdev


182 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
)

184 
≥riod
 = 
ïdesc
->
bI¡îvÆ
;

185 i‡(
usbdev
->
•ìd
 !
USB_HIGHSPEED
)

186  (
≥riod
 <0Ë? 0 : 
	`__Ês
(period);

187  (
≥riod
 <= 4) ? 0 :Öeriod - 4;

188 
	}
}

191 
usb_ídpoöt_des¸ùt‹
 *

192 
	$födEndPoötDesc
(
usbdevi˚_s
 *
usbdev
, 
ty≥
, 
dú
)

194 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
 = (*)&
usbdev
->
iÁ˚
[1];

196 i‡((*)
ïdesc
 >(*)
usbdev
->
iÁ˚
 + usbdev->
imax


197 || 
ïdesc
->
bDes¸ùt‹Ty≥
 =
USB_DT_INTERFACE
) {

198  
NULL
;

200 i‡(
ïdesc
->
bDes¸ùt‹Ty≥
 =
USB_DT_ENDPOINT


201 && (
ïdesc
->
bEndpoötAddªss
 & 
USB_ENDPOINT_DIR_MASK
Ë=
dú


202 && (
ïdesc
->
bmAâribuãs
 & 
USB_ENDPOINT_XFERTYPE_MASK
Ë=
ty≥
)

203  
ïdesc
;

204 
ïdesc
 = (*Îpdes¯+Épdesc->
bLígth
;

206 
	}
}

210 
	$gë_devi˚_öfo8
(
usb_pùe
 *
pùe
, 
usb_devi˚_des¸ùt‹
 *
döfo
)

212 
usb_˘æªque°
 
ªq
;

213 
ªq
.
bReque°Ty≥
 = 
USB_DIR_IN
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
;

214 
ªq
.
bReque°
 = 
USB_REQ_GET_DESCRIPTOR
;

215 
ªq
.
wVÆue
 = 
USB_DT_DEVICE
<<8;

216 
ªq
.
wIndex
 = 0;

217 
ªq
.
wLígth
 = 8;

218  
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
döfo
);

219 
	}
}

221 
usb_c⁄fig_des¸ùt‹
 *

222 
	$gë_devi˚_c⁄fig
(
usb_pùe
 *
pùe
)

224 
usb_c⁄fig_des¸ùt‹
 
cfg
;

226 
usb_˘æªque°
 
ªq
;

227 
ªq
.
bReque°Ty≥
 = 
USB_DIR_IN
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
;

228 
ªq
.
bReque°
 = 
USB_REQ_GET_DESCRIPTOR
;

229 
ªq
.
wVÆue
 = 
USB_DT_CONFIG
<<8;

230 
ªq
.
wIndex
 = 0;

231 
ªq
.
wLígth
 = (
cfg
);

232 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, &
cfg
);

233 i‡(
ªt
)

234  
NULL
;

236 *
c⁄fig
 = 
	`mÆloc_tmphigh
(
cfg
.
wTŸÆLígth
);

237 i‡(!
c⁄fig
)

238  
NULL
;

239 
ªq
.
wLígth
 = 
cfg
.
wTŸÆLígth
;

240 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
c⁄fig
);

241 i‡(
ªt
)

242  
NULL
;

244  
c⁄fig
;

245 
	}
}

248 
	$£t_c⁄figuøti⁄
(
usb_pùe
 *
pùe
, 
u16
 
vÆ
)

250 
usb_˘æªque°
 
ªq
;

251 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
;

252 
ªq
.
bReque°
 = 
USB_REQ_SET_CONFIGURATION
;

253 
ªq
.
wVÆue
 = 
vÆ
;

254 
ªq
.
wIndex
 = 0;

255 
ªq
.
wLígth
 = 0;

256  
	`£nd_deÁu…_c⁄åﬁ
(
pùe
, &
ªq
, 
NULL
);

257 
	}
}

264 c⁄° 
	g•ìd_to_˘lsize
[] = {

265 [ 
USB_FULLSPEED
 ] = 8,

266 [ 
USB_LOWSPEED
 ] = 8,

267 [ 
USB_HIGHSPEED
 ] = 64,

268 [ 
USB_SUPERSPEED
 ] = 512,

274 
	$usb_£t_addªss
(
usbdevi˚_s
 *
usbdev
)

276 
	`ASSERT32FLAT
();

277 
usb_s
 *
˙é
 = 
usbdev
->
hub
->cntl;

278 
	`d¥ötf
(3, "£t_addªs†%p\n", 
˙é
);

279 i‡(
˙é
->
maxaddr
 >
USB_MAXADDR
)

282 
	`m¶ìp
(
USB_TIME_RSTRCY
);

285 
usb_ídpoöt_des¸ùt‹
 
ïdesc
 = {

286 .
wMaxPackëSize
 = 
•ìd_to_˘lsize
[
usbdev
->
•ìd
],

287 .
bmAâribuãs
 = 
USB_ENDPOINT_XFER_CONTROL
,

289 
usbdev
->
deÂùe
 = 
	`usb_Æloc_pùe
(usbdev, &
ïdesc
);

290 i‡(!
usbdev
->
deÂùe
)

294 
usb_˘æªque°
 
ªq
;

295 
ªq
.
bReque°Ty≥
 = 
USB_DIR_OUT
 | 
USB_TYPE_STANDARD
 | 
USB_RECIP_DEVICE
;

296 
ªq
.
bReque°
 = 
USB_REQ_SET_ADDRESS
;

297 
ªq
.
wVÆue
 = 
˙é
->
maxaddr
 + 1;

298 
ªq
.
wIndex
 = 0;

299 
ªq
.
wLígth
 = 0;

300 
ªt
 = 
	`£nd_deÁu…_c⁄åﬁ
(
usbdev
->
deÂùe
, &
ªq
, 
NULL
);

301 i‡(
ªt
) {

302 
	`‰ì_pùe
(
usbdev
->
deÂùe
);

306 
	`m¶ìp
(
USB_TIME_SETADDR_RECOVERY
);

308 
˙é
->
maxaddr
++;

309 
usbdev
->
devaddr
 = 
˙é
->
maxaddr
;

310 
usbdev
->
deÂùe
 = 
	`usb_upd©e_pùe
(usbdev, usbdev->deÂùe, &
ïdesc
);

311 i‡(!
usbdev
->
deÂùe
)

314 
	}
}

319 
	$c⁄figuª_usb_devi˚
(
usbdevi˚_s
 *
usbdev
)

321 
	`ASSERT32FLAT
();

322 
	`d¥ötf
(3, "c⁄fig_usb: %p\n", 
usbdev
->
deÂùe
);

325 
usb_devi˚_des¸ùt‹
 
döfo
;

326 
ªt
 = 
	`gë_devi˚_öfo8
(
usbdev
->
deÂùe
, &
döfo
);

327 i‡(
ªt
)

329 
u16
 
max∑ckë
 = 
döfo
.
bMaxPackëSize0
;

330 i‡(
döfo
.
bcdUSB
 >= 0x0300)

331 
max∑ckë
 = 1 << 
döfo
.
bMaxPackëSize0
;

332 
	`d¥ötf
(3, "deviceÑev=%04x cls=%02x sub=%02xÖroto=%02x size=%d\n"

333 , 
döfo
.
bcdUSB
, döfo.
bDevi˚Cœss
, döfo.
bDevi˚SubCœss


334 , 
döfo
.
bDevi˚PrŸocﬁ
, 
max∑ckë
);

335 i‡(
max∑ckë
 < 8)

337 
usb_ídpoöt_des¸ùt‹
 
ïdesc
 = {

338 .
wMaxPackëSize
 = 
max∑ckë
,

339 .
bmAâribuãs
 = 
USB_ENDPOINT_XFER_CONTROL
,

341 
usbdev
->
deÂùe
 = 
	`usb_upd©e_pùe
(usbdev, usbdev->deÂùe, &
ïdesc
);

342 i‡(!
usbdev
->
deÂùe
)

346 
usb_c⁄fig_des¸ùt‹
 *
c⁄fig
 = 
	`gë_devi˚_c⁄fig
(
usbdev
->
deÂùe
);

347 i‡(!
c⁄fig
)

352 
usb_öãrÁ˚_des¸ùt‹
 *
iÁ˚
 = (*)(&
c⁄fig
[1]);

353 i‡(
iÁ˚
->
bI¡îÁ˚Cœss
 !
USB_CLASS_HID


354 && 
iÁ˚
->
bI¡îÁ˚Cœss
 !
USB_CLASS_MASS_STORAGE


355 && 
iÁ˚
->
bI¡îÁ˚Cœss
 !
USB_CLASS_HUB
)

357 
Áû
;

360 
ªt
 = 
	`£t_c⁄figuøti⁄
(
usbdev
->
deÂùe
, 
c⁄fig
->
bC⁄figuøti⁄VÆue
);

361 i‡(
ªt
)

362 
Áû
;

365 
usbdev
->
c⁄fig
 = config;

366 
usbdev
->
iÁ˚
 = iface;

367 
usbdev
->
imax
 = (*)
c⁄fig
 + c⁄fig->
wTŸÆLígth
 - (*)
iÁ˚
;

368 i‡(
iÁ˚
->
bI¡îÁ˚Cœss
 =
USB_CLASS_HUB
)

369 
ªt
 = 
	`usb_hub_£tup
(
usbdev
);

370 i‡(
iÁ˚
->
bI¡îÁ˚Cœss
 =
USB_CLASS_MASS_STORAGE
) {

371 i‡(
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 =
US_PR_BULK
)

372 
ªt
 = 
	`usb_msc_£tup
(
usbdev
);

373 i‡(
iÁ˚
->
bI¡îÁ˚PrŸocﬁ
 =
US_PR_UAS
)

374 
ªt
 = 
	`usb_uas_£tup
(
usbdev
);

376 
ªt
 = 
	`usb_hid_£tup
(
usbdev
);

377 i‡(
ªt
)

378 
Áû
;

380 
	`‰ì
(
c⁄fig
);

382 
Áû
:

383 
	`‰ì
(
c⁄fig
);

385 
	}
}

388 
	$usb_hub_p‹t_£tup
(*
d©a
)

390 
usbdevi˚_s
 *
usbdev
 = 
d©a
;

391 
usbhub_s
 *
hub
 = 
usbdev
->hub;

392 
u32
 
p‹t
 = 
usbdev
->port;

395 
ªt
 = 
hub
->
›
->
	`dëe˘
(hub, 
p‹t
);

396 i‡(
ªt
)

398 
d⁄e
;

401 
	`muãx_lock
(&
hub
->
˙é
->
ª£éock
);

402 
ªt
 = 
hub
->
›
->
	`ª£t
(hub, 
p‹t
);

403 i‡(
ªt
 < 0)

405 
ª£tÁû
;

406 
usbdev
->
•ìd
 = 
ªt
;

409 
ªt
 = 
	`usb_£t_addªss
(
usbdev
);

410 i‡(
ªt
) {

411 
hub
->
›
->
	`disc⁄√˘
(hub, 
p‹t
);

412 
ª£tÁû
;

414 
	`muãx_u∆ock
(&
hub
->
˙é
->
ª£éock
);

417 
cou¡
 = 
	`c⁄figuª_usb_devi˚
(
usbdev
);

418 
	`‰ì_pùe
(
usbdev
->
deÂùe
);

419 i‡(!
cou¡
)

420 
hub
->
›
->
	`disc⁄√˘
(hub, 
p‹t
);

421 
hub
->
devcou¡
 +
cou¡
;

422 
d⁄e
:

423 
hub
->
thªads
--;

424 
	`‰ì
(
usbdev
);

427 
ª£tÁû
:

428 
	`muãx_u∆ock
(&
hub
->
˙é
->
ª£éock
);

429 
d⁄e
;

430 
	}
}

433 
	$usb_íumî©e
(
usbhub_s
 *
hub
)

435 
u32
 
p‹tcou¡
 = 
hub
->portcount;

436 
hub
->
thªads
 = 
p‹tcou¡
;

439 
i
;

440 
i
=0; i<
p‹tcou¡
; i++) {

441 
usbdevi˚_s
 *
usbdev
 = 
	`mÆloc_tmphigh
((*usbdev));

442 i‡(!
usbdev
) {

443 
	`w¨n_nﬂŒoc
();

446 
	`mem£t
(
usbdev
, 0, (*usbdev));

447 
usbdev
->
hub
 = hub;

448 
usbdev
->
p‹t
 = 
i
;

449 
	`run_thªad
(
usb_hub_p‹t_£tup
, 
usbdev
);

453 
hub
->
thªads
)

454 
	`yõld
();

455 
	}
}

458 
	$__usb_£tup
(*
d©a
)

460 
	`d¥ötf
(3, "init usb\n");

461 
	`xhci_£tup
();

462 
	`ehci_£tup
();

463 
	`uhci_£tup
();

464 
	`ohci_£tup
();

465 
	}
}

468 
	$usb_£tup
()

470 
	`ASSERT32FLAT
();

471 i‡(! 
CONFIG_USB
)

473 
	`run_thªad
(
__usb_£tup
, 
NULL
);

474 
	}
}

	@hw/usb.h

2 #i‚de‡
__USB_H


3 
	#__USB_H


	)

5 
	~"°acks.h
"

8 
	susb_pùe
 {

10 
usb_s
 *
	m˙é
;

11 
usb_pùe
 *
	m‰ì√xt
;

13 
u8
 
	mty≥
;

14 
u8
 
	mï
;

15 
u8
 
	mdevaddr
;

16 
u8
 
	m•ìd
;

17 
u16
 
	mmax∑ckë
;

18 
u8
 
	mïty≥
;

22 
	susbdevi˚_s
 {

23 
usbhub_s
 *
	mhub
;

24 
usb_pùe
 *
	mdeÂùe
;

25 
u32
 
	m¶Ÿid
;

26 
u32
 
	mp‹t
;

27 
usb_c⁄fig_des¸ùt‹
 *
	mc⁄fig
;

28 
usb_öãrÁ˚_des¸ùt‹
 *
	miÁ˚
;

29 
	mimax
;

30 
u8
 
	m•ìd
;

31 
u8
 
	mdevaddr
;

35 
	susb_s
 {

36 
usb_pùe
 *
	m‰ìli°
;

37 
muãx_s
 
	mª£éock
;

38 
pci_devi˚
 *
	mpci
;

39 
u8
 
	mty≥
;

40 
u8
 
	mmaxaddr
;

44 
	susbhub_s
 {

45 
usbhub_›_s
 *
	m›
;

46 
usbdevi˚_s
 *
	musbdev
;

47 
usb_s
 *
	m˙é
;

48 
muãx_s
 
	mlock
;

49 
u32
 
	mpowîwaô
;

50 
u32
 
	mp‹t
;

51 
u32
 
	mthªads
;

52 
u32
 
	mp‹tcou¡
;

53 
u32
 
	mdevcou¡
;

57 
	susbhub_›_s
 {

58 (*
	mdëe˘
)(
usbhub_s
 *
	mhub
, 
u32
 
	mp‹t
);

59 (*
	mª£t
)(
usbhub_s
 *
	mhub
, 
u32
 
	mp‹t
);

60 (*
	mdisc⁄√˘
)(
usbhub_s
 *
	mhub
, 
u32
 
	mp‹t
);

63 
	#USB_TYPE_UHCI
 1

	)

64 
	#USB_TYPE_OHCI
 2

	)

65 
	#USB_TYPE_EHCI
 3

	)

66 
	#USB_TYPE_XHCI
 4

	)

68 
	#USB_FULLSPEED
 0

	)

69 
	#USB_LOWSPEED
 1

	)

70 
	#USB_HIGHSPEED
 2

	)

71 
	#USB_SUPERSPEED
 3

	)

73 
	#USB_MAXADDR
 127

	)

81 
	#USB_TIME_SIGATT
 100

	)

82 
	#USB_TIME_ATTDB
 100

	)

83 
	#USB_TIME_DRST
 10

	)

84 
	#USB_TIME_DRSTR
 50

	)

85 
	#USB_TIME_RSTRCY
 10

	)

87 
	#USB_TIME_SETADDR_RECOVERY
 2

	)

89 
	#USB_PID_OUT
 0xe1

	)

90 
	#USB_PID_IN
 0x69

	)

91 
	#USB_PID_SETUP
 0x2d

	)

93 
	#USB_DIR_OUT
 0

	)

94 
	#USB_DIR_IN
 0x80

	)

96 
	#USB_TYPE_MASK
 (0x03 << 5)

	)

97 
	#USB_TYPE_STANDARD
 (0x00 << 5)

	)

98 
	#USB_TYPE_CLASS
 (0x01 << 5)

	)

99 
	#USB_TYPE_VENDOR
 (0x02 << 5)

	)

100 
	#USB_TYPE_RESERVED
 (0x03 << 5)

	)

102 
	#USB_RECIP_MASK
 0x1f

	)

103 
	#USB_RECIP_DEVICE
 0x00

	)

104 
	#USB_RECIP_INTERFACE
 0x01

	)

105 
	#USB_RECIP_ENDPOINT
 0x02

	)

106 
	#USB_RECIP_OTHER
 0x03

	)

108 
	#USB_REQ_GET_STATUS
 0x00

	)

109 
	#USB_REQ_CLEAR_FEATURE
 0x01

	)

110 
	#USB_REQ_SET_FEATURE
 0x03

	)

111 
	#USB_REQ_SET_ADDRESS
 0x05

	)

112 
	#USB_REQ_GET_DESCRIPTOR
 0x06

	)

113 
	#USB_REQ_SET_DESCRIPTOR
 0x07

	)

114 
	#USB_REQ_GET_CONFIGURATION
 0x08

	)

115 
	#USB_REQ_SET_CONFIGURATION
 0x09

	)

116 
	#USB_REQ_GET_INTERFACE
 0x0A

	)

117 
	#USB_REQ_SET_INTERFACE
 0x0B

	)

118 
	#USB_REQ_SYNCH_FRAME
 0x0C

	)

120 
	susb_˘æªque°
 {

121 
u8
 
	mbReque°Ty≥
;

122 
u8
 
	mbReque°
;

123 
u16
 
	mwVÆue
;

124 
u16
 
	mwIndex
;

125 
u16
 
	mwLígth
;

126 } 
	gPACKED
;

128 
	#USB_DT_DEVICE
 0x01

	)

129 
	#USB_DT_CONFIG
 0x02

	)

130 
	#USB_DT_STRING
 0x03

	)

131 
	#USB_DT_INTERFACE
 0x04

	)

132 
	#USB_DT_ENDPOINT
 0x05

	)

133 
	#USB_DT_DEVICE_QUALIFIER
 0x06

	)

134 
	#USB_DT_OTHER_SPEED_CONFIG
 0x07

	)

135 
	#USB_DT_ENDPOINT_COMPANION
 0x30

	)

137 
	susb_devi˚_des¸ùt‹
 {

138 
u8
 
	mbLígth
;

139 
u8
 
	mbDes¸ùt‹Ty≥
;

141 
u16
 
	mbcdUSB
;

142 
u8
 
	mbDevi˚Cœss
;

143 
u8
 
	mbDevi˚SubCœss
;

144 
u8
 
	mbDevi˚PrŸocﬁ
;

145 
u8
 
	mbMaxPackëSize0
;

146 
u16
 
	midVíd‹
;

147 
u16
 
	midProdu˘
;

148 
u16
 
	mbcdDevi˚
;

149 
u8
 
	miM™uÁ˘uªr
;

150 
u8
 
	miProdu˘
;

151 
u8
 
	miSîülNumbî
;

152 
u8
 
	mbNumC⁄figuøti⁄s
;

153 } 
	gPACKED
;

155 
	#USB_CLASS_PER_INTERFACE
 0

	)

156 
	#USB_CLASS_AUDIO
 1

	)

157 
	#USB_CLASS_COMM
 2

	)

158 
	#USB_CLASS_HID
 3

	)

159 
	#USB_CLASS_PHYSICAL
 5

	)

160 
	#USB_CLASS_STILL_IMAGE
 6

	)

161 
	#USB_CLASS_PRINTER
 7

	)

162 
	#USB_CLASS_MASS_STORAGE
 8

	)

163 
	#USB_CLASS_HUB
 9

	)

165 
	susb_c⁄fig_des¸ùt‹
 {

166 
u8
 
	mbLígth
;

167 
u8
 
	mbDes¸ùt‹Ty≥
;

169 
u16
 
	mwTŸÆLígth
;

170 
u8
 
	mbNumI¡îÁ˚s
;

171 
u8
 
	mbC⁄figuøti⁄VÆue
;

172 
u8
 
	miC⁄figuøti⁄
;

173 
u8
 
	mbmAâribuãs
;

174 
u8
 
	mbMaxPowî
;

175 } 
	gPACKED
;

177 
	susb_öãrÁ˚_des¸ùt‹
 {

178 
u8
 
	mbLígth
;

179 
u8
 
	mbDes¸ùt‹Ty≥
;

181 
u8
 
	mbI¡îÁ˚Numbî
;

182 
u8
 
	mbA…î«ãSëtög
;

183 
u8
 
	mbNumEndpoöts
;

184 
u8
 
	mbI¡îÁ˚Cœss
;

185 
u8
 
	mbI¡îÁ˚SubCœss
;

186 
u8
 
	mbI¡îÁ˚PrŸocﬁ
;

187 
u8
 
	miI¡îÁ˚
;

188 } 
	gPACKED
;

190 
	susb_ídpoöt_des¸ùt‹
 {

191 
u8
 
	mbLígth
;

192 
u8
 
	mbDes¸ùt‹Ty≥
;

194 
u8
 
	mbEndpoötAddªss
;

195 
u8
 
	mbmAâribuãs
;

196 
u16
 
	mwMaxPackëSize
;

197 
u8
 
	mbI¡îvÆ
;

198 } 
	gPACKED
;

200 
	#USB_ENDPOINT_NUMBER_MASK
 0x0‡

	)

201 
	#USB_ENDPOINT_DIR_MASK
 0x80

	)

203 
	#USB_ENDPOINT_XFERTYPE_MASK
 0x03

	)

204 
	#USB_ENDPOINT_XFER_CONTROL
 0

	)

205 
	#USB_ENDPOINT_XFER_ISOC
 1

	)

206 
	#USB_ENDPOINT_XFER_BULK
 2

	)

207 
	#USB_ENDPOINT_XFER_INT
 3

	)

208 
	#USB_ENDPOINT_MAX_ADJUSTABLE
 0x80

	)

215 
	#US_SC_ATAPI_8020
 0x02

	)

216 
	#US_SC_ATAPI_8070
 0x05

	)

217 
	#US_SC_SCSI
 0x06

	)

219 
	#US_PR_BULK
 0x50

	)

220 
	#US_PR_UAS
 0x62

	)

227 
usb_pùe
 *
usb_Æloc_pùe
(
usbdevi˚_s
 *
usbdev


228 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

229 
usb_£nd_bulk
(
usb_pùe
 *
pùe
, 
dú
, *
d©a
, 
d©asize
);

230 
usb_pﬁl_öå
(
usb_pùe
 *
pùe
, *
d©a
);

231 
usb_32bô_pùe
(
usb_pùe
 *
pùe_Ê
);

232 
£nd_deÁu…_c⁄åﬁ
(
usb_pùe
 *
pùe
, c⁄° 
usb_˘æªque°
 *
ªq


233 , *
d©a
);

234 
‰ì_pùe
(
usb_pùe
 *
pùe
);

235 
usb_pùe
 *
usb_gëFªePùe
(
usb_s
 *
˙é
, 
u8
 
ïty≥
);

236 
usb_desc2pùe
(
usb_pùe
 *
pùe
, 
usbdevi˚_s
 *
usbdev


237 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

238 
usb_gëFømeExp
(
usbdevi˚_s
 *
usbdev


239 , 
usb_ídpoöt_des¸ùt‹
 *
ïdesc
);

240 
usb_ídpoöt_des¸ùt‹
 *
födEndPoötDesc
(
usbdevi˚_s
 *
usbdev


241 , 
ty≥
, 
dú
);

242 
usb_íumî©e
(
usbhub_s
 *
hub
);

243 
usb_£tup
();

	@hw/virtio-blk.c

10 
	~"biosv¨.h
"

11 
	~"c⁄fig.h
"

12 
	~"block.h
"

13 
	~"mÆloc.h
"

14 
	~"ouçut.h
"

15 
	~"pci.h
"

16 
	~"pci_ids.h
"

17 
	~"pci_ªgs.h
"

18 
	~"°d/disk.h
"

19 
	~"°rög.h
"

20 
	~"utû.h
"

21 
	~"vútio-pci.h
"

22 
	~"vútio-rög.h
"

23 
	~"vútio-blk.h
"

25 
	svútiodrive_s
 {

26 
drive_s
 
	mdrive
;

27 
vrög_vútqueue
 *
	mvq
;

28 
u16
 
	miﬂddr
;

32 
	$vútio_blk_›
(
disk_›_s
 *
›
, 
wrôe
)

34 
vútiodrive_s
 *
vdrive_gf
 =

35 
	`c⁄èöî_of
(
›
->
drive_gf
, 
vútiodrive_s
, 
drive
);

36 
vrög_vútqueue
 *
vq
 = 
	`GET_GLOBALFLAT
(
vdrive_gf
->vq);

37 
vútio_blk_outhdr
 
hdr
 = {

38 .
ty≥
 = 
wrôe
 ? 
VIRTIO_BLK_T_OUT
 : 
VIRTIO_BLK_T_IN
,

39 .
i›rio
 = 0,

40 .
£˘‹
 = 
›
->
lba
,

42 
u8
 
°©us
 = 
VIRTIO_BLK_S_UNSUPP
;

43 
vrög_li°
 
sg
[] = {

45 .
addr
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
hdr
),

46 .
Àngth
 = (
hdr
),

49 .
addr
 = 
›
->
buf_Ê
,

50 .
Àngth
 = 
	`GET_GLOBALFLAT
(
vdrive_gf
->
drive
.
blksize
Ë* 
›
->
cou¡
,

53 .
addr
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
°©us
),

54 .
Àngth
 = (
°©us
),

59 i‡(
wrôe
)

60 
	`vrög_add_buf
(
vq
, 
sg
, 2, 1, 0, 0);

62 
	`vrög_add_buf
(
vq
, 
sg
, 1, 2, 0, 0);

63 
	`vrög_kick
(
	`GET_GLOBALFLAT
(
vdrive_gf
->
iﬂddr
), 
vq
, 1);

66 !
	`vrög_m‹e_u£d
(
vq
))

67 
	`u¶ìp
(5);

70 
	`vrög_gë_buf
(
vq
, 
NULL
);

75 
	`vp_gë_i§
(
	`GET_GLOBALFLAT
(
vdrive_gf
->
iﬂddr
));

77  
°©us
 =
VIRTIO_BLK_S_OK
 ? 
DISK_RET_SUCCESS
 : 
DISK_RET_EBADTRACK
;

78 
	}
}

81 
	$¥o˚ss_vútio_blk_›
(
disk_›_s
 *
›
)

83 i‡(! 
CONFIG_VIRTIO_BLK
)

85 
›
->
comm™d
) {

86 
CMD_READ
:

87  
	`vútio_blk_›
(
›
, 0);

88 
CMD_WRITE
:

89  
	`vútio_blk_›
(
›
, 1);

90 
CMD_FORMAT
:

91 
CMD_RESET
:

92 
CMD_ISREADY
:

93 
CMD_VERIFY
:

94 
CMD_SEEK
:

95  
DISK_RET_SUCCESS
;

97  
DISK_RET_EPARAM
;

99 
	}
}

102 
	$öô_vútio_blk
(
pci_devi˚
 *
pci
)

104 
u16
 
bdf
 = 
pci
->bdf;

105 
	`d¥ötf
(1, "found vútio-blkáà%x:%x\n", 
	`pci_bdf_to_bus
(
bdf
),

106 
	`pci_bdf_to_dev
(
bdf
));

107 
vútiodrive_s
 *
vdrive
 = 
	`mÆloc_f£g
((*vdrive));

108 i‡(!
vdrive
) {

109 
	`w¨n_nﬂŒoc
();

112 
	`mem£t
(
vdrive
, 0, (*vdrive));

113 
vdrive
->
drive
.
ty≥
 = 
DTYPE_VIRTIO_BLK
;

114 
vdrive
->
drive
.
˙é_id
 = 
bdf
;

116 
u16
 
iﬂddr
 = 
	`vp_öô_sim∂e
(
bdf
);

117 
vdrive
->
iﬂddr
 = ioaddr;

118 i‡(
	`vp_föd_vq
(
iﬂddr
, 0, &
vdrive
->
vq
) < 0 ) {

119 
	`d¥ötf
(1, "failÅo find vq for virtio-blk %x:%x\n",

120 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf));

121 
Áû
;

124 
vútio_blk_c⁄fig
 
cfg
;

125 
	`vp_gë
(
iﬂddr
, 0, &
cfg
, (cfg));

127 
u32
 
f
 = 
	`vp_gë_„©uªs
(
iﬂddr
);

128 
vdrive
->
drive
.
blksize
 = (
f
 & (1 << 
VIRTIO_BLK_F_BLK_SIZE
)) ?

129 
cfg
.
blk_size
 : 
DISK_SECTOR_SIZE
;

131 
vdrive
->
drive
.
£˘‹s
 = 
cfg
.
ˇ∑côy
;

132 
	`d¥ötf
(3, "virtio-blk %x:%x blksize=%d sectors=%u\n",

133 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

134 
vdrive
->
drive
.
blksize
, (
u32
)vdrive->drive.
£˘‹s
);

136 i‡(
vdrive
->
drive
.
blksize
 !
DISK_SECTOR_SIZE
) {

137 
	`d¥ötf
(1, "virtio-blk %x:%x block size %d is unsupported\n",

138 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf),

139 
vdrive
->
drive
.
blksize
);

140 
Áû
;

143 
vdrive
->
drive
.
pchs
.
cylödî
 = 
cfg
.
cylödîs
;

144 
vdrive
->
drive
.
pchs
.
hód
 = 
cfg
.
hóds
;

145 
vdrive
->
drive
.
pchs
.
£˘‹
 = 
cfg
.
£˘‹s
;

146 *
desc
 = 
	`z≈rötf
(
MAXDESCSIZE
, "Virtio disk PCI:%x:%x",

147 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf));

149 
	`boŸ_add_hd
(&
vdrive
->
drive
, 
desc
, 
	`boŸ¥io_föd_pci_devi˚
(
pci
));

151 
	`vp_£t_°©us
(
iﬂddr
, 
VIRTIO_CONFIG_S_ACKNOWLEDGE
 |

152 
VIRTIO_CONFIG_S_DRIVER
 | 
VIRTIO_CONFIG_S_DRIVER_OK
);

155 
Áû
:

156 
	`vp_ª£t
(
iﬂddr
);

157 
	`‰ì
(
vdrive
->
vq
);

158 
	`‰ì
(
vdrive
);

159 
	}
}

162 
	$vútio_blk_£tup
()

164 
	`ASSERT32FLAT
();

165 i‡(! 
CONFIG_VIRTIO_BLK
)

168 
	`d¥ötf
(3, "init virtio-blk\n");

170 
pci_devi˚
 *
pci
;

171 
	`f‹óchpci
(
pci
) {

172 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_REDHAT_QUMRANET


173 || 
pci
->
devi˚
 !
PCI_DEVICE_ID_VIRTIO_BLK
)

175 
	`öô_vútio_blk
(
pci
);

177 
	}
}

	@hw/virtio-blk.h

1 #i‚de‡
_VIRTIO_BLK_H


2 
	#_VIRTIO_BLK_H


	)

4 
	svútio_blk_c⁄fig


6 
u64
 
	mˇ∑côy
;

7 
u32
 
	msize_max
;

8 
u32
 
	m£g_max
;

9 
u16
 
	mcylödîs
;

10 
u8
 
	mhóds
;

11 
u8
 
	m£˘‹s
;

12 
u32
 
	mblk_size
;

13 
u8
 
	mphysiˇl_block_exp
;

14 
u8
 
	mÆignmít_off£t
;

15 
u16
 
	mmö_io_size
;

16 
u32
 
	m›t_io_size
;

17 } 
__©åibuã__
((
∑cked
));

19 
	#VIRTIO_BLK_F_BLK_SIZE
 6

	)

22 
	#VIRTIO_BLK_T_IN
 0

	)

23 
	#VIRTIO_BLK_T_OUT
 1

	)

26 
	svútio_blk_outhdr
 {

28 
u32
 
	mty≥
;

30 
u32
 
	mi›rio
;

32 
u64
 
	m£˘‹
;

35 
	#VIRTIO_BLK_S_OK
 0

	)

36 
	#VIRTIO_BLK_S_IOERR
 1

	)

37 
	#VIRTIO_BLK_S_UNSUPP
 2

	)

39 
	gdisk_›_s
;

40 
¥o˚ss_vútio_blk_›
(
disk_›_s
 *
›
);

41 
vútio_blk_£tup
();

	@hw/virtio-pci.c

18 
	~"c⁄fig.h
"

19 
	~"mÆloc.h
"

20 
	~"ouçut.h
"

21 
	~"pci.h
"

22 
	~"pci_ªgs.h
"

23 
	~"°rög.h
"

24 
	~"vútio-pci.h
"

25 
	~"vútio-rög.h
"

27 
	$vp_föd_vq
(
iﬂddr
, 
queue_ödex
,

28 
vrög_vútqueue
 **
p_vq
)

30 
u16
 
num
;

32 
	`ASSERT32FLAT
();

33 
vrög_vútqueue
 *
vq
 = *
p_vq
 = 
	`memÆign_low
(
PAGE_SIZE
, (*vq));

34 i‡(!
vq
) {

35 
	`w¨n_nﬂŒoc
();

36 
Áû
;

38 
	`mem£t
(
vq
, 0, (*vq));

42 
	`outw
(
queue_ödex
, 
iﬂddr
 + 
VIRTIO_PCI_QUEUE_SEL
);

46 
num
 = 
	`öw
(
iﬂddr
 + 
VIRTIO_PCI_QUEUE_NUM
);

47 i‡(!
num
) {

48 
	`d¥ötf
(1, "ERROR: queue size is 0\n");

49 
Áû
;

52 i‡(
num
 > 
MAX_QUEUE_NUM
) {

53 
	`d¥ötf
(1, "ERROR: queuêsizê%d > %d\n", 
num
, 
MAX_QUEUE_NUM
);

54 
Áû
;

59 i‡(
	`öl
(
iﬂddr
 + 
VIRTIO_PCI_QUEUE_PFN
)) {

60 
	`d¥ötf
(1, "ERROR: queueálreadyáctive\n");

61 
Áû
;

64 
vq
->
queue_ödex
 = queue_index;

68 
vrög
 * 
vr
 = &
vq
->vring;

69 
	`vrög_öô
(
vr
, 
num
, (*)&
vq
->
queue
);

76 
	`oué
(()
	`vút_to_phys
(
vr
->
desc
Ë>> 
PAGE_SHIFT
,

77 
iﬂddr
 + 
VIRTIO_PCI_QUEUE_PFN
);

79  
num
;

81 
Áû
:

82 
	`‰ì
(
vq
);

83 *
p_vq
 = 
NULL
;

85 
	}
}

87 
u16
 
	$vp_öô_sim∂e
(
u16
 
bdf
)

89 
u16
 
iﬂddr
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_BASE_ADDRESS_0
) &

90 
PCI_BASE_ADDRESS_IO_MASK
;

92 
	`vp_ª£t
(
iﬂddr
);

93 
	`pci_c⁄fig_maskw
(
bdf
, 
PCI_COMMAND
, 0, 
PCI_COMMAND_MASTER
);

94 
	`vp_£t_°©us
(
iﬂddr
, 
VIRTIO_CONFIG_S_ACKNOWLEDGE
 |

95 
VIRTIO_CONFIG_S_DRIVER
 );

96  
iﬂddr
;

97 
	}
}

	@hw/virtio-pci.h

1 #i‚de‡
_VIRTIO_PCI_H


2 
	#_VIRTIO_PCI_H


	)

4 
	~"x86.h
"

7 
	#VIRTIO_PCI_HOST_FEATURES
 0

	)

10 
	#VIRTIO_PCI_GUEST_FEATURES
 4

	)

13 
	#VIRTIO_PCI_QUEUE_PFN
 8

	)

16 
	#VIRTIO_PCI_QUEUE_NUM
 12

	)

19 
	#VIRTIO_PCI_QUEUE_SEL
 14

	)

22 
	#VIRTIO_PCI_QUEUE_NOTIFY
 16

	)

25 
	#VIRTIO_PCI_STATUS
 18

	)

30 
	#VIRTIO_PCI_ISR
 19

	)

33 
	#VIRTIO_PCI_ISR_CONFIG
 0x2

	)

37 
	#VIRTIO_PCI_CONFIG
 20

	)

40 
	#VIRTIO_PCI_ABI_VERSION
 0

	)

42 
ölöe
 
u32
 
	$vp_gë_„©uªs
(
iﬂddr
)

44  
	`öl
(
iﬂddr
 + 
VIRTIO_PCI_HOST_FEATURES
);

45 
	}
}

47 
ölöe
 
	$vp_£t_„©uªs
(
iﬂddr
, 
u32
 
„©uªs
)

49 
	`oué
(
„©uªs
, 
iﬂddr
 + 
VIRTIO_PCI_GUEST_FEATURES
);

50 
	}
}

52 
ölöe
 
	$vp_gë
(
iﬂddr
, 
off£t
,

53 *
buf
, 
Àn
)

55 
u8
 *
±r
 = 
buf
;

56 
i
;

58 
i
 = 0; i < 
Àn
; i++)

59 
±r
[
i
] = 
	`öb
(
iﬂddr
 + 
VIRTIO_PCI_CONFIG
 + 
off£t
 + i);

60 
	}
}

62 
ölöe
 
u8
 
	$vp_gë_°©us
(
iﬂddr
)

64  
	`öb
(
iﬂddr
 + 
VIRTIO_PCI_STATUS
);

65 
	}
}

67 
ölöe
 
	$vp_£t_°©us
(
iﬂddr
, 
u8
 
°©us
)

69 i‡(
°©us
 == 0)

71 
	`outb
(
°©us
, 
iﬂddr
 + 
VIRTIO_PCI_STATUS
);

72 
	}
}

74 
ölöe
 
u8
 
	$vp_gë_i§
(
iﬂddr
)

76  
	`öb
(
iﬂddr
 + 
VIRTIO_PCI_ISR
);

77 
	}
}

79 
ölöe
 
	$vp_ª£t
(
iﬂddr
)

81 
	`outb
(0, 
iﬂddr
 + 
VIRTIO_PCI_STATUS
);

82 ()
	`öb
(
iﬂddr
 + 
VIRTIO_PCI_ISR
);

83 
	}
}

85 
ölöe
 
	$vp_nŸify
(
iﬂddr
, 
queue_ödex
)

87 
	`outw
(
queue_ödex
, 
iﬂddr
 + 
VIRTIO_PCI_QUEUE_NOTIFY
);

88 
	}
}

90 
ölöe
 
	$vp_dñ_vq
(
iﬂddr
, 
queue_ödex
)

94 
	`outw
(
queue_ödex
, 
iﬂddr
 + 
VIRTIO_PCI_QUEUE_SEL
);

98 
	`oué
(0, 
iﬂddr
 + 
VIRTIO_PCI_QUEUE_PFN
);

99 
	}
}

101 
	gvrög_vútqueue
;

102 
u16
 
vp_öô_sim∂e
(u16 
bdf
);

103 
vp_föd_vq
(
iﬂddr
, 
queue_ödex
,

104 
vrög_vútqueue
 **
p_vq
);

	@hw/virtio-ring.c

19 
	~"biosv¨.h
"

20 
	~"ouçut.h
"

21 
	~"vútio-rög.h
"

22 
	~"vútio-pci.h
"

24 
	#BUG
() do { \

25 
	`∑nic
("BUG: faûuªáà%d/%s()!\n", 
__LINE__
, 
__func__
); \

26 } 0)

	)

27 
	#BUG_ON
(
c⁄dôi⁄
Ëdÿ{ i‡(c⁄dôi⁄Ë
	`BUG
(); } 0)

	)

36 
	$vrög_m‹e_u£d
(
vrög_vútqueue
 *
vq
)

38 
vrög_u£d
 *
u£d
 = 
	`GET_LOWFLAT
(
vq
->
vrög
.used);

39 
m‹e
 = 
	`GET_LOWFLAT
(
vq
->
œ°_u£d_idx
Ë!GET_LOWFLAT(
u£d
->
idx
);

41 
	`smp_rmb
();

42  
m‹e
;

43 
	}
}

51 
	$vrög_dëach
(
vrög_vútqueue
 *
vq
, 
hód
)

53 
vrög
 *
vr
 = &
vq
->vring;

54 
vrög_desc
 *
desc
 = 
	`GET_LOWFLAT
(
vr
->desc);

55 
i
;

59 
i
 = 
hód
;

60 
	`GET_LOWFLAT
(
desc
[
i
].
Êags
Ë& 
VRING_DESC_F_NEXT
)

61 
i
 = 
	`GET_LOWFLAT
(
desc
[i].
√xt
);

65 
	`SET_LOWFLAT
(
desc
[
i
].
√xt
, 
	`GET_LOWFLAT
(
vq
->
‰ì_hód
));

66 
	`SET_LOWFLAT
(
vq
->
‰ì_hód
, 
hód
);

67 
	}
}

76 
	$vrög_gë_buf
(
vrög_vútqueue
 *
vq
, *
Àn
)

78 
vrög
 *
vr
 = &
vq
->vring;

79 
vrög_u£d_ñem
 *
ñem
;

80 
vrög_u£d
 *
u£d
 = 
	`GET_LOWFLAT
(
vq
->
vrög
.used);

81 
u32
 
id
;

82 
ªt
;

86 
ñem
 = &
u£d
->
rög
[
	`GET_LOWFLAT
(
vq
->
œ°_u£d_idx
Ë% GET_LOWFLAT(
vr
->
num
)];

87 
id
 = 
	`GET_LOWFLAT
(
ñem
->id);

88 i‡(
Àn
 !
NULL
)

89 *
Àn
 = 
	`GET_LOWFLAT
(
ñem
->len);

91 
ªt
 = 
	`GET_LOWFLAT
(
vq
->
vd©a
[
id
]);

93 
	`vrög_dëach
(
vq
, 
id
);

95 
	`SET_LOWFLAT
(
vq
->
œ°_u£d_idx
, 
	`GET_LOWFLAT
(vq->last_used_idx) + 1);

97  
ªt
;

98 
	}
}

100 
	$vrög_add_buf
(
vrög_vútqueue
 *
vq
,

101 
vrög_li°
 
li°
[],

102 
out
, 
ö
,

103 
ödex
, 
num_added
)

105 
vrög
 *
vr
 = &
vq
->vring;

106 
i
, 
av
, 
hód
, 
¥ev
;

107 
vrög_desc
 *
desc
 = 
	`GET_LOWFLAT
(
vr
->desc);

108 
vrög_avaû
 *
avaû
 = 
	`GET_LOWFLAT
(
vr
->avail);

110 
	`BUG_ON
(
out
 + 
ö
 == 0);

112 
¥ev
 = 0;

113 
hód
 = 
	`GET_LOWFLAT
(
vq
->
‰ì_hód
);

114 
i
 = 
hód
; 
out
; i = 
	`GET_LOWFLAT
(
desc
[i].
√xt
), out--) {

115 
	`SET_LOWFLAT
(
desc
[
i
].
Êags
, 
VRING_DESC_F_NEXT
);

116 
	`SET_LOWFLAT
(
desc
[
i
].
addr
, (
u64
)
	`vút_to_phys
(
li°
->addr));

117 
	`SET_LOWFLAT
(
desc
[
i
].
Àn
, 
li°
->
Àngth
);

118 
¥ev
 = 
i
;

119 
li°
++;

121  ; 
ö
; 
i
 = 
	`GET_LOWFLAT
(
desc
[i].
√xt
), in--) {

122 
	`SET_LOWFLAT
(
desc
[
i
].
Êags
, 
VRING_DESC_F_NEXT
|
VRING_DESC_F_WRITE
);

123 
	`SET_LOWFLAT
(
desc
[
i
].
addr
, (
u64
)
	`vút_to_phys
(
li°
->addr));

124 
	`SET_LOWFLAT
(
desc
[
i
].
Àn
, 
li°
->
Àngth
);

125 
¥ev
 = 
i
;

126 
li°
++;

128 
	`SET_LOWFLAT
(
desc
[
¥ev
].
Êags
,

129 
	`GET_LOWFLAT
(
desc
[
¥ev
].
Êags
Ë& ~
VRING_DESC_F_NEXT
);

131 
	`SET_LOWFLAT
(
vq
->
‰ì_hód
, 
i
);

133 
	`SET_LOWFLAT
(
vq
->
vd©a
[
hód
], 
ödex
);

135 
av
 = (
	`GET_LOWFLAT
(
avaû
->
idx
Ë+ 
num_added
Ë% GET_LOWFLAT(
vr
->
num
);

136 
	`SET_LOWFLAT
(
avaû
->
rög
[
av
], 
hód
);

137 
	}
}

139 
	$vrög_kick
(
iﬂddr
, 
vrög_vútqueue
 *
vq
, 
num_added
)

141 
vrög
 *
vr
 = &
vq
->vring;

142 
vrög_avaû
 *
avaû
 = 
	`GET_LOWFLAT
(
vr
->avail);

145 
	`smp_wmb
();

146 
	`SET_LOWFLAT
(
avaû
->
idx
, 
	`GET_LOWFLAT
◊vaû->idxË+ 
num_added
);

148 
	`vp_nŸify
(
iﬂddr
, 
	`GET_LOWFLAT
(
vq
->
queue_ödex
));

149 
	}
}

	@hw/virtio-ring.h

1 #i‚de‡
_VIRTIO_RING_H


2 
	#_VIRTIO_RING_H


	)

4 
	~"ty≥s.h
"

5 
	~"memm≠.h
"

7 
	#PAGE_SHIFT
 12

	)

8 
	#PAGE_MASK
 (
PAGE_SIZE
-1)

	)

10 
	#vút_to_phys
(
v
Ë()(v)

	)

11 
	#phys_to_vút
(
p
Ë(*)’)

	)

13 
	#smp_rmb
(Ë
	`b¨rõr
()

	)

14 
	#smp_wmb
(Ë
	`b¨rõr
()

	)

18 
	#VIRTIO_CONFIG_S_ACKNOWLEDGE
 1

	)

20 
	#VIRTIO_CONFIG_S_DRIVER
 2

	)

22 
	#VIRTIO_CONFIG_S_DRIVER_OK
 4

	)

24 
	#VIRTIO_CONFIG_S_FAILED
 0x80

	)

26 
	#MAX_QUEUE_NUM
 (128)

	)

28 
	#VRING_DESC_F_NEXT
 1

	)

29 
	#VRING_DESC_F_WRITE
 2

	)

31 
	#VRING_AVAIL_F_NO_INTERRUPT
 1

	)

33 
	#VRING_USED_F_NO_NOTIFY
 1

	)

35 
	svrög_desc


37 
u64
 
	maddr
;

38 
u32
 
	mÀn
;

39 
u16
 
	mÊags
;

40 
u16
 
	m√xt
;

43 
	svrög_avaû


45 
u16
 
	mÊags
;

46 
u16
 
	midx
;

47 
u16
 
	mrög
[0];

50 
	svrög_u£d_ñem


52 
u32
 
	mid
;

53 
u32
 
	mÀn
;

56 
	svrög_u£d


58 
u16
 
	mÊags
;

59 
u16
 
	midx
;

60 
vrög_u£d_ñem
 
	mrög
[];

63 
	svrög
 {

64 
	mnum
;

65 
vrög_desc
 *
	mdesc
;

66 
vrög_avaû
 *
	mavaû
;

67 
vrög_u£d
 *
	mu£d
;

70 
	#vrög_size
(
num
) \

71 ((((((
vrög_desc
Ë* 
num
) + \

72 ((
vrög_avaû
Ë+ (
u16
Ë* 
num
)) \

73 + 
PAGE_MASK
) & ~PAGE_MASK) + \

74 ((
vrög_u£d
Ë+ (
vrög_u£d_ñem
Ë* 
num
))

	)

76 
	tvútio_queue_t
[
vrög_size
(
MAX_QUEUE_NUM
)];

78 
	svrög_vútqueue
 {

79 
vútio_queue_t
 
	mqueue
;

80 
vrög
 
	mvrög
;

81 
u16
 
	m‰ì_hód
;

82 
u16
 
	mœ°_u£d_idx
;

83 
u16
 
	mvd©a
[
MAX_QUEUE_NUM
];

85 
	mqueue_ödex
;

88 
	svrög_li°
 {

89 *
	maddr
;

90 
	mÀngth
;

93 
ölöe
 
	$vrög_öô
(
vrög
 *
vr
,

94 
num
, *
queue
)

96 
i
;

97 
∑
;

99 
	`ASSERT32FLAT
();

100 
vr
->
num
 =Çum;

104 
∑
 = 
	`vút_to_phys
(
queue
);

105 
∑
 = (∑ + 
PAGE_MASK
) & ~PAGE_MASK;

106 
vr
->
desc
 = 
	`phys_to_vút
(
∑
);

108 
vr
->
avaû
 = (
vrög_avaû
 *)&vr->
desc
[
num
];

110 
vr
->
avaû
->
Êags
 |
VRING_AVAIL_F_NO_INTERRUPT
;

114 
∑
 = 
	`vút_to_phys
(&
vr
->
avaû
->
rög
[
num
]);

115 
∑
 = (∑ + 
PAGE_MASK
) & ~PAGE_MASK;

116 
vr
->
u£d
 = 
	`phys_to_vút
(
∑
);

118 
i
 = 0; i < 
num
 - 1; i++)

119 
vr
->
desc
[
i
].
√xt
 = i + 1;

120 
vr
->
desc
[
i
].
√xt
 = 0;

121 
	}
}

123 
vrög_m‹e_u£d
(
vrög_vútqueue
 *
vq
);

124 
vrög_dëach
(
vrög_vútqueue
 *
vq
, 
hód
);

125 
vrög_gë_buf
(
vrög_vútqueue
 *
vq
, *
Àn
);

126 
vrög_add_buf
(
vrög_vútqueue
 *
vq
, 
vrög_li°
 
li°
[],

127 
out
, 
ö
,

128 
ödex
, 
num_added
);

129 
vrög_kick
(
iﬂddr
, 
vrög_vútqueue
 *
vq
, 
num_added
);

	@hw/virtio-scsi.c

10 
	~"biosv¨.h
"

11 
	~"block.h
"

12 
	~"blockcmd.h
"

13 
	~"c⁄fig.h
"

14 
	~"mÆloc.h
"

15 
	~"ouçut.h
"

16 
	~"pci.h
"

17 
	~"pci_ids.h
"

18 
	~"pci_ªgs.h
"

19 
	~"°d/disk.h
"

20 
	~"°rög.h
"

21 
	~"utû.h
"

22 
	~"vútio-pci.h
"

23 
	~"vútio-rög.h
"

24 
	~"vútio-scsi.h
"

26 
	svútio_lun_s
 {

27 
drive_s
 
	mdrive
;

28 
pci_devi˚
 *
	mpci
;

29 
vrög_vútqueue
 *
	mvq
;

30 
u16
 
	miﬂddr
;

31 
u16
 
	mèrgë
;

32 
u16
 
	mlun
;

36 
	$vútio_scsi_cmd
(
u16
 
iﬂddr
, 
vrög_vútqueue
 *
vq
, 
disk_›_s
 *
›
,

37 *
cdbcmd
, 
u16
 
èrgë
, u16 
lun
, u16 
blocksize
)

39 
vútio_scsi_ªq_cmd
 
ªq
;

40 
vútio_scsi_ª•_cmd
 
ª•
;

41 
vrög_li°
 
sg
[3];

43 
	`mem£t
(&
ªq
, 0, (req));

44 
ªq
.
lun
[0] = 1;

45 
ªq
.
lun
[1] = 
èrgë
;

46 
ªq
.
lun
[2] = (lun >> 8) | 0x40;

47 
ªq
.
lun
[3] = (lun & 0xff);

48 
	`mem˝y
(
ªq
.
cdb
, 
cdbcmd
, 16);

50 
u32
 
Àn
 = 
›
->
cou¡
 * 
blocksize
;

51 
d©aö
 = 
	`cdb_is_ªad
(
cdbcmd
, 
blocksize
);

52 
ö_num
 = (
d©aö
 ? 2 : 1);

53 
out_num
 = (
Àn
 ? 3 : 2Ë- 
ö_num
;

55 
sg
[0].
addr
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ªq
);

56 
sg
[0].
Àngth
 = (
ªq
);

58 
sg
[
out_num
].
addr
 = 
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
ª•
);

59 
sg
[
out_num
].
Àngth
 = (
ª•
);

61 i‡(
Àn
) {

62 
d©a_idx
 = (
d©aö
 ? 2 : 1);

63 
sg
[
d©a_idx
].
addr
 = 
›
->
buf_Ê
;

64 
sg
[
d©a_idx
].
Àngth
 = 
Àn
;

68 
	`vrög_add_buf
(
vq
, 
sg
, 
out_num
, 
ö_num
, 0, 0);

69 
	`vrög_kick
(
iﬂddr
, 
vq
, 1);

72 !
	`vrög_m‹e_u£d
(
vq
))

73 
	`u¶ìp
(5);

76 
	`vrög_gë_buf
(
vq
, 
NULL
);

81 
	`vp_gë_i§
(
iﬂddr
);

83 i‡(
ª•
.
ª•⁄£
 =
VIRTIO_SCSI_S_OK
 &&Ñe•.
°©us
 == 0) {

84  
DISK_RET_SUCCESS
;

86  
DISK_RET_EBADTRACK
;

87 
	}
}

90 
	$vútio_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
)

92 
vútio_lun_s
 *
vlun_gf
 =

93 
	`c⁄èöî_of
(
›
->
drive_gf
, 
vútio_lun_s
, 
drive
);

95  
	`vútio_scsi_cmd
(
	`GET_GLOBALFLAT
(
vlun_gf
->
iﬂddr
),

96 
	`GET_GLOBALFLAT
(
vlun_gf
->
vq
), 
›
, 
cdbcmd
,

97 
	`GET_GLOBALFLAT
(
vlun_gf
->
èrgë
),

98 
	`GET_GLOBALFLAT
(
vlun_gf
->
lun
),

99 
blocksize
);

100 
	}
}

103 
	$vútio_scsi_add_lun
(
pci_devi˚
 *
pci
, 
u16
 
iﬂddr
,

104 
vrög_vútqueue
 *
vq
, 
u16
 
èrgë
, u16 
lun
)

106 
vútio_lun_s
 *
vlun
 = 
	`mÆloc_f£g
((*vlun));

107 i‡(!
vlun
) {

108 
	`w¨n_nﬂŒoc
();

111 
	`mem£t
(
vlun
, 0, (*vlun));

112 
vlun
->
drive
.
ty≥
 = 
DTYPE_VIRTIO_SCSI
;

113 
vlun
->
drive
.
˙é_id
 = 
pci
->
bdf
;

114 
vlun
->
pci
 =Öci;

115 
vlun
->
iﬂddr
 = ioaddr;

116 
vlun
->
vq
 = vq;

117 
vlun
->
èrgë
 =Åarget;

118 
vlun
->
lun
 =Üun;

120 
¥io
 = 
	`boŸ¥io_föd_scsi_devi˚
(
pci
, 
èrgë
, 
lun
);

121 
ªt
 = 
	`scsi_drive_£tup
(&
vlun
->
drive
, "vútio-scsi", 
¥io
);

122 i‡(
ªt
)

123 
Áû
;

126 
Áû
:

127 
	`‰ì
(
vlun
);

129 
	}
}

132 
	$vútio_scsi_sˇn_èrgë
(
pci_devi˚
 *
pci
, 
u16
 
iﬂddr
,

133 
vrög_vútqueue
 *
vq
, 
u16
 
èrgë
)

136 
ªt
 = 
	`vútio_scsi_add_lun
(
pci
, 
iﬂddr
, 
vq
, 
èrgë
, 0);

137  
ªt
 < 0 ? 0 : 1;

138 
	}
}

141 
	$öô_vútio_scsi
(
pci_devi˚
 *
pci
)

143 
u16
 
bdf
 = 
pci
->bdf;

144 
	`d¥ötf
(1, "found vútio-scsò© %x:%x\n", 
	`pci_bdf_to_bus
(
bdf
),

145 
	`pci_bdf_to_dev
(
bdf
));

146 
vrög_vútqueue
 *
vq
 = 
NULL
;

147 
u16
 
iﬂddr
 = 
	`vp_öô_sim∂e
(
bdf
);

148 i‡(
	`vp_föd_vq
(
iﬂddr
, 2, &
vq
) < 0 ) {

149 
	`d¥ötf
(1, "failÅo find vq for virtio-scsi %x:%x\n",

150 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf));

151 
Áû
;

154 
	`vp_£t_°©us
(
iﬂddr
, 
VIRTIO_CONFIG_S_ACKNOWLEDGE
 |

155 
VIRTIO_CONFIG_S_DRIVER
 | 
VIRTIO_CONFIG_S_DRIVER_OK
);

157 
i
, 
tŸ
;

158 
tŸ
 = 0, 
i
 = 0; i < 256; i++)

159 
tŸ
 +
	`vútio_scsi_sˇn_èrgë
(
pci
, 
iﬂddr
, 
vq
, 
i
);

161 i‡(!
tŸ
)

162 
Áû
;

166 
Áû
:

167 
	`vp_ª£t
(
iﬂddr
);

168 
	`‰ì
(
vq
);

169 
	}
}

172 
	$vútio_scsi_£tup
()

174 
	`ASSERT32FLAT
();

175 i‡(! 
CONFIG_VIRTIO_SCSI
)

178 
	`d¥ötf
(3, "init virtio-scsi\n");

180 
pci_devi˚
 *
pci
;

181 
	`f‹óchpci
(
pci
) {

182 i‡(
pci
->
víd‹
 !
PCI_VENDOR_ID_REDHAT_QUMRANET


183 || 
pci
->
devi˚
 !
PCI_DEVICE_ID_VIRTIO_SCSI
)

185 
	`öô_vútio_scsi
(
pci
);

187 
	}
}

	@hw/virtio-scsi.h

1 #i‚de‡
_VIRTIO_SCSI_H


2 
	#_VIRTIO_SCSI_H


	)

4 
	#VIRTIO_SCSI_CDB_SIZE
 32

	)

5 
	#VIRTIO_SCSI_SENSE_SIZE
 96

	)

7 
	svútio_scsi_c⁄fig


9 
u32
 
	mnum_queues
;

10 
u32
 
	m£g_max
;

11 
u32
 
	mmax_£˘‹s
;

12 
u32
 
	mcmd_≥r_lun
;

13 
u32
 
	mevít_öfo_size
;

14 
u32
 
	m£n£_size
;

15 
u32
 
	mcdb_size
;

16 
u16
 
	mmax_ch™√l
;

17 
u16
 
	mmax_èrgë
;

18 
u32
 
	mmax_lun
;

19 } 
__©åibuã__
((
∑cked
));

22 
	svútio_scsi_ªq_cmd
 {

23 
u8
 
	mlun
[8];

24 
u64
 
	mid
;

25 
u8
 
	mèsk_©å
;

26 
u8
 
	m¥io
;

27 
u8
 
	m¸n
;

28 
	mcdb
[
VIRTIO_SCSI_CDB_SIZE
];

29 } 
__©åibuã__
((
∑cked
));

32 
	svútio_scsi_ª•_cmd
 {

33 
u32
 
	m£n£_Àn
;

34 
u32
 
	mªsiduÆ
;

35 
u16
 
	m°©us_quÆifõr
;

36 
u8
 
	m°©us
;

37 
u8
 
	mª•⁄£
;

38 
u8
 
	m£n£
[
VIRTIO_SCSI_SENSE_SIZE
];

39 } 
__©åibuã__
((
∑cked
));

41 
	#VIRTIO_SCSI_S_OK
 0

	)

43 
	gdisk_›_s
;

44 
vútio_scsi_cmd_d©a
(
disk_›_s
 *
›
, *
cdbcmd
, 
u16
 
blocksize
);

45 
vútio_scsi_£tup
();

	@jpeg.c

42 
	#__LITTLE_ENDIAN


	)

43 
	~"mÆloc.h
"

44 
	~"°rög.h
"

45 
	~"utû.h
"

46 
	#ISHIFT
 11

	)

48 
	#IFIX
(
a
Ë(()(◊Ë* (1 << 
ISHIFT
Ë+ .5))

	)

49 
	#IMULT
(
a
, 
b
Ë((◊Ë* (b)Ë>> 
ISHIFT
)

	)

50 
	#ITOINT
(
a
Ë(◊Ë>> 
ISHIFT
)

	)

52 #i‚de‡
__P


53 
	#__P
(
x
Ë
	)
x

57 
	#M_BADHUFF
 -1

	)

58 
	#M_EOF
 0x80

	)

60 
	sö
 {

61 *
	mp
;

62 
	mbôs
;

63 
	mÀ·
;

64 
	mm¨kî
;

66 (*
	mfunc
Ë
__P
((*));

67 *
	md©a
;

71 
	gdec_huf·bl
;

72 
	gíc_huf·bl
;

74 
	uhuf·bÕ
 {

75 
dec_huf·bl
 *
	mdhuff
;

76 
íc_huf·bl
 *
	mehuff
;

79 
	ssˇn
 {

80 
	mdc
;

82 
huf·bÕ
 
	mhudc
;

83 
huf·bÕ
 
	mhuac
;

84 
	m√xt
;

86 
	mcid
;

87 
	mhv
;

88 
	mtq
;

93 
	#DECBITS
 10

	)

95 
	sdec_huf·bl
 {

96 
	mmaxcode
[17];

97 
	mvÆ±r
[16];

98 
	mvÆs
[256];

99 
	mŒvÆs
[1 << 
DECBITS
];

102 
decode_mcus
 
__P
((
ö
 *, *, , 
sˇn
 *, *));

103 
dec_ªadm¨kî
 
__P
((
ö
 *));

104 
dec_makehuff
 
__P
((
dec_huf·bl
 *, *, *));

106 
£töput
 
__P
((
ö
 *, *));

109 #unde‡
PREC


110 
	#PREC
 

	)

112 
id˘qèb
 
__P
((*, 
PREC
 *));

113 
id˘
 
__P
((*, *, 
PREC
 *, PREC, ));

114 
sˇÀid˘qèb
 
__P
((
PREC
 *, PREC));

118 
öôcﬁ
 
__P
((
PREC
[][64]));

120 
cﬁ221111
 
__P
((*, *, ));

121 
cﬁ221111_16
 
__P
((*, *, ));

122 
cﬁ221111_32
 
__P
((*, *, ));

126 
	#ERR_NO_SOI
 1

	)

127 
	#ERR_NOT_8BIT
 2

	)

128 
	#ERR_HEIGHT_MISMATCH
 3

	)

129 
	#ERR_WIDTH_MISMATCH
 4

	)

130 
	#ERR_BAD_WIDTH_OR_HEIGHT
 5

	)

131 
	#ERR_TOO_MANY_COMPPS
 6

	)

132 
	#ERR_ILLEGAL_HV
 7

	)

133 
	#ERR_QUANT_TABLE_SELECTOR
 8

	)

134 
	#ERR_NOT_YCBCR_221111
 9

	)

135 
	#ERR_UNKNOWN_CID_IN_SCAN
 10

	)

136 
	#ERR_NOT_SEQUENTIAL_DCT
 11

	)

137 
	#ERR_WRONG_MARKER
 12

	)

138 
	#ERR_NO_EOI
 13

	)

139 
	#ERR_BAD_TABLES
 14

	)

140 
	#ERR_DEPTH_MISMATCH
 15

	)

144 
	#M_SOI
 0xd8

	)

145 
	#M_APP0
 0xe0

	)

146 
	#M_DQT
 0xdb

	)

147 
	#M_SOF0
 0xc0

	)

148 
	#M_DHT
 0xc4

	)

149 
	#M_DRI
 0xdd

	)

150 
	#M_SOS
 0xda

	)

151 
	#M_RST0
 0xd0

	)

152 
	#M_EOI
 0xd9

	)

153 
	#M_COM
 0x„

	)

155 
	scomp
 {

156 
	mcid
;

157 
	mhv
;

158 
	mtq
;

161 
	#MAXCOMP
 4

	)

162 
	sjpgöfo
 {

163 
	mnc
;

164 
	mns
;

165 
	mdri
;

166 
	mnm
;

167 
	mrm
;

170 
	sj≥g_decd©a
 {

171 
	md˘s
[6 * 64 + 16];

172 
	mout
[64 * 6];

173 
	mdqu™t
[3][64];

175 *
	md©≠
;

176 
jpgöfo
 
	möfo
;

177 
comp
 
	mcomps
[
MAXCOMP
];

178 
sˇn
 
	mdsˇns
[
MAXCOMP
];

179 
	mqu™t
[4][64];

180 
dec_huf·bl
 
	mdhuff
[4];

181 
ö
 
	mö
;

183 
	mheight
, 
	mwidth
;

186 
	$gëbyã
(
j≥g_decd©a
 *
j≥g
)

188  *
j≥g
->
d©≠
++;

189 
	}
}

191 
	$gëw‹d
(
j≥g_decd©a
 *
j≥g
)

193 
c1
, 
c2
;

194 
c1
 = *
j≥g
->
d©≠
++;

195 
c2
 = *
j≥g
->
d©≠
++;

196  
c1
 << 8 | 
c2
;

197 
	}
}

199 
	$ªadèbÀs
(
j≥g_decd©a
 *
j≥g
, 
tûl
)

201 
m
, 
l
, 
i
, 
j
, 
lq
, 
pq
, 
tq
;

202 
tc
, 
th
, 
â
;

205 i‡(
	`gëbyã
(
j≥g
) != 0xff)

207 i‡((
m
 = 
	`gëbyã
(
j≥g
)Ë=
tûl
)

210 
m
) {

214 
M_DQT
:

215 
lq
 = 
	`gëw‹d
(
j≥g
);

216 
lq
 > 2) {

217 
pq
 = 
	`gëbyã
(
j≥g
);

218 
tq
 = 
pq
 & 15;

219 i‡(
tq
 > 3)

221 
pq
 >>= 4;

222 i‡(
pq
 != 0)

224 
i
 = 0; i < 64; i++)

225 
j≥g
->
qu™t
[
tq
][
i
] = 
	`gëbyã
(jpeg);

226 
lq
 -= 64 + 1;

230 
M_DHT
:

231 
l
 = 
	`gëw‹d
(
j≥g
);

232 
l
 > 2) {

233 
hufÊí
[16], 
k
;

234 
huffvÆs
[256];

236 
tc
 = 
	`gëbyã
(
j≥g
);

237 
th
 = 
tc
 & 15;

238 
tc
 >>= 4;

239 
â
 = 
tc
 * 2 + 
th
;

240 i‡(
tc
 > 1 || 
th
 > 1)

242 
i
 = 0; i < 16; i++)

243 
hufÊí
[
i
] = 
	`gëbyã
(
j≥g
);

244 
l
 -= 1 + 16;

245 
k
 = 0;

246 
i
 = 0; i < 16; i++) {

247 
j
 = 0; j < 
hufÊí
[
i
]; j++)

248 
huffvÆs
[
k
++] = 
	`gëbyã
(
j≥g
);

249 
l
 -
hufÊí
[
i
];

251 
	`dec_makehuff
(
j≥g
->
dhuff
 + 
â
, 
hufÊí
, 
huffvÆs
);

255 
M_DRI
:

256 
l
 = 
	`gëw‹d
(
j≥g
);

257 
j≥g
->
öfo
.
dri
 = 
	`gëw‹d
(jpeg);

261 
l
 = 
	`gëw‹d
(
j≥g
);

262 
l
-- > 2)

263 
	`gëbyã
(
j≥g
);

268 
	}
}

270 
	$dec_öôsˇns
(
j≥g_decd©a
 *
j≥g
)

272 
i
;

274 
j≥g
->
öfo
.
nm
 = j≥g->öfo.
dri
 + 1;

275 
j≥g
->
öfo
.
rm
 = 
M_RST0
;

276 
i
 = 0; i < 
j≥g
->
öfo
.
ns
; i++)

277 
j≥g
->
dsˇns
[
i
].
dc
 = 0;

278 
	}
}

280 
	$dec_checkm¨kî
(
j≥g_decd©a
 *
j≥g
)

282 
i
;

284 i‡(
	`dec_ªadm¨kî
(&
j≥g
->
ö
Ë!j≥g->
öfo
.
rm
)

286 
j≥g
->
öfo
.
nm
 = j≥g->öfo.
dri
;

287 
j≥g
->
öfo
.
rm
 = (jpeg->info.rm + 1) & ~0x08;

288 
i
 = 0; i < 
j≥g
->
öfo
.
ns
; i++)

289 
j≥g
->
dsˇns
[
i
].
dc
 = 0;

291 
	}
}

293 
j≥g_decd©a
 *
	$j≥g_Æloc
()

295 
j≥g_decd©a
 *
j≥g
 = 
	`mÆloc_tmphigh
((*jpeg));

296  
j≥g
;

297 
	}
}

299 
	$j≥g_decode
(
j≥g_decd©a
 *
j≥g
, *
buf
)

301 
i
, 
j
, 
m
, 
èc
, 
tdc
;

303 i‡(!
j≥g
 || !
buf
)

305 
j≥g
->
d©≠
 = 
buf
;

306 i‡(
	`gëbyã
(
j≥g
) != 0xff)

307  
ERR_NO_SOI
;

308 i‡(
	`gëbyã
(
j≥g
Ë!
M_SOI
)

309  
ERR_NO_SOI
;

310 i‡(
	`ªadèbÀs
(
j≥g
, 
M_SOF0
))

311  
ERR_BAD_TABLES
;

312 
	`gëw‹d
(
j≥g
);

313 
i
 = 
	`gëbyã
(
j≥g
);

314 i‡(
i
 != 8)

315  
ERR_NOT_8BIT
;

316 
j≥g
->
height
 = 
	`gëw‹d
(jpeg);

317 
j≥g
->
width
 = 
	`gëw‹d
(jpeg);

318 i‡((
j≥g
->
height
 & 15Ë|| (j≥g->
width
 & 15))

319  
ERR_BAD_WIDTH_OR_HEIGHT
;

320 
j≥g
->
öfo
.
nc
 = 
	`gëbyã
(jpeg);

321 i‡(
j≥g
->
öfo
.
nc
 > 
MAXCOMP
)

322  
ERR_TOO_MANY_COMPPS
;

323 
i
 = 0; i < 
j≥g
->
öfo
.
nc
; i++) {

324 
h
, 
v
;

325 
j≥g
->
comps
[
i
].
cid
 = 
	`gëbyã
(jpeg);

326 
j≥g
->
comps
[
i
].
hv
 = 
	`gëbyã
(jpeg);

327 
v
 = 
j≥g
->
comps
[
i
].
hv
 & 15;

328 
h
 = 
j≥g
->
comps
[
i
].
hv
 >> 4;

329 
j≥g
->
comps
[
i
].
tq
 = 
	`gëbyã
(jpeg);

330 i‡(
h
 > 3 || 
v
 > 3)

331  
ERR_ILLEGAL_HV
;

332 i‡(
j≥g
->
comps
[
i
].
tq
 > 3)

333  
ERR_QUANT_TABLE_SELECTOR
;

335 i‡(
	`ªadèbÀs
(
j≥g
, 
M_SOS
))

336  
ERR_BAD_TABLES
;

337 
	`gëw‹d
(
j≥g
);

338 
j≥g
->
öfo
.
ns
 = 
	`gëbyã
(jpeg);

339 i‡(
j≥g
->
öfo
.
ns
 != 3)

340  
ERR_NOT_YCBCR_221111
;

341 
i
 = 0; i < 3; i++) {

342 
j≥g
->
dsˇns
[
i
].
cid
 = 
	`gëbyã
(jpeg);

343 
tdc
 = 
	`gëbyã
(
j≥g
);

344 
èc
 = 
tdc
 & 15;

345 
tdc
 >>= 4;

346 i‡(
tdc
 > 1 || 
èc
 > 1)

347  
ERR_QUANT_TABLE_SELECTOR
;

348 
j
 = 0; j < 
j≥g
->
öfo
.
nc
; j++)

349 i‡(
j≥g
->
comps
[
j
].
cid
 =j≥g->
dsˇns
[
i
].cid)

351 i‡(
j
 =
j≥g
->
öfo
.
nc
)

352  
ERR_UNKNOWN_CID_IN_SCAN
;

353 
j≥g
->
dsˇns
[
i
].
hv
 = j≥g->
comps
[
j
].hv;

354 
j≥g
->
dsˇns
[
i
].
tq
 = j≥g->
comps
[
j
].tq;

355 
j≥g
->
dsˇns
[
i
].
hudc
.
dhuff
 = &j≥g->dhuff[
tdc
];

356 
j≥g
->
dsˇns
[
i
].
huac
.
dhuff
 = &j≥g->dhuff[2 + 
èc
];

359 
i
 = 
	`gëbyã
(
j≥g
);

360 
j
 = 
	`gëbyã
(
j≥g
);

361 
m
 = 
	`gëbyã
(
j≥g
);

363 i‡(
i
 !0 || 
j
 !63 || 
m
 != 0)

364  
ERR_NOT_SEQUENTIAL_DCT
;

366 i‡(
j≥g
->
dsˇns
[0].
cid
 != 1 || jpeg->dscans[1].cid != 2

367 || 
j≥g
->
dsˇns
[2].
cid
 != 3)

368  
ERR_NOT_YCBCR_221111
;

370 i‡(
j≥g
->
dsˇns
[0].
hv
 != 0x22 || jpeg->dscans[1].hv != 0x11

371 || 
j≥g
->
dsˇns
[2].
hv
 != 0x11)

372  
ERR_NOT_YCBCR_221111
;

374 
	`id˘qèb
(
j≥g
->
qu™t
[j≥g->
dsˇns
[0].
tq
], j≥g->
dqu™t
[0]);

375 
	`id˘qèb
(
j≥g
->
qu™t
[j≥g->
dsˇns
[1].
tq
], j≥g->
dqu™t
[1]);

376 
	`id˘qèb
(
j≥g
->
qu™t
[j≥g->
dsˇns
[2].
tq
], j≥g->
dqu™t
[2]);

377 
	`öôcﬁ
(
j≥g
->
dqu™t
);

378 
	`£töput
(&
j≥g
->
ö
, j≥g->
d©≠
);

382 
img
[
Àn
] = 0;

383 
img
[
Àn
 + 1] = 0xff;

384 
img
[
Àn
 + 2] = 
M_EOF
;

387 
	`dec_öôsˇns
(
j≥g
);

390 
	}
}

392 
	$j≥g_gë_size
(
j≥g_decd©a
 *
j≥g
, *
width
, *
height
)

394 *
width
 = 
j≥g
->width;

395 *
height
 = 
j≥g
->height;

396 
	}
}

398 
	$j≥g_show
(
j≥g_decd©a
 *
j≥g
, *
pic
, 
width


399 , 
height
, 
dïth
, 
byãs_≥r_löe_de°
)

401 
m
, 
mcusx
, 
mcusy
, 
mx
, 
my
, 
mloff£t
, 
jpgb∂
;

402 
max
[6];

404 i‡(
j≥g
->
height
 != height)

405  
ERR_HEIGHT_MISMATCH
;

406 i‡(
j≥g
->
width
 != width)

407  
ERR_WIDTH_MISMATCH
;

409 
jpgb∂
 = 
width
 * 
dïth
 / 8;

410 
mloff£t
 = 
byãs_≥r_löe_de°
 > 
jpgb∂
 ? bytes_per_line_dest : jpgbpl;

412 
mcusx
 = 
j≥g
->
width
 >> 4;

413 
mcusy
 = 
j≥g
->
height
 >> 4;

415 
j≥g
->
dsˇns
[0].
√xt
 = 6 - 4;

416 
j≥g
->
dsˇns
[1].
√xt
 = 6 - 4 - 1;

417 
j≥g
->
dsˇns
[2].
√xt
 = 6 - 4 - 1 - 1;

418 
my
 = 0; my < 
mcusy
; my++) {

419 
mx
 = 0; mx < 
mcusx
; mx++) {

420 i‡(
j≥g
->
öfo
.
dri
 && !--j≥g->öfo.
nm
)

421 i‡(
	`dec_checkm¨kî
(
j≥g
))

422  
ERR_WRONG_MARKER
;

424 
	`decode_mcus
(&
j≥g
->
ö
, j≥g->
d˘s
, 6, j≥g->
dsˇns
, 
max
);

425 
	`id˘
(
j≥g
->
d˘s
, j≥g->
out
, j≥g->
dqu™t
[0],

426 
	`IFIX
(128.5), 
max
[0]);

427 
	`id˘
(
j≥g
->
d˘s
 + 64, j≥g->
out
 + 64, j≥g->
dqu™t
[0],

428 
	`IFIX
(128.5), 
max
[1]);

429 
	`id˘
(
j≥g
->
d˘s
 + 128, j≥g->
out
 + 128, j≥g->
dqu™t
[0],

430 
	`IFIX
(128.5), 
max
[2]);

431 
	`id˘
(
j≥g
->
d˘s
 + 192, j≥g->
out
 + 192, j≥g->
dqu™t
[0],

432 
	`IFIX
(128.5), 
max
[3]);

433 
	`id˘
(
j≥g
->
d˘s
 + 256, j≥g->
out
 + 256, j≥g->
dqu™t
[1],

434 
	`IFIX
(0.5), 
max
[4]);

435 
	`id˘
(
j≥g
->
d˘s
 + 320, j≥g->
out
 + 320, j≥g->
dqu™t
[2],

436 
	`IFIX
(0.5), 
max
[5]);

438 
dïth
) {

440 
	`cﬁ221111_32
(
j≥g
->
out
,

441 
pic
 + (
my
 * 16 * 
mloff£t
 + 
mx
 * 16 * 4),

442 
mloff£t
);

445 
	`cﬁ221111
(
j≥g
->
out
,

446 
pic
 + (
my
 * 16 * 
mloff£t
 + 
mx
 * 16 * 3),

447 
mloff£t
);

450 
	`cﬁ221111_16
(
j≥g
->
out
,

451 
pic
 + (
my
 * 16 * 
mloff£t
 + 
mx
 * 16 * 2),

452 
mloff£t
);

455  
ERR_DEPTH_MISMATCH
;

461 
m
 = 
	`dec_ªadm¨kî
(&
j≥g
->
ö
);

462 i‡(
m
 !
M_EOI
)

463  
ERR_NO_EOI
;

466 
	}
}

472 
fûlbôs
 
__P
((
ö
 *, , ));

473 
dec_ªc2
 
__P
((
ö
 *, 
dec_huf·bl
 *, *, , ));

475 
	$£töput
(
ö
 *ö, *
p
)

477 
ö
->
p
 =Ö;

478 
ö
->
À·
 = 0;

479 
ö
->
bôs
 = 0;

480 
ö
->
m¨kî
 = 0;

481 
	}
}

483 
	$fûlbôs
(
ö
 *ö, 
À
, 
bi
)

485 
b
, 
m
;

487 i‡(
ö
->
m¨kî
) {

488 i‡(
À
 <= 16)

489 
ö
->
bôs
 = 
bi
 << 16, 
À
 += 16;

490  
À
;

492 
À
 <= 24) {

493 
b
 = *
ö
->
p
++;

494 i‡(
b
 =0xf‡&& (
m
 = *
ö
->
p
++) != 0) {

495 i‡(
m
 =
M_EOF
) {

496 i‡(
ö
->
func
 && (
m
 = in->
	`func
(ö->
d©a
)) == 0)

499 
ö
->
m¨kî
 = 
m
;

500 i‡(
À
 <= 16)

501 
bi
 = bò<< 16, 
À
 += 16;

504 
bi
 = bò<< 8 | 
b
;

505 
À
 += 8;

507 
ö
->
bôs
 = 
bi
;

508  
À
;

509 
	}
}

511 
	$dec_ªadm¨kî
(
ö
 *in)

513 
m
;

515 
ö
->
À·
 = 
	`fûlbôs
(ö, in->À·, in->
bôs
);

516 i‡((
m
 = 
ö
->
m¨kî
) == 0)

518 
ö
->
À·
 = 0;

519 
ö
->
m¨kî
 = 0;

520  
m
;

521 
	}
}

523 
	#LEBI_DCL
 
À
, 
bi


	)

524 
	#LEBI_GET
(
ö
Ë(
À
 = in->
À·
, 
bi
 = in->
bôs
)

	)

525 
	#LEBI_PUT
(
ö
Ë(ö->
À·
 = 
À
, in->
bôs
 = 
bi
)

	)

527 
	#GETBITS
(
ö
, 
n
) ( \

528 (
À
 < (
n
Ë?Üê
	`fûlbôs
(
ö
,Üe, 
bi
), bòö->
bôs
 : 0), \

529 (
À
 -(
n
)), \

530 
bi
 >> 
À
 & ((1 << (
n
)) - 1) \

531 )

	)

533 
	#UNGETBITS
(
ö
, 
n
) ( \

534 
À
 +(
n
) \

535 )

	)

538 
	$dec_ªc2
(
ö
 *ö, 
dec_huf·bl
 *
hu
, *
ru≈
,

539 
c
, 
i
)

541 
LEBI_DCL
;

543 
	`LEBI_GET
(
ö
);

544 i‡(
i
) {

545 
	`UNGETBITS
(
ö
, 
i
 & 127);

546 *
ru≈
 = 
i
 >> 8 & 15;

547 
i
 >>= 16;

549 
i
 = 
DECBITS
;

550 (
c
 = ((¯<< 1Ë| 
	`GETBITS
(
ö
, 1))Ë>(
hu
->
maxcode
[
i
]); i++);

551 i‡(
i
 >= 16) {

552 
ö
->
m¨kî
 = 
M_BADHUFF
;

555 
i
 = 
hu
->
vÆs
[hu->
vÆ±r
[i] + 
c
 - hu->
maxcode
[i - 1] * 2];

556 *
ru≈
 = 
i
 >> 4;

557 
i
 &= 15;

559 i‡(
i
 == 0) {

560 
	`LEBI_PUT
(
ö
);

564 
c
 = 
	`GETBITS
(
ö
, 
i
);

565 i‡(
c
 < (1 << (
i
 - 1)))

566 
c
 +(-1 << 
i
) + 1;

567 
	`LEBI_PUT
(
ö
);

568  
c
;

569 
	}
}

571 
	#DEC_REC
(
ö
, 
hu
, 
r
, 
i
) ( \

572 
r
 = 
	`GETBITS
(
ö
, 
DECBITS
), \

573 
i
 = 
hu
->
ŒvÆs
[
r
], \

574 
i
 & 128 ? \

576 
	`UNGETBITS
(
ö
, 
i
 & 127), \

577 
r
 = 
i
 >> 8 & 15, \

578 
i
 >> 16 \

582 
	`LEBI_PUT
(
ö
), \

583 
i
 = 
	`dec_ªc2
(
ö
, 
hu
, &
r
,Ñ, i), \

584 
	`LEBI_GET
(
ö
), \

585 
i
 \

587 )

	)

589 
	$decode_mcus
(
ö
 *ö, *
d˘
, 
n
, 
sˇn
 *
sc
,

590 *
maxp
)

592 
dec_huf·bl
 *
hu
;

593 
i
, 
r
, 
t
;

594 
LEBI_DCL
;

596 
	`mem£t
(
d˘
, 0, 
n
 * 64 * (*dct));

597 
	`LEBI_GET
(
ö
);

598 
n
-- > 0) {

599 
hu
 = 
sc
->
hudc
.
dhuff
;

600 *
d˘
++ = (
sc
->
dc
 +
	`DEC_REC
(
ö
, 
hu
, 
r
, 
t
));

602 
hu
 = 
sc
->
huac
.
dhuff
;

603 
i
 = 63;

604 
i
 > 0) {

605 
t
 = 
	`DEC_REC
(
ö
, 
hu
, 
r
,Å);

606 i‡(
t
 =0 && 
r
 == 0) {

607 
d˘
 +
i
;

610 
d˘
 +
r
;

611 *
d˘
++ = 
t
;

612 
i
 -
r
 + 1;

614 *
maxp
++ = 64 - 
i
;

615 i‡(
n
 =
sc
->
√xt
)

616 
sc
++;

618 
	`LEBI_PUT
(
ö
);

619 
	}
}

621 
	$dec_makehuff
(
dec_huf·bl
 *
hu
, *
hufÊí
,

622 *
huffvÆs
)

624 
code
, 
k
, 
i
, 
j
, 
d
, 
x
, 
c
, 
v
;

625 
i
 = 0; i < (1 << 
DECBITS
); i++)

626 
hu
->
ŒvÆs
[
i
] = 0;

639 
code
 = 0;

640 
k
 = 0;

641 
i
 = 0; i < 16; i++, 
code
 <<= 1) {

642 
hu
->
vÆ±r
[
i
] = 
k
;

643 
j
 = 0; j < 
hufÊí
[
i
]; j++) {

644 
hu
->
vÆs
[
k
] = *
huffvÆs
++;

645 i‡(
i
 < 
DECBITS
) {

646 
c
 = 
code
 << (
DECBITS
 - 1 - 
i
);

647 
v
 = 
hu
->
vÆs
[
k
] & 0x0f;

648 
d
 = 1 << (
DECBITS
 - 1 - 
i
); --d >= 0;) {

649 i‡(
v
 + 
i
 < 
DECBITS
) {

650 
x
 = 
d
 >> (
DECBITS
 - 1 - 
v
 - 
i
);

651 i‡(
v
 && 
x
 < (1 << (v - 1)))

652 
x
 +(-1 << 
v
) + 1;

653 
x
 = x << 16 | (
hu
->
vÆs
[
k
] & 0xf0) << 4 |

654 (
DECBITS
 - (
i
 + 1 + 
v
)) | 128;

656 
x
 = 
v
 << 16 | (
hu
->
vÆs
[
k
] & 0xf0) << 4 |

657 (
DECBITS
 - (
i
 + 1));

658 
hu
->
ŒvÆs
[
c
 | 
d
] = 
x
;

661 
code
++;

662 
k
++;

664 
hu
->
maxcode
[
i
] = 
code
;

666 
hu
->
maxcode
[16] = 0x20000;

667 
	}
}

673 
	#ONE
 ((
PREC
)
	`IFIX
(1.))

	)

674 
	#S2
 ((
PREC
)
	`IFIX
(0.382683432))

	)

675 
	#C2
 ((
PREC
)
	`IFIX
(0.923879532))

	)

676 
	#C4
 ((
PREC
)
	`IFIX
(0.707106781))

	)

678 
	#S22
 ((
PREC
)
	`IFIX
(2 * 0.382683432))

	)

679 
	#C22
 ((
PREC
)
	`IFIX
(2 * 0.923879532))

	)

680 
	#IC4
 ((
PREC
)
	`IFIX
(1 / 0.707106781))

	)

682 
	#C3IC1
 ((
PREC
)
	`IFIX
(0.847759065)Ë

	)

683 
	#C5IC1
 ((
PREC
)
	`IFIX
(0.566454497)Ë

	)

684 
	#C7IC1
 ((
PREC
)
	`IFIX
(0.198912367)Ë

	)

686 
	#XPP
(
a
,
b
Ë(
t
 =á + b, b =á - b,á =Å)

	)

687 
	#XMP
(
a
,
b
Ë(
t
 =á - b, b =á + b,á =Å)

	)

688 
	#XPM
(
a
,
b
Ë(
t
 =á + b, b = b -á,á =Å)

	)

690 
	#ROT
(
a
,
b
,
s
,
c
Ë–
t
 = 
	`IMULT
(a + b, s), \

691 
a
 = 
	`IMULT
◊, 
c
 - 
s
Ë+ 
t
, \

692 
b
 = 
	`IMULT
(b, 
c
 + 
s
Ë- 
t
)

	)

694 
	#IDCT
 \

696 
	`XPP
(
t0
, 
t1
), \

697 
	`XMP
(
t2
, 
t3
), \

698 
t2
 = 
	`IMULT
—2, 
IC4
Ë- 
t3
, \

699 
	`XPP
(
t0
, 
t3
), \

700 
	`XPP
(
t1
, 
t2
), \

701 
	`XMP
(
t4
, 
t7
), \

702 
	`XPP
(
t5
, 
t6
), \

703 
	`XMP
(
t5
, 
t7
), \

704 
t5
 = 
	`IMULT
—5, 
IC4
), \

705 
	`ROT
(
t4
, 
t6
, 
S22
, 
C22
), \

706 
t6
 -
t7
, \

707 
t5
 -
t6
, \

708 
t4
 -
t5
, \

709 
	`XPP
(
t0
, 
t7
), \

710 
	`XPP
(
t1
, 
t6
), \

711 
	`XPP
(
t2
, 
t5
), \

712 
	`XPP
(
t3
, 
t4
) \

713 )

	)

715 
	gzig2
[64] = {

726 
	$id˘
(*
ö
, *
out
, 
PREC
 * 
qu™t
, PREC 
off
, 
max
)

728 
PREC
 
t0
, 
t1
, 
t2
, 
t3
, 
t4
, 
t5
, 
t6
, 
t7
, 
t
;

729 
PREC
 
tmp
[64], *
tmµ
;

730 
i
, 
j
;

731 *
zig2p
;

733 
t0
 = 
off
;

734 i‡(
max
 == 1) {

735 
t0
 +
ö
[0] * 
qu™t
[0];

736 
i
 = 0; i < 64; i++)

737 
out
[
i
] = 
	`ITOINT
(
t0
);

740 
zig2p
 = 
zig2
;

741 
tmµ
 = 
tmp
;

742 
i
 = 0; i < 8; i++) {

743 
j
 = *
zig2p
++;

744 
t0
 +
ö
[
j
] * 
qu™t
[j];

745 
j
 = *
zig2p
++;

746 
t5
 = 
ö
[
j
] * 
qu™t
[j];

747 
j
 = *
zig2p
++;

748 
t2
 = 
ö
[
j
] * 
qu™t
[j];

749 
j
 = *
zig2p
++;

750 
t7
 = 
ö
[
j
] * 
qu™t
[j];

751 
j
 = *
zig2p
++;

752 
t1
 = 
ö
[
j
] * 
qu™t
[j];

753 
j
 = *
zig2p
++;

754 
t4
 = 
ö
[
j
] * 
qu™t
[j];

755 
j
 = *
zig2p
++;

756 
t3
 = 
ö
[
j
] * 
qu™t
[j];

757 
j
 = *
zig2p
++;

758 
t6
 = 
ö
[
j
] * 
qu™t
[j];

759 
IDCT
;

760 
tmµ
[0 * 8] = 
t0
;

761 
tmµ
[1 * 8] = 
t1
;

762 
tmµ
[2 * 8] = 
t2
;

763 
tmµ
[3 * 8] = 
t3
;

764 
tmµ
[4 * 8] = 
t4
;

765 
tmµ
[5 * 8] = 
t5
;

766 
tmµ
[6 * 8] = 
t6
;

767 
tmµ
[7 * 8] = 
t7
;

768 
tmµ
++;

769 
t0
 = 0;

771 
i
 = 0; i < 8; i++) {

772 
t0
 = 
tmp
[8 * 
i
 + 0];

773 
t1
 = 
tmp
[8 * 
i
 + 1];

774 
t2
 = 
tmp
[8 * 
i
 + 2];

775 
t3
 = 
tmp
[8 * 
i
 + 3];

776 
t4
 = 
tmp
[8 * 
i
 + 4];

777 
t5
 = 
tmp
[8 * 
i
 + 5];

778 
t6
 = 
tmp
[8 * 
i
 + 6];

779 
t7
 = 
tmp
[8 * 
i
 + 7];

780 
IDCT
;

781 
out
[8 * 
i
 + 0] = 
	`ITOINT
(
t0
);

782 
out
[8 * 
i
 + 1] = 
	`ITOINT
(
t1
);

783 
out
[8 * 
i
 + 2] = 
	`ITOINT
(
t2
);

784 
out
[8 * 
i
 + 3] = 
	`ITOINT
(
t3
);

785 
out
[8 * 
i
 + 4] = 
	`ITOINT
(
t4
);

786 
out
[8 * 
i
 + 5] = 
	`ITOINT
(
t5
);

787 
out
[8 * 
i
 + 6] = 
	`ITOINT
(
t6
);

788 
out
[8 * 
i
 + 7] = 
	`ITOINT
(
t7
);

790 
	}
}

792 
	gzig
[64] = {

803 
PREC
 
	gØid˘
[8] = {

804 
IFIX
(0.3535533906), IFIX(0.4903926402),

805 
IFIX
(0.4619397663), IFIX(0.4157348062),

806 
IFIX
(0.3535533906), IFIX(0.2777851165),

807 
IFIX
(0.1913417162), IFIX(0.0975451610)

811 
	$id˘qèb
(*
qö
, 
PREC
 * 
qout
)

813 
i
, 
j
;

815 
i
 = 0; i < 8; i++)

816 
j
 = 0; j < 8; j++)

817 
qout
[
zig
[
i
 * 8 + 
j
]] = 
qö
[zig[i * 8 + j]] *

818 
	`IMULT
(
Øid˘
[
i
],áaid˘[
j
]);

819 
	}
}

821 
	$sˇÀid˘qèb
(
PREC
 * 
q
, PREC 
sc
)

823 
i
;

825 
i
 = 0; i < 64; i++)

826 
q
[
i
] = 
	`IMULT
(q[i], 
sc
);

827 
	}
}

833 
	#ROUND


	)

856 
	$öôcﬁ
(
PREC
 
q
[][64])

858 
	`sˇÀid˘qèb
(
q
[1], 
	`IFIX
(1.77200));

859 
	`sˇÀid˘qèb
(
q
[2], 
	`IFIX
(1.40200));

860 
	}
}

863 
	#STORECLAMP
(
a
,
x
) \

865 (
a
Ë(
x
), \

866 ()(
x
) >= 256 ? \

867 ((
a
Ë(
x
) < 0 ? 0 : 255) \

870 )

	)

872 
	#CLAMP
(
x
Ë(()(xË>256 ? ((xË< 0 ? 0 : 255Ë: (x))

	)

874 #ifde‡
ROUND


876 
	#CBCRCG
(
yö
, 
xö
) \

878 
cb
 = 
outc
[0 +
yö
*8+
xö
], \

879 
¸
 = 
outc
[64+
yö
*8+
xö
], \

880 
cg
 = (50 * 
cb
 + 130 * 
¸
 + 128) >> 8 \

881 )

	)

885 
	#CBCRCG
(
yö
, 
xö
) \

887 
cb
 = 
outc
[0 +
yö
*8+
xö
], \

888 
¸
 = 
outc
[64+
yö
*8+
xö
], \

889 
cg
 = (3 * 
cb
 + 8 * 
¸
) >> 4 \

890 )

	)

894 #ifde‡
__LITTLE_ENDIAN


895 
	#PIC
(
yö
, 
xö
, 
p
, 
xout
) \

897 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

898 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 2], 
y
 + 
¸
), \

899 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 1], 
y
 - 
cg
), \

900 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 0], 
y
 + 
cb
) \

901 )

	)

903 
	#PIC
(
yö
, 
xö
, 
p
, 
xout
) \

905 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

906 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 0], 
y
 + 
¸
), \

907 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 1], 
y
 - 
cg
), \

908 
	`STORECLAMP
(
p
[(
xout
Ë* 3 + 2], 
y
 + 
cb
) \

909 )

	)

912 #ifde‡
__LITTLE_ENDIAN


913 
	#PIC_16
(
yö
, 
xö
, 
p
, 
xout
, 
add
) \

915 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

916 
y
 = ((
	`CLAMP
(y + 
¸
 + 
add
*2+1) & 0xf8) << 8) | \

917 ((
	`CLAMP
(
y
 - 
cg
 + 
add
 ) & 0xfc) << 3) | \

918 ((
	`CLAMP
(
y
 + 
cb
 + 
add
*2+1) ) >> 3), \

919 
p
[(
xout
Ë* 2 + 0] = 
y
 & 0xff, \

920 
p
[(
xout
Ë* 2 + 1] = 
y
 >> 8 \

921 )

	)

923 #ifde‡
CONFIG_PPC


924 
	#PIC_16
(
yö
, 
xö
, 
p
, 
xout
, 
add
) \

926 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

927 
y
 = ((
	`CLAMP
(y + 
¸
 + 
add
*2+1) & 0xf8) << 7) | \

928 ((
	`CLAMP
(
y
 - 
cg
 + 
add
*2+1) & 0xf8) << 2) | \

929 ((
	`CLAMP
(
y
 + 
cb
 + 
add
*2+1) ) >> 3), \

930 
p
[(
xout
Ë* 2 + 0] = 
y
 >> 8, \

931 
p
[(
xout
Ë* 2 + 1] = 
y
 & 0xff \

932 )

	)

934 
	#PIC_16
(
yö
, 
xö
, 
p
, 
xout
, 
add
) \

936 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

937 
y
 = ((
	`CLAMP
(y + 
¸
 + 
add
*2+1) & 0xf8) << 8) | \

938 ((
	`CLAMP
(
y
 - 
cg
 + 
add
 ) & 0xfc) << 3) | \

939 ((
	`CLAMP
(
y
 + 
cb
 + 
add
*2+1) ) >> 3), \

940 
p
[(
xout
Ë* 2 + 0] = 
y
 >> 8, \

941 
p
[(
xout
Ë* 2 + 1] = 
y
 & 0xff \

942 )

	)

946 
	#PIC_32
(
yö
, 
xö
, 
p
, 
xout
) \

948 
y
 = 
outy
[(
yö
Ë* 8 + 
xö
], \

949 
	`STORECLAMP
(
p
[(
xout
Ë* 4 + 0], 
y
 + 
¸
), \

950 
	`STORECLAMP
(
p
[(
xout
Ë* 4 + 1], 
y
 - 
cg
), \

951 
	`STORECLAMP
(
p
[(
xout
Ë* 4 + 2], 
y
 + 
cb
), \

952 
p
[(
xout
) * 4 + 3] = 0 \

953 )

	)

955 
	#PIC221111
(
xö
) \

957 
	`CBCRCG
(0, 
xö
), \

958 
	`PIC
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 0, 
pic0
, xin * 2 + 0), \

959 
	`PIC
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 1, 
pic0
, xin * 2 + 1), \

960 
	`PIC
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 0, 
pic1
, xin * 2 + 0), \

961 
	`PIC
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 1, 
pic1
, xin * 2 + 1) \

962 )

	)

964 
	#PIC221111_16
(
xö
) \

966 
	`CBCRCG
(0, 
xö
), \

967 
	`PIC_16
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 0, 
pic0
, xin * 2 + 0, 3), \

968 
	`PIC_16
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 1, 
pic0
, xin * 2 + 1, 0), \

969 
	`PIC_16
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 0, 
pic1
, xin * 2 + 0, 1), \

970 
	`PIC_16
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 1, 
pic1
, xin * 2 + 1, 2) \

971 )

	)

973 
	#PIC221111_32
(
xö
) \

975 
	`CBCRCG
(0, 
xö
), \

976 
	`PIC_32
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 0, 
pic0
, xin * 2 + 0), \

977 
	`PIC_32
(
xö
 / 4 * 8 + 0, (xö & 3Ë* 2 + 1, 
pic0
, xin * 2 + 1), \

978 
	`PIC_32
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 0, 
pic1
, xin * 2 + 0), \

979 
	`PIC_32
(
xö
 / 4 * 8 + 1, (xö & 3Ë* 2 + 1, 
pic1
, xin * 2 + 1) \

980 )

	)

982 
	$cﬁ221111
(*
out
, *
pic
, 
width
)

984 
i
, 
j
, 
k
;

985 *
pic0
, *
pic1
;

986 *
outy
, *
outc
;

987 
¸
, 
cg
, 
cb
, 
y
;

989 
pic0
 = 
pic
;

990 
pic1
 = 
pic
 + 
width
;

991 
outy
 = 
out
;

992 
outc
 = 
out
 + 64 * 4;

993 
i
 = 2; i > 0; i--) {

994 
j
 = 4; j > 0; j--) {

995 
k
 = 0; k < 8; k++) {

996 
	`PIC221111
(
k
);

998 
outc
 += 8;

999 
outy
 += 16;

1000 
pic0
 +2 * 
width
;

1001 
pic1
 +2 * 
width
;

1003 
outy
 += 64 * 2 - 16 * 4;

1005 
	}
}

1007 
	$cﬁ221111_16
(*
out
, *
pic
, 
width
)

1009 
i
, 
j
, 
k
;

1010 *
pic0
, *
pic1
;

1011 *
outy
, *
outc
;

1012 
¸
, 
cg
, 
cb
, 
y
;

1014 
pic0
 = 
pic
;

1015 
pic1
 = 
pic
 + 
width
;

1016 
outy
 = 
out
;

1017 
outc
 = 
out
 + 64 * 4;

1018 
i
 = 2; i > 0; i--) {

1019 
j
 = 4; j > 0; j--) {

1020 
k
 = 0; k < 8; k++) {

1021 
	`PIC221111_16
(
k
);

1023 
outc
 += 8;

1024 
outy
 += 16;

1025 
pic0
 +2 * 
width
;

1026 
pic1
 +2 * 
width
;

1028 
outy
 += 64 * 2 - 16 * 4;

1030 
	}
}

1032 
	$cﬁ221111_32
(*
out
, *
pic
, 
width
)

1034 
i
, 
j
, 
k
;

1035 *
pic0
, *
pic1
;

1036 *
outy
, *
outc
;

1037 
¸
, 
cg
, 
cb
, 
y
;

1039 
pic0
 = 
pic
;

1040 
pic1
 = 
pic
 + 
width
;

1041 
outy
 = 
out
;

1042 
outc
 = 
out
 + 64 * 4;

1043 
i
 = 2; i > 0; i--) {

1044 
j
 = 4; j > 0; j--) {

1045 
k
 = 0; k < 8; k++) {

1046 
	`PIC221111_32
(
k
);

1048 
outc
 += 8;

1049 
outy
 += 16;

1050 
pic0
 +2 * 
width
;

1051 
pic1
 +2 * 
width
;

1053 
outy
 += 64 * 2 - 16 * 4;

1055 
	}
}

	@kbd.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"c⁄fig.h
"

11 
	~"hw/ps2p‹t.h
"

12 
	~"hw/usb-hid.h
"

13 
	~"ouçut.h
"

14 
	~"°acks.h
"

15 
	~"°rög.h
"

16 
	~"utû.h
"

19 
	#KF0_RSHIFT
 (1<<0)

	)

20 
	#KF0_LSHIFT
 (1<<1)

	)

21 
	#KF0_CTRLACTIVE
 (1<<2)

	)

22 
	#KF0_ALTACTIVE
 (1<<3)

	)

23 
	#KF0_SCROLLACTIVE
 (1<<4)

	)

24 
	#KF0_NUMACTIVE
 (1<<5)

	)

25 
	#KF0_CAPSACTIVE
 (1<<6)

	)

27 
	#KF1_LCTRL
 (1<<0)

	)

28 
	#KF1_LALT
 (1<<1)

	)

29 
	#KF1_PAUSEACTIVE
 (1<<3)

	)

30 
	#KF1_SCROLL
 (1<<4)

	)

31 
	#KF1_NUM
 (1<<5)

	)

32 
	#KF1_CAPS
 (1<<6)

	)

34 
	#KF2_LAST_E1
 (1<<0)

	)

35 
	#KF2_LAST_E0
 (1<<1)

	)

36 
	#KF2_RCTRL
 (1<<2)

	)

37 
	#KF2_RALT
 (1<<3)

	)

38 
	#KF2_101KBD
 (1<<4)

	)

41 
	$kbd_öô
()

43 
	`d¥ötf
(3, "init keyboard\n");

44 
u16
 
x
 = 
	`off£tof
(
bios_d©a_¨ó_s
, 
kbd_buf
);

45 
	`SET_BDA
(
kbd_Êag2
, 
KF2_101KBD
);

46 
	`SET_BDA
(
kbd_buf_hód
, 
x
);

47 
	`SET_BDA
(
kbd_buf_èû
, 
x
);

48 
	`SET_BDA
(
kbd_buf_°¨t_off£t
, 
x
);

50 
	`SET_BDA
(
kbd_buf_íd_off£t


51 , 
x
 + 
	`FIELD_SIZEOF
(
bios_d©a_¨ó_s
, 
kbd_buf
));

52 
	}
}

54 
u8


55 
	$íqueue_key
(
u8
 
sˇn_code
, u8 
ascii_code
)

57 
u16
 
buf„r_°¨t
 = 
	`GET_BDA
(
kbd_buf_°¨t_off£t
);

58 
u16
 
buf„r_íd
 = 
	`GET_BDA
(
kbd_buf_íd_off£t
);

60 
u16
 
buf„r_hód
 = 
	`GET_BDA
(
kbd_buf_hód
);

61 
u16
 
buf„r_èû
 = 
	`GET_BDA
(
kbd_buf_èû
);

63 
u16
 
ãmp_èû
 = 
buf„r_èû
;

64 
buf„r_èû
 += 2;

65 i‡(
buf„r_èû
 >
buf„r_íd
)

66 
buf„r_èû
 = 
buf„r_°¨t
;

68 i‡(
buf„r_èû
 =
buf„r_hód
)

71 
	`SET_FARVAR
(
SEG_BDA
, *(
u8
*)(
ãmp_èû
+0), 
ascii_code
);

72 
	`SET_FARVAR
(
SEG_BDA
, *(
u8
*)(
ãmp_èû
+1), 
sˇn_code
);

73 
	`SET_BDA
(
kbd_buf_èû
, 
buf„r_èû
);

75 
	}
}

78 
	$dequeue_key
(
bªgs
 *
ªgs
, 
ö¸
, 
exãnded
)

80 
	`yõld
();

81 
u16
 
buf„r_hód
;

82 
u16
 
buf„r_èû
;

84 
buf„r_hód
 = 
	`GET_BDA
(
kbd_buf_hód
);

85 
buf„r_èû
 = 
	`GET_BDA
(
kbd_buf_èû
);

87 i‡(
buf„r_hód
 !
buf„r_èû
)

89 i‡(!
ö¸
) {

90 
ªgs
->
Êags
 |
F_ZF
;

93 
	`yõld_toúq
();

96 
u8
 
ascii_code
 = 
	`GET_FARVAR
(
SEG_BDA
, *(u8*)(
buf„r_hód
+0));

97 
u8
 
sˇn_code
 = 
	`GET_FARVAR
(
SEG_BDA
, *(u8*)(
buf„r_hód
+1));

98 i‡((
ascii_code
 =0xF0 && 
sˇn_code
 != 0)

99 || (
ascii_code
 =0xE0 && !
exãnded
))

100 
ascii_code
 = 0;

101 
ªgs
->
ax
 = (
sˇn_code
 << 8Ë| 
ascii_code
;

103 i‡(!
ö¸
) {

104 
ªgs
->
Êags
 &~
F_ZF
;

107 
u16
 
buf„r_°¨t
 = 
	`GET_BDA
(
kbd_buf_°¨t_off£t
);

108 
u16
 
buf„r_íd
 = 
	`GET_BDA
(
kbd_buf_íd_off£t
);

110 
buf„r_hód
 += 2;

111 i‡(
buf„r_hód
 >
buf„r_íd
)

112 
buf„r_hód
 = 
buf„r_°¨t
;

113 
	`SET_BDA
(
kbd_buf_hód
, 
buf„r_hód
);

114 
	}
}

117 
	$kbd_comm™d
(
comm™d
, 
u8
 *
∑øm
)

119 i‡(
	`usb_kbd_a˘ive
())

120  
	`°ack_h›
(
comm™d
, (
u32
)
∑øm
, 
usb_kbd_comm™d
);

121  
	`°ack_h›
(
comm™d
, (
u32
)
∑øm
, 
ps2_kbd_comm™d
);

122 
	}
}

126 
	$h™dÀ_1600
(
bªgs
 *
ªgs
)

128 
	`dequeue_key
(
ªgs
, 1, 0);

129 
	}
}

133 
	$h™dÀ_1601
(
bªgs
 *
ªgs
)

135 
	`dequeue_key
(
ªgs
, 0, 0);

136 
	}
}

140 
	$h™dÀ_1602
(
bªgs
 *
ªgs
)

142 
	`yõld
();

143 
ªgs
->
Æ
 = 
	`GET_BDA
(
kbd_Êag0
);

144 
	}
}

148 
	$h™dÀ_1605
(
bªgs
 *
ªgs
)

150 
ªgs
->
Æ
 = !
	`íqueue_key
‘egs->
ch
,Ñegs->
˛
);

151 
	}
}

155 
	$h™dÀ_1609
(
bªgs
 *
ªgs
)

167 
ªgs
->
Æ
 = 0x30;

168 
	}
}

171 
noölöe


172 
	$h™dÀ_160a
(
bªgs
 *
ªgs
)

174 
u8
 
∑øm
[2];

175 
ªt
 = 
	`kbd_comm™d
(
ATKBD_CMD_GETID
, 
∑øm
);

176 i‡(
ªt
) {

177 
ªgs
->
bx
 = 0;

180 
ªgs
->
bx
 = (
∑øm
[1] << 8) |Öaram[0];

181 
	}
}

185 
	$h™dÀ_1610
(
bªgs
 *
ªgs
)

187 
	`dequeue_key
(
ªgs
, 1, 1);

188 
	}
}

192 
	$h™dÀ_1611
(
bªgs
 *
ªgs
)

194 
	`dequeue_key
(
ªgs
, 0, 1);

195 
	}
}

199 
	$h™dÀ_1612
(
bªgs
 *
ªgs
)

201 
	`yõld
();

202 
ªgs
->
Æ
 = 
	`GET_BDA
(
kbd_Êag0
);

203 
ªgs
->
ah
 = ((
	`GET_BDA
(
kbd_Êag1
Ë& ~(
KF2_RCTRL
|
KF2_RALT
))

204 | (
	`GET_BDA
(
kbd_Êag2
Ë& (
KF2_RCTRL
|
KF2_RALT
)));

206 
	}
}

209 
	$h™dÀ_166f
(
bªgs
 *
ªgs
)

211 i‡(
ªgs
->
Æ
 == 0x08)

213 
ªgs
->
ah
 = 2;

214 
	}
}

218 
	$h™dÀ_1692
(
bªgs
 *
ªgs
)

221 
ªgs
->
ah
 = 0x80;

222 
	}
}

226 
	$h™dÀ_16a2
(
bªgs
 *
ªgs
)

229 
	}
}

232 
	$h™dÀ_16XX
(
bªgs
 *
ªgs
)

234 
	`w¨n_unim∂emíãd
(
ªgs
);

235 
	}
}

237 
noölöe


238 
	$£t_Àds
()

240 
u8
 
shi·_Êags
 = (
	`GET_BDA
(
kbd_Êag0
) >> 4) & 0x07;

241 
u8
 
kbd_Àd
 = 
	`GET_BDA
(kbd_led);

242 
u8
 
Àd_Êags
 = 
kbd_Àd
 & 0x07;

243 i‡(
shi·_Êags
 =
Àd_Êags
)

246 
ªt
 = 
	`kbd_comm™d
(
ATKBD_CMD_SETLEDS
, &
shi·_Êags
);

247 i‡(
ªt
)

250 
kbd_Àd
 = (kbd_Àd & ~0x07Ë| 
shi·_Êags
;

251 
	`SET_BDA
(
kbd_Àd
, kbd_led);

252 
	}
}

255 
VISIBLE16


256 
	$h™dÀ_16
(
bªgs
 *
ªgs
)

258 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_16
);

259 i‡(! 
CONFIG_KEYBOARD
)

263 
	`£t_Àds
();

265 
ªgs
->
ah
) {

266 0x00: 
	`h™dÀ_1600
(
ªgs
); ;

267 0x01: 
	`h™dÀ_1601
(
ªgs
); ;

268 0x02: 
	`h™dÀ_1602
(
ªgs
); ;

269 0x05: 
	`h™dÀ_1605
(
ªgs
); ;

270 0x09: 
	`h™dÀ_1609
(
ªgs
); ;

271 0x0a: 
	`h™dÀ_160a
(
ªgs
); ;

272 0x10: 
	`h™dÀ_1610
(
ªgs
); ;

273 0x11: 
	`h™dÀ_1611
(
ªgs
); ;

274 0x12: 
	`h™dÀ_1612
(
ªgs
); ;

275 0x92: 
	`h™dÀ_1692
(
ªgs
); ;

276 0xa2: 
	`h™dÀ_16a2
(
ªgs
); ;

277 0x6f: 
	`h™dÀ_166f
(
ªgs
); ;

278 : 
	`h™dÀ_16XX
(
ªgs
); ;

280 
	}
}

282 
	#n⁄e
 0

	)

283 
	#MNUM
 
KF0_NUMACTIVE


	)

284 
	#MCAP
 
KF0_CAPSACTIVE


	)

286 
	ssˇnöfo
 {

287 
u16
 
	mn‹mÆ
;

288 
u16
 
	mshi·
;

289 
u16
 
	mc⁄åﬁ
;

290 
u16
 
	mÆt
;

291 
u8
 
	mlock_Êags
;

292 } 
	gsˇn_to_sˇ«scii
[] 
	gVAR16
 = {

293 { 
n⁄e
,Çone,Çone,Çone,Çone },

294 { 0x011b, 0x011b, 0x011b, 0x0100, 
n⁄e
 },

295 { 0x0231, 0x0221, 
n⁄e
, 0x7800,Çone },

296 { 0x0332, 0x0340, 0x0300, 0x7900, 
n⁄e
 },

297 { 0x0433, 0x0423, 
n⁄e
, 0x7a00,Çone },

298 { 0x0534, 0x0524, 
n⁄e
, 0x7b00,Çone },

299 { 0x0635, 0x0625, 
n⁄e
, 0x7c00,Çone },

300 { 0x0736, 0x075e, 0x071e, 0x7d00, 
n⁄e
 },

301 { 0x0837, 0x0826, 
n⁄e
, 0x7e00,Çone },

302 { 0x0938, 0x092a, 
n⁄e
, 0x7f00,Çone },

303 { 0x0a39, 0x0a28, 
n⁄e
, 0x8000,Çone },

304 { 0x0b30, 0x0b29, 
n⁄e
, 0x8100,Çone },

305 { 0x0c2d, 0x0c5f, 0x0c1f, 0x8200, 
n⁄e
 },

306 { 0x0d3d, 0x0d2b, 
n⁄e
, 0x8300,Çone },

307 { 0x0e08, 0x0e08, 0x0e7f, 
n⁄e
,Çone },

308 { 0x0f09, 0x0f00, 
n⁄e
,Çone,Çone },

309 { 0x1071, 0x1051, 0x1011, 0x1000, 
MCAP
 },

310 { 0x1177, 0x1157, 0x1117, 0x1100, 
MCAP
 },

311 { 0x1265, 0x1245, 0x1205, 0x1200, 
MCAP
 },

312 { 0x1372, 0x1352, 0x1312, 0x1300, 
MCAP
 },

313 { 0x1474, 0x1454, 0x1414, 0x1400, 
MCAP
 },

314 { 0x1579, 0x1559, 0x1519, 0x1500, 
MCAP
 },

315 { 0x1675, 0x1655, 0x1615, 0x1600, 
MCAP
 },

316 { 0x1769, 0x1749, 0x1709, 0x1700, 
MCAP
 },

317 { 0x186f, 0x184f, 0x180f, 0x1800, 
MCAP
 },

318 { 0x1970, 0x1950, 0x1910, 0x1900, 
MCAP
 },

319 { 0x1a5b, 0x1a7b, 0x1a1b, 
n⁄e
,Çone },

320 { 0x1b5d, 0x1b7d, 0x1b1d, 
n⁄e
,Çone },

321 { 0x1c0d, 0x1c0d, 0x1c0a, 
n⁄e
,Çone },

322 { 
n⁄e
,Çone,Çone,Çone,Çone },

323 { 0x1e61, 0x1e41, 0x1e01, 0x1e00, 
MCAP
 },

324 { 0x1f73, 0x1f53, 0x1f13, 0x1f00, 
MCAP
 },

325 { 0x2064, 0x2044, 0x2004, 0x2000, 
MCAP
 },

326 { 0x2166, 0x2146, 0x2106, 0x2100, 
MCAP
 },

327 { 0x2267, 0x2247, 0x2207, 0x2200, 
MCAP
 },

328 { 0x2368, 0x2348, 0x2308, 0x2300, 
MCAP
 },

329 { 0x246a, 0x244a, 0x240a, 0x2400, 
MCAP
 },

330 { 0x256b, 0x254b, 0x250b, 0x2500, 
MCAP
 },

331 { 0x266c, 0x264c, 0x260c, 0x2600, 
MCAP
 },

332 { 0x273b, 0x273a, 
n⁄e
,Çone,Çone },

333 { 0x2827, 0x2822, 
n⁄e
,Çone,Çone },

334 { 0x2960, 0x297e, 
n⁄e
,Çone,Çone },

335 { 
n⁄e
,Çone,Çone,Çone,Çone },

336 { 0x2b5c, 0x2b7c, 0x2b1c, 
n⁄e
,Çone },

337 { 0x2c7a, 0x2c5a, 0x2c1a, 0x2c00, 
MCAP
 },

338 { 0x2d78, 0x2d58, 0x2d18, 0x2d00, 
MCAP
 },

339 { 0x2e63, 0x2e43, 0x2e03, 0x2e00, 
MCAP
 },

340 { 0x2f76, 0x2f56, 0x2f16, 0x2f00, 
MCAP
 },

341 { 0x3062, 0x3042, 0x3002, 0x3000, 
MCAP
 },

342 { 0x316e, 0x314e, 0x310e, 0x3100, 
MCAP
 },

343 { 0x326d, 0x324d, 0x320d, 0x3200, 
MCAP
 },

344 { 0x332c, 0x333c, 
n⁄e
,Çone,Çone },

345 { 0x342e, 0x343e, 
n⁄e
,Çone,Çone },

346 { 0x352f, 0x353f, 
n⁄e
,Çone,Çone },

347 { 
n⁄e
,Çone,Çone,Çone,Çone },

348 { 0x372a, 0x372a, 
n⁄e
,Çone,Çone },

349 { 
n⁄e
,Çone,Çone,Çone,Çone },

350 { 0x3920, 0x3920, 0x3920, 0x3920, 
n⁄e
 },

351 { 
n⁄e
,Çone,Çone,Çone,Çone },

352 { 0x3b00, 0x5400, 0x5e00, 0x6800, 
n⁄e
 },

353 { 0x3c00, 0x5500, 0x5f00, 0x6900, 
n⁄e
 },

354 { 0x3d00, 0x5600, 0x6000, 0x6a00, 
n⁄e
 },

355 { 0x3e00, 0x5700, 0x6100, 0x6b00, 
n⁄e
 },

356 { 0x3f00, 0x5800, 0x6200, 0x6c00, 
n⁄e
 },

357 { 0x4000, 0x5900, 0x6300, 0x6d00, 
n⁄e
 },

358 { 0x4100, 0x5a00, 0x6400, 0x6e00, 
n⁄e
 },

359 { 0x4200, 0x5b00, 0x6500, 0x6f00, 
n⁄e
 },

360 { 0x4300, 0x5c00, 0x6600, 0x7000, 
n⁄e
 },

361 { 0x4400, 0x5d00, 0x6700, 0x7100, 
n⁄e
 },

362 { 
n⁄e
,Çone,Çone,Çone,Çone },

363 { 
n⁄e
,Çone,Çone,Çone,Çone },

364 { 0x4700, 0x4737, 0x7700, 
n⁄e
, 
MNUM
 },

365 { 0x4800, 0x4838, 
n⁄e
,Ç⁄e, 
MNUM
 },

366 { 0x4900, 0x4939, 0x8400, 
n⁄e
, 
MNUM
 },

367 { 0x4a2d, 0x4a2d, 
n⁄e
,Çone,Çone },

368 { 0x4b00, 0x4b34, 0x7300, 
n⁄e
, 
MNUM
 },

369 { 0x4c00, 0x4c35, 
n⁄e
,Ç⁄e, 
MNUM
 },

370 { 0x4d00, 0x4d36, 0x7400, 
n⁄e
, 
MNUM
 },

371 { 0x4e2b, 0x4e2b, 
n⁄e
,Çone,Çone },

372 { 0x4f00, 0x4f31, 0x7500, 
n⁄e
, 
MNUM
 },

373 { 0x5000, 0x5032, 
n⁄e
,Ç⁄e, 
MNUM
 },

374 { 0x5100, 0x5133, 0x7600, 
n⁄e
, 
MNUM
 },

375 { 0x5200, 0x5230, 
n⁄e
,Ç⁄e, 
MNUM
 },

376 { 0x5300, 0x532e, 
n⁄e
,Ç⁄e, 
MNUM
 },

377 { 
n⁄e
,Çone,Çone,Çone,Çone },

378 { 
n⁄e
,Çone,Çone,Çone,Çone },

379 { 0x565c, 0x567c, 
n⁄e
,Çone,Çone },

380 { 0x8500, 0x8700, 0x8900, 0x8b00, 
n⁄e
 },

381 { 0x8600, 0x8800, 0x8a00, 0x8c00, 
n⁄e
 },

386 
	$__¥o˚ss_key
(
u8
 
sˇncode
)

388 
u8
 
Êags0
 = 
	`GET_BDA
(
kbd_Êag0
);

389 
u8
 
Êags1
 = 
	`GET_BDA
(
kbd_Êag1
);

390 
u8
 
Êags2
 = 
	`GET_BDA
(
kbd_Êag2
);

392 i‡(
Êags2
 & 
KF2_LAST_E1
) {

394 i‡((
sˇncode
 & ~0x80) == 0x1d)

398 
Êags2
 &~
KF2_LAST_E1
;

399 
	`SET_BDA
(
kbd_Êag2
, 
Êags2
);

401 i‡(
sˇncode
 == 0xc5) {

413 
sˇncode
) {

415 
	`d¥ötf
(1, "KBD: int09 handler: AL=0\n");

419 
Êags0
 ^
KF0_CAPSACTIVE
;

420 
Êags1
 |
KF1_CAPS
;

423 
Êags1
 &~
KF1_CAPS
;

427 
Êags0
 |
KF0_LSHIFT
;

430 
Êags0
 &~
KF0_LSHIFT
;

434 
Êags0
 |
KF0_RSHIFT
;

437 
Êags0
 &~
KF0_RSHIFT
;

441 
Êags0
 |
KF0_CTRLACTIVE
;

442 i‡(
Êags2
 & 
KF2_LAST_E0
)

443 
Êags2
 |
KF2_RCTRL
;

445 
Êags1
 |
KF1_LCTRL
;

448 
Êags0
 &~
KF0_CTRLACTIVE
;

449 i‡(
Êags2
 & 
KF2_LAST_E0
)

450 
Êags2
 &~
KF2_RCTRL
;

452 
Êags1
 &~
KF1_LCTRL
;

456 
Êags0
 |
KF0_ALTACTIVE
;

457 i‡(
Êags2
 & 
KF2_LAST_E0
)

458 
Êags2
 |
KF2_RALT
;

460 
Êags1
 |
KF1_LALT
;

463 
Êags0
 &~
KF0_ALTACTIVE
;

464 i‡(
Êags2
 & 
KF2_LAST_E0
)

465 
Êags2
 &~
KF2_RALT
;

467 
Êags1
 &~
KF1_LALT
;

471 
Êags1
 |
KF1_NUM
;

472 
Êags0
 ^
KF0_NUMACTIVE
;

475 
Êags1
 &~
KF1_NUM
;

479 
Êags1
 |
KF1_SCROLL
;

480 
Êags0
 ^
KF0_SCROLLACTIVE
;

483 
Êags1
 &~
KF1_SCROLL
;

488 
Êags2
 |
KF2_LAST_E0
;

489 
	`SET_BDA
(
kbd_Êag2
, 
Êags2
);

493 
Êags2
 |
KF2_LAST_E1
;

497 i‡(
sˇncode
 & 0x80)

500 i‡(
sˇncode
 == 0x53

501 && ((
Êags0
 & (
KF0_CTRLACTIVE
|
KF0_ALTACTIVE
))

502 =(
KF0_CTRLACTIVE
|
KF0_ALTACTIVE
))) {

504 
	`SET_BDA
(
so·_ª£t_Êag
, 0x1234);

505 
	`ª£t_ve˘‹
();

507 i‡(
sˇncode
 >
	`ARRAY_SIZE
(
sˇn_to_sˇ«scii
)) {

508 
	`d¥ötf
(1, "KBD: int09h_handler(): unknown scancodeÑead: 0x%02x!\n"

509 , 
sˇncode
);

512 
u8
 
asciicode
;

513 
sˇnöfo
 *
öfo
 = &
sˇn_to_sˇ«scii
[
sˇncode
];

514 i‡(
Êags0
 & 
KF0_ALTACTIVE
) {

515 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
Æt
);

516 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
Æt
) >> 8;

517 } i‡(
Êags0
 & 
KF0_CTRLACTIVE
) {

518 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
c⁄åﬁ
);

519 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
c⁄åﬁ
) >> 8;

520 } i‡(
Êags2
 & 
KF2_LAST_E0


521 && 
sˇncode
 >= 0x47 && scancode <= 0x53) {

523 
asciicode
 = 0xe0;

524 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
n‹mÆ
) >> 8;

525 } i‡(
Êags0
 & (
KF0_RSHIFT
|
KF0_LSHIFT
)) {

529 i‡(
Êags0
 & 
	`GET_GLOBAL
(
öfo
->
lock_Êags
)) {

530 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
n‹mÆ
);

531 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
n‹mÆ
) >> 8;

533 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
shi·
);

534 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
shi·
) >> 8;

538 i‡(
Êags0
 & 
	`GET_GLOBAL
(
öfo
->
lock_Êags
)) {

539 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
shi·
);

540 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
shi·
) >> 8;

542 
asciicode
 = 
	`GET_GLOBAL
(
öfo
->
n‹mÆ
);

543 
sˇncode
 = 
	`GET_GLOBAL
(
öfo
->
n‹mÆ
) >> 8;

546 i‡(
sˇncode
==0 && 
asciicode
==0)

547 
	`d¥ötf
(1, "KBD: scancode &ásciicodeáre zero?\n");

548 
	`íqueue_key
(
sˇncode
, 
asciicode
);

551 
Êags2
 &~
KF2_LAST_E0
;

553 
	`SET_BDA
(
kbd_Êag0
, 
Êags0
);

554 
	`SET_BDA
(
kbd_Êag1
, 
Êags1
);

555 
	`SET_BDA
(
kbd_Êag2
, 
Êags2
);

556 
	}
}

559 
	$¥o˚ss_key
(
u8
 
key
)

561 i‡(!
CONFIG_KEYBOARD
)

564 i‡(
CONFIG_KBD_CALL_INT15_4F
) {

566 
bªgs
 
br
;

567 
	`mem£t
(&
br
, 0, (br));

568 
br
.
óx
 = (0x4‡<< 8Ë| 
key
;

569 
br
.
Êags
 = 
F_IF
|
F_CF
;

570 
	`ˇŒ16_öt
(0x15, &
br
);

571 i‡(!(
br
.
Êags
 & 
F_CF
))

573 
key
 = 
br
.
óx
;

575 
	`__¥o˚ss_key
(
key
);

576 
	}
}

	@list.h

1 #i‚de‡
__LIST_H


2 
	#__LIST_H


	)

4 
	~"ty≥s.h
"

11 
	shli°_node
 {

12 
hli°_node
 *
	m√xt
, **
	mµªv
;

15 
	shli°_hód
 {

16 
hli°_node
 *
	mfú°
;

19 
ölöe
 

20 
	$hli°_em±y
(c⁄° 
hli°_hód
 *
h
)

22  !
h
->
fú°
;

23 
	}
}

25 
ölöe
 

26 
	$hli°_dñ
(
hli°_node
 *
n
)

28 
hli°_node
 *
√xt
 = 
n
->next;

29 
hli°_node
 **
µªv
 = 
n
->pprev;

30 *
µªv
 = 
√xt
;

31 i‡(
√xt
)

32 
√xt
->
µªv
 =Öprev;

33 
	}
}

35 
ölöe
 

36 
	$hli°_add
(
hli°_node
 *
n
, hli°_nodê**
µªv
)

38 
hli°_node
 *
√xt
 = *
µªv
;

39 
n
->
µªv
 =Öprev;

40 
n
->
√xt
 =Çext;

41 i‡(
√xt
)

42 
√xt
->
µªv
 = &
n
->next;

43 *
µªv
 = 
n
;

44 
	}
}

46 
ölöe
 

47 
	$hli°_add_hód
(
hli°_node
 *
n
, 
hli°_hód
 *
h
)

49 
	`hli°_add
(
n
, &
h
->
fú°
);

50 
	}
}

52 
ölöe
 

53 
	$hli°_add_bef‹e
(
hli°_node
 *
n
, hli°_nodê*
√xt
)

55 
	`hli°_add
(
n
, 
√xt
->
µªv
);

56 
	}
}

58 
ölöe
 

59 
	$hli°_add_a·î
(
hli°_node
 *
n
, hli°_nodê*
¥ev
)

61 
	`hli°_add
(
n
, &
¥ev
->
√xt
);

62 
	}
}

64 
	#hli°_f‹_óch_íåy
(
pos
, 
hód
, 
membî
) \

65 
pos
 = 
	`c⁄èöî_of
((
hód
)->
fú°
, 
	`ty≥of
(*pos), 
membî
) \

66 ; 
pos
 !
	`c⁄èöî_of
(
NULL
, 
	`ty≥of
(*pos), 
membî
) \

67 ; 
pos
 = 
	`c⁄èöî_of
’os->
membî
.
√xt
, 
	`ty≥of
(*pos), membî))

	)

69 
	#hli°_f‹_óch_íåy_ß„
(
pos
, 
n
, 
hód
, 
membî
) \

70 
pos
 = 
	`c⁄èöî_of
((
hód
)->
fú°
, 
	`ty≥of
(*pos), 
membî
) \

71 ; 
pos
 !
	`c⁄èöî_of
(
NULL
, 
	`ty≥of
(*pos), 
membî
) \

72 && ({ 
n
 = 
pos
->
membî
.
√xt
; 1; }) \

73 ; 
pos
 = 
	`c⁄èöî_of
(
n
, 
	`ty≥of
(*pos), 
membî
))

	)

75 
	#hli°_f‹_óch_íåy_µªv
(
pos
, 
µªv
, 
hód
, 
membî
) \

76 
µªv
 = &(
hód
)->
fú°
 \

77 ; *
µªv
 && ({ 
pos
=
	`c⁄èöî_of
(*µªv, 
	`ty≥of
(*pos), 
membî
); 1; }) \

78 ; 
µªv
 = &(*µªv)->
√xt
)

	)

	@malloc.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"li°.h
"

10 
	~"mÆloc.h
"

11 
	~"memm≠.h
"

12 
	~"ouçut.h
"

13 
	~"°acks.h
"

14 
	~"°d/›ti⁄rom.h
"

15 
	~"°rög.h
"

18 
	sÆlocöfo_s
 {

19 
hli°_node
 
	mnode
;

20 *
	md©a
, *
	md©´nd
, *
	mÆlo˚nd
;

24 
	sÆlocdëaû_s
 {

25 
Ælocöfo_s
 
	mdëaûöfo
;

26 
Ælocöfo_s
 
	md©aöfo
;

27 
u32
 
	mh™dÀ
;

31 
	sz⁄e_s
 {

32 
hli°_hód
 
	mhód
;

35 
z⁄e_s
 
Z⁄eLow
 
	gVARVERIFY32INIT
, 
Z⁄eHigh
 VARVERIFY32INIT;

36 
z⁄e_s
 
Z⁄eFSeg
 
	gVARVERIFY32INIT
;

37 
z⁄e_s
 
Z⁄eTmpLow
 
	gVARVERIFY32INIT
, 
Z⁄eTmpHigh
 VARVERIFY32INIT;

39 
z⁄e_s
 *
	gZ⁄es
[] 
	gVARVERIFY32INIT
 = {

40 &
Z⁄eTmpLow
, &
Z⁄eLow
, &
Z⁄eFSeg
, &
Z⁄eTmpHigh
, &
Z⁄eHigh


50 
	$ÆlocS∑˚
(
z⁄e_s
 *
z⁄e
, 
u32
 
size
, u32 
Æign
, 
Ælocöfo_s
 *
fûl
)

52 
Ælocöfo_s
 *
öfo
;

53 
	`hli°_f‹_óch_íåy
(
öfo
, &
z⁄e
->
hód
, 
node
) {

54 *
d©´nd
 = 
öfo
->dataend;

55 *
Ælo˚nd
 = 
öfo
->allocend;

56 *
√wÆlo˚nd
 = (*)
	`ALIGN_DOWN
((
u32
)
Ælo˚nd
 - 
size
, 
Æign
);

57 i‡(
√wÆlo˚nd
 >
d©´nd
 &&ÇewÆlo˚nd <
Ælo˚nd
) {

59 i‡(!
fûl
)

60 
fûl
 = 
√wÆlo˚nd
;

61 
fûl
->
d©a
 = 
√wÆlo˚nd
;

62 
fûl
->
d©´nd
 = 
√wÆlo˚nd
 + 
size
;

63 
fûl
->
Ælo˚nd
 =állocend;

65 
öfo
->
Ælo˚nd
 = 
√wÆlo˚nd
;

66 
	`hli°_add_bef‹e
(&
fûl
->
node
, &
öfo
->node);

67  
√wÆlo˚nd
;

70  
NULL
;

71 
	}
}

75 
	$‰ìS∑˚
(
Ælocöfo_s
 *
öfo
)

77 
Ælocöfo_s
 *
√xt
 = 
	`c⁄èöî_of_‹_nuŒ
(

78 
öfo
->
node
.
√xt
, 
Ælocöfo_s
,Çode);

79 i‡(
√xt
 &&Çext->
Ælo˚nd
 =
öfo
->
d©a
)

80 
√xt
->
Ælo˚nd
 = 
öfo
->allocend;

81 
	`hli°_dñ
(&
öfo
->
node
);

82 
	}
}

86 
	$addS∑˚
(
z⁄e_s
 *
z⁄e
, *
°¨t
, *
íd
)

89 
Ælocöfo_s
 *
öfo
;

90 
hli°_node
 **
µªv
;

91 
	`hli°_f‹_óch_íåy_µªv
(
öfo
, 
µªv
, &
z⁄e
->
hód
, 
node
) {

92 i‡(
öfo
->
d©a
 < 
°¨t
)

97 
Ælocdëaû_s
 
ãmpdëaû
;

98 
ãmpdëaû
.
d©aöfo
.
d©a
 =Åempdëaû.d©aöfo.
d©´nd
 = 
°¨t
;

99 
ãmpdëaû
.
d©aöfo
.
Ælo˚nd
 = 
íd
;

100 
	`hli°_add
(&
ãmpdëaû
.
d©aöfo
.
node
, 
µªv
);

103 
Ælocdëaû_s
 *
dëaû
 = 
	`ÆlocS∑˚
(

104 &
Z⁄eTmpHigh
, (*
dëaû
), 
MALLOC_MIN_ALIGN
, 
NULL
);

105 i‡(!
dëaû
) {

106 
dëaû
 = 
	`ÆlocS∑˚
(&
Z⁄eTmpLow
, (*detail)

107 , 
MALLOC_MIN_ALIGN
, 
NULL
);

108 i‡(!
dëaû
) {

109 
	`hli°_dñ
(&
ãmpdëaû
.
d©aöfo
.
node
);

110 
	`w¨n_nﬂŒoc
();

116 
µªv
 = 
ãmpdëaû
.
d©aöfo
.
node
.pprev;

117 
	`hli°_dñ
(&
ãmpdëaû
.
d©aöfo
.
node
);

118 
	`mem˝y
(&
dëaû
->
d©aöfo
, &
ãmpdëaû
.datainfo, (detail->datainfo));

119 
dëaû
->
h™dÀ
 = 
MALLOC_DEFAULT_HANDLE
;

120 
	`hli°_add
(&
dëaû
->
d©aöfo
.
node
, 
µªv
);

121 
	}
}

124 
Ælocöfo_s
 *

125 
	$födAŒoc
(*
d©a
)

127 
i
;

128 
i
=0; i<
	`ARRAY_SIZE
(
Z⁄es
); i++) {

129 
Ælocöfo_s
 *
öfo
;

130 
	`hli°_f‹_óch_íåy
(
öfo
, &
Z⁄es
[
i
]->
hód
, 
node
) {

131 i‡(
öfo
->
d©a
 == data)

132  
öfo
;

135  
NULL
;

136 
	}
}

139 
Ælocöfo_s
 *

140 
	$födLa°
(
z⁄e_s
 *
z⁄e
)

142 
Ælocöfo_s
 *
öfo
, *
œ°
 = 
NULL
;

143 
	`hli°_f‹_óch_íåy
(
öfo
, &
z⁄e
->
hód
, 
node
) {

144 
œ°
 = 
öfo
;

146  
œ°
;

147 
	}
}

156 
	$ªloˇã_ebda
(
u32
 
√webda
, u32 
ﬁdebda
, 
u8
 
ebda_size
)

158 
u32
 
lowøm
 = 
	`GET_BDA
(
mem_size_kb
) * 1024;

159 i‡(
ﬁdebda
 !
lowøm
)

164 
	`memmove
((*)
√webda
, (*)
ﬁdebda
, 
ebda_size
 * 1024);

167 
	`d¥ötf
(1, "ebd®moved from %xÅÿ%x\n", 
ﬁdebda
, 
√webda
);

168 
	`SET_BDA
(
mem_size_kb
, 
√webda
 / 1024);

169 
	`SET_BDA
(
ebda_£g
, 
	`FLATPTR_TO_SEG
(
√webda
));

171 
	}
}

175 
	$z⁄ñow_ex∑nd
(
u32
 
size
, u32 
Æign
, 
Ælocöfo_s
 *
fûl
)

178 i‡(
	`u∆ikñy
(
	`waô_¥ìm±
())) {

179 *
d©a
 = 
	`ÆlocS∑˚
(&
Z⁄eLow
, 
size
, 
Æign
, 
fûl
);

180 i‡(
d©a
)

181  
d©a
;

184 
Ælocöfo_s
 *
öfo
 = 
	`födLa°
(&
Z⁄eLow
);

185 i‡(!
öfo
)

186  
NULL
;

187 
u32
 
ﬁdpos
 = (u32)
öfo
->
Ælo˚nd
;

188 
u32
 
√wpos
 = 
	`ALIGN_DOWN
(
ﬁdpos
 - 
size
, 
Æign
);

189 
u32
 
bŸtom
 = (u32)
öfo
->
d©´nd
;

190 i‡(
√wpos
 >
bŸtom
 &&Çewpo†<
ﬁdpos
)

192  
	`ÆlocS∑˚
(&
Z⁄eLow
, 
size
, 
Æign
, 
fûl
);

193 
u16
 
ebda_£g
 = 
	`gë_ebda_£g
();

194 
u32
 
ebda_pos
 = (u32)
	`MAKE_FLATPTR
(
ebda_£g
, 0);

195 
u8
 
ebda_size
 = 
	`GET_EBDA
(
ebda_£g
, 
size
);

196 
u32
 
ebda_íd
 = 
ebda_pos
 + 
ebda_size
 * 1024;

197 i‡(
ebda_íd
 !
bŸtom
)

199 
√wpos
 = 
	`ALIGN_DOWN
(
ebda_íd
 - 
size
, 
Æign
);

200 
u32
 
√wbŸtom
 = 
	`ALIGN_DOWN
(
√wpos
, 1024);

201 
u32
 
√webda
 = 
	`ALIGN_DOWN
(
√wbŸtom
 - 
ebda_size
 * 1024, 1024);

202 i‡(
√webda
 < 
BUILD_EBDA_MINIMUM
)

204  
NULL
;

207 
ªt
 = 
	`ªloˇã_ebda
(
√webda
, 
ebda_pos
, 
ebda_size
);

208 i‡(
ªt
)

209  
NULL
;

212 i‡(
ebda_íd
 =
bŸtom
) {

213 
öfo
->
d©a
 = (*)
√wbŸtom
;

214 
öfo
->
d©´nd
 = (*)
√wbŸtom
;

216 
	`addS∑˚
(&
Z⁄eLow
, (*)
√wbŸtom
, (*)
ebda_íd
);

218  
	`ÆlocS∑˚
(&
Z⁄eLow
, 
size
, 
Æign
, 
fûl
);

219 
	}
}

227 * 
__mÆloc


228 
	$_mÆloc
(
z⁄e_s
 *
z⁄e
, 
u32
 
size
, u32 
Æign
)

230 
	`ASSERT32FLAT
();

231 i‡(!
size
)

232  
NULL
;

235 
Ælocdëaû_s
 *
dëaû
 = 
	`ÆlocS∑˚
(

236 &
Z⁄eTmpHigh
, (*
dëaû
), 
MALLOC_MIN_ALIGN
, 
NULL
);

237 i‡(!
dëaû
) {

238 
dëaû
 = 
	`ÆlocS∑˚
(&
Z⁄eTmpLow
, (*detail)

239 , 
MALLOC_MIN_ALIGN
, 
NULL
);

240 i‡(!
dëaû
)

241  
NULL
;

243 
dëaû
->
h™dÀ
 = 
MALLOC_DEFAULT_HANDLE
;

246 *
d©a
 = 
	`ÆlocS∑˚
(
z⁄e
, 
size
, 
Æign
, &
dëaû
->
d©aöfo
);

247 i‡(!
CONFIG_MALLOC_UPPERMEMORY
 && !
d©a
 && 
z⁄e
 =&
Z⁄eLow
)

248 
d©a
 = 
	`z⁄ñow_ex∑nd
(
size
, 
Æign
, &
dëaû
->
d©aöfo
);

249 i‡(!
d©a
) {

250 
	`‰ìS∑˚
(&
dëaû
->
dëaûöfo
);

251  
NULL
;

254 
	`d¥ötf
(8, "_malloc zone=%p size=%dálign=%xÑet=%p (detail=%p)\n"

255 , 
z⁄e
, 
size
, 
Æign
, 
d©a
, 
dëaû
);

260 
	`mem£t
(
d©a
,0,
size
);

262  
d©a
;

263 
	}
}

267 
	$_‰ì
(*
d©a
)

269 
	`ASSERT32FLAT
();

270 
Ælocöfo_s
 *
öfo
 = 
	`födAŒoc
(
d©a
);

271 i‡(!
öfo
 || 
d©a
 =(*)öfÿ|| d©®=öfo->
d©´nd
)

273 
Ælocdëaû_s
 *
dëaû
 = 
	`c⁄èöî_of
(

274 
öfo
, 
Ælocdëaû_s
, 
d©aöfo
);

275 
	`d¥ötf
(8, "_‰ì %∞(dëaû=%p)\n", 
d©a
, 
dëaû
);

276 
	`‰ìS∑˚
(
öfo
);

277 
	`‰ìS∑˚
(&
dëaû
->
dëaûöfo
);

279 
	}
}

282 
u32


283 
	$mÆloc_gë•a˚
(
z⁄e_s
 *
z⁄e
)

287 
u32
 
max•a˚
 = 0;

288 
Ælocöfo_s
 *
öfo
;

289 
	`hli°_f‹_óch_íåy
(
öfo
, &
z⁄e
->
hód
, 
node
) {

290 
u32
 
•a˚
 = 
öfo
->
Ælo˚nd
 - info->
d©´nd
;

291 i‡(
•a˚
 > 
max•a˚
)

292 
max•a˚
 = 
•a˚
;

295 i‡(
z⁄e
 !&
Z⁄eTmpHigh
 && z⁄ê!&
Z⁄eTmpLow
)

296  
max•a˚
;

298 
u32
 
ª£rve
 = 
	`ALIGN
((
Ælocdëaû_s
), 
MALLOC_MIN_ALIGN
);

299 i‡(
max•a˚
 <
ª£rve
)

301  
max•a˚
 - 
ª£rve
;

302 
	}
}

306 
	$mÆloc_£th™dÀ
(*
d©a
, 
u32
 
h™dÀ
)

308 
	`ASSERT32FLAT
();

309 
Ælocöfo_s
 *
öfo
 = 
	`födAŒoc
(
d©a
);

310 i‡(!
öfo
 || 
d©a
 =(*)öfÿ|| d©®=öfo->
d©´nd
)

312 
Ælocdëaû_s
 *
dëaû
 = 
	`c⁄èöî_of
(

313 
öfo
, 
Ælocdëaû_s
, 
d©aöfo
);

314 
dëaû
->
h™dÀ
 = handle;

315 
	}
}

319 
	$mÆloc_födh™dÀ
(
u32
 
h™dÀ
)

321 
i
;

322 
i
=0; i<
	`ARRAY_SIZE
(
Z⁄es
); i++) {

323 
Ælocöfo_s
 *
öfo
;

324 
	`hli°_f‹_óch_íåy
(
öfo
, &
Z⁄es
[
i
]->
hód
, 
node
) {

325 i‡(
öfo
->
d©a
 != (*)info)

327 
Ælocdëaû_s
 *
dëaû
 = 
	`c⁄èöî_of
(

328 
öfo
, 
Ælocdëaû_s
, 
dëaûöfo
);

329 i‡(
dëaû
->
h™dÀ
 == handle)

330  
dëaû
->
d©aöfo
.
d©a
;

333  
NULL
;

334 
	}
}

341 
u32
 
	gRomEnd
 = 
BUILD_ROM_START
;

342 
Ælocöfo_s
 *
	gRomBa£
;

344 
	#OPROM_HEADER_RESERVE
 16

	)

347 
u32


348 
	$rom_gë_max
()

350 i‡(
CONFIG_MALLOC_UPPERMEMORY
)

351  
	`ALIGN_DOWN
((
u32
)
RomBa£
->
Ælo˚nd
 - 
OPROM_HEADER_RESERVE


352 , 
OPTION_ROM_ALIGN
);

353 
u8
 
föÆ_ªad⁄ly_°¨t
[];

354  (
u32
)
föÆ_ªad⁄ly_°¨t
;

355 
	}
}

358 
u32


359 
	$rom_gë_œ°
()

361  
RomEnd
;

362 
	}
}

365 
rom_hódî
 *

366 
	$rom_ª£rve
(
u32
 
size
)

368 
u32
 
√wíd
 = 
	`ALIGN
(
RomEnd
 + 
size
, 
OPTION_ROM_ALIGN
);

369 i‡(
√wíd
 > 
	`rom_gë_max
())

370  
NULL
;

371 i‡(
CONFIG_MALLOC_UPPERMEMORY
) {

372 i‡(
√wíd
 < (
u32
)
z⁄ñow_ba£
)

373 
√wíd
 = (
u32
)
z⁄ñow_ba£
;

374 
RomBa£
->
d©a
 = RomBa£->
d©´nd
 = (*)
√wíd
 + 
OPROM_HEADER_RESERVE
;

376  (*)
RomEnd
;

377 
	}
}

381 
	$rom_c⁄fúm
(
u32
 
size
)

383 *
√w
 = 
	`rom_ª£rve
(
size
);

384 i‡(!
√w
) {

385 
	`w¨n_nﬂŒoc
();

388 
RomEnd
 = 
	`ALIGN
(RomEnd + 
size
, 
OPTION_ROM_ALIGN
);

390 
	}
}

398 
	$mÆloc_¥eöô
()

400 
	`ASSERT32FLAT
();

401 
	`d¥ötf
(3, "mallocÖreinit\n");

404 
	`add_e820
(
BUILD_LOWRAM_END
, 
BUILD_BIOS_ADDR
-BUILD_LOWRAM_END, 
E820_HOLE
);

407 
	`add_e820
(
BUILD_BIOS_ADDR
, 
BUILD_BIOS_SIZE
, 
E820_RESERVED
);

410 
u32
 
highøm
 = 0;

411 
i
;

412 
i
=
e820_cou¡
-1; i>=0; i--) {

413 
e820íåy
 *
í
 = &
e820_li°
[
i
];

414 
u64
 
íd
 = 
í
->
°¨t
 +Én->
size
;

415 i‡(
íd
 < 1024*1024)

417 i‡(
í
->
ty≥
 !
E820_RAM
 || 
íd
 > 0xffffffff)

419 
u32
 
s
 = 
í
->
°¨t
, 
e
 = 
íd
;

420 i‡(!
highøm
) {

421 
u32
 
√we
 = 
	`ALIGN_DOWN
(
e
 - 
BUILD_MAX_HIGHTABLE
, 
MALLOC_MIN_ALIGN
);

422 i‡(
√we
 <
e
 &&Çewê>
s
) {

423 
highøm
 = 
√we
;

424 
e
 = 
√we
;

427 
	`addS∑˚
(&
Z⁄eTmpHigh
, (*)
s
, (*)
e
);

431 
	`addS∑˚
(&
Z⁄eTmpLow
, (*)
BUILD_STACK_ADDR
, (*)
BUILD_EBDA_MINIMUM
);

432 i‡(
highøm
) {

433 
	`addS∑˚
(&
Z⁄eHigh
, (*)
highøm


434 , (*)
highøm
 + 
BUILD_MAX_HIGHTABLE
);

435 
	`add_e820
(
highøm
, 
BUILD_MAX_HIGHTABLE
, 
E820_RESERVED
);

437 
	}
}

440 
	$csm_mÆloc_¥eöô
(
u32
 
low_pmm
, u32 
low_pmm_size
, u32 
hi_pmm
, u32 
hi_pmm_size
)

442 
	`ASSERT32FLAT
();

444 i‡(
hi_pmm_size
 > 
BUILD_MAX_HIGHTABLE
) {

445 *
hi_pmm_íd
 = (*)
hi_pmm
 + 
hi_pmm_size
;

446 
	`addS∑˚
(&
Z⁄eTmpHigh
, (*)
hi_pmm
, 
hi_pmm_íd
 - 
BUILD_MAX_HIGHTABLE
);

447 
	`addS∑˚
(&
Z⁄eHigh
, 
hi_pmm_íd
 - 
BUILD_MAX_HIGHTABLE
, hi_pmm_end);

449 
	`addS∑˚
(&
Z⁄eTmpHigh
, (*)
hi_pmm
, (*)hi_pmm + 
hi_pmm_size
);

451 
	`addS∑˚
(&
Z⁄eTmpLow
, (*)
low_pmm
, (*Óow_pmm + 
low_pmm_size
);

452 
	}
}

454 
u32
 
LegacyRamSize
 
	gVARFSEG
;

458 
	$ˇlcRamSize
()

460 
u32
 
rs
 = 0;

461 
i
;

462 
i
=
e820_cou¡
-1; i>=0; i--) {

463 
e820íåy
 *
í
 = &
e820_li°
[
i
];

464 
u64
 
íd
 = 
í
->
°¨t
 +Én->
size
;

465 
u32
 
ty≥
 = 
í
->type;

466 i‡(
íd
 <0xfffffff‡&& (
ty≥
 =
E820_ACPI
 ||Åy≥ =
E820_RAM
)) {

467 
rs
 = 
íd
;

471 
LegacyRamSize
 = 
rs
 >= 1024*1024 ?Ñs : 1024*1024;

472 
	}
}

476 
	$mÆloc_öô
()

478 
	`ASSERT32FLAT
();

479 
	`d¥ötf
(3, "malloc init\n");

481 i‡(
CONFIG_RELOCATE_INIT
) {

483 
i
;

484 
i
=0; i<
	`ARRAY_SIZE
(
Z⁄es
); i++) {

485 
z⁄e_s
 *
z⁄e
 = 
Z⁄es
[
i
];

486 i‡(
z⁄e
->
hód
.
fú°
)

487 
z⁄e
->
hód
.
fú°
->
µªv
 = &zone->head.first;

492 
u8
 
v¨low_°¨t
[], 
v¨low_íd
[], 
föÆ_v¨low_°¨t
[];

493 
	`memmove
(
föÆ_v¨low_°¨t
, 
v¨low_°¨t
, 
v¨low_íd
 - varlow_start);

494 i‡(
CONFIG_MALLOC_UPPERMEMORY
) {

495 
	`addS∑˚
(&
Z⁄eLow
, 
z⁄ñow_ba£
 + 
OPROM_HEADER_RESERVE


496 , 
föÆ_v¨low_°¨t
);

497 
RomBa£
 = 
	`födLa°
(&
Z⁄eLow
);

499 
	`addS∑˚
(&
Z⁄eLow
, (*)
	`ALIGN_DOWN
((
u32
)
föÆ_v¨low_°¨t
, 1024)

500 , 
föÆ_v¨low_°¨t
);

504 
u8
 
z⁄ef£g_°¨t
[], 
z⁄ef£g_íd
[];

505 
	`mem£t
(
z⁄ef£g_°¨t
, 0, 
z⁄ef£g_íd
 - zonefseg_start);

506 
	`addS∑˚
(&
Z⁄eFSeg
, 
z⁄ef£g_°¨t
, 
z⁄ef£g_íd
);

508 
	`ˇlcRamSize
();

509 
	}
}

512 
	$mÆloc_¥ïboŸ
()

514 
	`ASSERT32FLAT
();

515 
	`d¥ötf
(3, "malloc finalize\n");

517 
u32
 
ba£
 = 
	`rom_gë_max
();

518 
	`mem£t
((*)
RomEnd
, 0, 
ba£
-RomEnd);

519 i‡(
CONFIG_MALLOC_UPPERMEMORY
) {

521 
rom_hódî
 *
dummyrom
 = (*)
ba£
;

522 
dummyrom
->
sig«tuª
 = 
OPTION_ROM_SIGNATURE
;

523 
size
 = (
BUILD_BIOS_ADDR
 - 
ba£
) / 512;

524 
dummyrom
->
size
 = (size > 255) ? 255 : size;

528 
u32
 
ídlow
 = 
	`GET_BDA
(
mem_size_kb
)*1024;

529 
	`add_e820
(
ídlow
, 
BUILD_LOWRAM_END
-ídlow, 
E820_RESERVED
);

532 
Ælocöfo_s
 *
öfo
 = 
	`födLa°
(&
Z⁄eFSeg
);

533 
	`mem£t
(
öfo
->
d©´nd
, 0, info->
Ælo˚nd
 - info->dataend);

534 
	`d¥ötf
(1, "Spaceávailable for UMB: %x-%x, %x-%x\n"

535 , 
RomEnd
, 
ba£
, (
u32
)
öfo
->
d©´nd
, (u32)öfo->
Ælo˚nd
);

538 
öfo
 = 
	`födLa°
(&
Z⁄eHigh
);

539 i‡(
öfo
) {

540 
u32
 
giveback
 = 
	`ALIGN_DOWN
(
öfo
->
Ælo˚nd
 - info->
d©´nd
, 
PAGE_SIZE
);

541 
	`add_e820
((
u32
)
öfo
->
d©´nd
, 
giveback
, 
E820_RAM
);

542 
	`d¥ötf
(1, "Rëu∫ed %d byã†o‡Z⁄eHigh\n", 
giveback
);

545 
	`ˇlcRamSize
();

546 
	}
}

	@malloc.h

1 #i‚de‡
__MALLOC_H


2 
	#__MALLOC_H


	)

4 
	~"ty≥s.h
"

7 
z⁄e_s
 
Z⁄eLow
, 
Z⁄eHigh
, 
Z⁄eFSeg
, 
Z⁄eTmpLow
, 
Z⁄eTmpHigh
;

8 
u32
 
rom_gë_max
();

9 
u32
 
rom_gë_œ°
();

10 
rom_hódî
 *
rom_ª£rve
(
u32
 
size
);

11 
rom_c⁄fúm
(
u32
 
size
);

12 
csm_mÆloc_¥eöô
(
u32
 
low_pmm
, u32 
low_pmm_size
, u32 
hi_pmm
,

13 
u32
 
hi_pmm_size
);

14 
mÆloc_¥eöô
();

15 
u32
 
LegacyRamSize
;

16 
mÆloc_öô
();

17 
mÆloc_¥ïboŸ
();

18 *
_mÆloc
(
z⁄e_s
 *
z⁄e
, 
u32
 
size
, u32 
Æign
);

19 
_‰ì
(*
d©a
);

20 
u32
 
mÆloc_gë•a˚
(
z⁄e_s
 *
z⁄e
);

21 
mÆloc_£th™dÀ
(*
d©a
, 
u32
 
h™dÀ
);

22 *
mÆloc_födh™dÀ
(
u32
 
h™dÀ
);

24 
	#MALLOC_DEFAULT_HANDLE
 0xFFFFFFFF

	)

26 
	#MALLOC_MIN_ALIGN
 16

	)

28 
ölöe
 *
	$mÆloc_low
(
u32
 
size
) {

29  
	`_mÆloc
(&
Z⁄eLow
, 
size
, 
MALLOC_MIN_ALIGN
);

30 
	}
}

31 
ölöe
 *
	$mÆloc_high
(
u32
 
size
) {

32  
	`_mÆloc
(&
Z⁄eHigh
, 
size
, 
MALLOC_MIN_ALIGN
);

33 
	}
}

34 
ölöe
 *
	$mÆloc_f£g
(
u32
 
size
) {

35  
	`_mÆloc
(&
Z⁄eFSeg
, 
size
, 
MALLOC_MIN_ALIGN
);

36 
	}
}

37 
ölöe
 *
	$mÆloc_tm∂ow
(
u32
 
size
) {

38  
	`_mÆloc
(&
Z⁄eTmpLow
, 
size
, 
MALLOC_MIN_ALIGN
);

39 
	}
}

40 
ölöe
 *
	$mÆloc_tmphigh
(
u32
 
size
) {

41  
	`_mÆloc
(&
Z⁄eTmpHigh
, 
size
, 
MALLOC_MIN_ALIGN
);

42 
	}
}

43 
ölöe
 *
	$mÆloc_tmp
(
u32
 
size
) {

44 *
ªt
 = 
	`mÆloc_tmphigh
(
size
);

45 i‡(
ªt
)

46  
ªt
;

47  
	`mÆloc_tm∂ow
(
size
);

48 
	}
}

49 
ölöe
 *
	$memÆign_low
(
u32
 
Æign
, u32 
size
) {

50  
	`_mÆloc
(&
Z⁄eLow
, 
size
, 
Æign
);

51 
	}
}

52 
ölöe
 *
	$memÆign_high
(
u32
 
Æign
, u32 
size
) {

53  
	`_mÆloc
(&
Z⁄eHigh
, 
size
, 
Æign
);

54 
	}
}

55 
ölöe
 *
	$memÆign_tm∂ow
(
u32
 
Æign
, u32 
size
) {

56  
	`_mÆloc
(&
Z⁄eTmpLow
, 
size
, 
Æign
);

57 
	}
}

58 
ölöe
 *
	$memÆign_tmphigh
(
u32
 
Æign
, u32 
size
) {

59  
	`_mÆloc
(&
Z⁄eTmpHigh
, 
size
, 
Æign
);

60 
	}
}

61 
ölöe
 *
	$memÆign_tmp
(
u32
 
Æign
, u32 
size
) {

62 *
ªt
 = 
	`memÆign_tmphigh
(
Æign
, 
size
);

63 i‡(
ªt
)

64  
ªt
;

65  
	`memÆign_tm∂ow
(
Æign
, 
size
);

66 
	}
}

67 
ölöe
 
	$‰ì
(*
d©a
) {

68 
	`_‰ì
(
d©a
);

69 
	}
}

	@memmap.c

7 
	~"c⁄fig.h
"

8 
	~"memm≠.h
"

9 
	~"ouçut.h
"

10 
	~"°rög.h
"

18 
e820íåy
 
	ge820_li°
[
BUILD_MAX_E820
] 
	gVARFSEG
;

19 
e820_cou¡
 
	gVARFSEG
;

23 
	$ªmove_e820
(
i
)

25 
e820_cou¡
--;

26 
	`memmove
(&
e820_li°
[
i
], &e820_list[i+1]

27 , (
e820_li°
[0]Ë* (
e820_cou¡
 - 
i
));

28 
	}
}

32 
	$ö£π_e820
(
i
, 
u64
 
°¨t
, u64 
size
, 
u32
 
ty≥
)

34 i‡(
e820_cou¡
 >
BUILD_MAX_E820
) {

35 
	`w¨n_nﬂŒoc
();

39 
	`memmove
(&
e820_li°
[
i
+1], &e820_list[i]

40 , (
e820_li°
[0]Ë* (
e820_cou¡
 - 
i
));

41 
e820_cou¡
++;

42 
e820íåy
 *
e
 = &
e820_li°
[
i
];

43 
e
->
°¨t
 = start;

44 
e
->
size
 = size;

45 
e
->
ty≥
 =Åype;

46 
	}
}

49 
	$e820_ty≥_«me
(
u32
 
ty≥
)

51 
ty≥
) {

52 
E820_RAM
:  "RAM";

53 
E820_RESERVED
:  "RESERVED";

54 
E820_ACPI
:  "ACPI";

55 
E820_NVS
:  "NVS";

56 
E820_UNUSABLE
:  "UNUSABLE";

57 
E820_HOLE
:  "HOLE";

60 
	}
}

64 
	$dump_m≠
()

66 
	`d¥ötf
(1, "e820 m≠ ha†%d iãms:\n", 
e820_cou¡
);

67 
i
;

68 
i
=0; i<
e820_cou¡
; i++) {

69 
e820íåy
 *
e
 = &
e820_li°
[
i
];

70 
u64
 
e_íd
 = 
e
->
°¨t
 +É->
size
;

71 
	`d¥ötf
(1, " %d: %016Œx - %016Œx = %d %s\n", 
i


72 , 
e
->
°¨t
, 
e_íd
,É->
ty≥
, 
	`e820_ty≥_«me
(e->type));

74 
	}
}

79 
	$add_e820
(
u64
 
°¨t
, u64 
size
, 
u32
 
ty≥
)

81 
	`d¥ötf
(8, "AddÅÿe820 m≠: %08x %08x %d\n", (
u32
)
°¨t
, (u32)
size
, 
ty≥
);

83 i‡(! 
size
)

88 
u64
 
íd
 = 
°¨t
 + 
size
;

89 
i
;

90 
i
=0; i<
e820_cou¡
; i++) {

91 
e820íåy
 *
e
 = &
e820_li°
[
i
];

92 
u64
 
e_íd
 = 
e
->
°¨t
 +É->
size
;

93 i‡(
°¨t
 > 
e_íd
)

96 i‡(
°¨t
 > 
e
->start) {

97 i‡(
ty≥
 =
e
->type) {

99 
size
 +
°¨t
 - 
e
->start;

100 
°¨t
 = 
e
->start;

103 
e
->
size
 = 
°¨t
 -É->start;

104 
i
++;

105 i‡(
e_íd
 > 
íd
)

106 
	`ö£π_e820
(
i
, 
íd
, 
e_íd
 -Énd, 
e
->
ty≥
);

112 
i
<
e820_cou¡
) {

113 
e820íåy
 *
e
 = &
e820_li°
[
i
];

114 i‡(
íd
 < 
e
->
°¨t
)

117 
u64
 
e_íd
 = 
e
->
°¨t
 +É->
size
;

118 i‡(
íd
 >
e_íd
) {

120 
	`ªmove_e820
(
i
);

124 
e
->
°¨t
 = 
íd
;

125 
e
->
size
 = 
e_íd
 - 
íd
;

126 i‡(
ty≥
 =
e
->type) {

128 
size
 +
e
->size;

129 
	`ªmove_e820
(
i
);

134 i‡(
ty≥
 !
E820_HOLE
)

135 
	`ö£π_e820
(
i
, 
°¨t
, 
size
, 
ty≥
);

137 
	}
}

141 
	$memm≠_¥ïboŸ
()

143 
	`dump_m≠
();

144 
	}
}

	@memmap.h

1 #i‚de‡
__E820MAP_H


2 
	#__E820MAP_H


	)

4 
	~"ty≥s.h
"

6 
	#E820_RAM
 1

	)

7 
	#E820_RESERVED
 2

	)

8 
	#E820_ACPI
 3

	)

9 
	#E820_NVS
 4

	)

10 
	#E820_UNUSABLE
 5

	)

11 
	#E820_HOLE
 ((
u32
)-1)

12 

	)

13 
	se820íåy
 {

14 
u64
 
	m°¨t
;

15 
u64
 
	msize
;

16 
u32
 
	mty≥
;

19 
add_e820
(
u64
 
°¨t
, u64 
size
, 
u32
 
ty≥
);

20 
memm≠_¥ïboŸ
();

23 
	#PAGE_SIZE
 4096

	)

26 
e820íåy
 
e820_li°
[];

27 
e820_cou¡
;

	@misc.c

9 
	~"biosv¨.h
"

10 
	~"bªgs.h
"

11 
	~"hw/pic.h
"

12 
	~"ouçut.h
"

13 
	~"°acks.h
"

14 
	~"°rög.h
"

15 
	~"hw/£rülio.h
"

17 
	#PORT_MATH_CLEAR
 0x00f0

	)

25 
VISIBLE16


26 
	$h™dÀ_12
(
bªgs
 *
ªgs
)

28 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_12
);

29 
ªgs
->
ax
 = 
	`GET_BDA
(
mem_size_kb
);

30 
	}
}

33 
VISIBLE16


34 
	$h™dÀ_11
(
bªgs
 *
ªgs
)

36 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_11
);

37 
ªgs
->
ax
 = 
	`GET_BDA
(
equùmít_li°_Êags
);

38 
	}
}

41 
VISIBLE16


42 
	$h™dÀ_05
(
bªgs
 *
ªgs
)

44 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_05
);

45 
	}
}

47 #i‡
CONFIG_INT10_SERIAL_CONSOLE


49 
	$öt10_com_ouçut
–
c
 )

51 
	#UART_THRE
 (1 << 5)

	)

52 
timeout
 = 100000;

54 (
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_LSR
Ë& 
UART_THRE
) != UART_THRE)

55 i‡(!
timeout
--) ;

56 
	`outb
(
c
, 
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_DATA
);

57 
	}
}

61 
VISIBLE16


62 
	$h™dÀ_10
(
bªgs
 *
ªgs
)

64 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_10
);

66 #i‡
CONFIG_INT10_SERIAL_CONSOLE


74 
ªgs
->
ah
) {

77 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


78 i‡(
	`GET_BDA
(
video_mode
Ë=
UART_OUTPUT_ENABLED
)

80 
	`öt10_com_ouçut
(
ªgs
->
Æ
);

83 
	`d¥ötf
(2, "unh™dÀd INT10áh=%xál=%x\n",
ªgs
->
ah
,ªgs->
Æ
);

87 
	}
}

90 
VISIBLE16


91 
	$h™dÀ_02
()

93 
	`debug_i§
(
DEBUG_ISR_02
);

94 
	}
}

97 
	$m©h˝_£tup
()

99 
	`d¥ötf
(3, "math cp init\n");

101 
	`£t_equùmít_Êags
(0x02, 0x02);

102 
	`íabÀ_hwúq
(13, 
	`FUNC16
(
íåy_75
));

103 
	}
}

106 
VISIBLE16


107 
	$h™dÀ_75
()

109 
	`debug_i§
(
DEBUG_ISR_75
);

112 
	`outb
(0, 
PORT_MATH_CLEAR
);

114 
	`pic_eoi2
();

116 
bªgs
 
br
;

117 
	`mem£t
(&
br
, 0, (br));

118 
br
.
Êags
 = 
F_IF
;

119 
	`ˇŒ16_öt
(0x02, &
br
);

120 
	}
}

128 
	#CBT_F1_DMA3USED
 (1<<7)

	)

130 
	#CBT_F1_2NDPIC
 (1<<6)

	)

132 
	#CBT_F1_RTC
 (1<<5)

	)

134 
	#CBT_F1_INT154F
 (1<<4)

	)

136 
	#CBT_F1_WAITEXT
 (1<<3)

	)

138 
	#CBT_F1_EBDA
 (1<<2)

	)

140 
	#CBT_F1_MCA
 (1<<1)

	)

142 
	#CBT_F1_MCAISA
 (1<<0)

	)

145 
	#CBT_F2_INT1609
 (1<<6)

	)

147 
bios_c⁄fig_èbÀ_s
 
BIOS_CONFIG_TABLE
 
VAR16FIXED
(0xe6f5) = {

148 .
size
 = (
BIOS_CONFIG_TABLE
) - 2,

149 .
	gmodñ
 = 
BUILD_MODEL_ID
,

150 .
	gsubmodñ
 = 
BUILD_SUBMODEL_ID
,

151 .
	gbio§ev
 = 
BUILD_BIOS_REVISION
,

152 .
	g„©uª1
 = (

153 
CBT_F1_2NDPIC
 | 
CBT_F1_RTC
 | 
CBT_F1_EBDA


154 | (
CONFIG_KBD_CALL_INT15_4F
 ? 
CBT_F1_INT154F
 : 0)),

155 .
	g„©uª2
 = 
CBT_F2_INT1609
,

156 .
	g„©uª3
 = 0,

157 .
	g„©uª4
 = 0,

158 .
	g„©uª5
 = 0,

167 
des˛oc_s
 
rmode_IDT_öfo
 
	gVARFSEG
 = {

168 .
Àngth
 = (
rmode_IVT
) - 1,

169 .
	gaddr
 = (
u32
)
MAKE_FLATPTR
(
SEG_IVT
, 0),

174 
u8
 
dummy_IDT
 
	gVARFSEG
;

177 
des˛oc_s
 
pmode_IDT_öfo
 
	gVARFSEG
 = {

178 .
Àngth
 = (
dummy_IDT
) - 1,

179 .
	gaddr
 = (
u32
)&
dummy_IDT
,

183 
u64
 
	grombios32_gdt
[] 
VARFSEG
 
__Æig√d
(8) = {

187 
GDT_GRANLIMIT
(0xffffffffË| 
GDT_CODE
 | 
GDT_B
,

189 
GDT_GRANLIMIT
(0xffffffffË| 
GDT_DATA
 | 
GDT_B
,

191 
GDT_LIMIT
(
BUILD_BIOS_SIZE
-1Ë| 
GDT_CODE
 | 
GDT_BASE
(
BUILD_BIOS_ADDR
),

193 
GDT_LIMIT
(0x0ffffË| 
GDT_DATA
,

195 
GDT_GRANLIMIT
(0xffffffffË| 
GDT_CODE
 | 
GDT_BASE
(
BUILD_BIOS_ADDR
),

197 
GDT_GRANLIMIT
(0xffffffffË| 
GDT_DATA
,

201 
des˛oc_s
 
rombios32_gdt_48
 
	gVARFSEG
 = {

202 .
Àngth
 = (
rombios32_gdt
) - 1,

203 .
	gaddr
 = (
u32
)
rombios32_gdt
,

211 
	gBiosC›yright
[] 
VAR16FIXED
(0xff00) =

215 
	gBiosD©e
[] 
VAR16FIXED
(0xfff5) = "06/23/99";

217 
u8
 
BiosModñId
 
VAR16FIXED
(0xff„Ë
BUILD_MODEL_ID
;

219 
u8
 
BiosChecksum
 
VAR16FIXED
(0xffff);

222 
u8
 
	gInôVe˘‹s
[13] 
VAR16FIXED
(0xfef3);

225 
u8
 
	gVideoP¨ams
[88] 
VAR16FIXED
(0xf0a4);

	@mouse.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"hw/ps2p‹t.h
"

11 
	~"hw/usb-hid.h
"

12 
	~"ouçut.h
"

13 
	~"°acks.h
"

14 
	~"utû.h
"

17 
	$mou£_öô
()

19 i‡(! 
CONFIG_MOUSE
)

21 
	`d¥ötf
(3, "init mouse\n");

23 
	`£t_equùmít_Êags
(0x04, 0x04);

24 
	}
}

27 
	$mou£_comm™d
(
comm™d
, 
u8
 *
∑øm
)

29 i‡(
	`usb_mou£_a˘ive
())

30  
	`°ack_h›
(
comm™d
, (
u32
)
∑øm
, 
usb_mou£_comm™d
);

31  
	`°ack_h›
(
comm™d
, (
u32
)
∑øm
, 
ps2_mou£_comm™d
);

32 
	}
}

34 
	#RET_SUCCESS
 0x00

	)

35 
	#RET_EINVFUNCTION
 0x01

	)

36 
	#RET_EINVINPUT
 0x02

	)

37 
	#RET_EINTERFACE
 0x03

	)

38 
	#RET_ENEEDRESEND
 0x04

	)

39 
	#RET_ENOHANDLER
 0x05

	)

43 
	$mou£_15c20000
(
bªgs
 *
ªgs
)

45 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_DISABLE
, 
NULL
);

46 i‡(
ªt
)

47 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

49 
	`£t_code_suc˚ss
(
ªgs
);

50 
	}
}

54 
	$mou£_15c20001
(
bªgs
 *
ªgs
)

56 
u16
 
ebda_£g
 = 
	`gë_ebda_£g
();

57 
u8
 
mou£_Êags_2
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_Êag2
);

58 i‡((
mou£_Êags_2
 & 0x80) == 0) {

59 
	`£t_code_övÆid
(
ªgs
, 
RET_ENOHANDLER
);

63 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_ENABLE
, 
NULL
);

64 i‡(
ªt
)

65 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

67 
	`£t_code_suc˚ss
(
ªgs
);

68 
	}
}

71 
	$mou£_15c200XX
(
bªgs
 *
ªgs
)

73 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EINVFUNCTION
);

74 
	}
}

78 
	$mou£_15c200
(
bªgs
 *
ªgs
)

80 
ªgs
->
bh
) {

81 0x00: 
	`mou£_15c20000
(
ªgs
); ;

82 0x01: 
	`mou£_15c20001
(
ªgs
); ;

83 : 
	`mou£_15c200XX
(
ªgs
); ;

85 
	}
}

89 
	$mou£_15c201
(
bªgs
 *
ªgs
)

91 
u8
 
∑øm
[2];

92 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_RESET_BAT
, 
∑øm
);

93 i‡(
ªt
) {

94 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

97 
ªgs
->
bl
 = 
∑øm
[0];

98 
ªgs
->
bh
 = 
∑øm
[1];

99 
	`£t_code_suc˚ss
(
ªgs
);

100 
	}
}

104 
	$mou£_15c202
(
bªgs
 *
ªgs
)

106 
u8
 
VAR16
 
ßm∂e_øãs
[7] = {10, 20, 40, 60, 80, 100, 200};

107 i‡(
ªgs
->
bh
 >
	`ARRAY_SIZE
(
ßm∂e_øãs
)) {

108 
	`£t_code_övÆid
(
ªgs
, 
RET_EINVINPUT
);

111 
u8
 
mou£_d©a1
 = 
	`GET_GLOBAL
(
ßm∂e_øãs
[
ªgs
->
bh
]);

112 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_SETRATE
, &
mou£_d©a1
);

113 i‡(
ªt
)

114 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

116 
	`£t_code_suc˚ss
(
ªgs
);

117 
	}
}

121 
	$mou£_15c203
(
bªgs
 *
ªgs
)

128 i‡(
ªgs
->
bh
 >= 4) {

129 
	`£t_code_övÆid
(
ªgs
, 
RET_EINVINPUT
);

132 
u8
 
∑øm
 = 
ªgs
->
bh
;

133 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_SETRES
, &
∑øm
);

134 i‡(
ªt
)

135 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

137 
	`£t_code_suc˚ss
(
ªgs
);

138 
	}
}

142 
	$mou£_15c204
(
bªgs
 *
ªgs
)

144 
u8
 
∑øm
[2];

145 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_GETID
, 
∑øm
);

146 i‡(
ªt
) {

147 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

150 
ªgs
->
bh
 = 
∑øm
[0];

151 
	`£t_code_suc˚ss
(
ªgs
);

152 
	}
}

156 
	$mou£_15c205
(
bªgs
 *
ªgs
)

158 i‡(
ªgs
->
bh
 != 3) {

159 
	`£t_code_övÆid
(
ªgs
, 
RET_EINTERFACE
);

162 
u16
 
ebda_£g
 = 
	`gë_ebda_£g
();

163 
	`SET_EBDA
(
ebda_£g
, 
mou£_Êag1
, 0x00);

164 
	`SET_EBDA
(
ebda_£g
, 
mou£_Êag2
, 
ªgs
->
bh
);

167 
	`mou£_15c201
(
ªgs
);

168 
	}
}

172 
	$mou£_15c20600
(
bªgs
 *
ªgs
)

174 
u8
 
∑øm
[3];

175 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_GETINFO
, 
∑øm
);

176 i‡(
ªt
) {

177 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

180 
ªgs
->
bl
 = 
∑øm
[0];

181 
ªgs
->
˛
 = 
∑øm
[1];

182 
ªgs
->
dl
 = 
∑øm
[2];

183 
	`£t_code_suc˚ss
(
ªgs
);

184 
	}
}

188 
	$mou£_15c20601
(
bªgs
 *
ªgs
)

190 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_SETSCALE11
, 
NULL
);

191 i‡(
ªt
)

192 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

194 
	`£t_code_suc˚ss
(
ªgs
);

195 
	}
}

199 
	$mou£_15c20602
(
bªgs
 *
ªgs
)

201 
ªt
 = 
	`mou£_comm™d
(
PSMOUSE_CMD_SETSCALE21
, 
NULL
);

202 i‡(
ªt
)

203 
	`£t_code_övÆid
(
ªgs
, 
RET_ENEEDRESEND
);

205 
	`£t_code_suc˚ss
(
ªgs
);

206 
	}
}

209 
	$mou£_15c206XX
(
bªgs
 *
ªgs
)

211 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EINVFUNCTION
);

212 
	}
}

216 
	$mou£_15c206
(
bªgs
 *
ªgs
)

218 
ªgs
->
bh
) {

219 0x00: 
	`mou£_15c20600
(
ªgs
); ;

220 0x01: 
	`mou£_15c20601
(
ªgs
); ;

221 0x02: 
	`mou£_15c20602
(
ªgs
); ;

222 : 
	`mou£_15c206XX
(
ªgs
); ;

224 
	}
}

228 
	$mou£_15c207
(
bªgs
 *
ªgs
)

230 
£goff_s
 
ÁΩå
 = 
	`SEGOFF
(
ªgs
->
es
,Ñegs->
bx
);

231 
u16
 
ebda_£g
 = 
	`gë_ebda_£g
();

232 
u8
 
mou£_Êags_2
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_Êag2
);

233 i‡(! 
ÁΩå
.
£goff
) {

235 i‡((
mou£_Êags_2
 & 0x80) != 0) {

236 
mou£_Êags_2
 &= ~0x80;

237 
	`mou£_comm™d
(
PSMOUSE_CMD_DISABLE
, 
NULL
);

241 
mou£_Êags_2
 |= 0x80;

243 
	`SET_EBDA
(
ebda_£g
, 
mou£_Êag2
, 
mou£_Êags_2
);

244 
	`SET_EBDA
(
ebda_£g
, 
Ár_ˇŒ_poöãr
, 
ÁΩå
);

245 
	`£t_code_suc˚ss
(
ªgs
);

246 
	}
}

249 
	$mou£_15c2XX
(
bªgs
 *
ªgs
)

251 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EINVFUNCTION
);

252 
	}
}

255 
	$h™dÀ_15c2
(
bªgs
 *
ªgs
)

259 i‡(! 
CONFIG_MOUSE
) {

260 
	`£t_code_övÆid
(
ªgs
, 
RET_EUNSUPPORTED
);

264 
ªgs
->
Æ
) {

265 0x00: 
	`mou£_15c200
(
ªgs
); ;

266 0x01: 
	`mou£_15c201
(
ªgs
); ;

267 0x02: 
	`mou£_15c202
(
ªgs
); ;

268 0x03: 
	`mou£_15c203
(
ªgs
); ;

269 0x04: 
	`mou£_15c204
(
ªgs
); ;

270 0x05: 
	`mou£_15c205
(
ªgs
); ;

271 0x06: 
	`mou£_15c206
(
ªgs
); ;

272 0x07: 
	`mou£_15c207
(
ªgs
); ;

273 : 
	`mou£_15c2XX
(
ªgs
); ;

275 
	}
}

278 
	$övoke_mou£_h™dÀr
(
u16
 
ebda_£g
)

280 
u16
 
°©us
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_d©a
[0]);

281 
u16
 
X
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_d©a
[1]);

282 
u16
 
Y
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_d©a
[2]);

284 
£goff_s
 
func
 = 
	`GET_EBDA
(
ebda_£g
, 
Ár_ˇŒ_poöãr
);

285 
	`d¥ötf
(16, "mouse farcall s=%04x x=%04x y=%04x func=%04x:%04x\n"

286 , 
°©us
, 
X
, 
Y
, 
func
.
£g
, func.
off£t
);

288 
asm
 volatile(

303 : "+a"(
func
.
£goff
), "+c"(
°©us
), "+d"(
X
), "+b"(
Y
)

306 
	}
}

309 
	$¥o˚ss_mou£
(
u8
 
d©a
)

311 i‡(!
CONFIG_MOUSE
)

314 
u16
 
ebda_£g
 = 
	`gë_ebda_£g
();

315 
u8
 
mou£_Êags_1
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_Êag1
);

316 
u8
 
mou£_Êags_2
 = 
	`GET_EBDA
(
ebda_£g
, 
mou£_Êag2
);

318 i‡(! (
mou£_Êags_2
 & 0x80))

322 
u8
 
∑ckage_cou¡
 = 
mou£_Êags_2
 & 0x07;

323 
u8
 
ödex
 = 
mou£_Êags_1
 & 0x07;

324 
	`SET_EBDA
(
ebda_£g
, 
mou£_d©a
[
ödex
], 
d©a
);

326 i‡((
ödex
+1Ë< 
∑ckage_cou¡
) {

327 
mou£_Êags_1
++;

328 
	`SET_EBDA
(
ebda_£g
, 
mou£_Êag1
, 
mou£_Êags_1
);

332 
	`SET_EBDA
(
ebda_£g
, 
mou£_Êag1
, 0);

333 
	`°ack_h›_back
(
ebda_£g
, 0, 
övoke_mou£_h™dÀr
);

334 
	}
}

	@optionroms.c

9 
	~"bªgs.h
"

10 
	~"c⁄fig.h
"

11 
	~"ÁΩå.h
"

12 
	~"hw/pci.h
"

13 
	~"hw/pci_ids.h
"

14 
	~"hw/pci_ªgs.h
"

15 
	~"mÆloc.h
"

16 
	~"ouçut.h
"

17 
	~"romfûe.h
"

18 
	~"°acks.h
"

19 
	~"°d/›ti⁄rom.h
"

20 
	~"°d/≤pbios.h
"

21 
	~"°rög.h
"

22 
	~"utû.h
"

31 
	$__ˇŒrom
(
rom_hódî
 *
rom
, 
u16
 
off£t
, u16 
bdf
)

33 
u16
 
£g
 = 
	`FLATPTR_TO_SEG
(
rom
);

34 
	`d¥ötf
(1, "Ru¬ög o±i⁄Ñomáà%04x:%04x\n", 
£g
, 
off£t
);

36 
bªgs
 
br
;

37 
	`mem£t
(&
br
, 0, (br));

38 
br
.
Êags
 = 
F_IF
;

39 
br
.
ax
 = 
bdf
;

40 
br
.
bx
 = 0xffff;

41 
br
.
dx
 = 0xffff;

42 
br
.
es
 = 
SEG_BIOS
;

43 
br
.
di
 = 
	`gë_≤p_off£t
();

44 
br
.
code
 = 
	`SEGOFF
(
£g
, 
off£t
);

45 
	`°¨t_¥ìm±
();

46 
	`ÁrˇŒ16big
(&
br
);

47 
	`föish_¥ìm±
();

48 
	}
}

52 
	$ˇŒrom
(
rom_hódî
 *
rom
, 
u16
 
bdf
)

54 
	`__ˇŒrom
(
rom
, 
OPTION_ROM_INITVECTOR
, 
bdf
);

55 
	}
}

59 
	$ˇŒ_bcv
(
u16
 
£g
, u16 
ù
)

61 
	`__ˇŒrom
(
	`MAKE_FLATPTR
(
£g
, 0), 
ù
, 0);

62 
	}
}

64 
	gEnf‹˚Checksum
;

68 
	$is_vÆid_rom
(
rom_hódî
 *
rom
)

70 
	`d¥ötf
(6, "CheckingÑom %p (sig %x size %d)\n"

71 , 
rom
,Ñom->
sig«tuª
,Ñom->
size
);

72 i‡(
rom
->
sig«tuª
 !
OPTION_ROM_SIGNATURE
)

74 i‡(! 
rom
->
size
)

76 
u32
 
Àn
 = 
rom
->
size
 * 512;

77 
u8
 
sum
 = 
	`checksum
(
rom
, 
Àn
);

78 i‡(
sum
 != 0) {

79 
	`d¥ötf
(1, "Found optionÑom with bad checksum:Üoc=%pÜen=%d sum=%x\n"

80 , 
rom
, 
Àn
, 
sum
);

81 i‡(
Enf‹˚Checksum
)

85 
	}
}

88 
≤p_d©a
 *

89 
	$gë_≤p_rom
(
rom_hódî
 *
rom
)

91 
≤p_d©a
 *
≤p
 = (*)((
u8
*)
rom
 +Ñom->
≤poff£t
);

92 i‡(
≤p
->
sig«tuª
 !
PNP_SIGNATURE
)

93  
NULL
;

94  
≤p
;

95 
	}
}

98 
≤p_d©a
 *

99 
	$gë_≤p_√xt
(
rom_hódî
 *
rom
, 
≤p_d©a
 *
≤p
)

101 i‡(! 
≤p
->
√xtoff£t
)

102  
NULL
;

103 
≤p
 = (*)((
u8
*)
rom
 +Ö≈->
√xtoff£t
);

104 i‡(
≤p
->
sig«tuª
 !
PNP_SIGNATURE
)

105  
NULL
;

106  
≤p
;

107 
	}
}

110 
pci_d©a
 *

111 
	$gë_pci_rom
(
rom_hódî
 *
rom
)

113 
pci_d©a
 *
pd
 = (*)((
u32
)
rom
 +Ñom->
pcioff£t
);

114 i‡(
pd
->
sig«tuª
 !
PCI_ROM_SIGNATURE
)

115  
NULL
;

116 i‡(
rom
->
pcioff£t
 & 3)

117 
	`d¥ötf
(1, "WARNING! Found unaligned PCIÑom (vd=%04x:%04x)\n"

118 , 
pd
->
víd‹
,Öd->
devi˚
);

119  
pd
;

120 
	}
}

124 
	$öô_›ti⁄rom
(
rom_hódî
 *
rom
, 
u16
 
bdf
, 
isvga
)

126 #i‡
CONFIG_PRINT_TIMESTAMPS


127 
u64
 
tscvÆ
;

128 *
romty≥
;

131 i‡(! 
	`is_vÆid_rom
(
rom
))

133 
rom_hódî
 *
√wrom
 = 
	`rom_ª£rve
(
rom
->
size
 * 512);

134 i‡(!
√wrom
) {

135 
	`w¨n_nﬂŒoc
();

138 i‡(
√wrom
 !
rom
)

139 
	`memmove
(
√wrom
, 
rom
,Ñom->
size
 * 512);

141 i‡(
isvga
 || 
	`gë_≤p_rom
(
√wrom
)) {

142 #i‡
CONFIG_PRINT_TIMESTAMPS


143 
tscvÆ
 = 
	`rdts˛l
();

144 i‡(
isvga
)

145 
romty≥
 = "VBIOS";

147 
romty≥
 = "optionÑom";

148 
	`d¥ötf
(1, "TSC: Bef‹ê%s: 0x%08lx_%08lx\n", 
romty≥
,

149 ()(
tscvÆ
 >> 32),

150 ()
tscvÆ
);

154 
	`ˇŒrom
(
√wrom
, 
bdf
);

156 #i‡
CONFIG_PRINT_TIMESTAMPS


157 
tscvÆ
 = 
	`rdts˛l
();

158 
	`d¥ötf
(1, "TSC: A·î %s: 0x%08lx_%08lx\n", 
romty≥
,

159 ()(
tscvÆ
 >> 32),

160 ()
tscvÆ
);

164  
	`rom_c⁄fúm
(
√wrom
->
size
 * 512);

165 
	}
}

167 
	#RS_PCIROM
 (1LL<<33)

	)

170 
	$£tRomSour˚
(
u64
 *
sour˚s
, 
rom_hódî
 *
rom
, u64 
sour˚
)

172 i‡(
sour˚s
)

173 
sour˚s
[((
u32
)
rom
 - 
BUILD_ROM_START
Ë/ 
OPTION_ROM_ALIGN
] = 
sour˚
;

174 
	}
}

177 
	$gëRomPri‹ôy
(
u64
 *
sour˚s
, 
rom_hódî
 *
rom
, 
ö°™˚
)

179 
u64
 
sour˚
 = 
sour˚s
[((
u32
)
rom
 - 
BUILD_ROM_START
Ë/ 
OPTION_ROM_ALIGN
];

180 i‡(!
sour˚
)

182 i‡(
sour˚
 & 
RS_PCIROM
)

183  
	`boŸ¥io_föd_pci_rom
((*)(
u32
)
sour˚
, 
ö°™˚
);

184 
romfûe_s
 *
fûe
 = (*)(
u32
)
sour˚
;

185  
	`boŸ¥io_föd_«med_rom
(
fûe
->
«me
, 
ö°™˚
);

186 
	}
}

193 
rom_hódî
 *

194 
	$dïloy_romfûe
(
romfûe_s
 *
fûe
)

196 
u32
 
size
 = 
fûe
->size;

197 
rom_hódî
 *
rom
 = 
	`rom_ª£rve
(
size
);

198 i‡(!
rom
) {

199 
	`w¨n_nﬂŒoc
();

200  
NULL
;

202 
ªt
 = 
fûe
->
	`c›y
(fûe, 
rom
, 
size
);

203 i‡(
ªt
 <= 0)

204  
NULL
;

205  
rom
;

206 
	}
}

209 
rom_hódî
 *

210 
	$lookup_h¨dcode
(
pci_devi˚
 *
pci
)

212 
‚ame
[17];

213 
	`¢¥ötf
(
‚ame
, (fname), "pci%04x,%04x.rom"

214 , 
pci
->
víd‹
,Öci->
devi˚
);

215 
romfûe_s
 *
fûe
 = 
	`romfûe_föd
(
‚ame
);

216 i‡(
fûe
)

217  
	`dïloy_romfûe
(
fûe
);

218  
NULL
;

219 
	}
}

223 
	$run_fûe_roms
(c⁄° *
¥efix
, 
isvga
, 
u64
 *
sour˚s
)

225 
romfûe_s
 *
fûe
 = 
NULL
;

226 *
vÆue
;

227 
ã°_°rög
[] = {"pxen0"};

228 
pxe_skù
 = 0;

230 i‡(
CONFIG_CHECK_FOR_PXE_LOAD_DISABLED
) {

232 
vÆue
 = 
	`cbfs_föd_°rög
(
ã°_°rög
, "bootorder");

233 i‡(
vÆue
)

234 
pxe_skù
 = 1;

238 
fûe
 = 
	`romfûe_föd¥efix
(
¥efix
, file);

239 i‡(!
fûe
)

242 i‡–
pxe_skù
 && 
	`°r°r
(
fûe
->
«me
,"pxe"))

245 
rom_hódî
 *
rom
 = 
	`dïloy_romfûe
(
fûe
);

246 i‡(
rom
) {

247 
	`£tRomSour˚
(
sour˚s
, 
rom
, (
u32
)
fûe
);

248 
	`öô_›ti⁄rom
(
rom
, 0, 
isvga
);

251 
	}
}

260 
	$is_pci_vga
(
pci_devi˚
 *
pci
)

262 i‡(
pci
->
˛ass
 !
PCI_CLASS_DISPLAY_VGA
)

264 
u16
 
cmd
 = 
	`pci_c⁄fig_ªadw
(
pci
->
bdf
, 
PCI_COMMAND
);

265 i‡(!(
cmd
 & 
PCI_COMMAND_IO
 && cmd & 
PCI_COMMAND_MEMORY
))

267 
pci
->
∑ª¡
) {

268 
pci
 =Öci->
∑ª¡
;

269 
u32
 
˘æ
 = 
	`pci_c⁄fig_ªadb
(
pci
->
bdf
, 
PCI_BRIDGE_CONTROL
);

270 i‡(!(
˘æ
 & 
PCI_BRIDGE_CTL_VGA
))

274 
	}
}

277 
rom_hódî
 *

278 
	$c›y_rom
(
rom_hódî
 *
rom
)

280 
u32
 
romsize
 = 
rom
->
size
 * 512;

281 
rom_hódî
 *
√wrom
 = 
	`rom_ª£rve
(
romsize
);

282 i‡(!
√wrom
) {

283 
	`w¨n_nﬂŒoc
();

284  
NULL
;

286 
	`d¥ötf
(4, "Copying optionÑom (size %d) from %pÅo %p\n"

287 , 
romsize
, 
rom
, 
√wrom
);

288 
	`iomem˝y
(
√wrom
, 
rom
, 
romsize
);

289  
√wrom
;

290 
	}
}

293 
rom_hódî
 *

294 
	$m≠_pcúom
(
pci_devi˚
 *
pci
)

296 
u16
 
bdf
 = 
pci
->bdf;

297 
	`d¥ötf
(6, "AttemptingÅo map optionÑom on dev %02x:%02x.%x\n"

298 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf), 
	`pci_bdf_to_‚
(bdf));

300 i‡((
pci
->
hódî_ty≥
 & 0x7fË!
PCI_HEADER_TYPE_NORMAL
) {

301 
	`d¥ötf
(6, "SkippingÇon-normalÖci device (type=%x)\n"

302 , 
pci
->
hódî_ty≥
);

303  
NULL
;

306 
u32
 
‹ig
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_ROM_ADDRESS
);

307 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_ROM_ADDRESS
, ~
PCI_ROM_ADDRESS_ENABLE
);

308 
u32
 
sz
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_ROM_ADDRESS
);

310 
	`d¥ötf
(6, "O±i⁄Ñom sizögÑëu∫ed %x %x\n", 
‹ig
, 
sz
);

311 
‹ig
 &~
PCI_ROM_ADDRESS_ENABLE
;

312 i‡(!
sz
 || sz == 0xffffffff)

313 
Áû
;

315 i‡(
‹ig
 =
sz
 || (
u32
)(orig + 4*1024*1024) < 20*1024*1024) {

318 
	`d¥ötf
(6, "PresetÑomáddress doesn'tÜook valid\n");

319 
Áû
;

323 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_ROM_ADDRESS
, 
‹ig
 | 
PCI_ROM_ADDRESS_ENABLE
);

325 
rom_hódî
 *
rom
 = (*)
‹ig
;

327 
	`d¥ötf
(5, "InspectingÖossibleÑomát %p (vd=%04x:%04x"

329 , 
rom
, 
pci
->
víd‹
,Öci->
devi˚


330 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf), 
	`pci_bdf_to_‚
(bdf));

331 i‡(
rom
->
sig«tuª
 !
OPTION_ROM_SIGNATURE
) {

332 
	`d¥ötf
(6, "Nÿ›ti⁄Ñom sig«tuª (gŸ %x)\n", 
rom
->
sig«tuª
);

333 
Áû
;

335 
pci_d©a
 *
pd
 = 
	`gë_pci_rom
(
rom
);

336 i‡(! 
pd
) {

337 
	`d¥ötf
(6, "No validÖci signature found\n");

338 
Áû
;

341 i‡(
pd
->
víd‹
 =
pci
->víd‹ &&Öd->
devi˚
 ==Öci->device

342 && 
pd
->
ty≥
 =
PCIROM_CODETYPE_X86
)

345 
	`d¥ötf
(6, "Didn't match dev/ven (got %04x:%04x) orÅype (got %d)\n"

346 , 
pd
->
víd‹
,Öd->
devi˚
,Öd->
ty≥
);

347 i‡(
pd
->
ödiˇt‹
 & 0x80) {

348 
	`d¥ötf
(6, "No more imagesÜeft\n");

349 
Áû
;

351 
rom
 = (*)((
u32
Ïom + 
pd
->
ûí
 * 512);

354 
rom
 = 
	`c›y_rom
(rom);

355 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_ROM_ADDRESS
, 
‹ig
);

356  
rom
;

357 
Áû
:

359 
	`pci_c⁄fig_wrôñ
(
bdf
, 
PCI_ROM_ADDRESS
, 
‹ig
);

360  
NULL
;

361 
	}
}

365 
	$öô_pcúom
(
pci_devi˚
 *
pci
, 
isvga
, 
u64
 *
sour˚s
)

367 
u16
 
bdf
 = 
pci
->bdf;

368 
	`d¥ötf
(4, "AttemptingÅo init PCI bdf %02x:%02x.%x (vd %04x:%04x)\n"

369 , 
	`pci_bdf_to_bus
(
bdf
), 
	`pci_bdf_to_dev
(bdf), 
	`pci_bdf_to_‚
(bdf)

370 , 
pci
->
víd‹
,Öci->
devi˚
);

371 
rom_hódî
 *
rom
 = 
	`lookup_h¨dcode
(
pci
);

372 i‡(! 
rom
)

373 
rom
 = 
	`m≠_pcúom
(
pci
);

374 i‡(! 
rom
)

377 
	`£tRomSour˚
(
sour˚s
, 
rom
, 
RS_PCIROM
 | (
u32
)
pci
);

378  
	`öô_›ti⁄rom
(
rom
, 
bdf
, 
isvga
);

379 
	}
}

387 
	$›ti⁄rom_£tup
()

389 i‡(! 
CONFIG_OPTIONROMS
)

392 
	`d¥ötf
(1, "Scan for optionÑoms\n");

393 
u64
 
sour˚s
[(
BUILD_BIOS_ADDR
 - 
BUILD_ROM_START
Ë/ 
OPTION_ROM_ALIGN
];

394 
	`mem£t
(
sour˚s
, 0, (sources));

395 
u32
 
po°_vga
 = 
	`rom_gë_œ°
();

397 i‡(
CONFIG_OPTIONROMS_DEPLOYED
) {

399 
u32
 
pos
 = 
po°_vga
;

400 
pos
 < 
	`rom_gë_max
()) {

401 
ªt
 = 
	`öô_›ti⁄rom
((*)
pos
, 0, 0);

402 i‡(
ªt
)

403 
pos
 +
OPTION_ROM_ALIGN
;

405 
pos
 = 
	`rom_gë_œ°
();

409 
pci_devi˚
 *
pci
;

410 
	`f‹óchpci
(
pci
) {

411 i‡(
pci
->
˛ass
 =
PCI_CLASS_DISPLAY_VGA
 ||Öci->
have_drivî
)

413 
	`öô_pcúom
(
pci
, 0, 
sour˚s
);

417 
	`run_fûe_roms
("gíroms/", 0, 
sour˚s
);

419 
	`rom_ª£rve
(0);

423 
u32
 
pos
 = 
po°_vga
;

424 
pos
 < 
	`rom_gë_œ°
()) {

425 
rom_hódî
 *
rom
 = (*)
pos
;

426 i‡(! 
	`is_vÆid_rom
(
rom
)) {

427 
pos
 +
OPTION_ROM_ALIGN
;

430 
pos
 +
	`ALIGN
(
rom
->
size
 * 512, 
OPTION_ROM_ALIGN
);

431 
≤p_d©a
 *
≤p
 = 
	`gë_≤p_rom
(
rom
);

432 i‡(! 
≤p
) {

434 
	`boŸ_add_bcv
(
	`FLATPTR_TO_SEG
(
rom
), 
OPTION_ROM_INITVECTOR
, 0

435 , 
	`gëRomPri‹ôy
(
sour˚s
, 
rom
, 0));

439 
ö°™˚
 = 0;

440 
≤p
) {

441 i‡(
≤p
->
bev
)

442 
	`boŸ_add_bev
(
	`FLATPTR_TO_SEG
(
rom
), 
≤p
->
bev
,Ö≈->
¥odu˘«me


443 , 
	`gëRomPri‹ôy
(
sour˚s
, 
rom
, 
ö°™˚
++));

444 i‡(
≤p
->
bcv
)

445 
	`boŸ_add_bcv
(
	`FLATPTR_TO_SEG
(
rom
), 
≤p
->
bcv
,Ö≈->
¥odu˘«me


446 , 
	`gëRomPri‹ôy
(
sour˚s
, 
rom
, 
ö°™˚
++));

449 
≤p
 = 
	`gë_≤p_√xt
(
rom
,Önp);

452 
	}
}

459 
	gS3ResumeVga
;

460 
	gS¸ìnAndDebug
;

461 
rom_hódî
 *
	gVgaROM
;

465 
	$vg¨om_£tup
()

467 i‡(! 
CONFIG_OPTIONROMS
)

470 
	`d¥ötf
(1, "Scan for VGA optionÑom\n");

473 
Enf‹˚Checksum
 = 
	`romfûe_lﬂdöt
("etc/optionroms-checksum", 1);

474 
S3ResumeVga
 = 
	`romfûe_lﬂdöt
("ëc/s3-ªsume-vga-öô", 
CONFIG_QEMU
);

475 
S¸ìnAndDebug
 = 
	`romfûe_lﬂdöt
("etc/screen-and-debug", 1);

477 i‡(
CONFIG_OPTIONROMS_DEPLOYED
) {

479 
	`öô_›ti⁄rom
((*)
BUILD_ROM_START
, 0, 1);

482 
	`mem£t
((*)
BUILD_ROM_START
, 0, 
	`rom_gë_max
() - BUILD_ROM_START);

485 
pci_devi˚
 *
pci
;

486 
	`f‹óchpci
(
pci
) {

487 i‡(!
	`is_pci_vga
(
pci
))

489 
	`vgahook_£tup
(
pci
);

490 
	`öô_pcúom
(
pci
, 1, 
NULL
);

495 
	`run_fûe_roms
("vg¨oms/", 1, 
NULL
);

497 
	`rom_ª£rve
(0);

499 i‡(
	`rom_gë_œ°
(Ë=
BUILD_ROM_START
)

503 
VgaROM
 = (*)
BUILD_ROM_START
;

504 
	`íabÀ_vga_c⁄sﬁe
();

505 
	}
}

508 
	$s3_ªsume_vga
()

510 i‡(!
S3ResumeVga
)

512 i‡(!
VgaROM
 || ! 
	`is_vÆid_rom
(VgaROM))

514 
	`ˇŒrom
(
VgaROM
, 0);

515 
	}
}

	@output.c

8 
	~<°d¨g.h
>

10 
	~"ÁΩå.h
"

11 
	~"bªgs.h
"

12 
	~"c⁄fig.h
"

13 
	~"biosv¨.h
"

14 
	~"hw/£rülio.h
"

15 
	~"mÆloc.h
"

16 
	~"ouçut.h
"

17 
	~"°acks.h
"

18 
	~"°rög.h
"

19 
	~"utû.h
"

21 
	sputcöfo
 {

22 (*
	mfunc
)(
putcöfo
 *
	möfo
, 
	mc
);

30 
	$debug_b™√r
()

32 
	`d¥ötf
(1, "SóBIOS (vîsi⁄ %s)\n", 
VERSION
);

33 
	}
}

37 
	$debug_putc
(
putcöfo
 *
a˘i⁄
, 
c
)

39 i‡(! 
CONFIG_DEBUG_LEVEL
)

41 
	`qemu_debug_putc
(
c
);

42 i‡(!
MODESEGMENT
)

43 
	`c‹eboŸ_debug_putc
(
c
);

44 
	`£rül_debug_putc
(
c
);

45 
	}
}

49 
	$debug_Êush
()

51 
	`£rül_debug_Êush
();

52 
	}
}

57 #i‡
MODE16


58 
putcöfo
 
debugöfo
 
	gVAR16
;

59 #ñi‡
MODESEGMENT


60 
putcöfo
 
debugöfo
 
	gVAR32SEG
;

62 
putcöfo
 
	gdebugöfo
 = { 
debug_putc
 };

72 
	$s¸ìnc
(
c
)

74 
bªgs
 
br
;

75 
	`mem£t
(&
br
, 0, (br));

76 
br
.
Êags
 = 
F_IF
;

77 
br
.
ah
 = 0x0e;

78 
br
.
Æ
 = 
c
;

79 
	`ˇŒ16_öt
(0x10, &
br
);

80 
	}
}

84 
	$s¸ìn_putc
(
putcöfo
 *
a˘i⁄
, 
c
)

86 i‡(
S¸ìnAndDebug
)

87 
	`debug_putc
(&
debugöfo
, 
c
);

88 i‡(
c
 == '\n')

89 
	`s¸ìnc
('\r');

90 
	`s¸ìnc
(
c
);

91 
	}
}

93 
putcöfo
 
	gs¸ìnöfo
 = { 
s¸ìn_putc
 };

102 
	$putc
(
putcöfo
 *
a˘i⁄
, 
c
)

104 i‡(
MODESEGMENT
) {

106 
	`debug_putc
(
a˘i⁄
, 
c
);

110 (*
func
)(
putcöfo
 *
öfo
, 
c
Ë
	`GET_GLOBAL
(
a˘i⁄
->func);

111 
	`func
(
a˘i⁄
, 
c
);

112 
	}
}

116 
	$puts
(
putcöfo
 *
a˘i⁄
, c⁄° *
s
)

118 i‡(!
MODESEGMENT
 && !
s
)

119 
s
 = "(NULL)";

120 ; *
s
; s++)

121 
	`putc
(
a˘i⁄
, *
s
);

122 
	}
}

126 
	$puts_cs
(
putcöfo
 *
a˘i⁄
, c⁄° *
s
)

128 *
vs
 = (*)
s
;

129 ;; 
vs
++) {

130 
c
 = 
	`GET_GLOBAL
(*
vs
);

131 i‡(!
c
)

133 
	`putc
(
a˘i⁄
, 
c
);

135 
	}
}

139 
	$putuöt
(
putcöfo
 *
a˘i⁄
, 
u32
 
vÆ
)

141 
buf
[12];

142 *
d
 = &
buf
[(buf) - 1];

143 *
d
-- = '\0';

145 *
d
 = (
vÆ
 % 10) + '0';

146 
vÆ
 /= 10;

147 i‡(!
vÆ
)

149 
d
--;

151 
	`puts
(
a˘i⁄
, 
d
);

152 
	}
}

155 
ölöe
 

156 
	$putsögÀhex
(
putcöfo
 *
a˘i⁄
, 
u32
 
vÆ
)

158 i‡(
vÆ
 <= 9)

159 
vÆ
 = '0' + val;

161 
vÆ
 = 'a' + val - 10;

162 
	`putc
(
a˘i⁄
, 
vÆ
);

163 
	}
}

167 
	$puthex
(
putcöfo
 *
a˘i⁄
, 
u32
 
vÆ
, 
width
)

169 
width
) {

170 : 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 28) & 0xf);

171 7: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 24) & 0xf);

172 6: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 20) & 0xf);

173 5: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 16) & 0xf);

174 4: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 12) & 0xf);

175 3: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 8) & 0xf);

176 2: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 4) & 0xf);

177 1: 
	`putsögÀhex
(
a˘i⁄
, (
vÆ
 >> 0) & 0xf);

179 
	}
}

183 
	$puçªâyhex
(
putcöfo
 *
a˘i⁄
, 
u32
 
vÆ
, 
width
, 
∑dch¨
)

185 
u32
 
tmp
 = 
vÆ
;

186 
cou¡
 = 1;

187 
tmp
 >>= 4)

188 
cou¡
++;

189 
width
 -
cou¡
;

190 
width
-- > 0)

191 
	`putc
(
a˘i⁄
, 
∑dch¨
);

192 
	`puthex
(
a˘i⁄
, 
vÆ
, 
cou¡
);

193 
	}
}

195 
ölöe
 

196 
	$isdigô
(
u8
 
c
)

198  ((
u8
)(
c
 - '0')) < 10;

199 
	}
}

202 
	$bv¥ötf
(
putcöfo
 *
a˘i⁄
, c⁄° *
fmt
, 
va_li°
 
¨gs
)

204 c⁄° *
s
 = 
fmt
;

205 ;; 
s
++) {

206 
c
 = 
	`GET_GLOBAL
(*(
u8
*)
s
);

207 i‡(!
c
)

209 i‡(
c
 != '%') {

210 
	`putc
(
a˘i⁄
, 
c
);

213 c⁄° *
n
 = 
s
+1;

214 
fõld_width
 = 0;

215 
∑dch¨
 = ' ';

216 
u8
 
is64
 = 0;

218 
c
 = 
	`GET_GLOBAL
(*(
u8
*)
n
);

219 i‡(!
	`isdigô
(
c
))

221 i‡(!
fõld_width
 && (
c
 == '0'))

222 
∑dch¨
 = '0';

224 
fõld_width
 = fõld_width * 10 + 
c
 - '0';

225 
n
++;

227 i‡(
c
 == 'l') {

229 
n
++;

230 
c
 = 
	`GET_GLOBAL
(*(
u8
*)
n
);

232 i‡(
c
 == 'l') {

233 
is64
 = 1;

234 
n
++;

235 
c
 = 
	`GET_GLOBAL
(*(
u8
*)
n
);

237 
s32
 
vÆ
;

238 c⁄° *
ßrg
;

239 
c
) {

241 
	`putc
(
a˘i⁄
, '%');

244 
vÆ
 = 
	`va_¨g
(
¨gs
, 
s32
);

245 i‡(
is64
)

246 
	`va_¨g
(
¨gs
, 
s32
);

247 i‡(
vÆ
 < 0) {

248 
	`putc
(
a˘i⁄
, '-');

249 
vÆ
 = -val;

251 
	`putuöt
(
a˘i⁄
, 
vÆ
);

254 
vÆ
 = 
	`va_¨g
(
¨gs
, 
s32
);

255 i‡(
is64
)

256 
	`va_¨g
(
¨gs
, 
s32
);

257 
	`putuöt
(
a˘i⁄
, 
vÆ
);

260 
vÆ
 = 
	`va_¨g
(
¨gs
, 
s32
);

261 
	`putc
(
a˘i⁄
, '0');

262 
	`putc
(
a˘i⁄
, 'x');

263 
	`puthex
(
a˘i⁄
, 
vÆ
, 8);

266 
vÆ
 = 
	`va_¨g
(
¨gs
, 
s32
);

267 i‡(
is64
) {

268 
u32
 
uµî
 = 
	`va_¨g
(
¨gs
, 
s32
);

269 i‡(
uµî
) {

270 
	`puçªâyhex
(
a˘i⁄
, 
uµî
, 
fõld_width
 - 8, 
∑dch¨
);

271 
	`puthex
(
a˘i⁄
, 
vÆ
, 8);

275 
	`puçªâyhex
(
a˘i⁄
, 
vÆ
, 
fõld_width
, 
∑dch¨
);

278 
vÆ
 = 
	`va_¨g
(
¨gs
, );

279 
	`putc
(
a˘i⁄
, 
vÆ
);

283 i‡(
	`GET_GLOBAL
(*(
u8
*)(
n
+1)) != 's')

285 
n
++;

286 
ßrg
 = 
	`va_¨g
(
¨gs
, const *);

287 
	`puts
(
a˘i⁄
, 
ßrg
);

290 
ßrg
 = 
	`va_¨g
(
¨gs
, const *);

291 
	`puts_cs
(
a˘i⁄
, 
ßrg
);

294 
	`putc
(
a˘i⁄
, '%');

295 
n
 = 
s
;

297 
s
 = 
n
;

299 
	}
}

302 
	$∑nic
(c⁄° *
fmt
, ...)

304 i‡(
CONFIG_DEBUG_LEVEL
) {

305 
va_li°
 
¨gs
;

306 
	`va_°¨t
(
¨gs
, 
fmt
);

307 
	`bv¥ötf
(&
debugöfo
, 
fmt
, 
¨gs
);

308 
	`va_íd
(
¨gs
);

309 
	`debug_Êush
();

313 
	`úq_dißbÀ
();

315 
	`h…
();

316 
	}
}

319 
	$__d¥ötf
(c⁄° *
fmt
, ...)

321 i‡(!
MODESEGMENT
 && 
CONFIG_THREADS
 && 
CONFIG_DEBUG_LEVEL
 >
DEBUG_thªad


322 && *
fmt
 != '\\' && *fmt != '/') {

323 
thªad_öfo
 *
cur
 = 
	`gëCurThªad
();

324 i‡(
cur
 !&
MaöThªad
) {

326 
	`debug_putc
(&
debugöfo
, '|');

327 
	`puthex
(&
debugöfo
, (
u32
)
cur
, 8);

328 
	`debug_putc
(&
debugöfo
, '|');

329 
	`debug_putc
(&
debugöfo
, ' ');

333 
va_li°
 
¨gs
;

334 
	`va_°¨t
(
¨gs
, 
fmt
);

335 
	`bv¥ötf
(&
debugöfo
, 
fmt
, 
¨gs
);

336 
	`va_íd
(
¨gs
);

337 
	`debug_Êush
();

338 
	}
}

341 
	$¥ötf
(c⁄° *
fmt
, ...)

343 
	`ASSERT32FLAT
();

344 
va_li°
 
¨gs
;

345 
	`va_°¨t
(
¨gs
, 
fmt
);

346 
	`bv¥ötf
(&
s¸ìnöfo
, 
fmt
, 
¨gs
);

347 
	`va_íd
(
¨gs
);

348 i‡(
S¸ìnAndDebug
)

349 
	`debug_Êush
();

350 
	}
}

357 
	s¢¥ötföfo
 {

358 
putcöfo
 
	möfo
;

359 *
	m°r
, *
	míd
;

363 
	$putc_°r
(
putcöfo
 *
öfo
, 
c
)

365 
¢¥ötföfo
 *
söfo
 = 
	`c⁄èöî_of
(
öfo
, snprintfinfo, info);

366 i‡(
söfo
->
°r
 >söfo->
íd
)

368 *
söfo
->
°r
 = 
c
;

369 
söfo
->
°r
++;

370 
	}
}

376 
	$¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, ...)

378 
	`ASSERT32FLAT
();

379 i‡(!
size
)

381 
¢¥ötföfo
 
söfo
 = { { 
putc_°r
 }, 
°r
, så + 
size
 };

382 
va_li°
 
¨gs
;

383 
	`va_°¨t
(
¨gs
, 
fmt
);

384 
	`bv¥ötf
(&
söfo
.
öfo
, 
fmt
, 
¨gs
);

385 
	`va_íd
(
¨gs
);

386 *
íd
 = 
söfo
.
°r
;

387 i‡(
íd
 >
söfo
.end)

388 
íd
 = 
söfo
.end - 1;

389 *
íd
 = '\0';

390  
íd
 - 
°r
;

391 
	}
}

395 
	$z≈rötf
(
size_t
 
size
, c⁄° *
fmt
, ...)

397 
	`ASSERT32FLAT
();

398 i‡(!
size
)

399  
NULL
;

400 *
°r
 = 
	`mÆloc_tmp
(
size
);

401 i‡(!
°r
) {

402 
	`w¨n_nﬂŒoc
();

403  
NULL
;

405 
¢¥ötföfo
 
söfo
 = { { 
putc_°r
 }, 
°r
, så + 
size
 };

406 
va_li°
 
¨gs
;

407 
	`va_°¨t
(
¨gs
, 
fmt
);

408 
	`bv¥ötf
(&
söfo
.
öfo
, 
fmt
, 
¨gs
);

409 
	`va_íd
(
¨gs
);

410 *
íd
 = 
söfo
.
°r
;

411 i‡(
íd
 >
söfo
.end)

412 
íd
 = 
söfo
.end - 1;

413 *
íd
 = '\0';

414  
°r
;

415 
	}
}

423 
	$hexdump
(c⁄° *
d
, 
Àn
)

425 
cou¡
=0;

426 
Àn
 > 0) {

427 i‡(
cou¡
 % 8 == 0) {

428 
	`putc
(&
debugöfo
, '\n');

429 
	`puthex
(&
debugöfo
, 
cou¡
*4, 8);

430 
	`putc
(&
debugöfo
, ':');

432 
	`putc
(&
debugöfo
, ' ');

434 
	`puthex
(&
debugöfo
, *(
u32
*)
d
, 8);

435 
cou¡
++;

436 
Àn
-=4;

437 
d
+=4;

439 
	`putc
(&
debugöfo
, '\n');

440 
	`debug_Êush
();

441 
	}
}

444 
	$dump_ªgs
(
bªgs
 *
ªgs
)

446 i‡(!
ªgs
) {

447 
	`d¥ötf
(1, " NULL\n");

450 
	`d¥ötf
(1, "á=%08x b=%08x c=%08x d=%08x ds=%04xÉs=%04x ss=%04x\n"

451 , 
ªgs
->
óx
,Ñegs->
ebx
,Ñegs->
ecx
,Ñegs->
edx


452 , 
ªgs
->
ds
,Ñegs->
es
, 
	`GET_SEG
(
SS
));

453 
	`d¥ötf
(1, " si=%08x di=%08x bp=%08x sp=%08x cs=%04x ip=%04x f=%04x\n"

454 , 
ªgs
->
esi
,Ñegs->
edi
,Ñegs->
ebp
, (
u32
)&regs[1]

455 , 
ªgs
->
code
.
£g
,Ñegs->code.
off£t
,Ñegs->
Êags
);

456 
	}
}

460 
	$__debug_i§
(c⁄° *
‚ame
)

462 
	`puts_cs
(&
debugöfo
, 
‚ame
);

463 
	`putc
(&
debugöfo
, '\n');

464 
	`debug_Êush
();

465 
	}
}

469 
	$__debug_íãr
(
bªgs
 *
ªgs
, c⁄° *
‚ame
)

471 
	`d¥ötf
(1, "íã∏%s:\n", 
‚ame
);

472 
	`dump_ªgs
(
ªgs
);

473 
	}
}

477 
	$__debug_°ub
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

479 
	`d¥ötf
(1, "°ub %s:%d:\n", 
‚ame
, 
löío
);

480 
	`dump_ªgs
(
ªgs
);

481 
	}
}

485 
	$__w¨n_övÆid
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

487 i‡(
CONFIG_DEBUG_LEVEL
 >
DEBUG_övÆid
) {

488 
	`d¥ötf
(1, "övÆid %s:%d:\n", 
‚ame
, 
löío
);

489 
	`dump_ªgs
(
ªgs
);

491 
	}
}

495 
	$__w¨n_unim∂emíãd
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

497 i‡(
CONFIG_DEBUG_LEVEL
 >
DEBUG_unim∂emíãd
) {

498 
	`d¥ötf
(1, "unim∂emíãd %s:%d:\n", 
‚ame
, 
löío
);

499 
	`dump_ªgs
(
ªgs
);

501 
	}
}

505 
	$__w¨n_öã∫Æîr‹
(
löío
, c⁄° *
‚ame
)

507 
	`d¥ötf
(1, "WARNING - internalÉrror detectedát %s:%d!\n"

508 , 
‚ame
, 
löío
);

509 
	}
}

513 
	$__w¨n_nﬂŒoc
(
löío
, c⁄° *
‚ame
)

515 
	`d¥ötf
(1, "WARNING - UnableÅoállocateÑesourceát %s:%d!\n"

516 , 
‚ame
, 
löío
);

517 
	}
}

521 
	$__w¨n_timeout
(
löío
, c⁄° *
‚ame
)

523 
	`d¥ötf
(1, "WARNING - Timeouà© %s:%d!\n", 
‚ame
, 
löío
);

524 
	}
}

528 
	$__£t_övÆid
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

530 
	`__w¨n_övÆid
(
ªgs
, 
löío
, 
‚ame
);

531 
	`£t_övÆid_sûít
(
ªgs
);

532 
	}
}

536 
	$__£t_unim∂emíãd
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
)

538 
	`__w¨n_unim∂emíãd
(
ªgs
, 
löío
, 
‚ame
);

539 
	`£t_övÆid_sûít
(
ªgs
);

540 
	}
}

547 
	$__£t_code_övÆid
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
)

549 
u8
 
code
 = 
löecode
;

550 
u32
 
löío
 = 
löecode
 >> 8;

551 
	`__w¨n_övÆid
(
ªgs
, 
löío
, 
‚ame
);

552 
	`£t_code_övÆid_sûít
(
ªgs
, 
code
);

553 
	}
}

557 
	$__£t_code_unim∂emíãd
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
)

559 
u8
 
code
 = 
löecode
;

560 
u32
 
löío
 = 
löecode
 >> 8;

561 
	`__w¨n_unim∂emíãd
(
ªgs
, 
löío
, 
‚ame
);

562 
	`£t_code_övÆid_sûít
(
ªgs
, 
code
);

563 
	}
}

	@output.h

1 #i‚de‡
__OUTPUT_H


2 
	#__OUTPUT_H


	)

4 
	~"ty≥s.h
"

7 
debug_b™√r
();

8 
	$∑nic
(c⁄° *
fmt
, ...)

9 
	`__©åibuã__
 ((
	$f‹m©
 (
¥ötf
, 1, 2))Ë
__n‹ëu∫
;

10 
	$¥ötf
(c⁄° *
fmt
, ...)

11 
	`__©åibuã__
 ((
	`f‹m©
 (
¥ötf
, 1, 2)));

12 
	$¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
fmt
, ...)

13 
	`__©åibuã__
 ((
	`f‹m©
 (
¥ötf
, 3, 4)));

14 * 
	$z≈rötf
(
size_t
 
size
, c⁄° *
fmt
, ...)

15 
	`__©åibuã__
 ((
	`f‹m©
 (
¥ötf
, 2, 3)));

16 
	$__d¥ötf
(c⁄° *
fmt
, ...)

17 
	`__©åibuã__
 ((
	`f‹m©
 (
¥ötf
, 1, 2)));

18 
bªgs
;

19 
	`__debug_íãr
(
bªgs
 *
ªgs
, c⁄° *
‚ame
);

20 
	`__debug_i§
(c⁄° *
‚ame
);

21 
	`__debug_°ub
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
);

22 
	`__w¨n_övÆid
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
);

23 
	`__w¨n_unim∂emíãd
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
);

24 
	`__w¨n_öã∫Æîr‹
(
löío
, c⁄° *
‚ame
);

25 
	`__w¨n_nﬂŒoc
(
löío
, c⁄° *
‚ame
);

26 
	`__w¨n_timeout
(
löío
, c⁄° *
‚ame
);

27 
	`__£t_övÆid
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
);

28 
	`__£t_unim∂emíãd
(
bªgs
 *
ªgs
, 
löío
, c⁄° *
‚ame
);

29 
	`__£t_code_övÆid
(
bªgs
 *
ªgs
, 
u32
 
löecode
, c⁄° *
‚ame
);

30 
	`__£t_code_unim∂emíãd
(
bªgs
 *
ªgs
, 
u32
 
löecode


31 , c⁄° *
‚ame
);

32 
	`hexdump
(c⁄° *
d
, 
Àn
);

34 
	#d¥ötf
(
lvl
, 
fmt
, 
¨gs
...) do { \

35 i‡(
CONFIG_DEBUG_LEVEL
 && (
lvl
) <= CONFIG_DEBUG_LEVEL) \

36 
	`__d¥ötf
((
fmt
Ë, ##
¨gs
 ); \

37 
	}
} 0)

	)

38 
	#debug_íãr
(
ªgs
, 
lvl
) do { \

39 i‡((
lvl
Ë&& (lvlË<
CONFIG_DEBUG_LEVEL
) \

40 
	`__debug_íãr
((
ªgs
), 
__func__
); \

41 } 0)

	)

42 
	#debug_i§
(
lvl
) do { \

43 i‡((
lvl
Ë&& (lvlË<
CONFIG_DEBUG_LEVEL
) \

44 
	`__debug_i§
(
__func__
); \

45 } 0)

	)

46 
	#debug_°ub
(
ªgs
) \

47 
	`__debug_°ub
((
ªgs
), 
__LINE__
, 
__func__
)

	)

48 
	#w¨n_övÆid
(
ªgs
) \

49 
	`__w¨n_övÆid
((
ªgs
), 
__LINE__
, 
__func__
)

	)

50 
	#w¨n_unim∂emíãd
(
ªgs
) \

51 
	`__w¨n_unim∂emíãd
((
ªgs
), 
__LINE__
, 
__func__
)

	)

52 
	#w¨n_öã∫Æîr‹
() \

53 
	`__w¨n_öã∫Æîr‹
(
__LINE__
, 
__func__
)

	)

54 
	#w¨n_nﬂŒoc
() \

55 
	`__w¨n_nﬂŒoc
(
__LINE__
, 
__func__
)

	)

56 
	#w¨n_timeout
() \

57 
	`__w¨n_timeout
(
__LINE__
, 
__func__
)

	)

58 
	#£t_övÆid
(
ªgs
) \

59 
	`__£t_övÆid
((
ªgs
), 
__LINE__
, 
__func__
)

	)

60 
	#£t_code_övÆid
(
ªgs
, 
code
) \

61 
	`__£t_code_övÆid
((
ªgs
), (
code
Ë| (
__LINE__
 << 8), 
__func__
)

	)

62 
	#£t_unim∂emíãd
(
ªgs
) \

63 
	`__£t_unim∂emíãd
((
ªgs
), 
__LINE__
, 
__func__
)

	)

64 
	#£t_code_unim∂emíãd
(
ªgs
, 
code
) \

65 
	`__£t_code_unim∂emíãd
((
ªgs
), (
code
Ë| (
__LINE__
 << 8), 
__func__
)

	)

	@pcibios.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pci_ªgs.h
"

12 
	~"ouçut.h
"

13 
	~"°d/púèbÀ.h
"

14 
	~"°rög.h
"

15 
	~"utû.h
"

18 
íåy_bios32
();

19 
íåy_pcibios32
();

21 
	#RET_FUNC_NOT_SUPPORTED
 0x81

	)

22 
	#RET_BAD_VENDOR_ID
 0x83

	)

23 
	#RET_DEVICE_NOT_FOUND
 0x86

	)

24 
	#RET_BUFFER_TOO_SMALL
 0x89

	)

28 
	$h™dÀ_1ab101
(
bªgs
 *
ªgs
)

30 
ªgs
->
Æ
 = 0x01;

31 
ªgs
->
bx
 = 0x0210;

32 
ªgs
->
˛
 = 
	`GET_GLOBAL
(
MaxPCIBus
);

33 
ªgs
->
edx
 = 0x20494350;

34 
ªgs
->
edi
 = (
u32
)
íåy_pcibios32
 + 
BUILD_BIOS_ADDR
;

35 
	`£t_code_suc˚ss
(
ªgs
);

36 
	}
}

40 
	$h™dÀ_1ab102
(
bªgs
 *
ªgs
)

42 
u32
 
id
 = (
ªgs
->
cx
 << 16Ë|Ñegs->
dx
;

43 
cou¡
 = 
ªgs
->
si
;

44 
bus
 = -1;

45 
bus
 < 
	`GET_GLOBAL
(
MaxPCIBus
)) {

46 
bus
++;

47 
bdf
;

48 
	`f‹óchbdf
(
bdf
, 
bus
) {

49 
u32
 
v
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_VENDOR_ID
);

50 i‡(
v
 !
id
)

52 i‡(
cou¡
--)

54 
ªgs
->
bx
 = 
bdf
;

55 
	`£t_code_suc˚ss
(
ªgs
);

59 
	`£t_code_övÆid
(
ªgs
, 
RET_DEVICE_NOT_FOUND
);

60 
	}
}

64 
	$h™dÀ_1ab103
(
bªgs
 *
ªgs
)

66 
cou¡
 = 
ªgs
->
si
;

67 
u32
 
˛as•rog
 = 
ªgs
->
ecx
;

68 
bus
 = -1;

69 
bus
 < 
	`GET_GLOBAL
(
MaxPCIBus
)) {

70 
bus
++;

71 
bdf
;

72 
	`f‹óchbdf
(
bdf
, 
bus
) {

73 
u32
 
v
 = 
	`pci_c⁄fig_ªadl
(
bdf
, 
PCI_CLASS_REVISION
);

74 i‡((
v
>>8Ë!
˛as•rog
)

76 i‡(
cou¡
--)

78 
ªgs
->
bx
 = 
bdf
;

79 
	`£t_code_suc˚ss
(
ªgs
);

83 
	`£t_code_övÆid
(
ªgs
, 
RET_DEVICE_NOT_FOUND
);

84 
	}
}

88 
	$h™dÀ_1ab108
(
bªgs
 *
ªgs
)

90 
ªgs
->
˛
 = 
	`pci_c⁄fig_ªadb
‘egs->
bx
,Ñegs->
di
);

91 
	`£t_code_suc˚ss
(
ªgs
);

92 
	}
}

96 
	$h™dÀ_1ab109
(
bªgs
 *
ªgs
)

98 
ªgs
->
cx
 = 
	`pci_c⁄fig_ªadw
‘egs->
bx
,Ñegs->
di
);

99 
	`£t_code_suc˚ss
(
ªgs
);

100 
	}
}

104 
	$h™dÀ_1ab10a
(
bªgs
 *
ªgs
)

106 
ªgs
->
ecx
 = 
	`pci_c⁄fig_ªadl
‘egs->
bx
,Ñegs->
di
);

107 
	`£t_code_suc˚ss
(
ªgs
);

108 
	}
}

112 
	$h™dÀ_1ab10b
(
bªgs
 *
ªgs
)

114 
	`pci_c⁄fig_wrôeb
(
ªgs
->
bx
,Ñegs->
di
,Ñegs->
˛
);

115 
	`£t_code_suc˚ss
(
ªgs
);

116 
	}
}

120 
	$h™dÀ_1ab10c
(
bªgs
 *
ªgs
)

122 
	`pci_c⁄fig_wrôew
(
ªgs
->
bx
,Ñegs->
di
,Ñegs->
cx
);

123 
	`£t_code_suc˚ss
(
ªgs
);

124 
	}
}

128 
	$h™dÀ_1ab10d
(
bªgs
 *
ªgs
)

130 
	`pci_c⁄fig_wrôñ
(
ªgs
->
bx
,Ñegs->
di
,Ñegs->
ecx
);

131 
	`£t_code_suc˚ss
(
ªgs
);

132 
	}
}

136 
	$h™dÀ_1ab10e
(
bªgs
 *
ªgs
)

138 
pú_hódî
 *
púèbÀ_gf
 = 
	`GET_GLOBAL
(
PúAddr
);

139 i‡(! 
púèbÀ_gf
) {

140 
	`£t_code_övÆid
(
ªgs
, 
RET_FUNC_NOT_SUPPORTED
);

143 
pú_hódî
 *
púèbÀ_g
 = 
	`GLOBALFLAT2GLOBAL
(
púèbÀ_gf
);

145 
	s∑øm_s
 {

146 
u16
 
size
;

147 
u16
 
buf_off
;

148 
u16
 
buf_£g
;

149 } *
∑øm_Ár
 = (*)(
ªgs
->
di
+0);

152 
u16
 
bufsize
 = 
	`GET_FARVAR
(
ªgs
->
es
, 
∑øm_Ár
->
size
);

153 
u16
 
púsize
 = 
	`GET_GLOBAL
(
púèbÀ_g
->
size
Ë- (
pú_hódî
);

154 
	`SET_FARVAR
(
ªgs
->
es
, 
∑øm_Ár
->
size
, 
púsize
);

155 i‡(
bufsize
 < 
púsize
) {

156 
	`£t_code_övÆid
(
ªgs
, 
RET_BUFFER_TOO_SMALL
);

161 *
buf_Ár
 = (*)(
	`GET_FARVAR
(
ªgs
->
es
, 
∑øm_Ár
->
buf_off
)+0);

162 
u16
 
buf_£g
 = 
	`GET_FARVAR
(
ªgs
->
es
, 
∑øm_Ár
->buf_seg);

165 
	`mem˝y_Ár
(
buf_£g
, 
buf_Ár


166 , 
	`gë_globÆ_£g
()

167 , (*)(
púèbÀ_g
->
¶Ÿs
Ë+ 
	`gë_globÆ_off£t
()

168 , 
púsize
);

171 
ªgs
->
bx
 = 
	`GET_GLOBAL
(
púèbÀ_g
->
ex˛usive_úqs
);

172 
	`£t_code_suc˚ss
(
ªgs
);

173 
	}
}

176 
	$h™dÀ_1ab1XX
(
bªgs
 *
ªgs
)

178 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_FUNC_NOT_SUPPORTED
);

179 
	}
}

182 
	$h™dÀ_1ab1
(
bªgs
 *
ªgs
)

186 i‡(! 
CONFIG_PCIBIOS
) {

187 
	`£t_övÆid
(
ªgs
);

191 
ªgs
->
Æ
) {

192 0x01: 
	`h™dÀ_1ab101
(
ªgs
); ;

193 0x02: 
	`h™dÀ_1ab102
(
ªgs
); ;

194 0x03: 
	`h™dÀ_1ab103
(
ªgs
); ;

195 0x08: 
	`h™dÀ_1ab108
(
ªgs
); ;

196 0x09: 
	`h™dÀ_1ab109
(
ªgs
); ;

197 0x0a: 
	`h™dÀ_1ab10a
(
ªgs
); ;

198 0x0b: 
	`h™dÀ_1ab10b
(
ªgs
); ;

199 0x0c: 
	`h™dÀ_1ab10c
(
ªgs
); ;

200 0x0d: 
	`h™dÀ_1ab10d
(
ªgs
); ;

201 0x0e: 
	`h™dÀ_1ab10e
(
ªgs
); ;

202 : 
	`h™dÀ_1ab1XX
(
ªgs
); ;

204 
	}
}

207 
VISIBLE16
 
VISIBLE32SEG


208 
	$h™dÀ_pcibios
(
bªgs
 *
ªgs
)

210 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_pcibios
);

211 
	`h™dÀ_1ab1
(
ªgs
);

212 
	}
}

219 
	sbios32_s
 {

220 
u32
 
	msig«tuª
;

221 
u32
 
	míåy
;

222 
u8
 
	mvîsi⁄
;

223 
u8
 
	mÀngth
;

224 
u8
 
	mchecksum
;

225 
u8
 
	mª£rved
[5];

226 } 
	gPACKED
;

228 
bios32_s
 
BIOS32HEADER
 
	$__Æig√d
(16Ë
VARFSEG
 = {

229 .
sig«tuª
 = 0x5f32335f,

230 .
Àngth
 = (
BIOS32HEADER
) / 16,

231 
	}
};

234 
	$bios32_öô
()

236 
	`d¥ötf
(3, "init bios32\n");

238 
BIOS32HEADER
.
íåy
 = (
u32
)
íåy_bios32
;

239 
BIOS32HEADER
.
checksum
 -
	`checksum
(&BIOS32HEADER, (BIOS32HEADER));

240 
	}
}

	@pmm.c

7 
	~"biosv¨.h
"

8 
	~"c⁄fig.h
"

9 
	~"mÆloc.h
"

10 
	~"ouçut.h
"

11 
	~"°d/pmm.h
"

12 
	~"°rög.h
"

13 
	~"utû.h
"

14 
	~"x86.h
"

16 
pmmhódî
 
PMMHEADER
;

18 #i‡
CONFIG_PMM


19 
pmmhódî
 
PMMHEADER
 
	$__Æig√d
(16Ë
VARFSEG
 = {

20 .
sig«tuª
 = 
PMM_SIGNATURE
,

21 .
vîsi⁄
 = 0x01,

22 .
Àngth
 = (
PMMHEADER
),

23 
	}
};

27 
u32


28 
	$h™dÀ_pmm00
(
u16
 *
¨gs
)

30 
u32
 
Àngth
 = *(u32*)&
¨gs
[1], 
h™dÀ
 = *(u32*)&args[3];

31 
u16
 
Êags
 = 
¨gs
[5];

32 
	`d¥ötf
(3, "pmm00:Üength=%x handle=%x flags=%x\n"

33 , 
Àngth
, 
h™dÀ
, 
Êags
);

34 
z⁄e_s
 *
lowz⁄e
 = &
Z⁄eTmpLow
, *
highz⁄e
 = &
Z⁄eTmpHigh
;

35 i‡(
Êags
 & 8) {

37 
lowz⁄e
 = &
Z⁄eLow
;

38 
highz⁄e
 = &
Z⁄eHigh
;

40 i‡(!
Àngth
) {

42 
Êags
 & 3) {

47  
	`mÆloc_gë•a˚
(
lowz⁄e
);

49  
	`mÆloc_gë•a˚
(
highz⁄e
);

51 
u32
 
•a˚low
 = 
	`mÆloc_gë•a˚
(
lowz⁄e
);

52 
u32
 
•a˚high
 = 
	`mÆloc_gë•a˚
(
highz⁄e
);

53 i‡(
•a˚low
 > 
•a˚high
)

54  
•a˚low
;

55  
•a˚high
;

59 
u32
 
size
 = 
Àngth
 * 16;

60 i‡((
s32
)
size
 <= 0)

62 
u32
 
Æign
 = 
MALLOC_MIN_ALIGN
;

63 i‡(
Êags
 & 4) {

64 
Æign
 = 1<<
	`__ffs
(
size
);

65 i‡(
Æign
 < 
MALLOC_MIN_ALIGN
)

66 
Æign
 = 
MALLOC_MIN_ALIGN
;

68 *
d©a
;

69 
Êags
 & 3) {

74 
d©a
 = 
	`_mÆloc
(
lowz⁄e
, 
size
, 
Æign
);

77 
d©a
 = 
	`_mÆloc
(
highz⁄e
, 
size
, 
Æign
);

80 
d©a
 = 
	`_mÆloc
(
lowz⁄e
, 
size
, 
Æign
);

81 i‡(!
d©a
)

82 
d©a
 = 
	`_mÆloc
(
highz⁄e
, 
size
, 
Æign
);

85 i‡(
d©a
 && 
h™dÀ
 !
MALLOC_DEFAULT_HANDLE
)

86 
	`mÆloc_£th™dÀ
(
d©a
, 
h™dÀ
);

87  (
u32
)
d©a
;

88 
	}
}

91 
u32


92 
	$h™dÀ_pmm01
(
u16
 *
¨gs
)

94 
u32
 
h™dÀ
 = *(u32*)&
¨gs
[1];

95 
	`d¥ötf
(3, "pmm01: h™dÀ=%x\n", 
h™dÀ
);

96 i‡(
h™dÀ
 =
MALLOC_DEFAULT_HANDLE
)

98  (
u32
)
	`mÆloc_födh™dÀ
(
h™dÀ
);

99 
	}
}

102 
u32


103 
	$h™dÀ_pmm02
(
u16
 *
¨gs
)

105 
u32
 
buf„r
 = *(u32*)&
¨gs
[1];

106 
	`d¥ötf
(3, "pmm02: buf„r=%x\n", 
buf„r
);

107 
ªt
 = 
	`_‰ì
((*)
buf„r
);

108 i‡(
ªt
)

112 
	}
}

114 
u32


115 
	$h™dÀ_pmmXX
(
u16
 *
¨gs
)

117  
PMM_FUNCTION_NOT_SUPPORTED
;

118 
	}
}

120 
u32
 
VISIBLE32INIT


121 
	$h™dÀ_pmm
(
u16
 *
¨gs
)

123 
	`ASSERT32FLAT
();

124 i‡(! 
CONFIG_PMM
)

125  
PMM_FUNCTION_NOT_SUPPORTED
;

127 
u16
 
¨g1
 = 
¨gs
[0];

128 
	`d¥ötf
(
DEBUG_HDL_pmm
, "pmm cÆ»¨g1=%x\n", 
¨g1
);

130 
u32
 
ªt
;

131 
¨g1
) {

132 0x00: 
ªt
 = 
	`h™dÀ_pmm00
(
¨gs
); ;

133 0x01: 
ªt
 = 
	`h™dÀ_pmm01
(
¨gs
); ;

134 0x02: 
ªt
 = 
	`h™dÀ_pmm02
(
¨gs
); ;

135 : 
ªt
 = 
	`h™dÀ_pmmXX
(
¨gs
); ;

138  
ªt
;

139 
	}
}

142 
	$pmm_öô
()

144 i‡(! 
CONFIG_PMM
)

147 
	`d¥ötf
(3, "init PMM\n");

149 
PMMHEADER
.
íåy
 = 
	`FUNC16
(
íåy_pmm
);

150 
PMMHEADER
.
checksum
 -
	`checksum
(&PMMHEADER, (PMMHEADER));

151 
	}
}

154 
	$pmm_¥ïboŸ
()

156 i‡(! 
CONFIG_PMM
)

159 
	`d¥ötf
(3, "finalize PMM\n");

161 
PMMHEADER
.
sig«tuª
 = 0;

162 
PMMHEADER
.
íåy
.
£goff
 = 0;

163 
	}
}

	@pnpbios.c

7 
	~"c⁄fig.h
"

8 
	~"ÁΩå.h
"

9 
	~"ouçut.h
"

10 
	~"°d/≤pbios.h
"

11 
	~"°rög.h
"

12 
	~"utû.h
"

14 
≤phódî
 
PNPHEADER
;

15 
≤p_°rög
[];

17 #i‡
CONFIG_PNPBIOS


18 
≤phódî
 
PNPHEADER
 
	$__Æig√d
(16Ë
VARFSEG
 = {

19 .
sig«tuª
 = 
PNP_SIGNATURE
,

20 .
vîsi⁄
 = 0x10,

21 .
Àngth
 = (
PNPHEADER
),

22 .
ªÆ_cs
 = 
SEG_BIOS
,

23 .
¥Ÿ_ba£
 = 
BUILD_BIOS_ADDR
,

24 .
ªÆ_ds
 = 
SEG_BIOS
,

25 .
¥Ÿ_d©aba£
 = 
BUILD_BIOS_ADDR
,

26 
	}
};

31 
	g≤p_°rög
[] 
	$__Æig√d
(2Ë
VARFSEG
 = " $PnP";

35 
u16


36 
	$h™dÀ_≤p60
(
u16
 *
¨gs
)

38 
u16
 
vîsi⁄_±r
 = 
¨gs
[1];

39 
u16
 
vîsi⁄_£g
 = 
¨gs
[2];

40 
	`SET_FARVAR
(
vîsi⁄_£g
, *(
u16
*)(
vîsi⁄_±r
+0), 0x0101);

42 
	}
}

44 
u16


45 
	$h™dÀ_≤pXX
(
u16
 *
¨gs
)

47  
FUNCTION_NOT_SUPPORTED
;

48 
	}
}

50 
u16
 
VISIBLE16


51 
	$h™dÀ_≤p
(
u16
 *
¨gs
)

53 i‡(! 
CONFIG_PNPBIOS
)

54  
FUNCTION_NOT_SUPPORTED
;

56 
u16
 
¨g1
 = 
¨gs
[0];

57 
	`d¥ötf
(
DEBUG_HDL_≤p
, "≤∞ˇŒárg1=%x\n", 
¨g1
);

59 
¨g1
) {

60 0x60:  
	`h™dÀ_≤p60
(
¨gs
);

61 :  
	`h™dÀ_≤pXX
(
¨gs
);

63 
	}
}

65 
u16


66 
	$gë_≤p_off£t
()

68 i‡(! 
CONFIG_PNPBIOS
)

69  (
u32
)
≤p_°rög
 + 1 - 
BUILD_BIOS_ADDR
;

70  (
u32
)&
PNPHEADER
 - 
BUILD_BIOS_ADDR
;

71 
	}
}

74 
íåy_≤p_ªÆ
();

75 
íåy_≤p_¥Ÿ
();

78 
	$≤p_öô
()

80 i‡(! 
CONFIG_PNPBIOS
)

83 
	`d¥ötf
(3, "init PNPBIOSÅable\n");

85 
PNPHEADER
.
ªÆ_ù
 = (
u32
)
íåy_≤p_ªÆ
 - 
BUILD_BIOS_ADDR
;

86 
PNPHEADER
.
¥Ÿ_ù
 = (
u32
)
íåy_≤p_¥Ÿ
 - 
BUILD_BIOS_ADDR
;

87 
PNPHEADER
.
checksum
 -
	`checksum
(&PNPHEADER, (PNPHEADER));

88 
	}
}

	@post.c

9 
	~"biosv¨.h
"

10 
	~"bªgs.h
"

11 
	~"c⁄fig.h
"

12 
	~"fw/∑øvút.h
"

13 
	~"fw/xí.h
"

14 
	~"hw/ahci.h
"

15 
	~"hw/©a.h
"

16 
	~"hw/e•-scsi.h
"

17 
	~"hw/lsi-scsi.h
"

18 
	~"hw/sd_if.h
"

19 
	~"hw/megaßs.h
"

20 
	~"hw/pvscsi.h
"

21 
	~"hw/pic.h
"

22 
	~"hw/ps2p‹t.h
"

23 
	~"hw/πc.h
"

24 
	~"hw/£rülio.h
"

25 
	~"hw/usb.h
"

26 
	~"hw/vútio-blk.h
"

27 
	~"hw/vútio-scsi.h
"

28 
	~"mÆloc.h
"

29 
	~"memm≠.h
"

30 
	~"ouçut.h
"

31 
	~"°rög.h
"

32 
	~"utû.h
"

33 
	~"romfûe.h
"

34 
	~"fw/c‹eboŸ.h
"

35 
	~"hw/£rülio.h
"

37 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


38 
cmos_£rül_c⁄sﬁe_debug_Àvñ
;

46 
	$ivt_öô
()

48 
	`d¥ötf
(3, "init ivt\n");

51 
HaveRunPo°
 = 1;

52 
	`πc_wrôe
(
CMOS_RESET_CODE
, 0);

55 
i
;

56 
i
=0; i<256; i++)

57 
	`SET_IVT
(
i
, 
	`FUNC16
(
íåy_úë_officül
));

60 
i
=
BIOS_HWIRQ0_VECTOR
; i<BIOS_HWIRQ0_VECTOR+8; i++)

61 
	`SET_IVT
(
i
, 
	`FUNC16
(
íåy_hwpic1
));

62 
i
=
BIOS_HWIRQ8_VECTOR
; i<BIOS_HWIRQ8_VECTOR+8; i++)

63 
	`SET_IVT
(
i
, 
	`FUNC16
(
íåy_hwpic2
));

66 
	`SET_IVT
(0x02, 
	`FUNC16
(
íåy_02
));

67 
	`SET_IVT
(0x10, 
	`FUNC16
(
íåy_10
));

68 
	`SET_IVT
(0x11, 
	`FUNC16
(
íåy_11
));

69 
	`SET_IVT
(0x12, 
	`FUNC16
(
íåy_12
));

70 
	`SET_IVT
(0x13, 
	`FUNC16
(
íåy_13_officül
));

71 
	`SET_IVT
(0x14, 
	`FUNC16
(
íåy_14
));

72 
	`SET_IVT
(0x15, 
	`FUNC16
(
íåy_15
));

73 
	`SET_IVT
(0x16, 
	`FUNC16
(
íåy_16
));

74 
	`SET_IVT
(0x17, 
	`FUNC16
(
íåy_17
));

75 
	`SET_IVT
(0x18, 
	`FUNC16
(
íåy_18
));

76 
	`SET_IVT
(0x19, 
	`FUNC16
(
íåy_19_officül
));

77 
	`SET_IVT
(0x1a, 
	`FUNC16
(
íåy_1a_officül
));

78 
	`SET_IVT
(0x40, 
	`FUNC16
(
íåy_40
));

81 
i
=0x60; i<=0x66; i++)

82 
	`SET_IVT
(
i
, 
	`SEGOFF
(0, 0));

86 
	`SET_IVT
(0x79, 
	`SEGOFF
(0, 0));

87 
	}
}

90 
	$bda_öô
()

92 
	`d¥ötf
(3, "init bda\n");

94 
bios_d©a_¨ó_s
 *
bda
 = 
	`MAKE_FLATPTR
(
SEG_BDA
, 0);

95 
	`mem£t
(
bda
, 0, (*bda));

97 #i‡
CONFIG_INT10_SERIAL_CONSOLE


99 #i‡
CONFIG_CHECK_CMOS_SETTING_FOR_CONSOLE_ENABLE


100 i‡(!
cmos_£rül_c⁄sﬁe_debug_Àvñ
)

101 
	`SET_BDA
(
video_mode
, 
UART_OUTPUT_DISABLED
);

103 
	`SET_BDA
(
video_mode
, 
UART_OUTPUT_ENABLED
);

105 
	`SET_BDA
(
video_mode
, 
UART_OUTPUT_ENABLED
);

109 
esize
 = 
EBDA_SIZE_START
;

110 
u16
 
ebda_£g
 = 
EBDA_SEGMENT_START
;

111 
u8
 
föÆ_v¨low_°¨t
[];

112 i‡(!
CONFIG_MALLOC_UPPERMEMORY
)

113 
ebda_£g
 = 
	`FLATPTR_TO_SEG
(
	`ALIGN_DOWN
((
u32
)
föÆ_v¨low_°¨t
, 1024)

114 - 
EBDA_SIZE_START
*1024);

115 
	`SET_BDA
(
ebda_£g
,Ébda_seg);

117 
	`SET_BDA
(
mem_size_kb
, 
ebda_£g
 / (1024/16));

120 
exãnded_bios_d©a_¨ó_s
 *
ebda
 = 
	`gë_ebda_±r
();

121 
	`mem£t
(
ebda
, 0, (*ebda));

122 
ebda
->
size
 = 
esize
;

124 
	`add_e820
((
u32
)
ebda
, 
BUILD_LOWRAM_END
-(u32Îbda, 
E820_RESERVED
);

127 
SèckPos
 = (*)(&
ExåaSèck
[
BUILD_EXTRA_STACK_SIZE
] - 
z⁄ñow_ba£
);

128 
	}
}

131 
	$öãrÁ˚_öô
()

134 
	`mÆloc_öô
();

137 
	`qemu_cfg_öô
();

138 
	`c‹eboŸ_cbfs_öô
();

141 
	`ivt_öô
();

142 
	`bda_öô
();

145 
	`boŸ_öô
();

146 
	`bios32_öô
();

147 
	`pmm_öô
();

148 
	`≤p_öô
();

149 
	`kbd_öô
();

150 
	`mou£_öô
();

151 
	}
}

155 
	$devi˚_h¨dw¨e_£tup
()

157 
	`usb_£tup
();

158 
	`ps2p‹t_£tup
();

159 
	`Õt_£tup
();

160 
	`£rül_£tup
();

162 
	`Ê›py_£tup
();

163 
	`©a_£tup
();

164 
	`ahci_£tup
();

165 
	`sd_£tup
();

166 
	`cbfs_∑ylﬂd_£tup
();

167 
	`ømdisk_£tup
();

168 
	`vútio_blk_£tup
();

169 
	`vútio_scsi_£tup
();

170 
	`lsi_scsi_£tup
();

171 
	`e•_scsi_£tup
();

172 
	`megaßs_£tup
();

173 
	`pvscsi_£tup
();

174 
	}
}

177 
	$∂©f‹m_h¨dw¨e_£tup
()

180 
	`£t¸0
(
	`gë¸0
(Ë& ~(
CR0_CD
|
CR0_NW
));

183 
	`dma_£tup
();

186 
	`pic_£tup
();

187 
	`m©h˝_£tup
();

188 
	`timî_£tup
();

189 
	`˛ock_£tup
();

192 
	`qemu_∂©f‹m_£tup
();

193 
	`c‹eboŸ_∂©f‹m_£tup
();

194 
	}
}

197 
	$¥ï¨eboŸ
()

200 
	`bcv_¥ïboŸ
();

203 
	`cdrom_¥ïboŸ
();

204 
	`pmm_¥ïboŸ
();

205 
	`mÆloc_¥ïboŸ
();

206 
	`memm≠_¥ïboŸ
();

209 
BiosChecksum
 -
	`checksum
((
u8
*)
BUILD_BIOS_ADDR
, 
BUILD_BIOS_SIZE
);

210 
	}
}

213 
VISIBLE32FLAT


214 
	$°¨tBoŸ
()

217 
	`mem£t
((*)
BUILD_STACK_ADDR
, 0, 
BUILD_EBDA_MINIMUM
 - BUILD_STACK_ADDR);

219 
	`d¥ötf
(3, "JumpÅo int19\n");

220 
bªgs
 
br
;

221 
	`mem£t
(&
br
, 0, (br));

222 
br
.
Êags
 = 
F_IF
;

223 
	`ˇŒ16_öt
(0x19, &
br
);

224 
	}
}

228 
	$maööô
()

231 
	`öãrÁ˚_öô
();

234 
	`∂©f‹m_h¨dw¨e_£tup
();

237 i‡(
CONFIG_RUN_PAYLOAD
) {

238 
	`d¥ötf
(1, "Lookög f‹Öaylﬂd %s\n", 
CONFIG_RUN_PAYLOAD_FILE
);

239 
romfûe_s
 *
fûe
 = 
NULL
;

240 
fûe
 = 
	`romfûe_föd
–
CONFIG_RUN_PAYLOAD_FILE
 );

241 i‡(!
fûe
)

242 
	`¥ötf
("CouldÇot findÖayload\n");

244 
cbfs_romfûe_s
 *
cfûe
;

245 
cfûe
 = 
	`c⁄èöî_of
(
fûe
, 
cbfs_romfûe_s
, file);

246 
	`cbfs_run_∑ylﬂd
(
cfûe
->
fhdr
);

251 i‡(
CONFIG_THREAD_OPTIONROMS
)

252 
	`devi˚_h¨dw¨e_£tup
();

255 
	`vg¨om_£tup
();

258 i‡(!
CONFIG_THREAD_OPTIONROMS
) {

259 
	`devi˚_h¨dw¨e_£tup
();

260 
	`waô_thªads
();

264 
	`›ti⁄rom_£tup
();

267 i‡(
CONFIG_DISPLAY_SYSTEM_INFO
)

268 
	`d¥ötf
(1, "\nBuûd d©e: %s\n", 
__DATE__
);

271 
	`öãø˘ive_boŸmíu
();

272 
	`waô_thªads
();

275 
	`¥ï¨eboŸ
();

278 
	`make_bios_ªad⁄ly
();

281 
	`°¨tBoŸ
();

282 
	}
}

291 
	$upd©eRñocs
(*
de°
, 
u32
 *
r°¨t
, u32 *
ªnd
, u32 
dñè
)

293 
u32
 *
ªloc
;

294 
ªloc
 = 
r°¨t
;Ñño¯< 
ªnd
;Ñeloc++)

295 *((
u32
*)(
de°
 + *
ªloc
)Ë+
dñè
;

296 
	}
}

301 
__n‹ëu∫


302 
	$ªloc_¥eöô
(*
f
, *
¨g
)

304 (*
func
)(*Ë
__n‹ëu∫
 = 
f
;

305 i‡(!
CONFIG_RELOCATE_INIT
)

306 
	`func
(
¨g
);

308 
u8
 
code32Ê©_°¨t
[];

309 
u8
 
_ªloc_mö_Æign
;

310 
u32
 
_ªloc_abs_°¨t
[], 
_ªloc_abs_íd
[];

311 
u32
 
_ªloc_ªl_°¨t
[], 
_ªloc_ªl_íd
[];

312 
u32
 
_ªloc_öô_°¨t
[], 
_ªloc_öô_íd
[];

313 
u8
 
code32öô_°¨t
[], 
code32öô_íd
[];

316 
u32
 
öôsize
 = 
code32öô_íd
 - 
code32öô_°¨t
;

317 
u32
 
codólign
 = (u32)&
_ªloc_mö_Æign
;

318 *
codede°
 = 
	`memÆign_tmp
(
codólign
, 
öôsize
);

319 i‡(!
codede°
)

320 
	`∑nic
("No space for initÑelocation.\n");

323 
	`d¥ötf
(1, "Relocating init from %pÅo %p (size %d)\n"

324 , 
code32öô_°¨t
, 
codede°
, 
öôsize
);

325 
s32
 
dñè
 = 
codede°
 - (*)
code32öô_°¨t
;

326 
	`mem˝y
(
codede°
, 
code32öô_°¨t
, 
öôsize
);

327 
	`upd©eRñocs
(
codede°
, 
_ªloc_abs_°¨t
, 
_ªloc_abs_íd
, 
dñè
);

328 
	`upd©eRñocs
(
codede°
, 
_ªloc_ªl_°¨t
, 
_ªloc_ªl_íd
, -
dñè
);

329 
	`upd©eRñocs
(
code32Ê©_°¨t
, 
_ªloc_öô_°¨t
, 
_ªloc_öô_íd
, 
dñè
);

330 i‡(
f
 >(*)
code32öô_°¨t
 && f < (*)
code32öô_íd
)

331 
func
 = 
f
 + 
dñè
;

334 
	`b¨rõr
();

335 
	`func
(
¨g
);

336 
	}
}

339 
VISIBLE32INIT


340 
	$d›o°
()

343 
	`qemu_¥eöô
();

344 
	`c‹eboŸ_¥eöô
();

345 
	`mÆloc_¥eöô
();

348 
	`ªloc_¥eöô
(
maööô
, 
NULL
);

349 
	}
}

354 
VISIBLE32FLAT


355 
	$h™dÀ_po°
()

357 #i‡
CONFIG_PRINT_TIMESTAMPS


358 
u64
 
tscvÆ
;

361 i‡(!
CONFIG_QEMU
 && !
CONFIG_COREBOOT
)

364 
	`£rül_debug_¥eöô
();

365 
	`debug_b™√r
();

366 #i‡
CONFIG_PRINT_TIMESTAMPS


367 
tscvÆ
 = 
	`rdts˛l
();

368 
	`d¥ötf
(1, "TSC: Start of seabios: 0x%08lx_%08lx\n",

369 ()(
tscvÆ
 >> 32),

370 ()
tscvÆ
);

374 
	`xí_¥eöô
();

377 
	`make_bios_wrôabÀ
();

380 
	`d›o°
();

381 
	}
}

	@resume.c

7 
	~"bªgs.h
"

8 
	~"c⁄fig.h
"

9 
	~"ÁΩå.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pic.h
"

12 
	~"hw/ps2p‹t.h
"

13 
	~"hw/πc.h
"

14 
	~"ouçut.h
"

15 
	~"°acks.h
"

16 
	~"°d/bda.h
"

17 
	~"°rög.h
"

18 
	~"utû.h
"

21 
HaveRunPo°
 
	gVARFSEG
;

24 
VISIBLE16


25 
	$h™dÀ_ªsume
()

27 
	`ASSERT16
();

28 
°©us
 = 
	`πc_ªad
(
CMOS_RESET_CODE
);

29 
	`πc_wrôe
(
CMOS_RESET_CODE
, 0);

30 
	`d¥ötf
(1, "I¿ªsumê(°©us=%d)\n", 
°©us
);

32 
	`dma_£tup
();

34 
°©us
) {

37 
	`∑nic
("Unim∂emíãd shutdow¿°©us: %02x\n", 
°©us
);

41 
	`pic_eoi2
();

44 
	#BDA_JUMP
 (((
bios_d©a_¨ó_s
 *)0)->
jump
)

	)

46 
asm
 volatile(

49 : : "m"(
BDA_JUMP
), "r"(
SEG_BDA
)

55 
asm
 volatile(

59 : : "m"(
BDA_JUMP
), "r"(
SEG_BDA
)

65 
asm
 volatile(

69 : : "m"(
BDA_JUMP
), "r"(
SEG_BDA
)

78 
asm
 volatile(

83 : : "i"(
BUILD_S3RESUME_STACK_ADDR
), "r"(0), "a"(
°©us
)

85 
	}
}

89 
	$s3_ªsume
()

91 i‡(!
CONFIG_S3_RESUME
)

94 
u32
 
s3_ªsume_ve˘‹
 = 
	`föd_ªsume_ve˘‹
();

95 i‡(!
s3_ªsume_ve˘‹
) {

96 
	`d¥ötf
(1, "NoÑesume vector set!\n");

100 
	`pic_£tup
();

101 
	`smm_£tup
();

103 
	`pci_ªsume
();

105 
	`s3_ªsume_vga
();

107 
	`make_bios_ªad⁄ly
();

110 
bªgs
 
br
;

111 
	`mem£t
(&
br
, 0, (br));

112 
	`d¥ötf
(1, "Jum∞tÿªsumêve˘‹ (%x)\n", 
s3_ªsume_ve˘‹
);

113 
br
.
code
 = 
	`FLATPTR_TO_SEGOFF
((*)
s3_ªsume_ve˘‹
);

114 
	`ÁrˇŒ16big
(&
br
);

115 
	}
}

117 
u8
 
HaveAâem±edReboŸ
 
	gVARLOW
;

121 
	$åyReboŸ
()

123 i‡(
HaveAâem±edReboŸ
) {

125 
	`d¥ötf
(1, "UnableÅo hard-reboot machine -áttempting shutdown.\n");

126 
	`≠m_shutdown
();

128 
HaveAâem±edReboŸ
 = 1;

130 
	`d¥ötf
(1, "Attemptingá hardÑeboot\n");

133 
	`qemu_¥ï_ª£t
();

136 
	`a˝i_ªboŸ
();

139 
	`i8042_ªboŸ
();

142 
	`pci_ªboŸ
();

145 
asm
 volatile("int3");

147 
	`∑nic
("CouldÇotÑeboot");

148 
	}
}

150 
VISIBLE32FLAT


151 
	$h™dÀ_ªsume32
(
°©us
)

153 
	`ASSERT32FLAT
();

154 
	`d¥ötf
(1, "In 32bitÑesume\n");

156 i‡(
°©us
 == 0xfe)

157 
	`s3_ªsume
();

160 
	`åyReboŸ
();

161 
	}
}

	@romfile.c

7 
	~"c⁄fig.h
"

8 
	~"mÆloc.h
"

9 
	~"ouçut.h
"

10 
	~"romfûe.h
"

11 
	~"°rög.h
"

13 
romfûe_s
 *
RomfûeRoŸ
 
	gVARVERIFY32INIT
;

16 
	$romfûe_add
(
romfûe_s
 *
fûe
)

18 
	`d¥ötf
(3, "AddÑomfûe: %†(size=%d)\n", 
fûe
->
«me
, fûe->
size
);

19 
fûe
->
√xt
 = 
RomfûeRoŸ
;

20 
RomfûeRoŸ
 = 
fûe
;

21 
	}
}

24 
romfûe_s
 *

25 
	$__romfûe_föd¥efix
(c⁄° *
¥efix
, 
¥efixÀn
, 
romfûe_s
 *
¥ev
)

27 
romfûe_s
 *
cur
 = 
RomfûeRoŸ
;

28 i‡(
¥ev
)

29 
cur
 = 
¥ev
->
√xt
;

30 
cur
) {

31 i‡(
	`°∫icmp
(
¥efix
, 
cur
->
«me
, 
¥efixÀn
) == 0)

32  
cur
;

33 
cur
 = cur->
√xt
;

35  
NULL
;

36 
	}
}

38 
romfûe_s
 *

39 
	$romfûe_föd¥efix
(c⁄° *
¥efix
, 
romfûe_s
 *
¥ev
)

41  
	`__romfûe_föd¥efix
(
¥efix
, 
	`°æí
’ªfix), 
¥ev
);

42 
	}
}

44 
romfûe_s
 *

45 
	$romfûe_föd
(c⁄° *
«me
)

47  
	`__romfûe_föd¥efix
(
«me
, 
	`°æí
“ameË+ 1, 
NULL
);

48 
	}
}

53 
	$romfûe_lﬂdfûe
(c⁄° *
«me
, *
psize
)

55 
romfûe_s
 *
fûe
 = 
	`romfûe_föd
(
«me
);

56 i‡(!
fûe
)

57  
NULL
;

59 
fûesize
 = 
fûe
->
size
;

60 i‡(!
fûesize
)

61  
NULL
;

63 *
d©a
 = 
	`mÆloc_tmphigh
(
fûesize
+1);

64 i‡(!
d©a
) {

65 
	`w¨n_nﬂŒoc
();

66  
NULL
;

69 
	`d¥ötf
(5, "C›yögÑomfûê'%s' (À¿%d)\n", 
«me
, 
fûesize
);

70 
ªt
 = 
fûe
->
	`c›y
(fûe, 
d©a
, 
fûesize
);

71 i‡(
ªt
 < 0) {

72 
	`‰ì
(
d©a
);

73  
NULL
;

75 i‡(
psize
)

76 *
psize
 = 
fûesize
;

77 
d©a
[
fûesize
] = '\0';

78  
d©a
;

79 
	}
}

83 
u64


84 
	$romfûe_lﬂdöt
(c⁄° *
«me
, 
u64
 
defvÆ
)

86 
romfûe_s
 *
fûe
 = 
	`romfûe_föd
(
«me
);

87 i‡(!
fûe
)

88  
defvÆ
;

90 
fûesize
 = 
fûe
->
size
;

91 i‡(!
fûesize
 || fûesizê> (
u64
) || (filesize & (filesize-1)))

93  
defvÆ
;

95 
u64
 
vÆ
 = 0;

96 
ªt
 = 
fûe
->
	`c›y
(fûe, &
vÆ
, (val));

97 i‡(
ªt
 < 0)

98  
defvÆ
;

99  
vÆ
;

100 
	}
}

107 *
	$cbfs_föd_°rög
(c⁄° *
°rög
, c⁄° *
fûíame
)

109 *
d©a
 = 
	`romfûe_lﬂdfûe
(
fûíame
, 
NULL
);

110 i‡(!
d©a
)

111  
NULL
;

112 
u8
 
Àngth
 = 
	`°æí
(
°rög
);

115 i‡(*
d©a
 == 0)

117 i‡(!
	`°∫icmp
(
°rög
, 
d©a
, 
Àngth
))

118  
d©a
;

119 
d©a
++;

121  
NULL
;

122 
	}
}

	@romfile.h

1 #i‚de‡
__ROMFILE_H


2 
	#__ROMFILE_H


	)

4 
	~"ty≥s.h
"

7 
	sromfûe_s
 {

8 
romfûe_s
 *
	m√xt
;

9 
	m«me
[128];

10 
u32
 
	msize
;

11 (*
	mc›y
)(
romfûe_s
 *
	mfûe
, *
	mde°
, 
u32
 
	mmaxÀn
);

13 
romfûe_add
(
romfûe_s
 *
fûe
);

14 
romfûe_s
 *
romfûe_föd¥efix
(c⁄° *
¥efix
, romfûe_†*
¥ev
);

15 
romfûe_s
 *
romfûe_föd
(c⁄° *
«me
);

16 *
romfûe_lﬂdfûe
(c⁄° *
«me
, *
psize
);

17 
u64
 
romfûe_lﬂdöt
(c⁄° *
«me
, u64 
defvÆ
);

18 *
cbfs_föd_°rög
(c⁄° *
°rög
, c⁄° *
fûíame
);

	@serial.c

9 
	~"biosv¨.h
"

10 
	~"bªgs.h
"

11 
	~"hw/£rülio.h
"

12 
	~"ouçut.h
"

13 
	~"romfûe.h
"

14 
	~"°acks.h
"

15 
	~"utû.h
"

22 
u16


23 
	$dëe˘_£rül
(
u16
 
p‹t
, 
u8
 
timeout
, u8 
cou¡
)

25 i‡(
CONFIG_DEBUG_SERIAL
 && 
p‹t
 =
CONFIG_DEBUG_SERIAL_PORT


26 && !
	`romfûe_lﬂdöt
("etc/advertise-serial-debug-port", 1))

28 
	`outb
(0x02, 
p‹t
+
SEROFF_IER
);

29 
u8
 
õr
 = 
	`öb
(
p‹t
+
SEROFF_IER
);

30 i‡(
õr
 != 0x02)

32 
u8
 
iú
 = 
	`öb
(
p‹t
+
SEROFF_IIR
);

33 i‡((
iú
 & 0x3f) != 0x02)

36 
	`outb
(0x00, 
p‹t
+
SEROFF_IER
);

37 
	`SET_BDA
(
p‹t_com
[
cou¡
], 
p‹t
);

38 
	`SET_BDA
(
com_timeout
[
cou¡
], 
timeout
);

40 
	}
}

43 
	$£rül_£tup
()

45 i‡(! 
CONFIG_SERIAL
)

47 
	`d¥ötf
(3, "init serial\n");

49 
u16
 
cou¡
 = 0;

50 
cou¡
 +
	`dëe˘_£rül
(
PORT_SERIAL1
, 0x0a, count);

51 
cou¡
 +
	`dëe˘_£rül
(
PORT_SERIAL2
, 0x0a, count);

52 
cou¡
 +
	`dëe˘_£rül
(
PORT_SERIAL3
, 0x0a, count);

53 
cou¡
 +
	`dëe˘_£rül
(
PORT_SERIAL4
, 0x0a, count);

54 
	`d¥ötf
(1, "Found %d sîü»p‹ts\n", 
cou¡
);

57 
	`£t_equùmít_Êags
(0xe00, 
cou¡
 << 9);

58 
	}
}

60 
u16


61 
	$gëComAddr
(
bªgs
 *
ªgs
)

63 i‡(
ªgs
->
dx
 >= 4) {

64 
	`£t_övÆid
(
ªgs
);

67 
u16
 
addr
 = 
	`GET_BDA
(
p‹t_com
[
ªgs
->
dx
]);

68 i‡(! 
addr
)

69 
	`£t_övÆid
(
ªgs
);

70  
addr
;

71 
	}
}

75 
	$h™dÀ_1400
(
bªgs
 *
ªgs
)

77 
u16
 
addr
 = 
	`gëComAddr
(
ªgs
);

78 i‡(!
addr
)

81 i‡(
CONFIG_KEEP_DEBUG_CONSOLE_SETTINGS
) {

84 i‡(
addr
 =
CONFIG_DEBUG_SERIAL_PORT
) {

85 
	`£t_suc˚ss
(
ªgs
);

90 
	`outb
(
	`öb
(
addr
+
SEROFF_LCR
) | 0x80,áddr+SEROFF_LCR);

91 i‡((
ªgs
->
Æ
 & 0xE0) == 0) {

92 
	`outb
(0x17, 
addr
+
SEROFF_DLL
);

93 
	`outb
(0x04, 
addr
+
SEROFF_DLH
);

95 
u16
 
vÆ16
 = 0x600 >> ((
ªgs
->
Æ
 & 0xE0) >> 5);

96 
	`outb
(
vÆ16
 & 0xFF, 
addr
+
SEROFF_DLL
);

97 
	`outb
(
vÆ16
 >> 8, 
addr
+
SEROFF_DLH
);

99 
	`outb
(
ªgs
->
Æ
 & 0x1F, 
addr
+
SEROFF_LCR
);

100 
ªgs
->
ah
 = 
	`öb
(
addr
+
SEROFF_LSR
);

101 
ªgs
->
Æ
 = 
	`öb
(
addr
+
SEROFF_MSR
);

102 
	`£t_suc˚ss
(
ªgs
);

103 
	}
}

107 
	$h™dÀ_1401
(
bªgs
 *
ªgs
)

109 
u16
 
addr
 = 
	`gëComAddr
(
ªgs
);

110 i‡(!
addr
)

112 
u32
 
íd
 = 
	`úqtimî_ˇlc_ticks
(
	`GET_BDA
(
com_timeout
[
ªgs
->
dx
]));

114 
u8
 
l§
 = 
	`öb
(
addr
+
SEROFF_LSR
);

115 i‡((
l§
 & 0x60) == 0x60) {

117 
	`outb
(
ªgs
->
Æ
, 
addr
+
SEROFF_DATA
);

119 
ªgs
->
ah
 = 
l§
;

122 i‡(
	`úqtimî_check
(
íd
)) {

124 
ªgs
->
ah
 = 
l§
 | 0x80;

127 
	`yõld
();

129 
	`£t_suc˚ss
(
ªgs
);

130 
	}
}

134 
	$h™dÀ_1402
(
bªgs
 *
ªgs
)

136 
u16
 
addr
 = 
	`gëComAddr
(
ªgs
);

137 i‡(!
addr
)

139 
u32
 
íd
 = 
	`úqtimî_ˇlc_ticks
(
	`GET_BDA
(
com_timeout
[
ªgs
->
dx
]));

141 
u8
 
l§
 = 
	`öb
(
addr
+
SEROFF_LSR
);

142 i‡(
l§
 & 0x01) {

144 
ªgs
->
Æ
 = 
	`öb
(
addr
+
SEROFF_DATA
);

145 
ªgs
->
ah
 = 
l§
;

148 i‡(
	`úqtimî_check
(
íd
)) {

150 
ªgs
->
ah
 = 
l§
 | 0x80;

153 
	`yõld
();

155 
	`£t_suc˚ss
(
ªgs
);

156 
	}
}

160 
	$h™dÀ_1403
(
bªgs
 *
ªgs
)

162 
u16
 
addr
 = 
	`gëComAddr
(
ªgs
);

163 i‡(!
addr
)

165 
ªgs
->
ah
 = 
	`öb
(
addr
+
SEROFF_LSR
);

166 
ªgs
->
Æ
 = 
	`öb
(
addr
+
SEROFF_MSR
);

167 
	`£t_suc˚ss
(
ªgs
);

168 
	}
}

171 
	$h™dÀ_14XX
(
bªgs
 *
ªgs
)

173 
	`£t_unim∂emíãd
(
ªgs
);

174 
	}
}

177 
VISIBLE16


178 
	$h™dÀ_14
(
bªgs
 *
ªgs
)

180 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_14
);

181 i‡(! 
CONFIG_SERIAL
) {

182 
	`h™dÀ_14XX
(
ªgs
);

186 
ªgs
->
ah
) {

187 0x00: 
	`h™dÀ_1400
(
ªgs
); ;

188 0x01: 
	`h™dÀ_1401
(
ªgs
); ;

189 0x02: 
	`h™dÀ_1402
(
ªgs
); ;

190 0x03: 
	`h™dÀ_1403
(
ªgs
); ;

191 : 
	`h™dÀ_14XX
(
ªgs
); ;

193 
	}
}

196 
u8
 
	gBaudTabÀ
[16] 
VAR16FIXED
(0xe729);

203 
u16


204 
	$dëe˘_∑Ω‹t
(
u16
 
p‹t
, 
u8
 
timeout
, u8 
cou¡
)

207 
	`outb
(
	`öb
(
p‹t
+2) & 0xdf,Öort+2);

209 
	`outb
(0xØ, 
p‹t
);

210 i‡(
	`öb
(
p‹t
) != 0xaa)

213 
	`SET_BDA
(
p‹t_Õt
[
cou¡
], 
p‹t
);

214 
	`SET_BDA
(
Õt_timeout
[
cou¡
], 
timeout
);

216 
	}
}

219 
	$Õt_£tup
()

221 i‡(! 
CONFIG_LPT
)

223 
	`d¥ötf
(3, "initÜpt\n");

225 
u16
 
cou¡
 = 0;

226 
cou¡
 +
	`dëe˘_∑Ω‹t
(
PORT_LPT1
, 0x14, count);

227 
cou¡
 +
	`dëe˘_∑Ω‹t
(
PORT_LPT2
, 0x14, count);

228 
	`d¥ötf
(1, "Found %dÜ±Ö‹ts\n", 
cou¡
);

231 
	`£t_equùmít_Êags
(0xc000, 
cou¡
 << 14);

232 
	}
}

234 
u16


235 
	$gëL±Addr
(
bªgs
 *
ªgs
)

237 i‡(
ªgs
->
dx
 >= 3) {

238 
	`£t_övÆid
(
ªgs
);

241 
u16
 
addr
 = 
	`GET_BDA
(
p‹t_Õt
[
ªgs
->
dx
]);

242 i‡(! 
addr
)

243 
	`£t_övÆid
(
ªgs
);

244  
addr
;

245 
	}
}

249 
	$h™dÀ_1700
(
bªgs
 *
ªgs
)

251 
u16
 
addr
 = 
	`gëL±Addr
(
ªgs
);

252 i‡(!
addr
)

255 
u32
 
íd
 = 
	`úqtimî_ˇlc_ticks
(
	`GET_BDA
(
Õt_timeout
[
ªgs
->
dx
]));

257 
	`outb
(
ªgs
->
Æ
, 
addr
);

258 
u8
 
vÆ8
 = 
	`öb
(
addr
+2);

259 
	`outb
(
vÆ8
 | 0x01, 
addr
+2);

260 
	`udñay
(5);

261 
	`outb
(
vÆ8
 & ~0x01, 
addr
+2);

264 
u8
 
v
 = 
	`öb
(
addr
+1);

265 i‡(!(
v
 & 0x40)) {

267 
ªgs
->
ah
 = 
v
 ^ 0x48;

270 i‡(
	`úqtimî_check
(
íd
)) {

272 
ªgs
->
ah
 = (
v
 ^ 0x48) | 0x01;

275 
	`yõld
();

278 
	`£t_suc˚ss
(
ªgs
);

279 
	}
}

283 
	$h™dÀ_1701
(
bªgs
 *
ªgs
)

285 
u16
 
addr
 = 
	`gëL±Addr
(
ªgs
);

286 i‡(!
addr
)

289 
u8
 
vÆ8
 = 
	`öb
(
addr
+2);

290 
	`outb
(
vÆ8
 & ~0x04, 
addr
+2);

291 
	`udñay
(5);

292 
	`outb
(
vÆ8
 | 0x04, 
addr
+2);

294 
ªgs
->
ah
 = 
	`öb
(
addr
+1) ^ 0x48;

295 
	`£t_suc˚ss
(
ªgs
);

296 
	}
}

300 
	$h™dÀ_1702
(
bªgs
 *
ªgs
)

302 
u16
 
addr
 = 
	`gëL±Addr
(
ªgs
);

303 i‡(!
addr
)

305 
ªgs
->
ah
 = 
	`öb
(
addr
+1) ^ 0x48;

306 
	`£t_suc˚ss
(
ªgs
);

307 
	}
}

310 
	$h™dÀ_17XX
(
bªgs
 *
ªgs
)

312 
	`£t_unim∂emíãd
(
ªgs
);

313 
	}
}

316 
VISIBLE16


317 
	$h™dÀ_17
(
bªgs
 *
ªgs
)

319 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_17
);

320 i‡(! 
CONFIG_LPT
) {

321 
	`h™dÀ_17XX
(
ªgs
);

325 
ªgs
->
ah
) {

326 0x00: 
	`h™dÀ_1700
(
ªgs
); ;

327 0x01: 
	`h™dÀ_1701
(
ªgs
); ;

328 0x02: 
	`h™dÀ_1702
(
ªgs
); ;

329 : 
	`h™dÀ_17XX
(
ªgs
); ;

331 
	}
}

333 #i‡
CONFIG_INT16_SERIAL_KEYBOARD


334 
u8
 
	gU¨tToSˇnCode
[] 
	gVAR16
 = {

348 
	$u¨t_check_key°rokes
()

350 
u8
 
rx_buf
[5], 
rx_byãs
 = 0, 
ascii_code
 = 0, 
sˇn_code
 = 0;

353 i‡(
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_LSR
) == 0xFF)

356 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_LSR
) & 0x01) {

357 i‡(
rx_byãs
 > (
rx_buf
)) {

358 
	`d¥ötf
(1, "uart_check_keystrokes:ÉrrorÅoo many bytesáreávailable\n");

359 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_LSR
) & 0x01)

360 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_DATA
);

364 
rx_buf
[
rx_byãs
++] = 
	`öb
(
CONFIG_DEBUG_SERIAL_PORT
 + 
SEROFF_DATA
);

367 i‡(!
rx_byãs
)

370 i‡(
rx_byãs
 == 1) {

371 
ascii_code
 = 
rx_buf
[0];

372 i‡(
ascii_code
 >
	`ARRAY_SIZE
(
U¨tToSˇnCode
)) {

373 
	`d¥ötf
(3, "uart_check_keystrokes:Érror UartToScanCode out of bounds index\n");

376 
sˇn_code
 = 
	`GET_GLOBAL
(
U¨tToSˇnCode
[
ascii_code
]);

377 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

379 i‡(
rx_byãs
 == 2) {

380 
ascii_code
 = 
rx_buf
[0];

381 i‡(
ascii_code
 >
	`ARRAY_SIZE
(
U¨tToSˇnCode
)) {

382 
	`d¥ötf
(3, "uart_check_keystrokes:Érror in 1/2 byte UartToScanCode out of bounds index\n");

385 
sˇn_code
 = 
	`GET_GLOBAL
(
U¨tToSˇnCode
[
ascii_code
]);

386 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

388 
ascii_code
 = 
rx_buf
[1];

389 i‡(
ascii_code
 >
	`ARRAY_SIZE
(
U¨tToSˇnCode
)) {

390 
	`d¥ötf
(3, "uart_check_keystrokes:Érror in 2/2 UartToScanCode out of bounds index\n");

393 
sˇn_code
 = 
	`GET_GLOBAL
(
U¨tToSˇnCode
[
ascii_code
]);

394 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

396 i‡(
rx_byãs
 == 3) {

397 i‡((
rx_buf
[0] == 0x1b) && (rx_buf[1] == 0x4f)) {

398 
ascii_code
 = 0;

399 i‡((
rx_buf
[2] >= 0x50) && (rx_buf[2] <= 0x59))

400 
sˇn_code
 = (
rx_buf
[2] - 0x50) +0x3b;

401 i‡((
rx_buf
[2] >= 0x5a) && (rx_buf[2] <= 0x5b))

402 
sˇn_code
 = (
rx_buf
[2] - 0x5a) + 0x85;

404 
	`d¥ötf
(3, "u¨t_check_key°rokes:Éº‹ i¿Fkey h™dlög %x\n",
rx_buf
[2]);

408 i‡((
rx_buf
[0] == 0x1b) && (rx_buf[1] == 0x5b)) {

409 
ascii_code
 = 0xe0;

410 i‡(
rx_buf
[2] =0x41Ë
sˇn_code
 = 0x48;

411 i‡(
rx_buf
[2] =0x42Ë
sˇn_code
 = 0x50;

412 i‡(
rx_buf
[2] =0x43Ë
sˇn_code
 = 0x4d;

413 i‡(
rx_buf
[2] =0x44Ë
sˇn_code
 = 0x4b;

415 
	`d¥ötf
(3, "u¨t_check_key°rokes:Éº‹ i¿curs‹ h™dlög %x\n",
rx_buf
[2]);

420 
	`d¥ötf
(3, "uart_check_keystrokes:Érror in 3 byte key sequence\n");

423 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

425 i‡(
rx_byãs
 == 4) {

426 i‡((
rx_buf
[0] == 0x1b) && (rx_buf[1] == 0x5b) && (rx_buf[2] == 0x33) && (rx_buf[3] == 0x7e)) {

427 
ascii_code
 = 0xe0;

428 
sˇn_code
 = 0x53;

429 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

432 
	`d¥ötf
(3, "uart_check_keystrokes: unhandled 4 byte keystroke ");

433 
	`d¥ötf
(3, "%x %x %x %x\n",
rx_buf
[0],rx_buf[1],rx_buf[2],rx_buf[3]);

438 i‡(
rx_byãs
 == 5) {

439 i‡((
rx_buf
[0] == 0x1b) && (rx_buf[1] == 0x5b) && (rx_buf[2] == 0x32) && (rx_buf[4] == 0x7e)) {

440 
ascii_code
 = 0x00;

441 i‡(
rx_buf
[3] =0x30Ë
sˇn_code
 = 0x43;

442 i‡(
rx_buf
[3] =0x31Ë
sˇn_code
 = 0x44;

443 i‡(
rx_buf
[3] =0x33Ë
sˇn_code
 = 0x85;

444 i‡(
rx_buf
[3] =0x34Ë
sˇn_code
 = 0x86;

446 
	`d¥ötf
(3, "uart_check_keystrokes: unhandled 5 byte keystroke F9-F12 ");

447 
	`d¥ötf
(3, "%x %x %x %x %x\n",
rx_buf
[0],rx_buf[1],rx_buf[2],rx_buf[3],rx_buf[4]);

451 i‡((
rx_buf
[0] == 0x1b) && (rx_buf[1] == 0x5b) && (rx_buf[2] == 0x31) && (rx_buf[4] == 0x7e)) {

452 
ascii_code
 = 0x00;

453 i‡(
rx_buf
[3] =0x31Ë
sˇn_code
 = 0x3B;

454 i‡(
rx_buf
[3] =0x32Ë
sˇn_code
 = 0x3C;

455 i‡(
rx_buf
[3] =0x33Ë
sˇn_code
 = 0x3D;

456 i‡(
rx_buf
[3] =0x34Ë
sˇn_code
 = 0x3E;

457 i‡(
rx_buf
[3] =0x35Ë
sˇn_code
 = 0x3F;

458 i‡(
rx_buf
[3] =0x37Ë
sˇn_code
 = 0x40;

459 i‡(
rx_buf
[3] =0x38Ë
sˇn_code
 = 0x41;

460 i‡(
rx_buf
[3] =0x39Ë
sˇn_code
 = 0x42;

462 
	`d¥ötf
(3, "uart_check_keystrokes: unhandled 5 byte keystroke F1-F8 ");

463 
	`d¥ötf
(3, "%x %x %x %x %x\n",
rx_buf
[0],rx_buf[1],rx_buf[2],rx_buf[3],rx_buf[4]);

468 
	`d¥ötf
(3, "uart_check_keystrokes: unhandled 5 byte keystroke ");

469 
	`d¥ötf
(3, "%x %x %x %x %x\n",
rx_buf
[0],rx_buf[1],rx_buf[2],rx_buf[3],rx_buf[4]);

472 
	`íqueue_key
(
sˇn_code
, 
ascii_code
);

475 
	`d¥ötf
(3, "u¨t_check_key°rokes: unh™dÀdÑx_byã†%x\n",
rx_byãs
);

476 
	`d¥ötf
(3, "%x %x %x %x %x\n",
rx_buf
[0],rx_buf[1],rx_buf[2],rx_buf[3],rx_buf[4]);

479 
	}
}

	@stacks.c

7 
	~"biosv¨.h
"

8 
	~"bªgs.h
"

9 
	~"hw/πc.h
"

10 
	~"li°.h
"

11 
	~"mÆloc.h
"

12 
	~"ouçut.h
"

13 
	~"°acks.h
"

14 
	~"utû.h
"

16 
	#MAIN_STACK_MAX
 (1024*1024)

	)

24 
u8
 
	gExåaSèck
[
BUILD_EXTRA_STACK_SIZE
+1] 
VARLOW
 
__Æig√d
(8);

25 
u8
 *
SèckPos
 
	gVARLOW
;

28 
ölöe
 

29 
	$⁄_exåa_°ack
()

31  
MODE16
 && 
	`GET_SEG
(
SS
Ë=
SEG_LOW
 && 
	`gëe•
(Ë> (
u32
)
ExåaSèck
;

32 
	}
}

35 
u32


36 
	$°ack_h›
(
u32
 
óx
, u32 
edx
, *
func
)

38 i‡(
	`⁄_exåa_°ack
())

39  ((
	`u32
 (*)(
u32
, u32))
func
)(
óx
, 
edx
);

40 
	`ASSERT16
();

41 
u16
 
°ack_£g
 = 
SEG_LOW
;

42 
u32
 
bkup_ss
, 
bkup_e•
;

43 
asm
 volatile(

61 : "+a" (
óx
), "+d" (
edx
), "+c" (
func
), "=&r" (
bkup_ss
), "=&r" (
bkup_e•
)

62 : "m" (
SèckPos
), "r" (
°ack_£g
)

64  
óx
;

65 
	}
}

68 
u32


69 
	$°ack_h›_back
(
u32
 
óx
, u32 
edx
, *
func
)

71 i‡(!
	`⁄_exåa_°ack
())

72  ((
	`u32
 (*)(
u32
, u32))
func
)(
óx
, 
edx
);

73 
	`ASSERT16
();

74 
u16
 
bkup_ss
;

75 
u32
 
bkup_°ack_pos
, 
ãmp
;

76 
asm
 volatile(

93 : "+a" (
óx
), "+d" (
edx
), "+c" (
func
), "=&r" (
bkup_ss
)

94 , "=&r" (
bkup_°ack_pos
), "=&r" (
ãmp
), "+m" (
SèckPos
)

97  
óx
;

98 
	}
}

105 
u16
 
SèckSeg
 
	gVARLOW
;

108 
u32
 
VISIBLE16


109 
	$ˇŒ32
(*
func
, 
u32
 
óx
, u32 
îºë
)

111 
	`ASSERT16
();

112 
u32
 
¸0
 = 
	`gë¸0
();

113 i‡(
¸0
 & 
CR0_PE
)

115  
îºë
;

118 
u8
 
cmosödex
 = 
	`öb
(
PORT_CMOS_INDEX
);

119 
	`outb
(
cmosödex
 | 
NMI_DISABLE_BIT
, 
PORT_CMOS_INDEX
);

120 
	`öb
(
PORT_CMOS_DATA
);

123 
u16
 
fs
 = 
	`GET_SEG
(
FS
), 
gs
 = GET_SEG(
GS
);

124 
des˛oc_s
 
gdt
;

125 
	`sgdt
(&
gdt
);

127 
u16
 
ﬁd°ack£g
 = 
	`GET_LOW
(
SèckSeg
);

128 
	`SET_LOW
(
SèckSeg
, 
	`GET_SEG
(
SS
));

129 
u32
 
bkup_ss
, 
bkup_e•
;

130 
asm
 volatile(

139 " mov»$(" 
	`__°rögify
(
BUILD_BIOS_ADDR
) " + 1f), %%edx\n"

151 : "=&r" (
bkup_ss
), "=&r" (
bkup_e•
), "+a" (
óx
)

152 : "r" (
func
)

155 
	`SET_LOW
(
SèckSeg
, 
ﬁd°ack£g
);

158 
	`lgdt
(&
gdt
);

159 
	`SET_SEG
(
FS
, 
fs
);

160 
	`SET_SEG
(
GS
, 
gs
);

163 
	`outb
(
cmosödex
, 
PORT_CMOS_INDEX
);

164 
	`öb
(
PORT_CMOS_DATA
);

165  
óx
;

166 
	}
}

169 
ölöe
 
u32


170 
	$ˇŒ16
(
u32
 
óx
, u32 
edx
, *
func
)

172 
	`ASSERT32FLAT
();

173 i‡(
	`gëe•
(Ë> 
MAIN_STACK_MAX
)

174 
	`∑nic
("call16 with invalid stack\n");

175 
u32
 
	`__ˇŒ16
(u32 
óx
, u32 
edx
, *
func
);

176  
	`__ˇŒ16
(
óx
, 
edx
, 
func
 - 
BUILD_BIOS_ADDR
);

177 
	}
}

179 
ölöe
 
u32


180 
	$ˇŒ16big
(
u32
 
óx
, u32 
edx
, *
func
)

182 
	`ASSERT32FLAT
();

183 i‡(
	`gëe•
(Ë> 
MAIN_STACK_MAX
)

184 
	`∑nic
("call16big with invalid stack\n");

185 
u32
 
	`__ˇŒ16big
(u32 
óx
, u32 
edx
, *
func
);

186  
	`__ˇŒ16big
(
óx
, 
edx
, 
func
 - 
BUILD_BIOS_ADDR
);

187 
	}
}

195 
VISIBLE16


196 
	$_ÁrˇŒ16
(
bªgs
 *
ˇŒªgs
, 
u16
 
ˇŒªg£g
)

198 
	`ASSERT16
();

199 i‡(
	`⁄_exåa_°ack
()) {

200 
	`°ack_h›_back
((
u32
)
ˇŒªgs
, 
ˇŒªg£g
, 
_ÁrˇŒ16
);

203 
asm
 volatile(

205 : "+a" (
ˇŒªgs
), "+m" (*ˇŒªgs), "+d" (
ˇŒªg£g
)

208 
	}
}

210 
ölöe
 

211 
	$ÁrˇŒ16
(
bªgs
 *
ˇŒªgs
)

213 i‡(
MODE16
) {

214 
	`_ÁrˇŒ16
(
ˇŒªgs
, 
	`GET_SEG
(
SS
));

217 
	`_cfunc16__ÁrˇŒ16
();

218 
	`ˇŒ16
((
u32
)
ˇŒªgs
 - 
SèckSeg
 * 16, SèckSeg, 
_cfunc16__ÁrˇŒ16
);

219 
	}
}

221 
ölöe
 

222 
	$ÁrˇŒ16big
(
bªgs
 *
ˇŒªgs
)

224 
	`_cfunc16__ÁrˇŒ16
();

225 
	`ˇŒ16big
((
u32
)
ˇŒªgs
 - 
SèckSeg
 * 16, SèckSeg, 
_cfunc16__ÁrˇŒ16
);

226 
	}
}

229 
ölöe
 

230 
	$__ˇŒ16_öt
(
bªgs
 *
ˇŒªgs
, 
u16
 
off£t
)

232 i‡(
MODESEGMENT
)

233 
ˇŒªgs
->
code
.
£g
 = 
	`GET_SEG
(
CS
);

235 
ˇŒªgs
->
code
.
£g
 = 
SEG_BIOS
;

236 
ˇŒªgs
->
code
.
off£t
 = offset;

237 
	`ÁrˇŒ16
(
ˇŒªgs
);

238 
	}
}

247 
	sthªad_öfo
 {

248 *
	m°ackpos
;

249 
hli°_node
 
	mnode
;

251 
thªad_öfo
 
MaöThªad
 
	gVARFSEG
 = {

252 
NULL
, { &
MaöThªad
.
node
, &MaöThªad.node.
√xt
 }

254 
	#THREADSTACKSIZE
 4096

	)

258 
	$have_thªads
()

260  (
CONFIG_THREADS


261 && 
	`GET_FLATPTR
(
MaöThªad
.
node
.
√xt
) != &MainThread.node);

262 
	}
}

265 
thªad_öfo
 *

266 
	$gëCurThªad
()

268 
u32
 
e•
 = 
	`gëe•
();

269 i‡(
e•
 <
MAIN_STACK_MAX
)

270  &
MaöThªad
;

271  (*)
	`ALIGN_DOWN
(
e•
, 
THREADSTACKSIZE
);

272 
	}
}

276 
	$swôch_√xt
(
thªad_öfo
 *
cur
)

278 
thªad_öfo
 *
√xt
 = 
	`c⁄èöî_of
(

279 
cur
->
node
.
√xt
, 
thªad_öfo
,Çode);

280 i‡(
cur
 =
√xt
)

283 
asm
 volatile(

291 : "+a"(
cur
), "+c"(
√xt
)

294 
	}
}

298 
	$__íd_thªad
(
thªad_öfo
 *
ﬁd
)

300 
	`hli°_dñ
(&
ﬁd
->
node
);

301 
	`d¥ötf
(
DEBUG_thªad
, "\\%08x/ EndÅhªad\n", (
u32
)
ﬁd
);

302 
	`‰ì
(
ﬁd
);

303 i‡(!
	`have_thªads
())

304 
	`d¥ötf
(1, "AllÅhreads complete.\n");

305 
	}
}

309 
	$run_thªad
((*
func
)(*), *
d©a
)

311 
	`ASSERT32FLAT
();

312 i‡(! 
CONFIG_THREADS
)

313 
Áû
;

314 
thªad_öfo
 *
thªad
;

315 
thªad
 = 
	`memÆign_tmphigh
(
THREADSTACKSIZE
, THREADSTACKSIZE);

316 i‡(!
thªad
)

317 
Áû
;

319 
	`d¥ötf
(
DEBUG_thªad
, "/%08x\\ SèπÅhªad\n", (
u32
)
thªad
);

320 
thªad
->
°ackpos
 = (*Èhªad + 
THREADSTACKSIZE
;

321 
thªad_öfo
 *
cur
 = 
	`gëCurThªad
();

322 
	`hli°_add_a·î
(&
thªad
->
node
, &
cur
->node);

323 
asm
 volatile(

340 : "+a"(
d©a
), "+c"(
func
), "+b"(
thªad
), "+d"(
cur
)

341 : "m"(*(
u8
*)
__íd_thªad
), "m"(
MaöThªad
)

345 
Áû
:

346 
	`func
(
d©a
);

347 
	}
}

355 
VISIBLE16


356 
	$check_úqs
()

358 i‡(
	`⁄_exåa_°ack
()) {

359 
	`°ack_h›_back
(0, 0, 
check_úqs
);

362 
asm
 volatile("sti ;Çop ;Ñep ;Çop ; cli ; cld" : : :"memory");

363 
	}
}

367 
	$yõld
()

369 i‡(
MODESEGMENT
) {

370 
	`check_úqs
();

373 
	`_cfunc16_check_úqs
();

374 i‡(!
CONFIG_THREADS
) {

375 
	`ˇŒ16big
(0, 0, 
_cfunc16_check_úqs
);

378 
thªad_öfo
 *
cur
 = 
	`gëCurThªad
();

379 i‡(
cur
 =&
MaöThªad
)

381 
	`ˇŒ16big
(0, 0, 
_cfunc16_check_úqs
);

384 
	`swôch_√xt
(
cur
);

385 
	}
}

387 
VISIBLE16


388 
	$waô_úq
()

390 i‡(
	`⁄_exåa_°ack
()) {

391 
	`°ack_h›_back
(0, 0, 
waô_úq
);

394 
asm
 volatile("sti ; hlt ; cli ; cld": : :"memory");

395 
	}
}

399 
	$yõld_toúq
()

401 i‡(
MODESEGMENT
) {

402 
	`waô_úq
();

405 i‡(
	`have_thªads
()) {

407 
	`yõld
();

410 
	`_cfunc16_waô_úq
();

411 
	`ˇŒ16big
(0, 0, 
_cfunc16_waô_úq
);

412 
	}
}

416 
	$waô_thªads
()

418 
	`ASSERT32FLAT
();

419 
	`have_thªads
())

420 
	`yõld
();

421 
	}
}

424 
	$muãx_lock
(
muãx_s
 *
muãx
)

426 
	`ASSERT32FLAT
();

427 i‡(! 
CONFIG_THREADS
)

429 
muãx
->
isLocked
)

430 
	`yõld
();

431 
muãx
->
isLocked
 = 1;

432 
	}
}

435 
	$muãx_u∆ock
(
muãx_s
 *
muãx
)

437 
	`ASSERT32FLAT
();

438 i‡(! 
CONFIG_THREADS
)

440 
muãx
->
isLocked
 = 0;

441 
	}
}

448 
C™Pªem±
 
	gVARFSEG
;

449 
u32
 
	gPªem±Cou¡
;

453 
	$°¨t_¥ìm±
()

455 i‡(! 
CONFIG_THREAD_OPTIONROMS
)

457 
C™Pªem±
 = 1;

458 
Pªem±Cou¡
 = 0;

459 
	`πc_u£
();

460 
	}
}

464 
	$föish_¥ìm±
()

466 i‡(! 
CONFIG_THREAD_OPTIONROMS
) {

467 
	`yõld
();

470 
C™Pªem±
 = 0;

471 
	`πc_ªÀa£
();

472 
	`d¥ötf
(9, "D⁄ê¥ìm± - %d checks\n", 
Pªem±Cou¡
);

473 
	`yõld
();

474 
	}
}

478 
	$waô_¥ìm±
()

480 i‡(
MODESEGMENT
 || !
CONFIG_THREAD_OPTIONROMS
 || !
C™Pªem±


481 || 
	`gëe•
(Ë< 
MAIN_STACK_MAX
)

483 
C™Pªem±
)

484 
	`yõld
();

486 
	}
}

489 
VISIBLE32INIT


490 
	$yõld_¥ìm±
()

492 
Pªem±Cou¡
++;

493 
	`swôch_√xt
(&
MaöThªad
);

494 
	}
}

498 
	$check_¥ìm±
()

500 
	`_cfunc32Ê©_yõld_¥ìm±
();

501 i‡(
CONFIG_THREAD_OPTIONROMS
 && 
	`GET_GLOBAL
(
C™Pªem±
Ë&& 
	`have_thªads
())

502 
	`ˇŒ32
(
_cfunc32Ê©_yõld_¥ìm±
, 0, 0);

503 
	}
}

510 
	sˇŒ32_∑øms_s
 {

511 *
	mfunc
;

512 
u32
 
	móx
, 
	medx
, 
	mecx
;

515 
u32
 
VISIBLE32FLAT


516 
	$ˇŒ32_∑øms_hñ≥r
(
ˇŒ32_∑øms_s
 *
∑øms
)

518  ((
	`u32
 (*)(
u32
, u32, u32))
∑øms
->
func
)(

519 
∑øms
->
óx
,Ö¨ams->
edx
,Ö¨ams->
ecx
);

520 
	}
}

522 
u32


523 
	$ˇŒ32_∑øms
(*
func
, 
u32
 
óx
, u32 
edx
, u32 
ecx
, u32 
îºë
)

525 
	`ASSERT16
();

526 
ˇŒ32_∑øms_s
 
∑øms
 = {
func
, 
óx
, 
edx
, 
ecx
};

527 
	`_cfunc32Ê©_ˇŒ32_∑øms_hñ≥r
();

528  
	`ˇŒ32
(
_cfunc32Ê©_ˇŒ32_∑øms_hñ≥r


529 , (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), &
∑øms
), 
îºë
);

530 
	}
}

	@stacks.h

2 #i‚de‡
__STACKS_H


3 
	#__STACKS_H


	)

5 
	~"ty≥s.h
"

8 
u8
 
ExåaSèck
[], *
SèckPos
;

9 
u32
 
°ack_h›
(u32 
óx
, u32 
edx
, *
func
);

10 
u32
 
°ack_h›_back
(u32 
óx
, u32 
edx
, *
func
);

11 
u32
 
ˇŒ32
(*
func
, u32 
óx
, u32 
îºë
);

12 
	gbªgs
;

13 
ölöe
 
ÁrˇŒ16
(
bªgs
 *
ˇŒªgs
);

14 
ölöe
 
ÁrˇŒ16big
(
bªgs
 *
ˇŒªgs
);

15 
ölöe
 
__ˇŒ16_öt
(
bªgs
 *
ˇŒªgs
, 
u16
 
off£t
);

16 
	#ˇŒ16_öt
(
ƒ
, 
ˇŒªgs
) do { \

17 
úq_åampﬁöe_
 ##
	`ƒ
 (); \

18 
	`__ˇŒ16_öt
((
ˇŒªgs
), (
u32
)&
úq_åampﬁöe_
 ##
ƒ
 ); \

19 } 0)

	)

20 
thªad_öfo
 
MaöThªad
;

21 
thªad_öfo
 *
gëCurThªad
();

22 
yõld
();

23 
yõld_toúq
();

24 
run_thªad
((*
func
)(*), *
d©a
);

25 
	`waô_thªads
();

26 
	smuãx_s
 { 
u32
 
isLocked
; };

27 
	`muãx_lock
(
muãx_s
 *
muãx
);

28 
	`muãx_u∆ock
(
muãx_s
 *
muãx
);

29 
	`°¨t_¥ìm±
();

30 
	`föish_¥ìm±
();

31 
	`waô_¥ìm±
();

32 
	`check_¥ìm±
();

33 
u32
 
	`ˇŒ32_∑øms
(*
func
, u32 
óx
, u32 
edx
, u32 
ecx
, u32 
îºë
);

	@std/LegacyBios.h

27 #i‚de‡
_EFI_LEGACY_BIOS_H_


28 
	#_EFI_LEGACY_BIOS_H_


	)

33 #¥agm®
∑ck
(1)

35 
UINT8
 
	tSERIAL_MODE
;

36 
UINT8
 
	tPARALLEL_MODE
;

38 
	#EFI_COMPATIBILITY16_TABLE_SIGNATURE
 
	`SIGNATURE_32
 ('I', 'F', 'E', '$')

	)

53 
UINT32
 
	mSig«tuª
;

58 
UINT8
 
	mTabÀChecksum
;

63 
UINT8
 
	mTabÀLígth
;

68 
UINT8
 
	mEfiMaj‹Revisi⁄
;

73 
UINT8
 
	mEfiMö‹Revisi⁄
;

78 
UINT8
 
	mTabÀMaj‹Revisi⁄
;

83 
UINT8
 
	mTabÀMö‹Revisi⁄
;

88 
UINT16
 
	mRe£rved
;

93 
UINT16
 
	mCom∑tibûôy16CÆlSegmít
;

98 
UINT16
 
	mCom∑tibûôy16CÆlOff£t
;

104 
UINT16
 
	mPnPIn°Æœti⁄CheckSegmít
;

110 
UINT16
 
	mPnPIn°Æœti⁄CheckOff£t
;

116 
UINT32
 
	mEfiSy°emTabÀ
;

121 
UINT32
 
	mOemIdSåögPoöãr
;

129 
UINT32
 
	mA˝iRsdPåPoöãr
;

134 
UINT16
 
	mOemRevisi⁄
;

141 
UINT32
 
	mE820Poöãr
;

146 
UINT32
 
	mE820Lígth
;

153 
UINT32
 
	mIrqRoutögTabÀPoöãr
;

158 
UINT32
 
	mIrqRoutögTabÀLígth
;

165 
UINT32
 
	mMpTabÀPå
;

170 
UINT32
 
	mMpTabÀLígth
;

175 
UINT16
 
	mOemI¡Segmít
;

180 
UINT16
 
	mOemI¡Off£t
;

185 
UINT16
 
	mOem32Segmít
;

190 
UINT16
 
	mOem32Off£t
;

195 
UINT16
 
	mOem16Segmít
;

200 
UINT16
 
	mOem16Off£t
;

205 
UINT16
 
	mTpmSegmít
;

210 
UINT16
 
	mTpmOff£t
;

215 
UINT32
 
	mIbvPoöãr
;

225 
UINT32
 
	mPciEx¥essBa£
;

230 
UINT8
 
	mLa°PciBus
;

231 } 
	tEFI_COMPATIBILITY16_TABLE
;

251 
	mLegacy16InôülizeYour£lf
 = 0x0000,

261 
	mLegacy16Upd©eBbs
 = 0x0001,

272 
	mLegacy16Pª∑ªToBoŸ
 = 0x0002,

281 
	mLegacy16BoŸ
 = 0x0003,

292 
	mLegacy16RërõveLa°BoŸDevi˚
 = 0x0004,

303 
	mLegacy16Di•©chO¥om
 = 0x0005,

320 
	mLegacy16GëTabÀAddªss
 = 0x0006,

333 
	mLegacy16SëKeybﬂrdLeds
 = 0x0007,

344 
	mLegacy16In°ÆlPciH™dÀr
 = 0x0008

345 } 
	tEFI_COMPATIBILITY_FUNCTIONS
;

352 
UINT16
 
	mPnPIn°Æœti⁄CheckSegmít
;

353 
UINT16
 
	mPnPIn°Æœti⁄CheckOff£t
;

354 
UINT16
 
	mO¥omSegmít
;

355 
UINT8
 
	mPciBus
;

356 
UINT8
 
	mPciDevi˚Fun˘i⁄
;

357 
UINT8
 
	mNumbîBbsE¡rõs
;

360 
UINT32
 
	mBbsTabÀPoöãr
;

361 
UINT16
 
	mRu¡imeSegmít
;

367 } 
	tEFI_DISPATCH_OPROM_TABLE
;

376 
UINT32
 
	mBiosLessTh™1MB
;

381 
UINT32
 
	mHiPmmMem‹y
;

386 
UINT32
 
	mHiPmmMem‹ySizeInByãs
;

391 
UINT16
 
	mRevî£ThunkCÆlSegmít
;

396 
UINT16
 
	mRevî£ThunkCÆlOff£t
;

401 
UINT32
 
	mNumbîE820E¡rõs
;

406 
UINT32
 
	mOsMem‹yAbove1Mb
;

411 
UINT32
 
	mThunkSèπ
;

416 
UINT32
 
	mThunkSizeInByãs
;

421 
UINT32
 
	mLowPmmMem‹y
;

426 
UINT32
 
	mLowPmmMem‹ySizeInByãs
;

427 } 
	tEFI_TO_COMPATIBILITY16_INIT_TABLE
;

433 
UINT16
 
	mAddªss
;

434 
UINT8
 
	mIrq
;

435 
SERIAL_MODE
 
	mMode
;

436 } 
	tDEVICE_PRODUCER_SERIAL
;

441 
	#DEVICE_SERIAL_MODE_NORMAL
 0x00

	)

442 
	#DEVICE_SERIAL_MODE_IRDA
 0x01

	)

443 
	#DEVICE_SERIAL_MODE_ASK_IR
 0x02

	)

444 
	#DEVICE_SERIAL_MODE_DUPLEX_HALF
 0x00

	)

445 
	#DEVICE_SERIAL_MODE_DUPLEX_FULL
 0x10

	)

452 
UINT16
 
	mAddªss
;

453 
UINT8
 
	mIrq
;

454 
UINT8
 
	mDma
;

455 
PARALLEL_MODE
 
	mMode
;

456 } 
	tDEVICE_PRODUCER_PARALLEL
;

461 
	#DEVICE_PARALLEL_MODE_MODE_OUTPUT_ONLY
 0x00

	)

462 
	#DEVICE_PARALLEL_MODE_MODE_BIDIRECTIONAL
 0x01

	)

463 
	#DEVICE_PARALLEL_MODE_MODE_EPP
 0x02

	)

464 
	#DEVICE_PARALLEL_MODE_MODE_ECP
 0x03

	)

471 
UINT16
 
	mAddªss
;

472 
UINT8
 
	mIrq
;

473 
UINT8
 
	mDma
;

474 
UINT8
 
	mNumbîOfFl›py
;

475 } 
	tDEVICE_PRODUCER_FLOPPY
;

481 
UINT32
 
	mA20Kybd
 : 1;

482 
UINT32
 
	mA20P‹t90
 : 1;

483 
UINT32
 
	mRe£rved
 : 30;

484 } 
	tLEGACY_DEVICE_FLAGS
;

490 
DEVICE_PRODUCER_SERIAL
 
	mSîül
[4];

491 
DEVICE_PRODUCER_PARALLEL
 
	mP¨ÆÀl
[3];

492 
DEVICE_PRODUCER_FLOPPY
 
	mFl›py
;

493 
UINT8
 
	mMou£Pª£¡
;

494 
LEGACY_DEVICE_FLAGS
 
	mFœgs
;

495 } 
	tDEVICE_PRODUCER_DATA_HEADER
;

501 
UINT16
 
	mRaw
[256];

502 } 
	tATAPI_IDENTIFY
;

513 
UINT16
 
	mSètus
;

518 
UINT32
 
	mBus
;

523 
UINT32
 
	mDevi˚
;

528 
UINT32
 
	mFun˘i⁄
;

533 
UINT16
 
	mComm™dBa£Addªss
;

538 
UINT16
 
	mC⁄åﬁBa£Addªss
;

543 
UINT16
 
	mBusMa°îAddªss
;

545 
UINT8
 
	mHddIrq
;

550 
ATAPI_IDENTIFY
 
	mIdítifyDrive
[2];

551 } 
	tHDD_INFO
;

556 
	#HDD_PRIMARY
 0x01

	)

557 
	#HDD_SECONDARY
 0x02

	)

558 
	#HDD_MASTER_ATAPI_CDROM
 0x04

	)

559 
	#HDD_SLAVE_ATAPI_CDROM
 0x08

	)

560 
	#HDD_MASTER_IDE
 0x20

	)

561 
	#HDD_SLAVE_IDE
 0x40

	)

562 
	#HDD_MASTER_ATAPI_ZIPDISK
 0x10

	)

563 
	#HDD_SLAVE_ATAPI_ZIPDISK
 0x80

	)

569 
UINT16
 
	mOldPosôi⁄
 : 4;

570 
UINT16
 
	mRe£rved1
 : 4;

571 
UINT16
 
	mE«bÀd
 : 1;

572 
UINT16
 
	mFaûed
 : 1;

582 
UINT16
 
	mMedüPª£¡
 : 2;

583 
UINT16
 
	mRe£rved2
 : 4;

584 } 
	tBBS_STATUS_FLAGS
;

593 
UINT16
 
	mBoŸPri‹ôy
;

598 
UINT32
 
	mBus
;

603 
UINT32
 
	mDevi˚
;

608 
UINT32
 
	mFun˘i⁄
;

613 
UINT8
 
	mCœss
;

618 
UINT8
 
	mSubCœss
;

623 
UINT16
 
	mMfgSåögOff£t
;

628 
UINT16
 
	mMfgSåögSegmít
;

633 
UINT16
 
	mDevi˚Ty≥
;

638 
BBS_STATUS_FLAGS
 
	mSètusFœgs
;

644 
UINT16
 
	mBoŸH™dÀrOff£t
;

650 
UINT16
 
	mBoŸH™dÀrSegmít
;

655 
UINT16
 
	mDescSåögOff£t
;

660 
UINT16
 
	mDescSåögSegmít
;

665 
UINT32
 
	mInôPîRe£rved
;

672 
UINT32
 
	mAddôi⁄ÆIrq13H™dÀr
;

679 
UINT32
 
	mAddôi⁄ÆIrq18H™dÀr
;

686 
UINT32
 
	mAddôi⁄ÆIrq19H™dÀr
;

693 
UINT32
 
	mAddôi⁄ÆIrq40H™dÀr
;

694 
UINT8
 
	mAssig√dDriveNumbî
;

695 
UINT32
 
	mAddôi⁄ÆIrq41H™dÀr
;

696 
UINT32
 
	mAddôi⁄ÆIrq46H™dÀr
;

697 
UINT32
 
	mIBV1
;

698 
UINT32
 
	mIBV2
;

699 } 
	tBBS_TABLE
;

704 
	#BBS_FLOPPY
 0x01

	)

705 
	#BBS_HARDDISK
 0x02

	)

706 
	#BBS_CDROM
 0x03

	)

707 
	#BBS_PCMCIA
 0x04

	)

708 
	#BBS_USB
 0x05

	)

709 
	#BBS_EMBED_NETWORK
 0x06

	)

710 
	#BBS_BEV_DEVICE
 0x80

	)

711 
	#BBS_UNKNOWN
 0xff

	)

717 
	#BBS_DO_NOT_BOOT_FROM
 0xFFFC

	)

718 
	#BBS_LOWEST_PRIORITY
 0xFFFD

	)

719 
	#BBS_UNPRIORITIZED_ENTRY
 0xFFFE

	)

720 
	#BBS_IGNORE_ENTRY
 0xFFFF

	)

731 
UINT16
 
	mTy≥
 : 3;

736 
UINT16
 
	mP‹tGønuœrôy
 : 3;

741 
UINT16
 
	mD©aGønuœrôy
 : 3;

746 
UINT16
 
	mRe£rved
 : 7;

747 } 
	tSMM_ATTRIBUTES
;

752 
	#STANDARD_IO
 0x00

	)

753 
	#STANDARD_MEMORY
 0x01

	)

759 
	#PORT_SIZE_8
 0x00

	)

760 
	#PORT_SIZE_16
 0x01

	)

761 
	#PORT_SIZE_32
 0x02

	)

762 
	#PORT_SIZE_64
 0x03

	)

768 
	#DATA_SIZE_8
 0x00

	)

769 
	#DATA_SIZE_16
 0x01

	)

770 
	#DATA_SIZE_32
 0x02

	)

771 
	#DATA_SIZE_64
 0x03

	)

778 
UINT16
 
	mFun˘i⁄
 : 15;

779 
UINT16
 
	mOw√r
 : 1;

780 } 
	tSMM_FUNCTION
;

785 
	#INT15_D042
 0x0000

	)

786 
	#GET_USB_BOOT_INFO
 0x0001

	)

787 
	#DMI_PNP_50_57
 0x0002

	)

793 
	#STANDARD_OWNER
 0x0

	)

794 
	#OEM_OWNER
 0x1

	)

806 
SMM_ATTRIBUTES
 
	mSmmAâribuãs
;

811 
SMM_FUNCTION
 
	mSmmFun˘i⁄
;

816 
UINT8
 
	mSmmP‹t
;

821 
UINT8
 
	mSmmD©a
;

822 } 
	tSMM_ENTRY
;

828 
UINT16
 
	mNumSmmE¡rõs
;

829 
SMM_ENTRY
 
	mSmmE¡ry
;

830 } 
	tSMM_TABLE
;

839 
UINT8
 
	mDúe˘‹ySîvi˚VÆidôy
 : 1;

845 
UINT8
 
	mRabˇU£dFœg
 : 1;

850 
UINT8
 
	mExecuãHddDügno°icsFœg
 : 1;

855 
UINT8
 
	mRe£rved
 : 5;

856 } 
	tUDC_ATTRIBUTES
;

866 
UDC_ATTRIBUTES
 
	mAâribuãs
;

872 
UINT8
 
	mDevi˚Numbî
;

879 
UINT8
 
	mBbsTabÀE¡ryNumbîF‹P¨ítDevi˚
;

884 
UINT8
 
	mBbsTabÀE¡ryNumbîF‹BoŸ
;

889 
UINT8
 
	mBbsTabÀE¡ryNumbîF‹HddDüg
;

894 
UINT8
 
	mBìrD©a
[128];

899 
UINT8
 
	mSîvi˚AªaD©a
[64];

900 } 
	tUD_TABLE
;

902 
	#EFI_TO_LEGACY_MAJOR_VERSION
 0x02

	)

903 
	#EFI_TO_LEGACY_MINOR_VERSION
 0x00

	)

904 
	#MAX_IDE_CONTROLLER
 8

	)

910 
UINT16
 
	mMaj‹Vîsi⁄
;

911 
UINT16
 
	mMö‹Vîsi⁄
;

912 
UINT32
 
	mA˝iTabÀ
;

913 
UINT32
 
	mSmbiosTabÀ
;

914 
UINT32
 
	mSmbiosTabÀLígth
;

918 
DEVICE_PRODUCER_DATA_HEADER
 
	mSioD©a
;

919 
UINT16
 
	mDevi˚P©hTy≥
;

920 
UINT16
 
	mPciIrqMask
;

921 
UINT32
 
	mNumbîE820E¡rõs
;

926 
HDD_INFO
 
	mHddInfo
[
MAX_IDE_CONTROLLER
];

927 
UINT32
 
	mNumbîBbsE¡rõs
;

928 
UINT32
 
	mBbsTabÀ
;

929 
UINT32
 
	mSmmTabÀ
;

930 
UINT32
 
	mOsMem‹yAbove1Mb
;

933 
UINT32
 
	mUnc⁄víti⁄ÆDevi˚TabÀ
;

935 } 
	tEFI_TO_COMPATIBILITY16_BOOT_TABLE
;

941 
UINT8
 
	mPciBus
;

942 
UINT8
 
	mPciDevi˚Fun
;

943 
UINT8
 
	mPciSegmít
;

944 
UINT8
 
	mPciCœss
;

945 
UINT8
 
	mPciSub˛ass
;

946 
UINT8
 
	mPciI¡îÁ˚
;

950 
UINT8
 
	mPrim¨yIrq
;

951 
UINT8
 
	mPrim¨yRe£rved
;

952 
UINT16
 
	mPrim¨yC⁄åﬁ
;

953 
UINT16
 
	mPrim¨yBa£
;

954 
UINT16
 
	mPrim¨yBusMa°î
;

958 
UINT8
 
	mSec⁄d¨yIrq
;

959 
UINT8
 
	mSec⁄d¨yRe£rved
;

960 
UINT16
 
	mSec⁄d¨yC⁄åﬁ
;

961 
UINT16
 
	mSec⁄d¨yBa£
;

962 
UINT16
 
	mSec⁄d¨yBusMa°î
;

963 } 
	tEFI_LEGACY_INSTALL_PCI_HANDLER
;

	@std/acpi.h

1 #i‚de‡
__ACPI_H


2 
	#__ACPI_H


	)

4 
	~"ty≥s.h
"

9 
	sa˝i_20_gíîic_addªss
 {

10 
u8
 
	maddªss_•a˚_id
;

11 
u8
 
	mªgi°î_bô_width
;

12 
u8
 
	mªgi°î_bô_off£t
;

13 
u8
 
	mª£rved
;

14 
u64
 
	maddªss
;

15 } 
	gPACKED
;

17 
	#RSDP_SIGNATURE
 0x2052545020445352LL

18 

	)

19 
	srsdp_des¸ùt‹
 {

20 
u64
 
	msig«tuª
;

21 
u8
 
	mchecksum
;

22 
u8
 
	m€m_id
 [6];

23 
u8
 
	mªvisi⁄
;

24 
u32
 
	mrsdt_physiˇl_addªss
;

25 
u32
 
	mÀngth
;

26 
u64
 
	mxsdt_physiˇl_addªss
;

27 
u8
 
	mexãnded_checksum
;

28 
u8
 
	mª£rved
 [3];

34 
	#ACPI_TABLE_HEADER_DEF
 \

35 
u32
 
sig«tuª
; \

36 
u32
 
Àngth
; \

37 
u8
 
ªvisi⁄
; \

38 
u8
 
checksum
; \

39 
u8
 
€m_id
 [6]; \

40 
u8
 
€m_èbÀ_id
 [8]; \

41 
u32
 
€m_ªvisi⁄
; \

42 
u8
 
a¶_compûî_id
 [4]; \

43 
u32
 
a¶_compûî_ªvisi⁄
;

	)

49 
	#FACP_SIGNATURE
 0x50434146

50 
	sÁdt_des¸ùt‹_ªv1


	)

52 
ACPI_TABLE_HEADER_DEF


53 
u32
 
	mfúmw¨e_˘æ
;

54 
u32
 
	mdsdt
;

55 
u8
 
	mmodñ
;

56 
u8
 
	mª£rved1
;

57 
u16
 
	msci_öt
;

58 
u32
 
	msmi_cmd
;

59 
u8
 
	ma˝i_íabÀ
;

60 
u8
 
	ma˝i_dißbÀ
;

61 
u8
 
	mS4bios_ªq
;

62 
u8
 
	mª£rved2
;

63 
u32
 
	mpm1a_evt_blk
;

64 
u32
 
	mpm1b_evt_blk
;

65 
u32
 
	mpm1a_˙t_blk
;

66 
u32
 
	mpm1b_˙t_blk
;

67 
u32
 
	mpm2_˙t_blk
;

68 
u32
 
	mpm_tmr_blk
;

69 
u32
 
	mg≥0_blk
;

70 
u32
 
	mg≥1_blk
;

71 
u8
 
	mpm1_evt_Àn
;

72 
u8
 
	mpm1_˙t_Àn
;

73 
u8
 
	mpm2_˙t_Àn
;

74 
u8
 
	mpm_tmr_Àn
;

75 
u8
 
	mg≥0_blk_Àn
;

76 
u8
 
	mg≥1_blk_Àn
;

77 
u8
 
	mg≥1_ba£
;

78 
u8
 
	mª£rved3
;

79 
u16
 
	m∂vl2_œt
;

80 
u16
 
	m∂vl3_œt
;

81 
u16
 
	mÊush_size
;

82 
u16
 
	mÊush_°ride
;

83 
u8
 
	mduty_off£t
;

84 
u8
 
	mduty_width
;

85 
u8
 
	mday_Ærm
;

86 
u8
 
	mm⁄_Ærm
;

87 
u8
 
	m˚¡ury
;

88 
u8
 
	mª£rved4
;

89 
u8
 
	mª£rved4a
;

90 
u8
 
	mª£rved4b
;

91 
u32
 
	mÊags
;

92 } 
	gPACKED
;

94 
	sa˝i_èbÀ_hódî


96 
	mACPI_TABLE_HEADER_DEF


97 } 
	gPACKED
;

102 
	#RSDT_SIGNATURE
 0x54445352

103 
	srsdt_des¸ùt‹_ªv1


	)

105 
ACPI_TABLE_HEADER_DEF


106 
u32
 
	mèbÀ_off£t_íåy
[0];

108 } 
	gPACKED
;

113 
	#FACS_SIGNATURE
 0x53434146

114 
	sÁcs_des¸ùt‹_ªv1


	)

116 
u32
 
	msig«tuª
;

117 
u32
 
	mÀngth
;

118 
u32
 
	mh¨dw¨e_sig«tuª
;

119 
u32
 
	mfúmw¨e_wakög_ve˘‹
;

120 
u32
 
	mglobÆ_lock
;

121 
u32
 
	mÊags
;

122 
u8
 
	mªsvîved3
 [40];

123 } 
	gPACKED
;

128 
	#DSDT_SIGNATURE
 0x54445344

129 

	)

136 
	#DUAL_PIC
 0

	)

137 
	#MULTIPLE_APIC
 1

	)

141 
	#APIC_SIGNATURE
 0x43495041

142 
	smu…ùÀ_≠ic_èbÀ


	)

144 
ACPI_TABLE_HEADER_DEF


145 
u32
 
	mloˇl_≠ic_addªss
;

146 
u32
 
	mÊags
;

147 } 
	gPACKED
;

151 
	#APIC_PROCESSOR
 0

	)

152 
	#APIC_IO
 1

	)

153 
	#APIC_XRUPT_OVERRIDE
 2

	)

154 
	#APIC_NMI
 3

	)

155 
	#APIC_LOCAL_NMI
 4

	)

156 
	#APIC_ADDRESS_OVERRIDE
 5

	)

157 
	#APIC_IO_SAPIC
 6

	)

158 
	#APIC_LOCAL_SAPIC
 7

	)

159 
	#APIC_XRUPT_SOURCE
 8

	)

160 
	#APIC_RESERVED
 9

	)

165 
	#ACPI_SUB_HEADER_DEF
 \

166 
u8
 
ty≥
; \

167 
u8
 
Àngth
;

	)

171 
	smadt_¥o˚ss‹_≠ic


173 
ACPI_SUB_HEADER_DEF


174 
u8
 
	m¥o˚ss‹_id
;

175 
u8
 
	mloˇl_≠ic_id
;

176 
u32
 
	mÊags
;

177 } 
	gPACKED
;

179 
	smadt_io_≠ic


181 
ACPI_SUB_HEADER_DEF


182 
u8
 
	mio_≠ic_id
;

183 
u8
 
	mª£rved
;

184 
u32
 
	maddªss
;

185 
u32
 
	möãºu±
;

187 } 
	gPACKED
;

189 
	smadt_öt§covr
 {

190 
ACPI_SUB_HEADER_DEF


191 
u8
 
	mbus
;

192 
u8
 
	msour˚
;

193 
u32
 
	mgsi
;

194 
u16
 
	mÊags
;

195 } 
	gPACKED
;

197 
	smadt_loˇl_nmi
 {

198 
ACPI_SUB_HEADER_DEF


199 
u8
 
	m¥o˚ss‹_id
;

200 
u16
 
	mÊags
;

201 
u8
 
	mlöt
;

202 } 
	gPACKED
;

207 
	#HPET_SIGNATURE
 0x54455048

208 
	sa˝i_20_h≥t
 {

	)

209 
ACPI_TABLE_HEADER_DEF


210 
u32
 
	mtimî_block_id
;

211 
a˝i_20_gíîic_addªss
 
	maddr
;

212 
u8
 
	mh≥t_numbî
;

213 
u16
 
	mmö_tick
;

214 
u8
 
	m∑ge_¥Ÿe˘
;

215 } 
	gPACKED
;

221 
	#SRAT_SIGNATURE
 0x54415253

222 
	ssy°em_ªsour˚_afföôy_èbÀ


	)

224 
ACPI_TABLE_HEADER_DEF


225 
u32
 
	mª£rved1
;

226 
u32
 
	mª£rved2
[2];

227 } 
	gPACKED
;

229 
	#SRAT_PROCESSOR
 0

	)

230 
	#SRAT_MEMORY
 1

	)

232 
	s§©_¥o˚ss‹_afföôy


234 
ACPI_SUB_HEADER_DEF


235 
u8
 
	m¥oximôy_lo
;

236 
u8
 
	mloˇl_≠ic_id
;

237 
u32
 
	mÊags
;

238 
u8
 
	mloˇl_ßpic_eid
;

239 
u8
 
	m¥oximôy_hi
[3];

240 
u32
 
	mª£rved
;

241 } 
	gPACKED
;

243 
	s§©_mem‹y_afföôy


245 
ACPI_SUB_HEADER_DEF


246 
u8
 
	m¥oximôy
[4];

247 
u16
 
	mª£rved1
;

248 
u64
 
	mba£_addr
;

249 
u64
 
	mønge_Àngth
;

250 
u32
 
	mª£rved2
;

251 
u32
 
	mÊags
;

252 
u32
 
	mª£rved3
[2];

253 } 
	gPACKED
;

257 
	sa˝i_mcfg_Æloˇti⁄
 {

258 
u64
 
	maddªss
;

259 
u16
 
	mpci_£gmít
;

260 
u8
 
	m°¨t_bus_numbî
;

261 
u8
 
	míd_bus_numbî
;

262 
u32
 
	mª£rved
;

263 } 
	gPACKED
;

265 
	#MCFG_SIGNATURE
 0x4746434d

266 
	sa˝i_èbÀ_mcfg
 {

	)

267 
	mACPI_TABLE_HEADER_DEF
;

268 
u8
 
	mª£rved
[8];

269 
a˝i_mcfg_Æloˇti⁄
 
	mÆloˇti⁄
[0];

270 } 
	gPACKED
;

	@std/bda.h

2 #i‚de‡
__BDA_H


3 
	#__BDA_H


	)

5 
	~"disk.h
"

6 
	~"ty≥s.h
"

13 
	srmode_IVT
 {

14 
£goff_s
 
	mivec
[256];

22 
	sbios_d©a_¨ó_s
 {

24 
u16
 
	mp‹t_com
[4];

25 
u16
 
	mp‹t_Õt
[3];

26 
u16
 
	mebda_£g
;

28 
u16
 
	mequùmít_li°_Êags
;

29 
u8
 
	m∑d1
;

30 
u16
 
	mmem_size_kb
;

31 
u8
 
	m∑d2
;

32 
u8
 
	mps2_˘æ_Êag
;

33 
u8
 
	mkbd_Êag0
;

34 
u8
 
	mkbd_Êag1
;

35 
u8
 
	mÆt_key∑d
;

36 
u16
 
	mkbd_buf_hód
;

37 
u16
 
	mkbd_buf_èû
;

39 
u8
 
	mkbd_buf
[32];

40 
u8
 
	mÊ›py_ªˇlibøti⁄_°©us
;

41 
u8
 
	mÊ›py_mŸ‹_°©us
;

43 
u8
 
	mÊ›py_mŸ‹_cou¡î
;

44 
u8
 
	mÊ›py_œ°_°©us
;

45 
u8
 
	mÊ›py_ªtu∫_°©us
[7];

46 
u8
 
	mvideo_mode
;

47 
u16
 
	mvideo_cﬁs
;

48 
u16
 
	mvideo_∑gesize
;

49 
u16
 
	mvideo_∑ge°¨t
;

51 
u16
 
	mcurs‹_pos
[8];

53 
u16
 
	mcurs‹_ty≥
;

54 
u8
 
	mvideo_∑ge
;

55 
u16
 
	m¸tc_addªss
;

56 
u8
 
	mvideo_m§
;

57 
u8
 
	mvideo_∑l
;

58 
£goff_s
 
	mjump
;

59 
u8
 
	mŸhî_6b
;

60 
u32
 
	mtimî_cou¡î
;

62 
u8
 
	mtimî_rﬁlovî
;

63 
u8
 
	mbªak_Êag
;

64 
u16
 
	mso·_ª£t_Êag
;

65 
u8
 
	mdisk_œ°_°©us
;

66 
u8
 
	mhdcou¡
;

67 
u8
 
	mdisk_c⁄åﬁ_byã
;

68 
u8
 
	mp‹t_disk
;

69 
u8
 
	mÕt_timeout
[4];

70 
u8
 
	mcom_timeout
[4];

72 
u16
 
	mkbd_buf_°¨t_off£t
;

73 
u16
 
	mkbd_buf_íd_off£t
;

74 
u8
 
	mvideo_rows
;

75 
u16
 
	mch¨_height
;

76 
u8
 
	mvideo_˘l
;

77 
u8
 
	mvideo_swôches
;

78 
u8
 
	mmode£t_˘l
;

79 
u8
 
	mdcc_ödex
;

80 
u8
 
	mÊ›py_œ°_d©a_øã
;

81 
u8
 
	mdisk_°©us_c⁄åﬁÀr
;

82 
u8
 
	mdisk_îr‹_c⁄åﬁÀr
;

83 
u8
 
	mdisk_öãºu±_Êag
;

84 
u8
 
	mÊ›py_h¨ddisk_öfo
;

86 
u8
 
	mÊ›py_medü_°©e
[4];

87 
u8
 
	mÊ›py_åack
[2];

88 
u8
 
	mkbd_Êag2
;

89 
u8
 
	mkbd_Àd
;

90 
£goff_s
 
	mu£r_waô_com∂ëe_Êag
;

91 
u32
 
	mu£r_waô_timeout
;

93 
u8
 
	mπc_waô_Êag
;

94 
u8
 
	mŸhî_a1
[7];

95 
£goff_s
 
	mvideo_ßvëabÀ
;

96 
u8
 
	mŸhî_ac
[4];

98 
u8
 
	mŸhî_b0
[9];

99 
u8
 
	mvbe_Êag
;

100 
u16
 
	mvbe_mode
;

101 
u8
 
	mŸhî_bc
[4];

103 
u8
 
	mŸhî_c0
[4*16];

104 } 
	gPACKED
;

107 
	#FRS_IRQ
 (1<<7)

	)

110 
	#RWS_WAIT_PENDING
 (1<<0)

	)

111 
	#RWS_WAIT_ELAPSED
 (1<<7)

	)

114 
	#FMS_DRIVE_STATE_MASK
 (0x07)

	)

115 
	#FMS_MEDIA_DRIVE_ESTABLISHED
 (1<<4)

	)

116 
	#FMS_DOUBLE_STEPPING
 (1<<5)

	)

117 
	#FMS_DATA_RATE_MASK
 (0xc0)

	)

120 
	#TICKS_PER_DAY
 1573040

	)

127 
	sexãnded_bios_d©a_¨ó_s
 {

128 
u8
 
	msize
;

129 
u8
 
	mª£rved1
[0x21];

130 
£goff_s
 
	mÁr_ˇŒ_poöãr
;

131 
u8
 
	mmou£_Êag1
;

132 
u8
 
	mmou£_Êag2
;

133 
u8
 
	mmou£_d©a
[0x08];

135 
u8
 
	mŸhî1
[0x0d];

138 
fd±_s
 
	mfd±
[2];

141 
u8
 
	mŸhî2
[0xC4];

144 } 
	gPACKED
;

151 
	sbios_c⁄fig_èbÀ_s
 {

152 
u16
 
	msize
;

153 
u8
 
	mmodñ
;

154 
u8
 
	msubmodñ
;

155 
u8
 
	mbio§ev
;

156 
u8
 
	m„©uª1
, 
	m„©uª2
, 
	m„©uª3
, 
	m„©uª4
, 
	m„©uª5
;

157 } 
	gPACKED
;

	@std/disk.h

2 #i‚de‡
__DISK_H


3 
	#__DISK_H


	)

5 
	~"ty≥s.h
"

7 
	#DISK_RET_SUCCESS
 0x00

	)

8 
	#DISK_RET_EPARAM
 0x01

	)

9 
	#DISK_RET_EADDRNOTFOUND
 0x02

	)

10 
	#DISK_RET_EWRITEPROTECT
 0x03

	)

11 
	#DISK_RET_ECHANGED
 0x06

	)

12 
	#DISK_RET_EBOUNDARY
 0x09

	)

13 
	#DISK_RET_EBADTRACK
 0x0c

	)

14 
	#DISK_RET_ECONTROLLER
 0x20

	)

15 
	#DISK_RET_ETIMEOUT
 0x80

	)

16 
	#DISK_RET_ENOTLOCKED
 0xb0

	)

17 
	#DISK_RET_ELOCKED
 0xb1

	)

18 
	#DISK_RET_ENOTREMOVABLE
 0xb2

	)

19 
	#DISK_RET_ETOOMANYLOCKS
 0xb4

	)

20 
	#DISK_RET_EMEDIA
 0xC0

	)

21 
	#DISK_RET_ENOTREADY
 0xAA

	)

29 
	söt13ext_s
 {

30 
u8
 
	msize
;

31 
u8
 
	mª£rved
;

32 
u16
 
	mcou¡
;

33 
£goff_s
 
	md©a
;

34 
u64
 
	mlba
;

35 } 
	gPACKED
;

38 
	sd±e_s
 {

39 
u16
 
	mioba£1
;

40 
u16
 
	mioba£2
;

41 
u8
 
	m¥efix
;

42 
u8
 
	munu£d
;

43 
u8
 
	múq
;

44 
u8
 
	mblkcou¡
;

45 
u8
 
	mdma
;

46 
u8
 
	mpio
;

47 
u16
 
	m›ti⁄s
;

48 
u16
 
	mª£rved
;

49 
u8
 
	mªvisi⁄
;

50 
u8
 
	mchecksum
;

54 
	söt13d±_s
 {

55 
u16
 
	msize
;

56 
u16
 
	möfos
;

57 
u32
 
	mcylödîs
;

58 
u32
 
	mhóds
;

59 
u32
 
	m•t
;

60 
u64
 
	m£˘‹_cou¡
;

61 
u16
 
	mblksize
;

62 
£goff_s
 
	md±e
;

63 
u16
 
	mkey
;

64 
u8
 
	mdpi_Àngth
;

65 
u8
 
	mª£rved1
;

66 
u16
 
	mª£rved2
;

67 
u8
 
	mho°_bus
[4];

68 
u8
 
	miÁ˚_ty≥
[8];

69 
u64
 
	miÁ˚_∑th
;

72 
u64
 
	mdevi˚_∑th
;

73 
u8
 
	mª£rved3
;

74 
u8
 
	mchecksum
;

75 } 
	mph€nix
;

77 
u64
 
	mdevi˚_∑th
[2];

78 
u8
 
	mª£rved3
;

79 
u8
 
	mchecksum
;

80 } 
	mt13
;

82 } 
	gPACKED
;

85 
	sfd±_s
 {

86 
u16
 
	mcylödîs
;

87 
u8
 
	mhóds
;

88 
u8
 
	ma0h_sig«tuª
;

89 
u8
 
	mphys_£˘‹s
;

90 
u16
 
	m¥ecom≥nßti⁄
;

91 
u8
 
	mª£rved
;

92 
u8
 
	mdrive_c⁄åﬁ_byã
;

93 
u16
 
	mphys_cylödîs
;

94 
u8
 
	mphys_hóds
;

95 
u16
 
	mœndög_z⁄e
;

96 
u8
 
	m£˘‹s
;

97 
u8
 
	mchecksum
;

98 } 
	gPACKED
;

101 
	sÊ›py_dbt_s
 {

102 
u8
 
	m•ecify1
;

103 
u8
 
	m•ecify2
;

104 
u8
 
	mshutoff_ticks
;

105 
u8
 
	mbps_code
;

106 
u8
 
	m£˘‹s
;

107 
u8
 
	möãrblock_Àn
;

108 
u8
 
	md©a_Àn
;

109 
u8
 
	mg≠_Àn
;

110 
u8
 
	mfûl_byã
;

111 
u8
 
	m£âÀ_time
;

112 
u8
 
	m°¨tup_time
;

113 } 
	gPACKED
;

115 
	sÊ›py_ext_dbt_s
 {

116 
Ê›py_dbt_s
 
	mdbt
;

118 
u8
 
	mmax_åack
;

119 
u8
 
	md©a_øã
;

120 
u8
 
	mdrive_ty≥
;

121 } 
	gPACKED
;

128 
	s∑cked_chs_s
 {

129 
u8
 
	mhóds
;

130 
u8
 
	m•tcyl
;

131 
u8
 
	mcyŒow
;

134 
	s∑πôi⁄_s
 {

135 
u8
 
	m°©us
;

136 
∑cked_chs_s
 
	mfú°
;

137 
u8
 
	mty≥
;

138 
∑cked_chs_s
 
	mœ°
;

139 
u32
 
	mlba
;

140 
u32
 
	mcou¡
;

141 } 
	gPACKED
;

143 
	smbr_s
 {

144 
u8
 
	mcode
[440];

146 
u32
 
	mdisk£g
;

148 
u16
 
	mnuŒ
;

150 
∑πôi⁄_s
 
	m∑πôi⁄s
[4];

152 
u16
 
	msig«tuª
;

153 } 
	gPACKED
;

155 
	#MBR_SIGNATURE
 0xØ55

	)

162 
	sñt‹ôo_s
 {

163 
u8
 
	msize
;

164 
u8
 
	mmedü
;

165 
u8
 
	memuœãd_drive
;

166 
u8
 
	mc⁄åﬁÀr_ödex
;

167 
u32
 
	mûba
;

168 
u16
 
	mdevi˚_•ec
;

169 
u16
 
	mbuf„r_£gmít
;

170 
u16
 
	mlﬂd_£gmít
;

171 
u16
 
	m£˘‹_cou¡
;

172 
u8
 
	mcylödîs
;

173 
u8
 
	m£˘‹s
;

174 
u8
 
	mhóds
;

	@std/mptable.h

1 #i‚de‡
__MPTABLE_H


2 
	#__MPTABLE_H


	)

4 
	~"ty≥s.h
"

6 
	#MPTABLE_SIGNATURE
 0x5f504d5f

7 

	)

8 
	sm±abÀ_Êﬂtög_s
 {

9 
u32
 
	msig«tuª
;

10 
u32
 
	mphyßddr
;

11 
u8
 
	mÀngth
;

12 
u8
 
	m•ec_ªv
;

13 
u8
 
	mchecksum
;

14 
u8
 
	m„©uª1
;

15 
u8
 
	m„©uª2
;

16 
u8
 
	mª£rved
[3];

19 
	#MPCONFIG_SIGNATURE
 0x504d4350

20 

	)

21 
	sm±abÀ_c⁄fig_s
 {

22 
u32
 
	msig«tuª
;

23 
u16
 
	mÀngth
;

24 
u8
 
	m•ec
;

25 
u8
 
	mchecksum
;

26 
	m€mid
[8];

27 
	m¥odu˘id
[12];

28 
u32
 
	m€m±r
;

29 
u16
 
	m€msize
;

30 
u16
 
	míåycou¡
;

31 
u32
 
	mœpic
;

32 
u16
 
	mexâabÀ_Àngth
;

33 
u8
 
	mexâabÀ_checksum
;

34 
u8
 
	mª£rved
;

35 } 
	gPACKED
;

37 
	#MPT_TYPE_CPU
 0

	)

38 
	#MPT_TYPE_BUS
 1

	)

39 
	#MPT_TYPE_IOAPIC
 2

	)

40 
	#MPT_TYPE_INTSRC
 3

	)

41 
	#MPT_TYPE_LOCAL_INT
 4

	)

43 
	sm±_˝u
 {

44 
u8
 
	mty≥
;

45 
u8
 
	m≠icid
;

46 
u8
 
	m≠icvî
;

47 
u8
 
	m˝uÊag
;

48 
u32
 
	m˝usig«tuª
;

49 
u32
 
	m„©uªÊag
;

50 
u32
 
	mª£rved
[2];

51 } 
	gPACKED
;

53 
	sm±_bus
 {

54 
u8
 
	mty≥
;

55 
u8
 
	mbusid
;

56 
	mbu°y≥
[6];

57 } 
	gPACKED
;

59 
	sm±_iﬂpic
 {

60 
u8
 
	mty≥
;

61 
u8
 
	m≠icid
;

62 
u8
 
	m≠icvî
;

63 
u8
 
	mÊags
;

64 
u32
 
	m≠iˇddr
;

65 } 
	gPACKED
;

67 
	sm±_öt§c
 {

68 
u8
 
	mty≥
;

69 
u8
 
	múqty≥
;

70 
u16
 
	múqÊag
;

71 
u8
 
	m§cbus
;

72 
u8
 
	m§cbusúq
;

73 
u8
 
	md°≠ic
;

74 
u8
 
	md°úq
;

75 } 
	gPACKED
;

	@std/optionrom.h

1 #i‚de‡
__OPTIONROMS_H


2 
	#__OPTIONROMS_H


	)

4 
	~"ty≥s.h
"

6 
	#OPTION_ROM_SIGNATURE
 0xØ55

	)

8 
	srom_hódî
 {

9 
u16
 
	msig«tuª
;

10 
u8
 
	msize
;

11 
u8
 
	möôVe˘‹
[4];

12 
u8
 
	mª£rved
[17];

13 
u16
 
	mpcioff£t
;

14 
u16
 
	m≤poff£t
;

15 } 
	gPACKED
;

17 
	#PCI_ROM_SIGNATURE
 0x52494350

18 

	)

19 
	spci_d©a
 {

20 
u32
 
	msig«tuª
;

21 
u16
 
	mvíd‹
;

22 
u16
 
	mdevi˚
;

23 
u16
 
	mvôÆd©a
;

24 
u16
 
	mdÀn
;

25 
u8
 
	mdªvisi⁄
;

26 
u8
 
	m˛ass_lo
;

27 
u16
 
	m˛ass_hi
;

28 
u16
 
	mûí
;

29 
u16
 
	múevisi⁄
;

30 
u8
 
	mty≥
;

31 
u8
 
	mödiˇt‹
;

32 
u16
 
	mª£rved
;

33 } 
	gPACKED
;

35 
	s≤p_d©a
 {

36 
u32
 
	msig«tuª
;

37 
u8
 
	mªvisi⁄
;

38 
u8
 
	mÀn
;

39 
u16
 
	m√xtoff£t
;

40 
u8
 
	mª£rved_08
;

41 
u8
 
	mchecksum
;

42 
u32
 
	mdevid
;

43 
u16
 
	mm™uÁ˘uªr
;

44 
u16
 
	m¥odu˘«me
;

45 
u8
 
	mty≥_lo
;

46 
u16
 
	mty≥_hi
;

47 
u8
 
	mdev_Êags
;

48 
u16
 
	mbcv
;

49 
u16
 
	mdv
;

50 
u16
 
	mbev
;

51 
u16
 
	mª£rved_1c
;

52 
u16
 
	m°©i¸esour˚
;

53 } 
	gPACKED
;

55 
	#OPTION_ROM_ALIGN
 2048

	)

56 
	#OPTION_ROM_INITVECTOR
 
	`off£tof
(
rom_hódî
, 
öôVe˘‹
[0])

	)

57 
	#PCIROM_CODETYPE_X86
 0

	)

	@std/pirtable.h

1 #i‚de‡
__PIRTABLE_H


2 
	#__PIRTABLE_H


	)

4 
	~"ty≥s.h
"

6 
	slök_öfo
 {

7 
u8
 
	mlök
;

8 
u16
 
	mbôm≠
;

9 } 
	gPACKED
;

11 
	spú_¶Ÿ
 {

12 
u8
 
	mbus
;

13 
u8
 
	mdev
;

14 
lök_öfo
 
	mlöks
[4];

15 
u8
 
	m¶Ÿ_ƒ
;

16 
u8
 
	mª£rved
;

17 } 
	gPACKED
;

19 
	spú_hódî
 {

20 
u32
 
	msig«tuª
;

21 
u16
 
	mvîsi⁄
;

22 
u16
 
	msize
;

23 
u8
 
	mrouãr_bus
;

24 
u8
 
	mrouãr_devfunc
;

25 
u16
 
	mex˛usive_úqs
;

26 
u32
 
	mcom∑tibÀ_devid
;

27 
u32
 
	mmöù‹t_d©a
;

28 
u8
 
	mª£rved
[11];

29 
u8
 
	mchecksum
;

30 
pú_¶Ÿ
 
	m¶Ÿs
[0];

31 } 
	gPACKED
;

33 
	#PIR_SIGNATURE
 0x52495024

34 

	)

	@std/pmm.h

1 #i‚de‡
__PMM_H


2 
	#__PMM_H


	)

4 
	~"ty≥s.h
"

6 
	#PMM_SIGNATURE
 0x4d4d5024

7 

	)

8 
	spmmhódî
 {

9 
u32
 
	msig«tuª
;

10 
u8
 
	mvîsi⁄
;

11 
u8
 
	mÀngth
;

12 
u8
 
	mchecksum
;

13 
£goff_s
 
	míåy
;

14 
u8
 
	mª£rved
[5];

15 } 
	gPACKED
;

17 
	#PMM_FUNCTION_NOT_SUPPORTED
 0xffffffff

	)

	@std/pnpbios.h

1 #i‚de‡
__PNPHEADER_H


2 
	#__PNPHEADER_H


	)

4 
	#PNP_SIGNATURE
 0x506e5024

5 

	)

6 
	s≤phódî
 {

7 
u32
 
	msig«tuª
;

8 
u8
 
	mvîsi⁄
;

9 
u8
 
	mÀngth
;

10 
u16
 
	mc⁄åﬁ
;

11 
u8
 
	mchecksum
;

12 
u32
 
	mevíéoc
;

13 
u16
 
	mªÆ_ù
;

14 
u16
 
	mªÆ_cs
;

15 
u16
 
	m¥Ÿ_ù
;

16 
u32
 
	m¥Ÿ_ba£
;

17 
u32
 
	m€mid
;

18 
u16
 
	mªÆ_ds
;

19 
u32
 
	m¥Ÿ_d©aba£
;

20 } 
	gPACKED
;

22 
	#FUNCTION_NOT_SUPPORTED
 0x82

	)

	@std/smbios.h

1 #i‚de‡
__SMBIOS_H


2 
	#__SMBIOS_H


	)

4 
	~"ty≥s.h
"

9 
	ssmbios_íåy_poöt
 {

10 
	m™ch‹_°rög
[4];

11 
u8
 
	mchecksum
;

12 
u8
 
	mÀngth
;

13 
u8
 
	msmbios_maj‹_vîsi⁄
;

14 
u8
 
	msmbios_mö‹_vîsi⁄
;

15 
u16
 
	mmax_°ru˘uª_size
;

16 
u8
 
	míåy_poöt_ªvisi⁄
;

17 
u8
 
	mf‹m©ãd_¨ó
[5];

18 
	möãrmedüã_™ch‹_°rög
[5];

19 
u8
 
	möãrmedüã_checksum
;

20 
u16
 
	m°ru˘uª_èbÀ_Àngth
;

21 
u32
 
	m°ru˘uª_èbÀ_addªss
;

22 
u16
 
	mnumbî_of_°ru˘uªs
;

23 
u8
 
	msmbios_bcd_ªvisi⁄
;

24 } 
	gPACKED
;

27 
	ssmbios_°ru˘uª_hódî
 {

28 
u8
 
	mty≥
;

29 
u8
 
	mÀngth
;

30 
u16
 
	mh™dÀ
;

31 } 
	gPACKED
;

34 
	ssmbios_ty≥_0
 {

35 
smbios_°ru˘uª_hódî
 
	mhódî
;

36 
u8
 
	mvíd‹_°r
;

37 
u8
 
	mbios_vîsi⁄_°r
;

38 
u16
 
	mbios_°¨tög_addªss_£gmít
;

39 
u8
 
	mbios_ªÀa£_d©e_°r
;

40 
u8
 
	mbios_rom_size
;

41 
u8
 
	mbios_ch¨a˘îi°ics
[8];

42 
u8
 
	mbios_ch¨a˘îi°ics_exãnsi⁄_byãs
[2];

43 
u8
 
	msy°em_bios_maj‹_ªÀa£
;

44 
u8
 
	msy°em_bios_mö‹_ªÀa£
;

45 
u8
 
	membedded_c⁄åﬁÀr_maj‹_ªÀa£
;

46 
u8
 
	membedded_c⁄åﬁÀr_mö‹_ªÀa£
;

47 } 
	gPACKED
;

50 
	ssmbios_ty≥_1
 {

51 
smbios_°ru˘uª_hódî
 
	mhódî
;

52 
u8
 
	mm™uÁ˘uªr_°r
;

53 
u8
 
	m¥odu˘_«me_°r
;

54 
u8
 
	mvîsi⁄_°r
;

55 
u8
 
	m£rül_numbî_°r
;

56 
u8
 
	muuid
[16];

57 
u8
 
	mwake_up_ty≥
;

58 
u8
 
	msku_numbî_°r
;

59 
u8
 
	mÁmûy_°r
;

60 } 
	gPACKED
;

63 
	ssmbios_ty≥_3
 {

64 
smbios_°ru˘uª_hódî
 
	mhódî
;

65 
u8
 
	mm™uÁ˘uªr_°r
;

66 
u8
 
	mty≥
;

67 
u8
 
	mvîsi⁄_°r
;

68 
u8
 
	m£rül_numbî_°r
;

69 
u8
 
	mas£t_èg_numbî_°r
;

70 
u8
 
	mboŸ_up_°©e
;

71 
u8
 
	mpowî_suµly_°©e
;

72 
u8
 
	mthîmÆ_°©e
;

73 
u8
 
	m£curôy_°©us
;

74 
u32
 
	m€m_deföed
;

75 
u8
 
	mheight
;

76 
u8
 
	mnumbî_of_powî_c‹ds
;

77 
u8
 
	mc⁄èöed_ñemít_cou¡
;

79 } 
	gPACKED
;

82 
	ssmbios_ty≥_4
 {

83 
smbios_°ru˘uª_hódî
 
	mhódî
;

84 
u8
 
	msockë_desig«ti⁄_°r
;

85 
u8
 
	m¥o˚ss‹_ty≥
;

86 
u8
 
	m¥o˚ss‹_Ámûy
;

87 
u8
 
	m¥o˚ss‹_m™uÁ˘uªr_°r
;

88 
u32
 
	m¥o˚ss‹_id
[2];

89 
u8
 
	m¥o˚ss‹_vîsi⁄_°r
;

90 
u8
 
	mvﬁège
;

91 
u16
 
	mexã∫Æ_˛ock
;

92 
u16
 
	mmax_•ìd
;

93 
u16
 
	mcuºít_•ìd
;

94 
u8
 
	m°©us
;

95 
u8
 
	m¥o˚ss‹_upgøde
;

96 
u16
 
	ml1_ˇche_h™dÀ
;

97 
u16
 
	ml2_ˇche_h™dÀ
;

98 
u16
 
	ml3_ˇche_h™dÀ
;

99 } 
	gPACKED
;

104 
	ssmbios_ty≥_16
 {

105 
smbios_°ru˘uª_hódî
 
	mhódî
;

106 
u8
 
	mloˇti⁄
;

107 
u8
 
	mu£
;

108 
u8
 
	mîr‹_c‹ª˘i⁄
;

109 
u32
 
	mmaximum_ˇ∑côy
;

110 
u16
 
	mmem‹y_îr‹_öf‹m©i⁄_h™dÀ
;

111 
u16
 
	mnumbî_of_mem‹y_devi˚s
;

112 } 
	gPACKED
;

117 
	ssmbios_ty≥_17
 {

118 
smbios_°ru˘uª_hódî
 
	mhódî
;

119 
u16
 
	mphysiˇl_mem‹y_¨øy_h™dÀ
;

120 
u16
 
	mmem‹y_îr‹_öf‹m©i⁄_h™dÀ
;

121 
u16
 
	mtŸÆ_width
;

122 
u16
 
	md©a_width
;

123 
u16
 
	msize
;

124 
u8
 
	mf‹m_Á˘‹
;

125 
u8
 
	mdevi˚_£t
;

126 
u8
 
	mdevi˚_loˇt‹_°r
;

127 
u8
 
	mb™k_loˇt‹_°r
;

128 
u8
 
	mmem‹y_ty≥
;

129 
u16
 
	mty≥_dëaû
;

130 } 
	gPACKED
;

133 
	ssmbios_ty≥_19
 {

134 
smbios_°ru˘uª_hódî
 
	mhódî
;

135 
u32
 
	m°¨tög_addªss
;

136 
u32
 
	mídög_addªss
;

137 
u16
 
	mmem‹y_¨øy_h™dÀ
;

138 
u8
 
	m∑πôi⁄_width
;

139 } 
	gPACKED
;

142 
	ssmbios_ty≥_20
 {

143 
smbios_°ru˘uª_hódî
 
	mhódî
;

144 
u32
 
	m°¨tög_addªss
;

145 
u32
 
	mídög_addªss
;

146 
u16
 
	mmem‹y_devi˚_h™dÀ
;

147 
u16
 
	mmem‹y_¨øy_m≠≥d_addªss_h™dÀ
;

148 
u8
 
	m∑πôi⁄_row_posôi⁄
;

149 
u8
 
	möãæóve_posôi⁄
;

150 
u8
 
	möãæóved_d©a_dïth
;

151 } 
	gPACKED
;

154 
	ssmbios_ty≥_32
 {

155 
smbios_°ru˘uª_hódî
 
	mhódî
;

156 
u8
 
	mª£rved
[6];

157 
u8
 
	mboŸ_°©us
;

158 } 
	gPACKED
;

161 
	ssmbios_ty≥_127
 {

162 
smbios_°ru˘uª_hódî
 
	mhódî
;

163 } 
	gPACKED
;

	@std/vbe.h

1 #i‚de‡
__VBE_H


2 
	#__VBE_H


	)

4 
	~"ty≥s.h
"

6 
	#VESA_SIGNATURE
 0x41534556

7 
	#VBE2_SIGNATURE
 0x32454256

8 

	)

9 
	svbe_öfo
 {

10 
u32
 
	msig«tuª
;

11 
u16
 
	mvîsi⁄
;

12 
£goff_s
 
	m€m_°rög
;

13 
u32
 
	mˇ∑bûôõs
;

14 
£goff_s
 
	mvideo_mode
;

15 
u16
 
	mtŸÆ_mem‹y
;

16 
u16
 
	m€m_ªvisi⁄
;

17 
£goff_s
 
	m€m_víd‹_°rög
;

18 
£goff_s
 
	m€m_¥odu˘_°rög
;

19 
£goff_s
 
	m€m_ªvisi⁄_°rög
;

20 
u8
 
	mª£rved
[222];

21 } 
	gPACKED
;

23 
	svbe_mode_öfo
 {

25 
u16
 
	mmode_©åibuãs
;

26 
u8
 
	mwöA_©åibuãs
;

27 
u8
 
	mwöB_©åibuãs
;

28 
u16
 
	mwö_gønuœrôy
;

29 
u16
 
	mwö_size
;

30 
u16
 
	mwöA_£g
;

31 
u16
 
	mwöB_£g
;

32 
£goff_s
 
	mwö_func_±r
;

33 
u16
 
	mbyãs_≥r_sˇ∆öe
;

35 
u16
 
	mxªs
;

36 
u16
 
	myªs
;

37 
u8
 
	mxch¨size
;

38 
u8
 
	mych¨size
;

39 
u8
 
	m∂™es
;

40 
u8
 
	mbôs_≥r_pixñ
;

41 
u8
 
	mb™ks
;

42 
u8
 
	mmem_modñ
;

43 
u8
 
	mb™k_size
;

44 
u8
 
	m∑ges
;

45 
u8
 
	mª£rved0
;

47 
u8
 
	mªd_size
;

48 
u8
 
	mªd_pos
;

49 
u8
 
	mgªí_size
;

50 
u8
 
	mgªí_pos
;

51 
u8
 
	mblue_size
;

52 
u8
 
	mblue_pos
;

53 
u8
 
	mÆpha_size
;

54 
u8
 
	mÆpha_pos
;

55 
u8
 
	mdúe˘cﬁ‹_öfo
;

57 
u32
 
	mphys_ba£
;

58 
u32
 
	mª£rved1
;

59 
u16
 
	mª£rved2
;

61 
u16
 
	mlöór_byãs_≥r_sˇ∆öe
;

62 
u8
 
	mb™k_∑ges
;

63 
u8
 
	mlöór_∑ges
;

64 
u8
 
	mlöór_ªd_size
;

65 
u8
 
	mlöór_ªd_pos
;

66 
u8
 
	mlöór_gªí_size
;

67 
u8
 
	mlöór_gªí_pos
;

68 
u8
 
	mlöór_blue_size
;

69 
u8
 
	mlöór_blue_pos
;

70 
u8
 
	mlöór_Æpha_size
;

71 
u8
 
	mlöór_Æpha_pos
;

72 
u32
 
	mpix˛ock_max
;

73 
u8
 
	mª£rved
[190];

74 } 
	gPACKED
;

76 
	svbe_¸tc_öfo
 {

77 
u16
 
	mh‹iz_tŸÆ
;

78 
u16
 
	mh‹iz_sync_°¨t
;

79 
u16
 
	mh‹iz_sync_íd
;

80 
u16
 
	mvît_tŸÆ
;

81 
u16
 
	mvît_sync_°¨t
;

82 
u16
 
	mvît_sync_íd
;

83 
u8
 
	mÊags
;

84 
u32
 
	mpix˛ock
;

85 
u16
 
	mª‰esh_øã
;

86 
u8
 
	mª£rved
[40];

87 } 
	gPACKED
;

91 
	#VBE_RETURN_STATUS_SUPPORTED
 0x4F

	)

92 
	#VBE_RETURN_STATUS_UNSUPPORTED
 0x00

	)

94 
	#VBE_RETURN_STATUS_SUCCESSFULL
 0x00

	)

95 
	#VBE_RETURN_STATUS_FAILED
 0x01

	)

96 
	#VBE_RETURN_STATUS_NOT_SUPPORTED
 0x02

	)

97 
	#VBE_RETURN_STATUS_INVALID
 0x03

	)

101 
	#VBE_MODE_VESA_DEFINED
 0x0100

	)

102 
	#VBE_MODE_REFRESH_RATE_USE_CRTC
 0x0800

	)

103 
	#VBE_MODE_LINEAR_FRAME_BUFFER
 0x4000

	)

104 
	#VBE_MODE_PRESERVE_DISPLAY_MEMORY
 0x8000

	)

106 
	#VBE_VESA_MODE_END_OF_LIST
 0xFFFF

	)

110 
	#VBE_CAPABILITY_8BIT_DAC
 0x0001

	)

111 
	#VBE_CAPABILITY_NOT_VGA_COMPATIBLE
 0x0002

	)

112 
	#VBE_CAPABILITY_RAMDAC_USE_BLANK_BIT
 0x0004

	)

113 
	#VBE_CAPABILITY_STEREOSCOPIC_SUPPORT
 0x0008

	)

114 
	#VBE_CAPABILITY_STEREO_VIA_VESA_EVC
 0x0010

	)

118 
	#VBE_MODE_ATTRIBUTE_SUPPORTED
 0x0001

	)

119 
	#VBE_MODE_ATTRIBUTE_EXTENDED_INFORMATION_AVAILABLE
 0x0002

	)

120 
	#VBE_MODE_ATTRIBUTE_TTY_BIOS_SUPPORT
 0x0004

	)

121 
	#VBE_MODE_ATTRIBUTE_COLOR_MODE
 0x0008

	)

122 
	#VBE_MODE_ATTRIBUTE_GRAPHICS_MODE
 0x0010

	)

123 
	#VBE_MODE_ATTRIBUTE_NOT_VGA_COMPATIBLE
 0x0020

	)

124 
	#VBE_MODE_ATTRIBUTE_NO_VGA_COMPATIBLE_WINDOW
 0x0040

	)

125 
	#VBE_MODE_ATTRIBUTE_LINEAR_FRAME_BUFFER_MODE
 0x0080

	)

126 
	#VBE_MODE_ATTRIBUTE_DOUBLE_SCAN_MODE
 0x0100

	)

127 
	#VBE_MODE_ATTRIBUTE_INTERLACE_MODE
 0x0200

	)

128 
	#VBE_MODE_ATTRIBUTE_HARDWARE_TRIPLE_BUFFER
 0x0400

	)

129 
	#VBE_MODE_ATTRIBUTE_HARDWARE_STEREOSCOPIC_DISPLAY
 0x0800

	)

130 
	#VBE_MODE_ATTRIBUTE_DUAL_DISPLAY_START_ADDRESS
 0x1000

	)

132 
	#VBE_MODE_ATTTRIBUTE_LFB_ONLY
 ( 
VBE_MODE_ATTRIBUTE_NO_VGA_COMPATIBLE_WINDOW
 | 
VBE_MODE_ATTRIBUTE_LINEAR_FRAME_BUFFER_MODE
 )

	)

136 
	#VBE_WINDOW_ATTRIBUTE_RELOCATABLE
 0x01

	)

137 
	#VBE_WINDOW_ATTRIBUTE_READABLE
 0x02

	)

138 
	#VBE_WINDOW_ATTRIBUTE_WRITEABLE
 0x04

	)

142 
	#VBE_MEMORYMODEL_TEXT_MODE
 0x00

	)

143 
	#VBE_MEMORYMODEL_CGA_GRAPHICS
 0x01

	)

144 
	#VBE_MEMORYMODEL_HERCULES_GRAPHICS
 0x02

	)

145 
	#VBE_MEMORYMODEL_PLANAR
 0x03

	)

146 
	#VBE_MEMORYMODEL_PACKED_PIXEL
 0x04

	)

147 
	#VBE_MEMORYMODEL_NON_CHAIN_4_256
 0x05

	)

148 
	#VBE_MEMORYMODEL_DIRECT_COLOR
 0x06

	)

149 
	#VBE_MEMORYMODEL_YUV
 0x07

	)

153 
	#VBE_DIRECTCOLOR_COLOR_RAMP_PROGRAMMABLE
 0x01

	)

154 
	#VBE_DIRECTCOLOR_RESERVED_BITS_AVAILABLE
 0x02

	)

	@stdbool.h

15 #i‚de‡
__SEABIOS_STDBOOL_H


16 
	#__SEABIOS_STDBOOL_H


	)

18 
	tboﬁ
;

19 
	#åue
 1

	)

20 
	#Ál£
 0

	)

	@stdint.h

15 #i‚de‡
__SEABIOS_STDINT_H


16 
	#__SEABIOS_STDINT_H


	)

18 
	~"ty≥s.h
"

22 
u8
 
	tuöt8_t
;

23 
s8
 
	töt8_t
;

25 
u16
 
	tuöt16_t
;

26 
s16
 
	töt16_t
;

28 
u32
 
	tuöt32_t
;

29 
s32
 
	töt32_t
;

31 
u64
 
	tuöt64_t
;

32 
s64
 
	töt64_t
;

	@string.c

8 
	~"°acks.h
"

9 
	~"°rög.h
"

10 
	~"ÁΩå.h
"

18 
u8


19 
	$checksum_Ár
(
u16
 
buf_£g
, *
buf_Ár
, 
u32
 
Àn
)

21 
	`SET_SEG
(
ES
, 
buf_£g
);

22 
u32
 
i
;

23 
u8
 
sum
 = 0;

24 
i
=0; i<
Àn
; i++)

25 
sum
 +
	`GET_VAR
(
ES
, ((
u8
*)
buf_Ár
)[
i
]);

26  
sum
;

27 
	}
}

29 
u8


30 
	$checksum
(*
buf
, 
u32
 
Àn
)

32  
	`checksum_Ár
(
	`GET_SEG
(
SS
), 
buf
, 
Àn
);

33 
	}
}

35 
size_t


36 
	$°æí
(c⁄° *
s
)

38 i‡(
	`__buûtö_c⁄°™t_p
(
s
))

39  
	`__buûtö_°æí
(
s
);

40 c⁄° *
p
 = 
s
;

41 *
p
)

42 
p
++;

43  
p
-
s
;

44 
	}
}

48 
	$memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
n
)

50 
n
) {

51 i‡(*(
u8
*)
s1
 !*(u8*)
s2
)

52  *(
u8
*)
s1
 < *(u8*)
s2
 ? -1 : 1;

53 
s1
++;

54 
s2
++;

55 
n
--;

58 
	}
}

62 
	$°rcmp
(c⁄° *
s1
, c⁄° *
s2
)

65 i‡(*
s1
 !*
s2
)

66  *
s1
 < *
s2
 ? -1 : 1;

67 i‡(! *
s1
)

69 
s1
++;

70 
s2
++;

72 
	}
}

74 
ölöe
 

75 
	$mem£t_Ár
(
u16
 
d_£g
, *
d_Ár
, 
u8
 
c
, 
size_t
 
Àn
)

77 
	`SET_SEG
(
ES
, 
d_£g
);

78 
asm
 volatile(

80 : "+c"(
Àn
), "+D"(
d_Ár
)

81 : "a"(
c
), "m" (
__£gmít_ES
)

83 
	}
}

85 
ölöe
 

86 
	$mem£t16_Ár
(
u16
 
d_£g
, *
d_Ár
, u16 
c
, 
size_t
 
Àn
)

88 
Àn
 /= 2;

89 
	`SET_SEG
(
ES
, 
d_£g
);

90 
asm
 volatile(

92 : "+c"(
Àn
), "+D"(
d_Ár
)

93 : "a"(
c
), "m" (
__£gmít_ES
)

95 
	}
}

98 
	$mem£t
(*
s
, 
c
, 
size_t
 
n
)

100 
n
)

101 ((*)
s
)[--
n
] = 
c
;

102  
s
;

103 
	}
}

105 
	$mem£t_Ê
(*
±r
, 
u8
 
vÆ
, 
size_t
 
size
)

107 i‡(
MODESEGMENT
)

108 
	`mem£t_Ár
(
	`FLATPTR_TO_SEG
(
±r
), (*)(
	`FLATPTR_TO_OFFSET
(ptr)),

109 
vÆ
, 
size
);

111 
	`mem£t
(
±r
, 
vÆ
, 
size
);

112 
	}
}

114 
ölöe
 

115 
	$mem˝y_Ár
(
u16
 
d_£g
, *
d_Ár
, u16 
s_£g
, c⁄° *
s_Ár
, 
size_t
 
Àn
)

117 
	`SET_SEG
(
ES
, 
d_£g
);

118 
u16
 
bkup_ds
;

119 
asm
 volatile(

124 : "=&r"(
bkup_ds
), "+c"(
Àn
), "+S"(
s_Ár
), "+D"(
d_Ár
)

125 : "r"(
s_£g
), "m" (
__£gmít_ES
)

127 
	}
}

129 
ölöe
 

130 
	$mem˝y_Ê
(*
d_Ê
, c⁄° *
s_Ê
, 
size_t
 
Àn
)

132 i‡(
MODESEGMENT
)

133 
	`mem˝y_Ár
(
	`FLATPTR_TO_SEG
(
d_Ê
), (*)
	`FLATPTR_TO_OFFSET
(d_fl)

134 , 
	`FLATPTR_TO_SEG
(
s_Ê
), (*)
	`FLATPTR_TO_OFFSET
(s_fl)

135 , 
Àn
);

137 
	`mem˝y
(
d_Ê
, 
s_Ê
, 
Àn
);

138 
	}
}

141 #unde‡
mem˝y


142 
	$mem˝y
(*
d1
, c⁄° *
s1
, 
size_t
 
Àn
)

143 #i‡
MODESEGMENT
 == 0

144 
	#mem˝y
 
__buûtö_mem˝y


	)

147 
	`SET_SEG
(
ES
, 
	`GET_SEG
(
SS
));

148 *
d
 = 
d1
;

149 i‡(((
u32
)
d1
 | (u32)
s1
 | 
Àn
) & 3) {

151 
asm
 volatile(

153 : "+c"(
Àn
), "+S"(
s1
), "+D"(
d
)

154 : "m" (
__£gmít_ES
) : "cc", "memory");

155  
d1
;

158 
Àn
 /= 4;

159 
asm
 volatile(

161 : "+c"(
Àn
), "+S"(
s1
), "+D"(
d
)

162 : "m" (
__£gmít_ES
) : "cc", "memory");

163  
d1
;

164 
	}
}

169 
	$iomem˝y
(*
d
, c⁄° *
s
, 
u32
 
Àn
)

171 
	`ASSERT32FLAT
();

172 
	`yõld
();

173 
Àn
 > 3) {

174 
u32
 
c›yÀn
 = 
Àn
;

175 i‡(
c›yÀn
 > 2048)

176 
c›yÀn
 = 2048;

177 
c›yÀn
 /= 4;

178 
Àn
 -
c›yÀn
 * 4;

179 
asm
 volatile(

181 : "+c"(
c›yÀn
), "+S"(
s
), "+D"(
d
)

183 
	`yõld
();

185 i‡(
Àn
)

187 
	`mem˝y
(
d
, 
s
, 
Àn
);

188 
	}
}

191 
	$memmove
(*
d
, c⁄° *
s
, 
size_t
 
Àn
)

193 i‡(
s
 >
d
)

194  
	`mem˝y
(
d
, 
s
, 
Àn
);

196 
d
 +
Àn
-1;

197 
s
 +
Àn
-1;

198 
Àn
--) {

199 *(*)
d
 = *(*)
s
;

200 
d
--;

201 
s
--;

204  
d
;

205 
	}
}

209 
	$°π˝y
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

211 *
d
 = 
de°
;

212 --
Àn
 && *
§c
 != '\0')

213 *
d
++ = *
§c
++;

214 *
d
 = '\0';

215  
de°
;

216 
	}
}

220 
	$°rchr
(c⁄° *
s
, 
c
)

222 ; *
s
; s++)

223 i‡(*
s
 =
c
)

224  (*)
s
;

225  
NULL
;

226 
	}
}

230 
	$nuŒTøûögS∑˚
(*
buf
)

232 
Àn
 = 
	`°æí
(
buf
);

233 *
íd
 = &
buf
[
Àn
-1];

234 
íd
 >
buf
 && *end <= ' ')

235 *(
íd
--) = '\0';

236 *
buf
 && *buf <= ' ')

237 
buf
++;

238  
buf
;

239 
	}
}

241 
ölöe
 
	$isuµî
(
c
)

243  (
c
 >= 'A' && c <= 'Z');

244 
	}
}

246 
ölöe
 
	$tﬁowî
(
c
)

248 i‡(
	`isuµî
(
c
))

249 
c
 -= 'A'-'a';

250  
c
;

251 
	}
}

253 
	$°∫icmp
(c⁄° *
s1
, c⁄° *
s2
, 
maxÀn
)

255 
i
;

257 
i
 = 0; i < 
maxÀn
; i++) {

258 i‡(
	`tﬁowî
(
s1
[
i
]Ë!tﬁowî(
s2
[i]))

259  (
	`tﬁowî
(
s1
[
i
]Ë-Åﬁowî(
s2
[i]));

263 
	}
}

265 
	$is•a˚
(
c
)

267  (
c
 == ' ' || (c >= '\t' && c <= '\r'));

268 
	}
}

272 
	$_vÆid
(
ch
, 
ba£
)

274 
íd
 = (
ba£
 > 9) ? '9' : '0' + (base - 1);

278 i‡(
ch
 >'0' && ch <
íd
)

283 i‡(
ba£
 > 11) {

284 i‡(
	`tﬁowî
(
ch
) >= 'a' &&

285 
	`tﬁowî
(
ch
Ë<'a' + (
ba£
 - 11))

290 
	}
}

294 
	$_off£t
(
ch
, 
ba£
)

296 i‡(
ch
 >= '0' && ch <= '9')

297  
ch
 - '0';

299  10 + 
	`tﬁowî
(
ch
) - 'a';

300 
	}
}

308 
	$°πﬁ
(c⁄° *
±r
, **
íd±r
, 
ba£
)

310 
ªt
 = 0;

311 
√g©ive
 = 1;

313 i‡(
íd±r
 !
NULL
)

314 *
íd±r
 = (*Ë
±r
;

318  ; *
±r
 && 
	`is•a˚
(*ptr);Ötr++);

320 i‡(
±r
[0] == '-') {

321 
√g©ive
 = -1;

322 
±r
++;

325 i‡(!*
±r
)

330 i‡(
ba£
 == 0) {

331 i‡(
±r
[0] == '0' && (ptr[1] == 'x' ||Ötr[1] == 'X'))

332 
ba£
 = 16;

333 i‡(
±r
[0] == '0') {

334 
ba£
 = 8;

335 
±r
++;

338 
ba£
 = 10;

343 i‡(
ba£
 == 16) {

344 i‡(
±r
[0] == '0' && (ptr[1] == 'x' ||Ötr[1] == 'X'))

345 
±r
 += 2;

350 i‡(!*
±r
 || !
	`_vÆid
(*±r, 
ba£
))

353  ; *
±r
 && 
	`_vÆid
(*±r, 
ba£
);Ötr++)

354 
ªt
 = (ªà* 
ba£
Ë+ 
	`_off£t
(*
±r
, base);

356 i‡(
íd±r
 !
NULL
)

357 *
íd±r
 = (*Ë
±r
;

359  
ªt
 * 
√g©ive
;

360 
	}
}

370 *
	$°r°r
(c⁄° *
h
, c⁄° *
n
)

372 
hn
 = 
	`°æí
(
h
);

373 
¬
 = 
	`°æí
(
n
);

374 
i
;

376 
i
 = 0; i <
hn
 - 
¬
; i++)

377 i‡(!
	`memcmp
(&
h
[
i
], 
n
, 
¬
))

378  (*)&
h
[
i
];

380  
NULL
;

381 
	}
}

	@string.h

2 #i‚de‡
__STRING_H


3 
	#__STRING_H


	)

5 
	~"ty≥s.h
"

8 
u8
 
checksum_Ár
(
u16
 
buf_£g
, *
buf_Ár
, 
u32
 
Àn
);

9 
u8
 
checksum
(*
buf
, 
u32
 
Àn
);

10 
size_t
 
°æí
(c⁄° *
s
);

11 
memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
n
);

12 
°rcmp
(c⁄° *
s1
, c⁄° *
s2
);

13 
°∫icmp
(c⁄° *
s1
, c⁄° *
s2
, 
maxÀn
);

14 
ölöe
 
mem£t_Ár
(
u16
 
d_£g
, *
d_Ár
, 
u8
 
c
, 
size_t
 
Àn
);

15 
ölöe
 
mem£t16_Ár
(
u16
 
d_£g
, *
d_Ár
, u16 
c
, 
size_t
 
Àn
);

16 *
mem£t
(*
s
, 
c
, 
size_t
 
n
);

17 
mem£t_Ê
(*
±r
, 
u8
 
vÆ
, 
size_t
 
size
);

18 
ölöe
 
mem˝y_Ár
(
u16
 
d_£g
, *
d_Ár


19 , 
u16
 
s_£g
, c⁄° *
s_Ár
, 
size_t
 
Àn
);

20 
mem˝y_Ê
(*
d_Ê
, c⁄° *
s_Ê
, 
size_t
 
Àn
);

21 *
mem˝y
(*
d1
, c⁄° *
s1
, 
size_t
 
Àn
);

22 #i‡
MODESEGMENT
 == 0

23 
	#mem˝y
 
__buûtö_mem˝y


	)

25 
iomem˝y
(*
d
, c⁄° *
s
, 
u32
 
Àn
);

26 *
memmove
(*
d
, c⁄° *
s
, 
size_t
 
Àn
);

27 *
°π˝y
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
);

28 *
°rchr
(c⁄° *
s
, 
c
);

29 *
nuŒTøûögS∑˚
(*
buf
);

30 
°πﬁ
(c⁄° *
±r
, **
íd±r
, 
ba£
);

31 *
°r°r
(c⁄° *
h
, c⁄° *
n
);

	@system.c

8 
	~"biosv¨.h
"

9 
	~"bªgs.h
"

10 
	~"hw/pic.h
"

11 
	~"hw/ps2p‹t.h
"

12 
	~"mÆloc.h
"

13 
	~"memm≠.h
"

14 
	~"ouçut.h
"

15 
	~"°rög.h
"

16 
	~"utû.h
"

17 
	~"x86.h
"

20 
ölöe
 
u8


21 
	$£t_a20
(
u8
 
c⁄d
)

24 
u8
 
√wvÆ
, 
ﬁdvÆ
 = 
	`öb
(
PORT_A20
);

25 i‡(
c⁄d
)

26 
√wvÆ
 = 
ﬁdvÆ
 | 
A20_ENABLE_BIT
;

28 
√wvÆ
 = 
ﬁdvÆ
 & ~
A20_ENABLE_BIT
;

29 
	`outb
(
√wvÆ
, 
PORT_A20
);

31  (
ﬁdvÆ
 & 
A20_ENABLE_BIT
) != 0;

32 
	}
}

35 
	$h™dÀ_152400
(
bªgs
 *
ªgs
)

37 
	`£t_a20
(0);

38 
	`£t_code_suc˚ss
(
ªgs
);

39 
	}
}

42 
	$h™dÀ_152401
(
bªgs
 *
ªgs
)

44 
	`£t_a20
(1);

45 
	`£t_code_suc˚ss
(
ªgs
);

46 
	}
}

49 
	$h™dÀ_152402
(
bªgs
 *
ªgs
)

51 
ªgs
->
Æ
 = (
	`öb
(
PORT_A20
Ë& 
A20_ENABLE_BIT
) != 0;

52 
	`£t_code_suc˚ss
(
ªgs
);

53 
	}
}

56 
	$h™dÀ_152403
(
bªgs
 *
ªgs
)

58 
ªgs
->
bx
 = 3;

59 
	`£t_code_suc˚ss
(
ªgs
);

60 
	}
}

63 
	$h™dÀ_1524XX
(
bªgs
 *
ªgs
)

65 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

66 
	}
}

69 
	$h™dÀ_1524
(
bªgs
 *
ªgs
)

71 
ªgs
->
Æ
) {

72 0x00: 
	`h™dÀ_152400
(
ªgs
); ;

73 0x01: 
	`h™dÀ_152401
(
ªgs
); ;

74 0x02: 
	`h™dÀ_152402
(
ªgs
); ;

75 0x03: 
	`h™dÀ_152403
(
ªgs
); ;

76 : 
	`h™dÀ_1524XX
(
ªgs
); ;

78 
	}
}

82 
	$h™dÀ_1552
(
bªgs
 *
ªgs
)

84 
	`£t_code_suc˚ss
(
ªgs
);

85 
	}
}

88 
	$h™dÀ_1587
(
bªgs
 *
ªgs
)

93 
u8
 
¥ev_a20_íabÀ
 = 
	`£t_a20
(1);

111 
u32
 
si
 = 
ªgs
->si;

112 
u64
 *
gdt_Ár
 = (*)
si
;

113 
u16
 
gdt_£g
 = 
ªgs
->
es
;

114 
u32
 
loc
 = (u32)
	`MAKE_FLATPTR
(
gdt_£g
, 
gdt_Ár
);

115 
	`SET_FARVAR
(
gdt_£g
, 
gdt_Ár
[1], 
GDT_DATA
 | 
	`GDT_LIMIT
((6*(
u64
))-1)

116 | 
	`GDT_BASE
(
loc
));

118 
	`SET_FARVAR
(
gdt_£g
, 
gdt_Ár
[4], 
GDT_CODE
 | 
	`GDT_LIMIT
(
BUILD_BIOS_SIZE
-1)

119 | 
	`GDT_BASE
(
BUILD_BIOS_ADDR
));

121 
loc
 = (
u32
)
	`MAKE_FLATPTR
(
	`GET_SEG
(
SS
), 0);

122 
	`SET_FARVAR
(
gdt_£g
, 
gdt_Ár
[5], 
GDT_DATA
 | 
	`GDT_LIMIT
(0x0ffff)

123 | 
	`GDT_BASE
(
loc
));

125 
u16
 
cou¡
 = 
ªgs
->
cx
;

126 
asm
 volatile(

133 " oæ $" 
	`__°rögify
(
CR0_PE
) ", %%eax\n"

157 "ánd»$~" 
	`__°rögify
(
CR0_PE
) ", %%eax\n"

161 "Üjmpw $" 
	`__°rögify
(
SEG_BIOS
) ", $2f\n"

169 : "+c"(
cou¡
), "+S"(
si
), "+m" (
__£gmít_ES
)

172 
	`£t_a20
(
¥ev_a20_íabÀ
);

174 
	`£t_code_suc˚ss
(
ªgs
);

175 
	}
}

179 
	$h™dÀ_1588
(
bªgs
 *
ªgs
)

181 
u32
 
rs
 = 
	`GET_GLOBAL
(
LegacyRamSize
);

185 i‡(
rs
 > 64*1024*1024)

186 
ªgs
->
ax
 = 63 * 1024;

188 
ªgs
->
ax
 = (
rs
 - 1*1024*1024) / 1024;

189 
	`£t_suc˚ss
(
ªgs
);

190 
	}
}

194 
	$h™dÀ_1589
(
bªgs
 *
ªgs
)

196 
	`£t_a20
(1);

198 
	`pic_ª£t
(
ªgs
->
bl
,Ñegs->
bh
);

200 
u64
 *
gdt_Ár
 = (*)(
ªgs
->
si
 + 0);

201 
u16
 
gdt_£g
 = 
ªgs
->
es
;

202 
	`SET_FARVAR
(
gdt_£g
, 
gdt_Ár
[7], 
GDT_CODE
 | 
	`GDT_LIMIT
(
BUILD_BIOS_SIZE
-1)

203 | 
	`GDT_BASE
(
BUILD_BIOS_ADDR
));

205 
ªgs
->
ds
 = 3<<3;

206 
ªgs
->
es
 = 4<<3;

207 
ªgs
->
code
.
£g
 = 6<<3;

209 
	`£t_code_suc˚ss
(
ªgs
);

211 
asm
 volatile(

218 " oæ $" 
	`__°rögify
(
CR0_PE
) ", %%eax\n"

229 : "S"(
gdt_Ár
), "m" (
__£gmít_ES
)

231 
	}
}

235 
	$h™dÀ_1590
(
bªgs
 *
ªgs
)

237 
	}
}

241 
	$h™dÀ_1591
(
bªgs
 *
ªgs
)

243 
	}
}

247 
	$h™dÀ_154f
(
bªgs
 *
ªgs
)

249 
	`£t_övÆid_sûít
(
ªgs
);

250 
	}
}

253 
	$h™dÀ_15c0
(
bªgs
 *
ªgs
)

255 
ªgs
->
es
 = 
SEG_BIOS
;

256 
ªgs
->
bx
 = (
u32
)&
BIOS_CONFIG_TABLE
;

257 
	`£t_code_suc˚ss
(
ªgs
);

258 
	}
}

261 
	$h™dÀ_15c1
(
bªgs
 *
ªgs
)

263 
ªgs
->
es
 = 
	`gë_ebda_£g
();

264 
	`£t_suc˚ss
(
ªgs
);

265 
	}
}

268 
	$h™dÀ_15e801
(
bªgs
 *
ªgs
)

277 
u32
 
rs
 = 
	`GET_GLOBAL
(
LegacyRamSize
);

280 i‡(
rs
 > 16*1024*1024) {

282 
ªgs
->
cx
 = 15*1024;

284 
ªgs
->
dx
 = (
rs
 - 16*1024*1024) / (64*1024);

286 
ªgs
->
cx
 = (
rs
 - 1*1024*1024) / 1024;

287 
ªgs
->
dx
 = 0;

291 
ªgs
->
ax
 =Ñegs->
cx
;

292 
ªgs
->
bx
 =Ñegs->
dx
;

294 
	`£t_suc˚ss
(
ªgs
);

295 
	}
}

298 
	$h™dÀ_15e820
(
bªgs
 *
ªgs
)

300 
cou¡
 = 
	`GET_GLOBAL
(
e820_cou¡
);

301 i‡(
ªgs
->
edx
 !0x534D4150 ||Ñegs->
bx
 >
cou¡


302 || 
ªgs
->
ecx
 < (
e820_li°
[0])) {

303 
	`£t_code_övÆid
(
ªgs
, 
RET_EUNSUPPORTED
);

307 
	`mem˝y_Ár
(
ªgs
->
es
, (*)‘egs->
di
+0)

308 , 
	`gë_globÆ_£g
(), &
e820_li°
[
ªgs
->
bx
]

309 , (
e820_li°
[0]));

310 i‡(
ªgs
->
bx
 =
cou¡
-1)

311 
ªgs
->
ebx
 = 0;

313 
ªgs
->
ebx
++;

314 
ªgs
->
óx
 = 0x534D4150;

315 
ªgs
->
ecx
 = (
e820_li°
[0]);

316 
	`£t_suc˚ss
(
ªgs
);

317 
	}
}

320 
	$h™dÀ_15e8XX
(
bªgs
 *
ªgs
)

322 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

323 
	}
}

326 
	$h™dÀ_15e8
(
bªgs
 *
ªgs
)

328 
ªgs
->
Æ
) {

329 0x01: 
	`h™dÀ_15e801
(
ªgs
); ;

330 0x20: 
	`h™dÀ_15e820
(
ªgs
); ;

331 : 
	`h™dÀ_15e8XX
(
ªgs
); ;

333 
	}
}

336 
	$h™dÀ_15XX
(
bªgs
 *
ªgs
)

338 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

339 
	}
}

342 
VISIBLE16


343 
	$h™dÀ_15
(
bªgs
 *
ªgs
)

345 
	`debug_íãr
(
ªgs
, 
DEBUG_HDL_15
);

346 
ªgs
->
ah
) {

347 0x24: 
	`h™dÀ_1524
(
ªgs
); ;

348 0x4e: 
	`h™dÀ_154e
(
ªgs
); ;

349 0x4f: 
	`h™dÀ_154f
(
ªgs
); ;

350 0x52: 
	`h™dÀ_1552
(
ªgs
); ;

351 0x53: 
	`h™dÀ_1553
(
ªgs
); ;

352 0x5f: 
	`h™dÀ_155f
(
ªgs
); ;

353 0x7f: 
	`h™dÀ_157f
(
ªgs
); ;

354 0x83: 
	`h™dÀ_1583
(
ªgs
); ;

355 0x86: 
	`h™dÀ_1586
(
ªgs
); ;

356 0x87: 
	`h™dÀ_1587
(
ªgs
); ;

357 0x88: 
	`h™dÀ_1588
(
ªgs
); ;

358 0x89: 
	`h™dÀ_1589
(
ªgs
); ;

359 0x90: 
	`h™dÀ_1590
(
ªgs
); ;

360 0x91: 
	`h™dÀ_1591
(
ªgs
); ;

361 0xc0: 
	`h™dÀ_15c0
(
ªgs
); ;

362 0xc1: 
	`h™dÀ_15c1
(
ªgs
); ;

363 0xc2: 
	`h™dÀ_15c2
(
ªgs
); ;

364 0xe8: 
	`h™dÀ_15e8
(
ªgs
); ;

365 : 
	`h™dÀ_15XX
(
ªgs
); ;

367 
	}
}

	@types.h

6 #i‚de‡
__SB_TYPES_H


7 
	#__SB_TYPES_H


	)

9 
	tu8
;

10 sig√d 
	ts8
;

11 
	tu16
;

12 sig√d 
	ts16
;

13 
	tu32
;

14 sig√d 
	ts32
;

15 
	tu64
;

16 sig√d 
	ts64
;

17 
u32
 
	tsize_t
;

19 
	uu64_u32_u
 {

20 °ru˘ { 
u32
 
	mlo
, 
	mhi
; };

21 
u64
 
	mvÆ
;

25 
	s£goff_s
 {

28 
u16
 
	moff£t
;

29 
u16
 
	m£g
;

31 
u32
 
	m£goff
;

35 #ifde‡
MANUAL_NO_JUMP_TABLE


36  775324556: 
	`asm
(""); 

	)

39 #ifde‡
WHOLE_PROGRAM


40 
	#__VISIBLE
 
	`__©åibuã__
((
exã∫Æly_visibÀ
))

	)

42 
	#__VISIBLE


	)

45 
	#UNIQSEC
 
__FILE__
 "." 
	`__°rögify
(
__LINE__
)

	)

47 
	#__n‹ëu∫
 
	`__©åibuã__
((
n‹ëu∫
))

	)

48 
	$__f‹˚_lök_îr‹__⁄ly_ö_32bô_Ê©
(Ë
__n‹ëu∫
;

49 
	$__f‹˚_lök_îr‹__⁄ly_ö_32bô_£gmíãd
(Ë
__n‹ëu∫
;

50 
	$__f‹˚_lök_îr‹__⁄ly_ö_16bô
(Ë
__n‹ëu∫
;

52 
	#__ASM
(
code
Ë
	`asm
(".£˘i⁄ .ãxt.asm." 
UNIQSEC
 "\n\t" code)

	)

54 #i‡
MODE16
 == 1

56 
	#VISIBLE16
 
__VISIBLE


	)

58 
	#VISIBLE32FLAT


	)

60 
	#VISIBLE32INIT


	)

62 
	#VISIBLE32SEG


	)

64 
	#VAR16
 
	`__£˘i⁄
(".d©a16." 
UNIQSEC
)

	)

66 
	#VAR16FIXED
(
addr
Ë
	`__Æig√d
(1Ë
__VISIBLE
 
	`__£˘i⁄
(".fixedaddr." 
	`__°rögify
◊ddr))

	)

68 
	#VAR32SEG
 
	`__£˘i⁄
(".disˇrd.v¨32£g." 
UNIQSEC
)

	)

70 
	#VARLOW
 
	`__£˘i⁄
(".disˇrd.v¨low." 
UNIQSEC
Ë
__VISIBLE
 
__wók


	)

72 
	#VARFSEG
 
	`__£˘i⁄
(".disˇrd.v¨f£g." 
UNIQSEC
Ë
__VISIBLE
 
__wók


	)

74 
	#VARVERIFY32INIT
 
	`__£˘i⁄
(".disˇrd.v¨öô." 
UNIQSEC
)

	)

76 
	#ASM16
(
code
Ë
	`__ASM
(code)

	)

78 
	#ASM32FLAT
(
code
)

	)

80 
	#ASSERT16
(Ëdÿ{ 
	}
} 0)

	)

81 
	#ASSERT32SEG
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_32bô_£gmíãd
()

	)

82 
	#ASSERT32FLAT
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_32bô_Ê©
()

	)

83 #ñi‡
MODESEGMENT
 == 1

84 
	#VISIBLE16


	)

85 
	#VISIBLE32FLAT


	)

86 
	#VISIBLE32INIT


	)

87 
	#VISIBLE32SEG
 
__VISIBLE


	)

88 
	#VAR16
 
	`__£˘i⁄
(".disˇrd.v¨16." 
UNIQSEC
)

	)

89 
	#VAR16FIXED
(
addr
Ë
VAR16
 
__VISIBLE
 
__wók


	)

90 
	#VAR32SEG
 
	`__£˘i⁄
(".d©a32£g." 
UNIQSEC
)

	)

91 
	#VARLOW
 
	`__£˘i⁄
(".disˇrd.v¨low." 
UNIQSEC
Ë
__VISIBLE
 
__wók


	)

92 
	#VARFSEG
 
	`__£˘i⁄
(".disˇrd.v¨f£g." 
UNIQSEC
Ë
__VISIBLE
 
__wók


	)

93 
	#VARVERIFY32INIT
 
	`__£˘i⁄
(".disˇrd.v¨öô." 
UNIQSEC
)

	)

94 
	#ASM16
(
code
)

	)

95 
	#ASM32FLAT
(
code
)

	)

96 
	#ASSERT16
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_16bô
()

	)

97 
	#ASSERT32SEG
(Ëdÿ{ } 0)

	)

98 
	#ASSERT32FLAT
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_32bô_Ê©
()

	)

100 
	#VISIBLE16


	)

101 
	#VISIBLE32FLAT
 
	`__£˘i⁄
(".ãxt.ru¡ime." 
UNIQSEC
Ë
__VISIBLE


	)

102 
	#VISIBLE32INIT
 
	`__£˘i⁄
(".ãxt.öô." 
UNIQSEC
Ë
__VISIBLE


	)

103 
	#VISIBLE32SEG


	)

104 
	#VAR16
 
	`__£˘i⁄
(".disˇrd.v¨16." 
UNIQSEC
)

	)

105 
	#VAR16FIXED
(
addr
Ë
VAR16
 
__VISIBLE
 
__wók


	)

106 
	#VAR32SEG
 
	`__£˘i⁄
(".disˇrd.v¨32£g." 
UNIQSEC
)

	)

107 
	#VARLOW
 
	`__£˘i⁄
(".d©a.v¨low." 
UNIQSEC
Ë
__VISIBLE
 
__wók


	)

108 
	#VARFSEG
 
	`__£˘i⁄
(".d©a.v¨f£g." 
UNIQSEC
Ë
__VISIBLE


	)

109 
	#VARVERIFY32INIT
 
	`__£˘i⁄
(".d©a.v¨öô." 
UNIQSEC
)

	)

110 
	#ASM16
(
code
)

	)

111 
	#ASM32FLAT
(
code
Ë
	`__ASM
(code)

	)

112 
	#ASSERT16
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_16bô
()

	)

113 
	#ASSERT32SEG
(Ë
	`__f‹˚_lök_îr‹__⁄ly_ö_32bô_£gmíãd
()

	)

114 
	#ASSERT32FLAT
(Ëdÿ{ } 0)

	)

117 
	#off£tof
(
TYPE
, 
MEMBER
Ë((
size_t
Ë&((TYPE *)0)->MEMBER)

	)

118 
	#ARRAY_SIZE
(
a
Ë(◊Ë/ ◊[0]))

	)

119 
	#FIELD_SIZEOF
(
t
, 
f
Ë(((—*)0)->f))

	)

120 
	#DIV_ROUND_UP
(
n
,
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

121 
	#DIV_ROUND_CLOSEST
(
x
, 
divis‹
)({ \

122 
	`ty≥of
(
divis‹
Ë
__divis‹
 = divisor; \

123 (((
x
Ë+ ((
__divis‹
) / 2)) / (__divisor)); \

124 })

	)

125 
	#ALIGN
(
x
,
a
Ë
	`__ALIGN_MASK
(x,(
	`ty≥of
(x))◊)-1)

	)

126 
	#__ALIGN_MASK
(
x
,
mask
Ë(((x)+(mask))&~(mask))

	)

127 
	#ALIGN_DOWN
(
x
,
a
Ë((xË& ~((
	`ty≥of
(x))◊)-1))

	)

128 
	#c⁄èöî_of
(
±r
, 
ty≥
, 
membî
) ({ \

129 c⁄° 
	`ty≥of
–((
ty≥
 *)0)->
membî
 ) *
__m±r
 = (
±r
); \

130 (
ty≥
 *)–(*)
__m±r
 - 
	`off£tof
—y≥,
membî
Ë);})

	)

131 
	#c⁄èöî_of_‹_nuŒ
(
±r
, 
ty≥
, 
membî
) ({ \

132 c⁄° 
	`ty≥of
–((
ty≥
 *)0)->
membî
 ) *
___m±r
 = (
±r
); \

133 
___m±r
 ? 
	`c⁄èöî_of
(___m±r, 
ty≥
, 
membî
Ë: 
NULL
; })

	)

135 
	#likñy
(
x
Ë
	`__buûtö_ex≥˘
(!!(x), 1)

	)

136 
	#u∆ikñy
(
x
Ë
	`__buûtö_ex≥˘
(!!(x), 0)

	)

138 
	#NULL
 ((*)0)

	)

140 
	#__wók
 
	`__©åibuã__
((
wók
))

	)

141 
	#__£˘i⁄
(
S
Ë
	`__©åibuã__
((
	`£˘i⁄
(S)))

	)

143 
	#PACKED
 
	`__©åibuã__
((
∑cked
))

	)

144 
	#__Æig√d
(
x
Ë
	`__©åibuã__
((
	`Æig√d
(x)))

	)

146 
	#b¨rõr
(Ë
__asm__
 
	`__vﬁ©ûe__
("": : :"mem‹y")

	)

148 
	#noölöe
 
	`__©åibuã__
((
noölöe
))

	)

149 
	#__Æways_ölöe
 
ölöe
 
	`__©åibuã__
((
Æways_ölöe
))

	)

150 
	#__mÆloc
 
	`__©åibuã__
((
__mÆloc__
))

	)

151 
	#__©åibuã_c⁄°
 
	`__©åibuã__
((
__c⁄°__
))

	)

153 
	#__°rögify_1
(
x
Ë#x

	)

154 
	#__°rögify
(
x
Ë
	`__°rögify_1
(x)

	)

	@util.h

2 #i‚de‡
__UTIL_H


3 
	#__UTIL_H


	)

5 
	~"ty≥s.h
"

8 
≠m_shutdown
();

9 
	gbªgs
;

10 
h™dÀ_1553
(
bªgs
 *
ªgs
);

13 
bmp_decd©a
 *
bmp_Æloc
();

14 
bmp_decode
(
bmp_decd©a
 *
bmp
, *
d©a
, 
d©a_size
);

15 
bmp_gë_size
(
bmp_decd©a
 *
bmp
, *
width
, *
height
);

16 
bmp_show
(
bmp_decd©a
 *
bmp
, *
pic
, 
width


17 , 
height
, 
dïth
, 
byãs_≥r_löe_de°
);

20 
boŸ_öô
();

21 
boŸ_add_bev
(
u16
 
£g
, u16 
bev
, u16 
desc
, 
¥io
);

22 
boŸ_add_bcv
(
u16
 
£g
, u16 
ù
, u16 
desc
, 
¥io
);

23 
	gdrive_s
;

24 
boŸ_add_Ê›py
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
);

25 
boŸ_add_hd
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
);

26 
boŸ_add_cd
(
drive_s
 *
drive_g
, c⁄° *
desc
, 
¥io
);

27 
boŸ_add_cbfs
(*
d©a
, c⁄° *
desc
, 
¥io
);

28 
öãø˘ive_boŸmíu
();

29 
bcv_¥ïboŸ
();

30 
	gpci_devi˚
;

31 
boŸ¥io_föd_pci_devi˚
(
pci_devi˚
 *
pci
);

32 
boŸ¥io_föd_scsi_devi˚
(
pci_devi˚
 *
pci
, 
èrgë
, 
lun
);

33 
boŸ¥io_föd_©a_devi˚
(
pci_devi˚
 *
pci
, 
ch™id
, 
¶ave
);

34 
boŸ¥io_föd_fdc_devi˚
(
pci_devi˚
 *
pci
, 
p‹t
, 
fdid
);

35 
boŸ¥io_föd_pci_rom
(
pci_devi˚
 *
pci
, 
ö°™˚
);

36 
boŸ¥io_föd_«med_rom
(c⁄° *
«me
, 
ö°™˚
);

37 
	gusbdevi˚_s
;

38 
boŸ¥io_föd_usb
(
usbdevi˚_s
 *
usbdev
, 
lun
);

41 
íabÀ_vga_c⁄sﬁe
();

42 
íabÀ_boŸ•œsh
();

43 
dißbÀ_boŸ•œsh
();

46 
u8
 
CDRom_locks
[];

47 
cdemu_s
 
CDEmu
;

48 
drive_s
 *
cdemu_drive_gf
;

49 
	gdisk_›_s
;

50 
¥o˚ss_cdemu_›
(
disk_›_s
 *
›
);

51 
cdrom_¥ïboŸ
();

52 
cdemu_134b
(
bªgs
 *
ªgs
);

53 
cdrom_boŸ
(
drive_s
 *
drive_g
);

56 
˛ock_£tup
();

57 
h™dÀ_1583
(
bªgs
 *
ªgs
);

58 
u32
 
úqtimî_ˇlc_ticks
(u32 
cou¡
);

59 
u32
 
úqtimî_ˇlc
(u32 
m£cs
);

60 
úqtimî_check
(
u32
 
íd
);

61 
h™dÀ_1586
(
bªgs
 *
ªgs
);

64 
rsdp_des¸ùt‹
 *
RsdpAddr
;

65 
u32
 
a˝i_pm1a_˙t
;

66 
a˝i_£tup
();

67 
u32
 
föd_ªsume_ve˘‹
();

68 
föd_a˝i_„©uªs
();

69 
	ga˝i_20_gíîic_addªss
;

70 
a˝i_£t_ª£t_ªg
(
a˝i_20_gíîic_addªss
 *
ªg
, 
u8
 
vÆ
);

71 
a˝i_ªboŸ
();

74 
c›y_smbios
(*
pos
);

75 
c›y_èbÀ
(*
pos
);

76 *
föd_a˝i_rsdp
();

79 c⁄° *
CBvíd‹
, *
CB∑π
;

80 
	gcbfs_fûe
;

81 
c‹eboŸ_debug_putc
(
c
);

82 
cbfs_run_∑ylﬂd
(
cbfs_fûe
 *
fûe
);

83 
c‹eboŸ_∂©f‹m_£tup
();

84 
cbfs_∑ylﬂd_£tup
();

85 
c‹eboŸ_¥eöô
();

86 
c‹eboŸ_cbfs_öô
();

87 
upd©e_cbmem
();

90 
csm_boŸ¥io_fdc
(
pci_devi˚
 *
pci
, 
p‹t
, 
fdid
);

91 
csm_boŸ¥io_©a
(
pci_devi˚
 *
pci
, 
ch™id
, 
¶ave
);

92 
csm_boŸ¥io_pci
(
pci_devi˚
 *
pci
);

95 
m±abÀ_£tup
();

98 
mår_£tup
();

101 c⁄° 
u8
 
pci_úqs
[4];

102 
pci_£tup
();

103 
pci_ªsume
();

106 
pú_hódî
 *
PúAddr
;

107 
púèbÀ_£tup
();

110 
make_bios_wrôabÀ
();

111 
make_bios_ªad⁄ly
();

112 
qemu_¥ï_ª£t
();

115 
smbios_íåy_poöt
 *
SMBiosAddr
;

116 
smbios_£tup
();

117 
di•œy_uuid
();

120 
smm_devi˚_£tup
();

121 
smm_£tup
();

124 
u32
 
Cou¡CPUs
;

125 
u32
 
MaxCou¡CPUs
;

126 
wrm§_smp
(
u32
 
ödex
, 
u64
 
vÆ
);

127 
smp_£tup
();

128 
≠ic_id_is_¥e£¡
(
u8
 
≠ic_id
);

131 
dma_Ê›py
(
u32
 
addr
, 
cou¡
, 
isWrôe
);

132 
dma_£tup
();

135 
Ê›py_ext_dbt_s
 
diskëã_∑øm_èbÀ2
;

136 
Ê›py_£tup
();

137 
drive_s
 *
öô_Ê›py
(
Ê›pyid
, 
·y≥
);

138 
föd_Ê›py_ty≥
(
u32
 
size
);

139 
¥o˚ss_Ê›py_›
(
disk_›_s
 *
›
);

140 
Ê›py_tick
();

143 
ømdisk_£tup
();

144 
¥o˚ss_ømdisk_›
(
disk_›_s
 *
›
);

147 
timî_£tup
();

148 
pmtimî_£tup
(
u16
 
i›‹t
);

149 
u32
 
timî_ˇlc
(u32 
m£cs
);

150 
u32
 
timî_ˇlc_u£c
(u32 
u£cs
);

151 
timî_check
(
u32
 
íd
);

152 
ndñay
(
u32
 
cou¡
);

153 
udñay
(
u32
 
cou¡
);

154 
mdñay
(
u32
 
cou¡
);

155 
n¶ìp
(
u32
 
cou¡
);

156 
u¶ìp
(
u32
 
cou¡
);

157 
m¶ìp
(
u32
 
cou¡
);

158 
u32
 
ticks_to_ms
(u32 
ticks
);

159 
u32
 
ticks_‰om_ms
(u32 
ms
);

160 
pô_£tup
();

163 
j≥g_decd©a
 *
j≥g_Æloc
();

164 
j≥g_decode
(
j≥g_decd©a
 *
j≥g
, *
buf
);

165 
j≥g_gë_size
(
j≥g_decd©a
 *
j≥g
, *
width
, *
height
);

166 
j≥g_show
(
j≥g_decd©a
 *
j≥g
, *
pic
, 
width


167 , 
height
, 
dïth
, 
byãs_≥r_löe_de°
);

170 
kbd_öô
();

171 
h™dÀ_15c2
(
bªgs
 *
ªgs
);

172 
¥o˚ss_key
(
u8
 
key
);

173 
u8
 
íqueue_key
(u8 
sˇn_code
, u8 
ascii_code
);

176 
bios_c⁄fig_èbÀ_s
 
BIOS_CONFIG_TABLE
 
__Æig√d
(1);

177 
u8
 
BiosChecksum
;

178 
m©h˝_£tup
();

181 
mou£_öô
();

182 
¥o˚ss_mou£
(
u8
 
d©a
);

185 
	grom_hódî
;

186 
ˇŒrom
(
rom_hódî
 *
rom
, 
u16
 
bdf
);

187 
ˇŒ_bcv
(
u16
 
£g
, u16 
ù
);

188 
is_pci_vga
(
pci_devi˚
 *
pci
);

189 
›ti⁄rom_£tup
();

190 
vg¨om_£tup
();

191 
s3_ªsume_vga
();

192 
S¸ìnAndDebug
;

195 
h™dÀ_1ab1
(
bªgs
 *
ªgs
);

196 
bios32_öô
();

199 
pmm_öô
();

200 
pmm_¥ïboŸ
();

203 
u16
 
gë_≤p_off£t
();

204 
≤p_öô
();

207 
öãrÁ˚_öô
();

208 
devi˚_h¨dw¨e_£tup
();

209 
¥ï¨eboŸ
();

210 
°¨tBoŸ
();

211 
ªloc_¥eöô
(*
f
, *
¨g
);

214 
HaveRunPo°
;

217 
	$ª£t_ve˘‹
(Ë
__n‹ëu∫
;

220 
	`£rül_£tup
();

221 
	`Õt_£tup
();

222 
	`u¨t_check_key°rokes
();

225 
	`h™dÀ_155f
(
bªgs
 *
ªgs
);

226 
	`h™dÀ_157f
(
bªgs
 *
ªgs
);

227 
	`vgahook_£tup
(
pci_devi˚
 *
pci
);

228 
	`h™dÀ_154e
(
bªgs
 *
ªgs
);

229 
pci_devi˚
;

232 c⁄° 
VERSION
[];

	@vgahooks.c

7 
	~"biosv¨.h
"

8 
	~"bªgs.h
"

9 
	~"c⁄fig.h
"

10 
	~"hw/pci.h
"

11 
	~"hw/pci_ids.h
"

12 
	~"hw/pci_ªgs.h
"

13 
	~"ouçut.h
"

14 
	~"°rög.h
"

15 
	~"utû.h
"

17 
	#VH_VIA
 1

	)

18 
	#VH_INTEL
 2

	)

19 
	#VH_SMI
 3

	)

21 
VGAHookH™dÀrTy≥
 
	gVARFSEG
;

24 
	$h™dÀ_155fXX
(
bªgs
 *
ªgs
)

26 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

27 
	}
}

30 
	$h™dÀ_157fXX
(
bªgs
 *
ªgs
)

32 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

33 
	}
}

39 #i‡
CONFIG_LVDS_800


41 c⁄° 
u8
 
	gedid_800x600
[] 
	gVARFSEG
 = {

61 #i‡
CONFIG_LVDS_640


63 c⁄° 
u8
 
	gedid_640x480
[] 
	gVARFSEG
 = {

84 
	$h™dÀ_154e
(
bªgs
 *
ªgs
)

86 
	`d¥ötf
(1, "INT15.4E08 - ");

88 i‡–((
ªgs
->
ax
)==0x4e08Ë&& ((‘egs->
bx
) & 0x00ff)==0x1b) ) {

89 #i‡
CONFIG_LVDS_800


90 
	`d¥ötf
(1, "Retrieving 800x600 LCD Panel EDID\n");

91 
ªgs
->
cx
 = (
edid_800x600
);

92 
ªgs
->
di
 = (
u32
)
edid_800x600
;

93 
ªgs
->
Æ
 = 0;

96 #i‡
CONFIG_LVDS_640


97 
	`d¥ötf
(1, "Retrieving 640x480 LCD Panel EDID\n");

98 
ªgs
->
cx
 = (
edid_640x480
);

99 
ªgs
->
di
 = (
u32
)
edid_640x480
;

100 
ªgs
->
Æ
 = 0;

104 
	`£t_code_unim∂emíãd
(
ªgs
, 
RET_EUNSUPPORTED
);

105 
	}
}

111 
VüFBsize
 
	gVARFSEG
, 
VüRamS≥ed
 VARFSEG;

114 
	$vü_155f01
(
bªgs
 *
ªgs
)

116 
ªgs
->
óx
 = 0x5f;

117 
ªgs
->
˛
 = 2;

118 
	`£t_suc˚ss
(
ªgs
);

119 
	`d¥ötf
(1, "Warning: VGAÖanelÅype is hardcoded\n");

120 
	}
}

123 
	$vü_155f02
(
bªgs
 *
ªgs
)

125 
ªgs
->
óx
 = 0x5f;

126 
ªgs
->
bx
 = 2;

127 
ªgs
->
cx
 = 0x401;

128 
ªgs
->
dx
 = 0;

129 
	`£t_suc˚ss
(
ªgs
);

130 
	`d¥ötf
(1, "Warning: VGA TV/CRT outputÅype is hardcoded\n");

131 
	}
}

134 
	$vü_155f18
(
bªgs
 *
ªgs
)

136 
fbsize
 = 
	`GET_GLOBAL
(
VüFBsize
), 
øm•ìd
 = GET_GLOBAL(
VüRamS≥ed
);

137 i‡(
fbsize
 < 0 || 
øm•ìd
 < 0) {

138 
	`£t_code_övÆid
(
ªgs
, 
RET_EUNSUPPORTED
);

141 
ªgs
->
óx
 = 0x5f;

142 
ªgs
->
ebx
 = 0x500 | (
øm•ìd
 << 4Ë| 
fbsize
;

143 
ªgs
->
ecx
 = 0x060;

144 
	`£t_suc˚ss
(
ªgs
);

145 
	}
}

148 
	$vü_155f19
(
bªgs
 *
ªgs
)

150 
	`£t_övÆid_sûít
(
ªgs
);

151 
	}
}

154 
	$vü_155f
(
bªgs
 *
ªgs
)

156 
ªgs
->
Æ
) {

157 0x01: 
	`vü_155f01
(
ªgs
); ;

158 0x02: 
	`vü_155f02
(
ªgs
); ;

159 0x18: 
	`vü_155f18
(
ªgs
); ;

160 0x19: 
	`vü_155f19
(
ªgs
); ;

161 : 
	`h™dÀ_155fXX
(
ªgs
); ;

163 
	}
}

166 
	$gëFBSize
(
pci_devi˚
 *
pci
)

169 
u8
 
ªg
 = 
	`pci_c⁄fig_ªadb
(
pci
->
bdf
, 0xa1);

172 i‡(!(
ªg
 & 0x80))

175 
u8
 
mem_powî
[] = {0, 3, 4, 5, 6, 7, 8, 9};

176  
mem_powî
[(
ªg
 >> 4) & 0x7];

177 
	}
}

180 
	$gëVüRamS≥ed
(
pci_devi˚
 *
pci
)

182  (
	`pci_c⁄fig_ªadb
(
pci
->
bdf
, 0x90) & 0x07) + 3;

183 
	}
}

186 
	$gëAMDRamS≥ed
()

188 
pci_devi˚
 *
pci
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_AMD


189 , 
PCI_DEVICE_ID_AMD_K8_NB_MEMCTL
);

190 i‡(!
pci
)

194  (
	`pci_c⁄fig_ªadb
(
pci
->
bdf
, 0x94) & 0x7) + 6;

195 
	}
}

218 
	#PCI_DEVICE_ID_VIA_K8M890CE_3
 0x3336

	)

219 
	#PCI_DEVICE_ID_VIA_VX855_MEMCTRL
 0x3409

	)

222 
	$vü_£tup
(
pci_devi˚
 *
pci
)

224 
VGAHookH™dÀrTy≥
 = 
VH_VIA
;

226 
pci_devi˚
 *
d
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_VIA


227 , 
PCI_DEVICE_ID_VIA_K8M890CE_3
);

228 i‡(
d
) {

229 
VüFBsize
 = 
	`gëFBSize
(
d
);

230 
VüRamS≥ed
 = 
	`gëAMDRamS≥ed
();

233 
d
 = 
	`pci_föd_devi˚
(
PCI_VENDOR_ID_VIA
, 
PCI_DEVICE_ID_VIA_VX855_MEMCTRL
);

234 i‡(
d
) {

235 
VüFBsize
 = 
	`gëFBSize
(
d
);

236 
VüRamS≥ed
 = 
	`gëVüRamS≥ed
(
d
);

240 
	`d¥ötf
(1, "Warning: VGA memory sizeánd speed is hardcoded\n");

241 
VüFBsize
 = 5;

242 
VüRamS≥ed
 = 4;

243 
	}
}

250 
u8
 
I¡ñDi•œyTy≥
 
	gVARFSEG
, 
I¡ñDi•œyId
 VARFSEG;

253 
	$öãl_155f35
(
bªgs
 *
ªgs
)

255 
ªgs
->
ax
 = 0x005f;

256 
ªgs
->
˛
 = 
	`GET_GLOBAL
(
I¡ñDi•œyTy≥
);

257 
	`£t_suc˚ss
(
ªgs
);

258 
	}
}

261 
	$öãl_155f40
(
bªgs
 *
ªgs
)

263 
ªgs
->
ax
 = 0x005f;

264 
ªgs
->
˛
 = 
	`GET_GLOBAL
(
I¡ñDi•œyId
);

265 
	`£t_suc˚ss
(
ªgs
);

266 
	}
}

269 
	$öãl_155f50
(
bªgs
 *
ªgs
)

272 
ªgs
->
ax
 = 0x005f;

273 
	`£t_suc˚ss
(
ªgs
);

274 
	}
}

277 
	$öãl_155f
(
bªgs
 *
ªgs
)

279 
ªgs
->
Æ
) {

280 0x35: 
	`öãl_155f35
(
ªgs
); ;

281 0x40: 
	`öãl_155f40
(
ªgs
); ;

282 0x50: 
	`öãl_155f50
(
ªgs
); ;

283 : 
	`h™dÀ_155fXX
(
ªgs
); ;

285 
	}
}

287 
	#BOOT_DISPLAY_DEFAULT
 (0)

	)

288 
	#BOOT_DISPLAY_CRT
 (1 << 0)

	)

289 
	#BOOT_DISPLAY_TV
 (1 << 1)

	)

290 
	#BOOT_DISPLAY_EFP
 (1 << 2)

	)

291 
	#BOOT_DISPLAY_LCD
 (1 << 3)

	)

292 
	#BOOT_DISPLAY_CRT2
 (1 << 4)

	)

293 
	#BOOT_DISPLAY_TV2
 (1 << 5)

	)

294 
	#BOOT_DISPLAY_EFP2
 (1 << 6)

	)

295 
	#BOOT_DISPLAY_LCD2
 (1 << 7)

	)

298 
	$öãl_£tup
(
pci_devi˚
 *
pci
)

300 
VGAHookH™dÀrTy≥
 = 
VH_INTEL
;

302 
I¡ñDi•œyTy≥
 = 
BOOT_DISPLAY_DEFAULT
;

303 
I¡ñDi•œyId
 = 3;

304 
	}
}

307 
	$roda_£tup
(
pci_devi˚
 *
pci
)

309 
VGAHookH™dÀrTy≥
 = 
VH_INTEL
;

311 
I¡ñDi•œyTy≥
 = 
BOOT_DISPLAY_LCD
;

313 
I¡ñDi•œyId
 = 3;

314 
	}
}

317 
	$k⁄å⁄_£tup
(
pci_devi˚
 *
pci
)

319 
VGAHookH™dÀrTy≥
 = 
VH_INTEL
;

320 
I¡ñDi•œyTy≥
 = 
BOOT_DISPLAY_CRT
;

321 
I¡ñDi•œyId
 = 3;

322 
	}
}

325 
	$gëac_£tup
(
pci_devi˚
 *
pci
)

327 
	}
}

333 
u8
 
SmiBoŸDi•œy
 
	gVARFSEG
;

336 
	$smi_157f02
(
bªgs
 *
ªgs
)

339 
ªgs
->
ax
 = 0x007f;

340 
ªgs
->
bl
 = 
	`GET_GLOBAL
(
SmiBoŸDi•œy
);

341 
	`£t_suc˚ss
(
ªgs
);

342 
	}
}

345 
	$smi_157f14
(
bªgs
 *
ªgs
)

348 
ªgs
->
ax
 = 0x007f;

349 
ªgs
->
bl
 = 0x00;

350 
	`£t_suc˚ss
(
ªgs
);

351 
	}
}

354 
	$smi_157f
(
bªgs
 *
ªgs
)

356 
ªgs
->
Æ
) {

357 0x02: 
	`smi_157f02
(
ªgs
); ;

358 0x14: 
	`smi_157f14
(
ªgs
); ;

359 : 
	`h™dÀ_157fXX
(
ªgs
); ;

361 
	}
}

364 
	$wöít_mb6047_£tup
(
pci_devi˚
 *
pci
)

366 
VGAHookH™dÀrTy≥
 = 
VH_SMI
;

367 
SmiBoŸDi•œy
 = 0x02;

368 
	}
}

376 
	$h™dÀ_155f
(
bªgs
 *
ªgs
)

378 i‡(!
CONFIG_VGAHOOKS
) {

379 
	`h™dÀ_155fXX
(
ªgs
);

383 
hty≥
 = 
	`GET_GLOBAL
(
VGAHookH™dÀrTy≥
);

384 
hty≥
) {

385 
VH_VIA
: 
	`vü_155f
(
ªgs
); ;

386 
VH_INTEL
: 
	`öãl_155f
(
ªgs
); ;

387 : 
	`h™dÀ_155fXX
(
ªgs
); ;

389 
	}
}

393 
	$h™dÀ_157f
(
bªgs
 *
ªgs
)

395 i‡(!
CONFIG_VGAHOOKS
) {

396 
	`h™dÀ_157fXX
(
ªgs
);

400 
hty≥
 = 
	`GET_GLOBAL
(
VGAHookH™dÀrTy≥
);

401 
hty≥
) {

402 
VH_SMI
: 
	`smi_157f
(
ªgs
); ;

403 : 
	`h™dÀ_157fXX
(
ªgs
); ;

405 
	}
}

409 
	$vgahook_£tup
(
pci_devi˚
 *
pci
)

411 i‡(!
CONFIG_VGAHOOKS
)

414 i‡(
	`°rcmp
(
CBvíd‹
, "KONTRON"Ë=0 && såcmp(
CB∑π
, "986LCD-M") == 0)

415 
	`k⁄å⁄_£tup
(
pci
);

416 i‡(
	`°rcmp
(
CBvíd‹
, "GETAC"Ë=0 && såcmp(
CB∑π
, "P470") == 0)

417 
	`gëac_£tup
(
pci
);

418 i‡(
	`°rcmp
(
CBvíd‹
, "RODA"Ë=0 && såcmp(
CB∑π
, "RK886EX") == 0)

419 
	`roda_£tup
(
pci
);

420 i‡(
	`°rcmp
(
CBvíd‹
, "Wö E¡î¥i£"Ë=0 && såcmp(
CB∑π
, "MB6047") == 0)

421 
	`wöít_mb6047_£tup
(
pci
);

422 i‡(
pci
->
víd‹
 =
PCI_VENDOR_ID_VIA
)

423 
	`vü_£tup
(
pci
);

424 i‡(
pci
->
víd‹
 =
PCI_VENDOR_ID_INTEL
)

425 
	`öãl_£tup
(
pci
);

426 
	}
}

	@x86.c

7 
	~"x86.h
"

10 
	$˝uid
(
u32
 
ödex
, u32 *
óx
, u32 *
ebx
, u32 *
ecx
, u32 *
edx
)

13 
u32
 
‹igÊags
 = 
	`ßve_Êags
();

14 
	`ª°‹e_Êags
(
‹igÊags
 ^ 
F_ID
);

15 
u32
 
√wÊags
 = 
	`ßve_Êags
();

16 
	`ª°‹e_Êags
(
‹igÊags
);

18 i‡(((
‹igÊags
 ^ 
√wÊags
Ë& 
F_ID
) != F_ID)

20 *
óx
 = *
ebx
 = *
ecx
 = *
edx
 = 0;

22 
	`__˝uid
(
ödex
, 
óx
, 
ebx
, 
ecx
, 
edx
);

23 
	}
}

	@x86.h

2 #i‚de‡
__X86_H


3 
	#__X86_H


	)

6 
	#F_CF
 (1<<0)

	)

7 
	#F_ZF
 (1<<6)

	)

8 
	#F_IF
 (1<<9)

	)

9 
	#F_ID
 (1<<21)

	)

12 
	#CR0_PG
 (1<<31)

13 
	#CR0_CD
 (1<<30)

14 
	#CR0_NW
 (1<<29)

15 
	#CR0_PE
 (1<<0)

16 

	)

17 #i‚de‡
__ASSEMBLY__


19 
	~"ty≥s.h
"

21 
ölöe
 
	$úq_dißbÀ
()

23 
asm
 volatile("cli": : :"memory");

24 
	}
}

26 
ölöe
 
	$úq_íabÀ
()

28 
asm
 volatile("sti": : :"memory");

29 
	}
}

31 
ölöe
 
u32
 
	$ßve_Êags
()

33 
u32
 
Êags
;

34 
asm
 vﬁ©ûe("pushÊ ;Ö›»%0" : "Ùm" (
Êags
));

35  
Êags
;

36 
	}
}

38 
ölöe
 
	$ª°‹e_Êags
(
u32
 
Êags
)

40 
asm
 vﬁ©ûe("push»%0 ;Ö›Ê" : : "g" (
Êags
) : "memory", "cc");

41 
	}
}

43 
ölöe
 
	$˝u_ªœx
()

45 
asm
 volatile("rep ;Çop": : :"memory");

46 
	}
}

48 
ölöe
 
	$n›
()

50 
asm
 volatile("nop");

51 
	}
}

53 
ölöe
 
	$h…
()

55 
asm
 volatile("hlt": : :"memory");

56 
	}
}

58 
ölöe
 
	$wbövd
()

60 
asm
 volatile("wbinvd": : :"memory");

61 
	}
}

63 
	#CPUID_TSC
 (1 << 4)

	)

64 
	#CPUID_MSR
 (1 << 5)

	)

65 
	#CPUID_APIC
 (1 << 9)

	)

66 
	#CPUID_MTRR
 (1 << 12)

	)

67 
ölöe
 
	$__˝uid
(
u32
 
ödex
, u32 *
óx
, u32 *
ebx
, u32 *
ecx
, u32 *
edx
)

69 
	`asm
("cpuid"

70 : "˜" (*
óx
), "=b" (*
ebx
), "=c" (*
ecx
), "=d" (*
edx
)

71 : "0" (
ödex
));

72 
	}
}

74 
ölöe
 
u32
 
	$gë¸0
() {

75 
u32
 
¸0
;

76 
	`asm
("mov»%%¸0, %0" : "Ù"(
¸0
));

77  
¸0
;

78 
	}
}

79 
ölöe
 
	$£t¸0
(
u32
 
¸0
) {

80 
	`asm
("mov»%0, %%¸0" : : "r"(
¸0
));

81 
	}
}

83 
ölöe
 
u64
 
	$rdm§
(
u32
 
ödex
)

85 
u64
 
ªt
;

86 
	`asm
 ("rdm§" : "=A"(
ªt
Ë: "c"(
ödex
));

87  
ªt
;

88 
	}
}

90 
ölöe
 
	$wrm§
(
u32
 
ödex
, 
u64
 
vÆ
)

92 
asm
 vﬁ©ûê("wrm§" : : "c"(
ödex
), "A"(
vÆ
));

93 
	}
}

95 
ölöe
 
u64
 
	$rdts˛l
()

97 
u64
 
vÆ
;

98 
asm
 vﬁ©ûe("rdtsc" : "=A" (
vÆ
));

99  
vÆ
;

100 
	}
}

102 
ölöe
 
u32
 
	$__ffs
(
u32
 
w‹d
)

104 
	`asm
("bsf %1,%0"

105 : "Ù" (
w‹d
)

106 : "rm" (
w‹d
));

107  
w‹d
;

108 
	}
}

109 
ölöe
 
u32
 
	$__Ês
(
u32
 
w‹d
)

111 
	`asm
("bsr %1,%0"

112 : "Ù" (
w‹d
)

113 : "rm" (
w‹d
));

114  
w‹d
;

115 
	}
}

117 
ölöe
 
u32
 
	$gëe•
() {

118 
u32
 
e•
;

119 
	`asm
("mov»%%e•, %0" : "Ùm"(
e•
));

120  
e•
;

121 
	}
}

123 
ölöe
 
	$outb
(
u8
 
vÆue
, 
u16
 
p‹t
) {

124 
__asm__
 
	`__vﬁ©ûe__
("outb %b0, %w1" : : "a"(
vÆue
), "Nd"(
p‹t
));

125 
	}
}

126 
ölöe
 
	$outw
(
u16
 
vÆue
, u16 
p‹t
) {

127 
__asm__
 
	`__vﬁ©ûe__
("outw %w0, %w1" : : "a"(
vÆue
), "Nd"(
p‹t
));

128 
	}
}

129 
ölöe
 
	$oué
(
u32
 
vÆue
, 
u16
 
p‹t
) {

130 
__asm__
 
	`__vﬁ©ûe__
("oué %0, %w1" : : "a"(
vÆue
), "Nd"(
p‹t
));

131 
	}
}

132 
ölöe
 
u8
 
	$öb
(
u16
 
p‹t
) {

133 
u8
 
vÆue
;

134 
__asm__
 
	`__vﬁ©ûe__
("öb %w1, %b0" : "˜"(
vÆue
Ë: "Nd"(
p‹t
));

135  
vÆue
;

136 
	}
}

137 
ölöe
 
u16
 
	$öw
(
u16
 
p‹t
) {

138 
u16
 
vÆue
;

139 
__asm__
 
	`__vﬁ©ûe__
("öw %w1, %w0" : "˜"(
vÆue
Ë: "Nd"(
p‹t
));

140  
vÆue
;

141 
	}
}

142 
ölöe
 
u32
 
	$öl
(
u16
 
p‹t
) {

143 
u32
 
vÆue
;

144 
__asm__
 
	`__vﬁ©ûe__
("ö»%w1, %0" : "˜"(
vÆue
Ë: "Nd"(
p‹t
));

145  
vÆue
;

146 
	}
}

148 
ölöe
 
	$ösb
(
u16
 
p‹t
, 
u8
 *
d©a
, 
u32
 
cou¡
) {

149 
asm
 volatile("rep insb (%%dx), %%es:(%%edi)"

150 : "+c"(
cou¡
), "+D"(
d©a
Ë: "d"(
p‹t
) : "memory");

151 
	}
}

152 
ölöe
 
	$ösw
(
u16
 
p‹t
, u16 *
d©a
, 
u32
 
cou¡
) {

153 
asm
 volatile("rep insw (%%dx), %%es:(%%edi)"

154 : "+c"(
cou¡
), "+D"(
d©a
Ë: "d"(
p‹t
) : "memory");

155 
	}
}

156 
ölöe
 
	$ö¶
(
u16
 
p‹t
, 
u32
 *
d©a
, u32 
cou¡
) {

157 
asm
 volatile("rep insl (%%dx), %%es:(%%edi)"

158 : "+c"(
cou¡
), "+D"(
d©a
Ë: "d"(
p‹t
) : "memory");

159 
	}
}

161 
ölöe
 
	$outsb
(
u16
 
p‹t
, 
u8
 *
d©a
, 
u32
 
cou¡
) {

162 
asm
 volatile("rep outsb %%es:(%%esi), (%%dx)"

163 : "+c"(
cou¡
), "+S"(
d©a
Ë: "d"(
p‹t
) : "memory");

164 
	}
}

165 
ölöe
 
	$outsw
(
u16
 
p‹t
, u16 *
d©a
, 
u32
 
cou¡
) {

166 
asm
 volatile("rep outsw %%es:(%%esi), (%%dx)"

167 : "+c"(
cou¡
), "+S"(
d©a
Ë: "d"(
p‹t
) : "memory");

168 
	}
}

169 
ölöe
 
	$out¶
(
u16
 
p‹t
, 
u32
 *
d©a
, u32 
cou¡
) {

170 
asm
 volatile("rep outsl %%es:(%%esi), (%%dx)"

171 : "+c"(
cou¡
), "+S"(
d©a
Ë: "d"(
p‹t
) : "memory");

172 
	}
}

174 
ölöe
 
	$wrôñ
(*
addr
, 
u32
 
vÆ
) {

175 *(vﬁ©ûê
u32
 *)
addr
 = 
vÆ
;

176 
	}
}

177 
ölöe
 
	$wrôew
(*
addr
, 
u16
 
vÆ
) {

178 *(vﬁ©ûê
u16
 *)
addr
 = 
vÆ
;

179 
	}
}

180 
ölöe
 
	$wrôeb
(*
addr
, 
u8
 
vÆ
) {

181 *(vﬁ©ûê
u8
 *)
addr
 = 
vÆ
;

182 
	}
}

183 
ölöe
 
u32
 
	$ªadl
(c⁄° *
addr
) {

184  *(vﬁ©ûêc⁄° 
u32
 *)
addr
;

185 
	}
}

186 
ölöe
 
u16
 
	$ªadw
(c⁄° *
addr
) {

187  *(vﬁ©ûêc⁄° 
u16
 *)
addr
;

188 
	}
}

189 
ölöe
 
u8
 
	$ªadb
(c⁄° *
addr
) {

190  *(vﬁ©ûêc⁄° 
u8
 *)
addr
;

191 
	}
}

194 
	#GDT_CODE
 (0x9bULL << 40)

195 
	#GDT_DATA
 (0x93ULL << 40)

196 
	#GDT_B
 (0x1ULL << 54)

197 
	#GDT_G
 (0x1ULL << 55)

199 
	#GDT_BASE
(
v
Ë((((
u64
)(v) & 0xff000000) << 32) \

200 | (((
u64
)(
v
Ë& 0x00ffffffË<< 16))

	)

202 
	#GDT_LIMIT
(
v
Ë((((
u64
)(v) & 0x000f0000) << 32) \

203 | (((
u64
)(
v
Ë& 0x0000ffffË<< 0))

	)

205 
	#GDT_GRANLIMIT
(
v
Ë(
GDT_G
 | 
	`GDT_LIMIT
((vË>> 12))

	)

207 
	sdes˛oc_s
 {

208 
u16
 
	mÀngth
;

209 
u32
 
	maddr
;

210 } 
	gPACKED
;

212 
ölöe
 
	$sgdt
(
des˛oc_s
 *
desc
) {

213 
	`asm
("sgdé %0" : "=m"(*
desc
));

214 
	}
}

215 
ölöe
 
	$lgdt
(
des˛oc_s
 *
desc
) {

216 
	`asm
("lgdé %0" : : "m"(*
desc
) : "memory");

217 
	}
}

220 
˝uid
(
u32
 
ödex
, u32 *
óx
, u32 *
ebx
, u32 *
ecx
, u32 *
edx
);

	@
1
.
1
/usr/include
150
1709
apm.c
asm-offsets.c
biosvar.h
block.c
block.h
bmp.c
boot.c
boot.h
bootsplash.c
bregs.h
byteorder.h
cdrom.c
clock.c
config.h
disk.c
farptr.h
font.c
fw/acpi.c
fw/biostables.c
fw/coreboot.c
fw/coreboot.h
fw/csm.c
fw/dev-q35.h
fw/efi.h
fw/lzmadecode.c
fw/lzmadecode.h
fw/mptable.c
fw/mtrr.c
fw/paravirt.c
fw/paravirt.h
fw/pciinit.c
fw/pirtable.c
fw/romfile_loader.c
fw/romfile_loader.h
fw/shadow.c
fw/smbios.c
fw/smm.c
fw/smp.c
fw/xen.c
fw/xen.h
gen-defs.h
hw/ahci.c
hw/ahci.h
hw/ata.c
hw/ata.h
hw/bar.h
hw/blockcmd.c
hw/blockcmd.h
hw/dma.c
hw/esp-scsi.c
hw/esp-scsi.h
hw/floppy.c
hw/lsi-scsi.c
hw/lsi-scsi.h
hw/megasas.c
hw/megasas.h
hw/pci.c
hw/pci.h
hw/pci_ids.h
hw/pci_regs.h
hw/pic.c
hw/pic.h
hw/ps2port.c
hw/ps2port.h
hw/pvscsi.c
hw/pvscsi.h
hw/ramdisk.c
hw/rtc.c
hw/rtc.h
hw/sd.c
hw/sd.h
hw/sd_if.c
hw/sd_if.h
hw/sd_utils.c
hw/sd_utils.h
hw/sdhc_generic.c
hw/sdhc_generic.h
hw/sdhci.h
hw/serialio.c
hw/serialio.h
hw/timer.c
hw/usb-ehci.c
hw/usb-ehci.h
hw/usb-hid.c
hw/usb-hid.h
hw/usb-hub.c
hw/usb-hub.h
hw/usb-msc.c
hw/usb-msc.h
hw/usb-ohci.c
hw/usb-ohci.h
hw/usb-uas.c
hw/usb-uas.h
hw/usb-uhci.c
hw/usb-uhci.h
hw/usb-xhci.c
hw/usb-xhci.h
hw/usb.c
hw/usb.h
hw/virtio-blk.c
hw/virtio-blk.h
hw/virtio-pci.c
hw/virtio-pci.h
hw/virtio-ring.c
hw/virtio-ring.h
hw/virtio-scsi.c
hw/virtio-scsi.h
jpeg.c
kbd.c
list.h
malloc.c
malloc.h
memmap.c
memmap.h
misc.c
mouse.c
optionroms.c
output.c
output.h
pcibios.c
pmm.c
pnpbios.c
post.c
resume.c
romfile.c
romfile.h
serial.c
stacks.c
stacks.h
std/LegacyBios.h
std/acpi.h
std/bda.h
std/disk.h
std/mptable.h
std/optionrom.h
std/pirtable.h
std/pmm.h
std/pnpbios.h
std/smbios.h
std/vbe.h
stdbool.h
stdint.h
string.c
string.h
system.c
types.h
util.h
vgahooks.c
x86.c
x86.h
